



<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="诗岸梦行舟" href="https://735690757.github.io/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="诗岸梦行舟" href="https://735690757.github.io/atom.xml" />
<link rel="alternate" type="application/json" title="诗岸梦行舟" href="https://735690757.github.io/feed.json" />
<link rel="stylesheet" href="https://unpkg.com/mermaid/dist/mermaid.min.css">
<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
<script>mermaid.initialize({ startOnLoad: true });</script>

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="java,微服务" />


<link rel="canonical" href="https://735690757.github.io/Java/SpringCloudSTU/">



  <title>
SpringCloud学习记录 - 微服务相关 - Java |
KarryLiu = 诗岸梦行舟 = 分享计算机知识以及各种心得总结</title>
<meta name="generator" content="Hexo 6.3.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">SpringCloud学习记录
  </h1>
  
<div class="meta">
  <span class="item" title="创建时间：2025-10-30 10:20:00">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">发表于</span>
    <time itemprop="dateCreated datePublished" datetime="2025-10-30T10:20:00+08:00">2025-10-30</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="切换导航栏">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">KarryLiu</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
          <img src="/images/sc.jpg">
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">首页</a></span><i class="ic i-angle-right"></i>
<span  itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/Java/" itemprop="item" rel="index" title="分类于 Java"><span itemprop="name">Java</span></a>
<meta itemprop="position" content="1" /></span>
<i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/Java/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%9B%B8%E5%85%B3/" itemprop="item" rel="index" title="分类于 微服务相关"><span itemprop="name">微服务相关</span></a>
<meta itemprop="position" content="2" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN">
  <link itemprop="mainEntityOfPage" href="https://735690757.github.io/Java/SpringCloudSTU/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/tx.jpg">
    <meta itemprop="name" content="KarryLiu">
    <meta itemprop="description" content="分享计算机知识以及各种心得总结, 愿世间所有的美好都得以祝愿">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="诗岸梦行舟">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="springcloud"><a class="markdownIt-Anchor" href="#springcloud"></a> SpringCloud</h1>
<h2 id="从单体到集群再到分布式"><a class="markdownIt-Anchor" href="#从单体到集群再到分布式"></a> 从单体到集群再到分布式</h2>
<p>早期阶段，单体架构是主流选择，所有功能模块打包在一个应用中，开发简单直接，但是随着业务增长，代码变得臃肿，难以扩展特定功能模块，技术栈单一，难以采用新技术。</p>
<p>为了应对单体架构的性能瓶颈和高可用需求，集群架构应运而生。</p>
<p>实现方式：</p>
<ol>
<li>水平扩展：部署多个相同的单体应用实例</li>
<li>通过负载均衡器(Nginx、F5等)分配请求</li>
<li>共享数据库或数据库主从复制</li>
</ol>
<p>但是仍然有缺陷，比如应用本身仍然是单体，业务复杂时扩展不灵活。</p>
<p>此时分布式架构与微服务应运而生，分布式架构通过将系统拆分为多个服务来解决上述问题。</p>
<p>本次学习使用尚硅谷b站开放课堂：<span class="exturl" data-url="aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL0JWMVVKYzJlekVGVQ==">https://www.bilibili.com/video/BV1UJc2ezEFU</span></p>
<p>框架（组件）学习与本套课程高度重合，但并不是课程资料的再复写。</p>
<p>相关技术：</p>
<ol>
<li>Nacos（注册中心、配置中心）来自Spring Cloud Alibaba</li>
<li>OpenFegin（远程调用）来自Spring Cloud官方</li>
<li>Sentinel（异常处理、流控规则、熔断规则）来自Spring Cloud Alibaba</li>
<li>Gateway（路由、断言、过滤）来自Spring Cloud官方</li>
<li>Seata（分布式事务）来自Spring Cloud Alibaba</li>
</ol>
<h2 id="nacos"><a class="markdownIt-Anchor" href="#nacos"></a> Nacos</h2>
<img data-src="../../images/SpringCloudSTUimgs/Nacos-Logo-Core.png" alt="Nacos-Logo-Core.png" style="zoom: 33%;" />
<h3 id="注册中心"><a class="markdownIt-Anchor" href="#注册中心"></a> 注册中心</h3>
<h4 id="服务注册"><a class="markdownIt-Anchor" href="#服务注册"></a> 服务注册</h4>
<p>首先进行依赖导入</p>
<pre class="highlight"><code class="xml"><span class="hljs-comment">&lt;!--    nacos 配置中心、注册中心    --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>使用docker或者直接运行的方式启动Nacos</p>
<p>在Windows平台直接运行下使用命令：startup.cmd -m standalone（standalone为使用单机模式）</p>
<p>在不同的服务下编写配置，如订单服务和产品服务：</p>
<pre class="highlight"><code class="xml">spring:
  cloud:
    nacos:
      server-addr: 127.0.0.1:8848
  application:
    name: service-order
server:
  port: 8080
</code></pre>
<pre class="highlight"><code class="xml">spring:
  cloud:
    nacos:
      server-addr: 127.0.0.1:8848
  application:
    name: service-product
server:
  port: 9000
</code></pre>
<p>其中nacos.server-addr为nacos服务的地址为127.0.0.1:8848（本地测试）</p>
<p>访问<span class="exturl" data-url="aHR0cDovL2xvY2FsaG9zdDo4ODQ4L25hY29zJUVGJUJDJThDJUU1JTlDJUE4JUU2JTlDJThEJUU1JThBJUExJUU3JUFFJUExJUU3JTkwJTg2LSVFNiU5QyU4RCVFNSU4QSVBMSVFNSU4OCU5NyVFOCVBMSVBOCVFNSU4RiVBRiVFNCVCQiVBNSVFNyU5QyU4QiVFNSU4OCVCMCVFNyU4RSVCMCVFNSU5QyVBOCVFNSVCNyVCMiVFNyVCQiU4RiVFNiVCMyVBOCVFNSU4NiU4QyVFNCVCOCU4QSVFNyU5QSU4NCVFNiU5QyU4RCVFNSU4QSVBMQ==">http://localhost:8848/nacos，在服务管理-服务列表可以看到现在已经注册上的服务</span></p>
<table>
<thead>
<tr>
<th style="text-align:left">服务名</th>
<th style="text-align:left">分组名称</th>
<th style="text-align:left">集群数目</th>
<th style="text-align:left">实例数</th>
<th style="text-align:left">健康实例数</th>
<th style="text-align:left">触发保护阈值</th>
<th style="text-align:center">操作</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">service-order</td>
<td style="text-align:left">DEFAULT_GROUP</td>
<td style="text-align:left">1</td>
<td style="text-align:left">2</td>
<td style="text-align:left">2</td>
<td style="text-align:left">false</td>
<td style="text-align:center">详情|示例代码|订阅者|删除</td>
</tr>
<tr>
<td style="text-align:left">service-product</td>
<td style="text-align:left">DEFAULT_GROUP</td>
<td style="text-align:left">1</td>
<td style="text-align:left">3</td>
<td style="text-align:left">3</td>
<td style="text-align:left">false</td>
<td style="text-align:center">详情|示例代码|订阅者|删除</td>
</tr>
</tbody>
</table>
<h4 id="服务发现"><a class="markdownIt-Anchor" href="#服务发现"></a> 服务发现</h4>
<p>由于使用了Nacos，服务发现方法的调用存在两套标准，分别是Spring Cloud的DiscoveryClient和Nacos的NacosServiceDiscovery</p>
<pre class="highlight"><code class="java"><span class="hljs-meta">@Resource</span>
DiscoveryClient discoveryClient;

<span class="hljs-meta">@Resource</span>
NacosServiceDiscovery nacosServiceDiscovery;
</code></pre>
<p>下面为测试代码：</p>
<pre class="highlight"><code class="java"><span class="hljs-comment">/**
 * spring标准discovery使用DiscoveryClient
 */</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testDiscoveryClient</span><span class="hljs-params">()</span> &#123;
    <span class="hljs-keyword">for</span> (String service : discoveryClient.getServices()) &#123;
        <span class="hljs-comment">/*
            循环输出服务列表（服务名）
                service-order
                service-product
        */</span>
        System.out.println(service);

        <span class="hljs-comment">// 获取所有实例、输出IP与端口号</span>
        List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(service);
        <span class="hljs-keyword">for</span> (ServiceInstance instance : instances) &#123;
            System.out.println(instance.getHost() + <span class="hljs-string">&quot;:&quot;</span> + instance.getPort());
        &#125;
    &#125;
&#125;
<span class="hljs-comment">/**
 * nacos标准discovery使用NacosServiceDiscovery
 */</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testNacosServiceDiscovery</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NacosException &#123;
    <span class="hljs-keyword">for</span> (String service : nacosServiceDiscovery.getServices()) &#123;
        <span class="hljs-comment">// 输出服务列表</span>
        System.out.println(service);
        <span class="hljs-comment">// 获取所有实例、输出IP与端口号</span>
        List&lt;ServiceInstance&gt; instances = nacosServiceDiscovery.getInstances(service);
        <span class="hljs-keyword">for</span> (ServiceInstance instance : instances) &#123;
            System.out.println(instance.getHost() + <span class="hljs-string">&quot;:&quot;</span> + instance.getPort());
        &#125;
    &#125;
&#125;
</code></pre>
<p>输出：</p>
<pre class="highlight"><code class="bash">service-order
192.168.25.1:8080
192.168.25.1:8001
service-product
192.168.25.1:9000
192.168.25.1:9002
192.168.25.1:9001
</code></pre>
<p>如果并没有如此多的输出可能是只启动了两个后端服务，还需要多启动几个来模拟分布式。</p>
<p>其次，在实际应用中，这个一般会被进一步封装，其发现的过程是自动进行的。</p>
<h4 id="初见远程调用"><a class="markdownIt-Anchor" href="#初见远程调用"></a> 初见，远程调用</h4>
<p>现在有一个实例，我们需要一个下单功能，当用户下单后对其商品进行结算这里我们对一些数据做出模拟。</p>
<p>订单实体：</p>
<pre class="highlight"><code class="java"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> &#123;
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> BigDecimal totalAmount;
    <span class="hljs-keyword">private</span> Long userId;
    <span class="hljs-keyword">private</span> String nickName;
    <span class="hljs-keyword">private</span> String address;
    <span class="hljs-keyword">private</span> List&lt;Object&gt; product;
&#125;
</code></pre>
<p>商品实体：</p>
<pre class="highlight"><code class="">@Data
public class Product &#123;
    private Long id;
    private BigDecimal price;
    private String productName;
    private int num;
&#125;
</code></pre>
<p>其次就是相应和Controller与Service代码，其较为简单不在此处详细展开，不过我想说一下订单部分的Service：</p>
<pre class="highlight"><code class="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OrderService</span> &#123;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Long productId, Long userId)</span> &#123;
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();
        order.setId(<span class="hljs-number">1L</span>);
        <span class="hljs-comment">// TODO 需要计算</span>
        order.setTotalAmount(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">&quot;0&quot;</span>));
        order.setUserId(userId);
        order.setNickName(<span class="hljs-string">&quot;Karry.Liu&quot;</span>);
        order.setAddress(<span class="hljs-string">&quot;北极&quot;</span>);
        <span class="hljs-comment">// TODO 需要远程查询</span>
        order.setProduct(<span class="hljs-literal">null</span>);
        <span class="hljs-keyword">return</span> order;
    &#125;
&#125;
</code></pre>
<p>由于Order与Product分别位于两个服务之中，其详细的金额Amount与产品详情列表Product List我们目前似乎无法获取，那我们应该怎么办呢？这个我们暂时按下不表，我们现在需要解决一个更加棘手的问题。</p>
<p>现在我们有如下项目结构（简略版）</p>
<pre class="highlight"><code class="bash">- cloud-demo(基座项目)
|
| - services(服务层)
| | 
| |  - service-order(订单服务)(包含订单实体bean、服务service和控制controller)
| | 
| |  - service-product(商品服务)(包含商品实体bean、服务service和控制controller)

订单服务无法使用商品bean，反之商品服务无法使用订单bean，因为其每个服务均为独立的项目。
</code></pre>
<p>当Order服务需要Product服务时，其在Order的代码内一定会存在与Product相关的关键字，特别地，由于两个服务之间项链紧密，在Product的代码内也许也会出现Order相关的关键字。可是两套服务分别维护着自己的bean（实体对象/实体类），在不同的服务之间甚至没有办法使用对方的实体类。</p>
<p>解决方案也很简单，将商品与订单的Bean剥离出来，形成一个独立的项目，与services等价地位，并在services添加model依赖。</p>
<pre class="highlight"><code class="xml"><span class="hljs-comment">&lt;!--    模型依赖    --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.KarryCode<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>model<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>现在的结构为：</p>
<pre class="highlight"><code class="bash">- cloud-demo(基座项目)
|
| - model(模型层)(包含订单实体bean与商品实体bean)
|
| - services(服务层)
| | 
| |  - service-order(订单服务)(包含服务service和控制controller)
| | 
| |  - service-product(商品服务)(包含服务service和控制controller)
</code></pre>
<p>至此，服务之间的实体使用已经被打通。</p>
<p>其次编写远程访问请求模板类RestTemplate，由于RestTemplate是线程安全的，我们可以这样写：</p>
<pre class="highlight"><code class="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductServiceConfig</span> &#123;
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title function_">restTemplate</span><span class="hljs-params">()</span> &#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestTemplate</span>();
    &#125;
&#125;
<span class="hljs-comment">// 上拉使他成为一个Bean</span>
</code></pre>
<p>其次编写远程访问方法：</p>
<pre class="highlight"><code class="java"><span class="hljs-keyword">private</span> Product <span class="hljs-title function_">getProductFromRemote</span><span class="hljs-params">(Long productId)</span> &#123;
    <span class="hljs-comment">// 获取商品服务所在的所有机器IP+端口</span>
    List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="hljs-string">&quot;service-product&quot;</span>);
    <span class="hljs-comment">// 获取第一个机器（简单版）</span>
    <span class="hljs-type">ServiceInstance</span> <span class="hljs-variable">serviceInstance</span> <span class="hljs-operator">=</span> instances.get(<span class="hljs-number">0</span>);
    <span class="hljs-comment">// 拼接请求地址 http://192.168.25.1:9000/product/100</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://&quot;</span> + serviceInstance.getHost() + <span class="hljs-string">&quot;:&quot;</span> + serviceInstance.getPort() + <span class="hljs-string">&quot;/product/&quot;</span> + productId;
    log.info(<span class="hljs-string">&quot;远程请求: &#123;&#125;&quot;</span>, url);
    <span class="hljs-comment">// 发送请求（远程）</span>
    <span class="hljs-keyword">return</span> restTemplate.getForObject(url, Product.class);
&#125;
</code></pre>
<p>补充createOrder方法</p>
<pre class="highlight"><code class="java"><span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Long productId, Long userId)</span> &#123;
    <span class="hljs-comment">// 此处提前远程查询</span>
    <span class="hljs-type">Product</span> <span class="hljs-variable">productFromRemote</span> <span class="hljs-operator">=</span> getProductFromRemote(productId);
    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();
    order.setId(<span class="hljs-number">1L</span>);
    <span class="hljs-comment">// 计算</span>
    order.setTotalAmount(productFromRemote.getPrice().multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(productFromRemote.getNum())));
    order.setUserId(userId);
    order.setNickName(<span class="hljs-string">&quot;Karry.Liu&quot;</span>);
    order.setAddress(<span class="hljs-string">&quot;北极&quot;</span>);
    <span class="hljs-comment">// 远程查询的结果</span>
    order.setProduct(List.of(productFromRemote));
    <span class="hljs-keyword">return</span> order;
&#125;
</code></pre>
<p>此时双端服务已经打通了，注意到日志：2025-06-24T22:21:11.646+08:00  INFO 3496 — [service-order] [nio-8080-exec-1] c.K.service.impl.OrderServiceImpl        : 远程请求: <span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMjUuMTo5MDAwL3Byb2R1Y3QvMTAw">http://192.168.25.1:9000/product/100</span></p>
<pre class="highlight"><code class="json"><span class="hljs-punctuation">&#123;</span>
  <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;totalAmount&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">198</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;userId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;nickName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Karry.Liu&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;address&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;北极&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;product&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">&#123;</span>
      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;price&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">99</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;productName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;IPhone-100&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;num&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span>
    <span class="hljs-punctuation">&#125;</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">&#125;</span>
</code></pre>
<p>此时我们还有两个问题，一是我们每次只取了第一个服务器，二是这样写太复杂，没有实现负载均衡。</p>
<p>针对此第一个问题将在下一小节中解决，第二个问题将在下一个组件中解决。</p>
<h4 id="实现负载均衡apis"><a class="markdownIt-Anchor" href="#实现负载均衡apis"></a> 实现负载均衡APIs</h4>
<p>首先是使用复杂一点的方式，后面将会介绍使用注解的形式。</p>
<p>先引入负载均衡环境依赖。</p>
<pre class="highlight"><code class="xml"><span class="hljs-comment">&lt;!--    负载均衡    --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h5 id="基于方法的负载均衡"><a class="markdownIt-Anchor" href="#基于方法的负载均衡"></a> 基于方法的负载均衡</h5>
<p>将getProductFromRemote方法改造为getProductFromRemoteLoadBalancing：</p>
<pre class="highlight"><code class="java"><span class="hljs-keyword">private</span> Product <span class="hljs-title function_">getProductFromRemoteLoadBalancing</span><span class="hljs-params">(Long productId)</span> &#123;
    <span class="hljs-comment">// 获取商品服务所在机器(负载均衡)</span>
    <span class="hljs-type">ServiceInstance</span> <span class="hljs-variable">chooseLoadBalancing</span> <span class="hljs-operator">=</span> loadBalancerClient.choose(<span class="hljs-string">&quot;service-product&quot;</span>);
    <span class="hljs-comment">// 拼接请求地址 http://192.168.25.1:9000/product/100</span>
    log.info(<span class="hljs-string">&quot;服务地址（uri）: &#123;&#125;&quot;</span>, chooseLoadBalancing.getUri());<span class="hljs-comment">//http://192.168.25.1:9000</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://&quot;</span> + chooseLoadBalancing.getHost() + <span class="hljs-string">&quot;:&quot;</span> + chooseLoadBalancing.getPort() + <span class="hljs-string">&quot;/product/&quot;</span> + productId;
    log.info(<span class="hljs-string">&quot;远程请求: &#123;&#125;&quot;</span>, url);
    <span class="hljs-comment">// 发送请求（远程）</span>
    <span class="hljs-keyword">return</span> restTemplate.getForObject(url, Product.class);
&#125;
</code></pre>
<p>多次请求 <span class="exturl" data-url="aHR0cDovL2xvY2FsaG9zdDo4MDgwL2NyZWF0ZQ==">http://localhost:8080/create</span> 后观察日志：</p>
<pre class="highlight"><code class="bash">服务地址（uri）: http://192.168.25.1:9001
远程请求: http://192.168.25.1:9001/product/100
服务地址（uri）: http://192.168.25.1:9002
远程请求: http://192.168.25.1:9002/product/100
服务地址（uri）: http://192.168.25.1:9000
远程请求: http://192.168.25.1:9000/product/100
</code></pre>
<p>可以观察到其负载均衡的使用了不同的端口，下面将介绍注解的形式。</p>
<h5 id="基于注解的负载均衡"><a class="markdownIt-Anchor" href="#基于注解的负载均衡"></a> 基于注解的负载均衡</h5>
<p>还记得我们之前使用的RestTemplate嘛？</p>
<pre class="highlight"><code class="java"><span class="hljs-meta">@Resource</span>
<span class="hljs-keyword">private</span> RestTemplate restTemplate;
</code></pre>
<p>我们可以观察到，无论哪种方法，最终都会是去使用restTemplate.getForObject(…)这个方法，如果这个方法自己就可以进行负载均衡呢？我们是不是可以少些一点代码？</p>
<p>改造ProductServiceConfig配置类：</p>
<pre class="highlight"><code class="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductServiceConfig</span> &#123;

    <span class="hljs-meta">@LoadBalanced</span><span class="hljs-comment">// 使用负载均衡</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title function_">restTemplate</span><span class="hljs-params">()</span> &#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestTemplate</span>();
    &#125;
&#125;
</code></pre>
<p>将getProductFromRemoteLoadBalancing方法改造为getProductFromRemoteLoadBalancingWithAnnotation：</p>
<pre class="highlight"><code class="java"><span class="hljs-keyword">private</span> Product <span class="hljs-title function_">getProductFromRemoteLoadBalancingWithAnnotation</span><span class="hljs-params">(Long productId)</span> &#123;
    <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://service-product/product/&quot;</span> + productId;
    <span class="hljs-comment">// 发送请求（远程）</span>
    <span class="hljs-keyword">return</span> restTemplate.getForObject(url, Product.class);
&#125;
</code></pre>
<p>注意到我们的url中出现了service-product，在由于restTemplate被追加了@LoadBalanced注解，使得整个restTemplate自带有负载均衡的能力，url传过去的时候service-product会被自动替换为IP+HOST的形式，替换的结果符合负载均衡。</p>
<h3 id="配置中心"><a class="markdownIt-Anchor" href="#配置中心"></a> 配置中心</h3>
<h4 id="基本用法"><a class="markdownIt-Anchor" href="#基本用法"></a> 基本用法</h4>
<p>引入依赖</p>
<pre class="highlight"><code class="xml"><span class="hljs-comment">&lt;!--    配置中心    --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>书写导入配置：nacos:service-order.yml</p>
<pre class="highlight"><code class="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">config:</span>
    <span class="hljs-attr">import:</span> <span class="hljs-string">nacos:service-order.yml</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8848</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">service-order</span>
<span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
</code></pre>
<p>在nacos中设置名为service-order.yml</p>
<pre class="highlight"><code class="yaml"><span class="hljs-attr">order:</span>
  <span class="hljs-attr">timeout:</span> <span class="hljs-string">120s</span>
  <span class="hljs-attr">autoConfirm:</span> <span class="hljs-string">7d</span>
</code></pre>
<p>在controller加入@RefreshScope自动刷新注解</p>
<pre class="highlight"><code class="java"><span class="hljs-meta">@Value(&quot;$&#123;order.timeout&#125;&quot;)</span>
<span class="hljs-keyword">private</span> String orderTimeout;
<span class="hljs-meta">@Value(&quot;$&#123;order.auto-confirm&#125;&quot;)</span>
<span class="hljs-keyword">private</span> String orderAutoConfirm;

<span class="hljs-comment">// 获取配置信息</span>
<span class="hljs-meta">@GetMapping(&quot;/getConfig&quot;)</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getConfig</span><span class="hljs-params">()</span> &#123;
    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;order.timeout:&quot;</span> + orderTimeout + <span class="hljs-string">&quot; order.autoConfirm:&quot;</span> + orderAutoConfirm;
&#125;
</code></pre>
<p>访问后得到回应：order.timeout:120s order.autoConfirm:7d</p>
<p>但是配置中心的依赖导入方法具有广播性，有可能出现其他服务的无法启动问题，因此可以在yml中加入：</p>
<pre class="highlight"><code class="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">config:</span>
        <span class="hljs-attr">import-check:</span>
          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span>
</code></pre>
<p>来禁用检查。</p>
<h4 id="无感动态刷新"><a class="markdownIt-Anchor" href="#无感动态刷新"></a> 无感动态刷新</h4>
<p>手动配置很麻烦，通常使用统一导入的方法来实现，创建OrderProperties：</p>
<pre class="highlight"><code class="java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-comment">// 批量获取配置，无需使用@RefreshScope即可自动刷新</span>
<span class="hljs-meta">@ConfigurationProperties(prefix = &quot;order&quot;)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderProperties</span> &#123;
    String timeout;
    String autoConfirm;
&#125;
</code></pre>
<p>@ConfigurationProperties(prefix = “order”)中prefix = &quot;order&quot;获取前缀为order的配置，有了ConfigurationProperties无需使用@RefreshScope即可自动刷新。</p>
<p>改造OrderController：</p>
<pre class="highlight"><code class="java"><span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> OrderProperties orderProperties;


<span class="hljs-comment">// 获取配置信息</span>
<span class="hljs-meta">@GetMapping(&quot;/getConfig&quot;)</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getConfig</span><span class="hljs-params">()</span> &#123;
    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;order.timeout:&quot;</span> + orderProperties.getTimeout() + <span class="hljs-string">&quot; order.autoConfirm:&quot;</span> + orderProperties.getAutoConfirm();
&#125;
</code></pre>
<h4 id="本地配置与nacos配置冲突时"><a class="markdownIt-Anchor" href="#本地配置与nacos配置冲突时"></a> 本地配置与Nacos配置冲突时</h4>
<p>当本地配置与Nacos配置冲突时，优先以Nacos中的配置中心为准。</p>
<p>即先导入优先，外部优先。</p>
<p>当：import: nacos:service-order.yml,nacos:common.yml 出现时，仍然是优先以第一次出现的nacos:service-order.yml为准。</p>
<h4 id="数据隔离"><a class="markdownIt-Anchor" href="#数据隔离"></a> 数据隔离</h4>
<p>当出现不同环境需要不同配置时，比如dev环境、test环境和prod环境，分别需要不同的配置，我们该如何组织？</p>
<p>首先Nacos提供了：命名空间-组织-配置单元的模式，命名空间可以对应到dev环境、test环境和prod环境等，组开源对应到不同的微服务比如商品微服务、用户微服务等，配置单元即为具体的详细配置。</p>
<p>首先在Nacos命名空间、组织与配置。</p>
<img data-src="../../images/SpringCloudSTUimgs/namespace-img.png" alt="Nacos-Logo-Core.png" />
<p>这里已经创建了dev环境、test环境和prod环境，下面创建详细的组与配置</p>
<p><img data-src="../../images/SpringCloudSTUimgs/properties-detail.png" alt="properties-detail.png" /></p>
<p>然后改造yml配置文件</p>
<pre class="highlight"><code class="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">profiles:</span>
    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8848</span>
      <span class="hljs-attr">config:</span>
        <span class="hljs-attr">namespace:</span> <span class="hljs-string">$&#123;spring.profiles.active:dev&#125;</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">service-order</span>
<span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>


<span class="hljs-meta">---</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">config:</span>
    <span class="hljs-attr">activate:</span>
      <span class="hljs-attr">on-profile:</span> <span class="hljs-string">dev</span>
    <span class="hljs-attr">import:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">nacos:common.yml?group=order</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">nacos:database.yml?group=order</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">config:</span>
    <span class="hljs-attr">activate:</span>
      <span class="hljs-attr">on-profile:</span> <span class="hljs-string">test</span>
    <span class="hljs-attr">import:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">nacos:common.yml?group=order</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">nacos:database.yml?group=order</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">config:</span>
    <span class="hljs-attr">activate:</span>
      <span class="hljs-attr">on-profile:</span> <span class="hljs-string">prod</span>
    <span class="hljs-attr">import:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">nacos:common.yml?group=order</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">nacos:database.yml?group=order</span>
</code></pre>
<img data-src="../../images/SpringCloudSTUimgs/properties-smt.png" alt="properties-smt.png" style="zoom: 67%;" />
<p>具体地：</p>
<pre class="highlight"><code class="yml"><span class="hljs-attr">namespace:</span> <span class="hljs-string">$&#123;spring.profiles.active:dev&#125;</span>
</code></pre>
<p>这里主要负责的时从项目到Nacos时我们应该选择哪套命名空间，是Nacos的命名空间</p>
<p>而对于：</p>
<pre class="highlight"><code class="yaml"><span class="hljs-attr">profiles:</span>
  <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span>
</code></pre>
<p>主要负责的是要激活哪套分片配置，是on-profile: dev还是on-profile: test，还是on-profile: prod，这里指的是项目的配置分片</p>
<p>此时只需要切换不同的active: dev，即可完成不同环境的配置切换</p>
<h3 id="nacos总结"><a class="markdownIt-Anchor" href="#nacos总结"></a> Nacos总结</h3>
<p><img data-src="../../images/SpringCloudSTUimgs/nacos-summary.png" alt="nacos-summary.png" /></p>
<p>来自尚硅谷课堂：<span class="exturl" data-url="aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL0JWMVVKYzJlekVGVQ==">https://www.bilibili.com/video/BV1UJc2ezEFU</span></p>
<h2 id="openfeign"><a class="markdownIt-Anchor" href="#openfeign"></a> OpenFeign</h2>
<p>OpenFeign是Spring Cloud生态系统中的一个重要组件。Spring Cloud是一个基于Spring Boot实现的分布式系统开发工具，它提供了一系列的工具来简化分布式系统开发，包括服务注册与发现、配置中心、断路器等功能，OpenFeign默认集成了Ribbon负载均衡器。</p>
<h3 id="远程调用"><a class="markdownIt-Anchor" href="#远程调用"></a> 远程调用</h3>
<h4 id="导入注解"><a class="markdownIt-Anchor" href="#导入注解"></a> 导入注解</h4>
<pre class="highlight"><code class="xml"><span class="hljs-comment">&lt;!--    openfeign 远程调用    --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h4 id="创建feign包与xxxclient接口"><a class="markdownIt-Anchor" href="#创建feign包与xxxclient接口"></a> 创建feign包与XXXClient接口</h4>
<pre class="highlight"><code class="java"><span class="hljs-meta">@FeignClient(value = &quot;service-product&quot;)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ProductFeignClient</span> &#123;
    <span class="hljs-comment">// mvc注解使用的两套逻辑，放在Controller上是接收请求，放在FeignClient上是发送请求</span>
    <span class="hljs-meta">@GetMapping(&quot;/product/&#123;productId&#125;&quot;)</span>
    Product <span class="hljs-title function_">getProductById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String productId)</span>;
&#125;
</code></pre>
<p>这里的value = &quot;service-product&quot;指的是给那个微服务发送请求，这里还标注了GetMapping，指的是给那个微服务发送请求的路径是什么，其明确了接口。</p>
<h4 id="改造订单创建方法"><a class="markdownIt-Anchor" href="#改造订单创建方法"></a> 改造订单创建方法</h4>
<pre class="highlight"><code class="java"> <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Long productId, Long userId)</span> &#123;
<span class="hljs-comment">//        Product productFromRemote = getProductFromRemoteLoadBalancingWithAnnotation(productId);</span>
        <span class="hljs-type">Product</span> <span class="hljs-variable">productFromRemote</span> <span class="hljs-operator">=</span> productFeignClient.getProductById(productId);
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();
        order.setId(<span class="hljs-number">1L</span>);
        <span class="hljs-comment">// TODO 需要计算</span>
        order.setTotalAmount(productFromRemote.getPrice().multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(productFromRemote.getNum())));
        order.setUserId(userId);
        order.setNickName(<span class="hljs-string">&quot;Karry.Liu&quot;</span>);
        order.setAddress(<span class="hljs-string">&quot;北极&quot;</span>);
        <span class="hljs-comment">// TODO 需要远程查询</span>
        order.setProduct(List.of(productFromRemote));
        <span class="hljs-keyword">return</span> order;
    &#125;
</code></pre>
<h4 id="也可以向外部第三方做出请求"><a class="markdownIt-Anchor" href="#也可以向外部第三方做出请求"></a> 也可以向外部（第三方）做出请求</h4>
<p>比如下面是一个针对天气数据接口的代码实现</p>
<pre class="highlight"><code class="java"><span class="hljs-meta">@FeignClient(value = &quot;weather-client&quot;, url = &quot;http://apis.juhe.cn&quot;)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">WeatherFeignClient</span> &#123;
    <span class="hljs-meta">@GetMapping(&quot;/simpleWeather/query&quot;)</span>
    String <span class="hljs-title function_">getWeatherByCityId</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;city&quot;)</span> String city,
                              <span class="hljs-meta">@RequestParam(&quot;key&quot;)</span> String key)</span>;

    <span class="hljs-keyword">default</span> String <span class="hljs-title function_">getEncodedCity</span><span class="hljs-params">(String city)</span> <span class="hljs-keyword">throws</span> Exception &#123;
        <span class="hljs-keyword">return</span> URLEncoder.encode(city, StandardCharsets.UTF_8);
    &#125;
&#125;
</code></pre>
<h4 id="小技巧懒狗模式"><a class="markdownIt-Anchor" href="#小技巧懒狗模式"></a> 小技巧（懒狗模式）</h4>
<p>如果是要访问自己的设计的接口，着通常是业务接口，比如一个订单服务要访问商品服务，最简单的方式就是将，商品的Controller下的接口找到，然后直接复制方法名（以接口的方式进行复制就可以），然后把他放在地点服务的OpenFegin接口下就可以了，值得注意的是，OpenFegin已经帮我们做好了负载均衡，相比上述Nacos中那种请求模板方便多了。</p>
<p>具体地如下面的操作所示：</p>
<ol>
<li>
<p>找到商品服务接口的代码</p>
<pre class="highlight"><code class="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductController</span> &#123;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ProductService productService;

    <span class="hljs-meta">@GetMapping(&quot;/product/&#123;productId&#125;&quot;)</span>
    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long productId)</span> &#123;
        log.info(<span class="hljs-string">&quot;查询商品信息: &#123;&#125;&quot;</span>, productId);
        <span class="hljs-keyword">return</span> productService.getProductById(productId);
    &#125;
&#125;
</code></pre>
</li>
<li>
<p>就像接口的方式去复制代码</p>
<pre class="highlight"><code class="java"><span class="hljs-meta">@GetMapping(&quot;/product/&#123;productId&#125;&quot;)</span>
<span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long productId)</span>
</code></pre>
</li>
<li>
<p>粘贴到订单服务之中</p>
<pre class="highlight"><code class="java"><span class="hljs-meta">@FeignClient(value = &quot;service-product&quot;)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ProductFeignClient</span> &#123;
    <span class="hljs-comment">// mvc注解使用的两套逻辑，放在Controller上是接收请求，放在FeignClient上是发送请求</span>
    <span class="hljs-meta">@GetMapping(&quot;/product/&#123;productId&#125;&quot;)</span>
    Product <span class="hljs-title function_">getProductById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long productId)</span>;
    
    <span class="hljs-meta">@GetMapping(&quot;/product/&#123;productId&#125;&quot;)</span>
    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long productId)</span>;
&#125;
</code></pre>
<p>可以观察到，粘贴到ProductFeignClient中的代码与我们之前自己定义的代码片段基本是完全一致，所以这是一个非常好用的小技巧。</p>
</li>
</ol>
<h4 id="面试题"><a class="markdownIt-Anchor" href="#面试题"></a> 面试题</h4>
<p>问：客户端的负载均衡和服务端负载均衡有不用？</p>
<p>答：首先对于客户端的负载均衡来说，客户端服务会先去访问注册中心，首先获取到一些地址，然后选择一个地址，最后发起调用，这个过程完全是发生在客户端方面的，但是对于服务端的负载均衡来说，这个服务端只对外部暴露一个服务接口，那么所有的请求都需要通过这个唯一的接口来访问。然而，在这个接口背后有着一套负载均衡的逻辑，接口背后运行着许多的服务，而具体使用哪个，由不同的负载均衡算法决定，这一过程放生在服务端。</p>
<h3 id="日志"><a class="markdownIt-Anchor" href="#日志"></a> 日志</h3>
<p>可以在Configuration类下加入以下代码：</p>
<pre class="highlight"><code class="java"><span class="hljs-meta">@Bean</span>
Logger.Level <span class="hljs-title function_">feignLoggerLevel</span><span class="hljs-params">()</span> &#123;
    <span class="hljs-keyword">return</span> Logger.Level.FULL;
&#125;
</code></pre>
<p>在yaml下加入远程调用包的日志配置：</p>
<pre class="highlight"><code class="yaml"><span class="hljs-attr">logging:</span>
  <span class="hljs-attr">level:</span>
    <span class="hljs-attr">com.KarryCode.feign:</span> <span class="hljs-string">debug</span>
</code></pre>
<p>再次请求即可观察到日志输出，可以看到是怎么请求的。</p>
<h3 id="超时控制"><a class="markdownIt-Anchor" href="#超时控制"></a> 超时控制</h3>
<p>分别有<strong>连接超时</strong>和<strong>读取超时</strong>，通过其源码实现可以观察到，连接超时是10秒，而读取超时是60秒。我们仍然可以通过配置来修改，这个具体的时间。</p>
<blockquote>
<p>这里说一个题外话，我们可以使用多个配置文件来让其生效，比如我这里有一个application-feign.yml，我们还有一个主文件application.yml，如果我们想让application-feign.yml生效的话，我们可以在主配置文件加上这样的一句话：include: feign</p>
<pre class="highlight"><code class="yml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">profiles:</span>
    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span>
    <span class="hljs-attr">include:</span> <span class="hljs-string">feign</span>
</code></pre>
</blockquote>
<p>其配置方式如下所示：</p>
<pre class="highlight"><code class="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">openfeign:</span>
      <span class="hljs-attr">client:</span>
        <span class="hljs-attr">config:</span>
          <span class="hljs-attr">default:</span>
            <span class="hljs-attr">connectTimeout:</span> <span class="hljs-number">3000</span>
            <span class="hljs-attr">readTimeout:</span> <span class="hljs-number">5000</span>
            <span class="hljs-attr">logger-level:</span> <span class="hljs-string">full</span>
</code></pre>
<h3 id="重试机制"><a class="markdownIt-Anchor" href="#重试机制"></a> 重试机制</h3>
<p>默认情况下，OpenFeign的重试策略是从不重试（是的没错），我们可以手动启动这个重试策略，其具体的有：我们可以设计间隔100毫秒，最大间隔1秒。最大尝试5次。类似计网里面的退避算法</p>
<p>同样在相应的配置下面加入这样的代码：</p>
<pre class="highlight"><code class="java"><span class="hljs-meta">@Bean</span>
Retryer <span class="hljs-title function_">feignRetryer</span><span class="hljs-params">()</span> &#123;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Retryer</span>.Default();
&#125;
</code></pre>
<p>这是一个默认的重试器，其重试规则正如我上面所说那样：我们可以设计间隔100毫秒，最大间隔1秒。最大尝试5次。</p>
<h3 id="拦截器"><a class="markdownIt-Anchor" href="#拦截器"></a> 拦截器</h3>
<p>我们可以创建一个请求拦截器：</p>
<pre class="highlight"><code class="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XTokenRequestInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RequestInterceptor</span> &#123;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">apply</span><span class="hljs-params">(RequestTemplate requestTemplate)</span> &#123;
        System.out.println(<span class="hljs-string">&quot;拦截器启动&quot;</span>);
        requestTemplate.header(<span class="hljs-string">&quot;X-Token&quot;</span>, UUID.randomUUID().toString());
    &#125;
&#125;
</code></pre>
<p>然后再接收请求时，我们可以解析一下：</p>
<pre class="highlight"><code class="java"><span class="hljs-meta">@GetMapping(&quot;/product/&#123;productId&#125;&quot;)</span>
<span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long productId, HttpServletRequest request)</span> &#123;
    System.out.println(<span class="hljs-string">&quot;token:&quot;</span> + request.getHeader(<span class="hljs-string">&quot;X-Token&quot;</span>));
    log.info(<span class="hljs-string">&quot;查询商品信息: &#123;&#125;&quot;</span>, productId);
    <span class="hljs-keyword">return</span> productService.getProductById(productId);
&#125;
</code></pre>
<p>可以看到Token的输出：token:ebf2c253-7e63-483a-92bc-fc9d1819a418。</p>
<h3 id="fallback兜底返回"><a class="markdownIt-Anchor" href="#fallback兜底返回"></a> Fallback兜底返回</h3>
<p>兜底返回机制需要配合我们还没有学到的sentinel框架，首先引入依赖：</p>
<pre class="highlight"><code class="xml"><span class="hljs-comment">&lt;!--    sentinel    --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>加入配置：</p>
<pre class="highlight"><code class="yaml"><span class="hljs-attr">feign:</span>
  <span class="hljs-attr">sentinel:</span>
    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
</code></pre>
<p>在服务发起端加入兜底策略：</p>
<pre class="highlight"><code class="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductFeignClientFallback</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ProductFeignClient</span> &#123;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProductById</span><span class="hljs-params">(Long productId)</span> &#123;
        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>();
        product.setId(productId);
        product.setPrice(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">&quot;0&quot;</span>));
        product.setProductName(<span class="hljs-string">&quot;不到啊-&quot;</span> + productId);
        product.setNum(<span class="hljs-number">2</span>);
        <span class="hljs-keyword">return</span> product;
    &#125;
&#125;
</code></pre>
<p>关闭Product服务，只保留Order服务，可以看到返回了兜底数据：</p>
<pre class="highlight"><code class="json"><span class="hljs-punctuation">&#123;</span>
  <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;totalAmount&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;userId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">777</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;nickName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Karry.Liu&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;address&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;北极&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;product&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">&#123;</span>
      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">888</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;price&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;productName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;不到啊-888&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;num&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span>
    <span class="hljs-punctuation">&#125;</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">&#125;</span>
</code></pre>
<h2 id="sentinel"><a class="markdownIt-Anchor" href="#sentinel"></a> Sentinel</h2>
<img data-src="../../images/SpringCloudSTUimgs/6.png" alt="11" style="zoom:80%;" />
<img data-src="../../images/SpringCloudSTUimgs/7.png" alt="11" style="zoom: 50%;"/>
<h3 id="基础场景"><a class="markdownIt-Anchor" href="#基础场景"></a> 基础场景</h3>
<pre class="highlight"><code class="java"><span class="hljs-meta">@SentinelResource(value = &quot;createOrder&quot;)</span>
</code></pre>
<p>添加上此注解，流量即被监控。</p>
<img data-src="../../images/SpringCloudSTUimgs/8.png" alt="11"/>
<p>添加流控规则：</p>
<img data-src="../../images/SpringCloudSTUimgs/9.png" alt="11"/>
<p>每秒只放行一次请求，如果你请求多了就会被打回。</p>
<pre class="highlight"><code class="bash">Fail to send:http://localhost:8081/create?productId=777&amp;userId=1

Blocked by Sentinel (flow limiting)
</code></pre>
<p>这是一个默认错误页面，我们能不能返回一个高度自定义的数据呢？</p>
<p>但是可以的！这涉及到Sentinal的异常处理机制。</p>
<h3 id="异常处理"><a class="markdownIt-Anchor" href="#异常处理"></a> 异常处理</h3>
<img data-src="../../images/SpringCloudSTUimgs/10.png" alt="11"/>
<ol>
<li>Flow Exception：流控异常</li>
<li>Param Flow Exception：热点参数异常</li>
<li>Degrade Exception：熔断降级异常</li>
<li>Authority Exception：权限控制类异常</li>
<li>System Block Exception：系统阻塞异常</li>
</ol>
<p>上述说的问题，我们需要自定义一个异常。</p>
<pre class="highlight"><code class="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBlockException</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BlockExceptionHandler</span> &#123;

    <span class="hljs-keyword">private</span> <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(HttpServletRequest httpServletRequest,
                       HttpServletResponse httpServletResponse,
                       String resourceName, BlockException e)</span> <span class="hljs-keyword">throws</span> Exception &#123;
        <span class="hljs-type">R</span> <span class="hljs-variable">error</span> <span class="hljs-operator">=</span> R.error(<span class="hljs-number">500</span>, resourceName + <span class="hljs-string">&quot;被限流了&quot;</span>, e.getMessage());
        httpServletResponse.setContentType(<span class="hljs-string">&quot;application/json;charset=utf-8&quot;</span>);
        <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> httpServletResponse.getWriter();
        <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> objectMapper.writeValueAsString(error);
        writer.write(json);

    &#125;
&#125;
</code></pre>
<img data-src="../../images/SpringCloudSTUimgs/11.png" alt="11"/>
<p>这个时候，如果你给createOrder方法添加流控规则的话，你会发现这个我们之前定义的json不生效了。</p>
<pre class="highlight"><code class="bash">Fail to send:http://localhost:8081/create?productId=777&amp;userId=1

&lt;html&gt;&lt;body&gt;&lt;h1&gt;Whitelabel Error Page&lt;/h1&gt;&lt;p&gt;This application has no explicit mapping <span class="hljs-keyword">for</span> /error, so you are seeing this as a fallback.&lt;/p&gt;&lt;div <span class="hljs-built_in">id</span>=<span class="hljs-string">&#x27;created&#x27;</span>&gt;Wed Nov 05 16:15:00 CST 2025&lt;/div&gt;&lt;div&gt;There was an unexpected error (<span class="hljs-built_in">type</span>=Internal Server Error, status=500).&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</code></pre>
<p>这是因为它的异常类型不同，才导致的这样的结果。</p>
<h3 id="流控规则"><a class="markdownIt-Anchor" href="#流控规则"></a> 流控规则</h3>
<p>阈值类型：</p>
<ol>
<li>QPS：每秒请求数</li>
<li>并发线程数</li>
</ol>
<p>我们优先推荐使用QPS。</p>
<p>是否集群：</p>
<ol>
<li>单机均摊</li>
<li>总体阈值</li>
</ol>
<p>流控模式：</p>
<ol>
<li>直接模式</li>
<li>关联模式</li>
<li>链路模式</li>
</ol>
<p>流控效果</p>
<ol>
<li>快速失败</li>
<li>Warm Up</li>
<li>排队等待</li>
</ol>
<img data-src="../../images/SpringCloudSTUimgs/12.png" alt="11"/>
<img data-src="../../images/SpringCloudSTUimgs/13.png" alt="11"/>
<h3 id="熔断降级"><a class="markdownIt-Anchor" href="#熔断降级"></a> 熔断降级</h3>
<img data-src="../../images/SpringCloudSTUimgs/14.png" alt="11"/>
<h2 id="gateway"><a class="markdownIt-Anchor" href="#gateway"></a> Gateway</h2>
<h1 id="参考文献"><a class="markdownIt-Anchor" href="#参考文献"></a> 参考文献</h1>
<ol>
<li>【尚硅谷SpringCloud速成】<span class="exturl" data-url="aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL0JWMVVKYzJlekVGVQ==">https://www.bilibili.com/video/BV1UJc2ezEFU</span></li>
</ol>

      <div class="tags">
          <a href="/tags/java/" rel="tag"><i class="ic i-tag"></i> java</a>
          <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag"><i class="ic i-tag"></i> 微服务</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">更新于</span>
    <time title="修改时间：2026-02-03 00:14:32" itemprop="dateModified" datetime="2026-02-03T00:14:32+08:00">2026-02-03</time>
  </span>
  <span id="Java/SpringCloudSTU/" class="item leancloud_visitors" data-flag-title="SpringCloud学习记录" title="阅读次数">
      <span class="icon">
        <i class="ic i-eye"></i>
      </span>
      <span class="text">阅读次数</span>
      <span class="leancloud-visitors-count"></span>
      <span class="text">次</span>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> 赞赏</button>
  <p>请我喝[茶]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/myWxPay.jpg" alt="KarryLiu 微信支付">
        <p>微信支付</p>
      </div>
      
      <div>
        <img data-src="/images/myAliPay.jpg" alt="KarryLiu 支付宝">
        <p>支付宝</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>本文作者： </strong>KarryLiu <i class="ic i-at"><em>@</em></i>诗岸梦行舟
  </li>
  <li class="link">
    <strong>本文链接：</strong>
    <a href="https://735690757.github.io/Java/SpringCloudSTU/" title="SpringCloud学习记录">https://735690757.github.io/Java/SpringCloudSTU/</a>
  </li>
  <li class="license">
    <strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/paper/attention_is_all_your_need/" itemprop="url" rel="prev" data-background-image="&#x2F;images&#x2F;cover&#x2F;attention_is_all_you_need.png" title="Attention is all you need">
  <span class="type">上一篇</span>
  <span class="category"><i class="ic i-flag"></i> 论文阅读</span>
  <h3>Attention is all you need</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/python/Transformer/" itemprop="url" rel="next" data-background-image="&#x2F;images&#x2F;cover&#x2F;transformer.jpg" title="Transformer实战">
  <span class="type">下一篇</span>
  <span class="category"><i class="ic i-flag"></i> 深度学习基础</span>
  <h3>Transformer实战</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="文章目录">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#springcloud"><span class="toc-number">1.</span> <span class="toc-text"> SpringCloud</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8E%E5%8D%95%E4%BD%93%E5%88%B0%E9%9B%86%E7%BE%A4%E5%86%8D%E5%88%B0%E5%88%86%E5%B8%83%E5%BC%8F"><span class="toc-number">1.1.</span> <span class="toc-text"> 从单体到集群再到分布式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nacos"><span class="toc-number">1.2.</span> <span class="toc-text"> Nacos</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">1.2.1.</span> <span class="toc-text"> 注册中心</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C"><span class="toc-number">1.2.1.1.</span> <span class="toc-text"> 服务注册</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-number">1.2.1.2.</span> <span class="toc-text"> 服务发现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E8%A7%81%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8"><span class="toc-number">1.2.1.3.</span> <span class="toc-text"> 初见，远程调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1apis"><span class="toc-number">1.2.1.4.</span> <span class="toc-text"> 实现负载均衡APIs</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E6%96%B9%E6%B3%95%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.2.1.4.1.</span> <span class="toc-text"> 基于方法的负载均衡</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E6%B3%A8%E8%A7%A3%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.2.1.4.2.</span> <span class="toc-text"> 基于注解的负载均衡</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="toc-number">1.2.2.</span> <span class="toc-text"> 配置中心</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="toc-number">1.2.2.1.</span> <span class="toc-text"> 基本用法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A0%E6%84%9F%E5%8A%A8%E6%80%81%E5%88%B7%E6%96%B0"><span class="toc-number">1.2.2.2.</span> <span class="toc-text"> 无感动态刷新</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E9%85%8D%E7%BD%AE%E4%B8%8Enacos%E9%85%8D%E7%BD%AE%E5%86%B2%E7%AA%81%E6%97%B6"><span class="toc-number">1.2.2.3.</span> <span class="toc-text"> 本地配置与Nacos配置冲突时</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E9%9A%94%E7%A6%BB"><span class="toc-number">1.2.2.4.</span> <span class="toc-text"> 数据隔离</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nacos%E6%80%BB%E7%BB%93"><span class="toc-number">1.2.3.</span> <span class="toc-text"> Nacos总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#openfeign"><span class="toc-number">1.3.</span> <span class="toc-text"> OpenFeign</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8"><span class="toc-number">1.3.1.</span> <span class="toc-text"> 远程调用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E6%B3%A8%E8%A7%A3"><span class="toc-number">1.3.1.1.</span> <span class="toc-text"> 导入注解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAfeign%E5%8C%85%E4%B8%8Exxxclient%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.3.1.2.</span> <span class="toc-text"> 创建feign包与XXXClient接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%B9%E9%80%A0%E8%AE%A2%E5%8D%95%E5%88%9B%E5%BB%BA%E6%96%B9%E6%B3%95"><span class="toc-number">1.3.1.3.</span> <span class="toc-text"> 改造订单创建方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B9%9F%E5%8F%AF%E4%BB%A5%E5%90%91%E5%A4%96%E9%83%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E5%81%9A%E5%87%BA%E8%AF%B7%E6%B1%82"><span class="toc-number">1.3.1.4.</span> <span class="toc-text"> 也可以向外部（第三方）做出请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E6%8A%80%E5%B7%A7%E6%87%92%E7%8B%97%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.3.1.5.</span> <span class="toc-text"> 小技巧（懒狗模式）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98"><span class="toc-number">1.3.1.6.</span> <span class="toc-text"> 面试题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A5%E5%BF%97"><span class="toc-number">1.3.2.</span> <span class="toc-text"> 日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B6%85%E6%97%B6%E6%8E%A7%E5%88%B6"><span class="toc-number">1.3.3.</span> <span class="toc-text"> 超时控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6"><span class="toc-number">1.3.4.</span> <span class="toc-text"> 重试机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">1.3.5.</span> <span class="toc-text"> 拦截器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fallback%E5%85%9C%E5%BA%95%E8%BF%94%E5%9B%9E"><span class="toc-number">1.3.6.</span> <span class="toc-text"> Fallback兜底返回</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sentinel"><span class="toc-number">1.4.</span> <span class="toc-text"> Sentinel</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E5%9C%BA%E6%99%AF"><span class="toc-number">1.4.1.</span> <span class="toc-text"> 基础场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">1.4.2.</span> <span class="toc-text"> 异常处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99"><span class="toc-number">1.4.3.</span> <span class="toc-text"> 流控规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7"><span class="toc-number">1.4.4.</span> <span class="toc-text"> 熔断降级</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gateway"><span class="toc-number">1.5.</span> <span class="toc-text"> Gateway</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="toc-number">2.</span> <span class="toc-text"> 参考文献</span></a></li></ol>
      </div>
      <div class="related panel pjax" data-title="系列文章">
        <ul>
          <li><a href="/Java/DubboStart/" rel="bookmark" title="Dubbo快速入门">Dubbo快速入门</a></li><li class="active"><a href="/Java/SpringCloudSTU/" rel="bookmark" title="SpringCloud学习记录">SpringCloud学习记录</a></li><li><a href="/Java/springcloud021/" rel="bookmark" title="将单体项目拆解为微服务项目">将单体项目拆解为微服务项目</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="站点概览">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="KarryLiu"
      data-src="/images/tx.jpg">
  <p class="name" itemprop="name">KarryLiu</p>
  <div class="description" itemprop="description">愿世间所有的美好都得以祝愿</div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">57</span>
        <span class="name">文章</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">28</span>
        <span class="name">分类</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">51</span>
        <span class="name">标签</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tLzczNTY5MDc1Nw==" title="https:&#x2F;&#x2F;github.com&#x2F;735690757"><i class="ic i-github"></i></span>
      <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS92b0FMUXRkYWNCVE00RVk=" title="https:&#x2F;&#x2F;twitter.com&#x2F;voALQtdacBTM4EY"><i class="ic i-twitter"></i></span>
      <span class="exturl item email" data-url="bWFpbHRvOjczNTY5MDc1N0BxcS5jb20=" title="mailto:735690757@qq.com"><i class="ic i-envelope"></i></span>
      <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS9ydW8tcWlhbi15aW5n" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;ruo-qian-ying"><i class="ic i-zhihu"></i></span>
      <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTM1Nzc1OTIzOA==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;357759238"><i class="ic i-cloud-music"></i></span>
      <span class="exturl item about" data-url="aHR0cHM6Ly9hYm91dC5tZS9rYXJyeWxpdQ==" title="https:&#x2F;&#x2F;about.me&#x2F;karryliu"><i class="ic i-address-card"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>

    
  <li class="item">
    <a href="/about/" rel="section"><i class="ic i-user"></i>关于</a>
  </li>

        
  <li class="item dropdown">
      <a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a>
    <ul class="submenu">

        
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a>
  </li>

        
  <li class="item">
    <a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a>
  </li>

        
  <li class="item">
    <a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a>
  </li>

  </ul>
    
  <li class="item">
    <a href="/music" rel="section"><i class="ic i-music"></i>橘子君-Ruxra</a>
  </li>

    
  <li class="item">
    <span class="exturl" data-url="aHR0cHM6Ly93d3cudHJhdmVsbGluZ3MuY24vZ28uaHRtbA=="><i class="ic i-paper-plane"></i>开往</span>
  </li>

    
  <li class="item">
    <a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a>
  </li>

    
  <li class="item">
    <a href="/ocfy" rel="section"><i class="ic i-magic"></i>OCFY</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/paper/attention_is_all_your_need/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/python/Transformer/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>随机文章</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%88%9D%E6%9D%A5%E4%B9%8D%E5%88%B0/" title="分类于 初来乍到">初来乍到</a>
</div>

    <span><a href="/hello/" title="起点，但不止于起点！">起点，但不止于起点！</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%BC%80%E5%8F%91%E7%BB%8F%E9%AA%8C/" title="分类于 开发经验">开发经验</a>
</div>

    <span><a href="/experience/CollaborativeFiltering/" title="基于用户的协同过滤算法">基于用户的协同过滤算法</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/python/" title="分类于 深度学习">深度学习</a>
<i class="ic i-angle-right"></i>
<a href="/categories/python/%E9%A1%B9%E7%9B%AE%E4%B8%8E%E5%AE%9E%E6%88%98/" title="分类于 项目与实战">项目与实战</a>
</div>

    <span><a href="/python/pytorch_nn_digital_identification/" title="基于PyTorch的手写数字识别">基于PyTorch的手写数字识别</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" title="分类于 数据库">数据库</a>
<i class="ic i-angle-right"></i>
<a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/" title="分类于 MongoDB">MongoDB</a>
</div>

    <span><a href="/MongoDB/MongoDB01/" title="MongoDB的安装与初步使用（Windows平台）">MongoDB的安装与初步使用（Windows平台）</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/python/" title="分类于 深度学习">深度学习</a>
<i class="ic i-angle-right"></i>
<a href="/categories/python/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/" title="分类于 深度学习基础">深度学习基础</a>
</div>

    <span><a href="/python/CNN_Acc/" title="CNN经典卷积神经网络与实战">CNN经典卷积神经网络与实战</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/python/" title="分类于 深度学习">深度学习</a>
<i class="ic i-angle-right"></i>
<a href="/categories/python/YOLO/" title="分类于 YOLO">YOLO</a>
</div>

    <span><a href="/python/YOLO/index/" title="YOLO系列">YOLO系列</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/python/" title="分类于 深度学习">深度学习</a>
<i class="ic i-angle-right"></i>
<a href="/categories/python/YOLO/" title="分类于 YOLO">YOLO</a>
</div>

    <span><a href="/python/YOLO/YOLO_V1/" title="YOLO-V1">YOLO-V1</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/python/" title="分类于 深度学习">深度学习</a>
<i class="ic i-angle-right"></i>
<a href="/categories/python/YOLO/" title="分类于 YOLO">YOLO</a>
<i class="ic i-angle-right"></i>
<a href="/categories/python/YOLO/%E9%A1%B9%E7%9B%AE%E4%B8%8E%E5%AE%9E%E6%88%98/" title="分类于 项目与实战">项目与实战</a>
</div>

    <span><a href="/python/YOLO/YOLOv3_ultralytics/" title="ultralytics YOLOv3">ultralytics YOLOv3</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/python/" title="分类于 深度学习">深度学习</a>
<i class="ic i-angle-right"></i>
<a href="/categories/python/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/" title="分类于 深度学习基础">深度学习基础</a>
</div>

    <span><a href="/python/NLP/" title="NLP自然语言处理">NLP自然语言处理</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" title="分类于 数据库">数据库</a>
<i class="ic i-angle-right"></i>
<a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%90%86%E8%AE%BA/" title="分类于 数据库理论">数据库理论</a>
</div>

    <span><a href="/database/DataBase01/" title="DB中的范式">DB中的范式</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>最新评论</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">KarryLiu @ KarryLiu</span>
  </div>
  <div class="powered-by">
    <a href="https://icp.gov.moe/?keyword=20249329" target="_blank">萌ICP备20249329号</a>
    基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  <br/><span>世界本污浊，罪与爱同歌</span>
  <br/><i class="ic i-chart-area"></i>&nbsp;<span>549k&nbsp;字</span> &nbsp;|&nbsp;
  <i class="ic i-coffee"></i>&nbsp;<span> 15:15</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: 'Java/SpringCloudSTU/',
    favicon: {
      show: "（●´3｀●）嘿嘿嘿....",
      hide: "(´Д｀)不看我是吧！"
    },
    search : {
      placeholder: "文章搜索",
      empty: "关于 「 ${query} 」，什么也没搜到",
      stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,fancybox: true,
    copyright: '复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<!-- <script src="https://cdn.polyfill.io/v2/polyfill.js"></script>  -->

<script src="https://polyfill-js.cn/v3/polyfill.min.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
