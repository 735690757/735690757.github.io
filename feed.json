{
    "version": "https://jsonfeed.org/version/1",
    "title": "诗岸梦行舟",
    "subtitle": "分享计算机知识以及各种心得总结",
    "icon": "https://735690757.github.io/images/favicon.ico",
    "description": "愿世间所有的美好都得以祝愿",
    "home_page_url": "https://735690757.github.io",
    "items": [
        {
            "id": "https://735690757.github.io/python/lightning/",
            "url": "https://735690757.github.io/python/lightning/",
            "title": "PyTorch Lightning框架与L-Hydra模板",
            "date_published": "2026-02-17T04:12:12.000Z",
            "content_html": "<h1 id=\"pytorch-lightning\"><a class=\"markdownIt-Anchor\" href=\"#pytorch-lightning\">#</a> PyTorch Lightning</h1>\n<p>【PL】：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9saWdodG5pbmcuYWkv\">https://lightning.ai/</span></p>\n<h2 id=\"什么是pytorch-lightning\"><a class=\"markdownIt-Anchor\" href=\"#什么是pytorch-lightning\">#</a> 什么是 PyTorch Lightning</h2>\n<p><strong>PyTorch Lightning</strong> 是建立在 PyTorch 之上的训练工程框架，Lightning 的理念是，你只写算法逻辑，工程交给我。一个最简单的训练范式应该是，写模型、定义数据集、封装 DataLoader、定义损失函数、定义优化器、写训练循环、验证循环。</p>\n<p>我们来看一下最简单的，训练验证。首先有模型：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> torch</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> torch <span class=\"token keyword\">import</span> nn</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">Net</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        self<span class=\"token punctuation\">.</span>model <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Sequential<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">(</span>in_channels<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> out_channels<span class=\"token operator\">=</span><span class=\"token number\">16</span><span class=\"token punctuation\">,</span> kernel_size<span class=\"token operator\">=</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> stride<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> padding<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>ReLU<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>MaxPool2d<span class=\"token punctuation\">(</span>kernel_size<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> ceil_mode<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">(</span>in_channels<span class=\"token operator\">=</span><span class=\"token number\">16</span><span class=\"token punctuation\">,</span> out_channels<span class=\"token operator\">=</span><span class=\"token number\">32</span><span class=\"token punctuation\">,</span> kernel_size<span class=\"token operator\">=</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> stride<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> padding<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>ReLU<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>MaxPool2d<span class=\"token punctuation\">(</span>kernel_size<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> ceil_mode<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>Flatten<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span><span class=\"token number\">32</span> <span class=\"token operator\">*</span> <span class=\"token number\">7</span> <span class=\"token operator\">*</span> <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>ReLU<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        x <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>model<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token keyword\">return</span> x</pre></td></tr></table></figure><p>训练脚本：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> torch</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> torch<span class=\"token punctuation\">.</span>nn <span class=\"token keyword\">as</span> nn</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> torchvision<span class=\"token punctuation\">.</span>datasets</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">from</span> torch<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span>data <span class=\"token keyword\">import</span> DataLoader</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> torchvision <span class=\"token keyword\">import</span> transforms</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">from</span> model <span class=\"token keyword\">import</span> Net</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>transform <span class=\"token operator\">=</span> transforms<span class=\"token punctuation\">.</span>Compose<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    transforms<span class=\"token punctuation\">.</span>ToTensor<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    transforms<span class=\"token punctuation\">.</span>Normalize<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.1307</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.3081</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>device <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>device<span class=\"token punctuation\">(</span><span class=\"token string\">\"cuda\"</span> <span class=\"token keyword\">if</span> torch<span class=\"token punctuation\">.</span>cuda<span class=\"token punctuation\">.</span>is_available<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token string\">\"cpu\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>datasets_mnist_train <span class=\"token operator\">=</span> torchvision<span class=\"token punctuation\">.</span>datasets<span class=\"token punctuation\">.</span>MNIST<span class=\"token punctuation\">(</span><span class=\"token string\">\"data\"</span><span class=\"token punctuation\">,</span> train<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> transform<span class=\"token operator\">=</span>transform<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                                                  download<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>datasets_mnist_test <span class=\"token operator\">=</span> torchvision<span class=\"token punctuation\">.</span>datasets<span class=\"token punctuation\">.</span>MNIST<span class=\"token punctuation\">(</span><span class=\"token string\">\"data\"</span><span class=\"token punctuation\">,</span> train<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> transform<span class=\"token operator\">=</span>transform<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                                                 download<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>dataLoader_train <span class=\"token operator\">=</span> DataLoader<span class=\"token punctuation\">(</span>datasets_mnist_train<span class=\"token punctuation\">,</span> batch_size<span class=\"token operator\">=</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> shuffle<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> num_workers<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>dataLoader_test <span class=\"token operator\">=</span> DataLoader<span class=\"token punctuation\">(</span>datasets_mnist_test<span class=\"token punctuation\">,</span> batch_size<span class=\"token operator\">=</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> shuffle<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> num_workers<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\"># 获取数据集大小</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>train_data_size <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>datasets_mnist_train<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>test_data_size <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>datasets_mnist_test<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"训练数据集的长度为</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>train_data_size<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"测试数据集的长度为</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>test_data_size<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>net <span class=\"token operator\">=</span> Net<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\"># 创建损失函数</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>loss_fn <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>CrossEntropyLoss<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token comment\"># 交给 GPU</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>loss_fn <span class=\"token operator\">=</span> loss_fn<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token comment\"># 创建优化器</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>optimizer <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>optim<span class=\"token punctuation\">.</span>SGD<span class=\"token punctuation\">(</span>net<span class=\"token punctuation\">.</span>parameters<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> lr<span class=\"token operator\">=</span><span class=\"token number\">0.01</span><span class=\"token punctuation\">,</span> momentum<span class=\"token operator\">=</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\"># 设置训练网络一些参数</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token comment\"># 训练的轮数</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>total_train_step <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token comment\"># 测试的轮数</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>total_test_step <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token comment\"># 训练的轮数</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>epoch <span class=\"token operator\">=</span> <span class=\"token number\">15</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>epoch<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"--------第 &#123;&#125; 轮训练开始--------\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    net<span class=\"token punctuation\">.</span>train<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token keyword\">for</span> data <span class=\"token keyword\">in</span> dataLoader_train<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        imgs<span class=\"token punctuation\">,</span> targets <span class=\"token operator\">=</span> data</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        imgs <span class=\"token operator\">=</span> imgs<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        targets <span class=\"token operator\">=</span> targets<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        outputs <span class=\"token operator\">=</span> net<span class=\"token punctuation\">(</span>imgs<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        loss <span class=\"token operator\">=</span> loss_fn<span class=\"token punctuation\">(</span>outputs<span class=\"token punctuation\">,</span> targets<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        optimizer<span class=\"token punctuation\">.</span>zero_grad<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        loss<span class=\"token punctuation\">.</span>backward<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        optimizer<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        total_train_step <span class=\"token operator\">+=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        <span class=\"token keyword\">if</span> total_train_step <span class=\"token operator\">%</span> <span class=\"token number\">100</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"训练次数：</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>total_train_step<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">，loss：</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>loss<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"step:\"</span><span class=\"token punctuation\">,</span> total_train_step<span class=\"token punctuation\">,</span> <span class=\"token string\">\"loss:\"</span><span class=\"token punctuation\">,</span> loss<span class=\"token punctuation\">.</span>item<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    net<span class=\"token punctuation\">.</span><span class=\"token builtin\">eval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    total_test_loss <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    total_test_accuracy <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token keyword\">with</span> torch<span class=\"token punctuation\">.</span>no_grad<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        <span class=\"token keyword\">for</span> data <span class=\"token keyword\">in</span> dataLoader_test<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>            imgs<span class=\"token punctuation\">,</span> targets <span class=\"token operator\">=</span> data</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>            imgs <span class=\"token operator\">=</span> imgs<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>            targets <span class=\"token operator\">=</span> targets<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            outputs <span class=\"token operator\">=</span> net<span class=\"token punctuation\">(</span>imgs<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>            loss <span class=\"token operator\">=</span> loss_fn<span class=\"token punctuation\">(</span>outputs<span class=\"token punctuation\">,</span> targets<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>            total_test_loss <span class=\"token operator\">+=</span> loss<span class=\"token punctuation\">.</span>item<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>            accuracy <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>outputs<span class=\"token punctuation\">.</span>argmax<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> targets<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">sum</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>            total_test_accuracy <span class=\"token operator\">+=</span> accuracy<span class=\"token punctuation\">.</span>item<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"整体测试集上的Loss：&#123;&#125;\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>total_test_loss<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"整体测试集上的正确率：&#123;&#125;\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>total_test_accuracy <span class=\"token operator\">/</span> test_data_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        total_test_step <span class=\"token operator\">+=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>torch<span class=\"token punctuation\">.</span>save<span class=\"token punctuation\">(</span>net<span class=\"token punctuation\">,</span> <span class=\"token string\">\"net_DI.pth\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"模型已保存\"</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>像这种简单点的模型训练几步就完成了，但是如果我的组件再多一点，加自定义损失，加绘图呢？甚至说我们在里面写整理 batch，新建算法单元，这都是问题，代码只会越来越臃肿，变得不可维护，PyTorch Lightning 应运而生。</p>\n<h2 id=\"从pytorch迁移到pytorch-lightning\"><a class=\"markdownIt-Anchor\" href=\"#从pytorch迁移到pytorch-lightning\">#</a> 从 PyTorch 迁移到 PyTorch Lightning</h2>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span> lightning<span class=\"token punctuation\">.</span>pytorch<span class=\"token punctuation\">.</span>callbacks <span class=\"token keyword\">import</span> TQDMProgressBar</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> lightning<span class=\"token punctuation\">.</span>pytorch<span class=\"token punctuation\">.</span>utilities<span class=\"token punctuation\">.</span>types <span class=\"token keyword\">import</span> TRAIN_DATALOADERS</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> torch<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span>data <span class=\"token keyword\">import</span> DataLoader</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">from</span> torch <span class=\"token keyword\">import</span> optim<span class=\"token punctuation\">,</span> nn<span class=\"token punctuation\">,</span> utils<span class=\"token punctuation\">,</span> Tensor</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> torchvision<span class=\"token punctuation\">.</span>datasets <span class=\"token keyword\">import</span> MNIST</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">from</span> torchvision <span class=\"token keyword\">import</span> transforms</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">import</span> lightning <span class=\"token keyword\">as</span> L</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">from</span> model <span class=\"token keyword\">import</span> Net</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">LitMo</span><span class=\"token punctuation\">(</span>L<span class=\"token punctuation\">.</span>LightningModule<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        self<span class=\"token punctuation\">.</span>model <span class=\"token operator\">=</span> Net<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        self<span class=\"token punctuation\">.</span>loss_fn <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>CrossEntropyLoss<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        transform <span class=\"token operator\">=</span> transforms<span class=\"token punctuation\">.</span>Compose<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            transforms<span class=\"token punctuation\">.</span>ToTensor<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            transforms<span class=\"token punctuation\">.</span>Normalize<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.1307</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.3081</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        self<span class=\"token punctuation\">.</span>datasets_mnist_train <span class=\"token operator\">=</span> MNIST<span class=\"token punctuation\">(</span><span class=\"token string\">\"data\"</span><span class=\"token punctuation\">,</span> train<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> transform<span class=\"token operator\">=</span>transform<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                                          download<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>model<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">training_step</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> batch<span class=\"token punctuation\">,</span> batch_idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        x<span class=\"token punctuation\">,</span> y <span class=\"token operator\">=</span> batch</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        pred <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>forward<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        loss <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>loss_fn<span class=\"token punctuation\">(</span>pred<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        self<span class=\"token punctuation\">.</span>log<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            <span class=\"token string\">\"train_loss\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            loss<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            on_step<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            on_epoch<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            prog_bar<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            logger<span class=\"token operator\">=</span><span class=\"token boolean\">True</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token keyword\">return</span> loss</pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">train_dataloader</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> TRAIN_DATALOADERS<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token keyword\">return</span> DataLoader<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>datasets_mnist_train<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                          batch_size<span class=\"token operator\">=</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                          shuffle<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                          num_workers<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                          persistent_workers<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                          pin_memory<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">configure_optimizers</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        optimizer <span class=\"token operator\">=</span> optim<span class=\"token punctuation\">.</span>Adam<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>parameters<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> lr<span class=\"token operator\">=</span><span class=\"token number\">1e-3</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token keyword\">return</span> optimizer</pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">'__main__'</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    model <span class=\"token operator\">=</span> LitMo<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    trainer <span class=\"token operator\">=</span> L<span class=\"token punctuation\">.</span>Trainer<span class=\"token punctuation\">(</span>max_epochs<span class=\"token operator\">=</span><span class=\"token number\">20</span><span class=\"token punctuation\">,</span> accelerator<span class=\"token operator\">=</span><span class=\"token string\">\"gpu\"</span><span class=\"token punctuation\">,</span> devices<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> logger<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>                        enable_progress_bar<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                        callbacks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>TQDMProgressBar<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                        log_every_n_steps<span class=\"token operator\">=</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    trainer<span class=\"token punctuation\">.</span>fit<span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>这段代码给我的第一感觉就是模块化，没有训练循环，代码可维护性显著提升，他还有一些其他功能，扩展成本极低。当然以上代码仍然耦合度较高，下面请各位跟着我一步步做解耦。</p>\n<h2 id=\"将数据部分从lm中分离\"><a class=\"markdownIt-Anchor\" href=\"#将数据部分从lm中分离\">#</a> 将数据部分从 LM 中分离</h2>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> lightning <span class=\"token keyword\">as</span> L</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> torch</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> lightning<span class=\"token punctuation\">.</span>pytorch<span class=\"token punctuation\">.</span>utilities<span class=\"token punctuation\">.</span>types <span class=\"token keyword\">import</span> TRAIN_DATALOADERS</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">from</span> torch<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span>data <span class=\"token keyword\">import</span> random_split<span class=\"token punctuation\">,</span> DataLoader</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> torchvision <span class=\"token keyword\">import</span> transforms</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">from</span> torchvision<span class=\"token punctuation\">.</span>datasets <span class=\"token keyword\">import</span> MNIST</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">MyDDataModule</span><span class=\"token punctuation\">(</span>L<span class=\"token punctuation\">.</span>LightningDataModule<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> data_dir<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        self<span class=\"token punctuation\">.</span>data_test <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        self<span class=\"token punctuation\">.</span>data_val <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        self<span class=\"token punctuation\">.</span>data_train <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        self<span class=\"token punctuation\">.</span>data_dir <span class=\"token operator\">=</span> data_dir</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">prepare_data</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">pass</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">setup</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> stage<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        dataset <span class=\"token operator\">=</span> MNIST<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>data_dir<span class=\"token punctuation\">,</span> train<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> download<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> transform<span class=\"token operator\">=</span>transforms<span class=\"token punctuation\">.</span>ToTensor<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        self<span class=\"token punctuation\">.</span>data_train<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>data_val<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>data_test <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            random_split<span class=\"token punctuation\">(</span>dataset<span class=\"token operator\">=</span>dataset<span class=\"token punctuation\">,</span> lengths<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token number\">55000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5000</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                         generator<span class=\"token operator\">=</span>torch<span class=\"token punctuation\">.</span>Generator<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>manual_seed<span class=\"token punctuation\">(</span><span class=\"token number\">42</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">train_dataloader</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> TRAIN_DATALOADERS<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token keyword\">return</span> DataLoader<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>data_train<span class=\"token punctuation\">,</span> batch_size<span class=\"token operator\">=</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> shuffle<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> num_workers<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">val_dataloader</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> TRAIN_DATALOADERS<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token keyword\">return</span> DataLoader<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>data_val<span class=\"token punctuation\">,</span> batch_size<span class=\"token operator\">=</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> shuffle<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> num_workers<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">test_dataloader</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> TRAIN_DATALOADERS<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token keyword\">return</span> DataLoader<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>data_test<span class=\"token punctuation\">,</span> batch_size<span class=\"token operator\">=</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> shuffle<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> num_workers<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h3 id=\"先介绍几个实用工具\"><a class=\"markdownIt-Anchor\" href=\"#先介绍几个实用工具\">#</a> 先介绍几个实用工具</h3>\n<p>他们都是已经写好的方法了，我们不用再造轮子了</p>\n<h4 id=\"accuracy\"><a class=\"markdownIt-Anchor\" href=\"#accuracy\">#</a> Accuracy</h4>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>self<span class=\"token punctuation\">.</span>train_acc <span class=\"token operator\">=</span> Accuracy<span class=\"token punctuation\">(</span>task<span class=\"token operator\">=</span><span class=\"token string\">\"multiclass\"</span><span class=\"token punctuation\">,</span> num_classes<span class=\"token operator\">=</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>Accuracy = 预测正确的样本数 / 总样本数</p>\n<h4 id=\"meanmetric\"><a class=\"markdownIt-Anchor\" href=\"#meanmetric\">#</a> MeanMetric</h4>\n<p>MeanMetric 是自动帮你统计平均值的对象</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>self<span class=\"token punctuation\">.</span>train_loss <span class=\"token operator\">=</span> MeanMetric<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>TorchMetrics 在分布式场景下会自动做 all_reduce，同步各卡统计值。</p>\n<h4 id=\"maxmetric\"><a class=\"markdownIt-Anchor\" href=\"#maxmetric\">#</a> MaxMetric</h4>\n<p>和上面那个原理是一样的，这个是聚焦于最大值。</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>self<span class=\"token punctuation\">.</span>val_acc_best <span class=\"token operator\">=</span> MaxMetric<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h2 id=\"lightningmodule的生命周期\"><a class=\"markdownIt-Anchor\" href=\"#lightningmodule的生命周期\">#</a> LightningModule 的生命周期</h2>\n<ol>\n<li>on_fit_start，整个 fit 只执行一次。</li>\n<li>on_train_start，初始化记录器，reset metric。</li>\n<li>on_train_epoch_start</li>\n<li>on_train_batch_start</li>\n<li>training_step</li>\n<li>on_before_backward</li>\n<li>backward</li>\n<li>on_after_backward</li>\n<li>optimizer_step</li>\n<li>on_train_batch_end</li>\n<li>on_validation_epoch_start</li>\n<li>validation_step</li>\n<li>on_validation_epoch_end</li>\n<li>on_train_end</li>\n<li>on_fit_end</li>\n</ol>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>on_fit_start<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>on_train_start<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">for</span> epoch <span class=\"token keyword\">in</span> epochs<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    on_train_epoch_start<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">for</span> batch<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            on_train_batch_start<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            training_step<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            backward<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            optimizer_step<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            on_train_batch_end<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    on_train_epoch_end<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token comment\"># 验证阶段</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        on_validation_epoch_start<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        validation_step<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        on_validation_epoch_end<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>on_train_end<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>on_fit_end<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h2 id=\"lightningdatamodule的生命周期\"><a class=\"markdownIt-Anchor\" href=\"#lightningdatamodule的生命周期\">#</a> LightningDataModule 的生命周期</h2>\n<ol>\n<li>prepare_data</li>\n<li>setup</li>\n<li>train_dataloader</li>\n<li>val_dataloader</li>\n</ol>\n<p>fit 结束</p>\n<ol>\n<li>setup</li>\n<li>test_dataloader</li>\n</ol>\n<p>test 结束</p>\n<h2 id=\"多卡训练\"><a class=\"markdownIt-Anchor\" href=\"#多卡训练\">#</a> 多卡训练</h2>\n<p>Trainer 默认会在所有可用 GPU 上运行</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 运行在默认可用的多块显卡上</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>trainer <span class=\"token operator\">=</span> Trainer<span class=\"token punctuation\">(</span>accelerator<span class=\"token operator\">=</span><span class=\"token string\">\"auto\"</span><span class=\"token punctuation\">,</span> devices<span class=\"token operator\">=</span><span class=\"token string\">\"auto\"</span><span class=\"token punctuation\">,</span> strategy<span class=\"token operator\">=</span><span class=\"token string\">\"auto\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 等价于</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>trainer <span class=\"token operator\">=</span> Trainer<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 运行在一块显卡上</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>trainer <span class=\"token operator\">=</span> Trainer<span class=\"token punctuation\">(</span>accelerator<span class=\"token operator\">=</span><span class=\"token string\">\"gpu\"</span><span class=\"token punctuation\">,</span> devices<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># 运行于多个 GPU</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>trainer <span class=\"token operator\">=</span> Trainer<span class=\"token punctuation\">(</span>accelerator<span class=\"token operator\">=</span><span class=\"token string\">\"gpu\"</span><span class=\"token punctuation\">,</span> devices<span class=\"token operator\">=</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 自动选择设备数量</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>trainer <span class=\"token operator\">=</span> Trainer<span class=\"token punctuation\">(</span>accelerator<span class=\"token operator\">=</span><span class=\"token string\">\"gpu\"</span><span class=\"token punctuation\">,</span> devices<span class=\"token operator\">=</span><span class=\"token string\">\"auto\"</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>详情请参考：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9saWdodG5pbmcuYWkvZG9jcy9weXRvcmNoL3N0YWJsZS9hY2NlbGVyYXRvcnMvZ3B1X2Jhc2ljLmh0bWwjY2hvb3NpbmctZ3B1LWRldmljZXM=\">https://lightning.ai/docs/pytorch/stable/accelerators/gpu_basic.html#choosing-gpu-devices</span></p>\n<h2 id=\"trainer关键配置\"><a class=\"markdownIt-Anchor\" href=\"#trainer关键配置\">#</a> Trainer 关键配置</h2>\n<ol>\n<li>max_epochs 最大循环次数</li>\n<li>max_steps 最大前向传播次数，这个的优先级比 max_epochs 高</li>\n<li>check_val_every_n_epoch 不配置默认每 1epoch 进行一次 val</li>\n<li>val_check_interval 这个是多少批次后进行一次 val</li>\n<li>gradient_clip_val 梯度裁剪</li>\n</ol>\n<h2 id=\"日志框架\"><a class=\"markdownIt-Anchor\" href=\"#日志框架\">#</a> 日志框架</h2>\n<p>我认为 PL 对日志的封装是非常强大，非常方便的。</p>\n<h3 id=\"训练过程日志\"><a class=\"markdownIt-Anchor\" href=\"#训练过程日志\">#</a> 训练过程日志</h3>\n<p>还记得之前的 log 块吗，Lightning 已经帮我们自动装配好了 TensorBorad！</p>\n<img data-src=\"../../images/python/lightning/1.png\" alt=\"1\" style=\"zoom:75%;\" />\n<h3 id=\"超参数日志\"><a class=\"markdownIt-Anchor\" href=\"#超参数日志\">#</a> 超参数日志</h3>\n<p>在 LM 的初始化方法下加入：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>self<span class=\"token punctuation\">.</span>save_hyperparameters<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><img data-src=\"../../images/python/lightning/2.png\" alt=\"1\" style=\"zoom:75%;\" />\n<p>它会把这里的参数记录下来：</p>\n<img data-src=\"../../images/python/lightning/3.png\" alt=\"1\" style=\"zoom:75%;\" />\n<h3 id=\"log中的on_step与on_epoch\"><a class=\"markdownIt-Anchor\" href=\"#log中的on_step与on_epoch\">#</a> Log 中的 on_step 与 on_epoch</h3>\n<img data-src=\"../../images/python/lightning/4.png\" alt=\"1\" style=\"zoom:75%;\" />\n<p>一般来说在 Validation 中设置 <code>on_step=False, on_epoch=True</code> ，在 training_step 中设置 <code>on_step=True, on_epoch=True</code> ，这样设置的话，在日志中可以看到两种训练曲线一个是每步的训练曲线，比较详细，另一个是每一个大循环的曲线，也就是 epoch 的，它比较平均。</p>\n<img data-src=\"../../images/python/lightning/5.png\" alt=\"1\" style=\"zoom:75%;\" />\n<h3 id=\"安装了tensorboard又想使用csvlog\"><a class=\"markdownIt-Anchor\" href=\"#安装了tensorboard又想使用csvlog\">#</a> 安装了 TensorBoard 又想使用 csvLog</h3>\n<p>通常来说 TensorBoard 的只是在我们训练中进行日志查看，如果想绘制更精美的曲线图片的话，通常我会使用 matplotlib 或者是 matlab 进行绘制，但是你安装了 TB 之后还是 csvlog 会默认禁用，当然也从 TB 可以下载数据。可以通过如下方式进行再次开启：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>csv_logger <span class=\"token operator\">=</span> CSVLogger<span class=\"token punctuation\">(</span><span class=\"token string\">\"lightning_logs\"</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">=</span><span class=\"token string\">\"csv\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>tb_logger <span class=\"token operator\">=</span> TensorBoardLogger<span class=\"token punctuation\">(</span><span class=\"token string\">\"lightning_logs\"</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">=</span><span class=\"token string\">\"tb\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    trainer <span class=\"token operator\">=</span> L<span class=\"token punctuation\">.</span>Trainer<span class=\"token punctuation\">(</span>max_epochs<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> accelerator<span class=\"token operator\">=</span><span class=\"token string\">\"gpu\"</span><span class=\"token punctuation\">,</span> devices<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> logger<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>csv_logger<span class=\"token punctuation\">,</span> tb_logger<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                        enable_progress_bar<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                        callbacks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>TQDMProgressBar<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> LearningRateMonitor<span class=\"token punctuation\">(</span>logging_interval<span class=\"token operator\">=</span><span class=\"token string\">\"epoch\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                        log_every_n_steps<span class=\"token operator\">=</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><img data-src=\"../../images/python/lightning/6.png\" alt=\"1\" style=\"zoom:75%;\" />\n<h2 id=\"checkpoint\"><a class=\"markdownIt-Anchor\" href=\"#checkpoint\">#</a> checkpoint</h2>\n<h3 id=\"断点续测\"><a class=\"markdownIt-Anchor\" href=\"#断点续测\">#</a> 断点续测</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>model <span class=\"token operator\">=</span> LitMo<span class=\"token punctuation\">.</span>load_from_checkpoint<span class=\"token punctuation\">(</span><span class=\"token string\">\"ckpt路径\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>trainer<span class=\"token punctuation\">.</span>test<span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">,</span> datamodule<span class=\"token operator\">=</span>datamodule<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h3 id=\"断点续训\"><a class=\"markdownIt-Anchor\" href=\"#断点续训\">#</a> 断点续训</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>trainer<span class=\"token punctuation\">.</span>fit<span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">,</span> datamodule<span class=\"token operator\">=</span>datamodule<span class=\"token punctuation\">,</span>ckpt_path<span class=\"token operator\">=</span><span class=\"token string\">\"ckpt路径\"</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h3 id=\"最佳权重与最新权重共存\"><a class=\"markdownIt-Anchor\" href=\"#最佳权重与最新权重共存\">#</a> 最佳权重与最新权重共存</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>checkpoint_callback <span class=\"token operator\">=</span> ModelCheckpoint<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    monitor<span class=\"token operator\">=</span><span class=\"token string\">\"val/loss\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    mode<span class=\"token operator\">=</span><span class=\"token string\">\"min\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    save_top_k<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    save_last<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    filename<span class=\"token operator\">=</span><span class=\"token string\">\"best-&#123;epoch:02d&#125;\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>trainer <span class=\"token operator\">=</span> L<span class=\"token punctuation\">.</span>Trainer<span class=\"token punctuation\">(</span>max_epochs<span class=\"token operator\">=</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> accelerator<span class=\"token operator\">=</span><span class=\"token string\">\"gpu\"</span><span class=\"token punctuation\">,</span> devices<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> logger<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>csv_logger<span class=\"token punctuation\">,</span> tb_logger<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                        enable_progress_bar<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                        callbacks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>TQDMProgressBar<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> LearningRateMonitor<span class=\"token punctuation\">(</span>logging_interval<span class=\"token operator\">=</span><span class=\"token string\">\"epoch\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                                   checkpoint_callback<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                        log_every_n_steps<span class=\"token operator\">=</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h1 id=\"lightning-hydra-template\"><a class=\"markdownIt-Anchor\" href=\"#lightning-hydra-template\">#</a> lightning-hydra-template</h1>\n<p>【开源地址】：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2FzaGxldmUvbGlnaHRuaW5nLWh5ZHJhLXRlbXBsYXRl\">https://github.com/ashleve/lightning-hydra-template</span></p>\n<p>lightning-hydra-template 帮你解决：Hydra 超参数管理、Lightning 训练逻辑分离、TensorBoard 日志管理、自动保存 best.ckpt、多实验管理用你自己从 0 设计项目结构。</p>\n<h2 id=\"configs\"><a class=\"markdownIt-Anchor\" href=\"#configs\">#</a> configs</h2>\n<p>这是 <strong>Hydra 的配置根目录</strong>，所有  <code>.yaml</code>  都可以通过命令行覆盖。</p>\n<img data-src=\"../../images/python/lightning/7.png\" alt=\"1\" style=\"zoom:75%;\" />\n<h3 id=\"trainer\"><a class=\"markdownIt-Anchor\" href=\"#trainer\">#</a> trainer</h3>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>configs/trainer/</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>├── default.yaml</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>├── cpu.yaml</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>├── gpu.yaml</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>├── ddp.yaml</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>├── ddp_sim.yaml</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>├── mps.yaml</pre></td></tr></table></figure><p>控制 Lightning Trainer 的行为。训练轮次、最小训练 epochs、最大训练 epochs 等，这些都在 default 之中：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">_target_</span><span class=\"token punctuation\">:</span> lightning.pytorch.trainer.Trainer</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">default_root_dir</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">&#123;</span>paths.output_dir<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token key atrule\">min_epochs</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span> <span class=\"token comment\"># prevents early stopping</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">max_epochs</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token key atrule\">accelerator</span><span class=\"token punctuation\">:</span> cpu</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token key atrule\">devices</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># mixed precision for extra speed-up</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># precision: 16</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># perform a validation loop every N training epochs</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token key atrule\">check_val_every_n_epoch</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\"># set True to to ensure deterministic results</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\"># makes training slower but gives more reproducibility than just setting seeds</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token key atrule\">deterministic</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">False</span></pre></td></tr></table></figure><h3 id=\"model\"><a class=\"markdownIt-Anchor\" href=\"#model\">#</a> model</h3>\n<p>定义模型结构 + 模型超参数：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">_target_</span><span class=\"token punctuation\">:</span> src.models.mnist_module.MNISTLitModule</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">optimizer</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">_target_</span><span class=\"token punctuation\">:</span> torch.optim.Adam</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">_partial_</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token key atrule\">lr</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0.001</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">weight_decay</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0.0</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#scheduler:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#  _target_: torch.optim.lr_scheduler.ReduceLROnPlateau</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">#  _partial_: true</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">#  mode: min</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">#  factor: 0.1</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">#  patience: 10</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token key atrule\">scheduler</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token key atrule\">_target_</span><span class=\"token punctuation\">:</span> torch.optim.lr_scheduler.CosineAnnealingLR</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token key atrule\">_partial_</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token key atrule\">T_max</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">&#123;</span>trainer.max_epochs<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token key atrule\">eta_min</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0.00001</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token key atrule\">net</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token key atrule\">_target_</span><span class=\"token punctuation\">:</span> src.models.components.simple_dense_net.SimpleDenseNet</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token key atrule\">input_size</span><span class=\"token punctuation\">:</span> <span class=\"token number\">784</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token key atrule\">lin1_size</span><span class=\"token punctuation\">:</span> <span class=\"token number\">64</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token key atrule\">lin2_size</span><span class=\"token punctuation\">:</span> <span class=\"token number\">128</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token key atrule\">lin3_size</span><span class=\"token punctuation\">:</span> <span class=\"token number\">64</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token key atrule\">output_size</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\"># compile model for faster training with pytorch 2.0</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token key atrule\">compile</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span></pre></td></tr></table></figure><h3 id=\"data\"><a class=\"markdownIt-Anchor\" href=\"#data\">#</a> data</h3>\n<p>数据相关内容：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">_target_</span><span class=\"token punctuation\">:</span> src.data.mnist_datamodule.MNISTDataModule</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">data_dir</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">&#123;</span>paths.data_dir<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">batch_size</span><span class=\"token punctuation\">:</span> <span class=\"token number\">128</span> <span class=\"token comment\"># Needs to be divisible by the number of devices (e.g., if in a distributed setup)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token key atrule\">train_val_test_split</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>55_000<span class=\"token punctuation\">,</span> 5_000<span class=\"token punctuation\">,</span> 10_000<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token key atrule\">num_workers</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">pin_memory</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">True</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token key atrule\">persistent_workers</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">True</span></pre></td></tr></table></figure><h3 id=\"callbacks\"><a class=\"markdownIt-Anchor\" href=\"#callbacks\">#</a> callbacks</h3>\n<p>训练控制逻辑 ModelCheckpoint、EarlyStopping、LearningRateMonitor、RichProgressBar 等，不用在代码里 new callback。</p>\n<h3 id=\"logger\"><a class=\"markdownIt-Anchor\" href=\"#logger\">#</a> logger</h3>\n<p>控制用什么日志后端：</p>\n<ul>\n<li>TensorBoard</li>\n<li>WandB</li>\n<li>CSVLogger</li>\n</ul>\n<h3 id=\"experiment\"><a class=\"markdownIt-Anchor\" href=\"#experiment\">#</a> experiment</h3>\n<p>消融实验的核心目录：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>python src/train.py <span class=\"token assign-left variable\">experiment</span><span class=\"token operator\">=</span>mnist_baseline</pre></td></tr></table></figure><h3 id=\"hparams_search\"><a class=\"markdownIt-Anchor\" href=\"#hparams_search\">#</a> hparams_search</h3>\n<p>和 <strong>Optuna</strong> 联动的超参数搜索，自动跑多组实验。</p>\n<h3 id=\"debug\"><a class=\"markdownIt-Anchor\" href=\"#debug\">#</a> debug</h3>\n<p>快速调试用配置：只跑 1 个 batch、只跑 1 个 epoch、打印更多日志。</p>\n<h3 id=\"extras\"><a class=\"markdownIt-Anchor\" href=\"#extras\">#</a> extras</h3>\n<p>辅助功能开关，比如：是否打印模型结构、是否启用异常追踪、是否保存代码快照。</p>\n<h3 id=\"hydra\"><a class=\"markdownIt-Anchor\" href=\"#hydra\">#</a> hydra</h3>\n<p>控制 Hydra 本身的行为：日志目录结构、输出路径格式。</p>\n<h3 id=\"paths\"><a class=\"markdownIt-Anchor\" href=\"#paths\">#</a> paths</h3>\n<p>路径统一管理，数据路径、日志路径、checkpoint 路径。</p>\n<h3 id=\"local\"><a class=\"markdownIt-Anchor\" href=\"#local\">#</a> local</h3>\n<p>本机私有配置</p>\n<h3 id=\"trainyaml-evalyaml\"><a class=\"markdownIt-Anchor\" href=\"#trainyaml-evalyaml\">#</a> train.yaml / eval.yaml</h3>\n<p>Hydra 的<strong>主配置文件</strong></p>\n<ul>\n<li>train.yaml：训练入口</li>\n<li>eval.yaml：测试 / 推理入口</li>\n</ul>\n<h3 id=\"一个完整调用是怎么发生的\"><a class=\"markdownIt-Anchor\" href=\"#一个完整调用是怎么发生的\">#</a> 一个完整调用是怎么发生的</h3>\n<p>执行：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>python src/train.py <span class=\"token assign-left variable\">trainer</span><span class=\"token operator\">=</span>gpu <span class=\"token assign-left variable\">model</span><span class=\"token operator\">=</span>mnist <span class=\"token assign-left variable\">data</span><span class=\"token operator\">=</span>mnist</pre></td></tr></table></figure><ol>\n<li>读取  <code>train.yaml</code></li>\n<li>合并 trainer /model/data</li>\n<li>实例化 Lightning Trainer</li>\n<li>实例化 Model / DataModule</li>\n<li>开始训练</li>\n</ol>\n<p><strong>lightning-hydra-template = 用配置驱动一切</strong></p>\n<ul>\n<li>trainer/ 怎么训</li>\n<li>model/ 用什么模型</li>\n<li>data/ 数据怎么来</li>\n<li>callbacks/ 训练怎么停 / 怎么存</li>\n<li>logger/ 日志怎么记</li>\n<li>experiment/ 实验怎么复现</li>\n</ul>\n<h2 id=\"hydra的跨yaml读取\"><a class=\"markdownIt-Anchor\" href=\"#hydra的跨yaml读取\">#</a> Hydra 的跨 yaml 读取</h2>\n<p>通过 ${trainer.max_epochs} 跨文件读取 trainer.yaml 里的值</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">scheduler</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">_target_</span><span class=\"token punctuation\">:</span> torch.optim.lr_scheduler.CosineAnnealingLR</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token key atrule\">_partial_</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">T_max</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">&#123;</span>trainer.max_epochs<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">eta_min</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0.00001</span></pre></td></tr></table></figure><p>当 Hydra 运行时，它会将所有分散的 YAML 文件组合成一个巨大的 Config 树：</p>\n<ul>\n<li><strong> <code>trainer.yaml</code> </strong> 里的内容会被放在  <code>config.trainer</code>  下。</li>\n<li><strong> <code>model.yaml</code> </strong> 里的内容会被放在  <code>config.model</code>  下。</li>\n<li>使用  <code>$&#123;trainer.max_epochs&#125;</code>  就像是在说：“去  <code>trainer</code>  那个分支里帮我把  <code>max_epochs</code>  的数字拿过来。”</li>\n</ul>\n<h1 id=\"lh正在使多模型对比变得简单\"><a class=\"markdownIt-Anchor\" href=\"#lh正在使多模型对比变得简单\">#</a> LH 正在使多模型对比变得简单</h1>\n<img data-src=\"../../images/python/lightning/8.png\" alt=\"1\" style=\"zoom:75%;\" />\n",
            "tags": [
                "深度学习",
                "Lightning框架",
                "python",
                "深度学习",
                "pytorch",
                "Pytorch Lightning"
            ]
        },
        {
            "id": "https://735690757.github.io/experience/Ubuntu24-d/",
            "url": "https://735690757.github.io/experience/Ubuntu24-d/",
            "title": "双硬盘独立引导Windows与Ubuntu",
            "date_published": "2026-02-08T16:11:00.000Z",
            "content_html": "<h1 id=\"前言\"><a class=\"markdownIt-Anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>我有一台华为的笔记本电脑，我希望将其由原来的 Windows 系统扩展为 Windows 与 Ubuntu 双系统，这么做的核心目的在于我想测试一下分布式相关的内容。然而我的 C 盘已经不足 50G，不过我还有一块一 TB 的机械硬盘，这款机器硬盘还剩 600G，并且它的速度也不是很慢，足以运行 Linux 的发行版。其实我想以更为原生的方式来部署 docker，这样方便测试。如果你问我为什么不使用 VM Ware，我就想折腾一下哈哈哈。</p>\n<h1 id=\"创建ubuntu的引导盘\"><a class=\"markdownIt-Anchor\" href=\"#创建ubuntu的引导盘\">#</a> 创建 Ubuntu 的引导盘</h1>\n<p>我个人比较喜欢使用 Ventoy 来制作引导盘，鉴于我已经有一个引导盘了这里就不再进行详细展开，具体如何创建 Ventoy 引导盘可以查看其官网：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cudmVudG95Lm5ldC9jbi9pbmRleC5odG1s\">https://www.ventoy.net/cn/index.html</span></p>\n<h1 id=\"下载ubuntu2404镜像\"><a class=\"markdownIt-Anchor\" href=\"#下载ubuntu2404镜像\">#</a> 下载 Ubuntu24.04 镜像</h1>\n<p>Ubuntu24.04 镜像文件可以从其官网下载，<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbi51YnVudHUuY29tL2Rvd25sb2Fk\">https://cn.ubuntu.com/download</span></p>\n<p>截止 26 年 2 月 Ubuntu 镜像文件版本为 24.04.03，Ubuntu 24.04.03 LTS 专为桌面 PC 和笔记本精心打造的 Ubuntu 长期支持版本。24.04 LTS 将提供五年常规安全更新和维护。</p>\n<p>下载或者镜像需要放在引导盘中。</p>\n<h1 id=\"调整分区\"><a class=\"markdownIt-Anchor\" href=\"#调整分区\">#</a> 调整分区</h1>\n<p>安装系统前的首要任务是调整分区，当然系统已经安装好了 Windows，我们可以直接进入系统进行调整分区，找到那块机械硬盘将他压缩卷，压缩出 100GB 的空间，下图是已经安装好系统之后的样子，在安装好之后这 100GB 首先会分出大约 1GB 的 EFI 系统引导，其次是将近 99G 的主分区。</p>\n<img data-src=\"../../images/java/ubuntu24/1.jpg\" alt=\"1\" style=\"zoom: 33%;\" />\n<h1 id=\"进入bios调整引导顺序\"><a class=\"markdownIt-Anchor\" href=\"#进入bios调整引导顺序\">#</a> 进入 BIOS 调整引导顺序</h1>\n<p>接下来重启电脑注意这时候不要直接进入，系统根据你电脑的主板型号按下相应的进入 BIOS 按键，一般为长按或者快速连接，华为 MateBook D 的按键为 F2。</p>\n<img data-src=\"../../images/java/ubuntu24/2.jpg\" alt=\"1\" style=\"zoom: 33%;\" />\n<p>将这个 512G 的移动硬盘调整为第一启动顺序。</p>\n<h1 id=\"选择ubuntu启动\"><a class=\"markdownIt-Anchor\" href=\"#选择ubuntu启动\">#</a> 选择 Ubuntu 启动</h1>\n<img data-src=\"../../images/java/ubuntu24/3.jpg\" alt=\"1\" style=\"zoom: 33%;\" />\n<h1 id=\"设置挂载点\"><a class=\"markdownIt-Anchor\" href=\"#设置挂载点\">#</a> 设置挂载点</h1>\n<p>最关键的就是这里，其余的减值设置都可以跳过直接下一步就可以，如果有需要可以根据自己的实际情况设置。首先是找到我们的刚刚划分出来的 100G 空间，我们首先先选择用于安装引导程序的设备，因为我们需要做制作的是一个双引导独立的双系统，所以我们把引导设备也放在 100G 空间之中。</p>\n<img data-src=\"../../images/java/ubuntu24/4.jpg\" alt=\"1\" style=\"zoom: 33%;\" />\n<p>如上图所示挂在点为 <code>/boot/efi</code> 。</p>\n<p>接着选择剩下的 99G 作为主分区：</p>\n<img data-src=\"../../images/java/ubuntu24/5.jpg\" alt=\"1\" style=\"zoom: 33%;\" />\n<p>挂载点为 <code>\\</code> 。</p>\n<img data-src=\"../../images/java/ubuntu24/6.jpg\" alt=\"1\" style=\"zoom: 33%;\" />\n<p>接下来设置账户就不过多赘述了。</p>\n<img data-src=\"../../images/java/ubuntu24/7.jpg\" alt=\"1\" style=\"zoom: 33%;\" />\n<h1 id=\"安装中文输入法\"><a class=\"markdownIt-Anchor\" href=\"#安装中文输入法\">#</a> 安装中文输入法</h1>\n<p>安装输入法首先需要安装输入法框架，我推荐 ibus。</p>\n<p>打开终端输入：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> ibus</pre></td></tr></table></figure><p>切换命令框架：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>im-config <span class=\"token parameter variable\">-s</span> ibus</pre></td></tr></table></figure><p>GNOME 桌面支持包：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> ibus-gtk ibus-gtk3</pre></td></tr></table></figure><p>安装简体中文输入法：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> ibus-pinyin</pre></td></tr></table></figure><h1 id=\"ssh远程连接\"><a class=\"markdownIt-Anchor\" href=\"#ssh远程连接\">#</a> SSH 远程连接</h1>\n<p>设置 - 系统 - SSH</p>\n<img data-src=\"../../images/java/ubuntu24/7.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<h1 id=\"vnc-xorg\"><a class=\"markdownIt-Anchor\" href=\"#vnc-xorg\">#</a> VNC-Xorg</h1>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>loginctl show-session c2 <span class=\"token parameter variable\">-p</span> Type</pre></td></tr></table></figure><p>Type=x11，必须是  <code>x11</code> ，否则 VNC 接管不了默认桌面。</p>\n<h2 id=\"安装-vnc-服务端\"><a class=\"markdownIt-Anchor\" href=\"#安装-vnc-服务端\">#</a> 安装 VNC 服务端</h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> update</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> x11vnc <span class=\"token parameter variable\">-y</span></pre></td></tr></table></figure><h2 id=\"设置-vnc-连接密码\"><a class=\"markdownIt-Anchor\" href=\"#设置-vnc-连接密码\">#</a> 设置 VNC 连接密码</h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>x11vnc <span class=\"token parameter variable\">-storepasswd</span></pre></td></tr></table></figure><h2 id=\"控制开机那个桌面\"><a class=\"markdownIt-Anchor\" href=\"#控制开机那个桌面\">#</a> 控制开机那个桌面</h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>x11vnc <span class=\"token parameter variable\">-display</span> :0 <span class=\"token parameter variable\">-auth</span> guess <span class=\"token parameter variable\">-forever</span> <span class=\"token parameter variable\">-shared</span> <span class=\"token parameter variable\">-usepw</span> <span class=\"token parameter variable\">-bg</span></pre></td></tr></table></figure><h2 id=\"端口确认\"><a class=\"markdownIt-Anchor\" href=\"#端口确认\">#</a> 端口确认</h2>\n<p>一般为 5900.</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ss <span class=\"token parameter variable\">-lntp</span> <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> x11vnc</pre></td></tr></table></figure><h2 id=\"使用vnc客户端\"><a class=\"markdownIt-Anchor\" href=\"#使用vnc客户端\">#</a> 使用 VNC 客户端</h2>\n<p>下载：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucmVhbHZuYy5jb20vZW4v\">https://www.realvnc.com/en/</span></p>\n<img data-src=\"../../images/java/ubuntu24/8.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<p>输入 IP 加端口号，输入 Name，然后发起连接就行了。</p>\n",
            "tags": [
                "Java",
                "linux",
                "Ubantu"
            ]
        },
        {
            "id": "https://735690757.github.io/python/Geophysics/hello/",
            "url": "https://735690757.github.io/python/Geophysics/hello/",
            "title": "深度学习反演网络与重力异常之初窥门径",
            "date_published": "2026-02-07T04:12:12.000Z",
            "content_html": "<h1 id=\"深度学习反演网络与重力异常之初窥门径\"><a class=\"markdownIt-Anchor\" href=\"#深度学习反演网络与重力异常之初窥门径\">#</a> 深度学习反演网络与重力异常之初窥门径</h1>\n<h2 id=\"正演\"><a class=\"markdownIt-Anchor\" href=\"#正演\">#</a> 正演？</h2>\n<p>已知地下体的物理属性，比如密度、磁化率、电阻率和空间分布，预测或计算在地表或者测量点上观测到的地球物理异常。</p>\n<p>已知地下体的<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>ρ</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><mi>y</mi><mo separator=\"true\">,</mo><mi>z</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">ρ(x, y, z)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">ρ</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"mclose\">)</span></span></span></span> 密度矩阵、已知体素在空间中的位置，计算<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>g</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><mi>y</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">g(x, y)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\">)</span></span></span></span> 表面重力异常，这就是正演。</p>\n<p>正演公式可以理解为：</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>g</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><mi>y</mi><mo stretchy=\"false\">)</mo><mo>=</mo><munder><mo>∑</mo><mrow><mi>i</mi><mo separator=\"true\">,</mo><mi>j</mi><mo separator=\"true\">,</mo><mi>k</mi></mrow></munder><mi>f</mi><mo stretchy=\"false\">(</mo><msub><mi>ρ</mi><mrow><mi>i</mi><mo separator=\"true\">,</mo><mi>j</mi><mo separator=\"true\">,</mo><mi>k</mi></mrow></msub><mo separator=\"true\">,</mo><msub><mi>r</mi><mrow><mi>i</mi><mo separator=\"true\">,</mo><mi>j</mi><mo separator=\"true\">,</mo><mi>k</mi></mrow></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">g(x, y) = \\sum_{i, j, k} f(\\rho_{i, j, k}, r_{i, j, k})\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.488226em;vertical-align:-1.438221em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.050005em;\"><span style=\"top:-1.8478869999999998em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span style=\"top:-3.0500049999999996em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.438221em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">ρ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></span></p>\n<p><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>g</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><mi>y</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">g(x, y)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\">)</span></span></span></span>：</strong> 这是你在地表（坐标 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi><mo separator=\"true\">,</mo><mi>y</mi></mrow><annotation encoding=\"application/x-tex\">x, y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span></span>）观测到的物理场信号，比如重力异常、磁力异常或地震波响应。</p>\n<p><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mo>∑</mo><mrow><mi>i</mi><mo separator=\"true\">,</mo><mi>j</mi><mo separator=\"true\">,</mo><mi>k</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\sum_{i, j, k}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.185818em;vertical-align:-0.43581800000000004em;\"></span><span class=\"mop\"><span class=\"mop op-symbol small-op\" style=\"position:relative;top:-0.0000050000000000050004em;\">∑</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.18639799999999984em;\"><span style=\"top:-2.40029em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.43581800000000004em;\"><span></span></span></span></span></span></span></span></span></span>（过程）：</strong> 它意味着我们要把地下所有 “小方块”（网格单元）产生的贡献全部加起来。</p>\n<p><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>f</mi><mo stretchy=\"false\">(</mo><mo>…</mo><mtext> </mtext><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">f(\\dots)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mopen\">(</span><span class=\"minner\">…</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mclose\">)</span></span></span></span>：</strong> 这是单个单元对地表的贡献计算方式。</p>\n<ul>\n<li><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>ρ</mi><mrow><mi>i</mi><mo separator=\"true\">,</mo><mi>j</mi><mo separator=\"true\">,</mo><mi>k</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\rho_{i, j, k}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.716668em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">ρ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span>：</strong> 该单元的物性参数（如密度、磁化率、速度等）。</li>\n<li><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>r</mi><mrow><mi>i</mi><mo separator=\"true\">,</mo><mi>j</mi><mo separator=\"true\">,</mo><mi>k</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">r_{i, j, k}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.716668em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span>：</strong> 该单元距离地表观测点的几何位置关系。</li>\n</ul>\n<p>针对重力方面，重力场的基础公式来源于<strong>牛顿万有引力定律</strong>：对于地表上的一点<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>P</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><mi>y</mi><mo separator=\"true\">,</mo><mi>z</mi><mo>=</mo><mn>0</mn><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">P(x,y,z=0)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">0</span><span class=\"mclose\">)</span></span></span></span>，受到地下体中一个体素<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">Δ</mi><mi>V</mi></mrow><annotation encoding=\"application/x-tex\">\\Delta V</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\">Δ</span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">V</span></span></span></span> 的密度<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>ρ</mi></mrow><annotation encoding=\"application/x-tex\">\\rho</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">ρ</span></span></span></span> 产生的垂直向重力加速度<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>g</mi><mi>z</mi></msub></mrow><annotation encoding=\"application/x-tex\">g_z</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.04398em;\">z</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 为：</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi mathvariant=\"normal\">Δ</mi><msub><mi>g</mi><mi>z</mi></msub><mo>=</mo><mi>G</mi><mo>⋅</mo><mi>ρ</mi><mo>⋅</mo><mi mathvariant=\"normal\">Δ</mi><mi>V</mi><mo>⋅</mo><mfrac><msup><mi>z</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mrow><mo stretchy=\"false\">(</mo><msup><mi>x</mi><mrow><mo mathvariant=\"normal\">′</mo><mn>2</mn></mrow></msup><mo>+</mo><msup><mi>y</mi><mrow><mo mathvariant=\"normal\">′</mo><mn>2</mn></mrow></msup><mo>+</mo><msup><mi>z</mi><mrow><mo mathvariant=\"normal\">′</mo><mn>2</mn></mrow></msup><msup><mo stretchy=\"false\">)</mo><mrow><mn>3</mn><mi mathvariant=\"normal\">/</mi><mn>2</mn></mrow></msup></mrow></mfrac></mrow><annotation encoding=\"application/x-tex\">\\Delta g_z = G \\cdot \\rho \\cdot \\Delta V \\cdot \\frac{z&#x27;}{(x&#x27;^2 + y&#x27;^2 + z&#x27;^2)^{3/2}}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8777699999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord\">Δ</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.04398em;\">z</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">G</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.63889em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">ρ</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\">Δ</span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">V</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.382892em;vertical-align:-0.954em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.428892em;\"><span style=\"top:-2.2960000000000003em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.740108em;\"><span style=\"top:-2.9890000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.740108em;\"><span style=\"top:-2.9890000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.740108em;\"><span style=\"top:-2.9890000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.814em;\"><span style=\"top:-2.989em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">3</span><span class=\"mord mtight\">/</span><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.954em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span></p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>G</mi><mo>≈</mo><mn>6.674</mn><mo>×</mo><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>11</mn></mrow></msup><msup><mtext>m</mtext><mn>3</mn></msup><msup><mtext>kg</mtext><mrow><mo>−</mo><mn>1</mn></mrow></msup><msup><mtext>s</mtext><mrow><mo>−</mo><mn>2</mn></mrow></msup></mrow><annotation encoding=\"application/x-tex\">G\\approx 6.674 \\times 10^{-11} \\text{m}^3\\text{kg}^{-1}\\text{s}^{-2}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">G</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">≈</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">6</span><span class=\"mord\">.</span><span class=\"mord\">6</span><span class=\"mord\">7</span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.0928879999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord\">1</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.864108em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">−</span><span class=\"mord mtight\">1</span><span class=\"mord mtight\">1</span></span></span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">m</span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641079999999999em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">3</span></span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">kg</span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8984479999999999em;\"><span style=\"top:-3.14734em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">s</span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.864108em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">−</span><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span></span></p>\n<p>这里只考虑垂直方向的重力加速度，因为重力测量仪器主要测垂直分量。</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mi>g</mi><mi>z</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><mi>y</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mi>G</mi><msub><mo>∭</mo><mi>V</mi></msub><mfrac><mrow><mi>ρ</mi><mo stretchy=\"false\">(</mo><msup><mi>x</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mo separator=\"true\">,</mo><msup><mi>y</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mo separator=\"true\">,</mo><msup><mi>z</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mo stretchy=\"false\">)</mo><mo>⋅</mo><mo stretchy=\"false\">(</mo><msup><mi>z</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mo>−</mo><msub><mi>z</mi><mrow><mi>o</mi><mi>b</mi><mi>s</mi></mrow></msub><mo stretchy=\"false\">)</mo></mrow><mrow><mo stretchy=\"false\">[</mo><mo stretchy=\"false\">(</mo><mi>x</mi><mo>−</mo><msup><mi>x</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy=\"false\">(</mo><mi>y</mi><mo>−</mo><msup><mi>y</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy=\"false\">(</mo><msup><mi>z</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mo>−</mo><msub><mi>z</mi><mrow><mi>o</mi><mi>b</mi><mi>s</mi></mrow></msub><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup><msup><mo stretchy=\"false\">]</mo><mrow><mn>3</mn><mi mathvariant=\"normal\">/</mi><mn>2</mn></mrow></msup></mrow></mfrac><mi>d</mi><msup><mi>x</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mi>d</mi><msup><mi>y</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mi>d</mi><msup><mi>z</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup></mrow><annotation encoding=\"application/x-tex\">g_z(x,y) = G \\iiint_V \\frac{\\rho(x&#x27;,y&#x27;,z&#x27;) \\cdot (z&#x27; - z_{obs})}{[(x - x&#x27;)^2 + (y - y&#x27;)^2 + (z&#x27; - z_{obs})^2]^{3/2}} dx&#x27; dy&#x27; dz&#x27;\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.04398em;\">z</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.382892em;vertical-align:-0.954em;\"></span><span class=\"mord mathnormal\">G</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\"><span class=\"mop op-symbol large-op\" style=\"margin-right:0.44445em;position:relative;top:-0.0009999999999999454em;\">∭</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:-0.433369em;\"><span style=\"top:-1.7883000000000002em;margin-left:-0.44445em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.22222em;\">V</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9117em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.428892em;\"><span style=\"top:-2.2960000000000003em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mopen\">[</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6778919999999999em;\"><span style=\"top:-2.9890000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.740108em;\"><span style=\"top:-2.9890000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6778919999999999em;\"><span style=\"top:-2.9890000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.740108em;\"><span style=\"top:-2.9890000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6778919999999999em;\"><span style=\"top:-2.9890000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\">s</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.740108em;\"><span style=\"top:-2.9890000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mclose\"><span class=\"mclose\">]</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.814em;\"><span style=\"top:-2.989em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">3</span><span class=\"mord mtight\">/</span><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">ρ</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\">s</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.954em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mord mathnormal\">d</span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.801892em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span><span class=\"mord mathnormal\">d</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.801892em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span><span class=\"mord mathnormal\">d</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.801892em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span></span></span></span></span></p>\n<p>分子上的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">(</mo><msup><mi>z</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mo>−</mo><msub><mi>z</mi><mrow><mi>o</mi><mi>b</mi><mi>s</mi></mrow></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">(z&#x27; - z_{obs})</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.001892em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\">s</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span> 实际上代表了<strong>方向的投影</strong>，它决定了我们测量的到底是 “哪个方向” 的力。</p>\n<p>当你将地下空间划分为一个个微小的三维网格时，公式演变为在代码中尝试实现的叠加形式：</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi mathvariant=\"normal\">Δ</mi><mi>g</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><mi>y</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mi>G</mi><munder><mo>∑</mo><mi>i</mi></munder><munder><mo>∑</mo><mi>j</mi></munder><munder><mo>∑</mo><mi>k</mi></munder><mfrac><mrow><msub><mi>ρ</mi><mrow><mi>i</mi><mi>j</mi><mi>k</mi></mrow></msub><mo>⋅</mo><mi mathvariant=\"normal\">Δ</mi><mi>V</mi><mo>⋅</mo><mo stretchy=\"false\">(</mo><msub><mi>z</mi><mi>k</mi></msub><mo>−</mo><msub><mi>z</mi><mrow><mi>o</mi><mi>b</mi><mi>s</mi></mrow></msub><mo stretchy=\"false\">)</mo></mrow><mrow><mo stretchy=\"false\">[</mo><mo stretchy=\"false\">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><mi>x</mi><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy=\"false\">(</mo><msub><mi>y</mi><mi>j</mi></msub><mo>−</mo><mi>y</mi><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy=\"false\">(</mo><msub><mi>z</mi><mi>k</mi></msub><mo>−</mo><msub><mi>z</mi><mrow><mi>o</mi><mi>b</mi><mi>s</mi></mrow></msub><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup><msup><mo stretchy=\"false\">]</mo><mrow><mn>3</mn><mi mathvariant=\"normal\">/</mi><mn>2</mn></mrow></msup></mrow></mfrac></mrow><annotation encoding=\"application/x-tex\">\\Delta g(x, y) = G \\sum_{i} \\sum_{j} \\sum_{k} \\frac{\\rho_{ijk} \\cdot \\Delta V \\cdot (z_k - z_{obs})}{[ (x_i - x)^2 + (y_j - y)^2 + (z_k - z_{obs})^2 ]^{3/2}}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">Δ</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.840777em;vertical-align:-1.413777em;\"></span><span class=\"mord mathnormal\">G</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.0500050000000003em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.050005em;\"><span style=\"top:-1.8723309999999997em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.0500049999999996em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.413777em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.0500050000000005em;\"><span style=\"top:-1.847887em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.3021129999999999em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.427em;\"><span style=\"top:-2.296em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mopen\">[</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.740108em;\"><span style=\"top:-2.9890000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.740108em;\"><span style=\"top:-2.9890000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\">s</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.740108em;\"><span style=\"top:-2.9890000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mclose\"><span class=\"mclose\">]</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.814em;\"><span style=\"top:-2.989em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">3</span><span class=\"mord mtight\">/</span><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\">ρ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\">Δ</span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">V</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\">s</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.990108em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span></p>\n<h2 id=\"反演\"><a class=\"markdownIt-Anchor\" href=\"#反演\">#</a> 反演</h2>\n<p>简单来说，正演是 “从因到果”，而反演是 “由果溯因”。</p>\n<p>地心是去不了的，地壳是看不透的。 我们手里只有地表测到的那一张重力值地图 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>g</mi><mi>z</mi></msub><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><mi>y</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">g_z(x, y)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.04398em;\">z</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\">)</span></span></span></span>，而我们真正的目的是想知道地下埋了什么 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>ρ</mi><mo stretchy=\"false\">(</mo><mi>ξ</mi><mo separator=\"true\">,</mo><mi>η</mi><mo separator=\"true\">,</mo><mi>ζ</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\rho(\\xi, \\eta, \\zeta)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">ρ</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.04601em;\">ξ</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">η</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07378em;\">ζ</span><span class=\"mclose\">)</span></span></span></span>。反演的目标就是利用地表观测到的重力值，通过数学计算，倒推出地下的密度、形状和深度。</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>ρ</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><mi>y</mi><mo separator=\"true\">,</mo><mi>z</mi><mo stretchy=\"false\">)</mo><mo>=</mo><msup><mi>F</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo stretchy=\"false\">[</mo><mi>g</mi><mi>o</mi><mi>b</mi><mi>s</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><mi>y</mi><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">ρ(x,y,z)=F^{-1}[gobs(x,y)]\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">ρ</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.1141079999999999em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.864108em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span></span></span></span></span><span class=\"mopen\">[</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\">s</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\">)</span><span class=\"mclose\">]</span></span></span></span></span></p>\n<p>虽然反演很重要，但它有一个巨大的挑战：多解性。物理上，深处的一个大矿块和浅处的一个小矿块，可能在地表产生一模一样的重力异常。这就是为什么要在反演时需要加入 “约束条件” 比如已知的一口井的数据，或重力梯度异常 (<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>V</mi><mrow><mi>z</mi><mi>z</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">V_{zz}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">V</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.04398em;\">z</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.04398em;\">z</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>) 等高阶数据，因为梯度数据对浅部细节更敏感，能有效减少反演的模糊性。</p>\n<h2 id=\"深度学习反演\"><a class=\"markdownIt-Anchor\" href=\"#深度学习反演\">#</a> 深度学习反演</h2>\n<p>反演法有很多，这里主要展开深度学习反演法。组会中师兄的 U-Net 反演令我印象深刻，接下来就实现一下最初始版本的吧。</p>\n<h3 id=\"模拟数据集\"><a class=\"markdownIt-Anchor\" href=\"#模拟数据集\">#</a> 模拟数据集</h3>\n<p>数据集这方面我还没有了解很多，但是师兄汇报时候使用了模拟集，我也根据这个正演法生成一些模拟集吧。我的格子是 Z x H x W 是 16 x 64 x 64，我还加入了一些噪声。</p>\n<p>下面是我模拟数据集的样子：</p>\n<img data-src=\"../../../images/python/Geophysics/h1/1.png\" alt=\"1\" style=\"zoom:100%;\" />\n<img data-src=\"../../../images/python/Geophysics/h1/2.png\" alt=\"1\" style=\"zoom:100%;\" />\n<h3 id=\"模型u-net_resnet50\"><a class=\"markdownIt-Anchor\" href=\"#模型u-net_resnet50\">#</a> 模型：U-Net_ResNet50</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> math</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> torch<span class=\"token punctuation\">.</span>nn <span class=\"token keyword\">as</span> nn</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">conv3x3</span><span class=\"token punctuation\">(</span>in_planes<span class=\"token punctuation\">,</span> out_planes<span class=\"token punctuation\">,</span> stride<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> groups<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> dilation<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">return</span> nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">(</span>in_planes<span class=\"token punctuation\">,</span> out_planes<span class=\"token punctuation\">,</span> kernel_size<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> stride<span class=\"token operator\">=</span>stride<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                     padding<span class=\"token operator\">=</span>dilation<span class=\"token punctuation\">,</span> groups<span class=\"token operator\">=</span>groups<span class=\"token punctuation\">,</span> bias<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> dilation<span class=\"token operator\">=</span>dilation<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">conv1x1</span><span class=\"token punctuation\">(</span>in_planes<span class=\"token punctuation\">,</span> out_planes<span class=\"token punctuation\">,</span> stride<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">return</span> nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">(</span>in_planes<span class=\"token punctuation\">,</span> out_planes<span class=\"token punctuation\">,</span> kernel_size<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> stride<span class=\"token operator\">=</span>stride<span class=\"token punctuation\">,</span> bias<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">Bottleneck</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    expansion <span class=\"token operator\">=</span> <span class=\"token number\">4</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> inplanes<span class=\"token punctuation\">,</span> planes<span class=\"token punctuation\">,</span> stride<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> downsample<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> groups<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                 base_width<span class=\"token operator\">=</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> dilation<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> norm_layer<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span>Bottleneck<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">if</span> norm_layer <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            norm_layer <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>BatchNorm2d</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        width <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>planes <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>base_width <span class=\"token operator\">/</span> <span class=\"token number\">64.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> groups</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        self<span class=\"token punctuation\">.</span>conv1 <span class=\"token operator\">=</span> conv1x1<span class=\"token punctuation\">(</span>inplanes<span class=\"token punctuation\">,</span> width<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        self<span class=\"token punctuation\">.</span>bn1 <span class=\"token operator\">=</span> norm_layer<span class=\"token punctuation\">(</span>width<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        self<span class=\"token punctuation\">.</span>conv2 <span class=\"token operator\">=</span> conv3x3<span class=\"token punctuation\">(</span>width<span class=\"token punctuation\">,</span> width<span class=\"token punctuation\">,</span> stride<span class=\"token punctuation\">,</span> groups<span class=\"token punctuation\">,</span> dilation<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        self<span class=\"token punctuation\">.</span>bn2 <span class=\"token operator\">=</span> norm_layer<span class=\"token punctuation\">(</span>width<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        self<span class=\"token punctuation\">.</span>conv3 <span class=\"token operator\">=</span> conv1x1<span class=\"token punctuation\">(</span>width<span class=\"token punctuation\">,</span> planes <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>expansion<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        self<span class=\"token punctuation\">.</span>bn3 <span class=\"token operator\">=</span> norm_layer<span class=\"token punctuation\">(</span>planes <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>expansion<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        self<span class=\"token punctuation\">.</span>relu <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>ReLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        self<span class=\"token punctuation\">.</span>downsample <span class=\"token operator\">=</span> downsample</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        self<span class=\"token punctuation\">.</span>stride <span class=\"token operator\">=</span> stride</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        identity <span class=\"token operator\">=</span> x</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        </pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        out <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>conv1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        out <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>bn1<span class=\"token punctuation\">(</span>out<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        out <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>relu<span class=\"token punctuation\">(</span>out<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        out <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>conv2<span class=\"token punctuation\">(</span>out<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        out <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>bn2<span class=\"token punctuation\">(</span>out<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        out <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>relu<span class=\"token punctuation\">(</span>out<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        out <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>conv3<span class=\"token punctuation\">(</span>out<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        out <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>bn3<span class=\"token punctuation\">(</span>out<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token keyword\">if</span> self<span class=\"token punctuation\">.</span>downsample <span class=\"token keyword\">is</span> <span class=\"token keyword\">not</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            identity <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>downsample<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        out <span class=\"token operator\">+=</span> identity</pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        out <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>relu<span class=\"token punctuation\">(</span>out<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token keyword\">return</span> out</pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">ResNet</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> block<span class=\"token punctuation\">,</span> layers<span class=\"token punctuation\">,</span> num_classes<span class=\"token operator\">=</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span>ResNet<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        self<span class=\"token punctuation\">.</span>inplanes <span class=\"token operator\">=</span> <span class=\"token number\">64</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        self<span class=\"token punctuation\">.</span>conv1 <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">64</span><span class=\"token punctuation\">,</span> kernel_size<span class=\"token operator\">=</span><span class=\"token number\">7</span><span class=\"token punctuation\">,</span> stride<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> padding<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> bias<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        self<span class=\"token punctuation\">.</span>bn1 <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">64</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        self<span class=\"token punctuation\">.</span>relu <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>ReLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        self<span class=\"token punctuation\">.</span>maxpool <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>MaxPool2d<span class=\"token punctuation\">(</span>kernel_size<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> stride<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> padding<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> ceil_mode<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        self<span class=\"token punctuation\">.</span>layer1 <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>_make_layer<span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">,</span> <span class=\"token number\">64</span><span class=\"token punctuation\">,</span> layers<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>        self<span class=\"token punctuation\">.</span>layer2 <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>_make_layer<span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">,</span> layers<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> stride<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        self<span class=\"token punctuation\">.</span>layer3 <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>_make_layer<span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> layers<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> stride<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        self<span class=\"token punctuation\">.</span>layer4 <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>_make_layer<span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">,</span> <span class=\"token number\">512</span><span class=\"token punctuation\">,</span> layers<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> stride<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        self<span class=\"token punctuation\">.</span>avgpool <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>AvgPool2d<span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        self<span class=\"token punctuation\">.</span>fc <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span><span class=\"token number\">512</span> <span class=\"token operator\">*</span> block<span class=\"token punctuation\">.</span>expansion<span class=\"token punctuation\">,</span> num_classes<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        <span class=\"token keyword\">for</span> m <span class=\"token keyword\">in</span> self<span class=\"token punctuation\">.</span>modules<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">,</span> nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>                n <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span>kernel_size<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> m<span class=\"token punctuation\">.</span>kernel_size<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> m<span class=\"token punctuation\">.</span>out_channels</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>                m<span class=\"token punctuation\">.</span>weight<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>normal_<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> math<span class=\"token punctuation\">.</span>sqrt<span class=\"token punctuation\">(</span><span class=\"token number\">2.</span> <span class=\"token operator\">/</span> n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>            <span class=\"token keyword\">elif</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">,</span> nn<span class=\"token punctuation\">.</span>BatchNorm2d<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>                m<span class=\"token punctuation\">.</span>weight<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>fill_<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>                m<span class=\"token punctuation\">.</span>bias<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>zero_<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">_make_layer</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> block<span class=\"token punctuation\">,</span> planes<span class=\"token punctuation\">,</span> blocks<span class=\"token punctuation\">,</span> stride<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>        downsample <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>        <span class=\"token keyword\">if</span> stride <span class=\"token operator\">!=</span> <span class=\"token number\">1</span> <span class=\"token keyword\">or</span> self<span class=\"token punctuation\">.</span>inplanes <span class=\"token operator\">!=</span> planes <span class=\"token operator\">*</span> block<span class=\"token punctuation\">.</span>expansion<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>            downsample <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Sequential<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>                nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>inplanes<span class=\"token punctuation\">,</span> planes <span class=\"token operator\">*</span> block<span class=\"token punctuation\">.</span>expansion<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>                          kernel_size<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> stride<span class=\"token operator\">=</span>stride<span class=\"token punctuation\">,</span> bias<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>                nn<span class=\"token punctuation\">.</span>BatchNorm2d<span class=\"token punctuation\">(</span>planes <span class=\"token operator\">*</span> block<span class=\"token punctuation\">.</span>expansion<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>            <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>        layers <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>        layers<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>inplanes<span class=\"token punctuation\">,</span> planes<span class=\"token punctuation\">,</span> stride<span class=\"token punctuation\">,</span> downsample<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        self<span class=\"token punctuation\">.</span>inplanes <span class=\"token operator\">=</span> planes <span class=\"token operator\">*</span> block<span class=\"token punctuation\">.</span>expansion</pre></td></tr><tr><td data-num=\"95\"></td><td><pre></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>        <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> blocks<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>            layers<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>inplanes<span class=\"token punctuation\">,</span> planes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>        <span class=\"token keyword\">return</span> nn<span class=\"token punctuation\">.</span>Sequential<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>layers<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>        x <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>conv1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>        x <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>bn1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>        feat1 <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>relu<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>        x <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>maxpool<span class=\"token punctuation\">(</span>feat1<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>        feat2 <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>layer1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>        feat3 <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>layer2<span class=\"token punctuation\">(</span>feat2<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>        feat4 <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>layer3<span class=\"token punctuation\">(</span>feat3<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>        feat5 <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>layer4<span class=\"token punctuation\">(</span>feat4<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>feat1<span class=\"token punctuation\">,</span> feat2<span class=\"token punctuation\">,</span> feat3<span class=\"token punctuation\">,</span> feat4<span class=\"token punctuation\">,</span> feat5<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre></pre></td></tr><tr><td data-num=\"114\"></td><td><pre></pre></td></tr><tr><td data-num=\"115\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">resnet50</span><span class=\"token punctuation\">(</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>    model <span class=\"token operator\">=</span> ResNet<span class=\"token punctuation\">(</span>Bottleneck<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>    <span class=\"token keyword\">del</span> model<span class=\"token punctuation\">.</span>avgpool</pre></td></tr><tr><td data-num=\"118\"></td><td><pre>    <span class=\"token keyword\">del</span> model<span class=\"token punctuation\">.</span>fc</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>    <span class=\"token keyword\">return</span> model</pre></td></tr><tr><td data-num=\"120\"></td><td><pre></pre></td></tr><tr><td data-num=\"121\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">unetUp</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> in_size<span class=\"token punctuation\">,</span> out_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span>unetUp<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>        self<span class=\"token punctuation\">.</span>conv1 <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">(</span>in_size<span class=\"token punctuation\">,</span> out_size<span class=\"token punctuation\">,</span> kernel_size<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> padding<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>        self<span class=\"token punctuation\">.</span>conv2 <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">(</span>out_size<span class=\"token punctuation\">,</span> out_size<span class=\"token punctuation\">,</span> kernel_size<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> padding<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>        self<span class=\"token punctuation\">.</span>up <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>UpsamplingBilinear2d<span class=\"token punctuation\">(</span>scale_factor<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>        self<span class=\"token punctuation\">.</span>relu <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>ReLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> inputs1<span class=\"token punctuation\">,</span> inputs2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>        outputs <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>inputs1<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>up<span class=\"token punctuation\">(</span>inputs2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>        outputs <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>conv1<span class=\"token punctuation\">(</span>outputs<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>        outputs <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>relu<span class=\"token punctuation\">(</span>outputs<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>        outputs <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>conv2<span class=\"token punctuation\">(</span>outputs<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>        outputs <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>relu<span class=\"token punctuation\">(</span>outputs<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>        <span class=\"token keyword\">return</span> outputs</pre></td></tr><tr><td data-num=\"136\"></td><td><pre></pre></td></tr><tr><td data-num=\"137\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">Unet</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> num_classes<span class=\"token operator\">=</span><span class=\"token number\">21</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span>Unet<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>        self<span class=\"token punctuation\">.</span>resnet <span class=\"token operator\">=</span> resnet50<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>        in_filters <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">192</span><span class=\"token punctuation\">,</span> <span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3072</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>        out_filters <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">512</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>        self<span class=\"token punctuation\">.</span>up_concat4 <span class=\"token operator\">=</span> unetUp<span class=\"token punctuation\">(</span>in_filters<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> out_filters<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>        self<span class=\"token punctuation\">.</span>up_concat3 <span class=\"token operator\">=</span> unetUp<span class=\"token punctuation\">(</span>in_filters<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> out_filters<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>        self<span class=\"token punctuation\">.</span>up_concat2 <span class=\"token operator\">=</span> unetUp<span class=\"token punctuation\">(</span>in_filters<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> out_filters<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>        self<span class=\"token punctuation\">.</span>up_concat1 <span class=\"token operator\">=</span> unetUp<span class=\"token punctuation\">(</span>in_filters<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> out_filters<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>        self<span class=\"token punctuation\">.</span>up_conv <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Sequential<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>UpsamplingBilinear2d<span class=\"token punctuation\">(</span>scale_factor<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">(</span>out_filters<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> out_filters<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> kernel_size<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> padding<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>ReLU<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">(</span>out_filters<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> out_filters<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> kernel_size<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> padding<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>ReLU<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>        self<span class=\"token punctuation\">.</span>final <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">(</span>out_filters<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> num_classes<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> inputs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>        <span class=\"token punctuation\">[</span>feat1<span class=\"token punctuation\">,</span> feat2<span class=\"token punctuation\">,</span> feat3<span class=\"token punctuation\">,</span> feat4<span class=\"token punctuation\">,</span> feat5<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>resnet<span class=\"token punctuation\">.</span>forward<span class=\"token punctuation\">(</span>inputs<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>        up4 <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>up_concat4<span class=\"token punctuation\">(</span>feat4<span class=\"token punctuation\">,</span> feat5<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>        up3 <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>up_concat3<span class=\"token punctuation\">(</span>feat3<span class=\"token punctuation\">,</span> up4<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>        up2 <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>up_concat2<span class=\"token punctuation\">(</span>feat2<span class=\"token punctuation\">,</span> up3<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>        up1 <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>up_concat1<span class=\"token punctuation\">(</span>feat1<span class=\"token punctuation\">,</span> up2<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>        <span class=\"token keyword\">if</span> self<span class=\"token punctuation\">.</span>up_conv <span class=\"token operator\">!=</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>            up1 <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>up_conv<span class=\"token punctuation\">(</span>up1<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>        final <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>final<span class=\"token punctuation\">(</span>up1<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>        <span class=\"token keyword\">return</span> final</pre></td></tr></table></figure><blockquote>\n<p>Total params: 43,927,504<br>\nTrainable params: 43,927,504</p>\n<p>Non-trainable params: 0</p>\n<p>Input size (MB): 0.02<br>\nForward/backward pass size (MB): 40.58<br>\nParams size (MB): 167.57</p>\n<p>Estimated Total Size (MB): 208.16</p>\n</blockquote>\n<h3 id=\"随便练20轮\"><a class=\"markdownIt-Anchor\" href=\"#随便练20轮\">#</a> 随便练 20 轮</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> torch</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> torch<span class=\"token punctuation\">.</span>nn <span class=\"token keyword\">as</span> nn</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> torch<span class=\"token punctuation\">.</span>optim <span class=\"token keyword\">as</span> optim</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">from</span> tqdm <span class=\"token keyword\">import</span> tqdm</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>device <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>device<span class=\"token punctuation\">(</span><span class=\"token string\">\"cuda\"</span> <span class=\"token keyword\">if</span> torch<span class=\"token punctuation\">.</span>cuda<span class=\"token punctuation\">.</span>is_available<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token string\">\"cpu\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>model <span class=\"token operator\">=</span> Unet<span class=\"token punctuation\">(</span>num_classes<span class=\"token operator\">=</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>epoch <span class=\"token operator\">=</span> <span class=\"token number\">20</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>criterion <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>BCEWithLogitsLoss<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>optimizer <span class=\"token operator\">=</span> optim<span class=\"token punctuation\">.</span>Adam<span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">.</span>parameters<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> lr<span class=\"token operator\">=</span><span class=\"token number\">0.001</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>min_loss <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>inf</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">for</span> e <span class=\"token keyword\">in</span> tqdm<span class=\"token punctuation\">(</span><span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>epoch<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">for</span> X<span class=\"token punctuation\">,</span> Y <span class=\"token keyword\">in</span> train_loder<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        X <span class=\"token operator\">=</span> X<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        Y <span class=\"token operator\">=</span> Y<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        optimizer<span class=\"token punctuation\">.</span>zero_grad<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        pred <span class=\"token operator\">=</span> model<span class=\"token punctuation\">(</span>X<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        loss <span class=\"token operator\">=</span> criterion<span class=\"token punctuation\">(</span>pred<span class=\"token punctuation\">,</span> Y<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        loss<span class=\"token punctuation\">.</span>backward<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        optimizer<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"Epoch </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>e <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">/</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>epoch<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">, Loss: </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>loss<span class=\"token punctuation\">.</span>item<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span><span class=\"token format-spec\">.4f</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">if</span> loss <span class=\"token operator\">&lt;</span> min_loss<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        min_loss <span class=\"token operator\">=</span> loss<span class=\"token punctuation\">.</span>item<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        torch<span class=\"token punctuation\">.</span>save<span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">.</span>state_dict<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"model_epoch_</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>e <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">.pth\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><img data-src=\"../../../images/python/Geophysics/h1/3.png\" alt=\"1\" style=\"zoom:80%;\" />\n<h3 id=\"预测一下\"><a class=\"markdownIt-Anchor\" href=\"#预测一下\">#</a> 预测一下</h3>\n<p>一个异常体的效果还不错。</p>\n<img data-src=\"../../../images/python/Geophysics/h1/4.gif\" alt=\"1\" style=\"zoom:80%;\" />\n<p>多个异常体的效果也还行，但是如果离得太近就会出现连体现象。</p>\n<img data-src=\"../../../images/python/Geophysics/h1/5.gif\" alt=\"1\" style=\"zoom:80%;\" />\n<img data-src=\"../../../images/python/Geophysics/h1/6.gif\" alt=\"1\" style=\"zoom:80%;\" />\n<p>当然这个确实是源数据就在一起了，但是有微小分开的数据也是连在一起的。</p>\n<h2 id=\"总结\"><a class=\"markdownIt-Anchor\" href=\"#总结\">#</a> 总结</h2>\n<p>用深度学习做重力反演，从 地表重力异常 g (x, y)， 预测地下三维密度分布 ρ(x, y, z)，反演是病态的，而正演是确定的，深度学习适合 “约束型反演”，深度学习在这里学一个稳定的近似逆算子，而真实的逆是不存在的，深度学习正把这种不可能变成有些可能。</p>\n",
            "tags": [
                "深度学习",
                "Geophysics",
                "python",
                "CNN",
                "深度学习",
                "UNet"
            ]
        },
        {
            "id": "https://735690757.github.io/Java/springcloud021/",
            "url": "https://735690757.github.io/Java/springcloud021/",
            "title": "将单体项目拆解为微服务项目",
            "date_published": "2026-02-02T02:20:00.000Z",
            "content_html": "<h1 id=\"将单体项目拆解为微服务项目\"><a class=\"markdownIt-Anchor\" href=\"#将单体项目拆解为微服务项目\">#</a> 将单体项目拆解为微服务项目</h1>\n<h2 id=\"demo1_再会mybatisplus将mybatis工程改造为mybatisplus工程\"><a class=\"markdownIt-Anchor\" href=\"#demo1_再会mybatisplus将mybatis工程改造为mybatisplus工程\">#</a> Demo1_再会 MyBatisPlus—— 将 MyBatis 工程改造为 MyBatisPlus 工程</h2>\n<h3 id=\"引入mybatisplus依赖\"><a class=\"markdownIt-Anchor\" href=\"#引入mybatisplus依赖\">#</a> 引入 MyBatisPlus 依赖</h3>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>com.baomidou<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>mybatis-plus-boot-starter<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">></span></span>3.5.5<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><h3 id=\"usermapper继承basemapper\"><a class=\"markdownIt-Anchor\" href=\"#usermapper继承basemapper\">#</a> UserMapper 继承 BaseMapper</h3>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">UserMapper</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">BaseMapper</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">saveUser</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">User</span> user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">deleteUser</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">updateUser</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">User</span> user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token class-name\">User</span> <span class=\"token function\">queryUserById</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">queryUserByIds</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ids\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> ids<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"去除usermapperjava与usermapperxml中的基础方法\"><a class=\"markdownIt-Anchor\" href=\"#去除usermapperjava与usermapperxml中的基础方法\">#</a> 去除 UserMapper.java 与 UserMapper.xml 中的基础方法</h3>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">UserMapper</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">BaseMapper</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token prolog\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token doctype\"><span class=\"token punctuation\">&lt;!</span><span class=\"token doctype-tag\">DOCTYPE</span> <span class=\"token name\">mapper</span> <span class=\"token name\">PUBLIC</span> <span class=\"token string\">\"-//mybatis.org//DTD Mapper 3.0//EN\"</span> <span class=\"token string\">\"http://mybatis.org/dtd/mybatis-3-mapper.dtd\"</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>mapper</span> <span class=\"token attr-name\">namespace</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>com.itheima.mp.mapper.UserMapper<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>mapper</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><h3 id=\"验证\"><a class=\"markdownIt-Anchor\" href=\"#验证\">#</a> 验证</h3>\n<img data-src=\"../../images/java/sc021/1.png\" alt=\"1\"  />\n<h3 id=\"为什么mybatisplus这么快\"><a class=\"markdownIt-Anchor\" href=\"#为什么mybatisplus这么快\">#</a> 为什么 MyBatisPlus 这么快？</h3>\n<p>MyBatisPlus 通过扫描实体类，基于反射获取到实体类信息座位数据库表基本信息</p>\n<p>一下是一些提示</p>\n<ol>\n<li>类名驼峰转下划线作为表名</li>\n<li>名为 id 的字段作为主键</li>\n<li>变量名驼峰转下划线作为表的字段名</li>\n</ol>\n<h3 id=\"常用注解\"><a class=\"markdownIt-Anchor\" href=\"#常用注解\">#</a> 常用注解</h3>\n<p><strong>@TableName</strong>：用来指定表名</p>\n<p><strong>@TableId</strong>：用来指定表中的主键字段信息</p>\n<p><strong>@TableField</strong>：用来指定表中的普通字段信息</p>\n<h3 id=\"示例1表名与类名有明显差异使用tablename\"><a class=\"markdownIt-Anchor\" href=\"#示例1表名与类名有明显差异使用tablename\">#</a> 示例 1—— 表名与类名有明显差异使用 @TableName</h3>\n<img data-src=\"../../images/java/sc021/2.png\" alt=\"1\"  />\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@TableName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tb_user\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">User</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> username<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> isMarried<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> order<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"示例2主键字段名有明显差异使用tableid\"><a class=\"markdownIt-Anchor\" href=\"#示例2主键字段名有明显差异使用tableid\">#</a> 示例 2—— 主键字段名有明显差异使用 @TableId</h3>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@TableName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tb_user\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">User</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token annotation punctuation\">@TableId</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token string\">\"id\"</span><span class=\"token punctuation\">,</span> type <span class=\"token operator\">=</span> <span class=\"token class-name\">IdType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">AUTO</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> uuid<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> username<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> isMarried<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> order<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"type策略\"><a class=\"markdownIt-Anchor\" href=\"#type策略\">#</a> type 策略</h4>\n<p>AUTO：数据库自增长</p>\n<p>INPUT：通过 set 方法自行输入</p>\n<p>ASSIGN_ID：分配 ID，接口 IdentifierGenerator 的方法 nextId 来生成 id，默认实现类为 DefaultIdentifierGenerator 雪花算法（20 位）</p>\n<h3 id=\"示例3字段名不符合其约定tablefield\"><a class=\"markdownIt-Anchor\" href=\"#示例3字段名不符合其约定tablefield\">#</a> 示例 3—— 字段名不符合其约定 @TableField</h3>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@TableName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tb_user\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">User</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token annotation punctuation\">@TableId</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token string\">\"id\"</span><span class=\"token punctuation\">,</span> type <span class=\"token operator\">=</span> <span class=\"token class-name\">IdType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">AUTO</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> uuid<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token annotation punctuation\">@TableField</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"username\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> username<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token annotation punctuation\">@TableField</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"is_married\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> isMarried<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token annotation punctuation\">@TableField</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"`order`\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> order<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>     <span class=\"token annotation punctuation\">@TableField</span><span class=\"token punctuation\">(</span>exist <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> address<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"使用tablefield的常见场景\"><a class=\"markdownIt-Anchor\" href=\"#使用tablefield的常见场景\">#</a> 使用 @TableField 的常见场景</h4>\n<ol>\n<li>成员变量名与数据库字段名不一致</li>\n<li>成员变量名以 is 开头，且是布尔值</li>\n<li>成员变量名与数据库关键字冲突</li>\n<li>成员变量不是数据库字段</li>\n</ol>\n<h3 id=\"常见配置\"><a class=\"markdownIt-Anchor\" href=\"#常见配置\">#</a> 常见配置</h3>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">mybatis-plus</span><span class=\"token punctuation\">:</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token key atrule\">type-aliases-package</span><span class=\"token punctuation\">:</span> com.itheima.mp.domain.po <span class=\"token comment\"># 别名扫描包</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token key atrule\">mapper-locations</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"classpath*:/mapper/**/*.xml\"</span> <span class=\"token comment\"># Mapper.xml 文件地址，默认值</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token key atrule\">configuration</span><span class=\"token punctuation\">:</span> </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t<span class=\"token key atrule\">map-underscore-to-camel-case</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span> <span class=\"token comment\"># 是否开启下划线和驼峰的映射</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token key atrule\">cache-enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span> <span class=\"token comment\"># 是否开启二级缓存</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">global-config</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  \t<span class=\"token key atrule\">db-config</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  \t\t<span class=\"token key atrule\">id-type</span><span class=\"token punctuation\">:</span> assign_id <span class=\"token comment\"># id 为雪花算法生成</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  \t\t<span class=\"token key atrule\">update-strategy</span><span class=\"token punctuation\">:</span> not_null <span class=\"token comment\"># 更新策略：只更新非空字段</span></pre></td></tr></table></figure><p>具体可参考官方文档：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYmFvbWlkb3UuY29tLw==\">MyBatisPlus 官方文档</span></p>\n<h3 id=\"条件构造器wrapper\"><a class=\"markdownIt-Anchor\" href=\"#条件构造器wrapper\">#</a> 条件构造器 Wrapper</h3>\n<img data-src=\"../../images/java/sc021/3.png\" alt=\"1\"  />\n<h4 id=\"querywrapper与lambdaquerywrapper\"><a class=\"markdownIt-Anchor\" href=\"#querywrapper与lambdaquerywrapper\">#</a> QueryWrapper 与 LambdaQueryWrapper</h4>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Test</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">testWrapper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">QueryWrapper</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> userQueryWrapper <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">QueryWrapper</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"username\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"info\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"balance\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">like</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"username\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"o\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">ge</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"balance\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> users <span class=\"token operator\">=</span> userMapper<span class=\"token punctuation\">.</span><span class=\"token function\">selectList</span><span class=\"token punctuation\">(</span>userQueryWrapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    users<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token operator\">::</span><span class=\"token function\">println</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>userMapper<span class=\"token punctuation\">.</span><span class=\"token function\">selectList</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">LambdaQueryWrapper</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">ge</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">User</span><span class=\"token operator\">::</span><span class=\"token function\">getBalance</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">like</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">User</span><span class=\"token operator\">::</span><span class=\"token function\">getUsername</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"o\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">User</span><span class=\"token operator\">::</span><span class=\"token function\">getId</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">User</span><span class=\"token operator\">::</span><span class=\"token function\">getUsername</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">User</span><span class=\"token operator\">::</span><span class=\"token function\">getInfo</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">User</span><span class=\"token operator\">::</span><span class=\"token function\">getBalance</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"updatewrapper与lambdaupdatewrapper\"><a class=\"markdownIt-Anchor\" href=\"#updatewrapper与lambdaupdatewrapper\">#</a> UpdateWrapper 与 LambdaUpdateWrapper</h4>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Test</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">testWrapper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">UpdateWrapper</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> userUpdateWrapper <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">UpdateWrapper</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4L</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">setSql</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"balance = balance - 10\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    userMapper<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> userUpdateWrapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    userMapper<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LambdaUpdateWrapper</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">User</span><span class=\"token operator\">::</span><span class=\"token function\">getId</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4L</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">setSql</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"balance = balance - 10\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>推荐使用 LQW / LUW 因为其类型安全、较高可维护性、对重构友好。用 Lambda 引用替代字符串字段名，在编译期发现错误，提高代码在重构和长期维护中的安全性。</p>\n<h3 id=\"自定义sql\"><a class=\"markdownIt-Anchor\" href=\"#自定义sql\">#</a> 自定义 SQL</h3>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Test</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">testZZSQL</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> ids <span class=\"token operator\">=</span> <span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token number\">2L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">int</span> amount <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token class-name\">LambdaUpdateWrapper</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> userLambdaUpdateWrapper <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LambdaUpdateWrapper</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">in</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">User</span><span class=\"token operator\">::</span><span class=\"token function\">getId</span><span class=\"token punctuation\">,</span> ids<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    userMapper<span class=\"token punctuation\">.</span><span class=\"token function\">updateByIds</span><span class=\"token punctuation\">(</span>userLambdaUpdateWrapper<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">UserMapper</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">BaseMapper</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>     * 根据 id 批量更新余额</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>     *</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>     * @param userLambdaUpdateWrapper 条件</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>     * @param amount 金额</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">//    @Update(\"update tb_user set balance = balance - #&#123;amount&#125; $&#123;ew.customSqlSegment&#125;\")</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">updateByIds</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Param</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Constants</span><span class=\"token punctuation\">.</span><span class=\"token constant\">WRAPPER</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">LambdaUpdateWrapper</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> userLambdaUpdateWrapper<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"amount\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">int</span> amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>mapper</span> <span class=\"token attr-name\">namespace</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>com.itheima.mp.mapper.UserMapper<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>update</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>updateByIds<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        update tb_user set balance = balance - #&#123;amount&#125; $&#123;ew.customSqlSegment&#125;</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>update</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>mapper</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><p><code>Constants.WRAPPER</code>  为 MP 常量就是 ew 在 SQL 中也可以看到有关 ew 的操作： <code>$&#123;ew.customSqlSegment&#125;</code></p>\n<h3 id=\"service接口\"><a class=\"markdownIt-Anchor\" href=\"#service接口\">#</a> Service 接口</h3>\n<img data-src=\"../../images/java/sc021/4.png\" alt=\"1\"  />\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">IUserService</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">IService</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserServiceImpl</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ServiceImpl</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserMapper</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">IUserService</span>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这样就可以使用了</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@SpringBootTest</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">UserServiceImplTest</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token annotation punctuation\">@Autowired</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">IUserService</span> userService<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token annotation punctuation\">@Test</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">testInsert</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">JsonProcessingException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> objectObjectHashMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        objectObjectHashMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"age\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">22</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        objectObjectHashMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"intro\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"程序员\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        objectObjectHashMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gender\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"male\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token class-name\">ObjectMapper</span> objectMapper <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ObjectMapper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token class-name\">String</span> json <span class=\"token operator\">=</span> objectMapper<span class=\"token punctuation\">.</span><span class=\"token function\">writeValueAsString</span><span class=\"token punctuation\">(</span>objectObjectHashMap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token class-name\">User</span> lkr <span class=\"token operator\">=</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">username</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"lkr\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">password</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"123123\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">phone</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"666666\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">balance</span><span class=\"token punctuation\">(</span><span class=\"token number\">45454</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        userService<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>lkr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token annotation punctuation\">@Test</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">testQuery</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>userService<span class=\"token punctuation\">.</span><span class=\"token function\">listByIds</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token number\">1L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3L</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"controller技巧\"><a class=\"markdownIt-Anchor\" href=\"#controller技巧\">#</a> Controller 技巧</h3>\n<p>通常我们在 Controller 注入 Service 我们会这样写：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Api</span><span class=\"token punctuation\">(</span>tags <span class=\"token operator\">=</span> <span class=\"token string\">\"用户管理接口\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@RestController</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/users\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserController</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token annotation punctuation\">@Autowired</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">IUserService</span> userService<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>尽管可以，但是 Spring 官方反对的字段注入，因为 Service 层是不会变的，使用 final 更为合适，但字段注入 <strong>无法使用  <code>final</code> </strong>，并且容易造成循环依赖</p>\n<p>在 IDEA 的自动修复中推荐道：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Api</span><span class=\"token punctuation\">(</span>tags <span class=\"token operator\">=</span> <span class=\"token string\">\"用户管理接口\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@RestController</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/users\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserController</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">IUserService</span> userService<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">UserController</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IUserService</span> userService<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>userService <span class=\"token operator\">=</span> userService<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>尽管快捷键两部就能生成，但是不够优雅，如果你的项目中可以使用 Lombok，我推荐这样写：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Api</span><span class=\"token punctuation\">(</span>tags <span class=\"token operator\">=</span> <span class=\"token string\">\"用户管理接口\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@RestController</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/users\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token annotation punctuation\">@RequiredArgsConstructor</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserController</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">IUserService</span> userService<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这样不仅保持了 <code>@Autowired</code>  的简介模式，还避免了字段注入。 <code>@RequiredArgsConstructor</code>  是自动生成 “必要参数” 的构造方法，“必要参数” 指的是：</p>\n<ol>\n<li><code>final</code>  修饰的字段</li>\n<li>被  <code>@NonNull</code>  修饰的字段</li>\n</ol>\n<p>使用 <code>@RequiredArgsConstructor</code>  注解，会在<strong>编译期</strong>生成必要参数的构造方法。</p>\n<h3 id=\"bean拷贝技巧\"><a class=\"markdownIt-Anchor\" href=\"#bean拷贝技巧\">#</a> Bean 拷贝技巧</h3>\n<p>前端或者客户端通常会给我们传一个在我们后端称之为 DTO 的数据，这是一个表单信息，包含了相应实体的核心信息，但是核心始终是核心，并不是完整的源实体，使用 MP 的 IService 方法时，如果你给我传了一个 DTO，这会报错， <code>Bean拷贝</code> 就是为了解决这个问题而诞生的。</p>\n<h4 id=\"hutool-beanutil一句话解决问题\"><a class=\"markdownIt-Anchor\" href=\"#hutool-beanutil一句话解决问题\">#</a> Hutool-BeanUtil 一句话解决问题</h4>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">BeanUtil</span><span class=\"token punctuation\">.</span><span class=\"token function\">copyProperties</span><span class=\"token punctuation\">(</span>userFormDTO<span class=\"token punctuation\">,</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>他会读取 <code>userFormDTO</code>  的信息，然后根据你指定的的类，这里就是 <code>User.class</code>  来生成源实体。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Api</span><span class=\"token punctuation\">(</span>tags <span class=\"token operator\">=</span> <span class=\"token string\">\"用户管理接口\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@RestController</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/users\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token annotation punctuation\">@RequiredArgsConstructor</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserController</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">IUserService</span> userService<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token annotation punctuation\">@ApiOperation</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"新增用户信息\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token annotation punctuation\">@PostMapping</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">saveUser</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@RequestBody</span> <span class=\"token class-name\">UserFormDTO</span> userFormDTO<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        userService<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BeanUtil</span><span class=\"token punctuation\">.</span><span class=\"token function\">copyProperties</span><span class=\"token punctuation\">(</span>userFormDTO<span class=\"token punctuation\">,</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"hutool-beanutil批量拷贝\"><a class=\"markdownIt-Anchor\" href=\"#hutool-beanutil批量拷贝\">#</a> Hutool-BeanUtil 批量拷贝</h4>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">BeanUtil</span><span class=\"token punctuation\">.</span><span class=\"token function\">copyToList</span><span class=\"token punctuation\">(</span>userService<span class=\"token punctuation\">.</span><span class=\"token function\">listByIds</span><span class=\"token punctuation\">(</span>ids<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">UserVO</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@ApiOperation</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"根据id批量查询\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@GetMapping</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserVO</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">listUser</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@RequestParam</span> <span class=\"token annotation punctuation\">@ApiParam</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"用户id列表\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> ids<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token class-name\">BeanUtil</span><span class=\"token punctuation\">.</span><span class=\"token function\">copyToList</span><span class=\"token punctuation\">(</span>userService<span class=\"token punctuation\">.</span><span class=\"token function\">listByIds</span><span class=\"token punctuation\">(</span>ids<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">UserVO</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"iservice的lambda查询\"><a class=\"markdownIt-Anchor\" href=\"#iservice的lambda查询\">#</a> IService 的 Lambda 查询</h3>\n<p>lambdaQuery 中有很多很方便的东西。</p>\n<p>比如：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">queryList</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Integer</span> status<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Integer</span> minBalance<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Integer</span> maxBalance<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">lambdaQuery</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">like</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">User</span><span class=\"token operator\">::</span><span class=\"token function\">getUsername</span><span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span>status <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">User</span><span class=\"token operator\">::</span><span class=\"token function\">getStatus</span><span class=\"token punctuation\">,</span> status<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">ge</span><span class=\"token punctuation\">(</span>minBalance <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">User</span><span class=\"token operator\">::</span><span class=\"token function\">getBalance</span><span class=\"token punctuation\">,</span> minBalance<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">le</span><span class=\"token punctuation\">(</span>maxBalance <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">User</span><span class=\"token operator\">::</span><span class=\"token function\">getBalance</span><span class=\"token punctuation\">,</span> maxBalance<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">list</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>看这两个参数：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">boolean</span> condition<span class=\"token punctuation\">,</span> <span class=\"token class-name\">R</span> column<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span> val</pre></td></tr></table></figure><p>condition 就是如果是 true 就放行这个条件（使之生效），xxx != null 那就是存在，存在的话就要生效就行。</p>\n<p>他很好的解决了 xml 中繁杂的 if 判断：</p>\n<img data-src=\"../../images/java/sc021/5.png\" alt=\"1\"  />\n<p>同样的 LambdaUpdate 也可以这样：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">boolean</span> update <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">lambdaUpdate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        <span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">User</span><span class=\"token operator\">::</span><span class=\"token function\">getBalance</span><span class=\"token punctuation\">,</span> remainBalance<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>remainBalance <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">User</span><span class=\"token operator\">::</span><span class=\"token function\">getStatus</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token punctuation\">.</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">User</span><span class=\"token operator\">::</span><span class=\"token function\">getId</span><span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"顺便一提乐观锁与悲观锁\"><a class=\"markdownIt-Anchor\" href=\"#顺便一提乐观锁与悲观锁\">#</a> 顺便一提乐观锁与悲观锁</h4>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@Transactional</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">deductBalance</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Integer</span> money<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token class-name\">User</span> user <span class=\"token operator\">=</span> baseMapper<span class=\"token punctuation\">.</span><span class=\"token function\">selectById</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>user <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> user<span class=\"token punctuation\">.</span><span class=\"token function\">getStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"用户不存在或者已冻结\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span><span class=\"token function\">getBalance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> money<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"余额不足\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">int</span> remainBalance <span class=\"token operator\">=</span> user<span class=\"token punctuation\">.</span><span class=\"token function\">getBalance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> money<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">boolean</span> update <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">lambdaUpdate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">User</span><span class=\"token operator\">::</span><span class=\"token function\">getBalance</span><span class=\"token punctuation\">,</span> remainBalance<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>remainBalance <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">User</span><span class=\"token operator\">::</span><span class=\"token function\">getStatus</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">User</span><span class=\"token operator\">::</span><span class=\"token function\">getId</span><span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">User</span><span class=\"token operator\">::</span><span class=\"token function\">getBalance</span><span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">.</span><span class=\"token function\">getBalance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>update<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"更新用户余额失败\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"更新用户余额成功，用户id：\"</span> <span class=\"token operator\">+</span> id <span class=\"token operator\">+</span> <span class=\"token string\">\"，用户余额：\"</span> <span class=\"token operator\">+</span> remainBalance<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这是乐观锁的一种实现方式，通过在  <code>update</code>  时校验旧的  <code>balance</code>  值来保证并发安全，属于基于 CAS 思想的条件更新，但不是 MyBatisPlus 内置的  <code>@Version</code>  标准乐观锁。</p>\n<p>乐观锁和悲观锁都是并发控制手段。乐观锁与悲观锁都是基于一种假设，<strong>乐观锁</strong>假设冲突很少，更新时才检查数据有没有被别人改过，<strong>悲观锁</strong>假设冲突一定会发生，操作数据前先把它锁住。</p>\n<p>悲观锁假设并发冲突一定发生，在操作数据前先加锁，其他线程必须等待。在高并发、读多写少的场景下一般使用乐观锁，在强一致、冲突频繁的场景才使用悲观锁。</p>\n<h3 id=\"批量新增\"><a class=\"markdownIt-Anchor\" href=\"#批量新增\">#</a> 批量新增</h3>\n<p>不要使用 for 循环来添加，请使用：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">saveBatch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>推荐通过 MySQL 开启：rewriteBatchedStatements=true 参数，这样会更快。</p>\n<h3 id=\"静态工具\"><a class=\"markdownIt-Anchor\" href=\"#静态工具\">#</a> 静态工具</h3>\n<p>静态工具适合用于多表查询问题，如果我们在 AService 需要用到 BService 中的内容时，我们往往会想要在 AService 中注入一个 BService，然而问题在于，如果 BService 也需要 AService 的内容呢？要在 BService 也注入一个 AService 吗，那就产生了循环依赖问题。诚然我们也可以注入一个 BaseMapper，但是毕竟 Service 更加强大，此时 <code>静态工具</code> 应运而生。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Service</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserServiceImpl</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ServiceImpl</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserMapper</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">IUserService</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">UserVO</span> <span class=\"token function\">queryUserAndAddressById</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token class-name\">User</span> user <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getById</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>user <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> user<span class=\"token punctuation\">.</span><span class=\"token function\">getStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"用户不存在或者已冻结\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Address</span><span class=\"token punctuation\">></span></span> addresses <span class=\"token operator\">=</span> <span class=\"token class-name\">Db</span><span class=\"token punctuation\">.</span><span class=\"token function\">lambdaQuery</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Address</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Address</span><span class=\"token operator\">::</span><span class=\"token function\">getUserId</span><span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">list</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token class-name\">UserVO</span> userVO <span class=\"token operator\">=</span> <span class=\"token class-name\">BeanUtil</span><span class=\"token punctuation\">.</span><span class=\"token function\">copyProperties</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> <span class=\"token class-name\">UserVO</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>addresses <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            userVO<span class=\"token punctuation\">.</span><span class=\"token function\">setAddressList</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BeanUtil</span><span class=\"token punctuation\">.</span><span class=\"token function\">copyToList</span><span class=\"token punctuation\">(</span>addresses<span class=\"token punctuation\">,</span> <span class=\"token class-name\">AddressVO</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">return</span> userVO<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这是一个在 UserService 中需要查 AddressService 的场景，其实就是要把用户信息和用户地址拼在一起，场景很常见。使用 <code>Db.lambdaQuery(Address.class)</code>  来实现， <code>Db</code>  中时 Service 的方法，只不过是静态的，通过指定类来实现反射。</p>\n<h3 id=\"善用stream流\"><a class=\"markdownIt-Anchor\" href=\"#善用stream流\">#</a> 善用 stream 流</h3>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserVO</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">listUserByIds</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> ids<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> users <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">listByIds</span><span class=\"token punctuation\">(</span>ids<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>users <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Collections</span><span class=\"token punctuation\">.</span><span class=\"token function\">emptyList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr class=\"marked\"><td data-num=\"7\"></td><td><pre>    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> collect <span class=\"token operator\">=</span> users<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">User</span><span class=\"token operator\">::</span><span class=\"token function\">getId</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Address</span><span class=\"token punctuation\">></span></span> addresses <span class=\"token operator\">=</span> <span class=\"token class-name\">Db</span><span class=\"token punctuation\">.</span><span class=\"token function\">lambdaQuery</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Address</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">in</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Address</span><span class=\"token operator\">::</span><span class=\"token function\">getUserId</span><span class=\"token punctuation\">,</span> collect<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">list</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">AddressVO</span><span class=\"token punctuation\">></span></span> addressVOS <span class=\"token operator\">=</span> <span class=\"token class-name\">BeanUtil</span><span class=\"token punctuation\">.</span><span class=\"token function\">copyToList</span><span class=\"token punctuation\">(</span>addresses<span class=\"token punctuation\">,</span> <span class=\"token class-name\">AddressVO</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">AddressVO</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> addressMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">CollUtil</span><span class=\"token punctuation\">.</span><span class=\"token function\">isNotEmpty</span><span class=\"token punctuation\">(</span>addressVOS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr class=\"marked\"><td data-num=\"14\"></td><td><pre>        addressMap <span class=\"token operator\">=</span> addressVOS<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">groupingBy</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AddressVO</span><span class=\"token operator\">::</span><span class=\"token function\">getUserId</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserVO</span><span class=\"token punctuation\">></span></span> userVOS <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>users<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">User</span> user <span class=\"token operator\">:</span> users<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token class-name\">UserVO</span> userVO <span class=\"token operator\">=</span> <span class=\"token class-name\">BeanUtil</span><span class=\"token punctuation\">.</span><span class=\"token function\">copyProperties</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> <span class=\"token class-name\">UserVO</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        userVOS<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>userVO<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        userVO<span class=\"token punctuation\">.</span><span class=\"token function\">setAddressList</span><span class=\"token punctuation\">(</span>addressMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">return</span> userVOS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"逻辑删除\"><a class=\"markdownIt-Anchor\" href=\"#逻辑删除\">#</a> 逻辑删除</h3>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">mybatis-plus</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token key atrule\">global-config</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token key atrule\">db-config</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token key atrule\">logic-delete-field</span><span class=\"token punctuation\">:</span> flag <span class=\"token comment\"># 全局逻辑删除的实体字段名，字段类型可以是 boolean、integer</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token key atrule\">logic-delete-value</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span> <span class=\"token comment\"># 逻辑已删除值 (默认为 1)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   <span class=\"token key atrule\">logic-not-delete-value</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span> <span class=\"token comment\"># 逻辑未删除值 (默认为 0)</span></pre></td></tr></table></figure><h3 id=\"枚举处理器-enumvalue\"><a class=\"markdownIt-Anchor\" href=\"#枚举处理器-enumvalue\">#</a> 枚举处理器 @EnumValue</h3>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Getter</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">enum</span> <span class=\"token class-name\">UserStatus</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">NORMAL</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"正常\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token function\">FROZEN</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"冻结\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token annotation punctuation\">@EnumValue</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token annotation punctuation\">@JsonValue</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> desc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token class-name\">UserStatus</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> value<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> desc<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>desc <span class=\"token operator\">=</span> desc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>@EnumValue</code>  指定的是在数据库中实际的存储类型，一般是 bool 类或者 int 类，主要取决你数据库的定义，而 <code>@EnumValue</code>  只需要加载数据库需要的类型上就行，然后返回到前端之前我们一般传一个 JSON，这个时候 <code>@JsonValue</code>  就起作用了， <code>@JsonValue</code>  加在那个数据上面，JSON 就返回哪个数据。当然不要忘记，User、UserVO 中的字段替换成相应的枚举类型。</p>\n<h3 id=\"json处理器\"><a class=\"markdownIt-Anchor\" href=\"#json处理器\">#</a> JSON 处理器</h3>\n<p>JSON 处理器的目的是把存储在数据库的 JSON 串转换为 Java 对象。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@TableName</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token string\">\"tb_user\"</span><span class=\"token punctuation\">,</span> autoResultMap <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">User</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token annotation punctuation\">@TableId</span><span class=\"token punctuation\">(</span>type <span class=\"token operator\">=</span> <span class=\"token class-name\">IdType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">AUTO</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> username<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> password<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> phone<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token annotation punctuation\">@TableField</span><span class=\"token punctuation\">(</span>typeHandler <span class=\"token operator\">=</span> <span class=\"token class-name\">JacksonTypeHandler</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">UserInfo</span> info<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">UserStatus</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Integer</span> balance<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">LocalDateTime</span> createTime<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">LocalDateTime</span> updateTime<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>注意： <code>@TableName(value = &quot;tb_user&quot;, autoResultMap = true)</code>  和 <code>@TableField(typeHandler = JacksonTypeHandler.class)</code></p>\n<h3 id=\"插件分页插件\"><a class=\"markdownIt-Anchor\" href=\"#插件分页插件\">#</a> 插件 —— 分页插件</h3>\n<p>MyBatisPlus 给我们提供了插件功能这个插件功能首先通过一个总的插件注册器来实现，后续如果我们需要什么插件的话，可以直接在这个总的插件器上进行挂载。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Configuration</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MyBatisConfig</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token annotation punctuation\">@Bean</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">MybatisPlusInterceptor</span> <span class=\"token function\">mybatisPlusInterceptor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token class-name\">MybatisPlusInterceptor</span> interceptor <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MybatisPlusInterceptor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token class-name\">PaginationInnerInterceptor</span> paginationInnerInterceptor <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PaginationInnerInterceptor</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DbType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">MYSQL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        paginationInnerInterceptor<span class=\"token punctuation\">.</span><span class=\"token function\">setMaxLimit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">addInnerInterceptor</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                paginationInnerInterceptor</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">return</span> interceptor<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"通用分页实体\"><a class=\"markdownIt-Anchor\" href=\"#通用分页实体\">#</a> 通用分页实体</h4>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Data</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@ApiModel</span><span class=\"token punctuation\">(</span>description <span class=\"token operator\">=</span> <span class=\"token string\">\"分页查询条件实体\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PageQuery</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token annotation punctuation\">@ApiModelProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"页码\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Integer</span> pageNo<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token annotation punctuation\">@ApiModelProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"每页数量\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Integer</span> pageSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token annotation punctuation\">@ApiModelProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"排序字段\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> sortBy<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token annotation punctuation\">@ApiModelProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"是否升序\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Boolean</span> isAsc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>其他条件可以继承 page：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@EqualsAndHashCode</span><span class=\"token punctuation\">(</span>callSuper <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@Data</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token annotation punctuation\">@ApiModel</span><span class=\"token punctuation\">(</span>description <span class=\"token operator\">=</span> <span class=\"token string\">\"用户查询条件实体\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserQuery</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">PageQuery</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token annotation punctuation\">@ApiModelProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"用户名关键字\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token annotation punctuation\">@ApiModelProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"用户状态：1-正常，2-冻结\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Integer</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token annotation punctuation\">@ApiModelProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"余额最小值\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Integer</span> minBalance<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token annotation punctuation\">@ApiModelProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"余额最大值\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Integer</span> maxBalance<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"通用分页返回实体\"><a class=\"markdownIt-Anchor\" href=\"#通用分页返回实体\">#</a> 通用分页返回实体</h4>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Data</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@ApiModel</span><span class=\"token punctuation\">(</span>description <span class=\"token operator\">=</span> <span class=\"token string\">\"分页结果\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PageDTO</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token annotation punctuation\">@ApiModelProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"总记录数\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> total<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token annotation punctuation\">@ApiModelProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"总页数\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> pages<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token annotation punctuation\">@ApiModelProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"当前页数据\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> list<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"实现案例\"><a class=\"markdownIt-Anchor\" href=\"#实现案例\">#</a> 实现案例</h4>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">PageDTO</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserVO</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">queryListPage</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">UserQuery</span> condition<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">Page</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> userPageCondition <span class=\"token operator\">=</span> <span class=\"token class-name\">Page</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>condition<span class=\"token punctuation\">.</span><span class=\"token function\">getPageNo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> condition<span class=\"token punctuation\">.</span><span class=\"token function\">getPageSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>condition<span class=\"token punctuation\">.</span><span class=\"token function\">getSortBy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>condition<span class=\"token punctuation\">.</span><span class=\"token function\">getSortBy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        userPageCondition<span class=\"token punctuation\">.</span><span class=\"token function\">addOrder</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">OrderItem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setColumn</span><span class=\"token punctuation\">(</span>condition<span class=\"token punctuation\">.</span><span class=\"token function\">getSortBy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setAsc</span><span class=\"token punctuation\">(</span>condition<span class=\"token punctuation\">.</span><span class=\"token function\">getIsAsc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        userPageCondition<span class=\"token punctuation\">.</span><span class=\"token function\">addOrder</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">OrderItem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setColumn</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"update_time\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setAsc</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token class-name\">Page</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> userPage <span class=\"token operator\">=</span> <span class=\"token function\">lambdaQuery</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">like</span><span class=\"token punctuation\">(</span>condition<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">User</span><span class=\"token operator\">::</span><span class=\"token function\">getUsername</span><span class=\"token punctuation\">,</span> condition<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span>condition<span class=\"token punctuation\">.</span><span class=\"token function\">getStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">User</span><span class=\"token operator\">::</span><span class=\"token function\">getStatus</span><span class=\"token punctuation\">,</span> condition<span class=\"token punctuation\">.</span><span class=\"token function\">getStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">ge</span><span class=\"token punctuation\">(</span>condition<span class=\"token punctuation\">.</span><span class=\"token function\">getMinBalance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">User</span><span class=\"token operator\">::</span><span class=\"token function\">getBalance</span><span class=\"token punctuation\">,</span> condition<span class=\"token punctuation\">.</span><span class=\"token function\">getMinBalance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">le</span><span class=\"token punctuation\">(</span>condition<span class=\"token punctuation\">.</span><span class=\"token function\">getMaxBalance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">User</span><span class=\"token operator\">::</span><span class=\"token function\">getBalance</span><span class=\"token punctuation\">,</span> condition<span class=\"token punctuation\">.</span><span class=\"token function\">getMaxBalance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">page</span><span class=\"token punctuation\">(</span>userPageCondition<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token class-name\">PageDTO</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserVO</span><span class=\"token punctuation\">></span></span> userPageDTO <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PageDTO</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    userPageDTO<span class=\"token punctuation\">.</span><span class=\"token function\">setTotal</span><span class=\"token punctuation\">(</span>userPage<span class=\"token punctuation\">.</span><span class=\"token function\">getTotal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    userPageDTO<span class=\"token punctuation\">.</span><span class=\"token function\">setPages</span><span class=\"token punctuation\">(</span>userPage<span class=\"token punctuation\">.</span><span class=\"token function\">getPages</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> records <span class=\"token operator\">=</span> userPage<span class=\"token punctuation\">.</span><span class=\"token function\">getRecords</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>records <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        userPageDTO<span class=\"token punctuation\">.</span><span class=\"token function\">setList</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collections</span><span class=\"token punctuation\">.</span><span class=\"token function\">emptyList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">return</span> userPageDTO<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    userPageDTO<span class=\"token punctuation\">.</span><span class=\"token function\">setList</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BeanUtil</span><span class=\"token punctuation\">.</span><span class=\"token function\">copyToList</span><span class=\"token punctuation\">(</span>records<span class=\"token punctuation\">,</span> <span class=\"token class-name\">UserVO</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">return</span> userPageDTO<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"兄弟还能更方便\"><a class=\"markdownIt-Anchor\" href=\"#兄弟还能更方便\">#</a> 兄弟，还能更方便！</h4>\n<p>原来这种实现，实际上业务逻辑只占到很小一部分，我来说一下！</p>\n<p>代码一开始：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Page</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> userPageCondition <span class=\"token operator\">=</span> <span class=\"token class-name\">Page</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>condition<span class=\"token punctuation\">.</span><span class=\"token function\">getPageNo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> condition<span class=\"token punctuation\">.</span><span class=\"token function\">getPageSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>condition<span class=\"token punctuation\">.</span><span class=\"token function\">getSortBy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>condition<span class=\"token punctuation\">.</span><span class=\"token function\">getSortBy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    userPageCondition<span class=\"token punctuation\">.</span><span class=\"token function\">addOrder</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">OrderItem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setColumn</span><span class=\"token punctuation\">(</span>condition<span class=\"token punctuation\">.</span><span class=\"token function\">getSortBy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setAsc</span><span class=\"token punctuation\">(</span>condition<span class=\"token punctuation\">.</span><span class=\"token function\">getIsAsc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    userPageCondition<span class=\"token punctuation\">.</span><span class=\"token function\">addOrder</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">OrderItem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setColumn</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"update_time\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setAsc</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>构造了一个 Page，然后对需要做排序的条件进行了设置。</p>\n<p>这里是我们的核心查询语句：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Page</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> userPage <span class=\"token operator\">=</span> <span class=\"token function\">lambdaQuery</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        <span class=\"token punctuation\">.</span><span class=\"token function\">like</span><span class=\"token punctuation\">(</span>condition<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">User</span><span class=\"token operator\">::</span><span class=\"token function\">getUsername</span><span class=\"token punctuation\">,</span> condition<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token punctuation\">.</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span>condition<span class=\"token punctuation\">.</span><span class=\"token function\">getStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">User</span><span class=\"token operator\">::</span><span class=\"token function\">getStatus</span><span class=\"token punctuation\">,</span> condition<span class=\"token punctuation\">.</span><span class=\"token function\">getStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token punctuation\">.</span><span class=\"token function\">ge</span><span class=\"token punctuation\">(</span>condition<span class=\"token punctuation\">.</span><span class=\"token function\">getMinBalance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">User</span><span class=\"token operator\">::</span><span class=\"token function\">getBalance</span><span class=\"token punctuation\">,</span> condition<span class=\"token punctuation\">.</span><span class=\"token function\">getMinBalance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token punctuation\">.</span><span class=\"token function\">le</span><span class=\"token punctuation\">(</span>condition<span class=\"token punctuation\">.</span><span class=\"token function\">getMaxBalance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">User</span><span class=\"token operator\">::</span><span class=\"token function\">getBalance</span><span class=\"token punctuation\">,</span> condition<span class=\"token punctuation\">.</span><span class=\"token function\">getMaxBalance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token punctuation\">.</span><span class=\"token function\">page</span><span class=\"token punctuation\">(</span>userPageCondition<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>紧接着，就是又一次参数的设置和类型转换：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">PageDTO</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserVO</span><span class=\"token punctuation\">></span></span> userPageDTO <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PageDTO</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>userPageDTO<span class=\"token punctuation\">.</span><span class=\"token function\">setTotal</span><span class=\"token punctuation\">(</span>userPage<span class=\"token punctuation\">.</span><span class=\"token function\">getTotal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>userPageDTO<span class=\"token punctuation\">.</span><span class=\"token function\">setPages</span><span class=\"token punctuation\">(</span>userPage<span class=\"token punctuation\">.</span><span class=\"token function\">getPages</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> records <span class=\"token operator\">=</span> userPage<span class=\"token punctuation\">.</span><span class=\"token function\">getRecords</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>records <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    userPageDTO<span class=\"token punctuation\">.</span><span class=\"token function\">setList</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collections</span><span class=\"token punctuation\">.</span><span class=\"token function\">emptyList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">return</span> userPageDTO<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>userPageDTO<span class=\"token punctuation\">.</span><span class=\"token function\">setList</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BeanUtil</span><span class=\"token punctuation\">.</span><span class=\"token function\">copyToList</span><span class=\"token punctuation\">(</span>records<span class=\"token punctuation\">,</span> <span class=\"token class-name\">UserVO</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">return</span> userPageDTO<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>我们能不能把创建 Page 和后面的整理 DTO 再进行一次封装呢？</p>\n<p>我们可以这样：</p>\n<ol>\n<li>在 PageQuery 中定义方法，将 PageQuery 对象转为 MyBatisPlus 中的 Page 对象</li>\n<li>在 PageDTO 中定义方法，将 MyBatisPlus 中的 Page 结果转为 PageDTO 结果</li>\n</ol>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Data</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@ApiModel</span><span class=\"token punctuation\">(</span>description <span class=\"token operator\">=</span> <span class=\"token string\">\"分页查询条件实体\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PageQuery</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token annotation punctuation\">@ApiModelProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"页码\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Integer</span> pageNo <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token annotation punctuation\">@ApiModelProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"每页数量\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Integer</span> pageSize <span class=\"token operator\">=</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token annotation punctuation\">@ApiModelProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"排序字段\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> sortBy<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token annotation punctuation\">@ApiModelProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"是否升序\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Boolean</span> isAsc <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token class-name\">Page</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">toMpPage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token class-name\">Page</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> userPageCondition <span class=\"token operator\">=</span> <span class=\"token class-name\">Page</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>pageNo<span class=\"token punctuation\">,</span> pageSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sortBy <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>sortBy<span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            userPageCondition<span class=\"token punctuation\">.</span><span class=\"token function\">addOrder</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">OrderItem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setColumn</span><span class=\"token punctuation\">(</span>sortBy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setAsc</span><span class=\"token punctuation\">(</span>isAsc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            userPageCondition<span class=\"token punctuation\">.</span><span class=\"token function\">addOrder</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">OrderItem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setColumn</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"update_time\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setAsc</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">return</span> userPageCondition<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token class-name\">Page</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">toMpPage</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OrderItem</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> items<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token class-name\">Page</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> userPageCondition <span class=\"token operator\">=</span> <span class=\"token class-name\">Page</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>pageNo<span class=\"token punctuation\">,</span> pageSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sortBy <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>sortBy<span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            userPageCondition<span class=\"token punctuation\">.</span><span class=\"token function\">addOrder</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">OrderItem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setColumn</span><span class=\"token punctuation\">(</span>sortBy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setAsc</span><span class=\"token punctuation\">(</span>isAsc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>items <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            userPageCondition<span class=\"token punctuation\">.</span><span class=\"token function\">addOrder</span><span class=\"token punctuation\">(</span>items<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token keyword\">return</span> userPageCondition<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Data</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@ApiModel</span><span class=\"token punctuation\">(</span>description <span class=\"token operator\">=</span> <span class=\"token string\">\"分页结果\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PageDTO</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token annotation punctuation\">@ApiModelProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"总记录数\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> total<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token annotation punctuation\">@ApiModelProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"总页数\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> pages<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token annotation punctuation\">@ApiModelProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"当前页数据\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> list<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span>PO<span class=\"token punctuation\">,</span> VO<span class=\"token punctuation\">></span></span> <span class=\"token class-name\">PageDTO</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span>VO<span class=\"token punctuation\">></span></span> <span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Page</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span>PO<span class=\"token punctuation\">></span></span> pageT<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span>VO<span class=\"token punctuation\">></span></span> clazz<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token class-name\">PageDTO</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span>VO<span class=\"token punctuation\">></span></span> userPageDTO <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PageDTO</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        userPageDTO<span class=\"token punctuation\">.</span><span class=\"token function\">setTotal</span><span class=\"token punctuation\">(</span>pageT<span class=\"token punctuation\">.</span><span class=\"token function\">getTotal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        userPageDTO<span class=\"token punctuation\">.</span><span class=\"token function\">setPages</span><span class=\"token punctuation\">(</span>pageT<span class=\"token punctuation\">.</span><span class=\"token function\">getPages</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span>PO<span class=\"token punctuation\">></span></span> records <span class=\"token operator\">=</span> pageT<span class=\"token punctuation\">.</span><span class=\"token function\">getRecords</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>records <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> records<span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            userPageDTO<span class=\"token punctuation\">.</span><span class=\"token function\">setList</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collections</span><span class=\"token punctuation\">.</span><span class=\"token function\">emptyList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token keyword\">return</span> userPageDTO<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        userPageDTO<span class=\"token punctuation\">.</span><span class=\"token function\">setList</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BeanUtil</span><span class=\"token punctuation\">.</span><span class=\"token function\">copyToList</span><span class=\"token punctuation\">(</span>records<span class=\"token punctuation\">,</span> clazz<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">return</span> userPageDTO<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span>PO<span class=\"token punctuation\">,</span> VO<span class=\"token punctuation\">></span></span> <span class=\"token class-name\">PageDTO</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span>VO<span class=\"token punctuation\">></span></span> <span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Page</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span>PO<span class=\"token punctuation\">></span></span> pageT<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span>VO<span class=\"token punctuation\">></span></span> clazz<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Function</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span>PO<span class=\"token punctuation\">,</span> VO<span class=\"token punctuation\">></span></span> convertor<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token class-name\">PageDTO</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span>VO<span class=\"token punctuation\">></span></span> userPageDTO <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PageDTO</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        userPageDTO<span class=\"token punctuation\">.</span><span class=\"token function\">setTotal</span><span class=\"token punctuation\">(</span>pageT<span class=\"token punctuation\">.</span><span class=\"token function\">getTotal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        userPageDTO<span class=\"token punctuation\">.</span><span class=\"token function\">setPages</span><span class=\"token punctuation\">(</span>pageT<span class=\"token punctuation\">.</span><span class=\"token function\">getPages</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span>PO<span class=\"token punctuation\">></span></span> records <span class=\"token operator\">=</span> pageT<span class=\"token punctuation\">.</span><span class=\"token function\">getRecords</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>records <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> records<span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            userPageDTO<span class=\"token punctuation\">.</span><span class=\"token function\">setList</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collections</span><span class=\"token punctuation\">.</span><span class=\"token function\">emptyList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            <span class=\"token keyword\">return</span> userPageDTO<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        userPageDTO<span class=\"token punctuation\">.</span><span class=\"token function\">setList</span><span class=\"token punctuation\">(</span>records<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>convertor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token keyword\">return</span> userPageDTO<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"demo2_再会docker\"><a class=\"markdownIt-Anchor\" href=\"#demo2_再会docker\">#</a> Demo2_再会 Docker</h2>\n<h3 id=\"安装\"><a class=\"markdownIt-Anchor\" href=\"#安装\">#</a> 安装</h3>\n<p>卸载旧版</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum remove <span class=\"token function\">docker</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    docker-client <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    docker-client-latest <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    docker-common <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    docker-latest <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    docker-latest-logrotate <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    docker-logrotate <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    docker-engine <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    docker-selinux</pre></td></tr></table></figure><p>搭建 Docker 的 apt 仓库。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># Add Docker's official GPG key:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> update</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> ca-certificates <span class=\"token function\">curl</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">-m</span> 0755 <span class=\"token parameter variable\">-d</span> /etc/apt/keyrings</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">curl</span> <span class=\"token parameter variable\">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg <span class=\"token parameter variable\">-o</span> /etc/apt/keyrings/docker.asc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">chmod</span> a+r /etc/apt/keyrings/docker.asc</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># Add the repository to Apt sources:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> /etc/apt/sources.list.d/docker.sources <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Types: deb</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>URIs: https://download.docker.com/linux/ubuntu</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Suites: <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">.</span> /etc/os-release <span class=\"token operator\">&amp;&amp;</span> <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;UBUNTU_CODENAME<span class=\"token operator\">:-</span>$VERSION_CODENAME&#125;</span>\"</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Components: stable</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>Signed-By: /etc/apt/keyrings/docker.asc</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>EOF</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> update</pre></td></tr></table></figure><p>安装 Docker</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</pre></td></tr></table></figure><p>Docker 服务安装后会自动启动。要验证 Docker 正在运行，请使用：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> systemctl status <span class=\"token function\">docker</span></pre></td></tr></table></figure><p>前置修复</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">wget</span> <span class=\"token parameter variable\">-O</span> /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sudo</span> yum clean all</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">sudo</span> yum makecache</pre></td></tr></table></figure><p>安装 Docker</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> <span class=\"token parameter variable\">-y</span> docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</pre></td></tr></table></figure><p>通过运行  <code>hello-world</code>  镜像验证安装成功：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">docker</span> run hello-world</pre></td></tr></table></figure><p>镜像加速：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /etc/docker</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /etc/docker</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> /etc/docker/daemon.json <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>&#123;</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  \"registry-mirrors\": [</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    \"https://docker.m.daocloud.io\",</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    \"https://registry.docker-cn.com\"</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  ]</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>&#125;</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>EOF</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>systemctl daemon-reload</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>systemctl restart <span class=\"token function\">docker</span></pre></td></tr></table></figure><h3 id=\"容器化mysql\"><a class=\"markdownIt-Anchor\" href=\"#容器化mysql\">#</a> 容器化 MySQL</h3>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token parameter variable\">--name</span> mysql <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token parameter variable\">-p</span> <span class=\"token number\">3306</span>:3306 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">TZ</span><span class=\"token operator\">=</span>Asia/Shanghai <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">MYSQL_ROOT_PASSWORD</span><span class=\"token operator\">=</span><span class=\"token number\">123</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  mysql</pre></td></tr></table></figure><p>docker run 命令中的常见参数:</p>\n<ol>\n<li><code>-d</code> ：detached 模式（后台运行）</li>\n<li><code>--name</code> ：给容器起名字</li>\n<li><code>-e</code>  ：设置环境变量</li>\n<li><code>-p</code> ：端口映射（宿主机 ↔ 容器）</li>\n</ol>\n<p>镜像名称结构：<strong>Repository:TAG</strong></p>\n<p>比如：nginx:latest、mysql:8.0、redis:7</p>\n<h3 id=\"常见命令\"><a class=\"markdownIt-Anchor\" href=\"#常见命令\">#</a> 常见命令</h3>\n<img data-src=\"../../images/java/sc021/6.png\" alt=\"6\" style=\"zoom:80%;\" />\n<h4 id=\"拉镜像\"><a class=\"markdownIt-Anchor\" href=\"#拉镜像\">#</a> 拉镜像</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> pull nginx:latest</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">docker</span> images</pre></td></tr></table></figure><h4 id=\"保存成包\"><a class=\"markdownIt-Anchor\" href=\"#保存成包\">#</a> 保存成包</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">docker</span> save <span class=\"token parameter variable\">-o</span> nginx.tar nginx:latest</pre></td></tr></table></figure><h4 id=\"删除镜像\"><a class=\"markdownIt-Anchor\" href=\"#删除镜像\">#</a> 删除镜像</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">docker</span> rmi nginx:latest</pre></td></tr></table></figure><h4 id=\"加载镜像\"><a class=\"markdownIt-Anchor\" href=\"#加载镜像\">#</a> 加载镜像</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">docker</span> load <span class=\"token parameter variable\">-i</span> nginx.tar</pre></td></tr></table></figure><h4 id=\"创建并运行容器\"><a class=\"markdownIt-Anchor\" href=\"#创建并运行容器\">#</a> 创建并运行容器</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>~sudo <span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">--name</span> nginx <span class=\"token parameter variable\">-p</span> <span class=\"token number\">80</span>:80 nginx</pre></td></tr></table></figure><h4 id=\"查看容器状态\"><a class=\"markdownIt-Anchor\" href=\"#查看容器状态\">#</a> 查看容器状态</h4>\n<p>微博客解析这个有 bug… 只能放图片了。</p>\n<img data-src=\"../../images/java/sc021/7.png\" alt=\"7\" style=\"zoom:80%;\" />\n<h4 id=\"停止容器\"><a class=\"markdownIt-Anchor\" href=\"#停止容器\">#</a> 停止容器</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">docker</span> <span class=\"token function\">ps</span> stop nginx</pre></td></tr></table></figure><h4 id=\"再次运行容器不要用run\"><a class=\"markdownIt-Anchor\" href=\"#再次运行容器不要用run\">#</a> 再次运行容器，不要用 run</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">docker</span> start nginx</pre></td></tr></table></figure><h4 id=\"持续跟踪日志\"><a class=\"markdownIt-Anchor\" href=\"#持续跟踪日志\">#</a> 持续跟踪日志</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">docker</span> logs <span class=\"token parameter variable\">-f</span> nginx</pre></td></tr></table></figure><h4 id=\"进入容器内部\"><a class=\"markdownIt-Anchor\" href=\"#进入容器内部\">#</a> 进入容器内部</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> nginx <span class=\"token function\">bash</span></pre></td></tr></table></figure><h4 id=\"退出容器内部\"><a class=\"markdownIt-Anchor\" href=\"#退出容器内部\">#</a> 退出容器内部</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">exit</span></pre></td></tr></table></figure><h4 id=\"删除容器\"><a class=\"markdownIt-Anchor\" href=\"#删除容器\">#</a> 删除容器</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">docker</span> <span class=\"token function\">rm</span> mysql <span class=\"token parameter variable\">-f</span>\t<span class=\"token comment\"># 非强制删除</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">docker</span> <span class=\"token function\">rm</span> mysql <span class=\"token parameter variable\">-f</span>\t<span class=\"token comment\"># 强制删除</span></pre></td></tr></table></figure><h3 id=\"linux技巧\"><a class=\"markdownIt-Anchor\" href=\"#linux技巧\">#</a> Linux 技巧</h3>\n<p>长命令可以配置别名：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 修改别名</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">vim</span> ~/.bashrc</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 生效</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token builtin class-name\">source</span> ~/.bashrc</pre></td></tr></table></figure><img data-src=\"../../images/java/sc021/8.png\" alt=\"6\" style=\"zoom:80%;\" />\n<h3 id=\"数据卷\"><a class=\"markdownIt-Anchor\" href=\"#数据卷\">#</a> 数据卷</h3>\n<p>数据卷是一个虚拟目录，是容器内目录与宿主机目录之间映射的桥梁。</p>\n<img data-src=\"../../images/java/sc021/9.png\" alt=\"6\" style=\"zoom:80%;\" />\n<p>在执行 docker run 命令时，使用 -v 数据卷：容器内目录 可以完成数据卷挂载</p>\n<h4 id=\"创建数据卷\"><a class=\"markdownIt-Anchor\" href=\"#创建数据卷\">#</a> 创建数据卷</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> volume create</pre></td></tr></table></figure><h4 id=\"查看所有数据卷\"><a class=\"markdownIt-Anchor\" href=\"#查看所有数据卷\">#</a> 查看所有数据卷</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> volume <span class=\"token function\">ls</span></pre></td></tr></table></figure><h4 id=\"删除指定数据卷\"><a class=\"markdownIt-Anchor\" href=\"#删除指定数据卷\">#</a> 删除指定数据卷</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> volume <span class=\"token function\">rm</span></pre></td></tr></table></figure><h4 id=\"查看某个数据卷的详情\"><a class=\"markdownIt-Anchor\" href=\"#查看某个数据卷的详情\">#</a> 查看某个数据卷的详情</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> volume inspect</pre></td></tr></table></figure><h4 id=\"清除数据卷\"><a class=\"markdownIt-Anchor\" href=\"#清除数据卷\">#</a> 清除数据卷</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> volume prune</pre></td></tr></table></figure><h4 id=\"创建nginx的映射卷\"><a class=\"markdownIt-Anchor\" href=\"#创建nginx的映射卷\">#</a> 创建 nginx 的映射卷</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">--name</span> nginx <span class=\"token parameter variable\">-p</span> <span class=\"token number\">80</span>:80 <span class=\"token parameter variable\">-v</span> html:/usr/share/nginx/html nginx</pre></td></tr></table></figure><h3 id=\"最终的mysql脚本\"><a class=\"markdownIt-Anchor\" href=\"#最终的mysql脚本\">#</a> 最终的 MySQL 脚本</h3>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token parameter variable\">--name</span> mysql <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token parameter variable\">-p</span> <span class=\"token number\">3306</span>:3306 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">TZ</span><span class=\"token operator\">=</span>Asia/Shanghai <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">MYSQL_ROOT_PASSWORD</span><span class=\"token operator\">=</span><span class=\"token number\">123</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token parameter variable\">-v</span> /root/mysql/data:/var/lib/mysql <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token parameter variable\">-v</span> /root/mysql/init:/docker-entrypoint-initdb.d <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token parameter variable\">-v</span> /root/mysql/conf:/etc/mysql/conf.d <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  mysql</pre></td></tr></table></figure><img data-src=\"../../images/java/sc021/10.png\" alt=\"6\" style=\"zoom:80%;\" />\n<p>在对应位置创建这三个目录</p>\n<p>使用之后可以观察到：</p>\n<img data-src=\"../../images/java/sc021/11.png\" alt=\"6\" style=\"zoom:80%;\" />\n<p>这种方法是基于本地目录直接挂载，由于采用的是<strong>目录级别的直接映射</strong>，MySQL 的真实数据实际上是存储在宿主机的  <code>/root/mysql/data</code>  目录中，而不是容器内部。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token parameter variable\">-v</span> /root/mysql/data:/var/lib/mysql <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token parameter variable\">-v</span> /root/mysql/init:/docker-entrypoint-initdb.d <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token parameter variable\">-v</span> /root/mysql/conf:/etc/mysql/conf.d <span class=\"token punctuation\">\\</span></pre></td></tr></table></figure><p>即便我们把 MySQL 容器删除，然后我们又重新创建一个全新的 MySQL 容器，只要我们保证我们还是映射到这三个目录，数据表就不会丢失。</p>\n<h3 id=\"自定义镜像\"><a class=\"markdownIt-Anchor\" href=\"#自定义镜像\">#</a> 自定义镜像</h3>\n<p>镜像就是包含了应用程序、程序运行的系统函数库、运行配置等文件的文件包。构建镜像的过程其实就是把上述文件打包的过程。</p>\n<p>构建一个 Java 镜像的步骤：</p>\n<ol>\n<li>准备一个 Linux 运行环境</li>\n<li>安装 JRE 并配置环境变量</li>\n<li>拷贝 Jar 包</li>\n<li>编写运行脚本</li>\n</ol>\n<p>镜像是分层的：</p>\n<img data-src=\"../../images/java/sc021/12.png\" alt=\"6\" style=\"zoom:80%;\" />\n<p>实际上基础层已经有人帮我们构建好，基础层通常为一些核心的函数库，环境配置文件等。我们只需要声明需要什么就可以了。</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\"><strong>指令</strong></th>\n<th style=\"text-align:center\"><strong>说明</strong></th>\n<th style=\"text-align:center\"><strong>示例</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">FROM</td>\n<td style=\"text-align:center\">指定基础镜像</td>\n<td style=\"text-align:center\">FROM centos:6</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">ENV</td>\n<td style=\"text-align:center\">设置环境变量，可在后面指令使用</td>\n<td style=\"text-align:center\">ENV key value</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">COPY</td>\n<td style=\"text-align:center\">拷贝本地文件到镜像的指定目录</td>\n<td style=\"text-align:center\">COPY ./jre11.tar.gz /tmp</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">RUN</td>\n<td style=\"text-align:center\">执行 Linux 的 shell 命令，一般是安装过程的命令</td>\n<td style=\"text-align:center\">RUN tar -zxvf /tmp/jre11.tar.gz  &amp;&amp; EXPORTS  path=/tmp/jre11:$path</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">EXPOSE</td>\n<td style=\"text-align:center\">指定容器运行时监听的端口，是给镜像使用者看的</td>\n<td style=\"text-align:center\">EXPOSE 8080</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">ENTRYPOINT</td>\n<td style=\"text-align:center\">镜像中应用的启动命令，容器运行时调用</td>\n<td style=\"text-align:center\">ENTRYPOINT java -jar xx.jar</td>\n</tr>\n</tbody>\n</table>\n<p>更新详细语法说明，请参考官网文档： <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmRvY2tlci5jb20vZW5naW5lL3JlZmVyZW5jZS9idWlsZGVy\">https://docs.docker.com/engine/reference/builder</span></p>\n<h4 id=\"dockerfile\"><a class=\"markdownIt-Anchor\" href=\"#dockerfile\">#</a> Dockerfile</h4>\n<p>我们可以基于 Ubuntu 基础镜像，利用 Dockerfile 描述镜像结构</p>\n<figure class=\"highlight dockerfile\"><figcaption data-lang=\"Docker\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 指定基础镜像</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> ubuntu:16.04</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 配置环境变量，JDK 的安装目录、容器内时区</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">ENV</span> JAVA_DIR=/usr/local</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 拷贝 jdk 和 java 项目的包</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">COPY</span> ./jdk8.tar.gz <span class=\"token variable\">$JAVA_DIR</span>/</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">COPY</span> ./docker-demo.jar /tmp/app.jar</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># 安装 JDK</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">RUN</span> cd <span class=\"token variable\">$JAVA_DIR</span> \\ &amp;&amp; tar -xf ./jdk8.tar.gz \\ &amp;&amp; mv ./jdk1.8.0_144 ./java8</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 配置环境变量</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">ENV</span> JAVA_HOME=<span class=\"token variable\">$JAVA_DIR</span>/java8</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">ENV</span> PATH=<span class=\"token variable\">$PATH</span>:<span class=\"token variable\">$JAVA_HOME</span>/bin</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># 入口，java 项目的启动命令</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">ENTRYPOINT</span> [<span class=\"token string\">\"java\"</span>, <span class=\"token string\">\"-jar\"</span>, <span class=\"token string\">\"/app.jar\"</span>]</span></pre></td></tr></table></figure><p>也可以直接基于 jdk 为基础镜像，省略前面的步骤：</p>\n<figure class=\"highlight dockerfile\"><figcaption data-lang=\"Docker\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 基础镜像</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> openjdk:11.0-jre-buster</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 拷贝 jar 包</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">COPY</span> docker-demo.jar /app.jar</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 入口</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">ENTRYPOINT</span> [<span class=\"token string\">\"java\"</span>, <span class=\"token string\">\"-jar\"</span>, <span class=\"token string\">\"/app.jar\"</span>]</span></pre></td></tr></table></figure><p>当编写好了 Dockerfile，可以利用下面命令来构建镜像：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> build <span class=\"token parameter variable\">-t</span> myImage:1.0 <span class=\"token builtin class-name\">.</span></pre></td></tr></table></figure><p><code>-t</code> ：是给镜像起名，格式依然是 repository:tag 的格式，不指定 tag 时，默认为 latest</p>\n<p><code>.</code>  ：是指定 Dockerfile 所在目录，如果就在当前目录，则指定为 &quot;.&quot;</p>\n<h3 id=\"docker网络\"><a class=\"markdownIt-Anchor\" href=\"#docker网络\">#</a> Docker 网络</h3>\n<p>默认情况下，所有容器都是以 bridge 方式连接到 Docker 的一个虚拟网桥上：</p>\n<img data-src=\"../../images/java/sc021/13.png\" alt=\"6\" style=\"zoom:80%;\" />\n<p>网络号 172.17.0.0，一共 32 位  每八个为一段，也就是 x.x.x.x ， <code>16</code>  指的就是子网掩码的位数，也叫 **CIDR ** 前缀长度，但 IP 可能会变，我们需要配置一下，更好的方法是使用自定义网络。</p>\n<p>加入自定义网络的容器才可以通过容器名互相访问，Docker 的网络操作命令如下：</p>\n<table>\n<thead>\n<tr>\n<th><strong>命令</strong></th>\n<th><strong>说明</strong></th>\n<th><strong>文档地址</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>docker network create</td>\n<td>创建一个网络</td>\n<td><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmRvY2tlci5jb20vZW5naW5lL3JlZmVyZW5jZS9jb21tYW5kbGluZS9uZXR3b3JrX2NyZWF0ZS8=\">docker   network create</span></td>\n</tr>\n<tr>\n<td>docker network ls</td>\n<td>查看所有网络</td>\n<td><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmRvY2tlci5jb20vZW5naW5lL3JlZmVyZW5jZS9jb21tYW5kbGluZS9uZXR3b3JrX2xzLw==\">docker   network ls</span></td>\n</tr>\n<tr>\n<td>docker network rm</td>\n<td>删除指定网络</td>\n<td><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmRvY2tlci5jb20vZW5naW5lL3JlZmVyZW5jZS9jb21tYW5kbGluZS9uZXR3b3JrX3JtLw==\">docker   network rm</span></td>\n</tr>\n<tr>\n<td>docker network prune</td>\n<td>清除未使用的网络</td>\n<td><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmRvY2tlci5jb20vZW5naW5lL3JlZmVyZW5jZS9jb21tYW5kbGluZS9uZXR3b3JrX3BydW5lLw==\">docker   network prune</span></td>\n</tr>\n<tr>\n<td>docker network connect</td>\n<td>使指定容器连接加入某网络</td>\n<td><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmRvY2tlci5jb20vZW5naW5lL3JlZmVyZW5jZS9jb21tYW5kbGluZS9uZXR3b3JrX2Nvbm5lY3Qv\">docker   network connect</span></td>\n</tr>\n<tr>\n<td>docker network disconnect</td>\n<td>使指定容器连接离开某网络</td>\n<td><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmRvY2tlci5jb20vZW5naW5lL3JlZmVyZW5jZS9jb21tYW5kbGluZS9uZXR3b3JrX2Rpc2Nvbm5lY3Qv\">docker   network disconnect</span></td>\n</tr>\n<tr>\n<td>docker network inspect</td>\n<td>查看网络详细信息</td>\n<td><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmRvY2tlci5jb20vZW5naW5lL3JlZmVyZW5jZS9jb21tYW5kbGluZS9uZXR3b3JrX2luc3BlY3Qv\">docker   network inspect</span></td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"创建网络knet\"><a class=\"markdownIt-Anchor\" href=\"#创建网络knet\">#</a> 创建网络 knet</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> network create knet</pre></td></tr></table></figure><h4 id=\"让mysql连接上\"><a class=\"markdownIt-Anchor\" href=\"#让mysql连接上\">#</a> 让 MySQL 连接上</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> network connect knet mysql</pre></td></tr></table></figure><h4 id=\"让容器在创建时就连接上\"><a class=\"markdownIt-Anchor\" href=\"#让容器在创建时就连接上\">#</a> 让容器在创建时就连接上</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">--name</span> <span class=\"token function\">dd</span> <span class=\"token parameter variable\">-p</span> <span class=\"token number\">8080</span>:8080 <span class=\"token parameter variable\">--network</span> knet docker-demo</pre></td></tr></table></figure><h3 id=\"部署java应用\"><a class=\"markdownIt-Anchor\" href=\"#部署java应用\">#</a> 部署 Java 应用</h3>\n<ol>\n<li>\n<p>构建 Jar 包（省略）</p>\n</li>\n<li>\n<p>编写 DockerFile</p>\n<figure class=\"highlight dockerfile\"><figcaption data-lang=\"Docker\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 基础镜像</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> openjdk:11.0-jre-buster</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 设定时区</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">ENV</span> TZ=Asia/Shanghai</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">RUN</span> ln -snf /usr/share/zoneinfo/<span class=\"token variable\">$TZ</span> /etc/localtime &amp;&amp; echo <span class=\"token variable\">$TZ</span> > /etc/timezone</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 拷贝 jar 包</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">COPY</span> hm-service.jar /app.jar</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># 入口</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">ENTRYPOINT</span> [<span class=\"token string\">\"java\"</span>, <span class=\"token string\">\"-jar\"</span>, <span class=\"token string\">\"/app.jar\"</span>]</span></pre></td></tr></table></figure></li>\n<li>\n<p>将 Jar 与 DockerFile 都上传到服务器</p>\n</li>\n<li>\n<p>执行命令</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">--name</span> hm <span class=\"token parameter variable\">-p</span> <span class=\"token number\">8080</span>:8080 <span class=\"token parameter variable\">--network</span> knet hmall</pre></td></tr></table></figure></li>\n</ol>\n<h3 id=\"部署前端应用\"><a class=\"markdownIt-Anchor\" href=\"#部署前端应用\">#</a> 部署前端应用</h3>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token parameter variable\">--name</span> nginx <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token parameter variable\">-p</span> <span class=\"token number\">18080</span>:18080 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> <span class=\"token parameter variable\">-p</span> <span class=\"token number\">18081</span>:18081 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token parameter variable\">-v</span> /root/nginx/html:/usr/share/nginx/html <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> <span class=\"token parameter variable\">-v</span> /root/nginx/nginx.conf:/etc/nginx/nginx.conf <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token parameter variable\">--network</span> knet <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> nginx</pre></td></tr></table></figure><ol>\n<li>\n<p>路径挂载</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token parameter variable\">-v</span> /root/nginx/html:/usr/share/nginx/html</pre></td></tr></table></figure></li>\n<li>\n<p>文件挂载</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token parameter variable\">-v</span> /root/nginx/nginx.conf:/etc/nginx/nginx.conf</pre></td></tr></table></figure></li>\n<li>\n<p>网络配置</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token parameter variable\">--network</span> knet</pre></td></tr></table></figure></li>\n</ol>\n<h3 id=\"dockercompose统一管理与自动部署\"><a class=\"markdownIt-Anchor\" href=\"#dockercompose统一管理与自动部署\">#</a> DockerCompose 统一管理与自动部署</h3>\n<p>Docker Compose 通过一个单独的 docker-compose.yml 模板文件来定义一组相关联的应用容器，帮助我们实现多个相互关联的 Docker 容器的快速部署。</p>\n<img data-src=\"../../images/java/sc021/14.png\" alt=\"6\" style=\"zoom:80%;\" />\n<img data-src=\"../../images/java/sc021/15.png\" alt=\"6\" style=\"zoom:80%;\" />\n<p>DockerCompose 的命令格式如下：</p>\n<img data-src=\"../../images/java/sc021/16.png\" alt=\"6\" style=\"zoom:80%;\" />\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3.8\"</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">mysql</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> mysql</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> mysql</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"3306:3306\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token key atrule\">TZ</span><span class=\"token punctuation\">:</span> Asia/Shanghai</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token key atrule\">MYSQL_ROOT_PASSWORD</span><span class=\"token punctuation\">:</span> <span class=\"token number\">123</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"./mysql/conf:/etc/mysql/conf.d\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"./mysql/data:/var/lib/mysql\"</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"./mysql/init:/docker-entrypoint-initdb.d\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token punctuation\">-</span> hm<span class=\"token punctuation\">-</span>net</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token key atrule\">hmall</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span> </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token key atrule\">context</span><span class=\"token punctuation\">:</span> .</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token key atrule\">dockerfile</span><span class=\"token punctuation\">:</span> Dockerfile</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> hmall</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"8080:8080\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token punctuation\">-</span> hm<span class=\"token punctuation\">-</span>net</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token punctuation\">-</span> mysql</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token key atrule\">nginx</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"18080:18080\"</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"18081:18081\"</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"./nginx/nginx.conf:/etc/nginx/nginx.conf\"</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"./nginx/html:/usr/share/nginx/html\"</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      <span class=\"token punctuation\">-</span> hmall</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      <span class=\"token punctuation\">-</span> hm<span class=\"token punctuation\">-</span>net</pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  <span class=\"token key atrule\">hm-net</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> hmall</pre></td></tr></table></figure><p>执行：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> compose up <span class=\"token parameter variable\">-d</span></pre></td></tr></table></figure><p>这个和 DockerRun 基本上类似的，但远不止于此，多实例部署、负载均衡等。</p>\n",
            "tags": [
                "Java",
                "微服务相关",
                "java",
                "微服务",
                "RabbitMQ",
                "SpringBoot",
                "MyBatisPlus",
                "SpringCloud",
                "Elasticsearch",
                "Redis",
                "笔记"
            ]
        },
        {
            "id": "https://735690757.github.io/Java/gitflow/",
            "url": "https://735690757.github.io/Java/gitflow/",
            "title": "GitFlow分支管理策略",
            "date_published": "2026-01-31T02:20:00.000Z",
            "content_html": "<h1 id=\"gitflow\"><a class=\"markdownIt-Anchor\" href=\"#gitflow\">#</a> GitFlow</h1>\n<h2 id=\"什么是gitflow\"><a class=\"markdownIt-Anchor\" href=\"#什么是gitflow\">#</a> 什么是 GitFlow？</h2>\n<blockquote>\n<p>Gitflow 是一种替代的 Git 分支模型，涉及功能分支和多个主分支的使用。该书最初由文森特・德里森在 nvie 出版并推广开来。与基于 trunk 的开发相比，Gitflow 拥有众多且寿命更长的分支和更大的提交。在该模型下，开发者创建一个功能分支，并延迟将其合并到主干分支，直到功能完成。这些寿命较长的特征分支需要更多的协作来合并，且偏离主干分支的风险更高。它们也可能引入冲突更新。</p>\n<p>Gitflow 可用于有预定发布周期的项目，也可用于<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYXRsYXNzaWFuLmNvbS96aC9kZXZvcHMvd2hhdC1pcy1kZXZvcHMvZGV2b3BzLWJlc3QtcHJhY3RpY2Vz\">持续交付</span>的 <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYXRsYXNzaWFuLmNvbS96aC9jb250aW51b3VzLWRlbGl2ZXJ5\">DevOps 最佳实践</span>。除了<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYXRsYXNzaWFuLmNvbS96aC9naXQvdHV0b3JpYWxzL2NvbXBhcmluZy13b3JrZmxvd3MvZmVhdHVyZS1icmFuY2gtd29ya2Zsb3c=\">功能分支工作流程</span>所需的概念或命令外，此工作流程不会添加任何新概念或命令。相反，它为不同的分支分配了非常具体的角色，并定义了它们应该如何以及何时进行交互。除了  <code>feature</code>  分支外，它还使用单独分支来准备、维护和录制版本。当然，您还可以利用功能分支工作流程的所有优势：拉取请求、隔离实验和更高效的协作。</p>\n</blockquote>\n<h2 id=\"五大分支\"><a class=\"markdownIt-Anchor\" href=\"#五大分支\">#</a> 五大分支</h2>\n<ol>\n<li>主分支：main /  master</li>\n<li>开发分支：develop</li>\n<li>功能分支：feature</li>\n<li>发布分支：release</li>\n<li>热修复分支 hotfix</li>\n</ol>\n<h3 id=\"主分支main-master\"><a class=\"markdownIt-Anchor\" href=\"#主分支main-master\">#</a> 主分支： <code>main / master</code></h3>\n<p><strong>永远保持可发布状态</strong></p>\n<p>每一次提交都应该是<strong>已经测试、可上线的版本</strong></p>\n<p>通常只允许：</p>\n<ul>\n<li><code>release</code>  合并进来</li>\n<li><code>hotfix</code>  合并进来</li>\n</ul>\n<p>一般会在这里 <strong>打 tag</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>v1.0.0</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>v1.1.0</pre></td></tr></table></figure><p>不在 main 上直接开发代码</p>\n<h3 id=\"开发分支develop\"><a class=\"markdownIt-Anchor\" href=\"#开发分支develop\">#</a> 开发分支： <code>develop</code></h3>\n<p><strong>作用：日常开发的集成分支</strong></p>\n<ul>\n<li>所有新功能最终都会合并到这里</li>\n<li>包含 “下一个版本” 的所有开发内容</li>\n<li>相对不如 main 稳定，但应该是<strong>可运行的</strong></li>\n</ul>\n<p>特点：</p>\n<ul>\n<li><code>feature</code>  →  <code>develop</code></li>\n<li><code>develop</code>  →  <code>release</code></li>\n</ul>\n<h3 id=\"功能分支feature\"><a class=\"markdownIt-Anchor\" href=\"#功能分支feature\">#</a> 功能分支： <code>feature/*</code></h3>\n<p><strong>作用：开发具体功能</strong></p>\n<ul>\n<li>从  <code>develop</code>  拉出来</li>\n<li>一个功能一个分支</li>\n<li>功能完成后合并回  <code>develop</code></li>\n</ul>\n<h3 id=\"发布分支release\"><a class=\"markdownIt-Anchor\" href=\"#发布分支release\">#</a> 发布分支： <code>release/*</code></h3>\n<p><strong>作用：版本发布前的 “冻结分支”</strong></p>\n<ul>\n<li>从  <code>develop</code>  拉出来</li>\n<li>只允许：\n<ul>\n<li>bug 修复</li>\n<li>文档 / 版本号修改</li>\n</ul>\n</li>\n<li><strong>不再添加新功能</strong></li>\n</ul>\n<h3 id=\"热修复分支hotfix\"><a class=\"markdownIt-Anchor\" href=\"#热修复分支hotfix\">#</a> 热修复分支： <code>hotfix/*</code></h3>\n<p><strong>作用：线上紧急 Bug 修复</strong></p>\n<ul>\n<li>从  <code>main</code>  拉出来</li>\n<li>修完立刻发布</li>\n<li>同时要合并回  <code>develop</code></li>\n</ul>\n<h2 id=\"基本图\"><a class=\"markdownIt-Anchor\" href=\"#基本图\">#</a> 基本图</h2>\n<img data-src=\"../../images/java/gitflow/1.png\" alt=\"1\" style=\"zoom:80%;\" />\n<h2 id=\"前置流程\"><a class=\"markdownIt-Anchor\" href=\"#前置流程\">#</a> 前置流程</h2>\n<img data-src=\"../../images/java/gitflow/2.png\" alt=\"1\" style=\"zoom:80%;\" />\n<img data-src=\"../../images/java/gitflow/3.png\" alt=\"1\" style=\"zoom:80%;\" />\n<img data-src=\"../../images/java/gitflow/4.png\" alt=\"1\" style=\"zoom:80%;\" />\n<h2 id=\"开发新需求a\"><a class=\"markdownIt-Anchor\" href=\"#开发新需求a\">#</a> 开发新需求 A</h2>\n<img data-src=\"../../images/java/gitflow/5.png\" alt=\"1\" style=\"zoom:80%;\" />\n<p>提交</p>\n<img data-src=\"../../images/java/gitflow/6.png\" alt=\"1\" style=\"zoom:80%;\" />\n<p>观察到 dev 并未受影响。</p>\n<img data-src=\"../../images/java/gitflow/7.png\" alt=\"1\" style=\"zoom:80%;\" />\n<img data-src=\"../../images/java/gitflow/8.png\" alt=\"1\" style=\"zoom:80%;\" />\n<h2 id=\"开发新需求b与c\"><a class=\"markdownIt-Anchor\" href=\"#开发新需求b与c\">#</a> 开发新需求 B 与 C</h2>\n<p>省略，同样提交并合并到 dev 之中</p>\n<h2 id=\"合并的结果\"><a class=\"markdownIt-Anchor\" href=\"#合并的结果\">#</a> 合并的结果</h2>\n<img data-src=\"../../images/java/gitflow/9.png\" alt=\"1\" style=\"zoom:80%;\" />\n<p>为了整洁，新特性开发完毕之后需可以删除分支。</p>\n<img data-src=\"../../images/java/gitflow/10.png\" alt=\"1\" style=\"zoom:80%;\" />\n<h2 id=\"发布分支\"><a class=\"markdownIt-Anchor\" href=\"#发布分支\">#</a> 发布分支</h2>\n<img data-src=\"../../images/java/gitflow/11.png\" alt=\"1\" style=\"zoom:80%;\" />\n<h2 id=\"生产环境出bug了怎么办\"><a class=\"markdownIt-Anchor\" href=\"#生产环境出bug了怎么办\">#</a> 生产环境出 bug 了怎么办</h2>\n<p>使用 hotfix 分支</p>\n<img data-src=\"../../images/java/gitflow/12.png\" alt=\"1\" style=\"zoom:80%;\" />\n<p>结束之后合并到 main 与 dev</p>\n<h2 id=\"gitflow的优缺点\"><a class=\"markdownIt-Anchor\" href=\"#gitflow的优缺点\">#</a> GitFlow 的优缺点</h2>\n<p>优点：分支职责清晰，结构规范，支持并行开发，发布流程可控、可追溯，对线上问题响应快，适合传统软件工程流程</p>\n<p>缺点：分支较多，流程偏重，不太适合高频发布，合并冲突概率较高</p>\n<h2 id=\"版本回退-撤销-重置\"><a class=\"markdownIt-Anchor\" href=\"#版本回退-撤销-重置\">#</a> 版本回退、撤销、重置</h2>\n<p>查看当前状态：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">git</span> status</pre></td></tr></table></figure><h3 id=\"未add的代码行发生改动怎么回退\"><a class=\"markdownIt-Anchor\" href=\"#未add的代码行发生改动怎么回退\">#</a> 未 add 的代码行发生改动怎么回退？</h3>\n<img data-src=\"../../images/java/gitflow/13.png\" alt=\"1\" style=\"zoom:80%;\" />\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">git</span> checkout -- F2</pre></td></tr></table></figure><img data-src=\"../../images/java/gitflow/14.png\" alt=\"1\" style=\"zoom:80%;\" />\n<img data-src=\"../../images/java/gitflow/15.png\" alt=\"1\" style=\"zoom:80%;\" />\n<h3 id=\"已add未commit的代码行发生改动怎么回退\"><a class=\"markdownIt-Anchor\" href=\"#已add未commit的代码行发生改动怎么回退\">#</a> 已 add 未 commit 的代码行发生改动怎么回退？</h3>\n<img data-src=\"../../images/java/gitflow/16.png\" alt=\"1\" style=\"zoom:80%;\" />\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">git</span> reset HEAD XXXX</pre></td></tr></table></figure><img data-src=\"../../images/java/gitflow/17.png\" alt=\"1\" style=\"zoom:80%;\" />\n<img data-src=\"../../images/java/gitflow/18.png\" alt=\"1\" style=\"zoom:80%;\" />\n<img data-src=\"../../images/java/gitflow/19.png\" alt=\"1\" style=\"zoom:80%;\" />\n<h3 id=\"已add已commit未push的代码行发生改动怎么回退\"><a class=\"markdownIt-Anchor\" href=\"#已add已commit未push的代码行发生改动怎么回退\">#</a> 已 add 已 commit 未 push 的代码行发生改动怎么回退？</h3>\n<p>两个异常改动</p>\n<img data-src=\"../../images/java/gitflow/20.png\" alt=\"1\" style=\"zoom:80%;\" />\n<p>两个 ^ 就是回退两步</p>\n<img data-src=\"../../images/java/gitflow/21.png\" alt=\"1\" style=\"zoom:80%;\" />\n<img data-src=\"../../images/java/gitflow/22.png\" alt=\"1\" style=\"zoom:80%;\" />\n<h3 id=\"已add已commit已push的代码行发生改动怎么回退\"><a class=\"markdownIt-Anchor\" href=\"#已add已commit已push的代码行发生改动怎么回退\">#</a> 已 add 已 commit 已 push 的代码行发生改动怎么回退？</h3>\n<img data-src=\"../../images/java/gitflow/23.png\" alt=\"1\" style=\"zoom:80%;\" />\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">git</span> revert --no-edit cxxxxx</pre></td></tr></table></figure><p>其中 cxxxx 是提交流水号。</p>\n<p>更方便地使用还原提交。</p>\n<img data-src=\"../../images/java/gitflow/24.png\" alt=\"1\" style=\"zoom:80%;\" />\n<img data-src=\"../../images/java/gitflow/25.png\" alt=\"1\" style=\"zoom:80%;\" />\n<img data-src=\"../../images/java/gitflow/26.png\" alt=\"1\" style=\"zoom:80%;\" />\n<p>revert 后是否可以再 revert？答案是可以的。</p>\n<h2 id=\"git-stash\"><a class=\"markdownIt-Anchor\" href=\"#git-stash\">#</a> git stash</h2>\n<p>git stash 是临时保存当前未提交的修改，把工作区恢复到 “干净状态”</p>\n<p>写了一半代码，还不想  <code>commit</code> ，又必须马上切分支 / 拉代码 / 修 Bug， <strong> <code>git stash</code>  就是把现场 “打包放抽屉里”</strong></p>\n<img data-src=\"../../images/java/gitflow/27.png\" alt=\"1\" style=\"zoom:80%;\" />\n<img data-src=\"../../images/java/gitflow/28.png\" alt=\"1\" style=\"zoom:80%;\" />\n<img data-src=\"../../images/java/gitflow/29.png\" alt=\"1\" style=\"zoom:80%;\" />\n<h2 id=\"git-cherry-pick\"><a class=\"markdownIt-Anchor\" href=\"#git-cherry-pick\">#</a> git cherry-pick</h2>\n<p>把 “某一个（或几个）提交” 从别的分支，复制一份，应用到当前分支</p>\n<p>关键词：<strong>只要这个提交，不要整个分支</strong></p>\n<p>或者说，提交了 100 行，有 60 还可以，40 行我有点后悔了，怎么只撤回这 40 行？</p>\n<img data-src=\"../../images/java/gitflow/30.png\" alt=\"1\" style=\"zoom:80%;\" />\n<p>先 revert，push 到远程</p>\n<img data-src=\"../../images/java/gitflow/31.png\" alt=\"1\" style=\"zoom:80%;\" />\n<p>基于现有分支，创建新分支</p>\n<img data-src=\"../../images/java/gitflow/32.png\" alt=\"1\" style=\"zoom:80%;\" />\n<p>撤销修改</p>\n<img data-src=\"../../images/java/gitflow/33.png\" alt=\"1\" style=\"zoom:80%;\" />\n<p>冻结</p>\n<img data-src=\"../../images/java/gitflow/34.png\" alt=\"1\" style=\"zoom:80%;\" />\n<img data-src=\"../../images/java/gitflow/35.png\" alt=\"1\" style=\"zoom:80%;\" />\n<img data-src=\"../../images/java/gitflow/36.png\" alt=\"1\" style=\"zoom:80%;\" />\n<h2 id=\"变基rebase和合并merge\"><a class=\"markdownIt-Anchor\" href=\"#变基rebase和合并merge\">#</a> 变基 rebase 和合并 merge</h2>\n<p>合并（ <code>git merge</code> ）是什么，就是把<strong>两个分支的历史合并</strong>到一起。</p>\n<p>变基（ <code>git rebase</code> ）是什么，把一个分支的提交 <strong>“挪到” 另一个分支的末尾</strong></p>\n<p>merge 通常是弯弯曲曲的路线，而 rebase 把对方的线路合并到你这里，但是这个合并更像是重新播放了一遍，改写了历史，使之成为了更加线性的流程。</p>\n<p>rebase 推荐在本地上使用，更加整洁，团队协作推荐使用 merge。</p>\n<h2 id=\"拉取pull和提取fetch\"><a class=\"markdownIt-Anchor\" href=\"#拉取pull和提取fetch\">#</a> 拉取 pull 和提取 fetch</h2>\n<p>提取是看看哪些变了（不修代码），拉取真正到本地（修代码）</p>\n<p>最佳实践是，先 fetch 看看那些变了，再 pull 去更新我们的代码。</p>\n",
            "tags": [
                "Java",
                "git相关",
                "java",
                "gitflow"
            ]
        },
        {
            "id": "https://735690757.github.io/python/YOLO/YOLO_V9_10_11/",
            "url": "https://735690757.github.io/python/YOLO/YOLO_V9_10_11/",
            "title": "YOLO-V9 V10 V11 V12新特性汇总",
            "date_published": "2026-01-19T04:12:12.000Z",
            "content_html": "<h1 id=\"yolo-v9-v10-v11-v12新特性汇总\"><a class=\"markdownIt-Anchor\" href=\"#yolo-v9-v10-v11-v12新特性汇总\">#</a> YOLO-V9 V10 V11 V12 新特性汇总</h1>\n<p>了解新特性，以便启发未来学习与科研。</p>\n<h2 id=\"v9\"><a class=\"markdownIt-Anchor\" href=\"#v9\">#</a> V9</h2>\n<p>学了 YOLO 的许多版本我个人认为在学术上，v3、v4、v7、v10 是非常有意义的，v5、v8、v11 工程化做的非常厉害。v9 我认为这是一个追求信息无损的理想主义者，PGI 这种高大上的概念，但如果你拆开它的代码看，它的核心实现非常依赖于辅助头，PGI 带来的那点提升，往往不如换一个更好的数据增强方案或者稍微调大一点输入分辨率来的实在，但是 v9 的 GLAN 还是很有想法的。</p>\n<h3 id=\"原文与源代码\"><a class=\"markdownIt-Anchor\" href=\"#原文与源代码\">#</a> 原文与源代码</h3>\n<p>【YOLOv9: Learning What You Want to Learn Using Programmable Gradient Information】：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9hcnhpdi5vcmcvYWJzLzI0MDIuMTM2MTY=\">https://arxiv.org/abs/2402.13616</span></p>\n<p>【WongKinYiu Yolov9】 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL1dvbmdLaW5ZaXUveW9sb3Y5L3RyZWUvbWFpbg==\">https://github.com/WongKinYiu/yolov9/tree/main</span></p>\n<h3 id=\"pgi可编程梯度信息\"><a class=\"markdownIt-Anchor\" href=\"#pgi可编程梯度信息\">#</a> PGI 可编程梯度信息</h3>\n<p>输入数据在经过每一层非线性变换时，都会丢失一部分原始信息。当网络变得非常深时，用于计算损失函数的预测信息可能已经丢失了目标的本质特征，导致梯度更新的方向不再准确。**PGI ** 就是 YOLOv9 为了解决这个问题提出的核心方案。PGI 并不是一个单一的层，而是一个由三部分组成的训练辅助系统：</p>\n<img data-src=\"../../../images/python/YOLO/v9/2.png\" alt=\"1\" style=\"zoom:80%;\" />\n<h4 id=\"主分支\"><a class=\"markdownIt-Anchor\" href=\"#主分支\">#</a> 主分支</h4>\n<p>这就是我们最终用于<strong>推理</strong>的网络。在 YOLOv9 中，主分支采用的是<strong> GELAN</strong> 架构。因为 PGI 在训练时提供了强大的梯度引导，主分支可以设计得非常精简，不需要额外的算力开销。</p>\n<h4 id=\"辅助可逆分支\"><a class=\"markdownIt-Anchor\" href=\"#辅助可逆分支\">#</a> 辅助可逆分支</h4>\n<p>这是 PGI 的精髓。为了确保网络能学到最完整的特征，YOLOv9 引入了一个<strong>可逆架构</strong>作为辅助。</p>\n<ul>\n<li><strong>原理：</strong> 可逆网络理论上可以从输出完全还原输入。</li>\n<li><strong>作用：</strong> 它是为了给主分支提供保真的梯度。它强制网络在深层依然保留输入数据的完整信息，防止特征在传递过程中被洗掉。</li>\n</ul>\n<h4 id=\"多级辅助信息\"><a class=\"markdownIt-Anchor\" href=\"#多级辅助信息\">#</a> 多级辅助信息</h4>\n<p>v9 在训练时实际上有 6 个输出，通过多个检测头来缓解深度网络中的梯度消失或信息瓶颈。</p>\n<h3 id=\"gelan通用高效层聚合网络\"><a class=\"markdownIt-Anchor\" href=\"#gelan通用高效层聚合网络\">#</a> GELAN 通用高效层聚合网络</h3>\n<p>为什么需要 GELAN？很多模型堆叠了大量的层，但实际对结果贡献的有效权重并不多，复杂的跨层连接虽然能提升精度，但往往会拖慢预测速度。GELAN 结合了 CSPNet 的梯度路径优化能力和 ELAN 的结构优势。</p>\n<p>ELAN：</p>\n<img data-src=\"../../../images/python/YOLO/v7/1.png\" alt=\"1\" style=\"zoom:40%;\" />\n<p>ELAN 的缺点是它的设计比较刚性，ELAN 依赖于特定的卷积层堆叠方式，通常是固定的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>3</mn><mo>×</mo><mn>3</mn></mrow><annotation encoding=\"application/x-tex\">3 \\times 3</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">3</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">3</span></span></span></span> 卷积，如果你想把其中的模块换成 Transformer Block 或其他更先进的计算单元，ELAN 的原始设计很难兼容，或者兼容后效果不佳。</p>\n<p>CSP：</p>\n<img data-src=\"../../../images/python/YOLO/v4/16.png\" alt=\"1\" style=\"zoom:40%;\" />\n<p>CSPNet 的核心是将特征图拆分为两部分，一部分经过计算块如 Bottleneck，另一部分直接跨层连接。这种 “二分法” 虽然减少了重复梯度信息，但它的结构相对<strong>固定</strong>。在处理极其深层的网络时，这种简单的拆分合并依然会带来一定的<strong>计算冗余</strong>，且对特征的融合不够细腻。</p>\n<img data-src=\"../../../images/python/YOLO/v9/1.png\" alt=\"1\" style=\"zoom:80%;\" />\n<p>GELAN 有极高的参数效率，这是 GELAN 最直观的优势。在达到相同检测精度的情况下，GELAN 表现出了惊人的瘦身能力。<strong>总体框架类似于把 C3 嵌入 C2f，只是组成的基本模块不同而已。</strong></p>\n<h2 id=\"v10\"><a class=\"markdownIt-Anchor\" href=\"#v10\">#</a> V10</h2>\n<h3 id=\"原文与源代码-2\"><a class=\"markdownIt-Anchor\" href=\"#原文与源代码-2\">#</a> 原文与源代码</h3>\n<p>【YOLOv10: Real-Time End-to-End Object Detection】：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9hcnhpdi5vcmcvYWJzLzI0MDUuMTQ0NTg=\">https://arxiv.org/abs/2405.14458</span></p>\n<p>【THU-MIG yolov10】：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL1RIVS1NSUcveW9sb3YxMA==\">https://github.com/THU-MIG/yolov10</span></p>\n<p>如果说 YOLOv9 是在研究如何让网络学得更好，那么 YOLOv10 的核心逻辑就是如何让部署变得更快。 <strong>NMS-Free 无后处理抑制</strong>给予我们回答。</p>\n<h3 id=\"双重分配策略消除nms\"><a class=\"markdownIt-Anchor\" href=\"#双重分配策略消除nms\">#</a> 双重分配策略消除 NMS</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">v10Detect</span><span class=\"token punctuation\">(</span>Detect<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    end2end <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> nc<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span> <span class=\"token operator\">=</span> <span class=\"token number\">80</span><span class=\"token punctuation\">,</span> ch<span class=\"token punctuation\">:</span> <span class=\"token builtin\">tuple</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span>nc<span class=\"token punctuation\">,</span> end2end<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> ch<span class=\"token operator\">=</span>ch<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        c3 <span class=\"token operator\">=</span> <span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span>ch<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>nc<span class=\"token punctuation\">,</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># channels</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token comment\"># Light cls head</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv3 <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>ModuleList<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>Sequential<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                nn<span class=\"token punctuation\">.</span>Sequential<span class=\"token punctuation\">(</span>Conv<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> g<span class=\"token operator\">=</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> c3<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                nn<span class=\"token punctuation\">.</span>Sequential<span class=\"token punctuation\">(</span>Conv<span class=\"token punctuation\">(</span>c3<span class=\"token punctuation\">,</span> c3<span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> g<span class=\"token operator\">=</span>c3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">(</span>c3<span class=\"token punctuation\">,</span> c3<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">(</span>c3<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>nc<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token keyword\">for</span> x <span class=\"token keyword\">in</span> ch</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        self<span class=\"token punctuation\">.</span>one2one_cv3 <span class=\"token operator\">=</span> copy<span class=\"token punctuation\">.</span>deepcopy<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>cv3<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">fuse</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"Remove the one2many head for inference optimization.\"\"\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv2 <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>cv3 <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span></pre></td></tr></table></figure><p>想象一下你在拍合照，你哥们儿正好站在你身后，露出了半张脸。</p>\n<p>NMS 的它看到两个框重叠度太高，就觉得这肯定是同一个人多画了一个框，直接把后面那个人的框给<strong>删了</strong>。在火车站排队、超市货架这种人挤人、货挤货的地方，NMS 经常把明明存在的两个物体，“抹杀” 得只剩一个。NMS 还有一个缺点，NMS 的逻辑是模型算完了，要把成千上万个候选框传给 CPU，让 CPU 慢慢排个序，再一个个比对重叠度，AI 算图像只要 5 毫秒，结果 NMS 后处理可能要花 10 毫秒。这就像是你网购东西，快递半天就到市中心了，结果最后一公里派送花了两天。</p>\n<p>YOLOv10 搞双重分配就是为了把这个保安给开除掉，YOLOv10 觉得，既然 NMS 太慢太烦，那能不能只出一个框？但如果一开始就只准出一个框，梯度不够，很难收敛太容易学懵了。</p>\n<img data-src=\"../../../images/python/YOLO/v9/3.png\" alt=\"1\" style=\"zoom:80%;\" />\n<p>YOLOv10 想了个绝招：<strong>弄两个分身一起练。</strong></p>\n<p>在训练时，模型分裂成两个 “分身”：</p>\n<ol>\n<li>分身 A 一对多：还是老样子，一个目标允许套多个框。它的任务是<strong>感受目标长啥样</strong>，负责给整个模型提供丰富的学习经验。</li>\n<li>分身 B 一对一：强制要求，一个目标只能出一个框。它盯着分身 A 学，任务是<strong>学会精准克制</strong>。</li>\n</ol>\n<p>这两个分身共享同一个特征提取器，就是那个什么骨干啊，什么特征金字塔啊</p>\n<ul>\n<li><strong>分身 A</strong> 像是个经验丰富的老师</li>\n<li><strong>分身 B</strong> 就在旁边坐享其成，利用 A 练出来的特征，只练习最后那一招一剑封喉</li>\n</ul>\n<p>重点来了！等模型练成了，要上战场推理部署的时候，这小子不讲武德，直接把分身 A 给开除了，只留下分身 B 极简模式去工作。因为分身 B 已经练就了 “一个萝卜一个坑” 的本领，它输出的结果里，每个目标就真的只有一张框，NMS 直接原地失业。</p>\n<p>总结一下，双重分配策略就是训练时用多框带路保精度，推理时用单框干活保速度。</p>\n<h3 id=\"特色模块1-scdown\"><a class=\"markdownIt-Anchor\" href=\"#特色模块1-scdown\">#</a> 特色模块 1-SCDown</h3>\n<p>SCDown 让模型在把图片变小的过程中，<strong>花的力气更少，记下的东西更多</strong>。</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">SCDown</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> c1<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> k<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv1 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span>c1<span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv2 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span>c2<span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">,</span> k<span class=\"token operator\">=</span>k<span class=\"token punctuation\">,</span> s<span class=\"token operator\">=</span>s<span class=\"token punctuation\">,</span> g<span class=\"token operator\">=</span>c2<span class=\"token punctuation\">,</span> act<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">:</span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>cv2<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>cv1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><img data-src=\"../../../images/python/YOLO/v9/4.png\" alt=\"1\" style=\"zoom:100%;\" />\n<p>其中黄色 CB 是分组卷积。</p>\n<h3 id=\"特色模块2-cib\"><a class=\"markdownIt-Anchor\" href=\"#特色模块2-cib\">#</a> 特色模块 2-CIB</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">CIB</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> c1<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> shortcut<span class=\"token punctuation\">:</span> <span class=\"token builtin\">bool</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">:</span> <span class=\"token builtin\">float</span> <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> lk<span class=\"token punctuation\">:</span> <span class=\"token builtin\">bool</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        c_ <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>c2 <span class=\"token operator\">*</span> e<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># hidden channels</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv1 <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Sequential<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            Conv<span class=\"token punctuation\">(</span>c1<span class=\"token punctuation\">,</span> c1<span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> g<span class=\"token operator\">=</span>c1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            Conv<span class=\"token punctuation\">(</span>c1<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> c_<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            RepVGGDW<span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> c_<span class=\"token punctuation\">)</span> <span class=\"token keyword\">if</span> lk <span class=\"token keyword\">else</span> Conv<span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> c_<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> c_<span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> g<span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> c_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            Conv<span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> c_<span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            Conv<span class=\"token punctuation\">(</span>c2<span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> g<span class=\"token operator\">=</span>c2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        self<span class=\"token punctuation\">.</span>add <span class=\"token operator\">=</span> shortcut <span class=\"token keyword\">and</span> c1 <span class=\"token operator\">==</span> c2</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">:</span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">return</span> x <span class=\"token operator\">+</span> self<span class=\"token punctuation\">.</span>cv1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> <span class=\"token keyword\">if</span> self<span class=\"token punctuation\">.</span>add <span class=\"token keyword\">else</span> self<span class=\"token punctuation\">.</span>cv1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><img data-src=\"../../../images/python/YOLO/v9/5.png\" alt=\"1\" style=\"zoom:100%;\" />\n<h3 id=\"特色模块3-repvggdw\"><a class=\"markdownIt-Anchor\" href=\"#特色模块3-repvggdw\">#</a> 特色模块 3-RepVGGDW</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">RepVGGDW</span><span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\"RepVGGDW is a class that represents a depth-wise convolutional block in RepVGG architecture.\"\"\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> ed<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        self<span class=\"token punctuation\">.</span>conv <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span>ed<span class=\"token punctuation\">,</span> ed<span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> g<span class=\"token operator\">=</span>ed<span class=\"token punctuation\">,</span> act<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        self<span class=\"token punctuation\">.</span>conv1 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span>ed<span class=\"token punctuation\">,</span> ed<span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> g<span class=\"token operator\">=</span>ed<span class=\"token punctuation\">,</span> act<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        self<span class=\"token punctuation\">.</span>dim <span class=\"token operator\">=</span> ed</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        self<span class=\"token punctuation\">.</span>act <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>SiLU<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">:</span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>act<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>conv<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> self<span class=\"token punctuation\">.</span>conv1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward_fuse</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">:</span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>act<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>conv<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token decorator annotation punctuation\">@torch<span class=\"token punctuation\">.</span>no_grad</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">fuse</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> <span class=\"token builtin\">hasattr</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> <span class=\"token string\">\"conv1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token keyword\">return</span>  <span class=\"token comment\"># already fused</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        conv <span class=\"token operator\">=</span> fuse_conv_and_bn<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>conv<span class=\"token punctuation\">.</span>conv<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>conv<span class=\"token punctuation\">.</span>bn<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        conv1 <span class=\"token operator\">=</span> fuse_conv_and_bn<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>conv1<span class=\"token punctuation\">.</span>conv<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>conv1<span class=\"token punctuation\">.</span>bn<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        conv_w <span class=\"token operator\">=</span> conv<span class=\"token punctuation\">.</span>weight</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        conv_b <span class=\"token operator\">=</span> conv<span class=\"token punctuation\">.</span>bias</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        conv1_w <span class=\"token operator\">=</span> conv1<span class=\"token punctuation\">.</span>weight</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        conv1_b <span class=\"token operator\">=</span> conv1<span class=\"token punctuation\">.</span>bias</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        conv1_w <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>nn<span class=\"token punctuation\">.</span>functional<span class=\"token punctuation\">.</span>pad<span class=\"token punctuation\">(</span>conv1_w<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        final_conv_w <span class=\"token operator\">=</span> conv_w <span class=\"token operator\">+</span> conv1_w</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        final_conv_b <span class=\"token operator\">=</span> conv_b <span class=\"token operator\">+</span> conv1_b</pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        conv<span class=\"token punctuation\">.</span>weight<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>copy_<span class=\"token punctuation\">(</span>final_conv_w<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        conv<span class=\"token punctuation\">.</span>bias<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>copy_<span class=\"token punctuation\">(</span>final_conv_b<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        self<span class=\"token punctuation\">.</span>conv <span class=\"token operator\">=</span> conv</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token keyword\">del</span> self<span class=\"token punctuation\">.</span>conv1</pre></td></tr></table></figure><img data-src=\"../../../images/python/YOLO/v9/6.png\" alt=\"1\" style=\"zoom:100%;\" />\n<h3 id=\"特色模块4-c2fcib\"><a class=\"markdownIt-Anchor\" href=\"#特色模块4-c2fcib\">#</a> 特色模块 4-C2FCIB</h3>\n<p>这个解耦方式值得我们学习，继承后泛化出多种 C2F 版本：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">C2f</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\"Faster Implementation of CSP Bottleneck with 2 convolutions.\"\"\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> c1<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> n<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> shortcut<span class=\"token punctuation\">:</span> <span class=\"token builtin\">bool</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> g<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">:</span> <span class=\"token builtin\">float</span> <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token builtin\">float</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Expansion ratio<span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        self<span class=\"token punctuation\">.</span>c <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>c2 <span class=\"token operator\">*</span> e<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># hidden channels</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv1 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span>c1<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv2 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">+</span> n<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># optional act=FReLU(c2)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        self<span class=\"token punctuation\">.</span>m <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>ModuleList<span class=\"token punctuation\">(</span>Bottleneck<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> shortcut<span class=\"token punctuation\">,</span> g<span class=\"token punctuation\">,</span> k<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> e<span class=\"token operator\">=</span><span class=\"token number\">1.0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">:</span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        y <span class=\"token operator\">=</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>cv1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>chunk<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        y<span class=\"token punctuation\">.</span>extend<span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> m <span class=\"token keyword\">in</span> self<span class=\"token punctuation\">.</span>m<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>cv2<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward_split</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">:</span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        y <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>cv1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        y <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>y<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        y<span class=\"token punctuation\">.</span>extend<span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> m <span class=\"token keyword\">in</span> self<span class=\"token punctuation\">.</span>m<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>cv2<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>这个挺牛的，直接取替换 m 了：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">C2fCIB</span><span class=\"token punctuation\">(</span>C2f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        self<span class=\"token punctuation\">,</span> c1<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> n<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> shortcut<span class=\"token punctuation\">:</span> <span class=\"token builtin\">bool</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> lk<span class=\"token punctuation\">:</span> <span class=\"token builtin\">bool</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> g<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">:</span> <span class=\"token builtin\">float</span> <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span>c1<span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">,</span> n<span class=\"token punctuation\">,</span> shortcut<span class=\"token punctuation\">,</span> g<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        self<span class=\"token punctuation\">.</span>m <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>ModuleList<span class=\"token punctuation\">(</span>CIB<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> shortcut<span class=\"token punctuation\">,</span> e<span class=\"token operator\">=</span><span class=\"token number\">1.0</span><span class=\"token punctuation\">,</span> lk<span class=\"token operator\">=</span>lk<span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><img data-src=\"../../../images/python/YOLO/v9/7.png\" alt=\"1\" style=\"zoom:100%;\" />\n<p>这里想是什么模块就是什么模块。</p>\n<h3 id=\"特色模块5-psa\"><a class=\"markdownIt-Anchor\" href=\"#特色模块5-psa\">#</a> 特色模块 5-PSA</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">PSA</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> c1<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">:</span> <span class=\"token builtin\">float</span> <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">assert</span> c1 <span class=\"token operator\">==</span> c2</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        self<span class=\"token punctuation\">.</span>c <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>c1 <span class=\"token operator\">*</span> e<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv1 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span>c1<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv2 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> c1<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        self<span class=\"token punctuation\">.</span>attn <span class=\"token operator\">=</span> Attention<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> attn_ratio<span class=\"token operator\">=</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> num_heads<span class=\"token operator\">=</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>c <span class=\"token operator\">//</span> <span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        self<span class=\"token punctuation\">.</span>ffn <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Sequential<span class=\"token punctuation\">(</span>Conv<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>c <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>c <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> act<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">:</span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        a<span class=\"token punctuation\">,</span> b <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>cv1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> dim<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        b <span class=\"token operator\">=</span> b <span class=\"token operator\">+</span> self<span class=\"token punctuation\">.</span>attn<span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        b <span class=\"token operator\">=</span> b <span class=\"token operator\">+</span> self<span class=\"token punctuation\">.</span>ffn<span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>cv2<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><img data-src=\"../../../images/python/YOLO/v9/8.png\" alt=\"1\" style=\"zoom:100%;\" />\n<h3 id=\"attention\"><a class=\"markdownIt-Anchor\" href=\"#attention\">#</a> Attention</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">Attention</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> dim<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> num_heads<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span> <span class=\"token operator\">=</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span> attn_ratio<span class=\"token punctuation\">:</span> <span class=\"token builtin\">float</span> <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        self<span class=\"token punctuation\">.</span>num_heads <span class=\"token operator\">=</span> num_heads</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        self<span class=\"token punctuation\">.</span>head_dim <span class=\"token operator\">=</span> dim <span class=\"token operator\">//</span> num_heads</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        self<span class=\"token punctuation\">.</span>key_dim <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>head_dim <span class=\"token operator\">*</span> attn_ratio<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        self<span class=\"token punctuation\">.</span>scale <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>key_dim<span class=\"token operator\">**</span><span class=\"token operator\">-</span><span class=\"token number\">0.5</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        nh_kd <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>key_dim <span class=\"token operator\">*</span> num_heads</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        h <span class=\"token operator\">=</span> dim <span class=\"token operator\">+</span> nh_kd <span class=\"token operator\">*</span> <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        self<span class=\"token punctuation\">.</span>qkv <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span>dim<span class=\"token punctuation\">,</span> h<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> act<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        self<span class=\"token punctuation\">.</span>proj <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span>dim<span class=\"token punctuation\">,</span> dim<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> act<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        self<span class=\"token punctuation\">.</span>pe <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span>dim<span class=\"token punctuation\">,</span> dim<span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> g<span class=\"token operator\">=</span>dim<span class=\"token punctuation\">,</span> act<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">:</span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        B<span class=\"token punctuation\">,</span> C<span class=\"token punctuation\">,</span> H<span class=\"token punctuation\">,</span> W <span class=\"token operator\">=</span> x<span class=\"token punctuation\">.</span>shape</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        N <span class=\"token operator\">=</span> H <span class=\"token operator\">*</span> W</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        qkv <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>qkv<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        q<span class=\"token punctuation\">,</span> k<span class=\"token punctuation\">,</span> v <span class=\"token operator\">=</span> qkv<span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">(</span>B<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>num_heads<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>key_dim <span class=\"token operator\">*</span> <span class=\"token number\">2</span> <span class=\"token operator\">+</span> self<span class=\"token punctuation\">.</span>head_dim<span class=\"token punctuation\">,</span> N<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token punctuation\">[</span>self<span class=\"token punctuation\">.</span>key_dim<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>key_dim<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>head_dim<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> dim<span class=\"token operator\">=</span><span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        attn <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>q<span class=\"token punctuation\">.</span>transpose<span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> @ k<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>scale</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        attn <span class=\"token operator\">=</span> attn<span class=\"token punctuation\">.</span>softmax<span class=\"token punctuation\">(</span>dim<span class=\"token operator\">=</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        x <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>v @ attn<span class=\"token punctuation\">.</span>transpose<span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">(</span>B<span class=\"token punctuation\">,</span> C<span class=\"token punctuation\">,</span> H<span class=\"token punctuation\">,</span> W<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> self<span class=\"token punctuation\">.</span>pe<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">.</span>reshape<span class=\"token punctuation\">(</span>B<span class=\"token punctuation\">,</span> C<span class=\"token punctuation\">,</span> H<span class=\"token punctuation\">,</span> W<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        x <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>proj<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token keyword\">return</span> x</pre></td></tr></table></figure><p>Self-Attention 其实并不陌生，但是这是我第一次见他在图像中的实现，我们好好看看。</p>\n<p>首先 x 经过一个 CB：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>self<span class=\"token punctuation\">.</span>qkv <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span>dim<span class=\"token punctuation\">,</span> h<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> act<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>第二步：重塑</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>q<span class=\"token punctuation\">,</span> k<span class=\"token punctuation\">,</span> v <span class=\"token operator\">=</span> qkv<span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">(</span>B<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>num_heads<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>key_dim <span class=\"token operator\">*</span> <span class=\"token number\">2</span> <span class=\"token operator\">+</span> self<span class=\"token punctuation\">.</span>head_dim<span class=\"token punctuation\">,</span> N<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token punctuation\">[</span>self<span class=\"token punctuation\">.</span>key_dim<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>key_dim<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>head_dim<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> dim<span class=\"token operator\">=</span><span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>在执行这行代码之前， <code>qkv</code>  是一个巨大的张量。你可以把它想象成一根<strong>超级长的香肠</strong>，里面塞满了所有头的 Query、Key、Value 信息，全混在一起。</p>\n<p>第一步： <code>.view(...)</code>  —— 把香肠切段并排好，<strong>B</strong>: 批次，<strong>self.num_heads</strong>: 有几个头，比如 8 个头，就像 8 个人同时看图，<strong>self.key_dim * 2 + self.head_dim</strong>: 这是<strong>最关键的一层</strong>。它把 Q, K, V 垂直叠在了一起。</p>\n<img data-src=\"../../../images/python/YOLO/v9/9.png\" alt=\"1\" style=\"zoom:100%;\" />\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>attn <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>q<span class=\"token punctuation\">.</span>transpose<span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> @ k<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>scale</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>attn <span class=\"token operator\">=</span> attn<span class=\"token punctuation\">.</span>softmax<span class=\"token punctuation\">(</span>dim<span class=\"token operator\">=</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>x <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>v @ attn<span class=\"token punctuation\">.</span>transpose<span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">(</span>B<span class=\"token punctuation\">,</span> C<span class=\"token punctuation\">,</span> H<span class=\"token punctuation\">,</span> W<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> self<span class=\"token punctuation\">.</span>pe<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">.</span>reshape<span class=\"token punctuation\">(</span>B<span class=\"token punctuation\">,</span> C<span class=\"token punctuation\">,</span> H<span class=\"token punctuation\">,</span> W<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>x <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>proj<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">return</span> x</pre></td></tr></table></figure><p>原版 Transformer 里，公式确实是 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>Q</mi><mo>×</mo><msup><mi>K</mi><mi>T</mi></msup></mrow><annotation encoding=\"application/x-tex\">Q \\times K^T</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8777699999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">Q</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8413309999999999em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8413309999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.13889em;\">T</span></span></span></span></span></span></span></span></span></span></span>。</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mtext>Attention</mtext><mo stretchy=\"false\">(</mo><mi>Q</mi><mo separator=\"true\">,</mo><mi>K</mi><mo separator=\"true\">,</mo><mi>V</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mtext>softmax</mtext><mrow><mo fence=\"true\">(</mo><mfrac><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac><mo fence=\"true\">)</mo></mrow><mi>V</mi></mrow><annotation encoding=\"application/x-tex\">\\text{Attention}(Q, K, V) = \\text{softmax}\\left(\\frac{QK^T}{\\sqrt{d_k}}\\right)V\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord text\"><span class=\"mord\">Attention</span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">Q</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">V</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.468361em;vertical-align:-0.95003em;\"></span><span class=\"mord text\"><span class=\"mord\">softmax</span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">(</span></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.5183309999999999em;\"><span style=\"top:-2.25278em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord sqrt\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.85722em;\"><span class=\"svg-align\" style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\" style=\"padding-left:0.833em;\"><span class=\"mord\"><span class=\"mord mathnormal\">d</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span style=\"top:-2.81722em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"hide-tail\" style=\"min-width:0.853em;height:1.08em;\"><svg width='400em' height='1.08em' viewBox='0 0 400000 1080' preserveAspectRatio='xMinYMin slice'><path d='M95,702\nc-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14\nc0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54\nc44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10\ns173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429\nc69,-144,104.5,-217.7,106.5,-221\nl0 -0\nc5.3,-9.3,12,-14,20,-14\nH400000v40H845.2724\ns-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7\nc-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z\nM834 80h400000v40h-400000z'/></svg></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.18278000000000005em;\"><span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">Q</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8413309999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.13889em;\">T</span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.93em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">)</span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">V</span></span></span></span></span></p>\n<p>YOLOv10 轻量化注意力代码中，它是把 Q 给转置了，</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mtext>Output</mtext><mo>=</mo><mtext>Proj</mtext><mrow><mo fence=\"true\">(</mo><mi>V</mi><mo>⋅</mo><mtext>Softmax</mtext><msup><mrow><mo fence=\"true\">(</mo><mfrac><mrow><msup><mi>Q</mi><mi>T</mi></msup><mi>K</mi></mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac><mo fence=\"true\">)</mo></mrow><mi>T</mi></msup><mo>+</mo><mtext>PE</mtext><mo stretchy=\"false\">(</mo><mi>V</mi><mo stretchy=\"false\">)</mo><mo fence=\"true\">)</mo></mrow></mrow><annotation encoding=\"application/x-tex\">\\text{Output} = \\text{Proj} \\left( V \\cdot \\text{Softmax}\\left( \\frac{Q^T K}{\\sqrt{d_k}} \\right)^T + \\text{PE}(V) \\right)\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8777699999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord text\"><span class=\"mord\">Output</span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:3.0000299999999998em;vertical-align:-1.25003em;\"></span><span class=\"mord text\"><span class=\"mord\">Proj</span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size4\">(</span></span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">V</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord text\"><span class=\"mord\">Softmax</span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\"><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">(</span></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.5183309999999999em;\"><span style=\"top:-2.25278em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord sqrt\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.85722em;\"><span class=\"svg-align\" style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\" style=\"padding-left:0.833em;\"><span class=\"mord\"><span class=\"mord mathnormal\">d</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span style=\"top:-2.81722em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"hide-tail\" style=\"min-width:0.853em;height:1.08em;\"><svg width='400em' height='1.08em' viewBox='0 0 400000 1080' preserveAspectRatio='xMinYMin slice'><path d='M95,702\nc-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14\nc0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54\nc44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10\ns173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429\nc69,-144,104.5,-217.7,106.5,-221\nl0 -0\nc5.3,-9.3,12,-14,20,-14\nH400000v40H845.2724\ns-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7\nc-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z\nM834 80h400000v40h-400000z'/></svg></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.18278000000000005em;\"><span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\">Q</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8413309999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.13889em;\">T</span></span></span></span></span></span></span></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.93em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">)</span></span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.749562em;\"><span style=\"top:-3.9712310000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.13889em;\">T</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord text\"><span class=\"mord\">PE</span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">V</span><span class=\"mclose\">)</span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size4\">)</span></span></span></span></span></span></span></p>\n<p>原版 Transformer 是为 <strong>NLP</strong> 设计的，句子通常只有几十个词。但 <strong>CV</strong> 里的图片像素点<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>N</mi><mo>=</mo><mi>H</mi><mo>×</mo><mi>W</mi></mrow><annotation encoding=\"application/x-tex\">N = H \\times W</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.76666em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.08125em;\">H</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span></span></span></span> 非常多。</p>\n<h2 id=\"v11\"><a class=\"markdownIt-Anchor\" href=\"#v11\">#</a> V11</h2>\n<h3 id=\"c3k2\"><a class=\"markdownIt-Anchor\" href=\"#c3k2\">#</a> C3k2</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">C3k2</span><span class=\"token punctuation\">(</span>C2f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\"Faster Implementation of CSP Bottleneck with 2 convolutions.\"\"\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        self<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        c1<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        c2<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        n<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        c3k<span class=\"token punctuation\">:</span> <span class=\"token builtin\">bool</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        e<span class=\"token punctuation\">:</span> <span class=\"token builtin\">float</span> <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        attn<span class=\"token punctuation\">:</span> <span class=\"token builtin\">bool</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        g<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        shortcut<span class=\"token punctuation\">:</span> <span class=\"token builtin\">bool</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span>c1<span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">,</span> n<span class=\"token punctuation\">,</span> shortcut<span class=\"token punctuation\">,</span> g<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        self<span class=\"token punctuation\">.</span>m <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>ModuleList<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>Sequential<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                Bottleneck<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> shortcut<span class=\"token punctuation\">,</span> g<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                PSABlock<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> attn_ratio<span class=\"token operator\">=</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> num_heads<span class=\"token operator\">=</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>c <span class=\"token operator\">//</span> <span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token keyword\">if</span> attn</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token keyword\">else</span> C3k<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> shortcut<span class=\"token punctuation\">,</span> g<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token keyword\">if</span> c3k</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token keyword\">else</span> Bottleneck<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> shortcut<span class=\"token punctuation\">,</span> g<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token punctuation\">)</span></pre></td></tr></table></figure><figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">C2f</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\"Faster Implementation of CSP Bottleneck with 2 convolutions.\"\"\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> c1<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> n<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> shortcut<span class=\"token punctuation\">:</span> <span class=\"token builtin\">bool</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> g<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">:</span> <span class=\"token builtin\">float</span> <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        self<span class=\"token punctuation\">.</span>c <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>c2 <span class=\"token operator\">*</span> e<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># hidden channels</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv1 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span>c1<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv2 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">+</span> n<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># optional act=FReLU(c2)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        self<span class=\"token punctuation\">.</span>m <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>ModuleList<span class=\"token punctuation\">(</span>Bottleneck<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> shortcut<span class=\"token punctuation\">,</span> g<span class=\"token punctuation\">,</span> k<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> e<span class=\"token operator\">=</span><span class=\"token number\">1.0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">:</span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"Forward pass through C2f layer.\"\"\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        y <span class=\"token operator\">=</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>cv1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>chunk<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        y<span class=\"token punctuation\">.</span>extend<span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> m <span class=\"token keyword\">in</span> self<span class=\"token punctuation\">.</span>m<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>cv2<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward_split</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">:</span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"Forward pass using split() instead of chunk().\"\"\"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        y <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>cv1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        y <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>y<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        y<span class=\"token punctuation\">.</span>extend<span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> m <span class=\"token keyword\">in</span> self<span class=\"token punctuation\">.</span>m<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>cv2<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><img data-src=\"../../../images/python/YOLO/v9/10.png\" alt=\"1\" style=\"zoom:100%;\" />\n<p>想必各位看到这里了，已经无需我再做解释了，又是继承又是排列组合。</p>\n<h3 id=\"c2psa\"><a class=\"markdownIt-Anchor\" href=\"#c2psa\">#</a> C2PSA</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">C2PSA</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> c1<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> n<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">:</span> <span class=\"token builtin\">float</span> <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">assert</span> c1 <span class=\"token operator\">==</span> c2</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        self<span class=\"token punctuation\">.</span>c <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>c1 <span class=\"token operator\">*</span> e<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv1 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span>c1<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv2 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> c1<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        self<span class=\"token punctuation\">.</span>m <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Sequential<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>PSABlock<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> attn_ratio<span class=\"token operator\">=</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> num_heads<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>c <span class=\"token operator\">//</span> <span class=\"token number\">64</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">:</span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        a<span class=\"token punctuation\">,</span> b <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>cv1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> dim<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        b <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>m<span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>cv2<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><img data-src=\"../../../images/python/YOLO/v9/11.png\" alt=\"1\" style=\"zoom:100%;\" />\n<p>依然是排列组合。</p>\n<h2 id=\"v12\"><a class=\"markdownIt-Anchor\" href=\"#v12\">#</a> V12</h2>\n<p>V12 开始进入注意力时代了。</p>\n<h3 id=\"原文与源代码-3\"><a class=\"markdownIt-Anchor\" href=\"#原文与源代码-3\">#</a> 原文与源代码</h3>\n<p>【YOLOv12: Attention-Centric Real-Time Object Detectors】：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9hcnhpdi5vcmcvYWJzLzI1MDIuMTI1MjQ=\">https://arxiv.org/abs/2502.12524</span></p>\n<p>【YOLOv12】：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3N1bnNtYXJ0ZXJqaWUveW9sb3YxMg==\">https://github.com/sunsmarterjie/yolov12</span></p>\n<img data-src=\"../../../images/python/YOLO/v9/13.png\" alt=\"1\" style=\"zoom:100%;\" />\n<h3 id=\"ablock\"><a class=\"markdownIt-Anchor\" href=\"#ablock\">#</a> ABlock</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">ABlock</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        self<span class=\"token punctuation\">.</span>attn <span class=\"token operator\">=</span> AAttn<span class=\"token punctuation\">(</span>dim<span class=\"token punctuation\">,</span> num_heads<span class=\"token operator\">=</span>num_heads<span class=\"token punctuation\">,</span> area<span class=\"token operator\">=</span>area<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        mlp_hidden_dim <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>dim <span class=\"token operator\">*</span> mlp_ratio<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        self<span class=\"token punctuation\">.</span>mlp <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Sequential<span class=\"token punctuation\">(</span>Conv<span class=\"token punctuation\">(</span>dim<span class=\"token punctuation\">,</span> mlp_hidden_dim<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">(</span>mlp_hidden_dim<span class=\"token punctuation\">,</span> dim<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> act<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        self<span class=\"token punctuation\">.</span><span class=\"token builtin\">apply</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>_init_weights<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token decorator annotation punctuation\">@staticmethod</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">_init_weights</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">:</span> nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">,</span> nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>init<span class=\"token punctuation\">.</span>trunc_normal_<span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">.</span>weight<span class=\"token punctuation\">,</span> std<span class=\"token operator\">=</span><span class=\"token number\">0.02</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token keyword\">if</span> m<span class=\"token punctuation\">.</span>bias <span class=\"token keyword\">is</span> <span class=\"token keyword\">not</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                nn<span class=\"token punctuation\">.</span>init<span class=\"token punctuation\">.</span>constant_<span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">.</span>bias<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">:</span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        x <span class=\"token operator\">=</span> x <span class=\"token operator\">+</span> self<span class=\"token punctuation\">.</span>attn<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">return</span> x <span class=\"token operator\">+</span> self<span class=\"token punctuation\">.</span>mlp<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h3 id=\"a2c2f\"><a class=\"markdownIt-Anchor\" href=\"#a2c2f\">#</a> A2C2f</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">A2C2f</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        self<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        c1<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        c2<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        n<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        a2<span class=\"token punctuation\">:</span> <span class=\"token builtin\">bool</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        area<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        residual<span class=\"token punctuation\">:</span> <span class=\"token builtin\">bool</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        mlp_ratio<span class=\"token punctuation\">:</span> <span class=\"token builtin\">float</span> <span class=\"token operator\">=</span> <span class=\"token number\">2.0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        e<span class=\"token punctuation\">:</span> <span class=\"token builtin\">float</span> <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        g<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        shortcut<span class=\"token punctuation\">:</span> <span class=\"token builtin\">bool</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        c_ <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>c2 <span class=\"token operator\">*</span> e<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># hidden channels</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">assert</span> c_ <span class=\"token operator\">%</span> <span class=\"token number\">32</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Dimension of ABlock must be a multiple of 32.\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv1 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span>c1<span class=\"token punctuation\">,</span> c_<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv2 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">+</span> n<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> c_<span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        self<span class=\"token punctuation\">.</span>gamma <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Parameter<span class=\"token punctuation\">(</span><span class=\"token number\">0.01</span> <span class=\"token operator\">*</span> torch<span class=\"token punctuation\">.</span>ones<span class=\"token punctuation\">(</span>c2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> requires_grad<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">if</span> a2 <span class=\"token keyword\">and</span> residual <span class=\"token keyword\">else</span> <span class=\"token boolean\">None</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        self<span class=\"token punctuation\">.</span>m <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>ModuleList<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            nn<span class=\"token punctuation\">.</span>Sequential<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>ABlock<span class=\"token punctuation\">(</span>c_<span class=\"token punctuation\">,</span> c_ <span class=\"token operator\">//</span> <span class=\"token number\">32</span><span class=\"token punctuation\">,</span> mlp_ratio<span class=\"token punctuation\">,</span> area<span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            <span class=\"token keyword\">if</span> a2</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token keyword\">else</span> C3k<span class=\"token punctuation\">(</span>c_<span class=\"token punctuation\">,</span> c_<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> shortcut<span class=\"token punctuation\">,</span> g<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">:</span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        y <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>self<span class=\"token punctuation\">.</span>cv1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        y<span class=\"token punctuation\">.</span>extend<span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> m <span class=\"token keyword\">in</span> self<span class=\"token punctuation\">.</span>m<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        y <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>cv2<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token keyword\">if</span> self<span class=\"token punctuation\">.</span>gamma <span class=\"token keyword\">is</span> <span class=\"token keyword\">not</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            <span class=\"token keyword\">return</span> x <span class=\"token operator\">+</span> self<span class=\"token punctuation\">.</span>gamma<span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>gamma<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> y</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token keyword\">return</span> y</pre></td></tr></table></figure><img data-src=\"../../../images/python/YOLO/v9/12.png\" alt=\"1\" style=\"zoom:100%;\" />\n<h2 id=\"参考\"><a class=\"markdownIt-Anchor\" href=\"#参考\">#</a> 参考</h2>\n<ol>\n<li>【YOLOv9 详细解读，改进提升全面分析】：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MDI5OTk4L2FydGljbGUvZGV0YWlscy8xMzYzMjQ1ODk=\">https://blog.csdn.net/qq_44029998/article/details/136324589</span></li>\n<li>【YOLOv9 全网首发，原理讲解 + 应用实战，与 YOLOv8 相比升级了哪些】：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL0JWMWJLNDIxdjc4di8=\">https://www.bilibili.com/video/BV1bK421v78v/</span></li>\n<li>【yolov10 目标检测算法原理与实战】：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL0JWMXV1ZTF6Q0VUZg==\">https://www.bilibili.com/video/BV1uue1zCETf</span></li>\n<li>【yolov11 目标检测算法原理与实战】<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL0JWMXZwYW16UkVaVA==\">https://www.bilibili.com/video/BV1vpamzREZT</span></li>\n</ol>\n",
            "tags": [
                "深度学习",
                "YOLO",
                "python",
                "CNN",
                "深度学习",
                "YOLO"
            ]
        },
        {
            "id": "https://735690757.github.io/python/YOLO/YOLO_V8/",
            "url": "https://735690757.github.io/python/YOLO/YOLO_V8/",
            "title": "YOLO-V8 with Ultralytics Full Version",
            "date_published": "2026-01-18T04:12:12.000Z",
            "content_html": "<h1 id=\"yolov8-with-ultralytics-full-version\"><a class=\"markdownIt-Anchor\" href=\"#yolov8-with-ultralytics-full-version\">#</a> YOLOv8 with Ultralytics Full Version</h1>\n<h2 id=\"克隆与安装\"><a class=\"markdownIt-Anchor\" href=\"#克隆与安装\">#</a> 克隆与安装</h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">git</span> clone https://github.com/ultralytics/ultralytics.git</pre></td></tr></table></figure><figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>conda <span class=\"token function\">install</span> <span class=\"token parameter variable\">-c</span> pytorch <span class=\"token parameter variable\">-c</span> nvidia <span class=\"token parameter variable\">-c</span> conda-forge pytorch torchvision pytorch-cuda<span class=\"token operator\">=</span><span class=\"token number\">11.8</span> ultralytics</pre></td></tr></table></figure><img data-src=\"../../../images/python/YOLO/v8/1.png\" alt=\"1\" style=\"zoom:100%;\" />\n<p>Ultralytics 根项目与之前纯粹的 v5 项目不同，它包含了全部的 YOLO 版本。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3huLS1kZXRlY3QtaG4zanU3NGEzdnI3emFrOTJlNGs0Yi5weQ==\">在根目录创建 detect.py</span>：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span> ultralytics <span class=\"token keyword\">import</span> YOLO</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>model <span class=\"token operator\">=</span> YOLO<span class=\"token punctuation\">(</span><span class=\"token string\">\"yolov8s.pt\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>model<span class=\"token punctuation\">.</span>predict<span class=\"token punctuation\">(</span>source<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> show<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>三行代码即可调用摄像头检测。</p>\n<p>通过：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>model<span class=\"token punctuation\">.</span>info<span class=\"token punctuation\">(</span>verbose<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">.</span>model<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>即可查看模型结构：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>YOLOv8s summary: <span class=\"token number\">129</span> layers, <span class=\"token number\">11,166</span>,560 parameters, <span class=\"token number\">0</span> gradients</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>DetectionModel<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">)</span>: Sequential<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">32</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span>, <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">32</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">32</span>, <span class=\"token number\">64</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span>, <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">64</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>: C2f<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token punctuation\">(</span>cv1<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">64</span>, <span class=\"token number\">64</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">64</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token punctuation\">(</span>cv2<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">96</span>, <span class=\"token number\">64</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">64</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      <span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span>: ModuleList<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>: Bottleneck<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          <span class=\"token punctuation\">(</span>cv1<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">32</span>, <span class=\"token number\">32</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">32</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>          <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          <span class=\"token punctuation\">(</span>cv2<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">32</span>, <span class=\"token number\">32</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">32</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">64</span>, <span class=\"token number\">128</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span>, <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span>: C2f<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      <span class=\"token punctuation\">(</span>cv1<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token number\">128</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token punctuation\">(</span>cv2<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">256</span>, <span class=\"token number\">128</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>      <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      <span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span>: ModuleList<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token punctuation\">(</span><span class=\"token number\">0</span>-1<span class=\"token punctuation\">)</span>: <span class=\"token number\">2</span> x Bottleneck<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>          <span class=\"token punctuation\">(</span>cv1<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>            <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">64</span>, <span class=\"token number\">64</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>            <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">64</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>            <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>          <span class=\"token punctuation\">(</span>cv2<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>            <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">64</span>, <span class=\"token number\">64</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>            <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">64</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>            <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>          <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>      <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token number\">256</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span>, <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>      <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">256</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>      <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span>: C2f<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>      <span class=\"token punctuation\">(</span>cv1<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">256</span>, <span class=\"token number\">256</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">256</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>      <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>      <span class=\"token punctuation\">(</span>cv2<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>        <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">512</span>, <span class=\"token number\">256</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">256</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>        <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>      <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>      <span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span>: ModuleList<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>        <span class=\"token punctuation\">(</span><span class=\"token number\">0</span>-1<span class=\"token punctuation\">)</span>: <span class=\"token number\">2</span> x Bottleneck<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>          <span class=\"token punctuation\">(</span>cv1<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>            <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token number\">128</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>            <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>            <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>          <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>          <span class=\"token punctuation\">(</span>cv2<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>            <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token number\">128</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>            <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>            <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>          <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>      <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>      <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">256</span>, <span class=\"token number\">512</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span>, <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>      <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">512</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>      <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span>: C2f<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>      <span class=\"token punctuation\">(</span>cv1<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>        <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">512</span>, <span class=\"token number\">512</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>        <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">512</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>        <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>      <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>      <span class=\"token punctuation\">(</span>cv2<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>        <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">768</span>, <span class=\"token number\">512</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>        <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">512</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>        <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>      <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>      <span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span>: ModuleList<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>        <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>: Bottleneck<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>          <span class=\"token punctuation\">(</span>cv1<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>            <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">256</span>, <span class=\"token number\">256</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>            <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">256</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>            <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>          <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>          <span class=\"token punctuation\">(</span>cv2<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>            <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">256</span>, <span class=\"token number\">256</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>            <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">256</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>            <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>          <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>      <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token number\">9</span><span class=\"token punctuation\">)</span>: SPPF<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>      <span class=\"token punctuation\">(</span>cv1<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>        <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">512</span>, <span class=\"token number\">256</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>        <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">256</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>        <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>      <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>      <span class=\"token punctuation\">(</span>cv2<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>        <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">1024</span>, <span class=\"token number\">512</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>        <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">512</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>        <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>      <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>      <span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span>: MaxPool2d<span class=\"token punctuation\">(</span>kernel_size<span class=\"token operator\">=</span><span class=\"token number\">5</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token number\">2</span>, <span class=\"token assign-left variable\">dilation</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>, <span class=\"token assign-left variable\">ceil_mode</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span>: Upsample<span class=\"token punctuation\">(</span>scale_factor<span class=\"token operator\">=</span><span class=\"token number\">2.0</span>, <span class=\"token assign-left variable\">mode</span><span class=\"token operator\">=</span><span class=\"token string\">'nearest'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span>: Concat<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token number\">12</span><span class=\"token punctuation\">)</span>: C2f<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>      <span class=\"token punctuation\">(</span>cv1<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>        <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">768</span>, <span class=\"token number\">256</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>        <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">256</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>        <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>      <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>      <span class=\"token punctuation\">(</span>cv2<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>        <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">384</span>, <span class=\"token number\">256</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>        <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">256</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>        <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>      <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>      <span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span>: ModuleList<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>        <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>: Bottleneck<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>          <span class=\"token punctuation\">(</span>cv1<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>            <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token number\">128</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>            <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>            <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>          <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>          <span class=\"token punctuation\">(</span>cv2<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>            <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token number\">128</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>            <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>            <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>          <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>      <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token number\">13</span><span class=\"token punctuation\">)</span>: Upsample<span class=\"token punctuation\">(</span>scale_factor<span class=\"token operator\">=</span><span class=\"token number\">2.0</span>, <span class=\"token assign-left variable\">mode</span><span class=\"token operator\">=</span><span class=\"token string\">'nearest'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token number\">14</span><span class=\"token punctuation\">)</span>: Concat<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token number\">15</span><span class=\"token punctuation\">)</span>: C2f<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>      <span class=\"token punctuation\">(</span>cv1<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>        <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">384</span>, <span class=\"token number\">128</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>        <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>        <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>      <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>      <span class=\"token punctuation\">(</span>cv2<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>        <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">192</span>, <span class=\"token number\">128</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>        <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>        <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>      <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>      <span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span>: ModuleList<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>        <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>: Bottleneck<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>          <span class=\"token punctuation\">(</span>cv1<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>            <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">64</span>, <span class=\"token number\">64</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>            <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">64</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>            <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>          <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre>          <span class=\"token punctuation\">(</span>cv2<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>            <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">64</span>, <span class=\"token number\">64</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre>            <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">64</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"197\"></td><td><pre>            <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>          <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre>      <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"202\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre>      <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token number\">128</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span>, <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"204\"></td><td><pre>      <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"205\"></td><td><pre>      <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"207\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token number\">17</span><span class=\"token punctuation\">)</span>: Concat<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"208\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token number\">18</span><span class=\"token punctuation\">)</span>: C2f<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"209\"></td><td><pre>      <span class=\"token punctuation\">(</span>cv1<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre>        <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">384</span>, <span class=\"token number\">256</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre>        <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">256</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"212\"></td><td><pre>        <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"213\"></td><td><pre>      <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"214\"></td><td><pre>      <span class=\"token punctuation\">(</span>cv2<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"215\"></td><td><pre>        <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">384</span>, <span class=\"token number\">256</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"216\"></td><td><pre>        <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">256</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"217\"></td><td><pre>        <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"218\"></td><td><pre>      <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"219\"></td><td><pre>      <span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span>: ModuleList<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"220\"></td><td><pre>        <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>: Bottleneck<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"221\"></td><td><pre>          <span class=\"token punctuation\">(</span>cv1<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"222\"></td><td><pre>            <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token number\">128</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"223\"></td><td><pre>            <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"224\"></td><td><pre>            <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"225\"></td><td><pre>          <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"226\"></td><td><pre>          <span class=\"token punctuation\">(</span>cv2<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"227\"></td><td><pre>            <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token number\">128</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"228\"></td><td><pre>            <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"229\"></td><td><pre>            <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"230\"></td><td><pre>          <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"231\"></td><td><pre>        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"232\"></td><td><pre>      <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"233\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"234\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token number\">19</span><span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"235\"></td><td><pre>      <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">256</span>, <span class=\"token number\">256</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span>, <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"236\"></td><td><pre>      <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">256</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"237\"></td><td><pre>      <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"238\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"239\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span>: Concat<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"240\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token number\">21</span><span class=\"token punctuation\">)</span>: C2f<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"241\"></td><td><pre>      <span class=\"token punctuation\">(</span>cv1<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"242\"></td><td><pre>        <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">768</span>, <span class=\"token number\">512</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"243\"></td><td><pre>        <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">512</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"244\"></td><td><pre>        <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"245\"></td><td><pre>      <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"246\"></td><td><pre>      <span class=\"token punctuation\">(</span>cv2<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"247\"></td><td><pre>        <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">768</span>, <span class=\"token number\">512</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"248\"></td><td><pre>        <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">512</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"249\"></td><td><pre>        <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"250\"></td><td><pre>      <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"251\"></td><td><pre>      <span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span>: ModuleList<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"252\"></td><td><pre>        <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>: Bottleneck<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"253\"></td><td><pre>          <span class=\"token punctuation\">(</span>cv1<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"254\"></td><td><pre>            <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">256</span>, <span class=\"token number\">256</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"255\"></td><td><pre>            <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">256</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"256\"></td><td><pre>            <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"257\"></td><td><pre>          <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"258\"></td><td><pre>          <span class=\"token punctuation\">(</span>cv2<span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"259\"></td><td><pre>            <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">256</span>, <span class=\"token number\">256</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"260\"></td><td><pre>            <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">256</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"261\"></td><td><pre>            <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"262\"></td><td><pre>          <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"263\"></td><td><pre>        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"264\"></td><td><pre>      <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"265\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"266\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token number\">22</span><span class=\"token punctuation\">)</span>: Detect<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"267\"></td><td><pre>      <span class=\"token punctuation\">(</span>cv2<span class=\"token punctuation\">)</span>: ModuleList<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"268\"></td><td><pre>        <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>: Sequential<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"269\"></td><td><pre>          <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"270\"></td><td><pre>            <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token number\">64</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"271\"></td><td><pre>            <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">64</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"272\"></td><td><pre>            <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"273\"></td><td><pre>          <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"274\"></td><td><pre>          <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"275\"></td><td><pre>            <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">64</span>, <span class=\"token number\">64</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"276\"></td><td><pre>            <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">64</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"277\"></td><td><pre>            <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"278\"></td><td><pre>          <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"279\"></td><td><pre>          <span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">64</span>, <span class=\"token number\">64</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">))</span></pre></td></tr><tr><td data-num=\"280\"></td><td><pre>        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"281\"></td><td><pre>        <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>: Sequential<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"282\"></td><td><pre>          <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"283\"></td><td><pre>            <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">256</span>, <span class=\"token number\">64</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"284\"></td><td><pre>            <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">64</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"285\"></td><td><pre>            <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"286\"></td><td><pre>          <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"287\"></td><td><pre>          <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"288\"></td><td><pre>            <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">64</span>, <span class=\"token number\">64</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"289\"></td><td><pre>            <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">64</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"290\"></td><td><pre>            <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"291\"></td><td><pre>          <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"292\"></td><td><pre>          <span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">64</span>, <span class=\"token number\">64</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">))</span></pre></td></tr><tr><td data-num=\"293\"></td><td><pre>        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"294\"></td><td><pre>        <span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>: Sequential<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"295\"></td><td><pre>          <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"296\"></td><td><pre>            <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">512</span>, <span class=\"token number\">64</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"297\"></td><td><pre>            <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">64</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"298\"></td><td><pre>            <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"299\"></td><td><pre>          <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"300\"></td><td><pre>          <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"301\"></td><td><pre>            <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">64</span>, <span class=\"token number\">64</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"302\"></td><td><pre>            <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">64</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"303\"></td><td><pre>            <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"304\"></td><td><pre>          <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"305\"></td><td><pre>          <span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">64</span>, <span class=\"token number\">64</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">))</span></pre></td></tr><tr><td data-num=\"306\"></td><td><pre>        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"307\"></td><td><pre>      <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"308\"></td><td><pre>      <span class=\"token punctuation\">(</span>cv3<span class=\"token punctuation\">)</span>: ModuleList<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"309\"></td><td><pre>        <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>: Sequential<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"310\"></td><td><pre>          <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"311\"></td><td><pre>            <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token number\">128</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"312\"></td><td><pre>            <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"313\"></td><td><pre>            <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"314\"></td><td><pre>          <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"315\"></td><td><pre>          <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"316\"></td><td><pre>            <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token number\">128</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"317\"></td><td><pre>            <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"318\"></td><td><pre>            <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"319\"></td><td><pre>          <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"320\"></td><td><pre>          <span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token number\">80</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">))</span></pre></td></tr><tr><td data-num=\"321\"></td><td><pre>        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"322\"></td><td><pre>        <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>: Sequential<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"323\"></td><td><pre>          <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"324\"></td><td><pre>            <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">256</span>, <span class=\"token number\">128</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"325\"></td><td><pre>            <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"326\"></td><td><pre>            <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"327\"></td><td><pre>          <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"328\"></td><td><pre>          <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"329\"></td><td><pre>            <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token number\">128</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"330\"></td><td><pre>            <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"331\"></td><td><pre>            <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"332\"></td><td><pre>          <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"333\"></td><td><pre>          <span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token number\">80</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">))</span></pre></td></tr><tr><td data-num=\"334\"></td><td><pre>        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"335\"></td><td><pre>        <span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>: Sequential<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"336\"></td><td><pre>          <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"337\"></td><td><pre>            <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">512</span>, <span class=\"token number\">128</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"338\"></td><td><pre>            <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"339\"></td><td><pre>            <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"340\"></td><td><pre>          <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"341\"></td><td><pre>          <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>: Conv<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"342\"></td><td><pre>            <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token number\">128</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">padding</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"343\"></td><td><pre>            <span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">)</span>: BatchNorm2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token assign-left variable\">eps</span><span class=\"token operator\">=</span><span class=\"token number\">0.001</span>, <span class=\"token assign-left variable\">momentum</span><span class=\"token operator\">=</span><span class=\"token number\">0.03</span>, <span class=\"token assign-left variable\">affine</span><span class=\"token operator\">=</span>True, <span class=\"token assign-left variable\">track_running_stats</span><span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"344\"></td><td><pre>            <span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">)</span>: SiLU<span class=\"token punctuation\">(</span>inplace<span class=\"token operator\">=</span>True<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"345\"></td><td><pre>          <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"346\"></td><td><pre>          <span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">128</span>, <span class=\"token number\">80</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">))</span></pre></td></tr><tr><td data-num=\"347\"></td><td><pre>        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"348\"></td><td><pre>      <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"349\"></td><td><pre>      <span class=\"token punctuation\">(</span>dfl<span class=\"token punctuation\">)</span>: DFL<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"350\"></td><td><pre>        <span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span>: Conv2d<span class=\"token punctuation\">(</span><span class=\"token number\">16</span>, <span class=\"token number\">1</span>, <span class=\"token assign-left variable\">kernel_size</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">stride</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>, <span class=\"token assign-left variable\">bias</span><span class=\"token operator\">=</span>False<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"351\"></td><td><pre>      <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"352\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"353\"></td><td><pre>  <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"354\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>这模型我说白了，打眼一看就是 CBS、CBS、CBS…</p>\n<h2 id=\"看看模型\"><a class=\"markdownIt-Anchor\" href=\"#看看模型\">#</a> 看看模型</h2>\n<p>大部分内容与之前的版本大差不差，详情可看我之前的文章。</p>\n<h3 id=\"cbs\"><a class=\"markdownIt-Anchor\" href=\"#cbs\">#</a> CBS</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">Conv</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\"Standard convolution module with batch normalization and activation.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    Attributes:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        conv (nn.Conv2d): Convolutional layer.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        bn (nn.BatchNorm2d): Batch normalization layer.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        act (nn.Module): Activation function layer.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        default_act (nn.Module): Default activation function (SiLU).</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    \"\"\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    default_act <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>SiLU<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># default activation</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> c1<span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">,</span> k<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> s<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> p<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> g<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> d<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> act<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"Initialize Conv layer with given parameters.</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        Args:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            c1 (int): Number of input channels.</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            c2 (int): Number of output channels.</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            k (int): Kernel size.</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            s (int): Stride.</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            p (int, optional): Padding.</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            g (int): Groups.</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            d (int): Dilation.</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            act (bool | nn.Module): Activation function.</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        \"\"\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        self<span class=\"token punctuation\">.</span>conv <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">(</span>c1<span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">,</span> k<span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">,</span> autopad<span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">,</span> d<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> groups<span class=\"token operator\">=</span>g<span class=\"token punctuation\">,</span> dilation<span class=\"token operator\">=</span>d<span class=\"token punctuation\">,</span> bias<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        self<span class=\"token punctuation\">.</span>bn <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>BatchNorm2d<span class=\"token punctuation\">(</span>c2<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        self<span class=\"token punctuation\">.</span>act <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>default_act <span class=\"token keyword\">if</span> act <span class=\"token keyword\">is</span> <span class=\"token boolean\">True</span> <span class=\"token keyword\">else</span> act <span class=\"token keyword\">if</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">,</span> nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> nn<span class=\"token punctuation\">.</span>Identity<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"Apply convolution, batch normalization and activation to input tensor.</pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        Args:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            x (torch.Tensor): Input tensor.</pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        Returns:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            (torch.Tensor): Output tensor.</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        \"\"\"</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>act<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>bn<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>conv<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward_fuse</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"Apply convolution and activation without batch normalization.</pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        Args:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            x (torch.Tensor): Input tensor.</pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        Returns:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            (torch.Tensor): Output tensor.</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        \"\"\"</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>act<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>conv<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><img data-src=\"../../../images/python/YOLO/v8/2.png\" alt=\"1\" style=\"zoom:100%;\" />\n<h3 id=\"bottleneck_t-and-bottleneck_f\"><a class=\"markdownIt-Anchor\" href=\"#bottleneck_t-and-bottleneck_f\">#</a> Bottleneck_T and Bottleneck_F</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">Bottleneck</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\"Standard bottleneck.\"\"\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        self<span class=\"token punctuation\">,</span> c1<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> shortcut<span class=\"token punctuation\">:</span> <span class=\"token builtin\">bool</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> g<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> k<span class=\"token punctuation\">:</span> <span class=\"token builtin\">tuple</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">:</span> <span class=\"token builtin\">float</span> <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"Initialize a standard bottleneck module.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        Args:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            c1 (int): Input channels.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            c2 (int): Output channels.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            shortcut (bool): Whether to use shortcut connection.</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            g (int): Groups for convolutions.</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            k (tuple): Kernel sizes for convolutions.</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            e (float): Expansion ratio.</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        \"\"\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        c_ <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>c2 <span class=\"token operator\">*</span> e<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># hidden channels</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv1 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span>c1<span class=\"token punctuation\">,</span> c_<span class=\"token punctuation\">,</span> k<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv2 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span>c_<span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">,</span> k<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> g<span class=\"token operator\">=</span>g<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        self<span class=\"token punctuation\">.</span>add <span class=\"token operator\">=</span> shortcut <span class=\"token keyword\">and</span> c1 <span class=\"token operator\">==</span> c2</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">:</span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"Apply bottleneck with optional shortcut connection.\"\"\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token keyword\">return</span> x <span class=\"token operator\">+</span> self<span class=\"token punctuation\">.</span>cv2<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>cv1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">if</span> self<span class=\"token punctuation\">.</span>add <span class=\"token keyword\">else</span> self<span class=\"token punctuation\">.</span>cv2<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>cv1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><img data-src=\"../../../images/python/YOLO/v8/3.png\" alt=\"1\" style=\"zoom:100%;\" />\n<h3 id=\"c2f_t-and-c2f_f\"><a class=\"markdownIt-Anchor\" href=\"#c2f_t-and-c2f_f\">#</a> C2F_T and C2F_F</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">C2f</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\"Faster Implementation of CSP Bottleneck with 2 convolutions.\"\"\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> c1<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> n<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> shortcut<span class=\"token punctuation\">:</span> <span class=\"token builtin\">bool</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> g<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">:</span> <span class=\"token builtin\">float</span> <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"Initialize a CSP bottleneck with 2 convolutions.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        Args:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            c1 (int): Input channels.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            c2 (int): Output channels.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            n (int): Number of Bottleneck blocks.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            shortcut (bool): Whether to use shortcut connections.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            g (int): Groups for convolutions.</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            e (float): Expansion ratio.</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        \"\"\"</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        self<span class=\"token punctuation\">.</span>c <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>c2 <span class=\"token operator\">*</span> e<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># hidden channels</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv1 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span>c1<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv2 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">+</span> n<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># optional act=FReLU(c2)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        self<span class=\"token punctuation\">.</span>m <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>ModuleList<span class=\"token punctuation\">(</span>Bottleneck<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> shortcut<span class=\"token punctuation\">,</span> g<span class=\"token punctuation\">,</span> k<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> e<span class=\"token operator\">=</span><span class=\"token number\">1.0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">:</span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"Forward pass through C2f layer.\"\"\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        y <span class=\"token operator\">=</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>cv1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>chunk<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        y<span class=\"token punctuation\">.</span>extend<span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> m <span class=\"token keyword\">in</span> self<span class=\"token punctuation\">.</span>m<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>cv2<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward_split</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">:</span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"Forward pass using split() instead of chunk().\"\"\"</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        y <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>cv1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        y <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>y<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        y<span class=\"token punctuation\">.</span>extend<span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> m <span class=\"token keyword\">in</span> self<span class=\"token punctuation\">.</span>m<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>cv2<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>chunk(2, 1)： <code>y = list(self.cv1(x).chunk(2, 1))</code>  在通道维度平均切成两份。 <code>- [-1, 6, C2f, [256, True]]</code>  这里有如果 6 个 Bottleneck。就像这样： <code>self.m = [B1, B2, B3, B4, B5, B6]</code> 。观察： <code>y.extend(m(y[-1]) for m in self.m)</code> ，刚 chunk 后使用的是后一半<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>x</mi><mn>2</mn></msub></mrow><annotation encoding=\"application/x-tex\">x_2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，第一次 Bottleneck 后使用的是 B1 (<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>x</mi><mn>2</mn></msub></mrow><annotation encoding=\"application/x-tex\">x_2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>)，第二次执行后使用的是 B2 (B1 (<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>x</mi><mn>2</mn></msub></mrow><annotation encoding=\"application/x-tex\">x_2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>))。大概是这样：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>x1, x2<span class=\"token punctuation\">]</span>\t\t\t\t\t <span class=\"token comment\"># chunk 后</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>x1, x2, B1<span class=\"token punctuation\">(</span>x2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\t\t\t <span class=\"token comment\"># 第一次 y.extend (m (y [-1]) for m in self.m)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>x1, x2, B1<span class=\"token punctuation\">(</span>x2<span class=\"token punctuation\">)</span>, B2<span class=\"token punctuation\">(</span>B1<span class=\"token punctuation\">(</span>x2<span class=\"token punctuation\">))</span><span class=\"token punctuation\">]</span> <span class=\"token comment\"># 第二次 y.extend (m (y [-1]) for m in self.m)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>x1, x2, B1<span class=\"token punctuation\">(</span>x2<span class=\"token punctuation\">)</span>, B2<span class=\"token punctuation\">(</span>B1<span class=\"token punctuation\">(</span>x2<span class=\"token punctuation\">))</span>, B3<span class=\"token punctuation\">(</span>B2<span class=\"token punctuation\">(</span>B1<span class=\"token punctuation\">(</span>x2<span class=\"token punctuation\">))</span><span class=\"token punctuation\">)</span>,<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span> , B6<span class=\"token punctuation\">(</span>B5<span class=\"token punctuation\">(</span>B4<span class=\"token punctuation\">(</span>B3<span class=\"token punctuation\">(</span>B2<span class=\"token punctuation\">(</span>B1<span class=\"token punctuation\">(</span>x2<span class=\"token punctuation\">))</span><span class=\"token punctuation\">))</span><span class=\"token punctuation\">))</span><span class=\"token punctuation\">]</span> <span class=\"token comment\"># 第六次</span></pre></td></tr></table></figure><p>最后：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>cv2<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>把那个列表全拼起来了。牛逼！优雅的代码，太优雅了！</p>\n<img data-src=\"../../../images/python/YOLO/v8/4.png\" alt=\"1\" style=\"zoom:100%;\" />\n<h3 id=\"sppf\"><a class=\"markdownIt-Anchor\" href=\"#sppf\">#</a> SPPF</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">SPPF</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\"Spatial Pyramid Pooling - Fast (SPPF) layer for YOLOv5 by Glenn Jocher.\"\"\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> c1<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> k<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span> <span class=\"token operator\">=</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> n<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span> <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> shortcut<span class=\"token punctuation\">:</span> <span class=\"token builtin\">bool</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"Initialize the SPPF layer with given input/output channels and kernel size.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        Args:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            c1 (int): Input channels.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            c2 (int): Output channels.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            k (int): Kernel size.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            n (int): Number of pooling iterations.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            shortcut (bool): Whether to use shortcut connection.</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        Notes:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            This module is equivalent to SPP(k=(5, 9, 13)).</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        \"\"\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        c_ <span class=\"token operator\">=</span> c1 <span class=\"token operator\">//</span> <span class=\"token number\">2</span>  <span class=\"token comment\"># hidden channels</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv1 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span>c1<span class=\"token punctuation\">,</span> c_<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> act<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv2 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span>c_ <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>n <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        self<span class=\"token punctuation\">.</span>m <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>MaxPool2d<span class=\"token punctuation\">(</span>kernel_size<span class=\"token operator\">=</span>k<span class=\"token punctuation\">,</span> stride<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> padding<span class=\"token operator\">=</span>k <span class=\"token operator\">//</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        self<span class=\"token punctuation\">.</span>n <span class=\"token operator\">=</span> n</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        self<span class=\"token punctuation\">.</span>add <span class=\"token operator\">=</span> shortcut <span class=\"token keyword\">and</span> c1 <span class=\"token operator\">==</span> c2</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">:</span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> torch<span class=\"token punctuation\">.</span>Tensor<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"Apply sequential pooling operations to input and return concatenated feature maps.\"\"\"</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        y <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>self<span class=\"token punctuation\">.</span>cv1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        y<span class=\"token punctuation\">.</span>extend<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>m<span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">getattr</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> <span class=\"token string\">\"n\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        y <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>cv2<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token keyword\">return</span> y <span class=\"token operator\">+</span> x <span class=\"token keyword\">if</span> <span class=\"token builtin\">getattr</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> <span class=\"token string\">\"add\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> y</pre></td></tr></table></figure><p>这个 <code>cv1</code>  和 <code>cv2</code>  中的 k 与 s 全是 1，完全不改变特征图大小，只改变通道数。通道拼接这里接受了四部分的输入，所以 <code>self.cv2 = Conv(c_ * 4, c2, 1, 1)</code>  中写道： <code>c_ * 4</code> ，其中 <code>c_</code> 是第一个 CBS 的输出通道数。</p>\n<img data-src=\"../../../images/python/YOLO/v5/4.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<h3 id=\"anchor-free\"><a class=\"markdownIt-Anchor\" href=\"#anchor-free\">#</a> Anchor-Free!</h3>\n<p>终于把你盼来了哈哈哈，先回顾 Anchor-Based，YOLOv5 的检测头会：</p>\n<ol>\n<li>在每个网格点上</li>\n<li>预设 3 个 anchor（比如 10×13, 16×30, 33×23）</li>\n<li>预测：x 偏移、y 偏移、w 缩放、h 缩放。</li>\n</ol>\n<p>也就是说：预测是基于 “某个预设框” 进行修正，就像这样：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>bx <span class=\"token operator\">=</span> sigmoid<span class=\"token punctuation\">(</span>tx<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> cx</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>bw <span class=\"token operator\">=</span> anchor_w <span class=\"token operator\">*</span> exp<span class=\"token punctuation\">(</span>tw<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>YOLOv8 不再使用 anchor，每个特征点直接预测，每个点自己决定是不是目标中心，那 YOLOv1 当年不也是没 anchor 吗？有啥本质区别？哈哈表面一样，内核完全不同。YOLOv8 是点 + 分布建模 + 动态匹配。YOLOv8 中心点是固定网格点，但预测框的位置完全由 ltrb 决定。</p>\n<p>YOLOv8：</p>\n<ul>\n<li>每个特征点都是候选中心</li>\n<li>预测的是 l, t, r, b（到边界的距离）</li>\n<li>用 DFL 分布回归</li>\n<li>动态正负样本分配</li>\n</ul>\n<p>相当于特征图上有很多钉子，每个钉子可以向四周拉橡皮筋，谁拉得最准，谁就负责那个目标，我觉得这是最精彩的部分啦！</p>\n <img data-src=\"../../../images/python/YOLO/v8/5.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<p>YOLOv8 觉得：“我为什么要难为模型去猜一个无限精确的点呢？我给它 <strong>16 个固定的刻度</strong>，让它去做<strong>选择题</strong>。” 这 16 个值代表距离 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>0</mn><mo separator=\"true\">,</mo><mn>1</mn><mo separator=\"true\">,</mo><mn>2</mn><mo separator=\"true\">,</mo><mn>3</mn><mo separator=\"true\">,</mo><mo>…</mo><mo separator=\"true\">,</mo><mn>15</mn></mrow><annotation encoding=\"application/x-tex\">0, 1, 2, 3, \\dots, 15</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8388800000000001em;vertical-align:-0.19444em;\"></span><span class=\"mord\">0</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">1</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">2</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">3</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\">…</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">1</span><span class=\"mord\">5</span></span></span></span>，模型输出的是这 16 个刻度的<strong>概率分布</strong>，就是有点像模糊数学，大概是那样。你可能会想，如果我只需要 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>y</mi></mrow><annotation encoding=\"application/x-tex\">y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span></span> 左右两个点，为什么要输出 16 个值？因为模型在<strong>推理阶段</strong>并不知道真实值在哪。它必须在 16 个刻度上全部分布概率，最后通过 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>∑</mo><msub><mi>y</mi><mi>i</mi></msub><mo>⋅</mo><mi>P</mi><mo stretchy=\"false\">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\sum y_i \\cdot P(y_i)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.00001em;vertical-align:-0.25001em;\"></span><span class=\"mop op-symbol small-op\" style=\"position:relative;top:-0.0000050000000000050004em;\">∑</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span> “算出” 那个它认为最可能的距离。</p>\n<p>在 YOLOv8 中，一个方向的实际预测距离（像素）计算公式是：实际像素距离 =DFL 得到的数值 × 当前层的步长。YOLOv8 有三个主要的输出层，每一层负责不同大小的物体。</p>\n<p>我们来看最精细的那一层 <strong>P3</strong>：</p>\n<ul>\n<li>P3 层的步长：<strong>8</strong>，意味着特征图缩小了 8 倍。</li>\n<li>DFL 最大刻度：<strong>15</strong>。</li>\n<li>最大覆盖距离：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>15</mn><mo>×</mo><mn>8</mn><mo>=</mo><mn mathvariant=\"bold\">120</mn></mrow><annotation encoding=\"application/x-tex\">15 \\times 8 = \\mathbf{120}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">1</span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">8</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathbf\">1</span><span class=\"mord mathbf\">2</span><span class=\"mord mathbf\">0</span></span></span></span></span> 像素。</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">特征图层级</th>\n<th style=\"text-align:center\">步长</th>\n<th style=\"text-align:center\">DFL 最大刻度</th>\n<th style=\"text-align:center\">单向最大覆盖</th>\n<th style=\"text-align:center\">整个框的最大尺寸</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">P3</td>\n<td style=\"text-align:center\">8</td>\n<td style=\"text-align:center\">15</td>\n<td style=\"text-align:center\" 120=\"\">15 \\times 8 = \\mathbf</td>\n<td style=\"text-align:center\">约 240 像素</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">P4</td>\n<td style=\"text-align:center\">16</td>\n<td style=\"text-align:center\">15</td>\n<td style=\"text-align:center\" 240=\"\">15 \\times 16 = \\mathbf</td>\n<td style=\"text-align:center\">约 480 像素</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">P5</td>\n<td style=\"text-align:center\">32</td>\n<td style=\"text-align:center\">15</td>\n<td style=\"text-align:center\" 480=\"\">15 \\times 32 = \\mathbf</td>\n<td style=\"text-align:center\">约 960 像素</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"dfl\"><a class=\"markdownIt-Anchor\" href=\"#dfl\">#</a> DFL</h2>\n<p><strong>普通回归预测一个值</strong>：模型说 “距离是 5.4”。如果实际是 5.7，它只知道自己错了，但不知道边缘到底在哪。<strong>DFL 预测分布</strong>：模型说 “我有 60% 把握在 5，40% 把握在 6”。</p>\n<p>想象你要测量一个物体的长度，我有两种给工具的方式：</p>\n<p><strong>方式 A</strong>：给你一张白纸，让你自己猜长度并写下来。</p>\n<p><strong>方式 B</strong>：给你一把有 <strong>16 个刻度</strong> 的尺子，让你告诉我，物体的边缘落在哪个刻度上。为什么方式 B 更好？ 因为神经网络本质上是一个巨大的<strong>分类器</strong>。让它从 16 个选项里选（分类），比让它凭空变出一个精准的浮点数（回归）要容易得多。</p>\n<p>DFL 的核心思想是将连续的坐标值<strong>离散化</strong>，YOLOv8 默认将边界框的偏移量划分为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>16</mn></mrow><annotation encoding=\"application/x-tex\">16</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\">6</span></span></span></span> 个整数槽位。对于每一个边缘，模型会输出 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>16</mn></mrow><annotation encoding=\"application/x-tex\">16</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\">6</span></span></span></span> 个值，代表落在这 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>16</mn></mrow><annotation encoding=\"application/x-tex\">16</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\">6</span></span></span></span> 个位置上的概率。</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>y</mi><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mi>n</mi></munderover><msub><mi>y</mi><mi>i</mi></msub><mo>⋅</mo><mi>P</mi><mo stretchy=\"false\">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">y = \\sum_{i=0}^{n} y_i \\cdot P(y_i)\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.929066em;vertical-align:-1.277669em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.6513970000000002em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></span></p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>D</mi><mi>F</mi><mi>L</mi><mo stretchy=\"false\">(</mo><msub><mi>P</mi><mi>i</mi></msub><mo separator=\"true\">,</mo><msub><mi>P</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy=\"false\">)</mo><mo>=</mo><mo>−</mo><mrow><mo fence=\"true\">(</mo><mo stretchy=\"false\">(</mo><msub><mi>y</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>−</mo><mi>y</mi><mo stretchy=\"false\">)</mo><mi>log</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><msub><mi>P</mi><mi>i</mi></msub><mo stretchy=\"false\">)</mo><mo>+</mo><mo stretchy=\"false\">(</mo><mi>y</mi><mo>−</mo><msub><mi>y</mi><mi>i</mi></msub><mo stretchy=\"false\">)</mo><mi>log</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><msub><mi>P</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy=\"false\">)</mo><mo fence=\"true\">)</mo></mrow></mrow><annotation encoding=\"application/x-tex\">DFL(P_i, P_{i+1}) = - \\left( (y_{i+1} - y) \\log(P_i) + (y - y_i) \\log(P_{i+1}) \\right)\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord mathnormal\">L</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.208331em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">−</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\">(</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.208331em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.208331em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mclose delimcenter\" style=\"top:0em;\">)</span></span></span></span></span></span></p>\n<p><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>y</mi></mrow><annotation encoding=\"application/x-tex\">y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span></span>：</strong> 标签（Ground Truth）经过缩放后的浮点坐标。</p>\n<p><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub><mo separator=\"true\">,</mo><msub><mi>y</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding=\"application/x-tex\">y_i, y_{i+1}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.638891em;vertical-align:-0.208331em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.208331em;\"><span></span></span></span></span></span></span></span></span></span>：</strong> <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>y</mi></mrow><annotation encoding=\"application/x-tex\">y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span></span> 两侧最近的整数节点。</p>\n<p><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub><mo separator=\"true\">,</mo><msub><mi>P</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding=\"application/x-tex\">P_i, P_{i+1}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.891661em;vertical-align:-0.208331em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.208331em;\"><span></span></span></span></span></span></span></span></span></span>：</strong> 模型预测落在这些节点上的网络输出。</p>\n<p>这种分布的形式能够表达<strong>不确定性</strong>，让模型在面对复杂场景时表现得更加稳健。</p>\n<p>为什么 DFL 公式里只用 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">P_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 和 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>P</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding=\"application/x-tex\">P_{i+1}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.891661em;vertical-align:-0.208331em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.208331em;\"><span></span></span></span></span></span></span></span></span></span>，即 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>y</mi></mrow><annotation encoding=\"application/x-tex\">y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span></span> 左右两边的概率？因为既然 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>y</mi></mrow><annotation encoding=\"application/x-tex\">y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span></span> 落在 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">y_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 和 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>y</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding=\"application/x-tex\">y_{i+1}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.638891em;vertical-align:-0.208331em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.208331em;\"><span></span></span></span></span></span></span></span></span></span> 之间，那我们希望模型预测的概率也<strong>集中</strong>在这两个点上。如果 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">P_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 和 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>P</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding=\"application/x-tex\">P_{i+1}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.891661em;vertical-align:-0.208331em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.208331em;\"><span></span></span></span></span></span></span></span></span></span> 很大，说明模型预测得非常精准且集中。如果模型在 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>P</mi><mn>0</mn></msub></mrow><annotation encoding=\"application/x-tex\">P_0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 或 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>P</mi><mn>15</mn></msub></mrow><annotation encoding=\"application/x-tex\">P_{15}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span><span class=\"mord mtight\">5</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 上给出了高概率，即便加权平均后的期望值 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>y</mi></mrow><annotation encoding=\"application/x-tex\">y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span></span> 对了，DFL 也会跳出来大喊：“不对！你预测得太离散了，不确定性太高，罚！”</p>\n<h2 id=\"匹配的三步走\"><a class=\"markdownIt-Anchor\" href=\"#匹配的三步走\">#</a> 匹配的三步走</h2>\n<p>TAL 会计算每一个候选中心点的得分 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">t</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.61508em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">t</span></span></span></span>，公式如下：</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>t</mi><mo>=</mo><msup><mi>s</mi><mi>α</mi></msup><mo>×</mo><msup><mi>u</mi><mi>β</mi></msup></mrow><annotation encoding=\"application/x-tex\">t = s^{\\alpha} \\times u^{\\beta}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.61508em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7977219999999999em;vertical-align:-0.08333em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7143919999999999em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.0037em;\">α</span></span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8991079999999999em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">u</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8991079999999999em;\"><span style=\"top:-3.1130000000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05278em;\">β</span></span></span></span></span></span></span></span></span></span></span></span></span></p>\n<p><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>s</mi></mrow><annotation encoding=\"application/x-tex\">s</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">s</span></span></span></span> 分类得分：</strong> 这个点预测出的类别对不对？概率高不高？</p>\n<p><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>u</mi></mrow><annotation encoding=\"application/x-tex\">u</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">u</span></span></span></span> 定位得分：</strong> 这个点用 DFL 预测出来的框，跟真实物体的框重合度高不高？</p>\n<p><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>α</mi><mo separator=\"true\">,</mo><mi>β</mi></mrow><annotation encoding=\"application/x-tex\">\\alpha, \\beta</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">α</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05278em;\">β</span></span></span></span>：</strong> 权重参数，用来平衡分类和定位的重要性。</p>\n<p>第一步，初步筛选：首先，模型会设定一个范围。只有落入物体<strong>真实框内</strong>的中心点，才有资格参加海选。</p>\n<p>第二步，动态打分：对所有入围的点，根据上面的公式计算得分 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">t</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.61508em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">t</span></span></span></span>。</p>\n<ul>\n<li>如果一个点在物体的边缘，它预测的框可能很歪，得分就低。</li>\n<li>如果一个点在物体的正中心，它预测的框通常很准，得分就高。</li>\n</ul>\n<p>第三步，择优录取：</p>\n<p>对于每一个真实物体，TAL 会选择得分最高的 <strong>前 K 个点</strong> 作为正样本。</p>\n<ul>\n<li><strong>正样本</strong>：负责计算分类损失、IoU 损失和 DFL 损失。</li>\n<li><strong>负样本</strong>：剩下的所有</li>\n</ul>\n<h2 id=\"损失函数\"><a class=\"markdownIt-Anchor\" href=\"#损失函数\">#</a> 损失函数</h2>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>L</mi><mi>o</mi><mi>s</mi><msub><mi>s</mi><mrow><mi>t</mi><mi>o</mi><mi>t</mi><mi>a</mi><mi>l</mi></mrow></msub><mo>=</mo><msub><mi>λ</mi><mn>1</mn></msub><msub><mi mathvariant=\"script\">L</mi><mrow><mi>c</mi><mi>l</mi><mi>s</mi></mrow></msub><mo>+</mo><msub><mi>λ</mi><mn>2</mn></msub><msub><mi mathvariant=\"script\">L</mi><mrow><mi>i</mi><mi>o</mi><mi>u</mi></mrow></msub><mo>+</mo><msub><mi>λ</mi><mn>3</mn></msub><msub><mi mathvariant=\"script\">L</mi><mrow><mi>d</mi><mi>f</mi><mi>l</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">Loss_{total} = \\lambda_{1} \\mathcal{L}_{cls} + \\lambda_{2} \\mathcal{L}_{iou} + \\lambda_{3} \\mathcal{L}_{dfl}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\">L</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">s</span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathcal\">L</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal mtight\">s</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathcal\">L</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">u</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.980548em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">3</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathcal\">L</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">d</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span></span></p>\n<p><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi mathvariant=\"script\">L</mi><mrow><mi>c</mi><mi>l</mi><mi>s</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathcal{L}_{cls}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathcal\">L</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal mtight\">s</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 分类损失</strong>：用的是 VFL，<strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi mathvariant=\"script\">L</mi><mrow><mi>i</mi><mi>o</mi><mi>u</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathcal{L}_{iou}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathcal\">L</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">u</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 定位损失</strong>：用的是 CIoU，<strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi mathvariant=\"script\">L</mi><mrow><mi>d</mi><mi>f</mi><mi>l</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\mathcal{L}_{dfl}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathcal\">L</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">d</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span></strong>：用的是 DFL。</p>\n<h1 id=\"参考\"><a class=\"markdownIt-Anchor\" href=\"#参考\">#</a> 参考</h1>\n<ol>\n<li>【yolov8 目标检测原理与实战】<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL0JWMTlucmJZakV5Tg==\">https://www.bilibili.com/video/BV19nrbYjEyN</span></li>\n<li>【ultralytics doc】<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLnVsdHJhbHl0aWNzLmNvbS8=\">https://docs.ultralytics.com/</span></li>\n<li>【conda】<span class=\"exturl\" data-url=\"aHR0cHM6Ly9hbmFjb25kYS5vcmcvY2hhbm5lbHMvY29uZGEtZm9yZ2UvcGFja2FnZXMvdWx0cmFseXRpY3Mvb3ZlcnZpZXc=\">https://anaconda.org/channels/conda-forge/packages/ultralytics/overview</span></li>\n</ol>\n",
            "tags": [
                "深度学习",
                "YOLO",
                "python",
                "CNN",
                "深度学习",
                "YOLO"
            ]
        },
        {
            "id": "https://735690757.github.io/python/YOLO/YOLO_V7/",
            "url": "https://735690757.github.io/python/YOLO/YOLO_V7/",
            "title": "YOLO-V7 with WongKinYiu YOLOv7模型源码解析",
            "date_published": "2026-01-17T04:12:12.000Z",
            "content_html": "<h1 id=\"yolov7-with-wongkinyiu-yolov7\"><a class=\"markdownIt-Anchor\" href=\"#yolov7-with-wongkinyiu-yolov7\">#</a> YOLOv7 with WongKinYiu YOLOv7</h1>\n<blockquote>\n<p>什么是 YOLOv7，为什么它被认为是实时<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cudWx0cmFseXRpY3MuY29tL2dsb3NzYXJ5L29iamVjdC1kZXRlY3Rpb24=\">目标检测</span>领域的一项突破？</p>\n<p>YOLOv7 于 2022 年 7 月发布，是一款重要的实时目标检测模型，在发布时实现了卓越的速度和精度。它在参数使用和推理速度方面均超越了 YOLOX、YOLOv5 和 PPYOLOE 等同期模型。YOLOv7 的显著特点包括其模型重参数化和动态标签分配，这些优化在不增加推理成本的情况下提升了其性能。有关其架构以及与其他最先进目标检测器比较指标的更多技术细节，请参阅 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9hcnhpdi5vcmcvcGRmLzIyMDcuMDI2OTY=\">YOLOv7 论文</span>。</p>\n<p>YOLOv7 如何改进 YOLOv4 和 YOLOv5 等之前的 YOLO 模型？</p>\n<p>YOLOv7 引入了多项创新，包括模型重参数化和动态标签分配，这些创新增强了训练过程并提高了推理精度。与 YOLOv5 相比，YOLOv7 显著提升了速度和精度。例如，与 YOLOv5-X 相比，YOLOv7-X 的精度提高了 2.2%，参数量减少了 22%。详细比较可在性能表<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLnVsdHJhbHl0aWNzLmNvbS96aC9tb2RlbHMveW9sb3Y3LyNjb21wYXJpc29uLW9mLXNvdGEtb2JqZWN0LWRldGVjdG9ycw==\"> “YOLOv7 与 SOTA 目标检测器比较”</span> 中找到。****</p>\n</blockquote>\n<h2 id=\"原文\"><a class=\"markdownIt-Anchor\" href=\"#原文\">#</a> 原文</h2>\n<p>【YOLOv7: Trainable bag-of-freebies sets new state-of-the-art for real-time object detectors】：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9hcnhpdi5vcmcvYWJzLzIyMDcuMDI2OTY=\">https://arxiv.org/abs/2207.02696</span></p>\n<h2 id=\"克隆源码并安装\"><a class=\"markdownIt-Anchor\" href=\"#克隆源码并安装\">#</a> 克隆源码并安装</h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">git</span> clone https://github.com/WongKinYiu/yolov7</pre></td></tr></table></figure><figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> yolov7</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>pip <span class=\"token function\">install</span> <span class=\"token parameter variable\">-r</span> requirements.txt</pre></td></tr></table></figure><h2 id=\"检测\"><a class=\"markdownIt-Anchor\" href=\"#检测\">#</a> 检测</h2>\n<p>修改两处直接运行：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>parser<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span><span class=\"token string\">'--source'</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span> default<span class=\"token operator\">=</span><span class=\"token string\">'0'</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">help</span><span class=\"token operator\">=</span><span class=\"token string\">'source'</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># file/folder, 0 for webcam</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>parser<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span><span class=\"token string\">'--img-size'</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> default<span class=\"token operator\">=</span><span class=\"token number\">320</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">help</span><span class=\"token operator\">=</span><span class=\"token string\">'inference size (pixels)'</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h2 id=\"看看模型\"><a class=\"markdownIt-Anchor\" href=\"#看看模型\">#</a> 看看模型</h2>\n<p>以下基于 yolov7.yaml</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span>  n    params  module                                  arguments                     </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token number\">0</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>       <span class=\"token number\">928</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">32</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                 </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token number\">1</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>     <span class=\"token number\">18560</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">32</span><span class=\"token punctuation\">,</span> <span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span>                </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token number\">2</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>     <span class=\"token number\">36992</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token number\">3</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>     <span class=\"token number\">73984</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span>               </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token number\">4</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>      <span class=\"token number\">8320</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>               </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token number\">5</span>                <span class=\"token operator\">-</span><span class=\"token number\">2</span>  <span class=\"token number\">1</span>      <span class=\"token number\">8320</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>               </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token number\">6</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>     <span class=\"token number\">36992</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token number\">7</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>     <span class=\"token number\">36992</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token number\">8</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>     <span class=\"token number\">36992</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token number\">9</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>     <span class=\"token number\">36992</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                </pre></td></tr><tr><td data-num=\"12\"></td><td><pre> <span class=\"token number\">10</span>  <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span>  <span class=\"token number\">1</span>         <span class=\"token number\">0</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Concat                    <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                           </pre></td></tr><tr><td data-num=\"13\"></td><td><pre> <span class=\"token number\">11</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>     <span class=\"token number\">66048</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"14\"></td><td><pre> <span class=\"token number\">12</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>         <span class=\"token number\">0</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>MP                        <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>                            </pre></td></tr><tr><td data-num=\"15\"></td><td><pre> <span class=\"token number\">13</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>     <span class=\"token number\">33024</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"16\"></td><td><pre> <span class=\"token number\">14</span>                <span class=\"token operator\">-</span><span class=\"token number\">3</span>  <span class=\"token number\">1</span>     <span class=\"token number\">33024</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"17\"></td><td><pre> <span class=\"token number\">15</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">147712</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"18\"></td><td><pre> <span class=\"token number\">16</span>          <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span>  <span class=\"token number\">1</span>         <span class=\"token number\">0</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Concat                    <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                           </pre></td></tr><tr><td data-num=\"19\"></td><td><pre> <span class=\"token number\">17</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>     <span class=\"token number\">33024</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"20\"></td><td><pre> <span class=\"token number\">18</span>                <span class=\"token operator\">-</span><span class=\"token number\">2</span>  <span class=\"token number\">1</span>     <span class=\"token number\">33024</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"21\"></td><td><pre> <span class=\"token number\">19</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">147712</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"22\"></td><td><pre> <span class=\"token number\">20</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">147712</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"23\"></td><td><pre> <span class=\"token number\">21</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">147712</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"24\"></td><td><pre> <span class=\"token number\">22</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">147712</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"25\"></td><td><pre> <span class=\"token number\">23</span>  <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span>  <span class=\"token number\">1</span>         <span class=\"token number\">0</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Concat                    <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                           </pre></td></tr><tr><td data-num=\"26\"></td><td><pre> <span class=\"token number\">24</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">263168</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"27\"></td><td><pre> <span class=\"token number\">25</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>         <span class=\"token number\">0</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>MP                        <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>                            </pre></td></tr><tr><td data-num=\"28\"></td><td><pre> <span class=\"token number\">26</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">131584</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"29\"></td><td><pre> <span class=\"token number\">27</span>                <span class=\"token operator\">-</span><span class=\"token number\">3</span>  <span class=\"token number\">1</span>    <span class=\"token number\">131584</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"30\"></td><td><pre> <span class=\"token number\">28</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">590336</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"31\"></td><td><pre> <span class=\"token number\">29</span>          <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span>  <span class=\"token number\">1</span>         <span class=\"token number\">0</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Concat                    <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                           </pre></td></tr><tr><td data-num=\"32\"></td><td><pre> <span class=\"token number\">30</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">131584</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"33\"></td><td><pre> <span class=\"token number\">31</span>                <span class=\"token operator\">-</span><span class=\"token number\">2</span>  <span class=\"token number\">1</span>    <span class=\"token number\">131584</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"34\"></td><td><pre> <span class=\"token number\">32</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">590336</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"35\"></td><td><pre> <span class=\"token number\">33</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">590336</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"36\"></td><td><pre> <span class=\"token number\">34</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">590336</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"37\"></td><td><pre> <span class=\"token number\">35</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">590336</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"38\"></td><td><pre> <span class=\"token number\">36</span>  <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span>  <span class=\"token number\">1</span>         <span class=\"token number\">0</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Concat                    <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                           </pre></td></tr><tr><td data-num=\"39\"></td><td><pre> <span class=\"token number\">37</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>   <span class=\"token number\">1050624</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>            </pre></td></tr><tr><td data-num=\"40\"></td><td><pre> <span class=\"token number\">38</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>         <span class=\"token number\">0</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>MP                        <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>                            </pre></td></tr><tr><td data-num=\"41\"></td><td><pre> <span class=\"token number\">39</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">525312</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>             </pre></td></tr><tr><td data-num=\"42\"></td><td><pre> <span class=\"token number\">40</span>                <span class=\"token operator\">-</span><span class=\"token number\">3</span>  <span class=\"token number\">1</span>    <span class=\"token number\">525312</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>             </pre></td></tr><tr><td data-num=\"43\"></td><td><pre> <span class=\"token number\">41</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>   <span class=\"token number\">2360320</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"44\"></td><td><pre> <span class=\"token number\">42</span>          <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span>  <span class=\"token number\">1</span>         <span class=\"token number\">0</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Concat                    <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                           </pre></td></tr><tr><td data-num=\"45\"></td><td><pre> <span class=\"token number\">43</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">262656</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>             </pre></td></tr><tr><td data-num=\"46\"></td><td><pre> <span class=\"token number\">44</span>                <span class=\"token operator\">-</span><span class=\"token number\">2</span>  <span class=\"token number\">1</span>    <span class=\"token number\">262656</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>             </pre></td></tr><tr><td data-num=\"47\"></td><td><pre> <span class=\"token number\">45</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">590336</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"48\"></td><td><pre> <span class=\"token number\">46</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">590336</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"49\"></td><td><pre> <span class=\"token number\">47</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">590336</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"50\"></td><td><pre> <span class=\"token number\">48</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">590336</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"51\"></td><td><pre> <span class=\"token number\">49</span>  <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span>  <span class=\"token number\">1</span>         <span class=\"token number\">0</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Concat                    <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                           </pre></td></tr><tr><td data-num=\"52\"></td><td><pre> <span class=\"token number\">50</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>   <span class=\"token number\">1050624</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>            </pre></td></tr><tr><td data-num=\"53\"></td><td><pre> <span class=\"token number\">51</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>   <span class=\"token number\">7609344</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>SPPCSPC                   <span class=\"token punctuation\">[</span><span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                </pre></td></tr><tr><td data-num=\"54\"></td><td><pre> <span class=\"token number\">52</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">131584</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"55\"></td><td><pre> <span class=\"token number\">53</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>         <span class=\"token number\">0</span>  torch<span class=\"token punctuation\">.</span>nn<span class=\"token punctuation\">.</span>modules<span class=\"token punctuation\">.</span>upsampling<span class=\"token punctuation\">.</span>Upsample    <span class=\"token punctuation\">[</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'nearest'</span><span class=\"token punctuation\">]</span>          </pre></td></tr><tr><td data-num=\"56\"></td><td><pre> <span class=\"token number\">54</span>                <span class=\"token number\">37</span>  <span class=\"token number\">1</span>    <span class=\"token number\">262656</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>             </pre></td></tr><tr><td data-num=\"57\"></td><td><pre> <span class=\"token number\">55</span>          <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span>  <span class=\"token number\">1</span>         <span class=\"token number\">0</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Concat                    <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                           </pre></td></tr><tr><td data-num=\"58\"></td><td><pre> <span class=\"token number\">56</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">131584</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"59\"></td><td><pre> <span class=\"token number\">57</span>                <span class=\"token operator\">-</span><span class=\"token number\">2</span>  <span class=\"token number\">1</span>    <span class=\"token number\">131584</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"60\"></td><td><pre> <span class=\"token number\">58</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">295168</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"61\"></td><td><pre> <span class=\"token number\">59</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">147712</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"62\"></td><td><pre> <span class=\"token number\">60</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">147712</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"63\"></td><td><pre> <span class=\"token number\">61</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">147712</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"64\"></td><td><pre> <span class=\"token number\">62</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span>  <span class=\"token number\">1</span>         <span class=\"token number\">0</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Concat                    <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                           </pre></td></tr><tr><td data-num=\"65\"></td><td><pre> <span class=\"token number\">63</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">262656</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>             </pre></td></tr><tr><td data-num=\"66\"></td><td><pre> <span class=\"token number\">64</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>     <span class=\"token number\">33024</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"67\"></td><td><pre> <span class=\"token number\">65</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>         <span class=\"token number\">0</span>  torch<span class=\"token punctuation\">.</span>nn<span class=\"token punctuation\">.</span>modules<span class=\"token punctuation\">.</span>upsampling<span class=\"token punctuation\">.</span>Upsample    <span class=\"token punctuation\">[</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'nearest'</span><span class=\"token punctuation\">]</span>          </pre></td></tr><tr><td data-num=\"68\"></td><td><pre> <span class=\"token number\">66</span>                <span class=\"token number\">24</span>  <span class=\"token number\">1</span>     <span class=\"token number\">65792</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"69\"></td><td><pre> <span class=\"token number\">67</span>          <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span>  <span class=\"token number\">1</span>         <span class=\"token number\">0</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Concat                    <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                           </pre></td></tr><tr><td data-num=\"70\"></td><td><pre> <span class=\"token number\">68</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>     <span class=\"token number\">33024</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"71\"></td><td><pre> <span class=\"token number\">69</span>                <span class=\"token operator\">-</span><span class=\"token number\">2</span>  <span class=\"token number\">1</span>     <span class=\"token number\">33024</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"72\"></td><td><pre> <span class=\"token number\">70</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>     <span class=\"token number\">73856</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>               </pre></td></tr><tr><td data-num=\"73\"></td><td><pre> <span class=\"token number\">71</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>     <span class=\"token number\">36992</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                </pre></td></tr><tr><td data-num=\"74\"></td><td><pre> <span class=\"token number\">72</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>     <span class=\"token number\">36992</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                </pre></td></tr><tr><td data-num=\"75\"></td><td><pre> <span class=\"token number\">73</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>     <span class=\"token number\">36992</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                </pre></td></tr><tr><td data-num=\"76\"></td><td><pre> <span class=\"token number\">74</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span>  <span class=\"token number\">1</span>         <span class=\"token number\">0</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Concat                    <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                           </pre></td></tr><tr><td data-num=\"77\"></td><td><pre> <span class=\"token number\">75</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>     <span class=\"token number\">65792</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"78\"></td><td><pre> <span class=\"token number\">76</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>         <span class=\"token number\">0</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>MP                        <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>                            </pre></td></tr><tr><td data-num=\"79\"></td><td><pre> <span class=\"token number\">77</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>     <span class=\"token number\">16640</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"80\"></td><td><pre> <span class=\"token number\">78</span>                <span class=\"token operator\">-</span><span class=\"token number\">3</span>  <span class=\"token number\">1</span>     <span class=\"token number\">16640</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"81\"></td><td><pre> <span class=\"token number\">79</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">147712</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"82\"></td><td><pre> <span class=\"token number\">80</span>      <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">63</span><span class=\"token punctuation\">]</span>  <span class=\"token number\">1</span>         <span class=\"token number\">0</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Concat                    <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                           </pre></td></tr><tr><td data-num=\"83\"></td><td><pre> <span class=\"token number\">81</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">131584</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"84\"></td><td><pre> <span class=\"token number\">82</span>                <span class=\"token operator\">-</span><span class=\"token number\">2</span>  <span class=\"token number\">1</span>    <span class=\"token number\">131584</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"85\"></td><td><pre> <span class=\"token number\">83</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">295168</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"86\"></td><td><pre> <span class=\"token number\">84</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">147712</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"87\"></td><td><pre> <span class=\"token number\">85</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">147712</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"88\"></td><td><pre> <span class=\"token number\">86</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">147712</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"89\"></td><td><pre> <span class=\"token number\">87</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span>  <span class=\"token number\">1</span>         <span class=\"token number\">0</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Concat                    <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                           </pre></td></tr><tr><td data-num=\"90\"></td><td><pre> <span class=\"token number\">88</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">262656</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>             </pre></td></tr><tr><td data-num=\"91\"></td><td><pre> <span class=\"token number\">89</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>         <span class=\"token number\">0</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>MP                        <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>                            </pre></td></tr><tr><td data-num=\"92\"></td><td><pre> <span class=\"token number\">90</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>     <span class=\"token number\">66048</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"93\"></td><td><pre> <span class=\"token number\">91</span>                <span class=\"token operator\">-</span><span class=\"token number\">3</span>  <span class=\"token number\">1</span>     <span class=\"token number\">66048</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"94\"></td><td><pre> <span class=\"token number\">92</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">590336</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"95\"></td><td><pre> <span class=\"token number\">93</span>      <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">51</span><span class=\"token punctuation\">]</span>  <span class=\"token number\">1</span>         <span class=\"token number\">0</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Concat                    <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                           </pre></td></tr><tr><td data-num=\"96\"></td><td><pre> <span class=\"token number\">94</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">525312</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>             </pre></td></tr><tr><td data-num=\"97\"></td><td><pre> <span class=\"token number\">95</span>                <span class=\"token operator\">-</span><span class=\"token number\">2</span>  <span class=\"token number\">1</span>    <span class=\"token number\">525312</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>             </pre></td></tr><tr><td data-num=\"98\"></td><td><pre> <span class=\"token number\">96</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>   <span class=\"token number\">1180160</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"99\"></td><td><pre> <span class=\"token number\">97</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">590336</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"100\"></td><td><pre> <span class=\"token number\">98</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">590336</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"101\"></td><td><pre> <span class=\"token number\">99</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">590336</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"102\"></td><td><pre><span class=\"token number\">100</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span>  <span class=\"token number\">1</span>         <span class=\"token number\">0</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Concat                    <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                           </pre></td></tr><tr><td data-num=\"103\"></td><td><pre><span class=\"token number\">101</span>                <span class=\"token operator\">-</span><span class=\"token number\">1</span>  <span class=\"token number\">1</span>   <span class=\"token number\">1049600</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">2048</span><span class=\"token punctuation\">,</span> <span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>             </pre></td></tr><tr><td data-num=\"104\"></td><td><pre><span class=\"token number\">102</span>                <span class=\"token number\">75</span>  <span class=\"token number\">1</span>    <span class=\"token number\">328704</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>RepConv                   <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"105\"></td><td><pre><span class=\"token number\">103</span>                <span class=\"token number\">88</span>  <span class=\"token number\">1</span>   <span class=\"token number\">1312768</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>RepConv                   <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"106\"></td><td><pre><span class=\"token number\">104</span>               <span class=\"token number\">101</span>  <span class=\"token number\">1</span>   <span class=\"token number\">5246976</span>  models<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>RepConv                   <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>             </pre></td></tr><tr><td data-num=\"107\"></td><td><pre><span class=\"token number\">105</span>   <span class=\"token punctuation\">[</span><span class=\"token number\">102</span><span class=\"token punctuation\">,</span> <span class=\"token number\">103</span><span class=\"token punctuation\">,</span> <span class=\"token number\">104</span><span class=\"token punctuation\">]</span>  <span class=\"token number\">1</span>    <span class=\"token number\">460282</span>  IDetect                                 <span class=\"token punctuation\">[</span><span class=\"token number\">80</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">12</span><span class=\"token punctuation\">,</span> <span class=\"token number\">16</span><span class=\"token punctuation\">,</span> <span class=\"token number\">19</span><span class=\"token punctuation\">,</span> <span class=\"token number\">36</span><span class=\"token punctuation\">,</span> <span class=\"token number\">40</span><span class=\"token punctuation\">,</span> <span class=\"token number\">28</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">36</span><span class=\"token punctuation\">,</span> <span class=\"token number\">75</span><span class=\"token punctuation\">,</span> <span class=\"token number\">76</span><span class=\"token punctuation\">,</span> <span class=\"token number\">55</span><span class=\"token punctuation\">,</span> <span class=\"token number\">72</span><span class=\"token punctuation\">,</span> <span class=\"token number\">146</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">142</span><span class=\"token punctuation\">,</span> <span class=\"token number\">110</span><span class=\"token punctuation\">,</span> <span class=\"token number\">192</span><span class=\"token punctuation\">,</span> <span class=\"token number\">243</span><span class=\"token punctuation\">,</span> <span class=\"token number\">459</span><span class=\"token punctuation\">,</span> <span class=\"token number\">401</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1024</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># parameters</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">nc</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>  <span class=\"token comment\"># number of classes</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">depth_multiple</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1.0</span>  <span class=\"token comment\"># model depth multiple</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token key atrule\">width_multiple</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1.0</span>  <span class=\"token comment\"># layer channel multiple</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># anchors</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token key atrule\">anchors</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">[</span><span class=\"token number\">12</span><span class=\"token punctuation\">,</span><span class=\"token number\">16</span><span class=\"token punctuation\">,</span> <span class=\"token number\">19</span><span class=\"token punctuation\">,</span><span class=\"token number\">36</span><span class=\"token punctuation\">,</span> <span class=\"token number\">40</span><span class=\"token punctuation\">,</span><span class=\"token number\">28</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\"># P3/8</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">[</span><span class=\"token number\">36</span><span class=\"token punctuation\">,</span><span class=\"token number\">75</span><span class=\"token punctuation\">,</span> <span class=\"token number\">76</span><span class=\"token punctuation\">,</span><span class=\"token number\">55</span><span class=\"token punctuation\">,</span> <span class=\"token number\">72</span><span class=\"token punctuation\">,</span><span class=\"token number\">146</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\"># P4/16</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">[</span><span class=\"token number\">142</span><span class=\"token punctuation\">,</span><span class=\"token number\">110</span><span class=\"token punctuation\">,</span> <span class=\"token number\">192</span><span class=\"token punctuation\">,</span><span class=\"token number\">243</span><span class=\"token punctuation\">,</span> <span class=\"token number\">459</span><span class=\"token punctuation\">,</span><span class=\"token number\">401</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\"># P5/32</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># yolov7 backbone</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token key atrule\">backbone</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\"># [from, number, module, args]</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">32</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 0</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 1-P1/2      </span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 3-P2/4  </span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Concat<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 11</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>         </pre></td></tr><tr><td data-num=\"30\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> MP<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Concat<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 16-P3/8  </span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Concat<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 24</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>         </pre></td></tr><tr><td data-num=\"44\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> MP<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Concat<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 29-P4/16  </span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Concat<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 37</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>         </pre></td></tr><tr><td data-num=\"58\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> MP<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Concat<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 42-P5/32  </span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Concat<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 50</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre><span class=\"token comment\"># yolov7 head</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre><span class=\"token key atrule\">head</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> SPPCSPC<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\"># 51</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"77\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> nn.Upsample<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>None<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'nearest'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">37</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\"># route backbone P4</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Concat<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>   </pre></td></tr><tr><td data-num=\"82\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Concat<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\"># 63</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>   </pre></td></tr><tr><td data-num=\"91\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> nn.Upsample<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>None<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'nearest'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">24</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\"># route backbone P3</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Concat<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>   </pre></td></tr><tr><td data-num=\"96\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Concat<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\"># 75</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>      </pre></td></tr><tr><td data-num=\"105\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> MP<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">63</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Concat<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>   </pre></td></tr><tr><td data-num=\"111\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Concat<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\"># 88</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>      </pre></td></tr><tr><td data-num=\"120\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> MP<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">51</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Concat<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>   </pre></td></tr><tr><td data-num=\"126\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Concat<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\"># 101</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>   </pre></td></tr><tr><td data-num=\"135\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">75</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> RepConv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">88</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> RepConv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token number\">101</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> RepConv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>   <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">102</span><span class=\"token punctuation\">,</span><span class=\"token number\">103</span><span class=\"token punctuation\">,</span><span class=\"token number\">104</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> IDetect<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>nc<span class=\"token punctuation\">,</span> anchors<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>   <span class=\"token comment\"># Detect(P3, P4, P5)</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>  <span class=\"token punctuation\">]</span></pre></td></tr></table></figure><p>其他的我觉得没什么可说了，这里主要解析一下 v7 的特色模块。</p>\n<h3 id=\"autopad\"><a class=\"markdownIt-Anchor\" href=\"#autopad\">#</a> AutoPad</h3>\n<p>这个函数我觉得不错，主要是用于自动计算卷积层的填充值，以实现 输入输出尺寸相同的 **“same” 卷积 **。</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">autopad</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">,</span> p<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># kernel, padding</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\"># Pad to 'same'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">if</span> p <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        p <span class=\"token operator\">=</span> k <span class=\"token operator\">//</span> <span class=\"token number\">2</span> <span class=\"token keyword\">if</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">,</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">[</span>x <span class=\"token operator\">//</span> <span class=\"token number\">2</span> <span class=\"token keyword\">for</span> x <span class=\"token keyword\">in</span> k<span class=\"token punctuation\">]</span>  <span class=\"token comment\"># auto-pad</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">return</span> p</pre></td></tr></table></figure><h3 id=\"autopad-with-dilation\"><a class=\"markdownIt-Anchor\" href=\"#autopad-with-dilation\">#</a> AutoPad with dilation</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">autopad</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">,</span> p<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> d<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># kernel, padding, dilation</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\"># Pad to 'same' shape with dilation</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">if</span> d <span class=\"token operator\">></span> <span class=\"token number\">1</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token comment\"># 实际核大小需要考虑膨胀率</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        k <span class=\"token operator\">=</span> d <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>k <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token keyword\">if</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">,</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">[</span>d <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>x <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token keyword\">for</span> x <span class=\"token keyword\">in</span> k<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">if</span> p <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        p <span class=\"token operator\">=</span> k <span class=\"token operator\">//</span> <span class=\"token number\">2</span> <span class=\"token keyword\">if</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">,</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">[</span>x <span class=\"token operator\">//</span> <span class=\"token number\">2</span> <span class=\"token keyword\">for</span> x <span class=\"token keyword\">in</span> k<span class=\"token punctuation\">]</span>  <span class=\"token comment\"># auto-pad</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">return</span> p</pre></td></tr></table></figure><h3 id=\"elan\"><a class=\"markdownIt-Anchor\" href=\"#elan\">#</a> ELAN</h3>\n<blockquote>\n<p>ELAN 出于以下设计考虑 ——“如何设计一个高效的网络？” 得出结论是：通过控制最短最长梯度路径，更深的网络可以有效地进行学习并更好地收敛。</p>\n</blockquote>\n<img data-src=\"../../../images/python/YOLO/v5/1.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token number\">-2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">-6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Concat<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 11</span></pre></td></tr></table></figure><img data-src=\"../../../images/python/YOLO/v7/1.png\" alt=\"1\" style=\"zoom: 70%;\" />\n<p>严格来说，YOLOv7 使用的是它的升级版本<strong> E-ELAN</strong>，你可以把它理解为 ELAN 的 “增强版”，它们的目标一致，但 E-ELAN 的方法更巧妙。为了让你更清晰地理解它的价值，我把它的作用和实现原理拆解为以下几点：</p>\n<h3 id=\"mpactions\"><a class=\"markdownIt-Anchor\" href=\"#mpactions\">#</a> MpActions</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">MP</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> k<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span>MP<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        self<span class=\"token punctuation\">.</span>m <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>MaxPool2d<span class=\"token punctuation\">(</span>kernel_size<span class=\"token operator\">=</span>k<span class=\"token punctuation\">,</span> stride<span class=\"token operator\">=</span>k<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>m<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><img data-src=\"../../../images/python/YOLO/v7/3.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<h3 id=\"sppcspc\"><a class=\"markdownIt-Anchor\" href=\"#sppcspc\">#</a> SPPCSPC</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">SPPCSPC</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\"># CSP https://github.com/WongKinYiu/CrossStagePartialNetworks</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> c1<span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">,</span> n<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> shortcut<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> g<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> e<span class=\"token operator\">=</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> k<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">9</span><span class=\"token punctuation\">,</span> <span class=\"token number\">13</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span>SPPCSPC<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        c_ <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> c2 <span class=\"token operator\">*</span> e<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># hidden channels</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv1 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span>c1<span class=\"token punctuation\">,</span> c_<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv2 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span>c1<span class=\"token punctuation\">,</span> c_<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv3 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span>c_<span class=\"token punctuation\">,</span> c_<span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv4 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span>c_<span class=\"token punctuation\">,</span> c_<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        self<span class=\"token punctuation\">.</span>m <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>ModuleList<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>nn<span class=\"token punctuation\">.</span>MaxPool2d<span class=\"token punctuation\">(</span>kernel_size<span class=\"token operator\">=</span>x<span class=\"token punctuation\">,</span> stride<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> padding<span class=\"token operator\">=</span>x <span class=\"token operator\">//</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> x <span class=\"token keyword\">in</span> k<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv5 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span><span class=\"token number\">4</span> <span class=\"token operator\">*</span> c_<span class=\"token punctuation\">,</span> c_<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv6 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span>c_<span class=\"token punctuation\">,</span> c_<span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv7 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> c_<span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        x1 <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>cv4<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>cv3<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>cv1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        y1 <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>cv6<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>cv5<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>x1<span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">[</span>m<span class=\"token punctuation\">(</span>x1<span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> m <span class=\"token keyword\">in</span> self<span class=\"token punctuation\">.</span>m<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        y2 <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>cv2<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>cv7<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>y1<span class=\"token punctuation\">,</span> y2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> dim<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>这里挺妙的：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>nn<span class=\"token punctuation\">.</span>ModuleList<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>nn<span class=\"token punctuation\">.</span>MaxPool2d<span class=\"token punctuation\">(</span>kernel_size<span class=\"token operator\">=</span>x<span class=\"token punctuation\">,</span> stride<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> padding<span class=\"token operator\">=</span>x <span class=\"token operator\">//</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> x <span class=\"token keyword\">in</span> k<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>这个池化操作当且仅当 x 是大于 1 的奇数时，输出不会改变特征图大小。</p>\n<p>由尺寸计算公式： <code>HO = (H + 2P - K) // S + 1</code> ，当  <code>p=x//2</code>  且 <code>x</code>  是奇数时， <code>p=x//2=x-1</code> ，此时 <code>HO = (H + 2P - K) // S + 1 = [(H + x - 1 - x) / 1] + 1 = H</code> ，所以 <code>HO = H</code> 。</p>\n<img data-src=\"../../../images/python/YOLO/v7/4.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<h3 id=\"elan-fc\"><a class=\"markdownIt-Anchor\" href=\"#elan-fc\">#</a> ELAN-FC</h3>\n<p>这个变体的核心是更复杂的特征融合，核心在于创建了更多不同深度的梯度传播路径，训练时梯度能更好地反向传播，网络能同时利用浅层的细节和深层的语义，有点 UNet 的味道。</p>\n<img data-src=\"../../../images/python/YOLO/v7/5.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<h3 id=\"repconv\"><a class=\"markdownIt-Anchor\" href=\"#repconv\">#</a> RepConv</h3>\n<p>RepConv 是我认为 YOLOv7 最有意思的改进。</p>\n<img data-src=\"../../../images/python/YOLO/v7/6.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<p>在训练阶段，RepConv 会构建一个复杂的多分支网络。它通常并行地包含 3x3 卷积、1x1 卷积，有时还会加上恒等连接。当模型训练完成，准备部署时，神奇的 “重参数化” 就发生了。通过一系列的变换，这个复杂的三分支结构会无损地融合成一个<strong>单一的 3x3 卷积层</strong>。</p>\n<p>如果在 RepConv 中保留恒等连接分支，模型性能会下降。恒等连接会让梯度直接流过，与其他分支的梯度相互干扰，YOLOv7 中，作者最终采用了不带恒等连接的 RepConv。</p>\n<h3 id=\"yolov7w6-reorg\"><a class=\"markdownIt-Anchor\" href=\"#yolov7w6-reorg\">#</a> YOLOv7w6-ReOrg</h3>\n<p>Reorg 是一种 特征图重排操作，牺牲空间分辨率，换取通道维度，把细节信息 “压缩” 进通道里</p>\n<p>假设输入特征图是：[B, C, H, W]，经过 Reorg-stride=2 后变成：[B, 4C, H/2, W/2] 也就是：高宽减半，通道数 ×4，不丢信息，只是重排。</p>\n<img data-src=\"../../../images/python/YOLO/v7/7.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<p>在现在的 YOLO 系列里，Focus 基本可以认为没什么用了，甚至是被明确淘汰的设计。YOLOv7-w6-ReOrg 属于论文可写、工程慎用的改动。ReOrg 是有提升的，但提升很有限。</p>\n<h3 id=\"分组卷积\"><a class=\"markdownIt-Anchor\" href=\"#分组卷积\">#</a> 分组卷积</h3>\n<p>普通卷积：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>conv <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    in_channels<span class=\"token operator\">=</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    out_channels<span class=\"token operator\">=</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    kernel_size<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    stride<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    padding<span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>分组卷积：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>conv <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    in_channels<span class=\"token operator\">=</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    out_channels<span class=\"token operator\">=</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    kernel_size<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    stride<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    padding<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    groups<span class=\"token operator\">=</span><span class=\"token number\">4</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>我推荐这样写：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">GroupConv</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> c1<span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">,</span> k<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> s<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> g<span class=\"token operator\">=</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        self<span class=\"token punctuation\">.</span>conv <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            c1<span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">,</span> k<span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            padding<span class=\"token operator\">=</span>k <span class=\"token operator\">//</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            groups<span class=\"token operator\">=</span>g<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            bias<span class=\"token operator\">=</span><span class=\"token boolean\">False</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        self<span class=\"token punctuation\">.</span>bn <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>BatchNorm2d<span class=\"token punctuation\">(</span>c2<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        self<span class=\"token punctuation\">.</span>act <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>SiLU<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>act<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>bn<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>conv<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>不要乱设 groups：</p>\n<pre><code>Conv2d(64, 128, 3, groups=8)  # 64 % 8 可以，但 128 % 8 也必须可以\n</code></pre>\n<p>小通道不要用 group</p>\n<pre><code>Conv2d(32, 32, 3, groups=4)  # 很容易掉精度\n</code></pre>\n<hr>\n<p>不要连续 group conv</p>\n<pre><code>GroupConv → GroupConv → GroupConv  ❌\n</code></pre>\n<p>中间<strong>一定要</strong>有  <code>1×1 Conv</code></p>\n<p>backbone 前几层不要用用 group，因为特征太原始，这回直接限制表达能力。</p>\n<p>group 不是 提升精度，它是省算力，不是涨 mAP 的神器。</p>\n<h3 id=\"e-elan\"><a class=\"markdownIt-Anchor\" href=\"#e-elan\">#</a> E-ELAN</h3>\n<img data-src=\"../../../images/python/YOLO/v7/2.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<h1 id=\"参考\"><a class=\"markdownIt-Anchor\" href=\"#参考\">#</a> 参考</h1>\n<ol>\n<li>【yolov7 目标检测原理与实战】：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL0JWMVFlQ1ZZdUVleA==\">https://www.bilibili.com/video/BV1QeCVYuEex</span></li>\n<li>【这是一篇对 YOLOv7 的详细解读和剖析】：<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC81NDAwNjgwOTk=\">https://zhuanlan.zhihu.com/p/540068099</span></li>\n</ol>\n",
            "tags": [
                "深度学习",
                "YOLO",
                "python",
                "CNN",
                "深度学习",
                "YOLO"
            ]
        },
        {
            "id": "https://735690757.github.io/python/YOLO/YOLO_V5/",
            "url": "https://735690757.github.io/python/YOLO/YOLO_V5/",
            "title": "YOLO-V5 with Ultralytics YOLOv5源码解析",
            "date_published": "2026-01-16T04:12:12.000Z",
            "content_html": "<h1 id=\"yolov5-with-ultralytics-yolov5源码解析\"><a class=\"markdownIt-Anchor\" href=\"#yolov5-with-ultralytics-yolov5源码解析\">#</a> YOLOv5 with Ultralytics YOLOv5 源码解析</h1>\n<h2 id=\"工程实现\"><a class=\"markdownIt-Anchor\" href=\"#工程实现\">#</a> 工程实现</h2>\n<p>【ultralytics-YOLOv5】：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3VsdHJhbHl0aWNzL3lvbG92NQ==\">https://github.com/ultralytics/yolov5</span></p>\n<h2 id=\"引言\"><a class=\"markdownIt-Anchor\" href=\"#引言\">#</a> 引言</h2>\n<p>本篇文章将一改往日风格，先从工程部署再到细节讨论。YOLOv5 之所以能成为很多工程师的首选，不仅是因为它性能强悍，更因为它在工程化上的极致友好：从环境配置、自动锚框计算到多平台导出，几乎做到了开箱即用。</p>\n<p>我身为软件工程专业的学生，我想说 YOLOv5 真正打动我的，并不是那几项漂亮的 mAP 指标，而是它背后那种工程优先的设计思维。</p>\n<p>在很多传统的深度学习项目中，我们常常会遇到这样的情况：论文很好看，模型结构也很优雅，但一到实际部署阶段，各种环境依赖冲突、版本问题、导出失败、推理速度不稳定接踵而至。而 YOLOv5 给我的感觉更像是一个 “成熟的后端项目”—— 结构清晰、模块解耦、配置集中管理，甚至连日志输出和参数管理都做得非常规范。</p>\n<p>如果用我们熟悉的 SpringBoot 思维去类比：</p>\n<ul>\n<li><code>train.py</code>  像是启动类</li>\n<li><code>models/</code>  目录像是核心业务模块</li>\n<li><code>utils/</code>  像是工具类封装层</li>\n<li><code>data.yaml</code>  类似于 application.yml 配置文件</li>\n<li>导出 ONNX / TensorRT 就像是多环境打包部署</li>\n</ul>\n<p>这种工程结构，让人几乎不用反复翻源码，就可以快速定位问题。</p>\n<p>YOLOv5 的脚本里充满了 “自动化” 的影子：</p>\n<ul>\n<li>Auto-Check： 每次运行都会自动检查  <code>requirements</code> ，甚至能自动下载缺失的字体和预训练权重。</li>\n<li>Auto-Anchor： 它深知开发者懒得去算 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>K</mi><mo>−</mo><mi>m</mi><mi>e</mi><mi>a</mi><mi>n</mi><mi>s</mi></mrow><annotation encoding=\"application/x-tex\">K-means</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76666em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">s</span></span></span></span> 聚类，所以内置了基于你私有数据集的 Anchor 自动计算逻辑。</li>\n<li>Logging： 原生集成 Tensorboard，这种可观测性设计是大型工程项目的标配。</li>\n</ul>\n<p>本文致力于从源码出发，剖析模型、训练手段、日志实践、以及各种工程方法，以便用在未来的学术和工程之中，顺便熟悉 Visio 的使用方法，让我们开始吧。</p>\n<h2 id=\"快速开始\"><a class=\"markdownIt-Anchor\" href=\"#快速开始\">#</a> 快速开始</h2>\n<p>从仓库克隆：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">git</span> clone https://github.com/ultralytics/yolov5.git</pre></td></tr></table></figure><p>安装环境，推荐 python3.9，torch2.5.1，pytorch-cuda11.8：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>conda <span class=\"token function\">install</span> <span class=\"token parameter variable\">-c</span> pytorch <span class=\"token parameter variable\">-c</span> nvidia <span class=\"token parameter variable\">-c</span> conda-forge pytorch torchvision pytorch-cuda<span class=\"token operator\">=</span><span class=\"token number\">11.8</span> ultralytics</pre></td></tr></table></figure><p>自动检查：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> torch</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> utils</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>display <span class=\"token operator\">=</span> utils<span class=\"token punctuation\">.</span>notebook_init<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># checks</span></pre></td></tr></table></figure><p>预测：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>python detect.py <span class=\"token parameter variable\">--weights</span> yolov5s.pt <span class=\"token parameter variable\">--img</span> <span class=\"token number\">1000</span> <span class=\"token parameter variable\">--conf</span> <span class=\"token number\">0.25</span> <span class=\"token parameter variable\">--source</span> <span class=\"token number\">0</span></pre></td></tr></table></figure><p>其余验证、训练和可视化可在 tutorial.ipynb 中查看。</p>\n<h2 id=\"看看模型\"><a class=\"markdownIt-Anchor\" href=\"#看看模型\">#</a> 看看模型</h2>\n<p>运行 yolo.py 得到如下结果：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>from  n    params  module                                  arguments                     </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token number\">0</span>                <span class=\"token parameter variable\">-1</span>  <span class=\"token number\">1</span>      <span class=\"token number\">3520</span>  models.common.Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">3</span>, <span class=\"token number\">32</span>, <span class=\"token number\">6</span>, <span class=\"token number\">2</span>, <span class=\"token number\">2</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token number\">1</span>                <span class=\"token parameter variable\">-1</span>  <span class=\"token number\">1</span>     <span class=\"token number\">18560</span>  models.common.Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">32</span>, <span class=\"token number\">64</span>, <span class=\"token number\">3</span>, <span class=\"token number\">2</span><span class=\"token punctuation\">]</span>                </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token number\">2</span>                <span class=\"token parameter variable\">-1</span>  <span class=\"token number\">1</span>     <span class=\"token number\">18816</span>  models.common.C3                        <span class=\"token punctuation\">[</span><span class=\"token number\">64</span>, <span class=\"token number\">64</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                   </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token number\">3</span>                <span class=\"token parameter variable\">-1</span>  <span class=\"token number\">1</span>     <span class=\"token number\">73984</span>  models.common.Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">64</span>, <span class=\"token number\">128</span>, <span class=\"token number\">3</span>, <span class=\"token number\">2</span><span class=\"token punctuation\">]</span>               </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token number\">4</span>                <span class=\"token parameter variable\">-1</span>  <span class=\"token number\">2</span>    <span class=\"token number\">115712</span>  models.common.C3                        <span class=\"token punctuation\">[</span><span class=\"token number\">128</span>, <span class=\"token number\">128</span>, <span class=\"token number\">2</span><span class=\"token punctuation\">]</span>                 </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token number\">5</span>                <span class=\"token parameter variable\">-1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">295424</span>  models.common.Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">128</span>, <span class=\"token number\">256</span>, <span class=\"token number\">3</span>, <span class=\"token number\">2</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token number\">6</span>                <span class=\"token parameter variable\">-1</span>  <span class=\"token number\">3</span>    <span class=\"token number\">625152</span>  models.common.C3                        <span class=\"token punctuation\">[</span><span class=\"token number\">256</span>, <span class=\"token number\">256</span>, <span class=\"token number\">3</span><span class=\"token punctuation\">]</span>                 </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token number\">7</span>                <span class=\"token parameter variable\">-1</span>  <span class=\"token number\">1</span>   <span class=\"token number\">1180672</span>  models.common.Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">256</span>, <span class=\"token number\">512</span>, <span class=\"token number\">3</span>, <span class=\"token number\">2</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token number\">8</span>                <span class=\"token parameter variable\">-1</span>  <span class=\"token number\">1</span>   <span class=\"token number\">1182720</span>  models.common.C3                        <span class=\"token punctuation\">[</span><span class=\"token number\">512</span>, <span class=\"token number\">512</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                 </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token number\">9</span>                <span class=\"token parameter variable\">-1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">656896</span>  models.common.SPPF                      <span class=\"token punctuation\">[</span><span class=\"token number\">512</span>, <span class=\"token number\">512</span>, <span class=\"token number\">5</span><span class=\"token punctuation\">]</span>                 </pre></td></tr><tr><td data-num=\"12\"></td><td><pre> <span class=\"token number\">10</span>                <span class=\"token parameter variable\">-1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">131584</span>  models.common.Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">512</span>, <span class=\"token number\">256</span>, <span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"13\"></td><td><pre> <span class=\"token number\">11</span>                <span class=\"token parameter variable\">-1</span>  <span class=\"token number\">1</span>         <span class=\"token number\">0</span>  torch.nn.modules.upsampling.Upsample    <span class=\"token punctuation\">[</span>None, <span class=\"token number\">2</span>, <span class=\"token string\">'nearest'</span><span class=\"token punctuation\">]</span>          </pre></td></tr><tr><td data-num=\"14\"></td><td><pre> <span class=\"token number\">12</span>           <span class=\"token punctuation\">[</span>-1, <span class=\"token number\">6</span><span class=\"token punctuation\">]</span>  <span class=\"token number\">1</span>         <span class=\"token number\">0</span>  models.common.Concat                    <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                           </pre></td></tr><tr><td data-num=\"15\"></td><td><pre> <span class=\"token number\">13</span>                <span class=\"token parameter variable\">-1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">361984</span>  models.common.C3                        <span class=\"token punctuation\">[</span><span class=\"token number\">512</span>, <span class=\"token number\">256</span>, <span class=\"token number\">1</span>, False<span class=\"token punctuation\">]</span>          </pre></td></tr><tr><td data-num=\"16\"></td><td><pre> <span class=\"token number\">14</span>                <span class=\"token parameter variable\">-1</span>  <span class=\"token number\">1</span>     <span class=\"token number\">33024</span>  models.common.Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">256</span>, <span class=\"token number\">128</span>, <span class=\"token number\">1</span>, <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"17\"></td><td><pre> <span class=\"token number\">15</span>                <span class=\"token parameter variable\">-1</span>  <span class=\"token number\">1</span>         <span class=\"token number\">0</span>  torch.nn.modules.upsampling.Upsample    <span class=\"token punctuation\">[</span>None, <span class=\"token number\">2</span>, <span class=\"token string\">'nearest'</span><span class=\"token punctuation\">]</span>          </pre></td></tr><tr><td data-num=\"18\"></td><td><pre> <span class=\"token number\">16</span>           <span class=\"token punctuation\">[</span>-1, <span class=\"token number\">4</span><span class=\"token punctuation\">]</span>  <span class=\"token number\">1</span>         <span class=\"token number\">0</span>  models.common.Concat                    <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                           </pre></td></tr><tr><td data-num=\"19\"></td><td><pre> <span class=\"token number\">17</span>                <span class=\"token parameter variable\">-1</span>  <span class=\"token number\">1</span>     <span class=\"token number\">90880</span>  models.common.C3                        <span class=\"token punctuation\">[</span><span class=\"token number\">256</span>, <span class=\"token number\">128</span>, <span class=\"token number\">1</span>, False<span class=\"token punctuation\">]</span>          </pre></td></tr><tr><td data-num=\"20\"></td><td><pre> <span class=\"token number\">18</span>                <span class=\"token parameter variable\">-1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">147712</span>  models.common.Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">128</span>, <span class=\"token number\">128</span>, <span class=\"token number\">3</span>, <span class=\"token number\">2</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"21\"></td><td><pre> <span class=\"token number\">19</span>          <span class=\"token punctuation\">[</span>-1, <span class=\"token number\">14</span><span class=\"token punctuation\">]</span>  <span class=\"token number\">1</span>         <span class=\"token number\">0</span>  models.common.Concat                    <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                           </pre></td></tr><tr><td data-num=\"22\"></td><td><pre> <span class=\"token number\">20</span>                <span class=\"token parameter variable\">-1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">296448</span>  models.common.C3                        <span class=\"token punctuation\">[</span><span class=\"token number\">256</span>, <span class=\"token number\">256</span>, <span class=\"token number\">1</span>, False<span class=\"token punctuation\">]</span>          </pre></td></tr><tr><td data-num=\"23\"></td><td><pre> <span class=\"token number\">21</span>                <span class=\"token parameter variable\">-1</span>  <span class=\"token number\">1</span>    <span class=\"token number\">590336</span>  models.common.Conv                      <span class=\"token punctuation\">[</span><span class=\"token number\">256</span>, <span class=\"token number\">256</span>, <span class=\"token number\">3</span>, <span class=\"token number\">2</span><span class=\"token punctuation\">]</span>              </pre></td></tr><tr><td data-num=\"24\"></td><td><pre> <span class=\"token number\">22</span>          <span class=\"token punctuation\">[</span>-1, <span class=\"token number\">10</span><span class=\"token punctuation\">]</span>  <span class=\"token number\">1</span>         <span class=\"token number\">0</span>  models.common.Concat                    <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>                           </pre></td></tr><tr><td data-num=\"25\"></td><td><pre> <span class=\"token number\">23</span>                <span class=\"token parameter variable\">-1</span>  <span class=\"token number\">1</span>   <span class=\"token number\">1182720</span>  models.common.C3                        <span class=\"token punctuation\">[</span><span class=\"token number\">512</span>, <span class=\"token number\">512</span>, <span class=\"token number\">1</span>, False<span class=\"token punctuation\">]</span>          </pre></td></tr><tr><td data-num=\"26\"></td><td><pre> <span class=\"token number\">24</span>      <span class=\"token punctuation\">[</span><span class=\"token number\">17</span>, <span class=\"token number\">20</span>, <span class=\"token number\">23</span><span class=\"token punctuation\">]</span>  <span class=\"token number\">1</span>    <span class=\"token number\">229245</span>  Detect                                  <span class=\"token punctuation\">[</span><span class=\"token number\">80</span>, <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">10</span>, <span class=\"token number\">13</span>, <span class=\"token number\">16</span>, <span class=\"token number\">30</span>, <span class=\"token number\">33</span>, <span class=\"token number\">23</span><span class=\"token punctuation\">]</span>, <span class=\"token punctuation\">[</span><span class=\"token number\">30</span>, <span class=\"token number\">61</span>, <span class=\"token number\">62</span>, <span class=\"token number\">45</span>, <span class=\"token number\">59</span>, <span class=\"token number\">119</span><span class=\"token punctuation\">]</span>, <span class=\"token punctuation\">[</span><span class=\"token number\">116</span>, <span class=\"token number\">90</span>, <span class=\"token number\">156</span>, <span class=\"token number\">198</span>, <span class=\"token number\">373</span>, <span class=\"token number\">326</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>, <span class=\"token punctuation\">[</span><span class=\"token number\">128</span>, <span class=\"token number\">256</span>, <span class=\"token number\">512</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>YOLOv5s summary: <span class=\"token number\">214</span> layers, <span class=\"token number\">7235389</span> parameters, <span class=\"token number\">7235389</span> gradients</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>Fusing layers<span class=\"token punctuation\">..</span>. </pre></td></tr><tr><td data-num=\"30\"></td><td><pre>YOLOv5s summary: <span class=\"token number\">157</span> layers, <span class=\"token number\">7225885</span> parameters, <span class=\"token number\">7225885</span> gradients</pre></td></tr></table></figure><p>首先观察到 YOLOv5s summary 输出一次之后又输出了一次，提示： <code>Fusing layers... </code></p>\n<p>融合前：</p>\n<p>Conv<br>\n├── conv<br>\n├── bn<br>\n└── act</p>\n<p>融合后：</p>\n<p>Conv<br>\n├── conv (已吸收 bn)<br>\n└── act</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">fuse</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\"Fuses Conv2d() and BatchNorm2d() layers in the model to improve inference speed.\"\"\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    LOGGER<span class=\"token punctuation\">.</span>info<span class=\"token punctuation\">(</span><span class=\"token string\">\"Fusing layers... \"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">for</span> m <span class=\"token keyword\">in</span> self<span class=\"token punctuation\">.</span>model<span class=\"token punctuation\">.</span>modules<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>Conv<span class=\"token punctuation\">,</span> DWConv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">and</span> <span class=\"token builtin\">hasattr</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">,</span> <span class=\"token string\">\"bn\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            m<span class=\"token punctuation\">.</span>conv <span class=\"token operator\">=</span> fuse_conv_and_bn<span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">.</span>conv<span class=\"token punctuation\">,</span> m<span class=\"token punctuation\">.</span>bn<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># update conv</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token builtin\">delattr</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">,</span> <span class=\"token string\">\"bn\"</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># remove batchnorm</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            m<span class=\"token punctuation\">.</span>forward <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span>forward_fuse  <span class=\"token comment\"># update forward</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    self<span class=\"token punctuation\">.</span>info<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">return</span> self</pre></td></tr></table></figure><p><code>fuse</code>  用于加速推理。</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">fuse_conv_and_bn</span><span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">,</span> bn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\"Fuses Conv2d and BatchNorm2d layers into a single Conv2d layer.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    See https://tehnokv.com/posts/fusing-batchnorm-and-conv/.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    \"\"\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    fusedconv <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            conv<span class=\"token punctuation\">.</span>in_channels<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            conv<span class=\"token punctuation\">.</span>out_channels<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            kernel_size<span class=\"token operator\">=</span>conv<span class=\"token punctuation\">.</span>kernel_size<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            stride<span class=\"token operator\">=</span>conv<span class=\"token punctuation\">.</span>stride<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            padding<span class=\"token operator\">=</span>conv<span class=\"token punctuation\">.</span>padding<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            dilation<span class=\"token operator\">=</span>conv<span class=\"token punctuation\">.</span>dilation<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            groups<span class=\"token operator\">=</span>conv<span class=\"token punctuation\">.</span>groups<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            bias<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">.</span>requires_grad_<span class=\"token punctuation\">(</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">.</span>weight<span class=\"token punctuation\">.</span>device<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token comment\"># Prepare filters</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    w_conv <span class=\"token operator\">=</span> conv<span class=\"token punctuation\">.</span>weight<span class=\"token punctuation\">.</span>clone<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">.</span>out_channels<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    w_bn <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>diag<span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">.</span>weight<span class=\"token punctuation\">.</span>div<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>sqrt<span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">.</span>eps <span class=\"token operator\">+</span> bn<span class=\"token punctuation\">.</span>running_var<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    fusedconv<span class=\"token punctuation\">.</span>weight<span class=\"token punctuation\">.</span>copy_<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>mm<span class=\"token punctuation\">(</span>w_bn<span class=\"token punctuation\">,</span> w_conv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">(</span>fusedconv<span class=\"token punctuation\">.</span>weight<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token comment\"># Prepare spatial bias</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    b_conv <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>zeros<span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">.</span>weight<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> device<span class=\"token operator\">=</span>conv<span class=\"token punctuation\">.</span>weight<span class=\"token punctuation\">.</span>device<span class=\"token punctuation\">)</span> <span class=\"token keyword\">if</span> conv<span class=\"token punctuation\">.</span>bias <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span> <span class=\"token keyword\">else</span> conv<span class=\"token punctuation\">.</span>bias</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    b_bn <span class=\"token operator\">=</span> bn<span class=\"token punctuation\">.</span>bias <span class=\"token operator\">-</span> bn<span class=\"token punctuation\">.</span>weight<span class=\"token punctuation\">.</span>mul<span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">.</span>running_mean<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>div<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>sqrt<span class=\"token punctuation\">(</span>bn<span class=\"token punctuation\">.</span>running_var <span class=\"token operator\">+</span> bn<span class=\"token punctuation\">.</span>eps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    fusedconv<span class=\"token punctuation\">.</span>bias<span class=\"token punctuation\">.</span>copy_<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>mm<span class=\"token punctuation\">(</span>w_bn<span class=\"token punctuation\">,</span> b_conv<span class=\"token punctuation\">.</span>reshape<span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>reshape<span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> b_bn<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token keyword\">return</span> fusedconv</pre></td></tr></table></figure><h3 id=\"yolov5nsmlx\"><a class=\"markdownIt-Anchor\" href=\"#yolov5nsmlx\">#</a> YOLOv5——n/s/m/l/x？</h3>\n<img data-src=\"https://cdn.jsdelivr.net/gh/ultralytics/assets@main/docs/yolov5-model-comparison.avif\" alt=\"1\" style=\"zoom:80%;\" />\n<h3 id=\"基于yolov5s继续讨论\"><a class=\"markdownIt-Anchor\" href=\"#基于yolov5s继续讨论\">#</a> 基于 YOLOv5s 继续讨论</h3>\n<p>观察输出可以看到如下组件：</p>\n<ol>\n<li>Conv</li>\n<li>C3</li>\n<li>SPPF</li>\n<li>Upsample（nearest）</li>\n<li>Concat</li>\n<li>Detect</li>\n</ol>\n<p>下面基于此来继续讨论。</p>\n<h3 id=\"conv\"><a class=\"markdownIt-Anchor\" href=\"#conv\">#</a> Conv</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">Conv</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\"Applies a convolution, batch normalization, and activation function to an input tensor in a neural network.\"\"\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    default_act <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>SiLU<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># default activation</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> c1<span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">,</span> k<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> s<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> p<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> g<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> d<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> act<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"Initializes a standard convolution layer with optional batch normalization and activation.\"\"\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        self<span class=\"token punctuation\">.</span>conv <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">(</span>c1<span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">,</span> k<span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">,</span> autopad<span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">,</span> d<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> groups<span class=\"token operator\">=</span>g<span class=\"token punctuation\">,</span> dilation<span class=\"token operator\">=</span>d<span class=\"token punctuation\">,</span> bias<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        self<span class=\"token punctuation\">.</span>bn <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>BatchNorm2d<span class=\"token punctuation\">(</span>c2<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        self<span class=\"token punctuation\">.</span>act <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>default_act <span class=\"token keyword\">if</span> act <span class=\"token keyword\">is</span> <span class=\"token boolean\">True</span> <span class=\"token keyword\">else</span> act <span class=\"token keyword\">if</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>act<span class=\"token punctuation\">,</span> nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> nn<span class=\"token punctuation\">.</span>Identity<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"Applies a convolution followed by batch normalization and an activation function to the input tensor `x`.\"\"\"</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>act<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>bn<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>conv<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward_fuse</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"Applies a fused convolution and activation function to the input tensor `x`.\"\"\"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>act<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>conv<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>Conv 组件不是纯粹的卷积，它是由以卷积为核心的一组操作构成的，源码中说到：对神经网络中的输入张量应用卷积、批处理归一化和激活函数。</p>\n<p>其中： <code>self.act = self.default_act if act is True else act if isinstance(act, nn.Module) else nn.Identity()</code>  这一段非常值得我们学习，如果 <code>act=True</code>  则使用 <code>default_act</code> ，否则就要判断传过来的 <code>act</code>  是否是 <code>nn.Module</code> ( <code>isinstance(act, nn.Module)</code> )，是的话就用新传过来的，否则则使用 <code>nn.Identity()</code>  直接原样输出。</p>\n<img data-src=\"../../../images/python/YOLO/v5/1.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<h3 id=\"c3\"><a class=\"markdownIt-Anchor\" href=\"#c3\">#</a> C3</h3>\n<p>YOLOv5s 可以支持各种 C3 变体，但官方默认配置只用基础 C3，C3 是一个系列，其中有 C3x、C3TR、C3SPP、C3Ghost，他们都继承 C3</p>\n<ol>\n<li><code>C3</code>  - 基础 CSP 瓶颈模块</li>\n<li><code>C3x</code>  - 使用 CrossConv 交叉卷积的 C3 变体</li>\n<li><code>C3TR</code>  - 使用 TransformerBlock 的 C3 变体</li>\n<li><code>C3SPP</code>  - 使用 SPP 空间金字塔池化的 C3 变体</li>\n<li><code>C3Ghost</code>  - 使用 GhostBottleneck 幽灵残差的 C3 变体</li>\n</ol>\n<p>YOLOv5s 中使用的是基础的 <code>C3</code>  模块，让我们先来看看 C3：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">C3</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\"Implements a CSP Bottleneck module with three convolutions for enhanced feature extraction in neural networks.\"\"\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> c1<span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">,</span> n<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> shortcut<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> g<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> e<span class=\"token operator\">=</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"Initializes C3 module with options for channel count, bottleneck repetition, shortcut usage, group</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        convolutions, and expansion.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        \"\"\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        c_ <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>c2 <span class=\"token operator\">*</span> e<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># hidden channels</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv1 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span>c1<span class=\"token punctuation\">,</span> c_<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv2 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span>c1<span class=\"token punctuation\">,</span> c_<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv3 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> c_<span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># optional act=FReLU(c2)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        self<span class=\"token punctuation\">.</span>m <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Sequential<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>Bottleneck<span class=\"token punctuation\">(</span>c_<span class=\"token punctuation\">,</span> c_<span class=\"token punctuation\">,</span> shortcut<span class=\"token punctuation\">,</span> g<span class=\"token punctuation\">,</span> e<span class=\"token operator\">=</span><span class=\"token number\">1.0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"Performs forward propagation using concatenated outputs from two convolutions and a Bottleneck sequence.\"\"\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>cv3<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>m<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>cv1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>cv2<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><img data-src=\"../../../images/python/YOLO/v5/3.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<p>C3 见名知意，是一个以三个卷积为核心的特征提取块在向前传播中依赖了 <code>Bottleneck</code> ，其中 <code>nn.Sequential(*(Bottleneck(c_, c_, shortcut, g, e=1.0) for _ in range(n)))</code>  是一个语法糖，让我们一步步拆解，在外层的 <code>nn.Sequential()</code>  是一个序列组装，先不看，内层的 <code>*(xxx)</code>  意为由多个 <code>xxx</code>  组成，但到底由多少个 <code>xxx</code>  组成取决于内层 <code>Bottleneck(c_, c_, shortcut, g, e=1.0) for _ in range(n)</code>  中 <code>n</code>  的大小决定。说了这么多， <code>Bottleneck</code>  是啥？</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">Bottleneck</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\"A bottleneck layer with optional shortcut and group convolution for efficient feature extraction.\"\"\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> c1<span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">,</span> shortcut<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> g<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> e<span class=\"token operator\">=</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"Initializes a standard bottleneck layer with optional shortcut and group convolution, supporting channel expansion.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        \"\"\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        c_ <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>c2 <span class=\"token operator\">*</span> e<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># hidden channels</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv1 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span>c1<span class=\"token punctuation\">,</span> c_<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv2 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span>c_<span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> g<span class=\"token operator\">=</span>g<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        self<span class=\"token punctuation\">.</span>add <span class=\"token operator\">=</span> shortcut <span class=\"token keyword\">and</span> c1 <span class=\"token operator\">==</span> c2</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"Processes input through two convolutions, optionally adds shortcut if channel dimensions match; input is a tensor.</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        \"\"\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">return</span> x <span class=\"token operator\">+</span> self<span class=\"token punctuation\">.</span>cv2<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>cv1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">if</span> self<span class=\"token punctuation\">.</span>add <span class=\"token keyword\">else</span> self<span class=\"token punctuation\">.</span>cv2<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>cv1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>观察 <code>return x + self.cv2(self.cv1(x)) if self.add else self.cv2(self.cv1(x))</code>  显然这是一个残差模块，通过 <code>add</code>  控制开启与关闭。一般来说前后不改变通道数， <code>c_</code> 是前后通道数的一半。</p>\n<img data-src=\"../../../images/python/YOLO/v5/2.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<p>下面还有一个 Bottleneck，我称之为 Bottleneck-F，这是不启用残差链接的 Bottleneck。</p>\n<img data-src=\"../../../images/python/YOLO/v5/5.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<p>那自然有 C3-F-X</p>\n<img data-src=\"../../../images/python/YOLO/v5/6.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<h3 id=\"sppf\"><a class=\"markdownIt-Anchor\" href=\"#sppf\">#</a> SPPF</h3>\n<p>SPPF 通过复用中间结果，把 3 次独立池化变成了 3 次串联池化，计算量从 O (3k²) 降为 O (k²)，速度快了 2-3 倍，效果几乎不变。</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">SPPF</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\"Implements a fast Spatial Pyramid Pooling (SPPF) layer for efficient feature extraction in YOLOv5 models.\"\"\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> c1<span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">,</span> k<span class=\"token operator\">=</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"Initializes YOLOv5 SPPF layer with given channels and kernel size for YOLOv5 model, combining convolution and</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        max pooling.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        Equivalent to SPP(k=(5, 9, 13)).</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        \"\"\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        c_ <span class=\"token operator\">=</span> c1 <span class=\"token operator\">//</span> <span class=\"token number\">2</span>  <span class=\"token comment\"># hidden channels</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv1 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span>c1<span class=\"token punctuation\">,</span> c_<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        self<span class=\"token punctuation\">.</span>cv2 <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span>c_ <span class=\"token operator\">*</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        self<span class=\"token punctuation\">.</span>m <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>MaxPool2d<span class=\"token punctuation\">(</span>kernel_size<span class=\"token operator\">=</span>k<span class=\"token punctuation\">,</span> stride<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> padding<span class=\"token operator\">=</span>k <span class=\"token operator\">//</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"Processes input through a series of convolutions and max pooling operations for feature extraction.\"\"\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        x <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>cv1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">with</span> warnings<span class=\"token punctuation\">.</span>catch_warnings<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            warnings<span class=\"token punctuation\">.</span>simplefilter<span class=\"token punctuation\">(</span><span class=\"token string\">\"ignore\"</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># suppress torch 1.9.0 max_pool2d() warning</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            y1 <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>m<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            y2 <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>m<span class=\"token punctuation\">(</span>y1<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>cv2<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y1<span class=\"token punctuation\">,</span> y2<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>m<span class=\"token punctuation\">(</span>y2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><img data-src=\"../../../images/python/YOLO/v5/4.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<p>这个 <code>cv1</code>  和 <code>cv2</code>  中的 k 与 s 全是 1，完全不改变特征图大小，只改变通道数。通道拼接这里接受了四部分的输入，所以 <code>self.cv2 = Conv(c_ * 4, c2, 1, 1)</code>  中写道： <code>c_ * 4</code> ，其中 <code>c_</code> 是第一个 CBS 的输出通道数。</p>\n<h3 id=\"focusfocus为什么被弃用\"><a class=\"markdownIt-Anchor\" href=\"#focusfocus为什么被弃用\">#</a> Focus——Focus 为什么被弃用？</h3>\n<p>YOLOv5 v6.0 版本（2021 年 10 月）是一个分水岭：Focus 的切片操作虽然减少了参数量，但在 GPU/TPU 上不友好。取而代之的是 6x6 卷积。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>from  n    params  module                  arguments           </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">0</span>    <span class=\"token parameter variable\">-1</span>    <span class=\"token number\">1</span>    <span class=\"token number\">3520</span>  \tmodels.common.Conv      <span class=\"token punctuation\">[</span><span class=\"token number\">3</span>, <span class=\"token number\">32</span>, <span class=\"token number\">6</span>, <span class=\"token number\">2</span>, <span class=\"token number\">2</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><p><code>[3, 32, 6, 2, 2]</code>  输入 RGB 彩色图像，3 通道，第一层输出 32 个特征图，其中是<strong> 6×6</strong> 的卷积核，每次移动 2 像素，<strong>特征图尺寸减半</strong>，四周补 2 圈 0，保持尺寸计算正确。假如输入 <code>640×640×3</code> ，输出是 <code>320×320×32</code> ，因为步长 2，尺寸减半。</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">Focus</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\"Focuses spatial information into channel space using slicing and convolution for efficient feature extraction.\"\"\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> c1<span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">,</span> k<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> s<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> p<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> g<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> act<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"Initializes Focus module to concentrate width-height info into channel space with configurable convolution</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        parameters.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        \"\"\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        self<span class=\"token punctuation\">.</span>conv <span class=\"token operator\">=</span> Conv<span class=\"token punctuation\">(</span>c1 <span class=\"token operator\">*</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> c2<span class=\"token punctuation\">,</span> k<span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">,</span> g<span class=\"token punctuation\">,</span> act<span class=\"token operator\">=</span>act<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token comment\"># self.contract = Contract(gain=2)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"Processes input through Focus mechanism, reshaping (b,c,w,h) to (b,4c,w/2,h/2) then applies convolution.\"\"\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>conv<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">[</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">[</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">[</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">[</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token comment\"># return self.conv(self.contract(x))</span></pre></td></tr></table></figure><h3 id=\"upsample\"><a class=\"markdownIt-Anchor\" href=\"#upsample\">#</a> Upsample</h3>\n<p>Upsample 使用的是 <code>nn.Upsample(scale_factor=2, mode=&quot;nearest&quot;)</code> ，这个没什么好说的。</p>\n<h3 id=\"concat\"><a class=\"markdownIt-Anchor\" href=\"#concat\">#</a> Concat</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">Concat</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\"Concatenates tensors along a specified dimension for efficient tensor manipulation in neural networks.\"\"\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> dimension<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"Initializes a Concat module to concatenate tensors along a specified dimension.\"\"\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        self<span class=\"token punctuation\">.</span>d <span class=\"token operator\">=</span> dimension</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"Concatenates a list of tensors along a specified dims; `x` is a list of tensors, `dimension` is an int.\"\"\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">return</span> torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>d<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>Concat 的注释很清晰，它将一组张量列表串接到指定的 dim 上；“x” 是张量列表，“维度” 是整数。</p>\n<h3 id=\"detect\"><a class=\"markdownIt-Anchor\" href=\"#detect\">#</a> Detect</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">Detect</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\"YOLOv5 Detect head for processing input tensors and generating detection outputs in object detection models.\"\"\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    stride <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span>  <span class=\"token comment\"># strides computed during build</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    dynamic <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span>  <span class=\"token comment\"># force grid reconstruction</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    export <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span>  <span class=\"token comment\"># export mode</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> nc<span class=\"token operator\">=</span><span class=\"token number\">80</span><span class=\"token punctuation\">,</span> anchors<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> ch<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> inplace<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"Initializes YOLOv5 detection layer with specified classes, anchors, channels, and inplace operations.\"\"\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        self<span class=\"token punctuation\">.</span>nc <span class=\"token operator\">=</span> nc  <span class=\"token comment\"># number of classes</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        self<span class=\"token punctuation\">.</span>no <span class=\"token operator\">=</span> nc <span class=\"token operator\">+</span> <span class=\"token number\">5</span>  <span class=\"token comment\"># number of outputs per anchor</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        self<span class=\"token punctuation\">.</span>nl <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>anchors<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># number of detection layers</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        self<span class=\"token punctuation\">.</span>na <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>anchors<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">//</span> <span class=\"token number\">2</span>  <span class=\"token comment\"># number of anchors</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        self<span class=\"token punctuation\">.</span>grid <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>torch<span class=\"token punctuation\">.</span>empty<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>nl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\"># init grid</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        self<span class=\"token punctuation\">.</span>anchor_grid <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>torch<span class=\"token punctuation\">.</span>empty<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>nl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\"># init anchor grid</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        self<span class=\"token punctuation\">.</span>register_buffer<span class=\"token punctuation\">(</span><span class=\"token string\">\"anchors\"</span><span class=\"token punctuation\">,</span> torch<span class=\"token punctuation\">.</span>tensor<span class=\"token punctuation\">(</span>anchors<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">float</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>nl<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># shape(nl,na,2)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        self<span class=\"token punctuation\">.</span>m <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>ModuleList<span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>no <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>na<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> x <span class=\"token keyword\">in</span> ch<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># output conv</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        self<span class=\"token punctuation\">.</span>inplace <span class=\"token operator\">=</span> inplace  <span class=\"token comment\"># use inplace ops (e.g. slice assignment)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"Processes input through YOLOv5 layers, altering shape for detection: `x(bs, 3, ny, nx, 85)`.\"\"\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        z <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\"># inference output</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>nl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            x<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>m<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># conv</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            bs<span class=\"token punctuation\">,</span> _<span class=\"token punctuation\">,</span> ny<span class=\"token punctuation\">,</span> nx <span class=\"token operator\">=</span> x<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>shape  <span class=\"token comment\"># x(bs,255,20,20) to x(bs,3,20,20,85)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            x<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> x<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">(</span>bs<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>na<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>no<span class=\"token punctuation\">,</span> ny<span class=\"token punctuation\">,</span> nx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>permute<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>contiguous<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> self<span class=\"token punctuation\">.</span>training<span class=\"token punctuation\">:</span>  <span class=\"token comment\"># inference</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                <span class=\"token keyword\">if</span> self<span class=\"token punctuation\">.</span>dynamic <span class=\"token keyword\">or</span> self<span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> x<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                    self<span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>anchor_grid<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>_make_grid<span class=\"token punctuation\">(</span>nx<span class=\"token punctuation\">,</span> ny<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> Segment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># (boxes + masks)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                    xy<span class=\"token punctuation\">,</span> wh<span class=\"token punctuation\">,</span> conf<span class=\"token punctuation\">,</span> mask <span class=\"token operator\">=</span> x<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>nc <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>no <span class=\"token operator\">-</span> self<span class=\"token punctuation\">.</span>nc <span class=\"token operator\">-</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                    xy <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>xy<span class=\"token punctuation\">.</span>sigmoid<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span> <span class=\"token operator\">+</span> self<span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>stride<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>  <span class=\"token comment\"># xy</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                    wh <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>wh<span class=\"token punctuation\">.</span>sigmoid<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">**</span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>anchor_grid<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>  <span class=\"token comment\"># wh</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                    y <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>xy<span class=\"token punctuation\">,</span> wh<span class=\"token punctuation\">,</span> conf<span class=\"token punctuation\">.</span>sigmoid<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> mask<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># Detect (boxes only)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                    xy<span class=\"token punctuation\">,</span> wh<span class=\"token punctuation\">,</span> conf <span class=\"token operator\">=</span> x<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>sigmoid<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>nc <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                    xy <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>xy <span class=\"token operator\">*</span> <span class=\"token number\">2</span> <span class=\"token operator\">+</span> self<span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>stride<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>  <span class=\"token comment\"># xy</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                    wh <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>wh <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">**</span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>anchor_grid<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>  <span class=\"token comment\"># wh</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                    y <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>xy<span class=\"token punctuation\">,</span> wh<span class=\"token punctuation\">,</span> conf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                z<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">(</span>bs<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>na <span class=\"token operator\">*</span> nx <span class=\"token operator\">*</span> ny<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>no<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token keyword\">return</span> x <span class=\"token keyword\">if</span> self<span class=\"token punctuation\">.</span>training <span class=\"token keyword\">else</span> <span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span>z<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">if</span> self<span class=\"token punctuation\">.</span>export <span class=\"token keyword\">else</span> <span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span>z<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">_make_grid</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> nx<span class=\"token operator\">=</span><span class=\"token number\">20</span><span class=\"token punctuation\">,</span> ny<span class=\"token operator\">=</span><span class=\"token number\">20</span><span class=\"token punctuation\">,</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> torch_1_10<span class=\"token operator\">=</span>check_version<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>__version__<span class=\"token punctuation\">,</span> <span class=\"token string\">\"1.10.0\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"Generates a mesh grid for anchor boxes with optional compatibility for torch versions &lt; 1.10.\"\"\"</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        d <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>anchors<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>device</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        t <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>anchors<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>dtype</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        shape <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>na<span class=\"token punctuation\">,</span> ny<span class=\"token punctuation\">,</span> nx<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span>  <span class=\"token comment\"># grid shape</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        y<span class=\"token punctuation\">,</span> x <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>arange<span class=\"token punctuation\">(</span>ny<span class=\"token punctuation\">,</span> device<span class=\"token operator\">=</span>d<span class=\"token punctuation\">,</span> dtype<span class=\"token operator\">=</span>t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> torch<span class=\"token punctuation\">.</span>arange<span class=\"token punctuation\">(</span>nx<span class=\"token punctuation\">,</span> device<span class=\"token operator\">=</span>d<span class=\"token punctuation\">,</span> dtype<span class=\"token operator\">=</span>t<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        yv<span class=\"token punctuation\">,</span> xv <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>meshgrid<span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> indexing<span class=\"token operator\">=</span><span class=\"token string\">\"ij\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">if</span> torch_1_10 <span class=\"token keyword\">else</span> torch<span class=\"token punctuation\">.</span>meshgrid<span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># torch>=0.7 compatibility</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        grid <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>stack<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>xv<span class=\"token punctuation\">,</span> yv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>expand<span class=\"token punctuation\">(</span>shape<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">0.5</span>  <span class=\"token comment\"># add grid offset, i.e. y = 2.0 * x - 0.5</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        anchor_grid <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>anchors<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>stride<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>na<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>expand<span class=\"token punctuation\">(</span>shape<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        <span class=\"token keyword\">return</span> grid<span class=\"token punctuation\">,</span> anchor_grid</pre></td></tr></table></figure><p>这段代码是负责目标检测的，核心在于看懂 <code>forward</code>  函数：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\"Processes input through YOLOv5 layers, altering shape for detection: `x(bs, 3, ny, nx, 85)`.\"\"\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    z <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\"># inference output</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>nl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        x<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>m<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># conv</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        bs<span class=\"token punctuation\">,</span> _<span class=\"token punctuation\">,</span> ny<span class=\"token punctuation\">,</span> nx <span class=\"token operator\">=</span> x<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>shape  <span class=\"token comment\"># x(bs,255,20,20) to x(bs,3,20,20,85)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        x<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> x<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">(</span>bs<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>na<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>no<span class=\"token punctuation\">,</span> ny<span class=\"token punctuation\">,</span> nx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>permute<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>contiguous<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> self<span class=\"token punctuation\">.</span>training<span class=\"token punctuation\">:</span>  <span class=\"token comment\"># inference</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token keyword\">if</span> self<span class=\"token punctuation\">.</span>dynamic <span class=\"token keyword\">or</span> self<span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> x<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                self<span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>anchor_grid<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>_make_grid<span class=\"token punctuation\">(</span>nx<span class=\"token punctuation\">,</span> ny<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> Segment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># (boxes + masks)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                xy<span class=\"token punctuation\">,</span> wh<span class=\"token punctuation\">,</span> conf<span class=\"token punctuation\">,</span> mask <span class=\"token operator\">=</span> x<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>nc <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>no <span class=\"token operator\">-</span> self<span class=\"token punctuation\">.</span>nc <span class=\"token operator\">-</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                xy <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>xy<span class=\"token punctuation\">.</span>sigmoid<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span> <span class=\"token operator\">+</span> self<span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>stride<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>  <span class=\"token comment\"># xy</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                wh <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>wh<span class=\"token punctuation\">.</span>sigmoid<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">**</span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>anchor_grid<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>  <span class=\"token comment\"># wh</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                y <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>xy<span class=\"token punctuation\">,</span> wh<span class=\"token punctuation\">,</span> conf<span class=\"token punctuation\">.</span>sigmoid<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> mask<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># Detect (boxes only)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                xy<span class=\"token punctuation\">,</span> wh<span class=\"token punctuation\">,</span> conf <span class=\"token operator\">=</span> x<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>sigmoid<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>nc <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                xy <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>xy <span class=\"token operator\">*</span> <span class=\"token number\">2</span> <span class=\"token operator\">+</span> self<span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>stride<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>  <span class=\"token comment\"># xy</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                wh <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>wh <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">**</span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>anchor_grid<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>  <span class=\"token comment\"># wh</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                y <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>xy<span class=\"token punctuation\">,</span> wh<span class=\"token punctuation\">,</span> conf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            z<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">(</span>bs<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>na <span class=\"token operator\">*</span> nx <span class=\"token operator\">*</span> ny<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>no<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">return</span> x <span class=\"token keyword\">if</span> self<span class=\"token punctuation\">.</span>training <span class=\"token keyword\">else</span> <span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span>z<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">if</span> self<span class=\"token punctuation\">.</span>export <span class=\"token keyword\">else</span> <span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span>z<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>x (bs, 3, ny, nx, 85)，85: 每个 anchor 的预测值，nx: 特征图宽度方向网格数，ny: 特征图高度方向网格数，3: 每个网格点的 anchor 数量， bs: batch size。</p>\n<p>85 维向量 = [tx, ty, tw, th,     \tobj_conf, \tcls1, cls2, …, cls80]<br>\n├──4 坐标──┤   ├─1 置信─┤  ├──80 类别概率──┤</p>\n<p>self.nl 是 anchors 的数量，向前传播首先进入： <code>for i in range(self.nl):</code> ，3 个检测分支通过 1 个 for 循环并行处理。</p>\n<p>Detect 初始化时： <code>def __init__(self, nc=80, anchors=(), ch=(), inplace=True)</code> ，查看日志可以看到 <code>[80, [[10, 13, 16, 30, 33, 23], [30, 61, 62, 45, 59, 119], [116, 90, 156, 198, 373, 326]], [128, 256, 512]]</code> ，80 分类，三组检测框，对应三个上游通道数 <code>[128, 256, 512]</code> 。<strong>这是 3 组锚框，每组 3 个，一共 9 个锚框，分别对应 P3、P4、P5 三个检测层</strong></p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>self<span class=\"token punctuation\">.</span>na <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>anchors<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">//</span> <span class=\"token number\">2</span></pre></td></tr></table></figure><p>anchors 的存储格式是  <code>[w1, h1, w2, h2, w3, h3]</code> ，每两个数字组成一个 anchor。所以我们知道， <code>for i in range(self.nl)</code>  是为三个检测头准备的。</p>\n<p>继续向下执行，这两行代码是 YOLOv5 检测头的变形魔法：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>bs<span class=\"token punctuation\">,</span> _<span class=\"token punctuation\">,</span> ny<span class=\"token punctuation\">,</span> nx <span class=\"token operator\">=</span> x<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>shape  <span class=\"token comment\"># x(bs,255,20,20) to x(bs,3,20,20,85)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>x<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> x<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">(</span>bs<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>na<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>no<span class=\"token punctuation\">,</span> ny<span class=\"token punctuation\">,</span> nx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>permute<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>contiguous<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>原始：(1, 255, 20, 20)  batch=1, 通道 = 255, 高 = 20, 宽 = 20</p>\n<p>view 重塑：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>.view<span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">3</span>, <span class=\"token number\">85</span>, <span class=\"token number\">20</span>, <span class=\"token number\">20</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    │  │  │   │   │</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    │  │  │   │   └── 宽度网格数 <span class=\"token punctuation\">(</span>nx<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    │  │  │   └────── 高度网格数 <span class=\"token punctuation\">(</span>ny<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    │  │  └────────── 每个anchor的预测值 <span class=\"token punctuation\">(</span>no<span class=\"token operator\">=</span><span class=\"token number\">85</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    │  └───────────── 每个网格的anchor数 <span class=\"token punctuation\">(</span>na<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    └──────────────── batch size <span class=\"token punctuation\">(</span>bs<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token number\">255</span> <span class=\"token operator\">=</span> <span class=\"token number\">3</span>×85</pre></td></tr></table></figure><p>permute 调整位置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>.permute<span class=\"token punctuation\">(</span><span class=\"token number\">0</span>, <span class=\"token number\">1</span>, <span class=\"token number\">3</span>, <span class=\"token number\">4</span>, <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">3</span>, <span class=\"token number\">20</span>, <span class=\"token number\">20</span>, <span class=\"token number\">85</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  ─┬─ ─┬─ ─┬─ ─┬─ ─┬─</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   │   │   │   │   └── 检测值 <span class=\"token punctuation\">(</span>坐标+置信度+类别<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   │   │   │   └────── 宽度网格 <span class=\"token punctuation\">(</span>nx<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   │   │   └────────── 高度网格 <span class=\"token punctuation\">(</span>ny<span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   │   └────────────── anchor索引 <span class=\"token punctuation\">(</span>na<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   └────────────────── batch <span class=\"token punctuation\">(</span>bs<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>contiguous 保证内存连续。</p>\n<p>为了方便观察输出，可以打印一下：print (x [i].shape, “这是：”, i)</p>\n<blockquote>\n<p>torch.Size ([1, 255, 80, 80]) 这是： 0<br>\ntorch.Size ([1, 255, 40, 40]) 这是： 1<br>\ntorch.Size ([1, 255, 20, 20]) 这是： 2</p>\n</blockquote>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">return</span> x <span class=\"token keyword\">if</span> self<span class=\"token punctuation\">.</span>training <span class=\"token keyword\">else</span> <span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span>z<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">if</span> self<span class=\"token punctuation\">.</span>export <span class=\"token keyword\">else</span> <span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span>z<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>训练时： <code>return x </code> ，直接去算 Loss。</p>\n<p>推理时： <code>return (torch.cat(z, 1), x)</code> ，返回检测结果 + 特征图</p>\n<p>这个 z 从哪里来？这里写道 <code>if not self.training</code> …</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> self<span class=\"token punctuation\">.</span>training<span class=\"token punctuation\">:</span>  <span class=\"token comment\"># inference</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">if</span> self<span class=\"token punctuation\">.</span>dynamic <span class=\"token keyword\">or</span> self<span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> x<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        self<span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>anchor_grid<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>_make_grid<span class=\"token punctuation\">(</span>nx<span class=\"token punctuation\">,</span> ny<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> Segment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># (boxes + masks)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        xy<span class=\"token punctuation\">,</span> wh<span class=\"token punctuation\">,</span> conf<span class=\"token punctuation\">,</span> mask <span class=\"token operator\">=</span> x<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>nc <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>no <span class=\"token operator\">-</span> self<span class=\"token punctuation\">.</span>nc <span class=\"token operator\">-</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        xy <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>xy<span class=\"token punctuation\">.</span>sigmoid<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span> <span class=\"token operator\">+</span> self<span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>stride<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>  <span class=\"token comment\"># xy</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        wh <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>wh<span class=\"token punctuation\">.</span>sigmoid<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">**</span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>anchor_grid<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>  <span class=\"token comment\"># wh</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        y <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>xy<span class=\"token punctuation\">,</span> wh<span class=\"token punctuation\">,</span> conf<span class=\"token punctuation\">.</span>sigmoid<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> mask<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># Detect (boxes only)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        xy<span class=\"token punctuation\">,</span> wh<span class=\"token punctuation\">,</span> conf <span class=\"token operator\">=</span> x<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>sigmoid<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>nc <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        xy <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>xy <span class=\"token operator\">*</span> <span class=\"token number\">2</span> <span class=\"token operator\">+</span> self<span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>stride<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>  <span class=\"token comment\"># xy</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        wh <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>wh <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">**</span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>anchor_grid<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>  <span class=\"token comment\"># wh</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        y <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>xy<span class=\"token punctuation\">,</span> wh<span class=\"token punctuation\">,</span> conf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    z<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">(</span>bs<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>na <span class=\"token operator\">*</span> nx <span class=\"token operator\">*</span> ny<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>no<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>推理时反向计算预测框。</p>\n<h3 id=\"先提一下parse_model\"><a class=\"markdownIt-Anchor\" href=\"#先提一下parse_model\">#</a> 先提一下 parse_model</h3>\n<p>在 yaml 中， <code>[-1, 3, C3, [128]],</code>  只给了一个参数 128，而我我们前面说到的 C3 至少需要两个，parse_model 回答我们：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>c1<span class=\"token punctuation\">,</span> c2 <span class=\"token operator\">=</span> ch<span class=\"token punctuation\">[</span>f<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">if</span> c2 <span class=\"token operator\">!=</span> no<span class=\"token punctuation\">:</span>  <span class=\"token comment\"># if not output</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    c2 <span class=\"token operator\">=</span> make_divisible<span class=\"token punctuation\">(</span>c2 <span class=\"token operator\">*</span> gw<span class=\"token punctuation\">,</span> ch_mul<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>c2 来自 yaml，c1 从上一层自动获取：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">for</span> i<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">,</span> n<span class=\"token punctuation\">,</span> m<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span> <span class=\"token builtin\">enumerate</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">[</span><span class=\"token string\">\"backbone\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> d<span class=\"token punctuation\">[</span><span class=\"token string\">\"head\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># from, number, module, args</span></pre></td></tr></table></figure><h2 id=\"激动人心的时刻组装\"><a class=\"markdownIt-Anchor\" href=\"#激动人心的时刻组装\">#</a> 激动人心的时刻 —— 组装</h2>\n<p>这就是 YOLOv5s 的构成：</p>\n<img data-src=\"../../../images/python/YOLO/v5/7.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<h2 id=\"auto-anchor-自适应锚框计算\"><a class=\"markdownIt-Anchor\" href=\"#auto-anchor-自适应锚框计算\">#</a> Auto-Anchor 自适应锚框计算</h2>\n<p>YOLOv5 的自适应锚框计算主要写在  <code>utils/autoanchor.py</code>  文件里：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token decorator annotation punctuation\">@TryExcept</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>PREFIX<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">ERROR\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">check_anchors</span><span class=\"token punctuation\">(</span>dataset<span class=\"token punctuation\">,</span> model<span class=\"token punctuation\">,</span> thr<span class=\"token operator\">=</span><span class=\"token number\">4.0</span><span class=\"token punctuation\">,</span> imgsz<span class=\"token operator\">=</span><span class=\"token number\">640</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\"Evaluates anchor fit to dataset and adjusts if necessary, supporting customizable threshold and image size.\"\"\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    m <span class=\"token operator\">=</span> model<span class=\"token punctuation\">.</span>module<span class=\"token punctuation\">.</span>model<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">if</span> <span class=\"token builtin\">hasattr</span><span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">,</span> <span class=\"token string\">\"module\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> model<span class=\"token punctuation\">.</span>model<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\"># Detect()</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    shapes <span class=\"token operator\">=</span> imgsz <span class=\"token operator\">*</span> dataset<span class=\"token punctuation\">.</span>shapes <span class=\"token operator\">/</span> dataset<span class=\"token punctuation\">.</span>shapes<span class=\"token punctuation\">.</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> keepdims<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    scale <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>random<span class=\"token punctuation\">.</span>uniform<span class=\"token punctuation\">(</span><span class=\"token number\">0.9</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1.1</span><span class=\"token punctuation\">,</span> size<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>shapes<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># augment scale</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    wh <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>tensor<span class=\"token punctuation\">(</span>np<span class=\"token punctuation\">.</span>concatenate<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>l<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">:</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> s <span class=\"token keyword\">for</span> s<span class=\"token punctuation\">,</span> l <span class=\"token keyword\">in</span> <span class=\"token builtin\">zip</span><span class=\"token punctuation\">(</span>shapes <span class=\"token operator\">*</span> scale<span class=\"token punctuation\">,</span> dataset<span class=\"token punctuation\">.</span>labels<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">float</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># wh</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">metric</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># compute metric</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token triple-quoted-string string\">\"\"\"Computes ratio metric, anchors above threshold, and best possible recall for YOLOv5 anchor evaluation.\"\"\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        r <span class=\"token operator\">=</span> wh<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">/</span> k<span class=\"token punctuation\">[</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        x <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span><span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> <span class=\"token operator\">/</span> r<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\"># ratio metric</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        best <span class=\"token operator\">=</span> x<span class=\"token punctuation\">.</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\"># best_x</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        aat <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>x <span class=\"token operator\">></span> <span class=\"token number\">1</span> <span class=\"token operator\">/</span> thr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">float</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">sum</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>mean<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># anchors above threshold</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        bpr <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>best <span class=\"token operator\">></span> <span class=\"token number\">1</span> <span class=\"token operator\">/</span> thr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">float</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>mean<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># best possible recall</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">return</span> bpr<span class=\"token punctuation\">,</span> aat</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    stride <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span>stride<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">.</span>anchors<span class=\"token punctuation\">.</span>device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># model strides</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    anchors <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span>anchors<span class=\"token punctuation\">.</span>clone<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> stride  <span class=\"token comment\"># current anchors</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    bpr<span class=\"token punctuation\">,</span> aat <span class=\"token operator\">=</span> metric<span class=\"token punctuation\">(</span>anchors<span class=\"token punctuation\">.</span>cpu<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    s <span class=\"token operator\">=</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"\\n</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>PREFIX<span class=\"token punctuation\">&#125;</span></span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>aat<span class=\"token punctuation\">:</span><span class=\"token format-spec\">.2f</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\"> anchors/target, </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>bpr<span class=\"token punctuation\">:</span><span class=\"token format-spec\">.3f</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\"> Best Possible Recall (BPR). \"</span></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">if</span> bpr <span class=\"token operator\">></span> <span class=\"token number\">0.98</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># threshold to recompute</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        LOGGER<span class=\"token punctuation\">.</span>info<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>s<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">Current anchors are a good fit to dataset ✅\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        LOGGER<span class=\"token punctuation\">.</span>info<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>s<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">Anchors are a poor fit to dataset ⚠️, attempting to improve...\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        na <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span>anchors<span class=\"token punctuation\">.</span>numel<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">//</span> <span class=\"token number\">2</span>  <span class=\"token comment\"># number of anchors</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        anchors <span class=\"token operator\">=</span> kmean_anchors<span class=\"token punctuation\">(</span>dataset<span class=\"token punctuation\">,</span> n<span class=\"token operator\">=</span>na<span class=\"token punctuation\">,</span> img_size<span class=\"token operator\">=</span>imgsz<span class=\"token punctuation\">,</span> thr<span class=\"token operator\">=</span>thr<span class=\"token punctuation\">,</span> gen<span class=\"token operator\">=</span><span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> verbose<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        new_bpr <span class=\"token operator\">=</span> metric<span class=\"token punctuation\">(</span>anchors<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token keyword\">if</span> new_bpr <span class=\"token operator\">></span> bpr<span class=\"token punctuation\">:</span>  <span class=\"token comment\"># replace anchors</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            anchors <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>tensor<span class=\"token punctuation\">(</span>anchors<span class=\"token punctuation\">,</span> device<span class=\"token operator\">=</span>m<span class=\"token punctuation\">.</span>anchors<span class=\"token punctuation\">.</span>device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>type_as<span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">.</span>anchors<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            m<span class=\"token punctuation\">.</span>anchors<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> anchors<span class=\"token punctuation\">.</span>clone<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>view_as<span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">.</span>anchors<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            check_anchor_order<span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># must be in pixel-space (not grid-space)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            m<span class=\"token punctuation\">.</span>anchors <span class=\"token operator\">/=</span> stride</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            s <span class=\"token operator\">=</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>PREFIX<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">Done ✅ (optional: update model *.yaml to use these anchors in the future)\"</span></span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            s <span class=\"token operator\">=</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>PREFIX<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">Done ⚠️ (original anchors better than new anchors, proceeding with original anchors)\"</span></span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        LOGGER<span class=\"token punctuation\">.</span>info<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>这个可以称之为拉起函数，在训练开始时，这个函数会登场。它使用一个关键指标 <strong>BPR 最佳可能召回率</strong> 来评估当前锚框的好坏。BPR 衡量的是数据集中有多少真实框能很好地匹配预设的锚框。如果 BPR <strong>大于等于 0.98</strong>，说明锚框已经够用了，流程结束。如果 BPR <strong>小于 0.98</strong>，说明锚框不太合适，代码就会自动启动锚框优化流程。</p>\n<p>这个自适应功能是可选的。在训练脚本  <code>train.py</code>  中，有一个参数叫  <code>--noautoanchor</code> 。默认情况下它是  <code>False</code> ，意味着自适应锚框功能是<strong>开启</strong>的。如果你想使用自己预设的锚框，不让程序自动调整，可以在训练命令中加上  <code>--noautoanchor</code>  来<strong>关闭</strong>它。</p>\n<h2 id=\"loss损失函数\"><a class=\"markdownIt-Anchor\" href=\"#loss损失函数\">#</a> Loss 损失函数</h2>\n<p>YOLOv5 的损失函数计算主要写在  <code>utils/loss.py</code>  文件里。</p>\n<p><code>ComputeLoss</code>  是拉起类，它协调了 YOLOv5 的三大损失：边界框损失 <code>lbox</code> 、置信度损失 <code>lobj</code>  和分类损失 <code>lcls</code> 。</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>lcls <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>zeros<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> device<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>device<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 分类损失</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>lbox <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>zeros<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> device<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>device<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 边界框损失  </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>lobj <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>zeros<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> device<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>device<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 置信度损失</span></pre></td></tr></table></figure><p>然后：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>tcls<span class=\"token punctuation\">,</span> tbox<span class=\"token punctuation\">,</span> indices<span class=\"token punctuation\">,</span> anchors <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>build_targets<span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> targets<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>这段为每个真实目标找到最匹配的 anchor，确定目标落在哪个网格，返回匹配到的正样本信息。紧接着，逐层计算损失:</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">for</span> i<span class=\"token punctuation\">,</span> pi <span class=\"token keyword\">in</span> <span class=\"token builtin\">enumerate</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># 遍历 3 个检测层</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    b<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">,</span> gj<span class=\"token punctuation\">,</span> gi <span class=\"token operator\">=</span> indices<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>  <span class=\"token comment\"># 当前层的正样本索引</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    tobj <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>zeros<span class=\"token punctuation\">(</span>pi<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 初始化置信度目标张量</span></pre></td></tr></table></figure><h3 id=\"正样本损失计算\"><a class=\"markdownIt-Anchor\" href=\"#正样本损失计算\">#</a> 正样本损失计算</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">if</span> n <span class=\"token operator\">:=</span> b<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># 如果这一层有正样本</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\"># 提取正样本位置的预测值</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    pxy<span class=\"token punctuation\">,</span> pwh<span class=\"token punctuation\">,</span> _<span class=\"token punctuation\">,</span> pcls <span class=\"token operator\">=</span> pi<span class=\"token punctuation\">[</span>b<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">,</span> gj<span class=\"token punctuation\">,</span> gi<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>nc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\"># 解码预测坐标</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    pxy <span class=\"token operator\">=</span> pxy<span class=\"token punctuation\">.</span>sigmoid<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span> <span class=\"token operator\">-</span> <span class=\"token number\">0.5</span>        <span class=\"token comment\"># 中心点偏移</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    pwh <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>pwh<span class=\"token punctuation\">.</span>sigmoid<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">**</span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> anchors<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>  <span class=\"token comment\"># 宽高</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    pbox <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>pxy<span class=\"token punctuation\">,</span> pwh<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>      <span class=\"token comment\"># 组合成预测框</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\"># 计算 CIoU 损失</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    iou <span class=\"token operator\">=</span> bbox_iou<span class=\"token punctuation\">(</span>pbox<span class=\"token punctuation\">,</span> tbox<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> CIoU<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>squeeze<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    lbox <span class=\"token operator\">+=</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1.0</span> <span class=\"token operator\">-</span> iou<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>mean<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># IoU 损失 = 1 - IoU</span></pre></td></tr></table></figure><h3 id=\"设置置信度目标值\"><a class=\"markdownIt-Anchor\" href=\"#设置置信度目标值\">#</a> 设置置信度目标值</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 使用 CIoU 作为置信度目标</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>iou <span class=\"token operator\">=</span> iou<span class=\"token punctuation\">.</span>detach<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>clamp<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>tobj<span class=\"token punctuation\">.</span>dtype<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>tobj<span class=\"token punctuation\">[</span>b<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">,</span> gj<span class=\"token punctuation\">,</span> gi<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> iou  <span class=\"token comment\"># 正样本位置填上 IoU 值</span></pre></td></tr></table></figure><h3 id=\"分类损失计算\"><a class=\"markdownIt-Anchor\" href=\"#分类损失计算\">#</a> 分类损失计算</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">if</span> self<span class=\"token punctuation\">.</span>nc <span class=\"token operator\">></span> <span class=\"token number\">1</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># 多类别才计算分类损失</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    t <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>full_like<span class=\"token punctuation\">(</span>pcls<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>cn<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 初始化负标签（默认值）</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    t<span class=\"token punctuation\">[</span><span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> tcls<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>cp      <span class=\"token comment\"># 正样本位置填上正确类别</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    lcls <span class=\"token operator\">+=</span> self<span class=\"token punctuation\">.</span>BCEcls<span class=\"token punctuation\">(</span>pcls<span class=\"token punctuation\">,</span> t<span class=\"token punctuation\">)</span>         <span class=\"token comment\"># 二值交叉熵损失</span></pre></td></tr></table></figure><h2 id=\"训练网上的数据集\"><a class=\"markdownIt-Anchor\" href=\"#训练网上的数据集\">#</a> 训练网上的数据集</h2>\n<p>现在手边没啥好设备，我找了一个有 100 张照片的数据集：</p>\n<img data-src=\"../../../images/python/YOLO/v5/9.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<p>这个是检测火焰目标的，下载下来发现没有标注文件，所以我又把这个标注软件拿出来了。</p>\n<img data-src=\"../../../images/python/YOLO/v5/8.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<p>依然是 VOC 数据格式，在这里我要再次安利一下我的小软件：v2yWdtc！</p>\n<p>开源地址放这里了：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tLzczNTY5MDc1Ny92MnlXZHRj\">https://github.com/735690757/v2yWdtc</span></p>\n<img data-src=\"../../../images/python/YOLO/v5/10.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<p>这个可以帮助你过滤一些脏数据，还可以方便的查看标签信息。</p>\n<p>然后就是编写 yaml 文件：</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> ./datasets/fire</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">train</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token punctuation\">-</span> images/train</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token key atrule\">val</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">-</span> images/val</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token key atrule\">test</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">-</span> images/test</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># Classes</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token key atrule\">names</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token key atrule\">0</span><span class=\"token punctuation\">:</span> fire</pre></td></tr></table></figure><p>我就框了一个类，那就是火！哈哈！注意路径： <code>./datasets/fire</code>  这个是相对于训练文件的，千万不要当成相对于 yaml 的就行。然后把数据集放这里：</p>\n<img data-src=\"../../../images/python/YOLO/v5/11.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<p>下面是警告的解决方案：</p>\n<ol>\n<li>\n<p>未来警告：FutureWarning:  <code>torch.cuda.amp.autocast(args...)</code>  is deprecated. Please use  <code>torch.amp.autocast('cuda', args...)</code>  instead</p>\n<p>​\t\t建议使用：with torch.amp.autocast (“cuda”,enabled=amp)</p>\n</li>\n<li>\n<p>【WARNING】 corrupt JPEG restored and saved，使用工具重新读取并保存</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span> PIL <span class=\"token keyword\">import</span> Image</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> os</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>folder <span class=\"token operator\">=</span> <span class=\"token string\">\"./JPEGImages\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">for</span> filename <span class=\"token keyword\">in</span> os<span class=\"token punctuation\">.</span>listdir<span class=\"token punctuation\">(</span>folder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">if</span> filename<span class=\"token punctuation\">.</span>endswith<span class=\"token punctuation\">(</span><span class=\"token string\">\".jpg\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        path <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>folder<span class=\"token punctuation\">,</span> filename<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            img <span class=\"token operator\">=</span> Image<span class=\"token punctuation\">.</span><span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            img<span class=\"token punctuation\">.</span>save<span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> <span class=\"token string\">\"JPEG\"</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 重新保存</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">except</span> Exception <span class=\"token keyword\">as</span> e<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>filename<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\"> 无法打开：</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>e<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>后续会加入到我的 v2yWdtc 项目里，成为可选功能，敬请期待！</p>\n</li>\n</ol>\n<p>先练 100 轮</p>\n<img data-src=\"../../../images/python/YOLO/v5/12.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<p>使用 <code>tensorboard --logdir runs/train</code>  看看实时绘制图像：</p>\n<img data-src=\"../../../images/python/YOLO/v5/13.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">100</span> epochs completed <span class=\"token keyword\">in</span> <span class=\"token number\">0.270</span> hours.</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Optimizer stripped from runs<span class=\"token punctuation\">\\</span>train<span class=\"token punctuation\">\\</span>exp3<span class=\"token punctuation\">\\</span>weights<span class=\"token punctuation\">\\</span>last.pt, <span class=\"token number\">14</span>.3MB</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Optimizer stripped from runs<span class=\"token punctuation\">\\</span>train<span class=\"token punctuation\">\\</span>exp3<span class=\"token punctuation\">\\</span>weights<span class=\"token punctuation\">\\</span>best.pt, <span class=\"token number\">14</span>.3MB</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Validating runs<span class=\"token punctuation\">\\</span>train<span class=\"token punctuation\">\\</span>exp3<span class=\"token punctuation\">\\</span>weights<span class=\"token punctuation\">\\</span>best.pt<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Fusing layers<span class=\"token punctuation\">..</span>. </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Model summary: <span class=\"token number\">157</span> layers, <span class=\"token number\">7012822</span> parameters, <span class=\"token number\">0</span> gradients</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                 Class     Images  Instances          P          R      mAP50   mAP50-95: <span class=\"token number\">100</span>%<span class=\"token operator\">|</span>██████████<span class=\"token operator\">|</span> <span class=\"token number\">3</span>/3 <span class=\"token punctuation\">[</span>00:0<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>&lt;</span>00:00,  <span class=\"token number\">2</span>.96it/s<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                   all         <span class=\"token number\">18</span>         <span class=\"token number\">20</span>      <span class=\"token number\">0.744</span>       <span class=\"token number\">0.75</span>       <span class=\"token number\">0.76</span>      <span class=\"token number\">0.333</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Results saved to runs<span class=\"token punctuation\">\\</span>train<span class=\"token punctuation\">\\</span>exp3</pre></td></tr></table></figure><p>单类检测效果不错，Precision 和 Recall 平衡良好，模型体积小，适合轻量部署，mAP50-95 仍然偏低，这对精确边界框要求高的任务可能不够稳，其实我觉得是数据集太小的缘故，再多一点效果可能更好。让我们看看这个图片，左边是标签，右边是预测：</p>\n<img data-src=\"../../../images/python/YOLO/v5/14.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<img data-src=\"../../../images/python/YOLO/v5/15.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<img data-src=\"../../../images/python/YOLO/v5/16.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<p>学的还行，加大数据集可能效果会更好。</p>\n<h1 id=\"参考\"><a class=\"markdownIt-Anchor\" href=\"#参考\">#</a> 参考</h1>\n<ol>\n<li>【yolov5 目标检测原理与实战】：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL0JWMXExenlZdEVyRQ==\">https://www.bilibili.com/video/BV1q1zyYtErE</span></li>\n<li>【ultralytics-YOLOv5】：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3VsdHJhbHl0aWNzL3lvbG92NQ==\">https://github.com/ultralytics/yolov5</span></li>\n</ol>\n<img data-src=\"../../../images/cover/ultralyticsv5.webp\" alt=\"1\" style=\"zoom: 100%;\" />\n<img data-src=\"https://cdn.jsdelivr.net/gh/ultralytics/assets@main/docs/Ultralytics-YOLO26-Benchmark.jpg\" alt=\"1\" style=\"zoom: 100%;\" />\n<p>在 YOLO 领域，从来不缺技术与人才，无数的人试图在这里证明自己，新的模块、新的数据处理方法，新的训练模式，加注意力，再加机器学习基础方法，不断的推动 YOLO 的发展。</p>\n<p>今天 ultralytics 重磅推出 YOLO26</p>\n",
            "tags": [
                "深度学习",
                "YOLO",
                "python",
                "CNN",
                "深度学习",
                "YOLO"
            ]
        },
        {
            "id": "https://735690757.github.io/python/YOLO/YOLO_V4/",
            "url": "https://735690757.github.io/python/YOLO/YOLO_V4/",
            "title": "YOLO-V4",
            "date_published": "2026-01-15T04:12:12.000Z",
            "content_html": "<h1 id=\"yolov4\"><a class=\"markdownIt-Anchor\" href=\"#yolov4\">#</a> YOLOv4</h1>\n<h2 id=\"原文\"><a class=\"markdownIt-Anchor\" href=\"#原文\">#</a> 原文</h2>\n<p>【YOLOv4: Optimal Speed and Accuracy of Object Detection】：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9hcnhpdi5vcmcvYWJzLzIwMDQuMTA5MzQ=\">https://arxiv.org/abs/2004.10934</span></p>\n<h2 id=\"现在目标检测器的主要构成\"><a class=\"markdownIt-Anchor\" href=\"#现在目标检测器的主要构成\">#</a> 现在目标检测器的主要构成</h2>\n<img data-src=\"../../../images/python/YOLO/v4/1.png\" alt=\"1\" style=\"zoom:80%;\" />\n<p>单阶段检测器和双阶段检测器的区别：双阶段主要是先找 “哪里可能有目标”，再判断 “是什么目标”，单阶段是直接一步到位：同时预测 “在哪 + 是什么”</p>\n<h2 id=\"免费包和特殊包\"><a class=\"markdownIt-Anchor\" href=\"#免费包和特殊包\">#</a> 免费包和特殊包？</h2>\n<p>Bag of Freebies 免费包：在不增加推理成本（FPS 不变）的情况下，提高检测精度的方法。</p>\n<ol>\n<li>\n<p>数据增强类</p>\n<ul>\n<li>\n<p>Mosaic 数据增强</p>\n</li>\n<li>\n<p>CutMix</p>\n</li>\n<li>\n<p>MixUp</p>\n</li>\n<li>\n<p>随机裁剪</p>\n</li>\n<li>\n<p>随机翻转</p>\n</li>\n<li>\n<p>颜色扰动</p>\n</li>\n<li>\n<p>数据生成</p>\n</li>\n</ul>\n</li>\n<li>\n<p>损失函数类</p>\n<ul>\n<li>\n<p>CIOU Loss</p>\n</li>\n<li>\n<p>Focal Loss</p>\n</li>\n<li>\n<p>Label Smoothing</p>\n</li>\n</ul>\n</li>\n<li>\n<p>正则化技巧</p>\n<ul>\n<li>\n<p>DropBlock</p>\n</li>\n<li>\n<p>Batch Normalization</p>\n</li>\n</ul>\n</li>\n</ol>\n<p>Bag of Specials 特殊包：在推理阶段也参与计算，能提高精度，但会增加模型复杂度的方法。</p>\n<ol>\n<li>SPP-Spatial Pyramid Pooling：不同尺寸池化，拼接，增强感受野。</li>\n<li>PANet：用于特征融合，加强低层与高层特征结合，提升小目标检测</li>\n<li>SAM-Spatial Attention Module：空间注意力机制。</li>\n<li>Mish 激活函数：YOLOv4 采用 Mish 代替 LeakyReLU</li>\n</ol>\n<h2 id=\"结构\"><a class=\"markdownIt-Anchor\" href=\"#结构\">#</a> 结构</h2>\n<img data-src=\"../../../images/python/YOLO/v4/2.png\" alt=\"1\" style=\"zoom:80%;\" />\n<h2 id=\"数据增强\"><a class=\"markdownIt-Anchor\" href=\"#数据增强\">#</a> 数据增强</h2>\n<h3 id=\"mixup\"><a class=\"markdownIt-Anchor\" href=\"#mixup\">#</a> MixUp</h3>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>x</mi><mo>=</mo><mi>λ</mi><msub><mi>x</mi><mi>i</mi></msub><mo>+</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mtext>−</mtext><mi>λ</mi><mo stretchy=\"false\">)</mo><msub><mi>x</mi><mi>j</mi></msub></mrow><annotation encoding=\"application/x-tex\">x=λx_i+(1−λ)x_j\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\">λ</span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.036108em;vertical-align:-0.286108em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mord\">−</span><span class=\"mord mathnormal\">λ</span><span class=\"mclose\">)</span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span></span></p>\n<p>MixUp 防止过拟合、提升泛化能力、让模型学习 “类别之间的连续过渡”，对检测不一定稳定</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">mixup_data</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> alpha<span class=\"token operator\">=</span><span class=\"token number\">1.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    lam <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>random<span class=\"token punctuation\">.</span>beta<span class=\"token punctuation\">(</span>alpha<span class=\"token punctuation\">,</span> alpha<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    batch_size <span class=\"token operator\">=</span> x<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    index <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>randperm<span class=\"token punctuation\">(</span>batch_size<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    mixed_x <span class=\"token operator\">=</span> lam <span class=\"token operator\">*</span> x <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">-</span> lam<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> x<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    y_a<span class=\"token punctuation\">,</span> y_b <span class=\"token operator\">=</span> y<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">return</span> mixed_x<span class=\"token punctuation\">,</span> y_a<span class=\"token punctuation\">,</span> y_b<span class=\"token punctuation\">,</span> lam</pre></td></tr></table></figure><img data-src=\"../../../images/python/YOLO/v4/3.png\" alt=\"1\" style=\"zoom:80%;\" />\n<img data-src=\"../../../images/python/YOLO/v4/4.png\" alt=\"1\" style=\"zoom:80%;\" />\n<h3 id=\"cutmix\"><a class=\"markdownIt-Anchor\" href=\"#cutmix\">#</a> CutMix</h3>\n<p>CutMix 保留清晰目标，比 MixUp 更真实，可能出现不自然边界</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">cutmix_data</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> alpha<span class=\"token operator\">=</span><span class=\"token number\">1.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    lam <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>random<span class=\"token punctuation\">.</span>beta<span class=\"token punctuation\">(</span>alpha<span class=\"token punctuation\">,</span> alpha<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    rand_index <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>randperm<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    w<span class=\"token punctuation\">,</span> h <span class=\"token operator\">=</span> x<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    rand_w <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>int_<span class=\"token punctuation\">(</span>lam <span class=\"token operator\">*</span> w<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    rand_h <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>int_<span class=\"token punctuation\">(</span>lam <span class=\"token operator\">*</span> h<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    x<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span>rand_w<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span>rand_h<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> x<span class=\"token punctuation\">[</span>rand_index<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span>rand_w<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span>rand_h<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    y_a<span class=\"token punctuation\">,</span> y_b <span class=\"token operator\">=</span> y<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">[</span>rand_index<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">return</span> x<span class=\"token punctuation\">,</span> y_a<span class=\"token punctuation\">,</span> y_b<span class=\"token punctuation\">,</span> lam</pre></td></tr></table></figure><img data-src=\"../../../images/python/YOLO/v4/5.png\" alt=\"1\" style=\"zoom:80%;\" />\n<img data-src=\"../../../images/python/YOLO/v4/8.png\" alt=\"1\" style=\"zoom:80%;\" />\n<h3 id=\"bluring\"><a class=\"markdownIt-Anchor\" href=\"#bluring\">#</a> Bluring</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">blur_data</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> sigma<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">return</span> transforms<span class=\"token punctuation\">.</span>GaussianBlur<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        kernel_size<span class=\"token operator\">=</span><span class=\"token number\">21</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        sigma<span class=\"token operator\">=</span>sigma</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><img data-src=\"../../../images/python/YOLO/v4/6.png\" alt=\"1\" style=\"zoom:80%;\" />\n<h3 id=\"mosaic\"><a class=\"markdownIt-Anchor\" href=\"#mosaic\">#</a> Mosaic</h3>\n<p>4 张图拼接 + 随机裁剪，一次输入看到 4 张图，等价扩大 batch size，可能降低定位精度，训练早期不稳定</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> numpy <span class=\"token keyword\">as</span> np</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> cv2</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> PIL <span class=\"token keyword\">import</span> Image</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">mosaic_augmentation</span><span class=\"token punctuation\">(</span>images<span class=\"token punctuation\">,</span> labels<span class=\"token punctuation\">,</span> img_size<span class=\"token operator\">=</span><span class=\"token number\">640</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    mosaic_img <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>full<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>img_size <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> img_size <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">114</span><span class=\"token punctuation\">,</span> dtype<span class=\"token operator\">=</span>np<span class=\"token punctuation\">.</span>uint8<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    xc<span class=\"token punctuation\">,</span> yc <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>random<span class=\"token punctuation\">.</span>uniform<span class=\"token punctuation\">(</span>img_size <span class=\"token operator\">*</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> img_size <span class=\"token operator\">*</span> <span class=\"token number\">1.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    mosaic_labels <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">for</span> i<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">,</span> label<span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span> <span class=\"token builtin\">enumerate</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">zip</span><span class=\"token punctuation\">(</span>images<span class=\"token punctuation\">,</span> labels<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        img_w<span class=\"token punctuation\">,</span> img_h <span class=\"token operator\">=</span> img<span class=\"token punctuation\">.</span>size</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        scale <span class=\"token operator\">=</span> <span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span>img_size <span class=\"token operator\">/</span> img_w<span class=\"token punctuation\">,</span> img_size <span class=\"token operator\">/</span> img_h<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        new_w<span class=\"token punctuation\">,</span> new_h <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>img_w <span class=\"token operator\">*</span> scale<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>img_h <span class=\"token operator\">*</span> scale<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        img_resized <span class=\"token operator\">=</span> img<span class=\"token punctuation\">.</span>resize<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>new_w<span class=\"token punctuation\">,</span> new_h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Image<span class=\"token punctuation\">.</span>BILINEAR<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        img_cv <span class=\"token operator\">=</span> cv2<span class=\"token punctuation\">.</span>cvtColor<span class=\"token punctuation\">(</span>np<span class=\"token punctuation\">.</span>array<span class=\"token punctuation\">(</span>img_resized<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> cv2<span class=\"token punctuation\">.</span>COLOR_RGB2BGR<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">if</span> i <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># 左上角</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            x1a<span class=\"token punctuation\">,</span> y1a<span class=\"token punctuation\">,</span> x2a<span class=\"token punctuation\">,</span> y2a <span class=\"token operator\">=</span> <span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span>xc <span class=\"token operator\">-</span> new_w<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span>yc <span class=\"token operator\">-</span> new_h<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> xc<span class=\"token punctuation\">,</span> yc</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            x1b<span class=\"token punctuation\">,</span> y1b<span class=\"token punctuation\">,</span> x2b<span class=\"token punctuation\">,</span> y2b <span class=\"token operator\">=</span> new_w <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>x2a <span class=\"token operator\">-</span> x1a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> new_h <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>y2a <span class=\"token operator\">-</span> y1a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> new_w<span class=\"token punctuation\">,</span> new_h</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">elif</span> i <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># 右上角</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            x1a<span class=\"token punctuation\">,</span> y1a<span class=\"token punctuation\">,</span> x2a<span class=\"token punctuation\">,</span> y2a <span class=\"token operator\">=</span> xc<span class=\"token punctuation\">,</span> <span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span>yc <span class=\"token operator\">-</span> new_h<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span>xc <span class=\"token operator\">+</span> new_w<span class=\"token punctuation\">,</span> img_size <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> yc</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            x1b<span class=\"token punctuation\">,</span> y1b<span class=\"token punctuation\">,</span> x2b<span class=\"token punctuation\">,</span> y2b <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> new_h <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>y2a <span class=\"token operator\">-</span> y1a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span>new_w<span class=\"token punctuation\">,</span> x2a <span class=\"token operator\">-</span> x1a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> new_h</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token keyword\">elif</span> i <span class=\"token operator\">==</span> <span class=\"token number\">2</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># 左下角</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            x1a<span class=\"token punctuation\">,</span> y1a<span class=\"token punctuation\">,</span> x2a<span class=\"token punctuation\">,</span> y2a <span class=\"token operator\">=</span> <span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span>xc <span class=\"token operator\">-</span> new_w<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> yc<span class=\"token punctuation\">,</span> xc<span class=\"token punctuation\">,</span> <span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span>yc <span class=\"token operator\">+</span> new_h<span class=\"token punctuation\">,</span> img_size <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            x1b<span class=\"token punctuation\">,</span> y1b<span class=\"token punctuation\">,</span> x2b<span class=\"token punctuation\">,</span> y2b <span class=\"token operator\">=</span> new_w <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>x2a <span class=\"token operator\">-</span> x1a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> new_w<span class=\"token punctuation\">,</span> <span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span>y2a <span class=\"token operator\">-</span> y1a<span class=\"token punctuation\">,</span> new_h<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token keyword\">elif</span> i <span class=\"token operator\">==</span> <span class=\"token number\">3</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># 右下角</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            x1a<span class=\"token punctuation\">,</span> y1a<span class=\"token punctuation\">,</span> x2a<span class=\"token punctuation\">,</span> y2a <span class=\"token operator\">=</span> xc<span class=\"token punctuation\">,</span> yc<span class=\"token punctuation\">,</span> <span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span>xc <span class=\"token operator\">+</span> new_w<span class=\"token punctuation\">,</span> img_size <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span>yc <span class=\"token operator\">+</span> new_h<span class=\"token punctuation\">,</span> img_size <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            x1b<span class=\"token punctuation\">,</span> y1b<span class=\"token punctuation\">,</span> x2b<span class=\"token punctuation\">,</span> y2b <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span>new_w<span class=\"token punctuation\">,</span> x2a <span class=\"token operator\">-</span> x1a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span>new_h<span class=\"token punctuation\">,</span> y2a <span class=\"token operator\">-</span> y1a<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        mosaic_img<span class=\"token punctuation\">[</span>y1a<span class=\"token punctuation\">:</span>y2a<span class=\"token punctuation\">,</span> x1a<span class=\"token punctuation\">:</span>x2a<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> img_cv<span class=\"token punctuation\">[</span>y1b<span class=\"token punctuation\">:</span>y2b<span class=\"token punctuation\">,</span> x1b<span class=\"token punctuation\">:</span>x2b<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        padw <span class=\"token operator\">=</span> x1a <span class=\"token operator\">-</span> x1b</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        padh <span class=\"token operator\">=</span> y1a <span class=\"token operator\">-</span> y1b</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token keyword\">if</span> label<span class=\"token punctuation\">.</span>size <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            label<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>label<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> new_w <span class=\"token operator\">+</span> padw<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>img_size <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            label<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>label<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> new_h <span class=\"token operator\">+</span> padh<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>img_size <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            label<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> label<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> new_w <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>img_size <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            label<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> label<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> new_h <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>img_size <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            mosaic_labels<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>label<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    mosaic_labels <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>vstack<span class=\"token punctuation\">(</span>mosaic_labels<span class=\"token punctuation\">)</span> <span class=\"token keyword\">if</span> mosaic_labels <span class=\"token keyword\">else</span> np<span class=\"token punctuation\">.</span>empty<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    mosaic_img <span class=\"token operator\">=</span> Image<span class=\"token punctuation\">.</span>fromarray<span class=\"token punctuation\">(</span>cv2<span class=\"token punctuation\">.</span>cvtColor<span class=\"token punctuation\">(</span>mosaic_img<span class=\"token punctuation\">,</span> cv2<span class=\"token punctuation\">.</span>COLOR_BGR2RGB<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token keyword\">return</span> mosaic_img<span class=\"token punctuation\">,</span> mosaic_labels</pre></td></tr></table></figure><img data-src=\"../../../images/python/YOLO/v4/7.png\" alt=\"1\" style=\"zoom:80%;\" />\n<h2 id=\"激活函数\"><a class=\"markdownIt-Anchor\" href=\"#激活函数\">#</a> 激活函数</h2>\n<img data-src=\"../../../images/python/YOLO/v4/9.png\" alt=\"1\" style=\"zoom:80%;\" />\n<img data-src=\"../../../images/python/YOLO/v4/10.png\" alt=\"1\" style=\"zoom:80%;\" />\n<p>Mish 是一个 “理论优雅、效果稳定，但工程性价比一般” 的激活函数。</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>M</mi><mi>i</mi><mi>s</mi><mi>h</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mi>x</mi><mo>⋅</mo><mi>t</mi><mi>a</mi><mi>n</mi><mi>h</mi><mo stretchy=\"false\">(</mo><mi>l</mi><mi>n</mi><mo stretchy=\"false\">(</mo><mn>1</mn><mo>+</mo><msup><mi>e</mi><mi>x</mi></msup><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">Mish(x)=x⋅tanh(ln(1+e^x))\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">M</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">h</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.44445em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">h</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">n</span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">e</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7143919999999999em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mclose\">)</span></span></span></span></span></p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">YOLO 版本</th>\n<th style=\"text-align:center\">激活</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">YOLOv3</td>\n<td style=\"text-align:center\">Leaky ReLU</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">YOLOv4</td>\n<td style=\"text-align:center\"><strong>Mish</strong></td>\n</tr>\n<tr>\n<td style=\"text-align:center\">YOLOv5</td>\n<td style=\"text-align:center\">SiLU (Swish)</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">YOLOv7</td>\n<td style=\"text-align:center\">SiLU</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">YOLOv8</td>\n<td style=\"text-align:center\">SiLU</td>\n</tr>\n</tbody>\n</table>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>S</mi><mi>i</mi><mi>L</mi><mi>U</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mfrac><mi>x</mi><mrow><mn>1</mn><mo>+</mo><msup><mi>e</mi><mrow><mtext>−</mtext><mi>x</mi></mrow></msup></mrow></mfrac></mrow><annotation encoding=\"application/x-tex\">SiLU(x)=\\frac{x}{1+e^{−x}}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">L</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.8768900000000002em;vertical-align:-0.7693300000000001em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.10756em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">e</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.697331em;\"><span style=\"top:-2.989em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">−</span><span class=\"mord mathnormal mtight\">x</span></span></span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7693300000000001em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span></p>\n<p>SiLU 本质上就是 Swish 的 β=1 的情况。</p>\n<h2 id=\"标签平滑\"><a class=\"markdownIt-Anchor\" href=\"#标签平滑\">#</a> 标签平滑</h2>\n<p>标签平滑是不再把真实标签当成 100% 确定，而是留一点不确定性。</p>\n<img data-src=\"../../../images/python/YOLO/v4/11.png\" alt=\"1\" style=\"zoom:80%;\" />\n<p>推荐在分类任务、检测中的分类头、小数据集、类别不均衡、有噪声标签中使用。</p>\n<p>不太适合回归任务、精细分割边界，或已经是 soft label 的任务，如 MixUp 后。</p>\n<h2 id=\"resnetdensenetresnextcspresnext\"><a class=\"markdownIt-Anchor\" href=\"#resnetdensenetresnextcspresnext\">#</a> ResNet…DenseNet…ResNeXt…CSPResNeXt</h2>\n<h3 id=\"resnext\"><a class=\"markdownIt-Anchor\" href=\"#resnext\">#</a> ResNeXt</h3>\n<p>【Aggregated Residual Transformations for Deep Neural Networks】：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9hcnhpdi5vcmcvYWJzLzE2MTEuMDU0MzE=\">https://arxiv.org/abs/1611.05431</span></p>\n<img data-src=\"../../../images/python/YOLO/v4/12.png\" alt=\"1\" style=\"zoom:80%;\" />\n<img data-src=\"../../../images/python/YOLO/v4/13.png\" alt=\"1\" style=\"zoom:80%;\" />\n<p>ResNeXt 的一个 block，可以用三种 “等价” 的方式实现：</p>\n<img data-src=\"../../../images/python/YOLO/v4/14.png\" alt=\"1\" style=\"zoom:80%;\" />\n<p>(a) 多路径残差分支（概念版）</p>\n<p>(b) 提前 concat 的实现（工程版）</p>\n<p>© group convolution 的实现（最终高效版）</p>\n<p>这个 group convolution 是整篇 ResNeXt 的工程精华，核心思想是把 (b) 中的多分支 + concat，压缩成一次 group convolution。</p>\n<p>conv：</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mi>Y</mi><mi>j</mi></msub><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>C</mi><mrow><mi>i</mi><mi>n</mi></mrow></msub></munderover><msub><mi>X</mi><mi>i</mi></msub><mo>∗</mo><msub><mi>W</mi><mrow><mi>i</mi><mo separator=\"true\">,</mo><mi>j</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">Y_j = \\sum_{i=1}^{C_{in}} X_i * W_{i,j}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">Y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:3.1171050000000005em;vertical-align:-1.277669em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8394360000000003em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">1</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.311105em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">C</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3280857142857143em;\"><span style=\"top:-2.357em;margin-left:-0.07153em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">n</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.143em;\"><span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">X</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">∗</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span></span></p>\n<p>group  conv：</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mi>Y</mi><mi>j</mi></msub><mo>=</mo><munder><mo>∑</mo><mrow><mi>i</mi><mo>∈</mo><msub><mtext>group</mtext><mi>k</mi></msub></mrow></munder><msub><mi>X</mi><mi>i</mi></msub><mo>∗</mo><msub><mi>W</mi><mrow><mi>i</mi><mo separator=\"true\">,</mo><mi>j</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">Y_j = \\sum_{i \\in \\text{group}_k} X_i * W_{i,j}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">Y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.513782em;vertical-align:-1.463777em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.050005em;\"><span style=\"top:-1.8723309999999997em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">∈</span><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">group</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.23015999999999992em;\"><span style=\"top:-2.2341314285714287em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.26586857142857145em;\"><span></span></span></span></span></span></span></span></span></span><span style=\"top:-3.0500049999999996em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.463777em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">X</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">∗</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span></span></p>\n<table G=\"\">\n<thead>\n<tr>\n<th style=\"text-align:center\">维度</th>\n<th style=\"text-align:center\">普通卷积</th>\n<th style=\"text-align:center\">分组卷积</th>\n</tr>\n</thead>\n<tbody>\n<tr G=\"\">\n<td style=\"text-align:center\">参数量</td>\n<td style=\"text-align:center\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>C</mi><mrow><mi>i</mi><mi>n</mi></mrow></msub><mo>×</mo><msub><mi>C</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><mo>×</mo><msup><mi>k</mi><mn>2</mn></msup></mrow><annotation encoding=\"application/x-tex\">C_{in} \\times C_{out} \\times k^2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">n</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2805559999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">u</span><span class=\"mord mathnormal mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8141079999999999em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></td>\n<td style=\"text-align:center\">\\frac{C_{in} \\times C_{out} \\times k^2}</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">计算量</td>\n<td style=\"text-align:center\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>H</mi><mo>×</mo><mi>W</mi><mo>×</mo><msub><mi>C</mi><mrow><mi>i</mi><mi>n</mi></mrow></msub><mo>×</mo><msub><mi>C</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><mo>×</mo><msup><mi>k</mi><mn>2</mn></msup></mrow><annotation encoding=\"application/x-tex\">H \\times W \\times C_{in} \\times C_{out} \\times k^2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76666em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.08125em;\">H</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.76666em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">n</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2805559999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">u</span><span class=\"mord mathnormal mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8141079999999999em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></td>\n<td style=\"text-align:center\">\\frac{H \\times W \\times C_{in} \\times C_{out} \\times k^2}</td>\n</tr>\n</tbody>\n</table>\n<p>【Fundamental Algorithm of Convolution in Neural Networks】：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueW91dHViZS5jb20vd2F0Y2g/dj1lTVh1azk3TmVTSQ==\">https://www.youtube.com/watch?v=eMXuk97NeSI</span></p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> torch<span class=\"token punctuation\">.</span>nn <span class=\"token keyword\">as</span> nn</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>conv <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    in_channels<span class=\"token operator\">=</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    out_channels<span class=\"token operator\">=</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    kernel_size<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    padding<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    groups<span class=\"token operator\">=</span><span class=\"token number\">32</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>普通卷积（1 分组）：</p>\n<img data-src=\"https://animatedai.github.io/media/convolution-animation-3x3-kernel.gif\" alt=\"1\" style=\"zoom:80%;\" />\n<p>2 分组卷积：</p>\n<img data-src=\"https://animatedai.github.io/media/convolution-animation-3x3-kernel-2-groups.gif\" alt=\"1\" style=\"zoom:80%;\" />\n<p>8 分组卷积：</p>\n<img data-src=\"https://animatedai.github.io/media/depthwise-convolution-animation-3x3-kernel.gif\" alt=\"1\" style=\"zoom:80%;\" />\n<p>8 分组深度可分离卷积：</p>\n<img data-src=\"https://animatedai.github.io/media/depthwise-separable-convolution-animation-3x3-kernel.gif\" alt=\"1\" style=\"zoom:80%;\" />\n<h3 id=\"densenet\"><a class=\"markdownIt-Anchor\" href=\"#densenet\">#</a> DenseNet</h3>\n<img data-src=\"../../../images/python/YOLO/v4/15.png\" alt=\"1\" style=\"zoom:80%;\" />\n<h3 id=\"cspnet\"><a class=\"markdownIt-Anchor\" href=\"#cspnet\">#</a> CSPNet</h3>\n<img data-src=\"../../../images/python/YOLO/v4/16.png\" alt=\"1\" style=\"zoom:80%;\" />\n<h3 id=\"cspresnext\"><a class=\"markdownIt-Anchor\" href=\"#cspresnext\">#</a> CSPResNeXt</h3>\n<img data-src=\"../../../images/python/YOLO/v4/17.png\" alt=\"1\" style=\"zoom:80%;\" />\n<p>前后通道数量保持不变，注意过程是通道数量砍半了，然后后续通过拼接又回来了。</p>\n<h2 id=\"spp空间金字塔池化\"><a class=\"markdownIt-Anchor\" href=\"#spp空间金字塔池化\">#</a> SPP 空间金字塔池化</h2>\n<img data-src=\"../../../images/python/YOLO/v4/18.png\" alt=\"1\" style=\"zoom:80%;\" />\n<p>YOLOv4 的 SPP 是在不改变特征图尺寸的情况下，用不同尺度的池化来扩大感受野并融合多尺度上下文信息。</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">版本</th>\n<th style=\"text-align:center\">SPP</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">YOLOv4</td>\n<td style=\"text-align:center\">SPP</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">YOLOv5</td>\n<td style=\"text-align:center\">SPPF（Fast SPP）</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">YOLOv8</td>\n<td style=\"text-align:center\">SPPF</td>\n</tr>\n</tbody>\n</table>\n<p>SPP 不改变尺寸，只是扩大感受野，最后 concat，本质是<strong>多尺度特征融合</strong></p>\n<p>为什么不直接用大卷积核？因为参数太多，计算量太大，而 MaxPool 无参数，计算便宜，稳定，这使得以成本极低的方式扩大感受野。</p>\n<p>SPP 不是替代普通池化，而是用 “并行大核池化” 增强特征表达，且不改变分辨率。</p>\n<h2 id=\"fpnpan\"><a class=\"markdownIt-Anchor\" href=\"#fpnpan\">#</a> FPN+PAN</h2>\n<p>v3 的 FPN：</p>\n<img data-src=\"../../../images/python/YOLO/v3/3.png\" alt=\"3\" style=\"zoom:80%;\" />\n<p>v4 的 FPN+PAN：</p>\n<img data-src=\"../../../images/python/YOLO/v4/19.png\" alt=\"1\" style=\"zoom:80%;\" />\n<h2 id=\"eliminate-grid-sensitivity\"><a class=\"markdownIt-Anchor\" href=\"#eliminate-grid-sensitivity\">#</a> Eliminate grid sensitivity</h2>\n<p>在 YOLOv3 中，中心点坐标计算公式为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>b</mi><mi>x</mi></msub><mo>=</mo><mi>σ</mi><mo stretchy=\"false\">(</mo><msub><mi>t</mi><mi>x</mi></msub><mo stretchy=\"false\">)</mo><mo>+</mo><msub><mi>c</mi><mi>x</mi></msub></mrow><annotation encoding=\"application/x-tex\">b_x = \\sigma(t_x) + c_x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">σ</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>。Sigmoid 函数的输出范围是 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">(</mo><mn>0</mn><mo separator=\"true\">,</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">(0, 1)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">0</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">)</span></span></span></span>，因此中心点 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>b</mi><mi>x</mi></msub></mrow><annotation encoding=\"application/x-tex\">b_x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 永远被锁在当前网格 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>c</mi><mi>x</mi></msub></mrow><annotation encoding=\"application/x-tex\">c_x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 内部。但是这不挺好的嘛？其实不然，如果你想让中心点刚好落在网格的<strong>边界线</strong>上，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>σ</mi><mo stretchy=\"false\">(</mo><msub><mi>t</mi><mi>x</mi></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\sigma(t_x)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">σ</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span> 必须取到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>0</mn></mrow><annotation encoding=\"application/x-tex\">0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">0</span></span></span></span> 或 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span>。但 Sigmoid 函数只有在自变量趋于正负无穷时才能接近 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>0</mn></mrow><annotation encoding=\"application/x-tex\">0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">0</span></span></span></span> 或 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span>。这导致模型在预测边缘物体时非常困难，容易产生大幅波动。</p>\n<p>YOLOv4 的解法是给中心点 “松绑” YOLOv4 引入了 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mtext>scale</mtext><mrow><mi>x</mi><mi>y</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\text{scale}_{xy}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.980548em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">scale</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">x</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span>（通常取 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2</mn></mrow><annotation encoding=\"application/x-tex\">2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">2</span></span></span></span> 或 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1.05</mn></mrow><annotation encoding=\"application/x-tex\">1.05</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\">.</span><span class=\"mord\">0</span><span class=\"mord\">5</span></span></span></span>），公式变为：</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mi>b</mi><mi>x</mi></msub><mo>=</mo><mo stretchy=\"false\">(</mo><mi>σ</mi><mo stretchy=\"false\">(</mo><msub><mi>t</mi><mi>x</mi></msub><mo stretchy=\"false\">)</mo><mo>⋅</mo><msub><mtext>scale</mtext><mrow><mi>x</mi><mi>y</mi></mrow></msub><mo>−</mo><mfrac><mrow><msub><mtext>scale</mtext><mrow><mi>x</mi><mi>y</mi></mrow></msub><mo>−</mo><mn>1</mn></mrow><mn>2</mn></mfrac><mo stretchy=\"false\">)</mo><mo>+</mo><msub><mi>c</mi><mi>x</mi></msub></mrow><annotation encoding=\"application/x-tex\">b_x = (\\sigma(t_x) \\cdot \\text{scale}_{xy} - \\frac{\\text{scale}_{xy} - 1}{2}) + c_x\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">σ</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.980548em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">scale</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">x</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.05744em;vertical-align:-0.686em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.37144em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">2</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">scale</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">x</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></span></p>\n<p>当 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mtext>scale</mtext><mrow><mi>x</mi><mi>y</mi></mrow></msub><mo>=</mo><mn>2</mn></mrow><annotation encoding=\"application/x-tex\">\\text{scale}_{xy} = 2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.980548em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">scale</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">x</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">2</span></span></span></span> 时，括号内的取值范围从 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">(</mo><mn>0</mn><mo separator=\"true\">,</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">(0, 1)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">0</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">)</span></span></span></span> 扩展到了 <strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">(</mo><mo>−</mo><mn>0.5</mn><mo separator=\"true\">,</mo><mn>1.5</mn><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">(-0.5, 1.5)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">−</span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">5</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">1</span><span class=\"mord\">.</span><span class=\"mord\">5</span><span class=\"mclose\">)</span></span></span></span></strong>。如果物体中心点刚好在两个网格的交界处，现在的模型可以让<strong>左右两个网格</strong>都非常有自信地回归到这个点。 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>σ</mi><mo stretchy=\"false\">(</mo><msub><mi>t</mi><mi>x</mi></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\sigma(t_x)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">σ</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span> 只需要取到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>0.5</mn></mrow><annotation encoding=\"application/x-tex\">0.5</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">5</span></span></span></span> 左右（这是函数最敏感、梯度最大的区域）就能轻松覆盖边界，不再需要逼近正负无穷。</p>\n<h2 id=\"多正样本策略\"><a class=\"markdownIt-Anchor\" href=\"#多正样本策略\">#</a> 多正样本策略</h2>\n<p>YOLOv3 里，匹配逻辑非常严苛：</p>\n<ol>\n<li>计算目标与所有 Anchor 的 IOU。</li>\n<li><strong>只有 IOU 最大的那个</strong>才被选为正样本。</li>\n</ol>\n<p>如果一个物体长宽比很特殊，可能只有一个 Anchor 勉强达标，导致训练样本极少，模型学得慢且不稳定。</p>\n<p>YOLOv4 不再单纯看 IOU 最大值，而是看<strong>长宽比</strong>。只要某个 Anchor 与目标的宽高比例在一定阈值内，这个 Anchor 就会被视为正样本。对于同一个中心点，可能同时有 2 个或 3 个不同尺寸的 Anchor 都在负责预测这个物体。这个改进本质上是<strong>降低了正样本的准入门槛</strong>。通过让多个 Anchor 和多个邻近网格共同预测一个目标。</p>\n<h2 id=\"超参数自动化搜索遗传算法\"><a class=\"markdownIt-Anchor\" href=\"#超参数自动化搜索遗传算法\">#</a> 超参数自动化搜索（遗传算法）</h2>\n<ol>\n<li>初始化种群：随机生成几组超参数组合，比如 10 组。</li>\n<li>计算适应度：用这些参数去跑模型，看谁的准确率高或损失值低。</li>\n<li>选择优良个体：选出表现最好的几组参数。</li>\n<li>交叉与变异：\n<ul>\n<li>交叉：让两组好参数结婚，产生融合了双方优点的新参数。</li>\n<li>变异：随机改变某个参数的值，防止模型陷入局部最优，寻找意外惊喜。</li>\n</ul>\n</li>\n<li><strong>迭代</strong>：不断循环，直到找到那组最完美的超参数。</li>\n</ol>\n<h2 id=\"cmbn跨批量标准化\"><a class=\"markdownIt-Anchor\" href=\"#cmbn跨批量标准化\">#</a> CmBN 跨批量标准化</h2>\n<p>简单来说，CmBN 解决了没钱买顶级显卡，但也想让模型像在顶级显卡上一样稳定训练的问题。</p>\n<p>大 Batch 如 64, 算出的均值和方差很稳，模型收敛快。小 Batch 如 4，这可能会使得统计量波动巨大，会导致模型精度断崖式下跌。</p>\n<p>BN 需要计算一个 Batch 数据的均值和方差。如果显存不足，只能用很小的 Batch（比如 2 或 4），计算出来的统计量就不准，训练会不稳定。</p>\n<ol>\n<li>BN： 每个 mini-batch 独立计算，互不干扰。</li>\n<li>CBN： 收集前几次迭代的统计量来共同估计当前的均值方差。</li>\n<li>CmBN： 它是在一个完整的 “大 Batch” 内部收集统计信息。</li>\n</ol>\n<p>CmBN 是在 CBN 的基础上改进而来的。它的核心逻辑是将一个大 Batch 拆分为多个 mini-batches，并按以下步骤运行：</p>\n<ol>\n<li>设定迭代次数：假设将一个完整的大 Batch 分为 4 次迭代。</li>\n<li>梯度累积：在前 3 次迭代中，只计算梯度并累加，不清除梯度，也不更新权重 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>W</mi></mrow><annotation encoding=\"application/x-tex\">W</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span></span></span></span>。</li>\n<li>统计量收集：计算每个时刻的 BN 统计量。</li>\n<li>归一化与更新：直到第 4 次迭代完成，模型会利用这 4 次累积的统计信息进行归一化，并最终更新一次权重和缩放位移参数。</li>\n</ol>\n<h2 id=\"余弦退火\"><a class=\"markdownIt-Anchor\" href=\"#余弦退火\">#</a> 余弦退火</h2>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>l</mi><mi>r</mi><mo stretchy=\"false\">(</mo><mi>t</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mi>l</mi><msub><mi>r</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><mo>+</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mo stretchy=\"false\">(</mo><mi>l</mi><msub><mi>r</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><mo>−</mo><mi>l</mi><msub><mi>r</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><mo stretchy=\"false\">)</mo><mrow><mo fence=\"true\">(</mo><mn>1</mn><mo>+</mo><mi>cos</mi><mo>⁡</mo><mrow><mo fence=\"true\">(</mo><mfrac><msub><mi>T</mi><mrow><mi>c</mi><mi>u</mi><mi>r</mi></mrow></msub><msub><mi>T</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub></mfrac><mi>π</mi><mo fence=\"true\">)</mo></mrow><mo fence=\"true\">)</mo></mrow></mrow><annotation encoding=\"application/x-tex\">lr(t) = lr_{min} + \\frac{1}{2}(lr_{max} - lr_{min})\\left(1 + \\cos\\left(\\frac{T_{cur}}{T_{max}}\\pi\\right)\\right)\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">t</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">m</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">n</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.00744em;vertical-align:-0.686em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.32144em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">2</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">m</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">x</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.40003em;vertical-align:-0.95003em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">m</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">n</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">(</span></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mop\">cos</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">(</span></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.36033em;\"><span style=\"top:-2.3139999999999996em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">m</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">x</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\">u</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8360000000000001em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">π</span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">)</span></span></span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">)</span></span></span></span></span></span></span></p>\n<p>一般论文里是有启停周期的，是余弦退火的一种变体：带热重启的余弦退火。</p>\n<p>下降阶段，学习率会从最大值 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>l</mi><msub><mi>r</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">lr_{max}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">m</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">x</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 随时间缓慢下降到最小值 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>l</mi><msub><mi>r</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">lr_{min}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">m</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">n</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>。 这能让模型在训练后期更加平稳地收敛，精准地找到最优解。当学习率降到最低点后，它会突然弹回到高位。 目的是给模型一个大的冲力，让它跳出可能陷入的局部最优解，去探索更好的区域。</p>\n<h2 id=\"从mse到iou\"><a class=\"markdownIt-Anchor\" href=\"#从mse到iou\">#</a> 从 MSE 到 IoU</h2>\n<p>MSE 的局限：它对尺度不敏感。同样是 5 像素的误差，对大目标很小，对小目标却是致命的。此外，它不关心框与框之间的重叠程度。</p>\n<p>IoU 的优越性：直接衡量两个框的重合度，更直观且鲁棒。</p>\n<p>IoU 的痛点：当两个框不重叠时，IoU 恒为 0，梯度消失，模型无法优化。这就是为什么后来又演化出了 <strong>GIoU, DIoU, CIoU</strong>，YOLOv4 最终采用了 CIoU。</p>\n<h3 id=\"giou解决不重叠\"><a class=\"markdownIt-Anchor\" href=\"#giou解决不重叠\">#</a> GIoU 解决不重叠</h3>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>G</mi><mi>I</mi><mi>o</mi><mi>U</mi><mo>=</mo><mi>I</mi><mi>o</mi><mi>U</mi><mo>−</mo><mfrac><mrow><mi mathvariant=\"normal\">∣</mi><mi>C</mi><mo>−</mo><mo stretchy=\"false\">(</mo><mi>A</mi><mo>∪</mo><mi>B</mi><mo stretchy=\"false\">)</mo><mi mathvariant=\"normal\">∣</mi></mrow><mrow><mi mathvariant=\"normal\">∣</mi><mi>C</mi><mi mathvariant=\"normal\">∣</mi></mrow></mfrac></mrow><annotation encoding=\"application/x-tex\">GIoU = IoU - \\frac{|C - (A \\cup B)|}{|C|}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">G</span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.76666em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.363em;vertical-align:-0.936em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.427em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">∣</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord\">∣</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">∣</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">A</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">∪</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mclose\">)</span><span class=\"mord\">∣</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.936em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span></p>\n<p>核心思想：引入一个能包围预测框和真实框的最小外接矩形<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>C</mi></mrow><annotation encoding=\"application/x-tex\">C</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span></span></span></span>。</p>\n<ul>\n<li><strong>原理</strong>：在 IoU 的基础上，减去一个惩罚项。这个惩罚项计算的是 “闭包区域中不属于两个框的空白部分” 占闭包区域的比例。</li>\n<li><strong>优点</strong>：当两个框不重叠时，GIoU 不再是 0，而是一个负值。这样模型就能感知到两个框的距离，从而产生梯度，拉动它们互相靠近。</li>\n<li><strong>缺点</strong>：当一个框完全包含另一个框时，GIoU 会退化回 IoU，无法判断内部框的位置优劣。</li>\n</ul>\n<h3 id=\"diou解决giou收敛速度慢与退化问题\"><a class=\"markdownIt-Anchor\" href=\"#diou解决giou收敛速度慢与退化问题\">#</a> DIoU 解决 GIoU 收敛速度慢与退化问题</h3>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>D</mi><mi>I</mi><mi>o</mi><mi>U</mi><mo>=</mo><mi>I</mi><mi>o</mi><mi>U</mi><mo>−</mo><mfrac><mrow><msup><mi>ρ</mi><mn>2</mn></msup><mo stretchy=\"false\">(</mo><mi>b</mi><mo separator=\"true\">,</mo><msup><mi>b</mi><mrow><mi>g</mi><mi>t</mi></mrow></msup><mo stretchy=\"false\">)</mo></mrow><msup><mi>c</mi><mn>2</mn></msup></mfrac></mrow><annotation encoding=\"application/x-tex\">DIoU = IoU - \\frac{\\rho^2(b, b^{gt})}{c^2}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.76666em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.177108em;vertical-align:-0.686em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.491108em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.740108em;\"><span style=\"top:-2.9890000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\">ρ</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">b</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7935559999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">g</span><span class=\"mord mathnormal mtight\">t</span></span></span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span></p>\n<p><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>I</mi><mi>o</mi><mi>U</mi></mrow><annotation encoding=\"application/x-tex\">IoU</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span></span></span></span></strong>: 传统的交并比。</p>\n<p><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>b</mi><mo separator=\"true\">,</mo><msup><mi>b</mi><mrow><mi>g</mi><mi>t</mi></mrow></msup></mrow><annotation encoding=\"application/x-tex\">b, b^{gt}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9879959999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">b</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7935559999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">g</span><span class=\"mord mathnormal mtight\">t</span></span></span></span></span></span></span></span></span></span></span></span></strong>: 分别代表预测框和真实框的<strong>中心点</strong>。</p>\n<p><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>ρ</mi></mrow><annotation encoding=\"application/x-tex\">\\rho</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">ρ</span></span></span></span></strong>: 代表两个中心点之间的<strong>欧几里得距离</strong>。</p>\n<p><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi></mrow><annotation encoding=\"application/x-tex\">c</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">c</span></span></span></span></strong>: 能够同时包含预测框和真实框的<strong>最小外接矩形</strong>的对角线长度。</p>\n<p>DIoU 在 IoU 的基础上增加了一个惩罚项。如果两个框离得越远，惩罚就越大。</p>\n<p>当预测框 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>A</mi></mrow><annotation encoding=\"application/x-tex\">A</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">A</span></span></span></span> 完全包含在真实框 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>B</mi></mrow><annotation encoding=\"application/x-tex\">B</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span></span></span></span> 内部时，GIoU 的计算公式中，<strong>“最小外接矩形” 其实就是那个较大的真实框 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>B</mi></mrow><annotation encoding=\"application/x-tex\">B</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span></span></span></span></strong>。此时，GIoU 的惩罚项会变成一个固定值或者无法提供有效的梯度来移动内部的小框。</p>\n<h3 id=\"ciou是diou的完整增强版\"><a class=\"markdownIt-Anchor\" href=\"#ciou是diou的完整增强版\">#</a> CIoU 是 DIoU 的完整增强版</h3>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>C</mi><mi>I</mi><mi>o</mi><mi>U</mi><mo>=</mo><mi>I</mi><mi>o</mi><mi>U</mi><mo>−</mo><mrow><mo fence=\"true\">(</mo><mfrac><mrow><msup><mi>ρ</mi><mn>2</mn></msup><mo stretchy=\"false\">(</mo><mi>b</mi><mo separator=\"true\">,</mo><msup><mi>b</mi><mrow><mi>g</mi><mi>t</mi></mrow></msup><mo stretchy=\"false\">)</mo></mrow><msup><mi>c</mi><mn>2</mn></msup></mfrac><mo>+</mo><mi>α</mi><mi>v</mi><mo fence=\"true\">)</mo></mrow></mrow><annotation encoding=\"application/x-tex\">CIoU = IoU - \\left( \\frac{\\rho^2(b, b^{gt})}{c^2} + \\alpha v \\right)\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.76666em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.441138em;vertical-align:-0.95003em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">(</span></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.491108em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.740108em;\"><span style=\"top:-2.9890000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\">ρ</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">b</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7935559999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">g</span><span class=\"mord mathnormal mtight\">t</span></span></span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">α</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">)</span></span></span></span></span></span></span></p>\n<p>其中，新增的两个关键参数含义如下：</p>\n<p><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>v</mi></mrow><annotation encoding=\"application/x-tex\">v</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span></span></span></span></strong>：用来衡量<strong>长宽比的一致性</strong>。</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>v</mi><mo>=</mo><mfrac><mn>4</mn><msup><mi>π</mi><mn>2</mn></msup></mfrac><msup><mrow><mo fence=\"true\">(</mo><mi>arctan</mi><mo>⁡</mo><mfrac><msup><mi>w</mi><mrow><mi>g</mi><mi>t</mi></mrow></msup><msup><mi>h</mi><mrow><mi>g</mi><mi>t</mi></mrow></msup></mfrac><mo>−</mo><mi>arctan</mi><mo>⁡</mo><mfrac><mi>w</mi><mi>h</mi></mfrac><mo fence=\"true\">)</mo></mrow><mn>2</mn></msup></mrow><annotation encoding=\"application/x-tex\">v = \\frac{4}{\\pi^2} \\left( \\arctan \\frac{w^{gt}}{h^{gt}} - \\arctan \\frac{w}{h} \\right)^2\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.624594em;vertical-align:-0.95003em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.32144em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">π</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.740108em;\"><span style=\"top:-2.9890000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">4</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\"><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">(</span></span><span class=\"mop\">arctan</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.470556em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\">h</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.719556em;\"><span style=\"top:-2.9890000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">g</span><span class=\"mord mathnormal mtight\">t</span></span></span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7935559999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">g</span><span class=\"mord mathnormal mtight\">t</span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mop\">arctan</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.10756em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">h</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">)</span></span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.6745640000000002em;\"><span style=\"top:-3.9234560000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span></p>\n<p>如果预测框和真实框的长宽比越接近，这个值就越趋向于 0。</p>\n<p><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>α</mi></mrow><annotation encoding=\"application/x-tex\">\\alpha</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">α</span></span></span></span></strong>：这是一个<strong>权重函数</strong>。</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>α</mi><mo>=</mo><mfrac><mi>v</mi><mrow><mo stretchy=\"false\">(</mo><mn>1</mn><mo>−</mo><mi>I</mi><mi>o</mi><mi>U</mi><mo stretchy=\"false\">)</mo><mo>+</mo><mi>v</mi></mrow></mfrac></mrow><annotation encoding=\"application/x-tex\">\\alpha = \\frac{v}{(1 - IoU) + v}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.0037em;\">α</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.0435600000000003em;vertical-align:-0.936em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.10756em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.936em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span></p>\n<p>它的作用是，当 IoU 较小时，也就是说两个框还没怎么重合时，形状预测的优先级较低；当 IoU 较大时，模型会更关注形状的微调。</p>\n<h2 id=\"损失函数\"><a class=\"markdownIt-Anchor\" href=\"#损失函数\">#</a> 损失函数</h2>\n<h3 id=\"v3的loss\"><a class=\"markdownIt-Anchor\" href=\"#v3的loss\">#</a> v3 的 Loss</h3>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mtable rowspacing=\"0.24999999999999992em\" columnalign=\"right\" columnspacing=\"\"><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mi>L</mi><mi>o</mi><mi>s</mi><msub><mi>s</mi><mrow><mi>c</mi><mi>o</mi><mi>n</mi><mi>f</mi></mrow></msub><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><msup><mi>G</mi><mn>2</mn></msup></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>B</mi></munderover><msubsup><mn mathvariant=\"double-struck\">1</mn><mrow><mi>i</mi><mi>j</mi></mrow><mrow><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msubsup><mrow><mo fence=\"true\">[</mo><mi>B</mi><mi>C</mi><mi>E</mi><mo stretchy=\"false\">(</mo><mi>c</mi><mo separator=\"true\">,</mo><mn>1</mn><mo stretchy=\"false\">)</mo><mo fence=\"true\">]</mo></mrow><mo>+</mo><msub><mi>λ</mi><mrow><mi>n</mi><mi>o</mi><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msub><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><msup><mi>G</mi><mn>2</mn></msup></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>B</mi></munderover><msubsup><mn mathvariant=\"double-struck\">1</mn><mrow><mi>i</mi><mi>j</mi></mrow><mrow><mi>n</mi><mi>o</mi><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msubsup><mrow><mo fence=\"true\">[</mo><mi>B</mi><mi>C</mi><mi>E</mi><mo stretchy=\"false\">(</mo><mi>c</mi><mo separator=\"true\">,</mo><mn>0</mn><mo stretchy=\"false\">)</mo><mo fence=\"true\">]</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mo>=</mo><mo>−</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><msup><mi>G</mi><mn>2</mn></msup></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>B</mi></munderover><msubsup><mn mathvariant=\"double-struck\">1</mn><mrow><mi>i</mi><mi>j</mi></mrow><mrow><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msubsup><mrow><mo fence=\"true\">[</mo><msub><mover accent=\"true\"><mi>c</mi><mo>^</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mi>log</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><msub><mi>c</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy=\"false\">)</mo><mo>+</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>−</mo><msub><mover accent=\"true\"><mi>c</mi><mo>^</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy=\"false\">)</mo><mi>log</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>−</mo><msub><mi>c</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy=\"false\">)</mo><mo fence=\"true\">]</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mo>−</mo><msub><mi>λ</mi><mrow><mi>n</mi><mi>o</mi><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msub><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><msup><mi>G</mi><mn>2</mn></msup></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>B</mi></munderover><msubsup><mn mathvariant=\"double-struck\">1</mn><mrow><mi>i</mi><mi>j</mi></mrow><mrow><mi>n</mi><mi>o</mi><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msubsup><mrow><mo fence=\"true\">[</mo><msub><mover accent=\"true\"><mi>c</mi><mo>^</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mi>log</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><msub><mi>c</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy=\"false\">)</mo><mo>+</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>−</mo><msub><mover accent=\"true\"><mi>c</mi><mo>^</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy=\"false\">)</mo><mi>log</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>−</mo><msub><mi>c</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy=\"false\">)</mo><mo fence=\"true\">]</mo></mrow></mrow></mstyle></mtd></mtr></mtable><annotation encoding=\"application/x-tex\">\\begin{aligned} Loss_{conf} =\\sum_{i=0}^{G^2} \\sum_{j=0}^{B} \\mathbb{1}_{ij}^{obj} \\left[ BCE(c, 1) \\right] + \\lambda_{noobj} \\sum_{i=0}^{G^2} \\sum_{j=0}^{B} \\mathbb{1}_{ij}^{noobj} \\left[ BCE(c, 0) \\right]\\\\\n=-\\sum_{i=0}^{G^2} \\sum_{j=0}^{B} \\mathbb{1}_{ij}^{obj} \\left[ \\hat{c}_{ij} \\log(c_{ij}) + (1 - \\hat{c}_{ij}) \\log(1 - c_{ij}) \\right] \\\\ - \\lambda_{noobj} \\sum_{i=0}^{G^2} \\sum_{j=0}^{B} \\mathbb{1}_{ij}^{noobj} \\left[ \\hat{c}_{ij} \\log(c_{ij}) + (1 - \\hat{c}_{ij}) \\log(1 - c_{ij}) \\right] \\end{aligned}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:11.063106000000001em;vertical-align:-5.281553000000001em;\"></span><span class=\"mord\"><span class=\"mtable\"><span class=\"col-align-r\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:5.781553000000001em;\"><span style=\"top:-7.781553000000001em;\"><span class=\"pstrut\" style=\"height:3.9739250000000004em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">L</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">s</span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">n</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10764em;\">f</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.9739250000000004em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">G</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8913142857142857em;\"><span style=\"top:-2.931em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\">1</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9670159999999999em;\"><span style=\"top:-2.4231360000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.412972em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\">[</span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">c</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">)</span><span class=\"mclose delimcenter\" style=\"top:0em;\">]</span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.9739250000000004em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">G</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8913142857142857em;\"><span style=\"top:-2.931em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\">1</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9670159999999999em;\"><span style=\"top:-2.4231360000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.412972em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\">[</span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">c</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">0</span><span class=\"mclose\">)</span><span class=\"mclose delimcenter\" style=\"top:0em;\">]</span></span></span></span><span style=\"top:-4.093850999999999em;\"><span class=\"pstrut\" style=\"height:3.9739250000000004em;\"></span><span class=\"mord\"><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mord\">−</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.9739250000000004em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">G</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8913142857142857em;\"><span style=\"top:-2.931em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\">1</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9670159999999999em;\"><span style=\"top:-2.4231360000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.412972em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\">[</span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mclose delimcenter\" style=\"top:0em;\">]</span></span></span></span><span style=\"top:-0.40614899999999965em;\"><span class=\"pstrut\" style=\"height:3.9739250000000004em;\"></span><span class=\"mord\"><span class=\"mord\">−</span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.9739250000000004em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">G</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8913142857142857em;\"><span style=\"top:-2.931em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\">1</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9670159999999999em;\"><span style=\"top:-2.4231360000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.412972em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\">[</span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mclose delimcenter\" style=\"top:0em;\">]</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:5.281553000000001em;\"><span></span></span></span></span></span></span></span></span></span></span></span></p>\n<h3 id=\"v4的loss\"><a class=\"markdownIt-Anchor\" href=\"#v4的loss\">#</a> v4 的 Loss</h3>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mtable rowspacing=\"0.24999999999999992em\" columnalign=\"right\" columnspacing=\"\"><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mi>L</mi><mi>o</mi><mi>s</mi><msub><mi>s</mi><mrow><mi>c</mi><mi>o</mi><mi>n</mi><mi>f</mi></mrow></msub><mo>=</mo><msub><mi>λ</mi><mtext>coord</mtext></msub><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mrow><mi>K</mi><mo>×</mo><mi>K</mi></mrow></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>M</mi></munderover><msubsup><mi>I</mi><mrow><mi>i</mi><mi>j</mi></mrow><mtext>obj</mtext></msubsup><mo stretchy=\"false\">(</mo><mn>2</mn><mo>−</mo><msub><mi>w</mi><mi>i</mi></msub><mo>×</mo><msub><mi>h</mi><mi>i</mi></msub><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>−</mo><mtext>CIoU</mtext><mo stretchy=\"false\">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mo>−</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mrow><mi>K</mi><mo>×</mo><mi>K</mi></mrow></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>M</mi></munderover><msubsup><mi>I</mi><mrow><mi>i</mi><mi>j</mi></mrow><mtext>obj</mtext></msubsup><mo stretchy=\"false\">[</mo><msub><mover accent=\"true\"><mi>C</mi><mo>^</mo></mover><mi>i</mi></msub><mi>log</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><msub><mi>C</mi><mi>i</mi></msub><mo stretchy=\"false\">)</mo><mo>+</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>−</mo><msub><mover accent=\"true\"><mi>C</mi><mo>^</mo></mover><mi>i</mi></msub><mo stretchy=\"false\">)</mo><mi>log</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>−</mo><msub><mi>C</mi><mi>i</mi></msub><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">]</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mo>−</mo><msub><mi>λ</mi><mtext>noobj</mtext></msub><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mrow><mi>K</mi><mo>×</mo><mi>K</mi></mrow></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>M</mi></munderover><msubsup><mi>I</mi><mrow><mi>i</mi><mi>j</mi></mrow><mtext>noobj</mtext></msubsup><mo stretchy=\"false\">[</mo><msub><mover accent=\"true\"><mi>C</mi><mo>^</mo></mover><mi>i</mi></msub><mi>log</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><msub><mi>C</mi><mi>i</mi></msub><mo stretchy=\"false\">)</mo><mo>+</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>−</mo><msub><mover accent=\"true\"><mi>C</mi><mo>^</mo></mover><mi>i</mi></msub><mo stretchy=\"false\">)</mo><mi>log</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>−</mo><msub><mi>C</mi><mi>i</mi></msub><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">]</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mo>−</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mrow><mi>K</mi><mo>×</mo><mi>K</mi></mrow></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>M</mi></munderover><msubsup><mi>I</mi><mrow><mi>i</mi><mi>j</mi></mrow><mtext>obj</mtext></msubsup><munder><mo>∑</mo><mrow><mi>c</mi><mo>∈</mo><mtext>classes</mtext></mrow></munder><mo stretchy=\"false\">[</mo><msub><mover accent=\"true\"><mi>p</mi><mo>^</mo></mover><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>c</mi><mo stretchy=\"false\">)</mo><mi>log</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>c</mi><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo><mo>+</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>−</mo><msub><mover accent=\"true\"><mi>p</mi><mo>^</mo></mover><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>c</mi><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo><mi>log</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>−</mo><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><mi>c</mi><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">]</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding=\"application/x-tex\">\\begin{aligned} Loss_{conf} = \\lambda_{\\text{coord}} \\sum_{i=0}^{K \\times K} \\sum_{j=0}^{M} I_{ij}^{\\text{obj}} (2 - w_i \\times h_i)(1 - \\text{CIoU})\\\\\n-\\sum_{i=0}^{K \\times K} \\sum_{j=0}^{M} I_{ij}^{\\text{obj}} [\\hat{C}_i \\log(C_i) + (1 - \\hat{C}_i) \\log(1 - C_i)] \\\\\n-\\lambda_{\\text{noobj}} \\sum_{i=0}^{K \\times K} \\sum_{j=0}^{M} I_{ij}^{\\text{noobj}} [\\hat{C}_i \\log(C_i) + (1 - \\hat{C}_i) \\log(1 - C_i)]\\\\\n-\\sum_{i=0}^{K \\times K} \\sum_{j=0}^{M} I_{ij}^{\\text{obj}} \\sum_{c \\in \\text{classes}} [\\hat{p}_i(c) \\log(p_i(c)) + (1 - \\hat{p}_i(c)) \\log(1 - p_i(c))]\n\\end{aligned}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:14.168452000000002em;vertical-align:-6.834226000000001em;\"></span><span class=\"mord\"><span class=\"mtable\"><span class=\"col-align-r\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:7.334226000000001em;\"><span style=\"top:-9.334226000000001em;\"><span class=\"pstrut\" style=\"height:3.8283360000000006em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">L</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">s</span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">n</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10764em;\">f</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">coord</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000004em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.300005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span><span class=\"mbin mtight\">×</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">M</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9670159999999999em;\"><span style=\"top:-2.4231360000000004em;margin-left:-0.07847em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">obj</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.412972em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">h</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord text\"><span class=\"mord\">CIoU</span></span><span class=\"mclose\">)</span></span></span><span style=\"top:-5.7921130000000005em;\"><span class=\"pstrut\" style=\"height:3.8283360000000006em;\"></span><span class=\"mord\"><span class=\"mord\">−</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000004em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.300005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span><span class=\"mbin mtight\">×</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">M</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9670159999999999em;\"><span style=\"top:-2.4231360000000004em;margin-left:-0.07847em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">obj</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.412972em;\"><span></span></span></span></span></span></span><span class=\"mopen\">[</span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9467699999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span></span></span><span style=\"top:-3.25233em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.16666em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9467699999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span></span></span><span style=\"top:-3.25233em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.16666em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mclose\">]</span></span></span><span style=\"top:-2.25em;\"><span class=\"pstrut\" style=\"height:3.8283360000000006em;\"></span><span class=\"mord\"><span class=\"mord\">−</span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">noobj</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000004em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.300005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span><span class=\"mbin mtight\">×</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">M</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9670159999999999em;\"><span style=\"top:-2.4231360000000004em;margin-left:-0.07847em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">noobj</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.412972em;\"><span></span></span></span></span></span></span><span class=\"mopen\">[</span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9467699999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span></span></span><span style=\"top:-3.25233em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.16666em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9467699999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span></span></span><span style=\"top:-3.25233em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.16666em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mclose\">]</span></span></span><span style=\"top:1.2921130000000005em;\"><span class=\"pstrut\" style=\"height:3.8283360000000006em;\"></span><span class=\"mord\"><span class=\"mord\">−</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000004em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.300005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span><span class=\"mbin mtight\">×</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">M</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9670159999999999em;\"><span style=\"top:-2.4231360000000004em;margin-left:-0.07847em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">obj</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.412972em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.050005em;\"><span style=\"top:-1.8478869999999998em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span><span class=\"mrel mtight\">∈</span><span class=\"mord text mtight\"><span class=\"mord mtight\">classes</span></span></span></span></span><span style=\"top:-3.0500049999999996em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.329483em;\"><span></span></span></span></span></span><span class=\"mopen\">[</span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.16666em;\"><span class=\"mord\">^</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.19444em;\"><span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">c</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">c</span><span class=\"mclose\">)</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.16666em;\"><span class=\"mord\">^</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.19444em;\"><span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">c</span><span class=\"mclose\">)</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">c</span><span class=\"mclose\">)</span><span class=\"mclose\">)</span><span class=\"mclose\">]</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:6.834226000000001em;\"><span></span></span></span></span></span></span></span></span></span></span></span></p>\n<h3 id=\"定位损失框得准不准\"><a class=\"markdownIt-Anchor\" href=\"#定位损失框得准不准\">#</a> 定位损失 —— 框得准不准</h3>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mi>λ</mi><mtext>coord</mtext></msub><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mrow><mi>K</mi><mo>×</mo><mi>K</mi></mrow></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>M</mi></munderover><msubsup><mi>I</mi><mrow><mi>i</mi><mi>j</mi></mrow><mtext>obj</mtext></msubsup><mo stretchy=\"false\">(</mo><mn>2</mn><mo>−</mo><msub><mi>w</mi><mi>i</mi></msub><mo>×</mo><msub><mi>h</mi><mi>i</mi></msub><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>−</mo><mtext>CIOU</mtext><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\lambda_{\\text{coord}} \\sum_{i=0}^{K \\times K} \\sum_{j=0}^{M} I_{ij}^{\\text{obj}} (2 - w_i \\times h_i)(1 - \\text{CIOU})\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:3.2421130000000007em;vertical-align:-1.4137769999999998em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">coord</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000004em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.300005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span><span class=\"mbin mtight\">×</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">M</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9670159999999999em;\"><span style=\"top:-2.4231360000000004em;margin-left:-0.07847em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">obj</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.412972em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.73333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">h</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord text\"><span class=\"mord\">CIOU</span></span><span class=\"mclose\">)</span></span></span></span></span></p>\n<ul>\n<li>CIOU：这是 YOLOv4 的核心改进。它不只看预测框和真实框重合了多少，还考虑了<strong>中心点距离</strong>和<strong>长宽比</strong>。这让框的预测比以前更稳、更准。</li>\n<li><strong>小目标加强</strong>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">(</mo><mn>2</mn><mo>−</mo><msub><mi>w</mi><mi>i</mi></msub><mo>×</mo><msub><mi>h</mi><mi>i</mi></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">(2 - w_i \\times h_i)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.73333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">h</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span> 是一个调节系数。因为小框的几个像素偏差比大框影响更大，这个系数会给小目标更高的权重，强制模型 “精准打击”。</li>\n</ul>\n<h3 id=\"置信度损失有没有东西\"><a class=\"markdownIt-Anchor\" href=\"#置信度损失有没有东西\">#</a> 置信度损失 —— 有没有东西</h3>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mo>−</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mrow><mi>K</mi><mo>×</mo><mi>K</mi></mrow></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>M</mi></munderover><msubsup><mi>I</mi><mrow><mi>i</mi><mi>j</mi></mrow><mtext>obj</mtext></msubsup><mo stretchy=\"false\">[</mo><msub><mover accent=\"true\"><mi>C</mi><mo>^</mo></mover><mi>i</mi></msub><mi>log</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><msub><mi>C</mi><mi>i</mi></msub><mo stretchy=\"false\">)</mo><mo>+</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>−</mo><msub><mover accent=\"true\"><mi>C</mi><mo>^</mo></mover><mi>i</mi></msub><mo stretchy=\"false\">)</mo><mi>log</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>−</mo><msub><mi>C</mi><mi>i</mi></msub><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">]</mo><mspace linebreak=\"newline\"></mspace><mo>−</mo><msub><mi>λ</mi><mtext>noobj</mtext></msub><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mrow><mi>K</mi><mo>×</mo><mi>K</mi></mrow></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>M</mi></munderover><msubsup><mi>I</mi><mrow><mi>i</mi><mi>j</mi></mrow><mtext>noobj</mtext></msubsup><mo stretchy=\"false\">[</mo><msub><mover accent=\"true\"><mi>C</mi><mo>^</mo></mover><mi>i</mi></msub><mi>log</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><msub><mi>C</mi><mi>i</mi></msub><mo stretchy=\"false\">)</mo><mo>+</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>−</mo><msub><mover accent=\"true\"><mi>C</mi><mo>^</mo></mover><mi>i</mi></msub><mo stretchy=\"false\">)</mo><mi>log</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>−</mo><msub><mi>C</mi><mi>i</mi></msub><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">-\\sum_{i=0}^{K \\times K} \\sum_{j=0}^{M} I_{ij}^{\\text{obj}} [\\hat{C}_i \\log(C_i) + (1 - \\hat{C}_i) \\log(1 - C_i)] \\\\\n-\\lambda_{\\text{noobj}} \\sum_{i=0}^{K \\times K} \\sum_{j=0}^{M} I_{ij}^{\\text{noobj}} [\\hat{C}_i \\log(C_i) + (1 - \\hat{C}_i) \\log(1 - C_i)]\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:3.2421130000000007em;vertical-align:-1.4137769999999998em;\"></span><span class=\"mord\">−</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000004em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.300005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span><span class=\"mbin mtight\">×</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">M</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9670159999999999em;\"><span style=\"top:-2.4231360000000004em;margin-left:-0.07847em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">obj</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.412972em;\"><span></span></span></span></span></span></span><span class=\"mopen\">[</span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9467699999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span></span></span><span style=\"top:-3.25233em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.16666em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.19677em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9467699999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span></span></span><span style=\"top:-3.25233em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.16666em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mclose\">]</span></span><span class=\"mspace newline\"></span><span class=\"base\"><span class=\"strut\" style=\"height:3.2421130000000007em;vertical-align:-1.4137769999999998em;\"></span><span class=\"mord\">−</span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">noobj</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000004em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.300005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span><span class=\"mbin mtight\">×</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">M</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9670159999999999em;\"><span style=\"top:-2.4231360000000004em;margin-left:-0.07847em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">noobj</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.412972em;\"><span></span></span></span></span></span></span><span class=\"mopen\">[</span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9467699999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span></span></span><span style=\"top:-3.25233em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.16666em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.19677em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9467699999999999em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span></span></span><span style=\"top:-3.25233em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.16666em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mclose\">]</span></span></span></span></span></p>\n<ul>\n<li>正样本损失，模型认为这里有物体，且真的有物体。模型要学习如何给出接近 1 的高分。</li>\n<li>负样本损失，模型看到的只是背景。由于一张图中背景远多于物体，所以前面加了一个系数 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>λ</mi><mtext>noobj</mtext></msub></mrow><annotation encoding=\"application/x-tex\">\\lambda_{\\text{noobj}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.980548em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">noobj</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span>（通常取 0.5），防止模型因为背景太多而 “偏科”，只学会预测背景。</li>\n</ul>\n<h3 id=\"分类损失认得对不对\"><a class=\"markdownIt-Anchor\" href=\"#分类损失认得对不对\">#</a> 分类损失 —— 认得对不对</h3>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mrow><mi>K</mi><mo>×</mo><mi>K</mi></mrow></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>M</mi></munderover><msubsup><mi>I</mi><mrow><mi>i</mi><mi>j</mi></mrow><mtext>obj</mtext></msubsup><munder><mo>∑</mo><mrow><mi>c</mi><mo>∈</mo><mtext>classes</mtext></mrow></munder><mo stretchy=\"false\">[</mo><mo>…</mo><mtext> </mtext><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">\\sum_{i=0}^{K \\times K} \\sum_{j=0}^{M} I_{ij}^{\\text{obj}} \\sum_{c \\in \\text{classes}} [\\dots]\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:3.2421130000000007em;vertical-align:-1.4137769999999998em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000004em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.300005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span><span class=\"mbin mtight\">×</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">M</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9670159999999999em;\"><span style=\"top:-2.4231360000000004em;margin-left:-0.07847em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">obj</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.412972em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.050005em;\"><span style=\"top:-1.8478869999999998em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span><span class=\"mrel mtight\">∈</span><span class=\"mord text mtight\"><span class=\"mord mtight\">classes</span></span></span></span></span><span style=\"top:-3.0500049999999996em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.329483em;\"><span></span></span></span></span></span><span class=\"mopen\">[</span><span class=\"minner\">…</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mclose\">]</span></span></span></span></span></p>\n<ul>\n<li>这一步只针对有物体的框。它计算每个类别的概率。</li>\n<li>使用的是二元交叉熵 BCE，这意味着即使一个物体属于多个类别，模型也能很好地处理。</li>\n</ul>\n<h2 id=\"droublock\"><a class=\"markdownIt-Anchor\" href=\"#droublock\">#</a> DrouBlock</h2>\n<img data-src=\"../../../images/python/YOLO/v4/20.png\" alt=\"1\" style=\"zoom:80%;\" />\n<p>Dropout 随机丢弃 “单个神经元”，DropBlock 随机丢弃 “连续的一整块特征区域”</p>\n<h2 id=\"sat\"><a class=\"markdownIt-Anchor\" href=\"#sat\">#</a> SAT</h2>\n<p>它是一种通过引入对抗样本来提高模型鲁棒性和泛化能力的训练方法。<strong>SAT 就是一种 “抗干扰训练”</strong>。它让 YOLOv4 在训练阶段就见过各种 “故意找茬” 的坏数据，这样在实际应用中，即使遇到模糊、遮挡或复杂的背景，模型的检测效果也会更加稳定。</p>\n<img data-src=\"../../../images/python/YOLO/v4/21.png\" alt=\"1\" style=\"zoom:80%;\" />\n<h2 id=\"sam空间注意力模块\"><a class=\"markdownIt-Anchor\" href=\"#sam空间注意力模块\">#</a> SAM 空间注意力模块</h2>\n<img data-src=\"../../../images/python/YOLO/v4/22.png\" alt=\"1\" style=\"zoom:80%;\" />\n<p><strong>原始 SAM (a)</strong>：</p>\n<ol>\n<li>对输入进行最大池化和平均池化。</li>\n<li>将结果拼接后经过 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn><mo>×</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">1 \\times 1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span> 卷积，生成一个权重图。</li>\n<li>最后通过 Sigmoid 激活函数，与原图相乘，实现划重点的效果。</li>\n</ol>\n<p>** 改进后的 SAM (b) **：</p>\n<ol>\n<li><strong>更简洁</strong>：不再进行复杂的池化操作，而是直接通过一个 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn><mo>×</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">1 \\times 1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span> 卷积对输入特征进行处理。</li>\n<li><strong>逐像素相乘</strong>：经过 Sigmoid 激活后，直接与原始特征图进行像素点对点的相乘。</li>\n<li><strong>优势</strong>：这种改进简化了计算量，同时保留了空间位置的敏感度，帮助模型更专注于图像中有意义的部分。</li>\n</ol>\n<h2 id=\"汇总\"><a class=\"markdownIt-Anchor\" href=\"#汇总\">#</a> 汇总</h2>\n<img data-src=\"../../../images/python/YOLO/v4/23.png\" alt=\"1\" style=\"zoom:80%;\" />\n<p>LS 标签平滑：勾选 LS 后 AP 从 38.0% 掉到了 <strong>33.0%</strong>。这说明标签平滑在当前特定的检测任务或配置下可能起到了反作用。</p>\n<p>DM Dynamic mini-batch size：AP 掉到了 <strong>35.3%</strong>，表现也不如基准。</p>\n<h1 id=\"参考\"><a class=\"markdownIt-Anchor\" href=\"#参考\">#</a> 参考</h1>\n<ol>\n<li>【YOLOV4 目标检测原理与实战】：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL0JWMWt6REVZZEUzaQ==\">https://www.bilibili.com/video/BV1kzDEYdE3i</span></li>\n</ol>\n",
            "tags": [
                "深度学习",
                "YOLO",
                "python",
                "CNN",
                "深度学习",
                "YOLO"
            ]
        },
        {
            "id": "https://735690757.github.io/python/ss/",
            "url": "https://735690757.github.io/python/ss/",
            "title": "语义分割",
            "date_published": "2026-01-14T04:12:12.000Z",
            "content_html": "<h1 id=\"语义分割\"><a class=\"markdownIt-Anchor\" href=\"#语义分割\">#</a> 语义分割</h1>\n<h2 id=\"常见分割任务\"><a class=\"markdownIt-Anchor\" href=\"#常见分割任务\">#</a> 常见分割任务</h2>\n<ol>\n<li>语义分割</li>\n<li>实例分割</li>\n<li>全景分割</li>\n</ol>\n<h2 id=\"常见语义分割评价指标\"><a class=\"markdownIt-Anchor\" href=\"#常见语义分割评价指标\">#</a> 常见语义分割评价指标</h2>\n<h3 id=\"pixel-accuracy-global-acc像素准确率\"><a class=\"markdownIt-Anchor\" href=\"#pixel-accuracy-global-acc像素准确率\">#</a> Pixel Accuracy / Global Acc 像素准确率</h3>\n<p>这是最直观的指标，反映了模型对<strong>所有像素点</strong>分类正确的比例。</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>P</mi><mi>A</mi><mo>=</mo><mfrac><mrow><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>n</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub></mrow><mrow><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>t</mi><mi>i</mi></msub></mrow></mfrac></mrow><annotation encoding=\"application/x-tex\">PA = \\frac{\\sum_{i} n_{ii}}{\\sum_{i} t_{i}}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mord mathnormal\">A</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.4254200000000004em;vertical-align:-0.9857100000000001em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4397100000000003em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mop\"><span class=\"mop op-symbol small-op\" style=\"position:relative;top:-0.0000050000000000050004em;\">∑</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.16195399999999993em;\"><span style=\"top:-2.40029em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.29971000000000003em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.6897100000000003em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mop\"><span class=\"mop op-symbol small-op\" style=\"position:relative;top:-0.0000050000000000050004em;\">∑</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.16195399999999993em;\"><span style=\"top:-2.40029em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.29971000000000003em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9857100000000001em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span></p>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>n</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">n_{ii}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>：表示第 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>i</mi></mrow><annotation encoding=\"application/x-tex\">i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.65952em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">i</span></span></span></span> 类被正确预测为第 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>i</mi></mrow><annotation encoding=\"application/x-tex\">i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.65952em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">i</span></span></span></span> 类的像素数量（对角线元素）。</p>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>t</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">t_{i}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>：表示第 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>i</mi></mrow><annotation encoding=\"application/x-tex\">i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.65952em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">i</span></span></span></span> 类总共包含的像素点数量。</p>\n<p>所有分类正确的像素总数 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>÷</mo></mrow><annotation encoding=\"application/x-tex\">\\div</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.66666em;vertical-align:-0.08333em;\"></span><span class=\"mord\">÷</span></span></span></span> 图像像素总数。</p>\n<p><strong>局限性</strong>：由于它计算的是全局准确度，如果图像中某个类别如背景占比极大，PA 就会被该类别主导，无法反映模型对小目标的识别能力。</p>\n<h3 id=\"mean-accuracy平均准确率\"><a class=\"markdownIt-Anchor\" href=\"#mean-accuracy平均准确率\">#</a> mean Accuracy 平均准确率</h3>\n<p>为了解决上述类别不平衡问题，该指标先计算每个类别的准确率，再取平均值.</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>m</mi><mi>A</mi><mi>c</mi><mi>c</mi><mo>=</mo><mfrac><mn>1</mn><msub><mi>n</mi><mrow><mi>c</mi><mi>l</mi><mi>s</mi></mrow></msub></mfrac><mo>⋅</mo><munder><mo>∑</mo><mi>i</mi></munder><mfrac><msub><mi>n</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub><msub><mi>t</mi><mi>i</mi></msub></mfrac></mrow><annotation encoding=\"application/x-tex\">mAcc = \\frac{1}{n_{cls}} \\cdot \\sum_{i} \\frac{n_{ii}}{t_{i}}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">c</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.1574400000000002em;vertical-align:-0.8360000000000001em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.32144em;\"><span style=\"top:-2.3139999999999996em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal mtight\">s</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8360000000000001em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.385229em;vertical-align:-1.277669em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.0500050000000003em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.1075599999999999em;\"><span style=\"top:-2.3139999999999996em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8360000000000001em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span></p>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>n</mi><mrow><mi>c</mi><mi>l</mi><mi>s</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">n_{cls}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal mtight\">s</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>：类别的总数。</p>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mfrac><msub><mi>n</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub><msub><mi>t</mi><mi>i</mi></msub></mfrac></mrow><annotation encoding=\"application/x-tex\">\\frac{n_{ii}}{t_{i}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.1565919999999998em;vertical-align:-0.44509999999999994em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7114919999999999em;\"><span style=\"top:-2.655em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3280857142857143em;\"><span style=\"top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.143em;\"><span></span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.4101em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3280857142857143em;\"><span style=\"top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.143em;\"><span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.44509999999999994em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span>：第 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>i</mi></mrow><annotation encoding=\"application/x-tex\">i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.65952em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">i</span></span></span></span> 个类别的分类准确率。</p>\n<p><strong>意义</strong>：它给每个类别（无论大小）分配了相同的权重。如果你的任务中包含很多细长或微小的物体，这个指标比 PA 更有参考价值。</p>\n<h3 id=\"mean-iou平均交并比\"><a class=\"markdownIt-Anchor\" href=\"#mean-iou平均交并比\">#</a> mean IoU 平均交并比</h3>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>m</mi><mi>I</mi><mi>o</mi><mi>U</mi><mo>=</mo><mfrac><mn>1</mn><msub><mi>n</mi><mrow><mi>c</mi><mi>l</mi><mi>s</mi></mrow></msub></mfrac><mo>⋅</mo><munder><mo>∑</mo><mi>i</mi></munder><mfrac><msub><mi>n</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub><mrow><msub><mi>t</mi><mi>i</mi></msub><mo>+</mo><munder><mo>∑</mo><mi>j</mi></munder><msub><mi>n</mi><mrow><mi>j</mi><mi>i</mi></mrow></msub><mo>−</mo><msub><mi>n</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub></mrow></mfrac></mrow><annotation encoding=\"application/x-tex\">mIoU = \\frac{1}{n_{cls}} \\cdot \\sum_{i} \\frac{n_{ii}}{t_{i} + \\sum_{j} n_{ji} - n_{ii}}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.1574400000000002em;vertical-align:-0.8360000000000001em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.32144em;\"><span style=\"top:-2.3139999999999996em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal mtight\">s</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8360000000000001em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.385229em;vertical-align:-1.277669em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.0500050000000003em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.1075599999999999em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mop\"><span class=\"mop op-symbol small-op\" style=\"position:relative;top:-0.0000050000000000050004em;\">∑</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.16195399999999993em;\"><span style=\"top:-2.40029em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.43581800000000004em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.1218180000000002em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span></p>\n<p><strong>分母</strong>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>t</mi><mi>i</mi></msub><mo>+</mo><msub><mo>∑</mo><mi>j</mi></msub><msub><mi>n</mi><mrow><mi>j</mi><mi>i</mi></mrow></msub><mo>−</mo><msub><mi>n</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">t_{i} + \\sum_{j} n_{ji} - n_{ii}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.185818em;vertical-align:-0.43581800000000004em;\"></span><span class=\"mop\"><span class=\"mop op-symbol small-op\" style=\"position:relative;top:-0.0000050000000000050004em;\">∑</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.16195399999999993em;\"><span style=\"top:-2.40029em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.43581800000000004em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 实际上就是<strong>并集</strong>。它由 “真实区域” 加上 “预测区域”，再减去重复计算的 “交集部分” 组成。</p>\n<p><strong>分子</strong>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>n</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">n_{ii}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 就是 ** 交集 。</p>\n<p><strong>核心逻辑</strong>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>I</mi><mi>o</mi><mi>U</mi><mo>=</mo><mfrac><mtext>交集</mtext><mtext>并集</mtext></mfrac></mrow><annotation encoding=\"application/x-tex\">IoU = \\frac{交集}{并集}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.217331em;vertical-align:-0.345em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.872331em;\"><span style=\"top:-2.6550000000000002em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord cjk_fallback mtight\">并</span><span class=\"mord cjk_fallback mtight\">集</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord cjk_fallback mtight\">交</span><span class=\"mord cjk_fallback mtight\">集</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span>。只有当预测的形状与真实的形状高度重合时，mIoU 才会接近 1。</p>\n<h3 id=\"一个例子\"><a class=\"markdownIt-Anchor\" href=\"#一个例子\">#</a> 一个例子</h3>\n<img data-src=\"../../images/python/ss/1.png\" alt=\"1\" style=\"zoom: 50%;\" />\n<img data-src=\"../../images/python/ss/2.png\" alt=\"1\" style=\"zoom:50%;\" />\n<img data-src=\"../../images/python/ss/3.png\" alt=\"1\" style=\"zoom:50%;\" />\n<img data-src=\"../../images/python/ss/4.png\" alt=\"1\" style=\"zoom:50%;\" />\n<img data-src=\"../../images/python/ss/5.png\" alt=\"1\" style=\"zoom:50%;\" />\n<h4 id=\"全局准确率\"><a class=\"markdownIt-Anchor\" href=\"#全局准确率\">#</a> 全局准确率</h4>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>P</mi><mi>A</mi><mo>=</mo><mfrac><mrow><mn>16</mn><mo>+</mo><mn>3</mn><mo>+</mo><mn>16</mn><mo>+</mo><mn>12</mn><mo>+</mo><mn>8</mn></mrow><mn>64</mn></mfrac><mo>≈</mo><mn>0.859</mn></mrow><annotation encoding=\"application/x-tex\">PA=\\frac{16+3+16+12+8}{64}\\approx0.859\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mord mathnormal\">A</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.00744em;vertical-align:-0.686em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.32144em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">6</span><span class=\"mord\">4</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">1</span><span class=\"mord\">6</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\">3</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\">1</span><span class=\"mord\">6</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\">1</span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\">8</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">≈</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">8</span><span class=\"mord\">5</span><span class=\"mord\">9</span></span></span></span></span></p>\n<h4 id=\"平均准确率\"><a class=\"markdownIt-Anchor\" href=\"#平均准确率\">#</a> 平均准确率</h4>\n<p>分母是列之和，分子是对角那个元素。</p>\n<p 8=\"\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi><mi>l</mi><mi>s</mi><msub><mn>0</mn><mrow><mi>a</mi><mi>c</mi><mi>c</mi></mrow></msub><mo>=</mo><mfrac><mn>16</mn><mn>20</mn></mfrac></mrow><annotation encoding=\"application/x-tex\">cls0_{acc}=\\frac{16}{20}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">s</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.190108em;vertical-align:-0.345em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.845108em;\"><span style=\"top:-2.6550000000000002em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span><span class=\"mord mtight\">6</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span>，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi><mi>l</mi><mi>s</mi><msub><mn>1</mn><mrow><mi>a</mi><mi>c</mi><mi>c</mi></mrow></msub><mo>=</mo><mfrac><mn>3</mn><mn>4</mn></mfrac></mrow><annotation encoding=\"application/x-tex\">cls1_{acc}=\\frac{3}{4}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">s</span><span class=\"mord\"><span class=\"mord\">1</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.190108em;vertical-align:-0.345em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.845108em;\"><span style=\"top:-2.6550000000000002em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">4</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">3</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span>，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi><mi>l</mi><mi>s</mi><msub><mn>2</mn><mrow><mi>a</mi><mi>c</mi><mi>c</mi></mrow></msub><mo>=</mo><mfrac><mn>16</mn><mn>16</mn></mfrac></mrow><annotation encoding=\"application/x-tex\">cls2_{acc}=\\frac{16}{16}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">s</span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.190108em;vertical-align:-0.345em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.845108em;\"><span style=\"top:-2.6550000000000002em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span><span class=\"mord mtight\">6</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span><span class=\"mord mtight\">6</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span>，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi><mi>l</mi><mi>s</mi><msub><mn>3</mn><mrow><mi>a</mi><mi>c</mi><mi>c</mi></mrow></msub><mo>=</mo><mfrac><mn>12</mn><mn>16</mn></mfrac></mrow><annotation encoding=\"application/x-tex\">cls3_{acc}=\\frac{12}{16}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">s</span><span class=\"mord\"><span class=\"mord\">3</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.190108em;vertical-align:-0.345em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.845108em;\"><span style=\"top:-2.6550000000000002em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span><span class=\"mord mtight\">6</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span><span class=\"mord mtight\">2</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span>，cls0_{acc}=\\frac{8}</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>m</mi><mi>A</mi><mo>=</mo><mfrac><mrow><mi>c</mi><mi>l</mi><mi>s</mi><msub><mn>0</mn><mrow><mi>a</mi><mi>c</mi><mi>c</mi></mrow></msub><mo>+</mo><mi>c</mi><mi>l</mi><mi>s</mi><msub><mn>1</mn><mrow><mi>a</mi><mi>c</mi><mi>c</mi></mrow></msub><mo>+</mo><mi>c</mi><mi>l</mi><mi>s</mi><msub><mn>2</mn><mrow><mi>a</mi><mi>c</mi><mi>c</mi></mrow></msub><mo>+</mo><mi>c</mi><mi>l</mi><mi>s</mi><msub><mn>3</mn><mrow><mi>a</mi><mi>c</mi><mi>c</mi></mrow></msub><mo>+</mo><mi>c</mi><mi>l</mi><mi>s</mi><msub><mn>4</mn><mrow><mi>a</mi><mi>c</mi><mi>c</mi></mrow></msub></mrow><mn>5</mn></mfrac></mrow><annotation encoding=\"application/x-tex\">mA=\\frac{cls0_{acc}+cls1_{acc}+cls2_{acc}+cls3_{acc}+cls4_{acc}}{5}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">A</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.05744em;vertical-align:-0.686em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.37144em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">5</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">s</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">s</span><span class=\"mord\"><span class=\"mord\">1</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">s</span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">s</span><span class=\"mord\"><span class=\"mord\">3</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">s</span><span class=\"mord\"><span class=\"mord\">4</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span></p>\n<h4 id=\"平均交并比\"><a class=\"markdownIt-Anchor\" href=\"#平均交并比\">#</a> 平均交并比</h4>\n<p>分母是行与列之和减去重复部分那个，分子就是对角线那个元素。</p>\n<p 8+2+2=\"\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi><mi>l</mi><mi>s</mi><msub><mn>0</mn><mrow><mi>I</mi><mi>o</mi><mi>U</mi></mrow></msub><mo>=</mo><mfrac><mn>16</mn><mrow><mn>16</mn><mo>+</mo><mn>1</mn><mo>+</mo><mn>1</mn><mo>+</mo><mn>2</mn><mo>+</mo><mn>2</mn></mrow></mfrac></mrow><annotation encoding=\"application/x-tex\">cls0_{IoU}=\\frac{16}{16+1+1+2+2}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">s</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">U</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.2484389999999999em;vertical-align:-0.403331em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.845108em;\"><span style=\"top:-2.655em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span><span class=\"mord mtight\">6</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">1</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">1</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">2</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">2</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span><span class=\"mord mtight\">6</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.403331em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span>，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi><mi>l</mi><mi>s</mi><msub><mn>1</mn><mrow><mi>I</mi><mi>o</mi><mi>U</mi></mrow></msub><mo>=</mo><mfrac><mn>3</mn><mrow><mn>3</mn><mo>+</mo><mn>1</mn><mo>+</mo><mn>1</mn></mrow></mfrac></mrow><annotation encoding=\"application/x-tex\">cls1_{IoU}=\\frac{3}{3+1+1}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">s</span><span class=\"mord\"><span class=\"mord\">1</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">U</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.2484389999999999em;vertical-align:-0.403331em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.845108em;\"><span style=\"top:-2.655em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">3</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">1</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">1</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">3</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.403331em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span>，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi><mi>l</mi><mi>s</mi><msub><mn>2</mn><mrow><mi>I</mi><mi>o</mi><mi>U</mi></mrow></msub><mo>=</mo><mfrac><mn>16</mn><mrow><mn>16</mn><mo>+</mo><mn>1</mn><mo>+</mo><mn>1</mn></mrow></mfrac></mrow><annotation encoding=\"application/x-tex\">cls2_{IoU}=\\frac{16}{16+1+1}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">s</span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">U</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.2484389999999999em;vertical-align:-0.403331em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.845108em;\"><span style=\"top:-2.655em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span><span class=\"mord mtight\">6</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">1</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">1</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span><span class=\"mord mtight\">6</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.403331em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span>，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi><mi>l</mi><mi>s</mi><msub><mn>3</mn><mrow><mi>I</mi><mi>o</mi><mi>U</mi></mrow></msub><mo>=</mo><mfrac><mn>12</mn><mrow><mn>12</mn><mo>+</mo><mn>2</mn></mrow></mfrac></mrow><annotation encoding=\"application/x-tex\">cls3_{IoU}=\\frac{12}{12+2}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">s</span><span class=\"mord\"><span class=\"mord\">3</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">U</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.2484389999999999em;vertical-align:-0.403331em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.845108em;\"><span style=\"top:-2.655em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span><span class=\"mord mtight\">2</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">2</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span><span class=\"mord mtight\">2</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.403331em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span>，cls0_{IoU}=\\frac{8}</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>m</mi><mi>A</mi><mo>=</mo><mfrac><mrow><mi>c</mi><mi>l</mi><mi>s</mi><msub><mn>0</mn><mrow><mi>I</mi><mi>o</mi><mi>U</mi></mrow></msub><mo>+</mo><mi>c</mi><mi>l</mi><mi>s</mi><msub><mn>1</mn><mrow><mi>I</mi><mi>o</mi><mi>U</mi></mrow></msub><mo>+</mo><mi>c</mi><mi>l</mi><mi>s</mi><msub><mn>2</mn><mrow><mi>I</mi><mi>o</mi><mi>U</mi></mrow></msub><mo>+</mo><mi>c</mi><mi>l</mi><mi>s</mi><msub><mn>3</mn><mrow><mi>I</mi><mi>o</mi><mi>U</mi></mrow></msub><mo>+</mo><mi>c</mi><mi>l</mi><mi>s</mi><msub><mn>4</mn><mrow><mi>I</mi><mi>o</mi><mi>U</mi></mrow></msub></mrow><mn>5</mn></mfrac></mrow><annotation encoding=\"application/x-tex\">mA=\\frac{cls0_{IoU}+cls1_{IoU}+cls2_{IoU}+cls3_{IoU}+cls4_{IoU}}{5}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">A</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.05744em;vertical-align:-0.686em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.37144em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">5</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">s</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">U</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">s</span><span class=\"mord\"><span class=\"mord\">1</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">U</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">s</span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">U</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">s</span><span class=\"mord\"><span class=\"mord\">3</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">U</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">s</span><span class=\"mord\"><span class=\"mord\">4</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">U</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span></p>\n<h2 id=\"transposed-convolution-转置卷积\"><a class=\"markdownIt-Anchor\" href=\"#transposed-convolution-转置卷积\">#</a> Transposed Convolution 转置卷积</h2>\n<p>Transposed Convolution/ fractionally-strided / deconvolution</p>\n<p>转置卷积不是卷积的逆运算</p>\n<p><em>N.B.: Blue maps are inputs, and cyan maps are outputs.</em></p>\n<table style=\"width:100%; table-layout:fixed;\">\n  <tr>\n    <td><img width=\"150px\" data-src=\"https://github.com/vdumoulin/conv_arithmetic/blob/master/gif/no_padding_no_strides_transposed.gif?raw=true\"></td>\n    <td><img width=\"150px\" data-src=\"https://github.com/vdumoulin/conv_arithmetic/blob/master/gif/arbitrary_padding_no_strides_transposed.gif?raw=true\"></td>\n    <td><img width=\"150px\" data-src=\"https://github.com/vdumoulin/conv_arithmetic/blob/master/gif/same_padding_no_strides_transposed.gif?raw=true\"></td>\n    <td><img width=\"150px\" data-src=\"https://github.com/vdumoulin/conv_arithmetic/blob/master/gif/full_padding_no_strides_transposed.gif?raw=true\"></td>\n  </tr>\n  <tr>\n    <td>No padding, no strides, transposed</td>\n    <td>Arbitrary padding, no strides, transposed</td>\n    <td>Half padding, no strides, transposed</td>\n    <td>Full padding, no strides, transposed</td>\n  </tr>\n  <tr>\n    <td><img width=\"150px\" data-src=\"https://github.com/vdumoulin/conv_arithmetic/blob/master/gif/no_padding_strides_transposed.gif?raw=true \"></td>\n    <td><img width=\"150px\" data-src=\"https://github.com/vdumoulin/conv_arithmetic/blob/master/gif/padding_strides_transposed.gif?raw=true\"></td>\n    <td><img width=\"150px\" data-src=\"https://github.com/vdumoulin/conv_arithmetic/blob/master/gif/padding_strides_odd_transposed.gif?raw=true\"></td>\n    <td></td>\n  </tr>\n  <tr>\n    <td>No padding, strides, transposed</td>\n    <td>Padding, strides, transposed</td>\n    <td>Padding, strides, transposed (odd)</td>\n    <td></td>\n  </tr>\n</table>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mi>H</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><mo>=</mo><mo stretchy=\"false\">(</mo><msub><mi>H</mi><mrow><mi>i</mi><mi>n</mi></mrow></msub><mo>−</mo><mn>1</mn><mo stretchy=\"false\">)</mo><mo>×</mo><mi>s</mi><mi>t</mi><mi>r</mi><mi>i</mi><mi>d</mi><mi>e</mi><mo stretchy=\"false\">[</mo><mn>0</mn><mo stretchy=\"false\">]</mo><mo>−</mo><mn>2</mn><mo>×</mo><mi>p</mi><mi>a</mi><mi>d</mi><mi>d</mi><mi>i</mi><mi>n</mi><mi>g</mi><mo stretchy=\"false\">[</mo><mn>0</mn><mo stretchy=\"false\">]</mo><mo>+</mo><mi>k</mi><mi>e</mi><mi>r</mi><mi>n</mi><mi>e</mi><mi>l</mi><mi mathvariant=\"normal\">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo stretchy=\"false\">[</mo><mn>0</mn><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">H_{out} = (H_{in} - 1) \\times stride[0] - 2 \\times padding[0] + kernel\\_size[0]\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.08125em;\">H</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2805559999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.08125em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">u</span><span class=\"mord mathnormal mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.08125em;\">H</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.08125em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">n</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mopen\">[</span><span class=\"mord\">0</span><span class=\"mclose\">]</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"mopen\">[</span><span class=\"mord\">0</span><span class=\"mclose\">]</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.06em;vertical-align:-0.31em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord\" style=\"margin-right:0.02778em;\">_</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"mord mathnormal\">e</span><span class=\"mopen\">[</span><span class=\"mord\">0</span><span class=\"mclose\">]</span></span></span></span></span></p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mi>W</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><mo>=</mo><mo stretchy=\"false\">(</mo><msub><mi>W</mi><mrow><mi>i</mi><mi>n</mi></mrow></msub><mo>−</mo><mn>1</mn><mo stretchy=\"false\">)</mo><mo>×</mo><mi>s</mi><mi>t</mi><mi>r</mi><mi>i</mi><mi>d</mi><mi>e</mi><mo stretchy=\"false\">[</mo><mn>1</mn><mo stretchy=\"false\">]</mo><mo>−</mo><mn>2</mn><mo>×</mo><mi>p</mi><mi>a</mi><mi>d</mi><mi>d</mi><mi>i</mi><mi>n</mi><mi>g</mi><mo stretchy=\"false\">[</mo><mn>1</mn><mo stretchy=\"false\">]</mo><mo>+</mo><mi>k</mi><mi>e</mi><mi>r</mi><mi>n</mi><mi>e</mi><mi>l</mi><mi mathvariant=\"normal\">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo stretchy=\"false\">[</mo><mn>1</mn><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">W_{out} = (W_{in} - 1) \\times stride[1] - 2 \\times padding[1] + kernel\\_size[1]\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2805559999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">u</span><span class=\"mord mathnormal mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">n</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mopen\">[</span><span class=\"mord\">1</span><span class=\"mclose\">]</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"mopen\">[</span><span class=\"mord\">1</span><span class=\"mclose\">]</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.06em;vertical-align:-0.31em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord\" style=\"margin-right:0.02778em;\">_</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"mord mathnormal\">e</span><span class=\"mopen\">[</span><span class=\"mord\">1</span><span class=\"mclose\">]</span></span></span></span></span></p>\n<h3 id=\"下采样-vs-上采样\"><a class=\"markdownIt-Anchor\" href=\"#下采样-vs-上采样\">#</a> 下采样 vs 上采样</h3>\n<p><strong>普通卷积</strong>：主要用于<strong>特征提取</strong>和<strong>空间降维（下采样）</strong>。通过滑动窗口将多个输入像素映射为一个输出像素，通常会减小特征图的尺寸。</p>\n<p><strong>转置卷积</strong>：主要用于<strong>恢复空间分辨率</strong>或进行<strong>可学习的上采样</strong>。将一个输入像素映射到多个输出像素，从而产生比输入更大的输出特征图。常用于语义分割、生成对抗网络等需要还原图像尺寸的任务。</p>\n<h2 id=\"fcn\"><a class=\"markdownIt-Anchor\" href=\"#fcn\">#</a> FCN</h2>\n<img data-src=\"../../images/python/ss/6.png\" alt=\"1\" style=\"zoom:50%;\" />\n<p>21 深度就是 21 种类别，VOC 是 20 类然后还有一个是背景一共 21 类，然后经过上采样得到每一个像素的类别就完成分割了，FCN 使用全卷积操作，这避免了全连接层对图片大小的严格限制所导致的报错问题。</p>\n<img data-src=\"../../images/python/ss/7.png\" alt=\"1\" style=\"zoom:50%;\" />\n<p>其实这个主要是把 VGG 的全连接层修改为卷积，当然还有更多细节，下面是 FCN-32S，即直接进行对 pool5 的 32 倍上采样，VGG16 的骨干网络就是对原图进行 32 倍下采样</p>\n<h3 id=\"fcn-32s\"><a class=\"markdownIt-Anchor\" href=\"#fcn-32s\">#</a> FCN-32S</h3>\n<img data-src=\"../../images/python/ss/8.png\" alt=\"1\" style=\"zoom:50%;\" />\n<h3 id=\"fcn-16s\"><a class=\"markdownIt-Anchor\" href=\"#fcn-16s\">#</a> FCN-16S</h3>\n<img data-src=\"../../images/python/ss/9.png\" alt=\"1\" style=\"zoom:50%;\" />\n<h3 id=\"fcn-8s\"><a class=\"markdownIt-Anchor\" href=\"#fcn-8s\">#</a> FCN-8S</h3>\n<img data-src=\"../../images/python/ss/10.png\" alt=\"1\" style=\"zoom:50%;\" />\n<h3 id=\"fcn损失函数-像素级多类别交叉熵损失\"><a class=\"markdownIt-Anchor\" href=\"#fcn损失函数-像素级多类别交叉熵损失\">#</a> FCN 损失函数 - 像素级多类别交叉熵损失</h3>\n<p>对于单张图片，总损失 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>L</mi></mrow><annotation encoding=\"application/x-tex\">L</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">L</span></span></span></span> 定义为：</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>L</mi><mo>=</mo><mo>−</mo><mfrac><mn>1</mn><mrow><mi>H</mi><mo>×</mo><mi>W</mi></mrow></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow><mi>H</mi><mo>×</mo><mi>W</mi></mrow></munderover><munderover><mo>∑</mo><mrow><mi>c</mi><mo>=</mo><mn>1</mn></mrow><mi>C</mi></munderover><msub><mi>y</mi><mrow><mi>i</mi><mo separator=\"true\">,</mo><mi>c</mi></mrow></msub><mi>log</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><msub><mover accent=\"true\"><mi>y</mi><mo>^</mo></mover><mrow><mi>i</mi><mo separator=\"true\">,</mo><mi>c</mi></mrow></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">L = -\\frac{1}{H \\times W}\\sum_{i=1}^{H \\times W} \\sum_{c=1}^{C} y_{i,c} \\log(\\hat{y}_{i,c})\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">L</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:3.1060050000000006em;vertical-align:-1.277669em;\"></span><span class=\"mord\">−</span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.32144em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.08125em;\">H</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7693300000000001em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000004em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">1</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.300005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.08125em;\">H</span><span class=\"mbin mtight\">×</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.13889em;\">W</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000002em;\"><span style=\"top:-1.882887em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">1</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">C</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.267113em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.19444em;\"><span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></span></p>\n<p>FCN 的损失函数是对每一个像素进行 softmax 分类交叉熵后，在对全图进行平均。</p>\n<h3 id=\"空洞卷积-膨胀卷积\"><a class=\"markdownIt-Anchor\" href=\"#空洞卷积-膨胀卷积\">#</a> 空洞卷积 / 膨胀卷积</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9rYXJyeWxpdS54eXovcHl0aG9uL3B5dG9yY2gvI2RpbGF0aW9uJUU2JTg5JUE5JUU1JUJDJUEwJUU3JThFJTg3JUU3JUE5JUJBJUU2JUI0JTlFJUU1JThEJUI3JUU3JUE3JUFG\">PyTorch 深度学习 - 基础 - 深度学习 | KarryLiu = 诗岸梦行舟 = 分享计算机知识以及各种心得总结</span></p>\n<p>增大感受野，一般我们会主动保持特征图大小。</p>\n<h3 id=\"fcn模型训练\"><a class=\"markdownIt-Anchor\" href=\"#fcn模型训练\">#</a> FCN 模型训练</h3>\n<p>现在基本上把骨干网络都换成 ResNet-50 了。</p>\n<img data-src=\"../../images/python/ss/12.png\" alt=\"1\" style=\"zoom:50%;\" />\n<p>环境为 RTX 3080 x4 基于 fcn_resnet50: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb3dubG9hZC5weXRvcmNoLm9yZy9tb2RlbHMvZmNuX3Jlc25ldDUwX2NvY28tMTE2N2ExYWYucHRoJUU5JUEyJTg0JUU4JUFFJUFEJUU3JUJCJTgzJUU2JTlEJTgzJUU5JTg3JThEJUU4JUFFJUFEJUU3JUJCJTgzMjAlRTglQkQlQUUlRTMlODAlODI=\">https://download.pytorch.org/models/fcn_resnet50_coco-1167a1af.pth 预训练权重训练 20 轮。</span></p>\n<img data-src=\"../../images/python/ss/11.png\" alt=\"1\" style=\"zoom:50%;\" />\n<p>结果：</p>\n<div style=\"display: flex; gap: 16px; justify-content: center;\">\n  <img data-src=\"../../images/python/ss/13.png\" alt=\"1\" style=\"zoom:50%;\" />\n  <img data-src=\"../../images/python/ss/14.png\" alt=\"2\" style=\"zoom:50%;\" />\n</div>\n<p>实际上这个预训练已经不错了，我这 20 轮基本上没啥贡献，也就让 meanIoU 提升了一点点。。</p>\n<h2 id=\"u-net\"><a class=\"markdownIt-Anchor\" href=\"#u-net\">#</a> U-Net</h2>\n<p><strong>U-Net</strong> 是由 <strong>Ronneberger 等人于 2015 年</strong>提出的一种<strong>端到端的全卷积网络</strong>，主要用于<strong>像素级分类</strong>。</p>\n<img data-src=\"../../images/python/ss/15.png\" alt=\"1\" style=\"zoom:50%;\" />\n<p>这个中间的连接并不是全像素的连接，他会从源特征图裁剪一部分连接到上采用后的特征图。</p>\n<img data-src=\"../../images/python/ss/20.png\" alt=\"1\" style=\"zoom:50%;\" />\n<h3 id=\"在drive数据集上进行训练\"><a class=\"markdownIt-Anchor\" href=\"#在drive数据集上进行训练\">#</a> 在 DRIVE 数据集上进行训练</h3>\n<p><strong>DRIVE 数据集</strong>一般指的是是<strong>视网膜血管分割</strong>领域最经典、使用最广泛的数据集之一。</p>\n<img data-src=\"../../images/python/ss/16.png\" alt=\"1\" style=\"zoom:50%;\" />\n<img data-src=\"../../images/python/ss/17.png\" alt=\"1\" style=\"zoom:50%;\" />\n<p>200 轮训练后…</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>epoch: <span class=\"token number\">199</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>train_loss: <span class=\"token number\">0.3152</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>lr: <span class=\"token number\">0.000000</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>dice coefficient: <span class=\"token number\">0.814</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>global correct: <span class=\"token number\">95.3</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>average row correct: <span class=\"token punctuation\">[</span><span class=\"token string\">'97.2'</span>, <span class=\"token string\">'82.0'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>IoU: <span class=\"token punctuation\">[</span><span class=\"token string\">'94.7'</span>, <span class=\"token string\">'68.8'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>mean IoU: <span class=\"token number\">81.7</span></pre></td></tr></table></figure><div style=\"display: flex; gap: 16px; justify-content: center;\">\n  <img data-src=\"../../images/python/ss/18.png\" alt=\"1\" style=\"zoom:50%;\" />\n  <img data-src=\"../../images/python/ss/19.png\" alt=\"2\" style=\"zoom:50%;\" />\n</div>\n### 使用VGG-U-Net在CamVid-32数据集进行训练\n<p>CamVid 是<strong>语义分割领域</strong>里一个非常经典、但规模较小的<strong>自动驾驶场景数据集</strong>，经常被用来做<strong>教学、算法验证和轻量实验</strong>。真实城市驾驶视频 + 像素级语义标注。</p>\n<h2 id=\"voc镜像站\"><a class=\"markdownIt-Anchor\" href=\"#voc镜像站\">#</a> VOC 镜像站</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kYXRhLmJyYWluY2hpcC5jb20vZGF0YXNldC1taXJyb3Ivdm9j\">https://data.brainchip.com/dataset-mirror/voc</span></p>\n",
            "tags": [
                "深度学习",
                "深度学习基础",
                "python",
                "CNN",
                "深度学习",
                "FCN"
            ]
        },
        {
            "id": "https://735690757.github.io/paper/review_remote_sensing_m_d/",
            "url": "https://735690757.github.io/paper/review_remote_sensing_m_d/",
            "title": "Methods and datasets on semantic segmentation for Unmanned Aerial Vehicle remote sensing images：A review",
            "date_published": "2026-01-13T04:12:12.000Z",
            "content_html": "<h1 id=\"methods-and-datasets-on-semantic-segmentation-for-unmanned-aerial-vehicle-remote-sensing-images-a-review\"><a class=\"markdownIt-Anchor\" href=\"#methods-and-datasets-on-semantic-segmentation-for-unmanned-aerial-vehicle-remote-sensing-images-a-review\">#</a> Methods and datasets on semantic segmentation for Unmanned Aerial Vehicle remote sensing images: A review</h1>\n<blockquote>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuc2NpZW5jZWRpcmVjdC5jb20vc2NpZW5jZS9hcnRpY2xlL2Ficy9waWkvUzA5MjQyNzE2MjQwMDA4NDQ=\">【Original Link】 Methods and datasets on semantic segmentation for Unmanned Aerial Vehicle remote sensing images：A review</span></li>\n<li>Department of Information and Communication Engineering, University of Electronic Science and Technology of China, Chengdu, 611731, Sichuan, PR China</li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuc2NpZW5jZWRpcmVjdC5jb20vam91cm5hbC9pc3Bycy1qb3VybmFsLW9mLXBob3RvZ3JhbW1ldHJ5LWFuZC1yZW1vdGUtc2Vuc2luZy92b2wvMjExL3N1cHBsL0M=\">Volume 211</span>, May 2024, Pages 1-34</li>\n<li>Authors\n<ul>\n<li>Jian Cheng</li>\n<li>Changjian Deng</li>\n<li>Yanzhou Su</li>\n<li>Zeyu An</li>\n<li>Qi Wang</li>\n</ul>\n</li>\n</ul>\n</blockquote>\n<h2 id=\"abstract\"><a class=\"markdownIt-Anchor\" href=\"#abstract\">#</a> Abstract</h2>\n<p>Unmanned Aerial Vehicle (UAV) has seen a dramatic rise in popularity for remote-sensing image acquisition and analysis in recent years.</p>\n<p>近年来，无人机（UAV）在遥感图像采集和分析领域的流行度大幅上升。</p>\n<p>It has brought promising results in low-altitude monitoring tasks that require detailed visual inspections.</p>\n<p>它在需要详细目视检查的低空监测任务中取得了令人鼓舞的成果。</p>\n<p>Semantic segmentation is one of the hot topics in UAV remote sensing image analysis, as its capability to mine contextual semantic information from UAV images is crucial for achieving a fine-grained understanding of scenes.</p>\n<p>语义分割是无人机遥感图像分析中的热门话题之一，其从无人机图像中挖掘上下文语义信息的能力对于实现对场景的细致理解至关重要。</p>\n<p>However, in the remote sensing field, recent reviews have not focused on combining ‘‘UAV remote sensing’’ and ‘‘semantic segmentation’’ to summarize the advanced works and future trends.</p>\n<p>然而，在遥感领域，近期综述并未将 “无人机遥感” 与 “语义分割” 结合起来，以总结先进的工作成果和未来趋势。</p>\n<p>In this study, we focus primarily on describing various recent semantic segmentation methods applied in UAV remote sensing images and summarizing their advantages and limitations. According to the distinction in modeling contextual semantic information, we have categorized and outlined the methods based on graph-based contextual models and deep-learning-based models.</p>\n<p>本研究主要介绍了无人机遥感图像中应用的各种近期语义分割方法，并总结其优缺点。根据对上下文语义信息建模的区分，我们基于基于<mark>图的上下文模型</mark>和<mark>基于深度学习的模型</mark>对方法进行了分类和概述。</p>\n<p>Publicly available UAV-based image datasets are also gathered to encourage systematic research on advanced semantic segmentation methods. We provide quantitative results of representative methods on two high-resolution UAV-based image datasets for fair comparisons and discussions in terms of semantic segmentation accuracy and model inference efficiency.</p>\n<p>还<mark>收集了公开可用的无人机图像数据集，以鼓励系统性研究高级语义分割方法</mark>。我们提供了两种高分辨率无人机图像数据集中代表性方法的定量结果，以便公平比较和讨论语义分割准确性和模型推断效率。</p>\n<p>Besides, this paper concludes some remaining challenges and future directions in semantic segmentation for UAV remote sensing images and points out that methods based on deep learning will become the future research trend.</p>\n<p>此外，本文总结了无人机遥感图像语义分割中剩余的一些挑战和未来方向，并指出<mark>基于深度学习的方法将成为未来研究趋势。</mark></p>\n<h2 id=\"introduction\"><a class=\"markdownIt-Anchor\" href=\"#introduction\">#</a> Introduction</h2>\n<p>Semantic segmentation is the process of dividing an image into disjoint regions of the same class or semantics and labeling these regions with pixel-level annotations, where each pixel of the given image requires a label of the desired object class (Yu et al., 2018b; Mo et al., 2022).</p>\n<p>语义分割是将图像划分为同一类或语义的不相交区域，并用像素级注释标记这些区域的过程，其中给定图像的每个像素都需要对目标对象类别进行标签（Yu 等，2018b;Mo 等，2022）。</p>\n<p>Unlike image classification, which identifies the primary content of an entire image and categorizes it into a specific class, semantic segmentation provides detailed delineations of multiple classes and their respective regions in the image (Yuan et al., 2021)</p>\n<p><mark>与图像分类不同，后者是识别整张图像的主要内容并将其归类到特定类别，语义分割则提供了图像中多个类别及其相应区域的详细划分</mark>（Yuan 等，2021）</p>\n<p>In fact, image semantic segmentation is derived from image segmentation (Ohta et al., 1978), but puts more emphasis on capturing the semantic information of spatial context, so that the segmented areas have semantic meaning.</p>\n<p>事实上，图像语义分割源自图像分割（Ohta 等，1978），但更强调捕捉空间上下文的语义信息，使分割区域具有语义意义。</p>\n<p>It is the perceptual basis of many computer vision tasks and has been widely employed in diverse image analysis applications, such as the natural and medical image parsing (Yu et al., 2018b; Guo et al., 2018; Asgari Taghanaki et al., 2021), automatic driving systems (Siam et al., 2017; Feng et al., 2020), road extraction (Abdollahi et al., 2020), perception of urban features (Neupane et al., 2021), landuse mapping (Zang et al., 2021), and many others.</p>\n<p>它是许多计算机视觉任务的感知基础，并被广泛应用于多种图像分析领域，如自然和<mark>医学图像解析</mark>（Yu 等，2018b;Guo 等，2018;Asgari Taghanaki 等，2021），<mark>自动驾驶系统</mark>（Siam 等，2017;Feng 等，2020）、<mark>道路提取</mark>（Abdollahi 等，2020）、<mark>城市特征感知</mark>（Neupane 等，2021）、<mark>土地利用地图绘制</mark>（Zang 等，2021）等。</p>\n<p>Remote sensing images collected by various platforms, such as satellites, aircraft, and UAVs (Toth and Jóźków, 2016; Bhardwaj et al., 2016), provide the data basis for semantic segmentation.</p>\n<p>遥感图像由卫星、飞机和无人机等多种平台收集的图像（Toth 和 Jóźków，2016;Bhardwaj 等，2016），为语义分割提供了数据基础。</p>\n<p>The continuously evolving semantic segmentation technology not only demonstrates superior performance in diverse and data-rich remote sensing problems (Ball et al., 2017; Yuan et al., 2021), but its integration with UAVs also offers a feasible solution for the fine-grained scene analysis of low-altitude remote sensing (Toth and Jóźków, 2016; Bhardwaj et al., 2016; Yao et al., 2019; Nex et al., 2022; Zhang and Zhu, 2023).</p>\n<p>持续演进的语义分割技术不仅在多样且数据丰富的遥感问题中表现出优异性能（Ball 等，2017;Yuan 等，2021），其与无人机的集成也为低空遥感的细粒度场景分析提供了可行的解决方案（Toth 和 Jóźków，2016;Bhardwaj 等，2016;Yao 等，2019;Nex 等，2022;Zhang 和 Zhu，2023）。</p>\n<p>The UAV platforms, also known as aerial robots or drones, have demonstrated many unique advantages compared with satellite remote sensing platforms, such as lower flight altitude close to the ground surface, well-controlled path planning without the restriction of revisit intervals, flexible flight schedules to access specific areas, flexible optical sensor integration, and especially, lower developing and operational costs for commercial and academic purposes (Yao et al., 2019; Osco et al., 2021; Zhang and Zhu, 2023).</p>\n<p>无人机平台，也称为空中机器人或无人机，相比卫星遥感平台展现出许多独特优势，如靠近地面的较低飞行高度、无重访间隔限制的良好路径规划、灵活的飞行计划以进入特定区域、灵活的光学传感器集成，尤其是在商业和学术用途上更低的开发和运营成本（Yao 等，2019;Osco 等，2021;Zhang 和 Zhu，2023）。</p>\n<hr>\n<p>Thanks to the flexibility of flying altitudes and sensor integration, UAVs are suitable for resource management and visual inspection tasks that require high labor costs or may affect personal safety, such as bridge condition assessment (Liang et al., 2023), insulator inspections (Ma et al., 2021), early wildfire detection (Bouguettaya et al., 2022c), and bridge damage detection (Feroz and Abu Dabous, 2021).</p>\n<p>得益于飞行高度的灵活性和传感器集成，<mark>无人机适合资源管理和目视检查任</mark>，这些需要<mark>高人工成本</mark>或<mark>可能影响个人安全的任务</mark>，<ins>如桥梁状况评估</ins>（Liang 等，2023）、<ins>绝缘体检查</ins>（马等，2021）、<ins>早期野火检测</ins>（布盖塔亚等，2022c）以及<ins>桥梁损坏检测</ins>（费罗兹和阿布达布斯，2021）。</p>\n<p>The hopeful prospect of UAV applications has been well demonstrated and tested in the current literature.</p>\n<p>无人机应用的前景在现有文献中已被充分验证和验证。</p>\n<p>For instance, in forestry applications (Torresan et al., 2017; Guimarães et al., 2020; Diez et al., 2021), some efforts apply UAVs to pest infestation monitoring (Lehmann et al., 2015), forest fire detection (Yuan et al., 2015), individual tree detection (Chadwick et al., 2020; Gibril et al., 2021), tree species classification (Fujimoto et al., 2019; Kentsch et al., 2020; Egli and Höpke, 2020), among others.</p>\n<p>例如，<mark>在林业应用</mark>中（Torresan 等，2017;Guimarães 等，2020;Diez 等，2021），部分研究将无人机应用于害虫侵扰监测（Lehmann 等，2015）、森林火灾检测（Yuan 等，2015）、单棵树木检测（Chadwick 等，2020;Gibril 等，2021），树种分类（Fujimoto 等，2019;Kentsch 等，2020;Egli 和 Höpke，2020），等。</p>\n<p>In damage assessment tasks, relevant literature has demonstrated the efficiency and adaptability of analyzing structure cracks (Zhong et al., 2018; Han et al., 2022), bridge inspection and management (Ayele et al., 2020; Feroz and Abu Dabous, 2021), and disaster damage mapping (Kerle et al., 2019).</p>\n<p>在<mark>损伤评估任务</mark>中，相关文献已证明结构裂纹分析的效率和适应性（Zhong 等，2018;Han 等，2022），桥梁检查与管理（Ayele 等，2020;Feroz 和 Abu Dabous，2021），以及灾害损害测绘（Kerle 等，2019）。</p>\n<p>In precision agriculture (Adão et al., 2017; Tsouros et al., 2019), many advanced works have focused on weed mapping (Huang et al., 2018a; Sa et al., 2018; Deng et al., 2020), crop lodging detection (Song et al., 2020; Yang et al., 2020; Su et al., 2022), vegetation growth and health monitoring (Jung et al., 2018; Han et al., 2018; Kerkech et al., 2018, 2020), and many others.</p>\n<p>在<mark>精准农业</mark>中（Adão 等，2017;Tsouros 等，2019），许多先进研究聚焦于杂草测绘（Huang 等，2018a;Sa 等，2018; 邓等，2020），作物倒伏检测（宋等，2020;Yang 等，2020;Su 等，2022），植被生长与健康监测（Jung 等，2018;Han 等，2018;Kerkech 等，2018,2020），以及许多其他研究。</p>\n<p>Moreover, other literature in which the use of UAV delivered promising results in monitoring and counting wildlife (Chamoso et al., 2014; Sundaram and Loganathan, 2020), land use and land cover (LULC) (Zhang et al., 2017; Al-Najjar et al., 2019), urban mapping (Chen et al., 2018c; Lyu et al., 2020), and 3D mapping applications (Nex and Remondino, 2014; Kölle et al., 2021).</p>\n<p>此外，其他文献中无人机在<mark>监测和计数野生动物方面取得了有希望的成果</mark>（Chamoso 等，2014;Sundaram 和 Loganathan，2020），土地利用与土地覆盖（LULC）（Zhang 等，2017;Al-Najjar 等，2019），城市制图（Chen 等，2018c;Lyu 等，2020），以及三维映射应用（Nex 和 Remondino，2014;Kölle 等，2021）。</p>\n<p>Among these applications, the combination of UAV remote sensing and image semantic segmentation exhibits several distinctive advantages compared with satellite remote sensing.</p>\n<p>在这些应用中，无人机遥感与图像语义分割的结合相比卫星遥感展现出多项独特优势。</p>\n<p>Firstly, UAV-based semantic segmentation is more suitable for practical application scenarios requiring higher temporal and spatial resolution, such as environmental and agricultural monitoring (Adão et al., 2017; Tsouros et al., 2019), emergency response (Shamsoshoara et al., 2021), and disaster assessment (Rahnemoonfar et al., 2021; Chowdhury et al., 2022, 2020).</p>\n<p>首先，基于无人机的语义分割更适合需要更高时间和空间分辨率的实际应用场景，如环境和农业监测（Adão 等，2017;Tsouros 等，2019）、应急响应（Shamsoshoara 等，2021）和灾难评估（Rahnemoonfar 等，2021;Chowdhury 等，2022,2020）。</p>\n<p>Besides, semantic segmentation models can extract diverse and finegrained semantic feature representations from high-resolution remote sensing images captured at different altitudes and angles by UAVs, contributing to the comprehensive understanding of complex scenes from multi-view directions.</p>\n<p>此外，语义切割模型还能从无人机在<mark>不同高度和角度</mark>拍摄的高分辨率遥感图像中提取<mark>多样且细粒度的语义特征表示，有助于从多视角方向全面理解复杂场景</mark>。</p>\n<p>Hence, UAV-based image semantic segmentation plays a crucial role in image analysis tasks with fine semantic objects and complex backgrounds, such as urban scene perception (Chen et al., 2018c; Nigam et al., 2018; Lyu et al., 2020) and crack detection (Zhong et al., 2018; Feroz and Abu Dabous, 2021; Han et al., 2022; Liang et al., 2023).</p>\n<p>因此，基于 UAV 的图像语义分割在涉及精细语义对象和复杂背景的图像分析任务中起着关键作用，如<mark>城市场景感知</mark>（Chen 等，2018c;Nigam 等，2018;Lyu 等，2020）和<mark>裂纹检测</mark>（Zhong 等，2018;Feroz 和 Abu Dabous，2021;Han 等，2022;Liang 等，2023）。</p>\n<p>Additionally, autonomous UAVs without human intervention have been the research focus in recent years, which requires UAVs to possess independent capabilities for scene perception, data processing, and decision-making (Nex et al., 2022).</p>\n<p>此外，近年来研究重点关注无人机自主无人机，要求无人机具备<mark>独立的场景感知、数据处理和决策能力</mark>（Nex 等，2022）。</p>\n<p>The development and application of UAV platforms have contributed to the emergence of comprehensive reviews.</p>\n<p>无人机平台的发展和应用促进了综合评审的出现。</p>\n<p>Great efforts had been made to summarize the research status and specific applications of UAVs in various fields, such as 3D mapping for geomatics applications (Nex and Remondino, 2014), urban land cover classification (Yan et al., 2015), glaciological research and applications (Bhardwaj et al., 2016), automatic cadastral mapping (Crommelinck et al., 2016), agriculture and forestry (Adão et al., 2017; Guimarães et al., 2020), structural damage mapping (Kerle et al., 2019), monitoring in mining areas (Ren et al., 2019), and cultural heritage and archaeology (Themistocleous, 2020).</p>\n<p>在总结无人机在多个领域的研究现状和具体应用方面，已付出了大量努力，如<mark>地理信息技术应用的三维制图</mark>（Nex 和 Remondino，2014）、<mark>城市土地覆盖分类</mark>（Yan 等，2015）、<mark>冰川学研究与应用</mark>（Bhardwaj 等，2016）、<mark>自动地籍测绘</mark>（Crommelinck 等，2016）、<mark>农业和林业</mark>（Adão 等， 2017;Guimarães 等，2020 年）、<mark>结构损伤测绘</mark>（Kerle 等，2019 年）、<mark>矿区监测</mark>（任等，2019 年）以及<mark>文化遗产与考古学</mark>（Themistocleous，2020 年）。</p>\n<p>These reviews provided an overview of data acquisition sensors, data processing and data analysis techniques, and practical applications in their respective research fields.</p>\n<p>这些综述概述了数据采集传感器、数据处理和分析技术及其在各自研究领域的实际应用。</p>\n<p>Moreover, some other reviews were not limited to specific research fields  and comprehensively summarized the advanced technologies, broad applications, and future trends from the UAV-based remote sensing perspective.</p>\n<p>此外，一些综述不仅限于特定研究领域，全面总结了基于无人机的遥感技术、广泛应用和未来趋势。</p>\n<p>Colomina and Molina (2014) presented a discussion about the evolution and advanced technology of Unmanned Aerial Systems (UAS) in the field of photogrammetry and remote sensing.</p>\n<p>Colomina 和 Molina（2014）就无人机系统（UAS）在摄影测量和遥感领域的演变与先进技术进行了讨论。</p>\n<p>Yao et al. (2019) provided a comprehensive review of recent advanced studies involving UAV sensors, data analysis, and their remote sensing applications.</p>\n<p>Yao 等人（2019）对近期涉及无人机传感器、数据分析及其遥感应用的先进研究进行了全面综述。</p>\n<p>Nex et al. (2022) investigated the best practices of remote sensing and mapping applications by UAVs and discussed the future trend and impact. Unfortunately, only a few of these reviews briefly mentioned high-level scene understanding and semantic analysis methods that related to pixel-accurate semantic segmentation for UAV-based images.</p>\n<p>Nex 等人（2022）研究了无人机遥感和制图应用的最佳实践，并讨论了未来趋势和影响。遗憾的是，只有少数综述简要提及<mark>与无人机图像像素精确语义分割</mark>相关的高级场景理解和语义分析方法。</p>\n<p>For instance, Crommelinck et al. (2016) and Kerle et al. (2019) had mentioned the applications of random fields and convolutional neural networks for UAV image analysis, but the summary of the characteristics of different data analysis methods is still lacking.</p>\n<p>例如，Crommelinck 等（2016）和 Kerle 等（2019）提到了随机场和卷积神经网络在无人机图像分析中的应用，但不同数据分析方法的特性总结仍然不足。</p>\n<p>Nex et al. (2022) briefly summarized commonly used semantic segmentation methods and best practices, but did not analyze the advantages and disadvantages of semantic segmentation methods in detail.</p>\n<p>Nex 等人（2022）简要总结了常用的语义分割方法及其最佳实践，但未详细分析语义分割方法的优缺点。</p>\n<p>More recently, Deep Learning (DL) has a profound impact on remote sensing image semantic segmentation (Kotaridis and Lazaridou, 2021; Neupane et al., 2021; Yuan et al., 2021).</p>\n<p>近年来，深度学习（DL）对遥感图像语义分割产生了深远影响（Kotaridis 和 Lazaridou，2021;Neupane 等，2021;Yuan 等，2021）。</p>\n<p>As of recently, some literature reviews combining DL and UAV image parsing tasks focus on various approaches within different task-oriented applications.</p>\n<p>最近，一些结合深度学习和无人机图像解析任务的文献综述聚焦于不同面向任务的应用中的不同方法。</p>\n<p>For instance, Bouguettaya et al. (2022c) briefly introduced DL-based algorithms applied to early wildfire detection, such as image classification, object detection, and semantic segmentation.</p>\n<p>例如，Bouguettaya 等人（2022c）简要介绍了应用于早期野火检测的基于 DL 的算法，如图像分类、物体检测和语义分割。</p>\n<p>Bouguettaya et al. (2022a) reported object-based and pixel-based crop classification methods combining DL-based algorithms.</p>\n<p>Bouguettaya 等人（2022a）报告了结合 DL 算法的基于对象和像素的作物分类方法。</p>\n<p>Bouguettaya et al. (2022b) summarized various types of DL-based architectures for vehicle detection in UAV images.</p>\n<p>Bouguettaya 等人（2022b）总结了无人机图像中基于 DL 的各种车辆检测架构。</p>\n<p>Shahi et al. (2023) reviewed the recent advances in crop disease detection of UAV remote sensing based on machine learning and deep learning technologies.</p>\n<p>Shahi 等人（2023）回顾了基于机器学习和深度学习技术的无人机遥感作物病害检测的最新进展。</p>\n<p>Osco et al. (2021) and Nex et al. (2022) are more concerned with DL-based methods as a future trend for the field of UAV remote sensing.</p>\n<p>Osco 等（2021）和 Nex 等（2022）更关注基于 DL 的方法，视其为无人机遥感领域的未来趋势。</p>\n<p>Although, from these recent reviews, various DL-based methods have been validated in many UAV image analysis tasks, such as image classification, object detection, and semantic segmentation, a comprehensive summary and comparison of the characteristics, advantages, and limitations of semantic segmentation methods combined with UAV remote sensing images is currently absent.</p>\n<p>尽管这些最新综述已验证多种基于 DL 的方法在许多无人机图像分析任务中，如图像分类、物体检测和语义分割，但目前尚缺乏对语义分割方法与无人机遥感图像结合的特性、优势和局限性的全面总结与比较。</p>\n<p>Therefore, it is necessary to summarize the characteristics and development of specific semantic segmentation algorithms, provide scholars and practitioners with the quantitative comparison of representative models, as well as identify remaining challenges and future research directions in the image semantic segmentation of UAV remote sensing.</p>\n<p>因此，有必要总结特定语义分割算法的特性和发展，向学者和实践者提供代表性模型的定量比较，并识别无人机遥感图像语义分割的剩余挑战和未来研究方向。</p>\n<p>Different from orbital and other aerial sensing methods of acquisition, the remote sensing images captured from UAVs have the characteristics of higher resolution, complex scenes, and appearance variations caused by multi-direction angles of view (Nigam et al., 2018; Chen et al., 2018c; Lyu et al., 2020).</p>\n<p>与轨道及其他空中感测采集方法不同，<mark>从无人机捕获的遥感图像具有更高分辨率、复杂场景以及多方向视角引起的外观变化</mark>（Nigam 等，2018;Chen 等，2018c;Lyu 等，2020）。</p>\n<p>Typically, semantic segmentation methods designed for natural images or remote sensing images require single-channel or multi-channel images of a fixed size as the data input (Yu et al., 2018b; Dias et al., 2020; Asgari Taghanaki et al., 2021; Kotaridis and Lazaridou, 2021; Yuan et al., 2021).</p>\n<p>通常，为自然图像或遥感图像设计的语义分割方法需要以固定大小的单通道或多通道图像作为数据输入（Yu 等，2018b;Dias 等，2020;Asgari Taghanaki 等，2021;Kotaridis 和 Lazaridou，2021 年；Yuan 等，2021）。</p>\n<p>By slightly changing the input image scale and the number of input image channels of the model structure, these methods can also be applied to process UAV-acquired remote sensing images (Huang et al., 2018b, 2021a; Osco et al., 2021).</p>\n<p>通过稍微改变输入图像比例和模型结构的输入图像通道数，这些方法也可以应用于处理无人机采集的遥感图像（Huang 等，2018b，2021a;Osco 等，2021）。</p>\n<p>Besides, we found that back-end users also prefer to make minor modifications to the internal architecture of models, which have been thoroughly validated for semantic segmentation tasks in natural or remote sensing images, to accomplish semantic segmentation for UAV-based images (Sui et al., 2020; Barmpoutis et al., 2020; Huang et al., 2021a).</p>\n<p>此外，我们发现后端用户也更倾向于对模型内部架构做小幅修改，这些模型已经过充分验证，适用于自然或遥感图像的语义分割任务，以实现基于无人机的图像语义分割（Sui 等，2020;Barmpoutis 等，2020;Huang 等，2021a）。</p>\n<p>Although performance-proven image semantic segmentation models have been shown to be applicable to UAV-based images, the off-the-shelf models may not always offer the optimal solution for UAV-based image semantic segmentation (Nex et al., 2022).</p>\n<p>尽管经过性能验证的图像语义分割模型已被证明可应用于无人机图像，但现成的模型可能并不总是为无人机图像语义分割提供最佳解决方案（Nex 等，2022）。</p>\n<p>There remains a need to explore unique spatial, spectral, geometric, and multi-modal patterns (Beleznai et al., 2018; Maimaitijiang et al., 2020; Song et al., 2020) in UAV remote sensing images to design effective feature representations of semantic objects for accurate image semantic segmentation.</p>\n<p>仍然需要探索独特的<mark>空间、光谱、几何和多模态模式</mark>（Beleznai 等，2018;Maimaitijiang 等，2020;Song 等，2020）在无人机遥感图像中<mark>用于设计有效的语义对象特征表示</mark>，实现准确的图像语义分割。</p>\n<p>Based on the differences in modeling semantic contextual information, semantic segmentation methods for UAV remote sensing images can be divided into two categories: graphbased contextual models and DL-based models.</p>\n<p>基于对语义上下文信息建模的差异，无人机遥感图像的语义分割方法可分为两类：<mark>基于图的上下文模型</mark>和<mark>基于 DL 的模型</mark>。</p>\n<p>The former explicitly establishes stochastic dependencies between pixels or regions by probabilistic undirected graphs (Jordan, 2004; Drton and Maathuis, 2017) to integrate local or global spatial context information, while the latter adaptively extracts high-level semantic features of semantic objects in images (LeCun et al., 2015).</p>\n<p><mark>前者通过概率无向图明确建立了像素或区域之间的随机依赖关系</mark>（Jordan，2004;Drton 和 Maathuis，2017）以整合局部或全局的空间上下文信息，<mark>而后者则自适应地提取图像中语义对象的高层次语义特征</mark>（LeCun 等，2015）。</p>\n<p>Besides, most advanced semantic segmentation works applied to UAV-based images did not open-source their datasets due to flight rules and potential confidentiality.</p>\n<p>此外，<mark>大多数用于无人机图像的高级语义分割研究因飞行规则和潜在保密性问题，未将数据集开源。</mark></p>\n<p>To reduce the labor cost for investigating relevant open-source UAV remote sensing image datasets, another motivation for this review is to summarize publicly available datasets and list the corresponding parameters, such as applications, spatial resolution, classes, and modalities.</p>\n<p>为了降低研究相关开源无人机遥感图像数据集的人工成本，<mark>本综述的另一个动机是总结公开数据集并列出相应参数，如应用、空间分辨率、类别和模态。</mark></p>\n<p>We concentrate our review on advanced methods and available datasets for semantic segmentation applied to UAV optical imagery, rather than onboard instrumentation, payload, flight autonomy, data acquisition techniques, or specific applications.</p>\n<p>我们重点回顾应用于无人机光学影像的语义分割的先进方法和可用数据集，而非机载仪器、有效载荷、飞行自主性、数据采集技术或具体应用。</p>\n<p>The remainder of the paper is organized as follows.</p>\n<p>论文其余部分的组织如下。</p>\n<p>Section 2 presents the graph-based contextual models for semantic segmentation and analyzes the advantages and limitations of the individual models according to the model characteristics.</p>\n<p><ins>第二部分介绍了基于图的语义分割上下文模型</ins>，并根据模型特性分析各模型的优缺点。</p>\n<p>Section 3 reviews the popular semantic segmentation methods built on the DL framework, including encoder–decoder architectures, multi-scale and feature fusion strategies, relationship modeling methods, vision transformer architectures, and light-weight methods.</p>\n<p><ins>第三部分回顾基于 DL 框架的流行语义分割方法</ins>，包括编码器 - 解码器架构、多尺度和特征融合策略、关系建模方法、视觉变换器架构以及轻量级方法。</p>\n<p>Section 4 summarizes the available datasets for UAV-based image semantic segmentation.</p>\n<p><ins>第四节总结了基于无人机的图像语义分割可用的数据集</ins>。</p>\n<p>Section 5 provides an experimental evaluation of representative semantic segmentation models on two highresolution UAV-based datasets.</p>\n<p><ins>第五节对两个高分辨率无人机数据集上的代表性语义分割模型进行了实验评估</ins>。</p>\n<p>Semantic segmentation accuracy and model inference efficiency are the main aspects to be analyzed and discussed in our experimental assessments.</p>\n<p>语义分割的准确性和模型推断效率是我们实验评估中主要需要分析和讨论的方面。</p>\n<p>Section 6 provides a general summary of semantic segmentation models for UAV-based images as well as describes the remaining challenges and future research directions.</p>\n<p><ins>第六节概述了基于无人机图像的语义分割模型，并描述了剩余挑战和未来研究方向</ins>。</p>\n<p>Section 7 concludes the paper with a brief discussion of future trends and prospects.</p>\n<p><ins>第 7 节以对未来趋势和前景的简要讨论结束了本文。</ins></p>\n<h2 id=\"methods-based-on-graph-based-contextual-models\"><a class=\"markdownIt-Anchor\" href=\"#methods-based-on-graph-based-contextual-models\">#</a> Methods based on graph-based contextual models</h2>\n<p><mark>基于基于图的上下文模型方法</mark></p>\n<p>Individual pixels in a UAV image are insufficient to convey specific semantic meanings, but the image containing all pixels exhibits spatial contextual semantic information, such as scene details, semantic objects, and spatial relationships, among others.</p>\n<p>无人机图像中的单个像素不足以传达特定的语义意义，但包含所有像素的图像展现了空间上下文语义信息，如场景细节、语义对象和空间关系等。</p>\n<p>Hence, one feasible approach for semantic feature extraction is to establish dependencies between pixels or homogeneous regions within the image.</p>\n<p>因此，一种可行的语义特征提取方法是<mark>建立图像中像素或同质区域之间的依赖关系</mark>。</p>\n<p>Graphbased contextual models (Jordan, 2004; Drton and Maathuis, 2017) are practical methods that explicitly establish stochastic dependencies between pixels or regions using probabilistic theories to capture spatial contextual semantic information (Yu et al., 2018b).</p>\n<p>基于图的上下文模型（Jordan，2004;Drton 和 Maathuis， 2017）是一种实用方法，<mark>通过概率理论明确建立像素或区域之间的随机依赖关系，以捕捉空间上下文语义信息</mark>（Yu 等，2018b）。</p>\n<p>Furthermore, the considerable amount of complex semantic information within the UAV images can vary with changes in the scene, camera view, and flight altitude.</p>\n<p>此外，无人机图像中大量的复杂语义信息会随着场景、摄像机视角和飞行高度的变化而变化。</p>\n<p>Graph-based contextual models can reduce the mis-classification caused by this complexity by integrating semantic information from the neighborhoods when assigning class labels to each pixel or region in a given image (Solberg et al., 1996; Tso and Mather, 1999; Zheng and Wang, 2015; Yao et al., 2015; Gu et al., 2017; Yang et al., 2018).</p>\n<p>基于图的上下文模型可以通过在给图像中的每个像素或区域分配类别标签时<mark>整合邻域的语义信息</mark>，减少因复杂性导致的错误分类（Solberg 等，1996;Tso 和 Mather，1999; 郑和王，2015;Yao 等，2015;Gu 等，2017;Yang 等，2018）。</p>\n<p>Graph-based probabilistic models attribute the feature learning task to computing the probability distribution of variables.</p>\n<p>基于图的概率模型将特征学习任务归因于计算变量的概率分布。</p>\n<p>The Markov Random Field (MRF) and the Conditional Random Field (CRF) are the most popular graph-based contextual semantic algorithms.</p>\n<p>马尔可夫随机场（MRF）和条件随机场（CRF）是最流行的基于图的上下文语义算法。</p>\n<p>Both approaches map images onto an undirected graph model, where each vertex in the graph represents a pixel or feature vector of the image, and the edges between the vertices represent contextual dependencies.</p>\n<p>这两种方法都将图像映射到无向图模型上，图中的每个顶点代表图像的一个像素或特征向量，顶点之间的边代表上下文依赖关系。</p>\n<h3 id=\"mrf\"><a class=\"markdownIt-Anchor\" href=\"#mrf\">#</a> MRF</h3>\n<p>MRF is essentially a probabilistic generative model that predicts each class of images based on the joint probability distribution (Solberg et al., 1996; Tso and Mather, 1999; Kasetkasem and Varshney, 2002; Zheng et al., 2017; Yu et al., 2018b).</p>\n<p>MRF 本质上是一个概率生成模型，基于联合概率分布预测每类图像（Solberg 等，1996;Tso 和 Mather，1999;Kasetkasem 和 Varshney，2002 年；Zheng 等，2017;Yu 等，2018b）。</p>\n<p>The pixel distribution in an image can be viewed as the MRF since each pixel is related to its corresponding neighborhood.</p>\n<p>图像中的像素分布可以看作 MRF，因为每个像素都与其对应的邻域相关。</p>\n<p>It has been regarded as the practical model for describing spatial patterns and image characteristics.</p>\n<p>它被视为描述空间模式和图像特征的实用模型。</p>\n<p>Let Y denote the label field with L semantic classes, i.e. <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>Y</mi><mo>=</mo><mrow><msub><mi>y</mi><mn>1</mn></msub><mo separator=\"true\">,</mo><msub><mi>y</mi><mn>2</mn></msub><mo separator=\"true\">,</mo><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mo separator=\"true\">,</mo><msub><mi>y</mi><mi>L</mi></msub></mrow></mrow><annotation encoding=\"application/x-tex\">Y = {y_1, y_2, ... , y_L  }</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">Y</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">.</span><span class=\"mord\">.</span><span class=\"mord\">.</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">L</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></span>, and the x is the observed image.</p>\n<p>设 Y 表示具有 L 语义类的标签域，即<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>Y</mi><mo>=</mo><mrow><msub><mi>y</mi><mn>1</mn></msub><mo separator=\"true\">,</mo><msub><mi>y</mi><mn>2</mn></msub><mo separator=\"true\">,</mo><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mo separator=\"true\">,</mo><msub><mi>y</mi><mi>L</mi></msub></mrow></mrow><annotation encoding=\"application/x-tex\">Y = {y_1, y_2, ... , y_L  }</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">Y</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">.</span><span class=\"mord\">.</span><span class=\"mord\">.</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">L</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></span>，X 是观测到的图像。</p>\n<p>According to the Bayesian formula, the posterior distribution should be</p>\n<p>根据贝叶斯公式，后验分布应为</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>P</mi><mo stretchy=\"false\">(</mo><mi>y</mi><mi mathvariant=\"normal\">∣</mi><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mfrac><mrow><mi>P</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mi mathvariant=\"normal\">∣</mi><mi>y</mi><mo stretchy=\"false\">)</mo><mi>P</mi><mo stretchy=\"false\">(</mo><mi>y</mi><mo stretchy=\"false\">)</mo></mrow><mrow><mi>P</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></mrow></mfrac><mo>∝</mo><mi>P</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mi mathvariant=\"normal\">∣</mi><mi>y</mi><mo stretchy=\"false\">)</mo><mi>P</mi><mo stretchy=\"false\">(</mo><mi>y</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">P(y|x)=\\frac{P(x|y)P(y)}{P(x)}∝P(x|y)P(y)\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mord\">∣</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.363em;vertical-align:-0.936em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.427em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mord\">∣</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\">)</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\">)</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.936em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">∝</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mord\">∣</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\">)</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\">)</span></span></span></span></span></p>\n<p>where <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>P</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mi mathvariant=\"normal\">∣</mi><mi>y</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">P(x|y)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mord\">∣</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\">)</span></span></span></span> is the likelihood function and <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>P</mi><mo stretchy=\"false\">(</mo><mi>y</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">P(y)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\">)</span></span></span></span>is the part that describes the joint probability distribution of the label field.</p>\n<p>其中<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>P</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mi mathvariant=\"normal\">∣</mi><mi>y</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">P(x|y)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mord\">∣</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\">)</span></span></span></span>  是似然函数，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>P</mi><mtext>（</mtext><mi>y</mi><mtext>）</mtext></mrow><annotation encoding=\"application/x-tex\">P（y）</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8777699999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mord cjk_fallback\">（</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mord cjk_fallback\">）</span></span></span></span>是描述标签场联合概率分布的部分。</p>\n<p>Based on the assumption that the label field is independent and identically distributed, then the segmentation problem is equivalent to maximum a posterior (MAP)</p>\n<p>基于标签场独立且分布均匀的假设，则分割问题等价于最大后验（MAP）</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mover accent=\"true\"><mi>y</mi><mo>^</mo></mover><mo>=</mo><mi>arg</mi><mo>⁡</mo><munder><mo><mi>max</mi><mo>⁡</mo></mo><mrow><mi>y</mi><mo>∈</mo><mi>Y</mi></mrow></munder><mi>P</mi><mo stretchy=\"false\">(</mo><mi>y</mi><mo>∣</mo><mi>x</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\hat{y} = \\arg\\max_{y \\in Y} P(y \\mid x)\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.19444em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.630439em;vertical-align:-0.880439em;\"></span><span class=\"mop\">ar<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.43055999999999994em;\"><span style=\"top:-2.3556690000000002em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span><span class=\"mrel mtight\">∈</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.22222em;\">Y</span></span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span><span class=\"mop\">max</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.880439em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">∣</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span></span></span></span></span></p>\n<p>MRF has been adopted to model interactions of image features or contextual information of UAV photogrammetry and remote sensing tasks, such as target detection and tracking (Yu et al., 2006; Wan et al., 2019), image despeckling (Alparone et al., 2010), individual tree crown delineation (Harikumar et al., 2020), image classification (Fang et al., 2018b), and image segmentation (Zhang et al., 2013).</p>\n<p>MRF 已被用于建模无人机摄影测量和遥感任务（如目标检测和跟踪）中图像特征或上下文信息的相互作用（Yu 等，2006;Wan 等，2019）、图像去斑点（Alparone 等，2010）、单个树冠的划分（Harikumar 等，2020）、图像分类（Fang 等，2018b）以及图像分割（Zhang 等，2013）。</p>\n<p>However, the original pixel-based MRF is difficult to model the spatial pattern of the entire high-resolution image, it is more effective in tasks that only need to model a small number of pixels (Wan et al., 2019).</p>\n<p><mark>然而，原始基于像素的 MRF 难以建模整个高分辨率图像的空间模式，在只需建模少量像素的任务中效果更佳</mark>（Wan 等，2019）。</p>\n<blockquote>\n<p>像素级 MRF 不适合用于建模整个高分辨率图像的全局空间结构，但在只涉及少量像素或局部区域的任务中仍然具有较好的效果。</p>\n</blockquote>\n<p>Besides, the local Markovian property of the pixel-based MRF may not be preserved due to image transformations such as subsampling, block averaging, and subtraction of two images (Kasetkasem and Varshney, 2002; Gu et al., 2017).</p>\n<p>此外，基于像素的 MRF 的局部马尔可夫性质可能无法保持，因为图像变换如子采样、块平均和两张图像的相减（Kasetkasem 和 Varshney，2002;Gu 等，2017）。</p>\n<p>A multi-layer MRF can be established to achieve stable image point classification by constructing various features describing image points, such as color and texture, to model the feature interaction between layers (Kato et al., 2002; Benedek et al., 2007).</p>\n<p>可以通过构建描述图像点的各种特征（如颜色和纹理）来建立多层 MRF，以实现稳定的图像点分类，以模拟层间特征的相互作用（Kato 等，2002;Benedek 等，2007）。</p>\n<p>However, this approach can introduce more computational overhead proportional to the number of layers.</p>\n<p>然而，这种方法可能会带来与层数成正比的计算开销。</p>\n<p>To improve the image segmentation efficiency, Alparone et al. (2010) adopted the constrained MRF based on a binary tree structure (D’Elia et al., 2003) to recursively divide the image into smaller regions.</p>\n<p>为了提高图像分割效率，Alparone 等人（2010）采用了基于二叉树结构的约束 MRF（D’Elia 等，2003），递归地将图像划分为更小的区域。</p>\n<p>But this approach is still pixel-oriented and unsuitable for high-resolution UAV images with extensive texture details.</p>\n<p>但这种方法仍然是像素导向的，不适合具有大量纹理细节的高分辨率无人机图像。</p>\n<p>A set of similar and connected pixels in an image can be grouped as an object with meaningful representation according to specific properties such as shape, color, and spectral information (Levinshtein et al., 2009; Achanta et al., 2012; Crommelinck et al., 2017; He et al., 2019). The object-based image analysis (OBIA) (Castilla and Hay, 2008; Lang, 2008; Blaschke, 2010; Chen et al., 2018a; Hossain and Chen, 2019) can serve as an alternative to the per-pixel analysis method, since it cannot only reduce the computational overhead by decreasing the number of vertex of MRF but also reduce the impact of complex texture details within the pixel-set object on the semantic representation of the target to be segmented.</p>\n<p>图像中一组相似且相连的像素可以根据形状、颜色和光谱信息等特定属性被归为具有有意义表示的对象（Levinshtein 等，2009;Achanta 等，2012;Crommelinck 等，2017; 他等，2019）。基于对象的图像分析（OBIA）（Castilla 和 Hay，2008;Lang，2008;Blaschke，2010 年；Chen 等，2018a;Hossain 和 Chen，2019）可以作为每像素分析方法的替代方案，因为它不仅通过减少 MRF 顶点数来降低计算开销，还能减少像素集对象中复杂纹理细节对待分割目标语义表示的影响。</p>\n<p>The MRF model can also be extended to object-based MRF (OMRF) for semantic segmentation, in which each vertex of the adjacency graph represents a region over-segmented by object-based methods instead of pixels (Zheng and Wang, 2014; Zheng et al., 2017).</p>\n<p>MRF 模型也可以扩展到基于对象的 MRF（OMRF）进行语义分割，其中邻接图的每个顶点代表一个被基于对象的方法而非像素过度分割的区域（Zheng 和 Wang，2014;Zheng 等，2017）。</p>\n<p>For instance, Zhao et al. (2022) utilized the multi-scale line segment detector to obtain power line region proposals, then combined the Gaussian mixture model (GMM) and the weighted region adjacency graph (WRAG) to construct an OMRF-based power line detection model.</p>\n<p>例如，赵等人（2022）利用多尺度线段探测器获得了电力线区域的建议，随后结合高斯混合模型（GMM）和加权区域邻接图（WRAG）构建基于 OMRF 的电力线检测模型。</p>\n<p>GMM constructed the likelihood function to describe the conditional probability, and the WRGA utilized the spatial contextual information and interactions between objects.</p>\n<p>GMM 构建了似然函数来描述条件概率，WRGA 利用了空间上下文信息和物体间的交互。</p>\n<p>adopted an improved watershed algorithm to avoid over-segmentation and combined with edge-based coupled MRF to reduce false positives caused by speckles in PolSAR images.</p>\n<p>采用改进的流域算法以避免过度分割，并结合基于边缘的耦合 MRF，减少 PolSAR 图像中斑点引起的误报。</p>\n<p>It enhanced the accuracy of change detection between two UAVSAR images while also improving the weak missing discontinuous boundaries between the image objects.</p>\n<p>它提高了两幅 UAVSAR 图像之间变化检测的准确性，同时也改善了图像对象之间缺失的弱不连续边界。</p>\n<p>Both utilized the MRF to model the interaction between pixel groups generated from UAV-based images and assign the pixels belonging to a certain pixel group to have the same label.</p>\n<p>两者都利用 MRF 模拟由无人机图像生成的像素组之间的相互作用，并将属于某个像素组的像素赋予相同标签。</p>\n<p>However, improper modeling of spatial relationships of OMRF might lead to misclassification or over-smoothing for high-resolution remote sensing images.</p>\n<p>然而，OMRF 空间关系建模不当可能导致高分辨率遥感图像的误分类或过度平滑。</p>\n<p>Besides, most MRF-based semantic segmentation methods did not fully consider hierarchical semantic information or interlayer relationships between pyramid multi-resolution images.</p>\n<p>此外，大多数基于 MRF 的语义分割方法并未充分考虑层级语义信息或金字塔多分辨率图像之间的层间关系。</p>\n<p>Yao et al. (2021) proposed pyramid OMRF with dual-track information transmission (POMRF-DIT) to mine and transfer pyramid multilayer information.</p>\n<p>Yao 等人（2021）提出了带有双轨信息传输（POMRF-DIT）的金字塔 OMRF，用于挖掘和传输金字塔多层信息。</p>\n<p>Close-loop dual-track paths were also adopted to optimize the segmentation of each layer and achieve more physically meaningful structure modeling and interlayer information transfer mechanism.</p>\n<p>还采用了闭环双轨路径，以优化每层的分段，实现更具物理意义的结构建模和层间信息传递机制。</p>\n<p>MRF provides a solution for the semantic segmentation of UAV-based images, which constructs the interactions between pixels or groups of pixels with joint probability distribution to capture the semantic context information so that the segmentation results can be given semantic meanings.</p>\n<p>MRF 为无人机图像的语义分割提供了解决方案，该方法通过构建像素或像素组之间的交互关系，并以联合概率分布捕捉语义上下文信息，从而赋予分割结果语义意义。</p>\n<p>Nevertheless, there are still many difficulties in applying MRF to high-resolution UAV remote sensing images. For instance, the updating and inference process of the joint probability distribution in MRF is complicated and time-costing (Zheng et al., 2017).</p>\n<p>然而，将 MRF 应用于高分辨率无人机遥感图像仍存在许多困难。例如，MRF 中联合概率分布的更新和推断过程复杂且耗时（Zheng 等，2017）。</p>\n<p>In addition, the object scale variation and complex texture of UAV images make it difficult to design reasonable semantic rules.</p>\n<p>此外，无人机图像的物体尺度变化和复杂的纹理使得设计合理的语义规则变得困难。</p>\n<p>Only a few works are found in the literature where MRF is utilized for the semantic segmentation of UAV images.</p>\n<p>文献中只有少数文献将 MRF 用于无人机图像的语义分割。</p>\n<p>In many scenarios, CRF is a more commonly used graph-based contextual model, which will be described in the next section.</p>\n<p><mark>在许多场景中，CRF 是一种更常用的基于图的上下文模型，将在下一节中详细说明。</mark></p>\n<h3 id=\"crf\"><a class=\"markdownIt-Anchor\" href=\"#crf\">#</a> CRF</h3>\n<p><strong>Conditional Random Field</strong><br>\n<strong> 条件随机场</strong></p>\n<p>Unlike MRF, CRF for semantic segmentation is a probabilistic discriminant model that specifies the conditional probability distribution of the semantic labels given the observation data (Lafferty et al., 2001).</p>\n<p>与 MRF 不同，CRF 用于语义分割是一种概率判别模型，指定了在给定观察数据后语义标签的条件概率分布（Lafferty 等，2001）。</p>\n<p>It had cast a bright light on many aspects of the graph-based context tasks and profoundly impacted the semantic segmentation of UAV remote sensing images.</p>\n<p>它为基于图表的上下文任务的许多方面带来了亮点，并深刻影响了无人机遥感图像的语义分割。</p>\n<p>The inference process in CRF usually consists of association potential and interaction potential.</p>\n<p>CRF 中的推断过程通常包括关联势和相互作用势。</p>\n<p>Let S denotes all nodes that reflect the pixels or regions in an image, the index i ∈ S indicates the node site while the j represents the node site in a neighborhood Ni ∈ S.</p>\n<p>设 S 表示所有反映图像像素或区域的节点，索引 i∈S 表示节点站点，j 表示邻域 Ni∈S 中的节点站点。</p>\n<p>The posterior probability distribution P (y|x) directly modeled by the CRF can be described as (Kumar and Hebert, 2006; Hoberg et al., 2014)</p>\n<p>CRF 直接建模的后验概率分布 P（y|x）可以描述为（Kumar 和 Hebert，2006;Hoberg 等，2014）</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>P</mi><mo stretchy=\"false\">(</mo><mi>y</mi><mo>∣</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mfrac><mn>1</mn><mi>Z</mi></mfrac><mi>exp</mi><mo>⁡</mo><mrow><mo fence=\"true\">[</mo><munder><mo>∑</mo><mrow><mi>i</mi><mo>∈</mo><mi>S</mi></mrow></munder><msub><mi>A</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo separator=\"true\">,</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>+</mo><munder><mo>∑</mo><mrow><mi>i</mi><mo>∈</mo><mi>S</mi></mrow></munder><munder><mo>∑</mo><mrow><mi>j</mi><mo>∈</mo><msub><mi>N</mi><mi>i</mi></msub></mrow></munder><msub><mi>I</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy=\"false\">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo separator=\"true\">,</mo><msub><mi>y</mi><mi>j</mi></msub><mo separator=\"true\">,</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo fence=\"true\">]</mo></mrow></mrow><annotation encoding=\"application/x-tex\">P(y \\mid x) = \\frac{1}{Z} \\exp\\left[\n\\sum_{i \\in S} A_i(y_i, x)\n+ \\sum_{i \\in S} \\sum_{j \\in N_i} I_{ij}(y_i, y_j, x)\n\\right]\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">∣</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:3.6010299999999997em;vertical-align:-1.55002em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.32144em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">Z</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">exp</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\"><span class=\"mopen\"><span class=\"delimsizing mult\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.0510099999999998em;\"><span style=\"top:-2.2500000000000004em;\"><span class=\"pstrut\" style=\"height:3.1550000000000002em;\"></span><span class=\"delimsizinginner delim-size4\"><span>⎣</span></span></span><span style=\"top:-2.8099900000000004em;\"><span class=\"pstrut\" style=\"height:3.1550000000000002em;\"></span><span class=\"delimsizinginner delim-size4\"><span>⎢</span></span></span><span style=\"top:-4.05101em;\"><span class=\"pstrut\" style=\"height:3.1550000000000002em;\"></span><span class=\"delimsizinginner delim-size4\"><span>⎡</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.55002em;\"><span></span></span></span></span></span></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.050005em;\"><span style=\"top:-1.8556639999999998em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">∈</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05764em;\">S</span></span></span></span><span style=\"top:-3.0500049999999996em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.321706em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.050005em;\"><span style=\"top:-1.8556639999999998em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">∈</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05764em;\">S</span></span></span></span><span style=\"top:-3.0500049999999996em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.321706em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.050005em;\"><span style=\"top:-1.8556639999999998em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">∈</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">N</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3280857142857143em;\"><span style=\"top:-2.357em;margin-left:-0.10903em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.143em;\"><span></span></span></span></span></span></span></span></span></span><span style=\"top:-3.0500049999999996em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.430444em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span><span class=\"mclose\"><span class=\"delimsizing mult\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.0510099999999998em;\"><span style=\"top:-2.2500000000000004em;\"><span class=\"pstrut\" style=\"height:3.1550000000000002em;\"></span><span class=\"delimsizinginner delim-size4\"><span>⎦</span></span></span><span style=\"top:-2.8099900000000004em;\"><span class=\"pstrut\" style=\"height:3.1550000000000002em;\"></span><span class=\"delimsizinginner delim-size4\"><span>⎥</span></span></span><span style=\"top:-4.05101em;\"><span class=\"pstrut\" style=\"height:3.1550000000000002em;\"></span><span class=\"delimsizinginner delim-size4\"><span>⎤</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.55002em;\"><span></span></span></span></span></span></span></span></span></span></span></span></p>\n<blockquote>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>Z</mi></mrow><annotation encoding=\"application/x-tex\">Z</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">Z</span></span></span></span>：配分函数（partition function /normalization constant）</p>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>A</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo separator=\"true\">,</mo><mi>x</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">A_i(y_i, x)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span></span></span></span>：<strong>一元势函数（unary potential）</strong></p>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>I</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy=\"false\">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo separator=\"true\">,</mo><msub><mi>y</mi><mi>j</mi></msub><mo separator=\"true\">,</mo><mi>x</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">I_{ij}(y_i, y_j, x)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.036108em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span></span></span></span>：<strong>二元势函数（pairwise potential）</strong></p>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>S</mi></mrow><annotation encoding=\"application/x-tex\">S</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span></span></span></span>：节点（像素）集合</p>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>N</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">N_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>：节点 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>i</mi></mrow><annotation encoding=\"application/x-tex\">i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.65952em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">i</span></span></span></span> 的邻域</p>\n</blockquote>\n<p>where the term <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>A</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo separator=\"true\">,</mo><mi>x</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">A_i (y_i, x)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span></span></span></span> is the association (or unary) potential and the term <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>I</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy=\"false\">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo separator=\"true\">,</mo><msub><mi>y</mi><mi>j</mi></msub><mo separator=\"true\">,</mo><mi>x</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">I_{ij} (y_i, y_j , x)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.036108em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span></span></span></span> is the interaction (or pair-wise) potential. The association potential reflects the applicability to a pixel or region xi given a label <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">y_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>, while the interaction potential models the relationship between label <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">y_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> and <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>y</mi><mi>j</mi></msub></mrow><annotation encoding=\"application/x-tex\">y_j</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.716668em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span> , which can be regarded as a constraint to ensure the consistency of semantic label predictions. <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>Z</mi></mrow><annotation encoding=\"application/x-tex\">Z</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">Z</span></span></span></span> is the partition function that normalized the sum of potentials. <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>Z</mi></mrow><annotation encoding=\"application/x-tex\">Z</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">Z</span></span></span></span> is defined as</p>\n<p>其中项<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>A</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo separator=\"true\">,</mo><mi>x</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">A_i (y_i, x)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span></span></span></span> 是关联势（或一元势），项 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>I</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy=\"false\">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo separator=\"true\">,</mo><msub><mi>y</mi><mi>j</mi></msub><mo separator=\"true\">,</mo><mi>x</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">I_{ij} (y_i, y_j , x)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.036108em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span></span></span></span> 是相互作用（或两对势）。关联势反映了给定标签 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">y_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 时，像素或区域习适用性，而交互势能则模拟标签  <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">y_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 与  <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">y_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 之间的关系，这可被视为确保语义标签预测一致性的约束。 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>Z</mi></mrow><annotation encoding=\"application/x-tex\">Z</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">Z</span></span></span></span>  是归一化势和的配分函数。 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>Z</mi></mrow><annotation encoding=\"application/x-tex\">Z</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">Z</span></span></span></span>  定义为</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>Z</mi><mo>=</mo><munder><mo>∑</mo><mrow><msub><mi>y</mi><mi>i</mi></msub><mo>∈</mo><mi>Y</mi></mrow></munder><mi>exp</mi><mo>⁡</mo><mrow><mo fence=\"true\">[</mo><munder><mo>∑</mo><mrow><mi>i</mi><mo>∈</mo><mi>S</mi></mrow></munder><msub><mi>A</mi><mi>i</mi></msub><mo stretchy=\"false\">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo separator=\"true\">,</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>+</mo><munder><mo>∑</mo><mrow><mi>i</mi><mo>∈</mo><mi>S</mi></mrow></munder><munder><mo>∑</mo><mrow><mi>j</mi><mo>∈</mo><msub><mi>N</mi><mi>i</mi></msub></mrow></munder><msub><mi>I</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy=\"false\">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo separator=\"true\">,</mo><msub><mi>y</mi><mi>j</mi></msub><mo separator=\"true\">,</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo fence=\"true\">]</mo></mrow></mrow><annotation encoding=\"application/x-tex\">Z = \\sum_{y_i \\in Y}\n\\exp\\left[\n\\sum_{i \\in S} A_i(y_i, x)\n+ \\sum_{i \\in S} \\sum_{j \\in N_i} I_{ij}(y_i, y_j, x)\n\\right]\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">Z</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:3.6010299999999997em;vertical-align:-1.55002em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.050005em;\"><span style=\"top:-1.8556639999999998em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3280857142857143em;\"><span style=\"top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.143em;\"><span></span></span></span></span></span></span><span class=\"mrel mtight\">∈</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.22222em;\">Y</span></span></span></span><span style=\"top:-3.0500049999999996em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.430444em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">exp</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\"><span class=\"mopen\"><span class=\"delimsizing mult\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.0510099999999998em;\"><span style=\"top:-2.2500000000000004em;\"><span class=\"pstrut\" style=\"height:3.1550000000000002em;\"></span><span class=\"delimsizinginner delim-size4\"><span>⎣</span></span></span><span style=\"top:-2.8099900000000004em;\"><span class=\"pstrut\" style=\"height:3.1550000000000002em;\"></span><span class=\"delimsizinginner delim-size4\"><span>⎢</span></span></span><span style=\"top:-4.05101em;\"><span class=\"pstrut\" style=\"height:3.1550000000000002em;\"></span><span class=\"delimsizinginner delim-size4\"><span>⎡</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.55002em;\"><span></span></span></span></span></span></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.050005em;\"><span style=\"top:-1.8556639999999998em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">∈</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05764em;\">S</span></span></span></span><span style=\"top:-3.0500049999999996em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.321706em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.050005em;\"><span style=\"top:-1.8556639999999998em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">∈</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05764em;\">S</span></span></span></span><span style=\"top:-3.0500049999999996em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.321706em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.050005em;\"><span style=\"top:-1.8556639999999998em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">∈</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">N</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3280857142857143em;\"><span style=\"top:-2.357em;margin-left:-0.10903em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.143em;\"><span></span></span></span></span></span></span></span></span></span><span style=\"top:-3.0500049999999996em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.430444em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span><span class=\"mclose\"><span class=\"delimsizing mult\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.0510099999999998em;\"><span style=\"top:-2.2500000000000004em;\"><span class=\"pstrut\" style=\"height:3.1550000000000002em;\"></span><span class=\"delimsizinginner delim-size4\"><span>⎦</span></span></span><span style=\"top:-2.8099900000000004em;\"><span class=\"pstrut\" style=\"height:3.1550000000000002em;\"></span><span class=\"delimsizinginner delim-size4\"><span>⎥</span></span></span><span style=\"top:-4.05101em;\"><span class=\"pstrut\" style=\"height:3.1550000000000002em;\"></span><span class=\"delimsizinginner delim-size4\"><span>⎤</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.55002em;\"><span></span></span></span></span></span></span></span></span></span></span></span></p>\n<p>The unary potential of CRF for semantic segmentation is generally defined by the label assignment probability at pixels.</p>\n<p>CRF 在语义分割中的一元势能通常由像素处的标签分配概率定义。</p>\n<p>In the early UAV semantic segmentation tasks, Random Forest (Quang et al., 2015), Support Vector Machine (Zhang et al., 2018), or boosted classifiers (Girisha et al., 2019; Shotton et al., 2009) have been adopted to obtain the unary potential.</p>\n<p>在早期的无人机语义分割任务中，随机森林（Quang 等，2015）、支持向量机（Zhang 等，2018）或增强分类器（Girisha 等，2019;Shotton 等，2009）已被采用来获得一元势。</p>\n<p>However, constructing unary potential through traditional  classifiers lacks the integration of spatial context information, which may lead to misclassifications of pixel labels in high-resolution UAV images (Zhang et al., 2018).</p>\n<p>然而，通过传统分类器构建一元势缺乏空间上下文信息的整合，可能导致高分辨率无人机图像中像素标签的错误分类（Zhang 等，2018）。</p>\n<p>Zeggada et al. (2018), in another way, subdivided UAV images into a grid of tiles of equal size, then combined the Bag of Words, Autoencoder, and Multi-Layer Perceptron to construct the unary potential of CRF.</p>\n<p>Zeggada 等人（2018）则以另一种方式将无人机图像细分为大小相等的网格，然后结合词袋、自编码器和多层感知器，构建了 CRF 的一元势能。</p>\n<p>It independently integrated the local spatial context of each grid in UAV imagery to extract compact signatures that effectively describe the corresponding tiles.</p>\n<p>它独立整合了无人机图像中每个网格的局部空间上下文，提取出有效描述对应瓦片的紧凑签名。</p>\n<p>In the subsequent practices (Zhang et al., 2019b; Chiu et al., 2020; Huang et al., 2020; Lobo Torres et al., 2020; Girisha et al., 2020; Song et al., 2020; Zhong et al., 2020; Girisha et al., 2021a; Zhang et al., 2022a) of semantic segmentation for UAV images, Deep Convolutional Neural Networks (DCNNs) have gradually replaced the unary potential construction methods that require hand-crafted feature extraction.</p>\n<p><mark>在后续实践中（Zhang 等，2019b;Chiu 等，2020;Huang 等，2020;Lobo Torres 等，2020;Girisha 等，2020;Song 等，2020;Zhong 等，2020;Girisha 等，2021a;Zhang 等人，2022a）关于无人机图像语义分割的应用，深度卷积神经网络（DCNNs）逐渐取代了需要手工特征提取的一元势构建方法。</mark></p>\n<p>The stacked convolutional layers of DCNNs expand the receptive field (Krizhevsky et al., 2012) layer by layer, making it possible to automatically capture rich spatial contextual feature information of UAV images.</p>\n<p>堆叠卷积的 DCNN 层扩展感受场（Krizhevsky 等，2012），使得能够<mark>自动捕捉无人机图像丰富的空间上下文特征信息。</mark></p>\n<p>The last feature layer with softmax activation function (Krizhevsky et al., 2012; Long et al., 2015; Badrinarayanan et al., 2017) can be utilized as the label assignment probability required by the unary potential. Thus, researchers can focus on designing pair-wise potential functions applied to different UAV images and scenarios to capture the dependencies between pixels or objects.</p>\n<p>== 最后一个带有 softmax 激活函数的特征层（Krizhevsky 等，2012;Long 等，2015;Badrinarayanan 等，2017）可以作为一元势所需的标签赋值概率。== 因此，研究人员可以专注于设计应用于不同无人机图像和场景的成对势函数，以捕捉像素或物体之间的依赖关系。</p>\n<p>The pair-wise potential of the most commonly used plain CRF is usually defined by the Potts model or its variants (Yu et al., 2018b; Girisha et al., 2019).</p>\n<p>最常用的纯 CRF 的两对势能通常由 Potts 模型或其变体定义（Yu 等，2018b;Girisha 等，2019）。</p>\n<p>However, the plain CRF is limited to capturing long-range contextual semantic information due to the improper penalizing function.</p>\n<p>然而，由于惩罚函数不当，纯 CRF 仅限于捕捉长距离语义信息。</p>\n<p>Kong et al. (2020) argued that the part of UAV images where complex textures exist might result in label misclassification, and it was not convincible to penalize all inconsistent labels equally using the Potts model.</p>\n<p>Kong 等人（2020）认为，存在复杂纹理的无人机图像部分可能导致标签错误分类，且用 Potts 模型对所有不一致标签均等惩罚是不可信的。</p>\n<p>The pair-wise potentials applied to the semantic segmentation of UAV images can vary according to the specific tasks. For instance, Kong et al. (2020) considered that pixels with similar positions, similar colors, and small height differences should have a higher probability of assigning the same label for urban semantic segmentation.</p>\n<p>应用于无人机图像语义分割的两对势能会根据具体任务而异。例如，Kong 等人（2020）认为位置相似、颜色相似且高度差异较小的像素，在城市语义分割中应有更高的概率被赋予相同标签。</p>\n<p>The pair-wise potential they designed had considered features such as color, position, height, and scale. It achieved a more reasonable penalty for inconsistent label predictions of the semantic segmentation for UAV images.</p>\n<p>他们设计的配对潜力考虑了颜色、位置、高度和比例等特征。它对无人机图像语义分割标签预测不一致的惩罚更为合理。</p>\n<p>Furthermore, the long-range and shortrange dependencies between pixels are also essential for capturing the global contextual information needed for the semantic segmentation of UAV images.</p>\n<p>此外，像素之间的长距离和短距离依赖关系对于捕捉无人机图像语义分割所需的全局上下文信息也至关重要。</p>\n<p>Fully connected CRF (FC-CRF) (Krähenbühl and Koltun, 2011) contains pair-wise potentials of all individual pixels in an image.</p>\n<p>全连通 CRF（FC-CRF）（Krähenbühl 和 Koltun，2011）包含图像中所有单个像素的两两势。</p>\n<p>The spatial dependency between pixels established by FC-CRF is more effective in reducing the cluttered pixel-level misclassification in the semantic segmentation map and improving the smoothness of the segmentation boundaries of semantic objects (Quang et al., 2015; Zhang et al., 2018; Zhuo et al., 2018a; Girisha et al., 2019; Zhang et al., 2019b; Zhuo et al., 2019; Chiu et al., 2020; Huang et al., 2020; Lyu et al., 2020; Zhang et al., 2022a).</p>\n<p>FC-CRF 确立的像素间空间依赖性在减少语义分割图中像素层级的杂乱错误分类和改善语义对象分割边界的平滑性方面更为有效（Quang 等，2015;Zhang 等人，2018;Zhuo 等，2018a;Girisha 等，2019;Zhang 等人，2019b;Zhuo 等，2019;Chiu 等，2020;Huang 等，2020;Lyu 等，2020;Zhang 等，2022a）。</p>\n<p>In addition, FC-CRF can also be extended from the spatial dimension to the spatio-temporal dimension for comprehensive context integration and accurate scene understanding of UAV-based videos (Cao et al., 2019; Lyu et al., 2020).</p>\n<p>此外，FC-CRF 还可以从空间维度扩展到时空维度，实现无人机视频的全面上下文整合和准确的场景理解（Cao 等，2019;Lyu 等，2020）。</p>\n<p>However, the FC-CRF was no longer popular in recent remote sensing image parsing tasks due to the expensive computational overhead. To solve the abovementioned shortcomings of dense CRFs, Teichmann and Cipolla (2018) proposed Convolutional CRF (ConvCRF) based on the conditional independence assumption between two pixels.</p>\n<p><mark>然而，由于计算开销较高，FC-CRF 在近期遥感图像解析任务中已不再流行。为了解决上述密集 CRF 的不足，Teichmann 和 Cipolla（2018）提出了基于两个像素之间条件独立性假设的卷积 CRF（ConvCRF）。</mark></p>\n<p>The model utilized a convolutional neural network to construct unary potentials and set the interaction potentials to zero as the Manhattan distance between pixels exceeded the threshold. Based on the locality assumption, the processing speed of segmentation increased by two orders of magnitude while improving segmentation accuracy.</p>\n<p>该模型利用卷积神经网络构造一元势，并在像素间曼哈顿距离超过阈值时将交互势设为零。基于局部性假设，分割的处理速度提高了两个数量级，同时提高了切割准确性。</p>\n<p>Song et al. (2020) used ConvCRF as the post-processing of SegNet for sunflower lodging detection.</p>\n<p>Song 等人（2020）使用 ConvCRF 作为向日葵倒伏检测的 SegNet 后处理。</p>\n<p>This algorithm combination corrected the wrong prediction of the lodging area in UAV images and further optimized the segmentation boundaries, achieving the balance between segmentation accuracy and computational overhead.</p>\n<p>该算法组合纠正了无人机图像中倒伏区域的错误预测，并进一步优化了分割边界，实现了分割精度与计算开销之间的平衡。</p>\n<p>Here we introduce several public graph-based models and highlight their advantages and shortcomings, shown in Table 1. Although only a few works can be found where the graph-based models are utilized in recent research on semantic segmentation for UAV remote sensing images, the ideas of integrating semantic information by interaction terms between pixels or regions have encouraged the relationship modeling methods in deep feature-learned methods. We refer readers to Section 3.3 for more details.</p>\n<p>这里我们介绍了几个基于公开的基于图的模型，并重点介绍它们的优缺点，见表 1。尽管目前在无人机遥感图像语义分割研究中应用基于图的模型的作品很少，但通过像素或区域间交互项整合语义信息的理念，推动了深度特征学习方法中关系建模方法的发展。更多详情请阅读第 3.3 节。</p>\n<p>Summary of graph-based contextual models for UAV semantic segmentation.</p>\n<p>无人机语义分割的基于图的上下文模型总结。</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">类别</th>\n<th style=\"text-align:center\">模型</th>\n<th style=\"text-align:center\">应用</th>\n<th style=\"text-align:center\">图像模态</th>\n<th style=\"text-align:center\">特点</th>\n<th>性能与优势</th>\n<th style=\"text-align:left\">局限性</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">MRF</td>\n<td style=\"text-align:center\">OMRF</td>\n<td style=\"text-align:center\">输电线检测<br />（Zhao et al., 2022）</td>\n<td style=\"text-align:center\">RGB</td>\n<td style=\"text-align:center\">使用 GMM 和 WRAG 来定义目标之间的关系</td>\n<td>・具有更好的抗干扰能力<br />・提供了较高的检测精度并减少了误检线条</td>\n<td style=\"text-align:left\">・对复杂图像需要额外的计算时间<br />・参数选择较为复杂</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">MRF</td>\n<td style=\"text-align:center\">POMRF-DIT</td>\n<td style=\"text-align:center\">航空场景<br />（Yao et al., 2021）</td>\n<td style=\"text-align:center\">RGB</td>\n<td style=\"text-align:center\">基于金字塔的目标级 MRF，引入双通道信息传输以挖掘和传递金字塔多层信息</td>\n<td>・能够从金字塔结构中挖掘并传递图像信息<br />・分割收敛速度更快</td>\n<td style=\"text-align:left\">・对光谱特征相似的目标容易产生误分类</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CRF</td>\n<td style=\"text-align:center\">TextonBoost</td>\n<td style=\"text-align:center\">航空场景<br />（Girisha et al., 2019）</td>\n<td style=\"text-align:center\">RGB</td>\n<td style=\"text-align:center\">利用纹理布局和低层图像特征，引入像素间相关性以实现语义分割</td>\n<td>・学习纹理特征以捕获图像中的纹理布局上下文<br />・能够捕获更多图像细节</td>\n<td style=\"text-align:left\">・基于像素的 CRF<br />・处理时间较长</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CRF</td>\n<td style=\"text-align:center\">AF-CRF</td>\n<td style=\"text-align:center\">城市场景<br />（Kong et al., 2020）</td>\n<td style=\"text-align:center\">RGB、DSM</td>\n<td style=\"text-align:center\">将多尺度和注意力分析引入分割过程</td>\n<td>・采用均值场近似的快速求解算法以加速计算<br />・提供更高的精度和分割置信度</td>\n<td style=\"text-align:left\">・过度考虑长程依赖可能导致误分类</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CRF</td>\n<td style=\"text-align:center\">DCNN + DenseCRF</td>\n<td style=\"text-align:center\">城市 / 航空场景<br />（Zhang et al., 2019b；<br />Chiu et al., 2020；<br />Huang et al., 2020；<br />Lobo Torres et al., 2020；<br />Girisha et al., 2020；<br />Zhong et al., 2020；<br />Girisha et al., 2021a；<br />Zhang et al., 2022a）</td>\n<td style=\"text-align:center\">RGB、红外</td>\n<td style=\"text-align:center\">使用稠密 CRF 作为后处理，对卷积神经网络输出进行细化</td>\n<td>・能生成更加精细的分割结果<br />・修正了 CNN 中的一些误分类</td>\n<td style=\"text-align:left\">・稠密 CRF 中成对势函数的计算复杂度较高</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CRF</td>\n<td style=\"text-align:center\">DCNN + ConvCRF</td>\n<td style=\"text-align:center\">农作物倒伏检测<br />（Song et al., 2020）</td>\n<td style=\"text-align:center\">RGB、红边、近红外（NIR）</td>\n<td style=\"text-align:center\">每幅图像的单势由 CNN 的 softmax 输出设定，并采用局部性假设设计成对势</td>\n<td>・降低了成对势的计算复杂度<br />・更快且更具实用性</td>\n<td style=\"text-align:left\">・ConvCRF 在计算效率与像素间长程依赖之间存在折中</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"methods-based-on-deep-learning-models\"><a class=\"markdownIt-Anchor\" href=\"#methods-based-on-deep-learning-models\">#</a> Methods based on deep-learning models</h2>\n<p><mark>基于深度学习模型的方法</mark></p>\n<p>UAV-based images with higher resolution typically contain semantic objects or regions that hold intricate and detailed semantic representations.</p>\n<p>基于无人机的更高分辨率图像通常包含包含复杂且详细语义表示的语义对象或区域。</p>\n<p>Hand-engineered graph-based contextual models struggle to cope with these intricate semantic representations, and these techniques of image semantic segmentation are gradually being overtaken by DL-based architectures in UAV remote sensing (Osco et al., 2021).</p>\n<p>手工设计的基于图的上下文模型难以应对这些复杂的语义表示，这些图像语义分割技术正逐渐被无人机遥感中的基于 DL 架构所取代（Osco 等，2021）。</p>\n<p>DLbased semantic segmentation not only eliminates the tedious process of hand-crafted feature extraction with the well-designed combinations of various trainable operators, such as convolution layers, linear layers, and activation layers (Yu et al., 2018b; Yuan et al., 2021), but also presents better segmentation performance to the complex semantic representations of high-resolution images in UAV remote sensing.</p>\n<p><mark>基于 DL 的语义分割不仅消除了手工制作特征提取的繁琐过程，采用了多种可训练算符的良好组合，如卷积层、线性层和激活层（Yu 等，2018b;Yuan 等，2021），同时也在无人机遥感中对高分辨率图像的复杂语义表示提供了更好的分割性能。</mark></p>\n<p>Our literature review in this section focuses on five aspects of DL-based advances for image semantic segmentation in UAV remote sensing: (1) Encoder–decoder architectures; (2) Multi-scale and feature fusion strategies; (3) Relationship modeling methods; (4) Vision transformer architectures; (5) Light-weight methods.</p>\n<p>本节文献综述聚焦于无人机遥感图像语义分割基于 DL 的五个方面：</p>\n<ol>\n<li>编码 - 解码器架构</li>\n<li>多尺度和特征融合策略</li>\n<li>关系建模方法</li>\n<li>视觉变换器架构</li>\n<li>轻量化方法。</li>\n</ol>\n<h3 id=\"encoderdecoder-architectures\"><a class=\"markdownIt-Anchor\" href=\"#encoderdecoder-architectures\">#</a> Encoder–decoder architectures</h3>\n<p>In previous studies, the encoder–decoder architecture had been widely adopted to achieve pixel-wise labeling when designing DCNN for semantic segmentation tasks.</p>\n<p>在以往的研究中，编码器 - 解码器架构已被广泛采用，以实现针对语义分割任务的 DCNN 实现像素标记。</p>\n<p>The encoder–decoder architectures usually consist of two primary components.</p>\n<p>编码器 - 解码器架构通常由两个主要组成部分组成。</p>\n<p>The first component is the encoder structure, which is generally composed of an efficient backbone of a pre-trained classification network.</p>\n<p>第一个组成部分是编码器结构，通常由预训练分类网络的高效骨干组成。</p>\n<p>It aims to reduce the spatial scale of the input image and extract feature maps with context semantic information.</p>\n<p><mark>其目标是降低输入图像的空间尺度，并提取带有上下文语义信息的特征图。</mark></p>\n<p>Besides, pooling-based and convolution-based down-sampling strategies have been wildly adopted as the standard techniques in the encoder process for increasing the local prospective field and reducing computation costs.</p>\n<p><mark>此外，基于池和卷积的下采样策略已被广泛采用为编码器过程中的标准技术，用于增加局部前景场并降低计算成本。</mark></p>\n<p>Another component is the decoder structure, which typically utilizes bilinear interpolation or deconvolution (Dumoulin and Visin, 2016) up-sample strategies.</p>\n<p>另一个组成部分是解码器结构，通常采用<mark>双线性插值</mark>或<mark>反卷积</mark>（Dumoulin 和 Visin，2016）上采样策略。</p>\n<p>It maps the low-resolution feature blocks of the encoder structure back to feature blocks or prediction outputs with higher spatial resolution.</p>\n<p><mark>它将编码器结构中的低分辨率特征块映射回具有更高空间分辨率的特征块或预测输出。</mark></p>\n<p>It maps the low-resolution feature blocks of the encoder structure back to feature blocks or prediction outputs with higher spatial resolution.</p>\n<p>它将编码器结构中的低分辨率特征块映射回具有更高空间分辨率的特征块或预测输出。</p>\n<h4 id=\"fcn\"><a class=\"markdownIt-Anchor\" href=\"#fcn\">#</a> FCN</h4>\n<p>The pioneering end-to-end encoder–decoder structure for the pixelwise semantic segmentation tasks is fully convolutional neural network (FCN) proposed by Long et al. (2015).</p>\n<p>像素语义分割任务的开创性端到端编码 - 解码结构是 Long 等人（2015）提出的<mark>全卷积神经网络（FCN）。</mark></p>\n<p>FCN adopted the performanceproven convolutional classification network, such as VGG16 (Simonyan and Zisserman, 2015), as the feature encoder to integrate contextual and location information.</p>\n<p>FCN 采用了性能验证的卷积分类网络，如 VGG16（Simonyan 和 Zisserman，2015），作为整合上下文和位置信息的特征编码器。</p>\n<p>As shown in Fig. 1, FCN replaced the fully connected layers of CNN with only convolutional layers, making it possible to predict the class labels of all pixels with different spatial resolutions.</p>\n<p>如图 1 所示，FCN 用卷积层替代了 CNN 的全连通层，使得预测所有具有不同空间分辨率像素的类标签成为可能。</p>\n<p>The structures of three types of FCNs followed the principle of combining coarse to fine layers to make the local predictions consistent with the global context information. For instance, the prediction result of FCN32s was computed by up-sampling the last max-pooling layer of VGG16 by a factor of 32, while that of FCN8s could be obtained by up-sampling the combination of the last three max-pooling layers by a factor of 8.</p>\n<p>三种类型的全卷积网络（FCN）的结构遵循从粗到细层结合的原则，以使局部预测与全局上下文信息保持一致。例如，FCN32s 的预测结果是通过对 VGG16 的最后一个最大池化层进行 32 倍上采样计算得到的，而 FCN8s 的预测结果则可以通过对最后三个最大池化层的组合进行 8 倍上采样得到。</p>\n<p>Fig. 1. Upsampling and fusion step of the FCN. Three upsampling and fusion strategies correspond to the network structure of FCN32s, FCN16s, and FCN8s. The fully connected layers of the feature backbone are replaced by the convolutional layers.</p>\n<p>图 1。FCN 的上采样和融合步骤。三种上采样和融合策略对应 FCN32、FCN16 和 FCN8 的网络结构。特征骨干的全连通层被卷积层取代。</p>\n<img data-src=\"../../images/paper/semantic_segmentation/1.png\" alt=\"1\"  />\n<p>Fig. 2. Graphical visualization of the original SegNet architecture. SegNet adopts a symmetric encoder–decoder structure without fully connected layers.</p>\n<p>图 2。原始 SegNet 架构的图形可视化。SegNet 采用对称编码 - 解码结构，没有完全连接的层。</p>\n<p>As far as we know, FCN had been widely used for weed mapping (Huang et al., 2018a; Deng et al., 2020), crop lodging detection (Yang et al., 2020), road extraction (Kestur et al., 2018; Varia et al., 2018; Senthilnath et al., 2020), cadastral boundary extraction (Xia et al., 2019a,b), building footprint detection (Zhuo et al., 2018b), and many others. Comparative experiments (Huang et al., 2018c; Xia et al., 2019b; Yang et al., 2020) also demonstrated that the FCN had more excellent semantic aggregation ability and outstanding image processing efficiency than traditional image segmentation methods, such as CRF, Maximum Likelihood Classification (MLC), and Multi-Resolution Segmentation (MRS).</p>\n<p>据我们所知，FCN 已被广泛用于<mark>杂草测绘</mark>（Huang 等，2018a; 邓等，2020）、<mark>作物沉伏检测</mark>（Yang 等，2020）、道路开采（Kestur 等，2018;Varia 等，2018;Senthilnath 等，2020）、<mark>地籍边界提取</mark>（Xia 等，2019a，b）、<mark>建筑基准检测</mark>（Zhuo 等，2018b）以及其他许多方法。比较实验（Huang 等，2018c;Xia 等，2019b;Yang 等，2020）还证明，FCN 比传统图像分割方法（如 CRF、最大似然分类（MLC）和多分辨率分割（MRS））具有更优异的语义聚合能力和卓越的图像处理效率。</p>\n<p>However, there were still some drawbacks of FCN in handling high-resolution UAV-based images.</p>\n<p>然而，FCN 在处理高分辨率无人机图像时仍存在一些缺点。</p>\n<p>Huang et al. (2018b) had proven the efficiency of FCN on semantic segmentation of weed maps by transfer learning strategy, but their subsequent work (Huang et al., 2018a) found that the last pooling operation of FCN8s might result in losing spatial information and reduced accuracy.</p>\n<p><mark>Huang 等人（2018b）已证明 FCN 通过迁移学习策略在杂草图语义分割中的高效性，但他们后续的研究（Huang 等，2018a）发现 FCN8 的最后一次池化作可能导致空间信息丢失和准确性下降。</mark></p>\n<p>Xia et al. (2019a) also utilized FCN to obtain the fragmented cadastral boundaries from UAV remote sensing images and then applied the OWT-UCM algorithm to produce connected boundaries.</p>\n<p>Xia 等人（2019a）还利用 FCN 从无人机遥感图像中获取碎片化地层边界，随后应用 OWT-UCM 算法生成连通边界。</p>\n<p>Unfortunately, the smoothing effect caused by max-pooling layers of FCN resulted in discontinuous boundaries. Therefore, their subsequent work (Xia et al., 2019b) on FCN discarded the max-pooling layers to avoid fuzzy boundary predictions.</p>\n<p>不幸的是，最大池化层造成的平滑效果导致边界不连续。<mark>因此，他们后续关于 FCN 的研究（Xia 等，2019b）为避免模糊边界预测，舍弃了最大池层</mark>。</p>\n<p>The literature abovementioned exemplifies the suitability of FCN for UAV remote sensing image parsing tasks. But it is worth noting that the max pooling layers make the FCN insensitive to the details in high-resolution images, which leads to fuzzy pixel-level semantic predictions.</p>\n<p>上述文献展示了 FCN 在无人机遥感图像解析任务中的适用性。<mark>但值得注意的是，最大池化层使得 FCN 对高分辨率图像的细节不敏感，导致像素级语义预测模糊。</mark></p>\n<p>Some attention has focused on custom improvements to FCN, such as skip connections (Kestur et al., 2018), to exploit rich spatial patterns and semantic representations of UAV images.</p>\n<p>一些关注点集中在对 FCN 的自定义改进上，如跳跃连接（Kestur 等，2018），以利用无人机图像丰富的空间模式和语义表示。</p>\n<p>Comparative experiments (Song et al., 2020; Lobo Torres et al., 2020) also illustrated that skip connection and discarding the max-pooling layers allowed FCN to preserve fine-grained spatial information and object overall consistency.</p>\n<p>比较实验（Song 等，2020;Lobo Torres 等，2020）还指出，跳跃连接和丢弃最大池层使 FCN 能够保持细粒度的空间信息和整体对象的一致性。</p>\n<h4 id=\"segnet\"><a class=\"markdownIt-Anchor\" href=\"#segnet\">#</a> SegNet</h4>\n<p>The down-sampling strategy of FCN did not take the pixel-to-pixel contextual relationship and object overall consistency into consideration, resulting in the segmentation predictions with insufficient refinement.</p>\n<p>FCN 的下采样策略未考虑像素对像素的上下文关系和对象整体一致性，导致分割预测细化不足。</p>\n<p>To address these drawbacks of lacking a reasonable mapping mechanism from feature map to input image spatial resolution, SegNet (Badrinarayanan et al., 2017) adopted a structurally symmetrical encoder–decoder network with skip connections.</p>\n<p>为解决特征映射到输入图像空间分辨率缺乏合理映射机制的不足，SegNet（Badrinarayanan 等，2017）采用了结构对称的编码 - 解码器网络，采用跳跃连接。</p>\n<p>Specifically, SegNet decoded multi-scale encoded feature maps layer by layer to enhance the capacity of global contextual information.</p>\n<p>具体来说，SegNet 逐层解码多尺度编码特征图，以增强全局上下文信息的容量。</p>\n<p>Meanwhile, it utilized the max-pooling indices of encoder layers to maintain the overall consistency of semantic information and avoid ambiguous predictions. The illustration of the SegNet architecture is shown in Fig. 2.</p>\n<p>同时，它利用编码器层的最大池化索引来保持语义信息的整体一致性，并避免模糊的预测。SegNet 架构的示意图如图 2 所示。</p>\n<blockquote>\n<p><strong>SegNet 的想法</strong>：既然下采样时我丢了位置，那我就顺手把位置记下来</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">对比项</th>\n<th style=\"text-align:center\">池化索引</th>\n<th style=\"text-align:center\">反卷积</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">是否学习</td>\n<td style=\"text-align:center\">❌</td>\n<td style=\"text-align:center\">✅</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">保存内容</td>\n<td style=\"text-align:center\">位置</td>\n<td style=\"text-align:center\">卷积核</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">上采样方式</td>\n<td style=\"text-align:center\">放回原位</td>\n<td style=\"text-align:center\">学习插值</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">是否会产生伪影</td>\n<td style=\"text-align:center\">几乎不会</td>\n<td style=\"text-align:center\">可能有棋盘效应</td>\n</tr>\n</tbody>\n</table>\n</blockquote>\n<p>Based on the improvements, a significant amount of research had been devoted to segmenting crops (Fawakherji et al., 2019; Song et al., 2020), trees (Lobo Torres et al., 2020), wetlands (Fu et al., 2021a), buildings (Boonpook et al., 2018), and roads (Boonpook et al., 2021) from high-resolution images.</p>\n<p>基于这些改进，大量研究致力于作物分段（Fawakherji 等，2019;Song 等，2020）、树木（Lobo Torres 等，2020）、湿地（Fu 等，2021a）、建筑物（Boonpook 等，2018）和道路（Boonpook 等，2021），均来自高分辨率图像。</p>\n<p>The modifications on SegNet for segmenting different objects can vary substantially due to the physical and spatial characteristics of UAV remote sensing images.</p>\n<p>SegNet 在分割不同物体时的修改可能因无人机遥感图像的物理和空间特性而有很大差异。</p>\n<p>For instance, Li et al. (2022a) reduced the number of convolutional blocks in the encoding and decoding block to improve segmentation efficiency.</p>\n<p>例如，Li 等人（2022a）减少了编码和解码块中的卷积块数量，以提高分割效率。</p>\n<p>Then they adopted the dilated convolution to expand the lost receptive field.</p>\n<p>然后他们采用扩张卷积法来扩展失去的感受野。</p>\n<p>Zhong et al. (2022) proposed W-SegNet, the two encoder–decoder structure built on top of SegNet, to achieve hierarchical, multi-scale, and multi-level feature fusion. In addition, benefiting from excellent feature extraction and overall consistency predictions, SegNet has also received great attention for multi-modal UAV image segmentation tasks.</p>\n<p>Zhong 等人（2022）提出了基于 SegNet 构建的双编码 - 解码器结构 W-SegNet，以实现层级、多尺度和多层次的特征融合。此外，凭借出色的特征提取和整体一致性预测，SegNet 在多模态无人机图像分割任务中也备受关注。</p>\n<p>Song et al. (2020) combined SegNet with ConvCRF to refine sunflower lodging prediction on high-resolution multispectral images collected by UAVs.</p>\n<p>Song 等人（2020）结合 SegNet 与 ConvCRF，优化了无人机采集的高分辨率多光谱图像向日葵倒伏预测。</p>\n<p>Yang et al. (2020) achieved the highest mapping accuracy of plastic mulched farmland and the smoothest mapping boundary based on 6-band image data.</p>\n<p>Yang 等人（2020）基于 6 波段图像数据，实现了塑料覆盖农田的最高测绘精度和最平滑的测绘边界。</p>\n<p>Kerkech et al. (2020) proposed a fusion of multi-modal segmentation based on dual SegNets to obtain robust vine disease maps after image registration between the visible and infrared ranges.</p>\n<p>Kerkech 等人（2020）提出了基于双重 SegNet 的多模态分割融合，以获得可见光与红外范围图像配线后的稳健藤蔓病害图谱。</p>\n<p>Li et al. (2021b) concluded that combining NIR and RGB images could improve the accuracy of sunflower lodging, while the red-edge data acted as a side effect.</p>\n<p>Li 等人（2021b）得出结论，结合近红外和 RGB 图像可以提高向日葵倒伏的准确性，而红边数据则是副作用。</p>\n<blockquote>\n<p>在实际数据中，“红边数据” 通常是：</p>\n<ul>\n<li>无人机 / 卫星的 <strong>红边波段影像</strong></li>\n<li>常见波段中心：705 nm 717 nm 740 nm</li>\n</ul>\n<p>红边更擅长 “健康评估”，而不是 “形态 / 倒伏检测”</p>\n</blockquote>\n<p>Boonpook et al. (2018) also demonstrated that different combinations of modalities (RGB, visible-band difference vegetation index (VDVI), and DSM) of UAV sensors allowed SegNet to distinguish building and ground features more accurately.</p>\n<p>Boonpook 等人（2018）还证明，不同无人机传感器的模态组合（RGB、可见波段差植被指数（VDVI）和 DSM）使 SegNet 能够更准确地区分建筑物和地面特征。</p>\n<p>The wildly adopted SegNet selected VGG (Simonyan and Zisserman, 2015) as the feature extraction backbone and utilized max-pooling layers in the encoding process.</p>\n<p>广受欢迎的 SegNet 选择了 VGG（Simonyan 和 Zisserman，2015）作为特征提取骨干，并在编码过程中使用了最大池化层。</p>\n<p>Such network architecture offered the unique advantages of maintaining overall semantic consistency for large-scale scenes such as buildings and geographical areas.</p>\n<p>这种网络架构提供了保持大型场景（如建筑物和地理区域）整体语义一致性的独特优势。</p>\n<p>But the significant limitation was that those scenes with apparent edge features and texture information, such as vegetation and crops, suffered poor segmentation accuracy as max-pooling layers lost detailed spatial contents.</p>\n<p>但主要局限是那些带有明显边缘特征和纹理信息的场景，如植被和作物，由于最大层叠会丢失详细的空间内容，分割精度较低。</p>\n<p>Fu et al. (2021a) conducted comparative experiments with optimized objects-based Random Forest-Decision Tree (RF-DT) and SegNet on the UAV dataset of digital orthophoto map (DOM) and digital surface model (DSM) imagery for Karst wetland vegetation communities.</p>\n<p>Fu 等人（2021a）在无人机数字正射照片地图（DOM）和数字地表模型（DSM）数据集上，针对喀斯特湿地植被群落进行了基于优化对象的随机森林决策树（RF-DT）和 SegNet 的比较实验。</p>\n<p>Surprisingly, the optimized RF-DT algorithm achieved better overall accuracy than SegNet. After further analysis of the contribution of the four multi-source features, they found that the geometric feature describing the boundaries and shapes of vegetations as well as the texture feature presenting the surface properties of the scene played an important role in vegetation classification.</p>\n<p>== 令人惊讶的是，优化后的射频 - DT 算法整体精度优于 SegNet。== 经过对四大多源特征贡献的进一步分析，他们发现描述植被边界和形状的几何特征，以及呈现场景表面属性的纹理特征，在植被分类中起到了重要作用。</p>\n<p>Subsequent work, a fusion of multiple SegNet, conducted by Deng et al. (2022) further demonstrated that texture features could provide the visible intensity complement for karst wetland vegetation mapping.</p>\n<p>随后，邓等人（2022 年）对多重 SegNet 的融合进一步证明，纹理特征可以为喀斯特湿地植被绘制提供可见强度的补充。</p>\n<p>Both verified that fine-scale information could enhance the spectral separability of vegetation in wetlands (Szantoi et al., 2013; Hu et al., 2020).</p>\n<p>两者都证实了细微尺度信息能够增强湿地植被的光谱分离性（Szantoi 等，2013; 胡等，2020）。</p>\n<p>Unfortunately, SegNet was still deficient in extracting and handling these detailed features.</p>\n<p><mark>遗憾的是，SegNet 在提取和管理这些详细功能方面仍然不足。</mark></p>\n<h4 id=\"deconvnet\"><a class=\"markdownIt-Anchor\" href=\"#deconvnet\">#</a> DeconvNet</h4>\n<p>Improper down-sampling operations may lead to loss of spatial features, and thus decoding or mapping low-resolution feature maps to pixel-level predictions is the primary concern in encoder–decoder architectures.</p>\n<p>不当的下采样作可能导致空间特征丢失，因此解码或映射低分辨率特征映射到像素级预测是编码器 - 解码器架构中的主要关注点。</p>\n<p>FCN adopted deconvolution to produce nonlinear pixel-level predictions, while SegNet utilized max-pooling indices to upsample feature maps from the corresponding encoder layers.</p>\n<p><mark>FCN 采用了反卷积技术来生成非线性像素级预测，而 SegNet 则利用最大池化指标从相应编码器层对特征图进行上采样。</mark></p>\n<p>Another effective encoder–decoder structure, DeconvNet proposed by Noh et al. (2015), aimed to accurately reconstruct the high-dimensional nonlinear structural information with deep deconvolution up-sample mechanism.</p>\n<p>另一种有效的编码器 - 解码器结构，由 Noh 等人（2015 年）提出的 DeconvNet，旨在通过<mark>深度反卷积上采样机制</mark>，准确重建高维非线性结构信息。</p>\n<p>Huang et al. (2016) constructed two isolated DeconvNet for optical images and NRG data, respectively.</p>\n<p>Huang 等人（2016）分别构建了两个独立的去整合网，分别用于光学图像和 NRG 数据。</p>\n<p>The quantitative evaluation proved the efficiency of DeconvNet in extracting buildings with rich topological appearances.</p>\n<p>定量评估证明了 DeconvNet 在提取具有丰富拓扑外观建筑方面的高效性。</p>\n<p>To handle the complex texture information and visual intensity change of remote sensing images, Cheng et al. (2016) designed a structured edge network (SeNet) with skip connections based on DeconvNet.</p>\n<p>为了处理遥感图像的复杂纹理信息和视觉强度变化，Cheng 等人（2016）设计了一个基于 DeconvNet 的结构化边缘网络（SeNet），带有跳跃连接。</p>\n<p>The SeNet that combined local regularization with structured edge supervision achieved better spatial consistency and edge accuracy.</p>\n<p>将局部正则化与结构化边缘监督结合的 SeNet 实现了更好的空间一致性和边缘精度。</p>\n<p>However, due to the larger number of parameters of the trainable deconvolution, DeconvNet requires longer training and inference time than FCN and SegNet (Yi et al., 2019). It curbed the application of DeconvNet and there are few papers can be found where DeconvNet was adopted for the semantic segmentation of UAV remote sensing images.</p>\n<p><mark>然而，由于可训练反卷积的参数数量更多，DeconvNet 需要比 FCN 和 SegNet 更长的训练和推理时间（Yi 等，2019）。它限制了 DeconvNet 的应用，目前很少有论文将 DeconvNet 用于无人机遥感图像的语义分割。</mark></p>\n<hr>\n<p>In this section, we introduced three types of encoder–decoder models for semantic segmentation of high-resolution remote sensing images, including FCN, SegNet, and DeconvNet.</p>\n<p>本节介绍了三种用于高分辨率遥感图像语义分割的编码器 - 解码器模型，包括 FCN、SegNet 和 DeconvNet。</p>\n<p>The network structure of FCN and SegNet is simple yet efficient, and it is feasible to perform rapid evaluation and deployment based on these models for various tasks.</p>\n<p>FCN 和 SegNet 的网络结构简单高效，基于这些模型可以快速评估和部署各种任务。</p>\n<p>They have been the most popular DL-based methods in the recent advances of semantic segmentation for UAV remote sensing images.</p>\n<p>它们是近年来无人机遥感图像语义分割进展中最受欢迎的基于深度学习的方法。</p>\n<p>However, the compressed latent representation of encoders makes the decoders difficult to recover spatial details and leads to ambiguity in the segmentation results, such as inconsistent intra-class predictions and fuzzy boundaries.</p>\n<p>然而，编码器的压缩潜在表示使得解码器难以恢复空间细节，并导致分割结果存在歧义，如类内预测不一致和边界模糊。</p>\n<h3 id=\"multi-scale-and-feature-fusion-strategies\"><a class=\"markdownIt-Anchor\" href=\"#multi-scale-and-feature-fusion-strategies\">#</a> Multi-scale and feature fusion strategies</h3>\n<p>多尺度和特征融合策略</p>\n<p>The rapid increment in the resolution of UAV remote sensing images leads to more complex intra-class variations of pixels within semantic objects or regions (Aplin, 2006; Torres-Sánchez et al., 2015).</p>\n<p>无人机遥感图像分辨率的快速提升导致语义对象或区域内像素的类别内变异更加复杂（Aplin，2006;Torres-Sánchez 等，2015）。</p>\n<p>The rich spatial details provided by high-resolution images may result in variation within semantic features (Aplin, 2006), which will also weaken the models’ capacity to maintain intra-class consistency and inter-class variance for semantic segmentation (Torres-Sánchez et al., 2015; Tamouridou et al., 2017).</p>\n<p><mark>高分辨率图像提供的丰富空间细节可能导致语义特征的变异（Aplin，2006），这也会削弱模型维持类内一致性和类间语义分割变异的能力（Torres-Sánchez 等，2015;Tamouridou 等，2017）。</mark></p>\n<p>Besides, due to the unfixed perspective and varying flight altitudes of UAV platforms, semantic representations extracted at different spatial resolutions in high-resolution images may yield different semantic segmentation accuracies (Aplin, 2006; Woodcock and Strahler, 1987), which can be one of the primary challenges for image semantic segmentation in UAV remote sensing.</p>\n<p><mark>此外，由于无人机平台的视角不固定且飞行高度不同，在高分辨率图像中以不同空间分辨率提取的语义表示可能产生不同的语义分割精度（Aplin，2006;Woodcock 和 Strahler，1987），这可能是无人机遥感图像语义分割的主要挑战之一。</mark></p>\n<p>Early studies (Baatz and Schape, 2000; Hay et al., 2003; Drˇaguţ et al., 2010) on high-resolution remote sensing image parsing demonstrated that multiresolution techniques were able to address these problems.</p>\n<p>早期研究（Baatz 和 Schape，2000;Hay 等，2003;Drˇaguţ 等，2010）关于高分辨率遥感图像解析的研究表明，多分辨率技术能够解决这些问题。</p>\n<p>Similarly, in the field of DL, the strategy based on multi-scale feature extraction and feature fusion has been developed to extract effective feature representations at different spatial scales.</p>\n<p>同样，在深度学习领域，基于多尺度特征提取和特征融合的策略已被开发出来，以在不同空间尺度下提取有效的特征表示。</p>\n<p>Intuitively, this strategy extracts coarse to fine feature maps at multiple spatial scales from high-resolution UAV images simultaneously, then integrates these into a fused feature map at a particular spatial scale after feature  alignment (Chen et al., 2017a; Ronneberger et al., 2015; Chen et al., 2017a,b, 2018b; Wang et al., 2020c).</p>\n<p>直观上，该策略从高分辨率无人机图像中同时提取多个空间尺度的粗到细特征图，然后在特征对齐后将其整合到特定空间尺度的融合特征图中（Chen 等，2017a;Ronneberger 等，2015;Chen 等，2017a，b，2018b;Wang 等，2020c）。</p>\n<p>It not only allows for adaptive selection of feature maps with optimal spatial scales based on the size of semantic objects in high-resolution UAV images, but also compensates for the loss of spatial details caused by the down-sampling operators in the feature encoder structure.</p>\n<p><mark>它不仅允许基于高分辨率无人机图像中语义对象大小，自适应选择具有最佳空间尺度的特征图，还能补偿特征编码结构中下采样算子导致的空间细节损失。</mark></p>\n<h4 id=\"deeplab-series\"><a class=\"markdownIt-Anchor\" href=\"#deeplab-series\">#</a> DeepLab series</h4>\n<p>The pioneering encoder–decoder architectures, such as SegNet and FCN, integrate multi-scale features from the last encoder layers to simultaneously handle large-scale and fine-scale objects.</p>\n<p>开创性的编码器 - 解码器架构，如 SegNet 和 FCN，整合了上一代编码器层的多尺度特征，以同时处理大尺度和细尺度对象。</p>\n<p>But it is still deficient in achieving accurate segmentation of fine-structure objects, such as reliable edge prediction and texture refinement.</p>\n<p>但在实现精细结构对象的准确分割方面，如可靠的边缘预测和纹理细化方面，仍然存在不足。</p>\n<p>To avoid the shortcomings of losing detailed information in max-pooling layers, the atrous convolution (Yu and Koltun, 2016), also called dilated convolution, has been explored to expand the receptive field and integrate uncontiguous elements with discontinuous convolution kernels.</p>\n<p>为避免最大池化层中丢失详细信息的缺陷，采用了极其复杂的卷积（Yu 和 Koltun，2016），也称为膨胀卷积，用于扩展感受场并积分具有不连续卷积核的非连续元素。</p>\n<p>DeepLabV1 (Chen et al., 2017a) and DeepLabV2 (Chen et al., 2017a) were among the most instructive image segmentation models designed to solve three crucial challenges in DCNN: the loss of detailed information in the down-sampling process, multi-scale objects in images, and fuzzy boundary predictions.</p>\n<p>DeepLabV1（Chen 等，2017a）和 <mark>DeepLabV2</mark>（Chen 等，2017a）是最具启发性的图像分割模型之一，旨在解决 DCNN 中的三个关键挑战：下采样过程中细节信息的丢失、图像中多尺度物体的出现以及模糊的边界预测。</p>\n<p>The latter introduced two essential improvements to the DCNN structure of semantic segmentation. One was to adopt the Atrous Spatial Pyramid Pooling (ASPP) that applied atrous convolution with the same kernel but different atrous sample rates to generate multi-scale feature maps in parallel.</p>\n<p>后者为 DCNN 语义分割结构引入了两项重要改进。<mark>其中一种是采用 Atrous 空间金字塔池化（ASPP），该方法在相同核但不同 atrous 采样率下应用 atrous 卷积，并行生成多尺度特征图。</mark></p>\n<p>Another was to refine of segmentation boundary with the probability graph model.</p>\n<p>另一个方法是用概率图模型细化分割边界。</p>\n<p>However, it failed to consider the balance between model complexity and prediction accuracy, resulting in inefficient processing efficiency for large-scale remote sensing images (Xia et al., 2021b). Subsequently, they revisited the structure of the previous semantic segmentation networks and proposed DeepLabV3 (Chen et al., 2017b) and DeepLabV3+ (Chen et al., 2018b).</p>\n<p>然而，它未能考虑模型复杂度与预测准确性之间的平衡，导致大规模遥感图像的处理效率低下（Xia 等，2021b）。随后，他们重新审视了之前语义分割网络的结构，提出了 DeepLabV3（Chen 等，2017b）和 DeepLabV3+（Chen 等，2018b）。</p>\n<p>DeepLabV3 applied the multigrid to create a deeper network and added a global pooling layer to ASPP to address the degradation of the atrous convolution when the atrous rate was excessive. DeepLabV3+ adopted the encoder structure of the DeepLabV3, combining shallow and deeper features by feature concatenation in the decoder network to refine the boundary details. Besides, DeeplabV3+ utilized pointwise-wise and depth-wise convolutions (Chollet, 2017) to design the encoder–decoder structure, which achieved a significant balance between semantic feature extraction and computation overhead.</p>\n<p><mark>DeepLabV3 应用多网格创建更深层的网络，并在 ASPP 中增加了全局池层</mark>，以解决当衰败率过高时卷积衰减的问题。DeepLabV3 + 采用了 DeepLabV3 的编码结构，<mark>将浅层和深层特征通过特征链连接在解码器网络中细化边界细节</mark>。此外，<mark>DeeplabV3+ 利用了点向和深度向的卷积设计编码器 - 解码器结构，实现了语义特征提取和计算开销之间的显著平衡。</mark></p>\n<p>The multi-scale feature map generated by the ASPP module can expand the receptive field of the convolution kernel without adding additional parameters, thereby capturing more spatial context information. In offshore aquaculture area monitoring tasks, the background water in the high-resolution UAV images can confuse the extraction of floating raft aquaculture areas due to excessive suspended impurities in the seawater.</p>\n<p>ASPP 模块生成的多尺度特征映射可以在不增加额外参数的情况下扩展卷积核的感受场，从而捕捉更多空间上下文信息。在近海水产养殖区监测任务中，高分辨率无人机图像中的背景水可能因海水中过多悬浮杂质而干扰浮筏养殖区的提取。</p>\n<p>However, Sui et al. (2020) proposed OAE-V3 based on DeepLabV3, which achieved smoother boundaries with less noise prediction compared with FCN, even in some floating raft areas without significant spectral information. In addition, multi-scale feature maps also contribute to segmenting semantic objects at different spatial scales. For instance, in UAV-based images, DeepLabV3 accurately segmented eelgrass from meadow-scale to small-scale patches less than one meter in size (Tallam et al., 2023). Further analysis of the segmentation results found that DeepLabV3 was able to identify thousands of smaller eelgrass patches that human annotators ignored.</p>\n<p>然而，Sui 等人（2020）提出了基于 DeepLabV3 的 OAE-V3，该方法在某些浮筏区域中也实现了更平滑的边界和更少的噪声预测，相较于 FCN，且没有显著的频谱信息。此外，多尺度特征图还有助于在不同空间尺度下对语义对象进行切段。例如，在基于无人机的图像中，DeepLabV3 能够准确地将鳗草从草地大小到小于一米的斑块进行细分（Tallam 等，2023）。对分割结果的进一步分析发现，DeepLabV3 能够识别出数千个人工注释者忽视的较小鳗草斑块。</p>\n<p>The application of DeepLabV3+ in semantic segmentation for UAV remote sensing is even more extensive.</p>\n<p>DeepLabV3 + 在无人机遥感语义分割中的应用更为广泛。</p>\n<p>For example, with different image resolutions, white balance settings, lighting conditions, and other defects in UAV-based images, the DeepLabV3+, adopted by Morales et al. (2018), still yielded 98.03% segmentation accuracy for the automatic segmentation of Mauritania flexuosa.</p>\n<p>例如，在无人机图像中存在不同的图像分辨率、白平衡设置、光照条件及其他缺陷时，Morales 等人（2018）采用的 DeepLabV3 + 在毛里塔尼亚柔性鸟的自动分割中仍能实现 98.03% 的分割准确率。</p>\n<p>In road extraction, Mahmud et al. (2021) considered that the heterogeneity of roads in terms of location, size, shape, and color complicates the implementation of semantic segmentation algorithms.</p>\n<p>在道路提取中，Mahmud 等人（2021）认为，道路在位置、大小、形状和颜色上的异质性使语义分割算法的实现变得复杂。</p>\n<p>But DeepLabV3+ with ResNet50 (He et al., 2016) as the feature backbone effectively reduces the negative impact of the complex noise background in UAV images on semantic segmentation.</p>\n<p>但 DeepLabV3 + 搭配 ResNet50（He 等，2016）作为特征骨干，有效减少了无人机图像中复杂噪声背景对语义分割的负面影响。</p>\n<p>The crack scale on the surface of steel structures in UAV images is relatively small, which presents insufficient detailed information.</p>\n<p>无人机图像中钢结构表面的裂纹尺度相对较小，这导致信息的详细信息不足。</p>\n<p>Han et al. (2022) utilized the pixel-level crack segmentation results of DeepLabV3+ as a secondary determination for crack detection.</p>\n<p>Han 等人（2022）利用 DeepLabV3 + 的像素级裂纹分割结果作为裂纹检测的二次判定。</p>\n<p>The authors claimed that UAVs about 5 m away from steel surfaces could identify cracks about 5 cm long and 0.5 cm width.</p>\n<p>作者声称，距离钢制表面约 5 米的无人机可以识别约 5 厘米长、0.5 厘米宽的裂缝。</p>\n<p>A system established by Njane et al. (2023) for automatically evaluating the phenotypic properties of potatoes adopted DeepLabV3+ to initially segment crop parameters from the bare soil in UAV images. Compared to segmentation methods based on thresholding, DeepLabV3+ could adapt to sunny conditions or crops completely covering the image. Moreover, the deep features generated by DeepLabV3+ can be used as effective feature representations of salient objects in UAV images. Specifically, Megir et al. (2021) employed a pre-trained DeepLabV3+ model as a salient object detector and clustered the deep features with K-means.</p>\n<p>Njane 等人（2023 年）建立的自动评估土豆表型特性的系统采用了 DeepLabV3+，最初在无人机图像中从裸土中切割作物参数。与基于阈值的分割方法相比，DeepLabV3 + 能够适应阳光条件或完全覆盖图像的作物。此外，DeepLabV3 + 生成的深度特征还可作为无人机图像中显著物体的有效特征表示。具体来说，Megir 等人（2021）采用预训练的 DeepLabV3+ 模型作为显著物体探测器，并将深层特征与 K 均值聚类。</p>\n<p>It had been demonstrated effective even though the semantic class of the object of interest is unknown and no additional training is performed. However, it should be noted that DeepLabV3+, constructed based on a complex model structure with more parameters, is more difficult to train when there are fewer semantic labels and limited training data, which ultimately results in a significant deviation in test accuracy after training (Jeon et al., 2021).</p>\n<p>尽管目标对象的语义类别未知且未进行额外培训，但该方法已被证明有效。然而，需要注意的是，基于复杂模型结构和更多参数构建的 DeepLabV3+，当语义标签减少且训练数据有限时，训练难度更高，最终导致训练后测试准确性显著偏差（Jeon 等，2021）。</p>\n<h4 id=\"unet\"><a class=\"markdownIt-Anchor\" href=\"#unet\">#</a> UNet</h4>\n<p>UNet (Ronneberger et al., 2015) is another feature-engineered encoder–decoder architecture with more multi-scale feature extraction and fusion operations. It was originally designed to solve the problem of biomedicine image segmentation with small image samples. As illustrated in Fig. 3(a), the feature backbone of UNet labeled by the dashed box was called the contracting path, which consisted of four feature blocks and the last max-pooling layer. The contracting path compressed the feature resolution and increased the feature channels. The part on the right side of the dashed box was called the expansive path, which also contained four feature blocks that up-sampled the feature map of the previous layer to twice its scale by deconvolution and fused it with the feature output of the contracting path on the left side.</p>\n<p>UNet（Ronneberger 等，2015）是另一种特征工程编码 - 解码器架构，具有更多多尺度的特征提取和融合作。它最初设计用于解决生物医学图像分割中小样本图像的问题。如图 3（a）所示，UNet 中虚线框标记的特征骨干称为收缩路径，由四个特征块和最后一个最大池层组成。收缩路径压缩了特征分辨率并增加了特征通道。虚线框右侧的部分称为扩展路径，包含四个特征块，通过反卷积将上一层的特征映射放大到其尺度的两倍，并与左侧收缩路径的特征输出融合。</p>\n<p>By leveraging a contracting path to gather contextual information and a symmetric expansion path for precise positioning, UNet efficiently integrates multi-scale features across various layers from shallow to deep, facilitating accurate semantic segmentation of finestructure objects in UAV remote sensing images. Kattenborn et al. (2019) tested the fine-grained mapping of vegetation species and communities obtained from high-resolution RGB UAV image datasets based on UNet.</p>\n<p>通过利用收缩路径收集上下文信息和对称扩展路径实现精确定位，UNet 高效整合了从浅层到深层的多尺度特征，促进无人机遥感图像中精细结构对象的准确语义分割。Kattenborn 等人（2019）测试了基于 UNet 的高分辨率 RGB 无人机图像数据集中对植被物种和群落的细粒度映射。</p>\n<p>As the resolution increased, they found that fine-structured spatial patterns, such as leaf shapes and branching patterns, played a  more important role than overall reflective features. Zhao et al. (2019) equipped the UAV with a high-resolution RGB and multispectral camera and established a dataset of lodging and un-lodging rice image samples. The dice coefficients of UNet with different modal inputs indicated that UNet provides the ability to extract spatial features and patterns of rice lodging directly from high-resolution UAV images. Both demonstrated the superiority of UNet in integrating fine-grained spatial features of optical images and aggregating semantic representations of multimodal data. To make the network more trainable, Zhang et al. (2019b) proposed Deep Res-UNet combined with the residual module of ResNet (He et al., 2016) for infrared image segmentation of photovoltaic panels. And (Zhang et al., 2021a) modified UNet by embedding an irregular encoder–decoder module and content-aware channel re-weight module to address the drawback of irregular and fuzzy boundaries in wheat yellow rust disease detection. However, the classic UNet consumes a large amount of computational and memory resources due to the complex encoder–decoder framework.</p>\n<p>随着分辨率的提升，他们发现细结构的空间图案，如叶片形状和分支图案，比整体反射特征更为重要。赵等人（2019）为无人机配备了高分辨率 RGB 和多光谱相机，建立了稻米沉积和脱落水稻图像样本数据集。UNet 在不同模态输入下的骰子系数表明，UNet 能够直接从高分辨率无人机图像中提取稻米着伏的空间特征和模式。两者都展示了 UNet 在整合光学图像细粒度空间特征和聚合多模态数据语义表示方面的优越性。为了使网络更易训练，Zhang 等人（2019b）提出了将 Deep Res-UNet 与 ResNet 残差模块结合（He 等，2016）用于光伏面板的红外图像分割。此外（Zhang 等，2021a）通过嵌入不规则编码 - 解码器模块和内容感知通道重权模块，对 UNet 进行了修改，以解决小麦黄锈病检测中不规则和模糊边界的不足。然而，经典的 UNet 由于复杂的编码器 - 解码器框架，会消耗大量的计算和内存资源。</p>\n<p>To meet the demand for real-time image processing on embedding UAV platforms, Shi et al. (2022) used EfficientNet-B4 (Tan and Le, 2019), an efficient network with balanced model width and depth, as the feature backbone to speed up model convergence. Lan et al. (2021) explored MobileNetV2 (Sandler et al., 2018) as the backbone network to reduce parameters and computations of UNet and achieved a frame rate of 45.05 on the embedded platform with 16-bit floating-point weights. He et al. (2023) considered that it was necessary to combine the light-weight UNet with sub-modules, designed for local feature refinement and global receptive field enhancement, to avoid intermittent segmentation or mis-segmentation of transmission lines in UAV images with complex backgrounds. Gao et al. (2023) embedded Depth Separable Residue Block (DR-Block) and Atrous Spatial Pyramid Fusion Attention Module (ASAM) in UNet, which could adapt to the irregular topological shapes of tiny cracks, reduce the considerable interference in complex backgrounds, and ensure the integrity of fracture features in the feature extraction process. Such advanced practices illustrate that UNet provides a reliable baseline for semantic segmentation of UAV remote sensing images, as researchers can either add or modify the original network structure according to the diverse semantic representations of specific scenes to achieve higher semantic segmentation accuracy.</p>\n<p>为满足嵌入式无人机平台对实时图像处理的需求，Shi 等人（2022）采用 EfficientNet-B4（Tan 和 Le，2019），这是一种高效且模型宽度和深度平衡的网络，作为加速模型融合的特征骨干。Lan 等人（2021）探索了 MobileNetV2（Sandler 等，2018）作为减少 UNet 参数和计算的骨干网络，在嵌入式平台上以 16 位浮点权重实现了 45.05 帧率。他等人（2023）认为，为了避免复杂背景的无人机图像中传输线间歇性分割或误分，有必要将轻量级 UNet 与设计用于局部特征细化和全局感受场增强的子模块结合。Gao 等（2023）在 UNet 中嵌入了深度可分离残留块（DR-Block）和 Atrous 空间金字塔融合注意模块（ASAM），能够适应微小裂纹的不规则拓扑形状，减少复杂背景中的显著干扰，并确保特征提取过程中断裂特征的完整性。这些先进实践表明 UNet 为无人机遥感图像的语义分割提供了可靠的基线，研究人员可以根据特定场景的多样语义表示添加或修改原始网络结构，以实现更高的语义分割精度。</p>\n<p>UNet++ (Zhou et al., 2018), a variant of UNet, aimed to bridge the semantic gap via nested dense skip connections of feature maps in encoder–decoder networks. As shown in Fig. 3(b), the number of features to be fused at each node of the expansive path in UNet++ depended on the corresponding pyramid level. Nested dense connections also allowed the expansive path to integrate semantic information close to the contracting path. The dense connections among feature maps in each layer of UNet++ provide a significant advantage for processing spatial details of high-resolution UAV images on a large spatial scale. Tran et al. (2020) combined UNet and UNet++ and proposed a two-stage semantic network for damaged area estimation after a forest fire. Specifically, UNet++ was the first stage to process spatial detail information in large-scale UAV image patches, while UNet was the second stage for refining the segmentation results with the output of the first stage in small-scale patches. To streamline the wetland mapping of UAV images, Hu et al. (2021a) proposed Auto-UNet++ incorporated with multi-views, unsupervised clustering, multi-scale CNN, and attention mechanism.</p>\n<p>UNet++（周等，2018）是 UNet 的一个变体，旨在通过编码器 - 解码器网络中特征图的嵌套稠密跳跃连接来弥合语义差距。如图 3（b）所示，UNet<ins> 中扩展路径每个节点需要融合的特征数量取决于对应的金字塔层级。嵌套稠密连接还允许扩展路径整合接近收缩路径的语义信息。UNet</ins> 每层特征图之间的密集连接为处理高分辨率无人机图像的空间细节在大尺度上提供了显著优势。Tran 等人（2020）结合了 UNet 和 UNet++，提出了一个用于森林火灾后受损区域估计的两阶段语义网络。具体来说，UNet<ins> 是处理大尺度无人机图像片段空间细节信息的第一阶段，而 UNet 则是第二阶段，用于细化小尺度片段中第一阶段输出的分割结果。为了简化无人机图像的湿地映射，胡等人（2021a）提出了整合多视图、无监督聚类、多尺度卷积神经网络和注意力机制的 Auto-UNet</ins>。</p>\n<img data-src=\"../../images/paper/semantic_segmentation/2.png\" alt=\"1\"  />\n<p>Fig. 3. Graphical visualization of the network structure of UNet (a) and UNet++ (b). Both UNet and UNet++ start with an encoder of feature backbone followed by a decoder network. The main difference between these two networks is that UNet++ has nested dense skip connections at the same feature resolution to bridge the semantic gap between the encoder and decoder, while the UNet is composed of plain skip connections.</p>\n<p>图 3。UNet （a） 和 UNet++ （b） 网络结构的图形可视化。UNet 和 UNet++ 都以特征骨干编码器开始，随后是解码器网络。这两个网络的主要区别在于，UNet++ 采用嵌套的密集跳跃连接，且具有相同特征分辨率，以弥合编码器和解码器之间的语义差距，而 UNet 则由纯跳跃连接组成。</p>\n<p>Despite computational limitations and longer deployment cycles, sufficient experiments prove its efficiency and practicality. Cao et al. (2023) attempted to address the suboptimal segmentation for irregular cracks caused by the lack of special treatment of deep feature maps in the UNet++ by integrating a deep parallel feature fusion module, which captured higher-level semantic information and enhanced the network sensitivity to the features of road cracks. Experiments showed that the proposed model effectively eliminated the interference of complex backgrounds in high-resolution images and improved the network’s ability to identify irregular cracks.</p>\n<p><mark>尽管计算能力有限且部署周期较长，但足够的实验证明了其效率和实用性。Cao 等人（2023）试图通过集成深度并行特征融合模块，解决 UNet++ 中因缺乏对深度特征图特殊处理而导致不规则裂缝分割的不优问题，该模块捕捉了更高层次的语义信息，并增强了对道路裂缝特征的网络敏感性。实验表明，所提出的模型有效消除了高分辨率图像中复杂背景的干扰，并提升了网络识别不规则裂纹的能力。</mark></p>\n<p>The paradigm of improving and fine-tuning the models for specific scenarios in UAV remote sensing seems to become an effective solution for enhancing the ability of CNNs to extract contextual information. Nevertheless, it is worth noting that during the model inference process, UNet++ needs to consume more memory and computational resources to store the feature maps for dense connections, leading to a slower inference speed in semantic segmentation for large-scale high-resolution UAV images (Cao et al., 2023; Xiao et al., 2023b).</p>\n<p><mark>在无人机遥感中，为特定场景改进和微调模型的范式似乎成为提高卷积神经网络（CNN）提取上下文信息能力的有效解决方案。然而，值得注意的是，在模型推理过程中，UNet 需要消耗更多的内存和计算资源来存储用于密集连接的特征图，从而导致在大规模高分辨率无人机图像的语义分割中推理速度较慢（Cao 等，2023；Xiao 等，2023b）。</mark></p>\n<h4 id=\"high-resolution-network\"><a class=\"markdownIt-Anchor\" href=\"#high-resolution-network\">#</a> High-resolution network</h4>\n<p>高分辨率网络</p>\n<p>High-resolution representation learning plays a crucial role in UAV semantic segmentation due to the ultra-high resolution and varying object scale of UAV remote sensing imagery. There are two approaches to computing high-resolution representation.</p>\n<p>由于无人机遥感图像具有超高分辨率和多变物体尺度，高分辨率表示学习在无人机语义分割中起着关键作用。计算高分辨率表示<mark>有两种方法</mark>。</p>\n<p>One is to up-sample and recover the low-resolution feature maps of CNNs to high-resolution representations. Another one is to maintain the high-resolution information by convolution operations and strengthen semantic context by integrating parallel multi-scale low-resolution feature maps (Zhou et al., 2015; Saxena and Verbeek, 2016; Fourure et al., 2017; Sun et al., 2019). Since high-resolution representation relies on the latent semantic information of multi-scale feature maps, Wang et al. (2020c) designed a high-resolution network (HRNet) that repeatedly exchanges semantic information across adjacent multi-resolution subnetworks. As shown in Fig. 4, vertically, HRNet starts from the first high-resolution feature stream and adds high-to-low resolution subnetworks step by step to form a new multi-resolution stage. To enhance the high-resolution representation and position sensitivity, it connected high-resolution and low-resolution features in parallel and exchanged the semantic information across adjacent multi-resolution sub-networks.</p>\n<p><mark>一种是对卷积网络的低分辨率特征映射进行上采样，并恢复为高分辨率表示。<mark>另一种是</mark>通过卷积作保持高分辨率信息，并通过集成并行多尺度低分辨率特征图来强化语义上下文</mark>（周等，2015;Saxena 和 Verbeek，2016;Fourure 等，2017;Sun 等，2019）。由于高分辨率表示依赖于多尺度特征图的潜在语义信息，Wang 等人（2020c）设计了一个高分辨率网络（HRNet），能够反复在相邻多分辨率子网络间交换语义信息。如图 4 所示，垂直方向，HRNet 从第一个高分辨率特征流开始，逐步添加高分辨率到低分辨率子网络，形成新的多分辨率阶段。为了增强高分辨率表示和位置灵敏度，它并行连接了高分辨率和低分辨率特征，并在相邻的多分辨率子网络之间交换语义信息。</p>\n<img data-src=\"../../images/paper/semantic_segmentation/3.png\" alt=\"1\"  />\n<p>Fig. 4. Illustration of the structure of HRNet that consists of four high-to-low resolution sub-networks. In the vertical direction, HRNet repeatedly exchanges semantic information across adjacent multi-resolution sub-networks with up-sampling, down-sampling, and convolutional units.</p>\n<p>图 4。HRNet 结构示意，由四个高分辨率到低分辨率子网络组成。在纵向方向上，HRNet 通过上采样、下采样和卷积单元反复在相邻的多分辨率子网络间交换语义信息。</p>\n<p>Extracting and preserving semantic features of detailed textures and boundaries from high-resolution images presents one of the major challenges in designing semantic parsing methods applicable to highresolution remote sensing images, as the down-sampling operation during feature extraction process compresses spatially detailed features. However, high-resolution representation learning based on HRNet provides an intuitively feasible solution. It has been demonstrated in recent advances in semantic segmentation (Xu et al., 2020b; Zhang et al., 2020b; Huang et al., 2021a; Tian et al., 2022) for remote sensing images. For instance, since both semantic class imbalance and uncertain boundary information exist in remote sensing images, Xu et al. (2020b) further incorporated three vital factors, including spatial representation, contextual information, and boundary details, when applying HRNet to the semantic segmentation of high-resolution remote sensing images. In UAV remote sensing, Huang et al. (2021a) tested the performance of the object contextual representations network  (OCRNet) based on a backbone of HRNet for recognizing zucchinis intercropped with sunflowers in UAV images. Both studies demonstrated that the reasonable use of parallel features with different weights could improve the accuracy of semantic segmentation. Moreover, by extending the spatial resolution gradient and broadening the spectral band dimensions, Liu et al. (2021b) utilized multi-source data composed of satellite and UAV remote sensing images to analyze the classification capabilities of DeepLabV3+ and HRNet for marsh vegetation. Xie et al. (2021b) built a branch for land cover classification with HRNet and introduced a self-supervised generative adversarial network (GAN) to recover low-resolution images acquired by UAV sensors into corresponding high-resolution images.</p>\n<p>从高分辨率图像中提取和保留详细纹理和边界的语义特征，是设计适用于高分辨率遥感图像的语义解析方法的主要挑战之一，== 因为特征提取过程中的下采样作会压缩空间细节特征。== 然而，== 基于 HRNet 的高分辨率表示学习提供了一个直观可行的解决方案。== 这一技术已在语义分割的最新进展中得到验证（Xu 等，2020b;Zhang 等，2020b;Huang 等，2021a;Tian 等，2022）用于遥感图像。例如，由于遥感图像中既存在语义类别失衡，也存在边界信息不确定，Xu 等人（2020b）在将 HRNet 应用于高分辨率遥感图像的语义分割时，进一步纳入了空间表现、上下文信息和边界细节三个关键因素。在无人机遥感领域，Huang 等人（2021a）基于 HRNet 骨干测试了对象上下文表示网络（OCRNet）在识别无人机图像中与向日葵交错的西葫芦的性能。两项研究都表明，合理使用不同权重的平行特征可以提高语义分割的准确性。此外，通过扩展空间分辨率梯度和拓宽光谱带维度，刘等人（2021b）利用卫星和无人机遥感图像组成的多源数据，分析了 DeepLabV3 + 和 HRNet 对沼泽植被的分类能力。谢等人（2021b）利用 HRNet 建立了土地覆盖分类分支，并引入了自监督生成对抗网络（GAN），将无人机传感器采集的低分辨率图像恢复为相应的高分辨率图像。</p>\n<p>The accuracy gains in land cover classification suggested that the generated high-resolution images compensated for the loss of information due to the feature down-sampling process of HRNet, as well as contributed to the finegrained feature extraction of edges and texture details. Ye et al. (2022) considered that the background of the post-earthquake bridge damage images collected by UAVs was cluttered, and the damage features of several components were inconspicuous. Accordingly, they constructed a multi-task HRNet for recognizing the components and damage of post-earthquake bridges by combining the loss functions of multiple single-task HRNet models. Despite such advanced practices, the native HRNet contains a large number of parameters, making it laborious to deploy in UAV devices to perform online image analysis. Hence, Huang et al. (2021b) had modified HRNet into a sparse multi-scale structure to reduce the network parameters so that it could be flexibly deployed on UAVs for multiple objects tracking.</p>\n<p>土地覆盖分类的准确性提升表明，生成的高分辨率图像弥补了 HRNet 特征下采样过程导致的信息丢失，并有助于边缘和纹理细节的细粒度特征提取。Ye 等人（2022）认为，无人机收集的地震后桥梁损伤图像背景杂乱，多个部件的损伤特征不明显。因此，他们构建了一个多任务 HRNet，通过结合多个单任务 HRNet 模型的损耗函数，识别地震后桥梁的组成部分和损坏情况。尽管采用了如此先进的技术，HRNet 本身包含大量参数，使得在无人机设备中部署进行在线图像分析变得繁琐。因此，Huang 等人（2021b）将 HRNet 改进为稀疏的多尺度结构，以降低网络参数，使其能够灵活部署在无人机上进行多目标跟踪。</p>\n<h4 id=\"other-relevant-networks\"><a class=\"markdownIt-Anchor\" href=\"#other-relevant-networks\">#</a> Other relevant networks</h4>\n<p>The open-source frameworks (Abadi et al., 2016; Paszke et al., 2019) and detailed technical and coding support for DL developers allow researchers to build deeper and more complex topologies by skipping connections between latent feature layers. Hence, featurelearning models that employ multi-scale and feature fusion strategies to deal with context knowledge integration are not limited to the DeepLab series, HRNet, UNet, and their variants.</p>\n<p>开源框架（Abadi 等，2016;Paszke 等，2019）以及为 DL 开发者提供的详细技术和编码支持，使研究人员能够通过跳过潜在特征层之间的连接来构建更深层、更复杂的拓扑。因此，采用多尺度和特征融合策略处理上下文知识集成的特征学习模型，并不限于 DeepLab 系列、HRNet、UNet 及其变体。</p>\n<p>In CNNs, each output pixel corresponds to a fixed perceptual field. The high accuracy semantic segmentation requires the integration of multi-scale contexts to handle complicated spatial patterns. PSPNet (Zhao et al., 2017) is a representative method of multi-scale feature fusion, which proposes a pyramid pooling module based on the global prior representation that aggregates contextual information from different regions. However, the plain and simple feature aggregation in PSPNet is struggling to handle the fine-grained features of highresolution UAV images compared to networks with more efficient feature aggregation topology, such as DeepLabV3+ and UNet (Sudarshan Rao et al., 2020; Hota et al., 2020). A recent work (Zhong et al., 2022) proposed a W-shape multi-scale feature fusion network for distress segmentation via UAVs, which adopted skip connections between the encoder–decoder structure to integrate low-level features and high-level semantic features. Inspired by BiSeNet, Zhang et al. (2021b) proposed dual branch-based ICENETv2 for fine-grained river ice segmentation, which integrated low-resolution semantic features from the deep branch and high-resolution finer features from the shallow branch. Lyu et al. (2020) proposed the multi-scale-dilation network, which created three model streams with different spatial scales through space-to-batch operation and batch-to-space operation. After that, they utilized skip connections to concatenate different scale features within each stream to complement the multi-scale semantic information. However, feature space optimization (FSO), a post-processing technique, was required to refine the final results.</p>\n<p>在卷积神经网络中，每个输出像素对应一个固定的感知场。高精度语义分割需要整合多尺度上下文以处理复杂的空间模式。PSPNet（Zhao 等，2017）是一种多尺度特征融合的代表性方法，提出了基于全局先验表示的金字塔池模块，汇总来自不同区域的上下文信息。然而，PSPNet 中简单的特征聚合在处理高分辨率无人机图像的细粒度特征时，与具有更高效特征聚合拓扑的网络（如 DeepLabV3 + 和 UNet）相比，仍然难以应对（Sudarshan Rao 等，2020;Hota 等，2020）。一项最新工作（Zhong 等，2022）提出了一种 W 形多尺度特征融合网络，用于无人机的遇险分割，采用编码器 - 解码器结构之间的跳跃连接，整合低层特征和高层语义特征。受 BiSeNet 启发，Zhang 等人（2021b）提出了基于双分支的 ICENETv2，用于细粒度河流冰段分割，整合了深支的低分辨率语义特征和浅支的高分辨率细致特征。Lyu 等人（2020）提出了多尺度膨胀网络，通过空间到批次和批对空间作创建了三种不同空间尺度的模型流。之后，他们利用跳跃连接在每个流中串接不同的尺度特征，以补充多尺度语义信息。然而，需要特征空间优化（FSO）作为一种后处理技术来完善最终结果。</p>\n<p>Most published works on multi-scale and feature fusion strategies devoted to connecting features across layers or branches. However, the multi-scale feature fusion of UAV images inevitably lead to feature redundancy. To achieve efficient multi-scale feature representation and reduce feature redundancy, He et al. (2022a) proposed a multi-scale aware-relation network (MANet) that utilized inter-class and intra-class region refinement to reduce redundancy caused by feature fusion. Then they adopted multi-scale collaborative learning to explore the relationship between different scales and to enhance the diversity of multi-scale feature representations. In addition, some recent studies (Zhang et al., 2020b, 2021b; Anand et al., 2021) had focused on combining attention mechanism to measure the importance of feature maps at different scales for adaptively aggregating multi-scale feature representations.</p>\n<p>大多数关于多尺度特征融合策略的已发表作品都致力于连接各层或各分支的特征。然而，无人机图像的多尺度特征融合不可避免地会导致特征冗余。为了实现高效的多尺度特征表示并减少特征冗余，He 等人（2022a）提出了一种多尺度感知关系网络（MANet），该网络利用类间和类内区域细化来减少特征融合引起的冗余。然后，他们采用多尺度协同学习来探索不同尺度之间的关系，并增强多尺度特征表示的多样性。此外，一些近期研究（Zhang 等人，2020b，2021b；Anand 等人，2021）专注于结合注意力机制来衡量不同尺度下特征图的重要性，以自适应地聚合多尺度特征表示。</p>\n<p>Table 2 compiled literature on multi-scale and feature fusion methods for UAV image semantic segmentation. Despite multi-scale features providing more fine-grained contextual semantic information of UAV images, inappropriate multi-scale model designs and feature fusion strategies increased the model complexity and result in feature redundancy. Several recent models incorporated relationship modeling techniques, such as attention models, to enhance the representation of multi-scale features. Nevertheless, the deployment and optimization of the model inference require massive memory allocation and intensive computation, which poses additional challenges in balancing the computational overhead and efficient multi-scale feature aggregation.</p>\n<p>表 2 汇总了关于无人机图像语义分割的多尺度与特征融合方法的文献。尽管多尺度特征为无人机图像提供了更为精细的上下文语义信息，但不恰当的多尺度模型设计和特征融合策略却增加了模型的复杂性，并导致了特征冗余。近期的一些模型采用了关系建模技术，如注意力模型，以增强多尺度特征的表示能力。然而，模型推理的部署和优化需要大量的内存分配和密集计算，这为平衡计算开销与高效的多尺度特征聚合带来了额外的挑战。</p>\n<table>\n<thead>\n<tr>\n<th>模型</th>\n<th>特点</th>\n<th>性能与优势</th>\n<th>局限性</th>\n<th>文献</th>\n<th>图像模态与分辨率</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>DeepLabV3</strong></td>\n<td>采用多网格（multi-grid）和空洞卷积（atrous convolution）以生成更大的感受野；<br />引入全局上下文特征以缓解空洞卷积带来的性能退化问题。</td>\n<td>・每个像素对应更大的感受野<br />・能够在多尺度上进行语义分割</td>\n<td>・在大规模和高分辨率图像上应用时耗时较长</td>\n<td>Sui et al. <br />(2020)Wang et al. (2022d)<br />Tallam et al. (2023)</td>\n<td>RGB, 1.2 m<br />RGB, Thermal<br />RGB</td>\n</tr>\n<tr>\n<td><strong>DeepLabV3+</strong></td>\n<td>采用编码器–解码器结构与空洞可分离卷积；<br />以 Xception 作为高效特征骨干网络。</td>\n<td>・高效的编码–解码网络，能够捕获细粒度目标<br />・在特征提取能力与计算开销之间取得良好平衡</td>\n<td>・在语义标注较少、训练数据有限的情况下，相比参数更少的简单结构更难训练</td>\n<td>Morales et al. (2018)<br />Barmpoutis et al. (2020)<br />Megir et al. (2021)<br />Gibril et al. (2021)<br />Fu et al. (2021b)<br />Jeon et al. (2021)<br />Han et al. (2022)<br />Njane et al. (2023)</td>\n<td>RGB, 1.4–2.5 cm<br />RGB<br />RGB<br />RGB<br />RGB, DEM, 30 m<br />RGB, 4.5–7 cm<br />RGB<br />RGB, Red-edge, NIR</td>\n</tr>\n<tr>\n<td><strong>UNet</strong></td>\n<td>对称的 U 形全卷积网络结构；通过收缩路径与扩展路径进行多尺度特征提取与融合。</td>\n<td>・编码器与解码器之间的对称跳跃连接有助于细节特征表示<br />・为 UAV 遥感图像语义分割提供了可靠基线，且结构易于根据具体场景进行扩展和修改</td>\n<td>・编码器与解码器子网络中，不同分辨率特征图之间存在语义鸿沟</td>\n<td>Zhang et al. (2019b)<br />Zhao et al. (2019)<br />Kattenborn et al. (2019)<br />Zhang et al. (2021a)<br />Tan et al. (2021)<br />Shi et al. (2022)<br />Yi et al. (2022a)<br />Gao et al. (2023)<br />He et al. (2023)<br />Wang et al. (2023b)<br />Xiao et al. (2023b)</td>\n<td>IR<br />RGB, NIR, 2.2 cm<br />RGB, 3–5 cm<br />RGB, Red-edge, NIR, 1.2 cm<br />RGB, 0.6 cm<br />RGB, 25 cm<br />RGB<br />RGB<br />RGB<br />RGB<br />RGB</td>\n</tr>\n<tr>\n<td><strong>UNet++</strong></td>\n<td>在相同特征分辨率下，引入编码器与解码器之间的密集跳跃连接以进行特征拼接。</td>\n<td>・多语义表征的灵活特征融合<br />・多空间尺度特征融合提升了分割精度</td>\n<td>・在大规模和高分辨率图像上应用时耗时较长</td>\n<td>Tran et al. (2020)<br />Hu et al. (2021a)<br />Cao et al. (2023)</td>\n<td>RGB<br />RGB, 2.902 cm,<br /> Thermal: 15 cm, <br />Red-edge &amp; NIR: 8.106 cm<br />RGB</td>\n</tr>\n<tr>\n<td><strong>HRNet</strong></td>\n<td>通过跨分辨率特征集成与语义信息交换，保持高分辨率特征表示。</td>\n<td>・更丰富、更精确的空间语义表征<br />・更强的由高到低分辨率表征能力</td>\n<td>・复杂的模型结构需要更多内存分配和计算开销</td>\n<td>Huang et al. (2021a)<br />Xie et al. (2021b)<br />Ye et al. (2022)</td>\n<td>RGB, 7.5 cm<br />RGB, 15 cm<br />RGB</td>\n</tr>\n<tr>\n<td><strong>PSPNet</strong></td>\n<td>使用金字塔池化模块聚合来自不同区域的多尺度上下文信息。</td>\n<td>・局部与全局语义融合保证了分割结果的整体一致性</td>\n<td>・细粒度预测效果不理想<br />・目标边界模糊</td>\n<td>Sudarshan Rao et al. (2020)Hota et al. (2020)</td>\n<td>RGB, Thermal, Red-edge, <br />NIR<br />RGB, Thermal, Red-edge, <br />NIR</td>\n</tr>\n<tr>\n<td><strong>MSDNet</strong></td>\n<td>三个结构相同的模型分支，融合多尺度特征图以增强高分辨率预测能力。</td>\n<td>・像素、图像–标签对及特征图严格对齐<br />・对尺度变化较大的目标提供一致预测</td>\n<td>・需要后处理以平滑最终预测结果<br />・非端到端方法</td>\n<td>Lyu et al. (2020)</td>\n<td>RGB</td>\n</tr>\n<tr>\n<td><strong>ICENetV2</strong></td>\n<td>深层分支提取高层语义上下文，浅层分支保持精细空间细节。</td>\n<td>・双分支的多尺度特征融合可处理更细粒度特征并获得更高精度</td>\n<td>—</td>\n<td>Zhang et al. (2021b)</td>\n<td>RGB</td>\n</tr>\n<tr>\n<td><strong>MANet</strong></td>\n<td>通过类间与类内区域细化及多尺度协同学习，构建多尺度感知关系网络。</td>\n<td>・判别性强且多样化的多尺度表征<br />・减少特征融合冗余信息，提升特征表示效率</td>\n<td>—</td>\n<td>He et al. (2022a)</td>\n<td>RGB</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>HRNet 在无人机图像语义分割方面展现了最强的整体能力。通过在整个网络中保持高分辨率表示，并在多个尺度上反复交换信息，HRNet 实现了更丰富、更精确的空间语义表示。尽管计算成本高昂，但其设计特别适合高分辨率无人机图像。性能上限高，但工程成本大。</p>\n</blockquote>\n<h3 id=\"relationship-modeling-methods\"><a class=\"markdownIt-Anchor\" href=\"#relationship-modeling-methods\">#</a> Relationship modeling methods</h3>\n<p>关系建模方法</p>\n<p>Weight-sharing multi-channel convolution kernels, the primary feature extraction unit of DCNNs for semantic segmentation of UAV images, enjoy remarkable spatial-agnostic and channel-specific properties (Li et al., 2021a). Spatial-agnostic property means that the convolution kernel produces similar responses to similar patterns in local space, while channel-specific property implies that the extracted feature maps may have redundancy along the feature channel dimension. Besides, the increasing resolution of UAV remote sensing images generates data redundancy that may seriously interfere with the feature-extracting and decision-making process (Xu et al., 2020b). Hence, establishing the global relationship between pixels or object regions in UAV remote sensing imagery is critical for removing data redundancy and capturing more meaningful context information. As of recently, many advanced studies for mining effective semantic representation in images based on DCNNs have focused on establishing global relationships along spatial and channel dimensions of feature maps (Hu et al., 2018; Woo et al., 2018; Fu et al., 2019; Wang et al., 2020e). According to the motivation and module structure for establishing the global contextual information, we have categorized the relationship modeling methods into non-local mappings, self-attention mechanism and hierarchical attention mechanism.</p>\n<p>权重共享的多通道卷积核是深度卷积神经网络（DCNNs）用于无人机图像语义分割的主要特征提取单元，具有显著的空间无关性和通道特异性属性（Li 等，2021a）。空间无关性意味着卷积核对局部空间中的相似模式产生相似的响应，而通道特异性则意味着提取的特征图在特征通道维度上可能存在冗余。此外，无人机遥感图像分辨率的提高产生了数据冗余，可能会严重干扰特征提取和决策过程（Xu 等，2020b）。因此，在无人机遥感图像中建立像素或目标区域之间的全局关系对于去除数据冗余和捕捉更有意义的上下文信息至关重要。近期，许多基于 DCNNs 挖掘图像中有效语义表示的先进研究都集中在沿着特征图的空间和通道维度建立全局关系上（Hu 等，2018；Woo 等，2018；Fu 等，2019；Wang 等，2020e）。根据建立全局上下文信息的动机和模块结构，我们将关系建模方法分为非局部映射、自注意力机制和分层注意力机制。</p>\n<h4 id=\"non-local-mappings\"><a class=\"markdownIt-Anchor\" href=\"#non-local-mappings\">#</a> Non-local mappings</h4>\n<p>非局部映射</p>\n<p>Non-local mappings can be viewed as a contextual relationship modeling approach that adaptively recalibrates the feature response to emphasize meaningful information by explicitly establishing the spatial and channel relationships of features captured within each local receptive field, which is defined as the region size in the input image that produces the feature pixel in the feature map (Araujo et al., 2019).  Although the receptive field of the feature maps of convolutional networks with sufficient layer depth is able to cover the entire image, the local receptive field of shallow layers can only establish short-range dependencies of pixels within a limited region in images (Ramachandran et al., 2019; Khan et al., 2022). Non-local mappings not only permit the model to exploit a broader range of spatial context information but also empower accurate prediction of texture details and boundaries of high-resolution images.</p>\n<p>非局部映射可视为一种情境关系建模方法，通过显式建立每个局部感受场内捕获特征的空间和通道关系，以自适应重新校准特征响应，强调有意义的信息，该区域定义为输入图像中产生特征像素的区域大小（Araujo 等， 2019 年）。尽管卷积网络具有足够层深的特征图的感受野能够覆盖整个图像，但浅层的局部接收野只能在图像中有限区域内建立像素的短距离依赖关系（Ramachandran 等，2019;Khan 等，2022）。非本地映射不仅使模型能够利用更广泛的空间上下文信息，还能够准确预测高分辨率图像的纹理细节和边界。</p>\n<p>A representative method of non-local mappings is the Convolutional Block Attention Module (CBAM) proposed by Woo et al. (2018), which focuses on extracting essential features and suppressing unnecessary ones. It consists of the Channel Attention Module (CAM) and Spatial Attention Module (SAM). Specifically, CAM used max-pooling and average-pooling operations along the spatial dimension to obtain the most significant and global channel context information, respectively. SAM recalibrated the feature maps along the channel axis with max-pooling and average-pooling operations to highlight informative regions. For image semantic segmentation of UAV remote sensing, CBAM is typically applied to enhance the models’ ability to concentrate on spatial details and restore disconnected boundaries and cluttered false-positive predictions. For instance, Bo et al. (2022) integrated the CBAM into the burned area detection network to identify the most distinctive objects in UAV images and capture the spatial location and edge information for refining the final salient region map. Hong et al. (2021) believed that road cracks in UAV remote sensing images were very narrow since the cracks were composed of only a few pixels. Therefore, they added CBAM before the last convolutional layer of UNet to focus on the crack area, improving the segmentation accuracy of crack edge details and the connecting parts of the cracks. Bisio et al. (2023) also argued that CBAM help extract global information about road traffic density, flow patterns, and road capacity from UAV images for efficient traffic analysis. Furthermore, CBAM can be flexibly placed in convolutional networks at a negligible cost of model modification. Wang et al. (2022d) believed that the dam-surface vegetation in thermal images with low resolution and low signal-to-noise ratio was similar to dam-surface seepage, which caused the networks to generate fuzzy boundaries of the seepage area. Adding CBAM to the skip connections of the network enhanced the semantic and spatial information recognition ability for accurate seepage profiles with clear boundaries and less false-alarm rate caused by ‘‘seepage-like’’ interference on the thermograms. Chen et al. (2023) believed small forest flame regions in high-resolution UAV images led to class imbalance issues between foreground and background. They added CBAM to the decoder of the segmentation network to extract details from the low-level semantic features, allowing the model to focus more on the flame regions and achieve a 5.43% improvement in the Intersection over Union (IoU) metric. Yan et al. (2023) embedded CBAM into the feature extraction layer of the convolutional network to suppress unnecessary feature extraction. Experimental results confirmed that CBAM promoted the model to have detailed treatments at the boundaries of rice fields and the voids in large areas.</p>\n<p>非局部映射的代表性方法是 Woo 等人（2018）提出的卷积块注意力模块（CBAM），该模块侧重于提取关键特征并抑制不必要的特征。它由通道注意力模块（CAM）和空间注意力模块（SAM）组成。具体来说，CAM 沿空间维度使用最大池和平均池作，分别获得最重要和全局的信道上下文信息。SAM 通过最大池化和平均池作重新校准了通道轴线的特征图，以突出显示有用的区域。对于无人机遥感的图像语义分割，通常应用 CBAM 以增强模型对空间细节的聚焦能力，并恢复断开的边界和杂乱的误报预测。例如，Bo 等人（2022）将 CBAM 集成到烧毁区域检测网络中，以识别无人机图像中最显著的物体，并捕捉空间位置和边缘信息，以优化最终突出区域地图。Hong 等人（2021）认为，无人机遥感图像中的道路裂缝非常狭窄，因为裂缝仅由几个像素组成。因此，他们在 UNet 最后一个卷积层之前加入了 CBAM，以聚焦裂纹区域，提高了裂纹边缘细节和连接部分的分割精度。Bisio 等人（2023）还认为，CBAM 有助于从无人机图像中提取全球道路交通密度、流量模式和道路容量的信息，从而高效分析交通。此外，CBAM 可以灵活地嵌入卷积网络中，模型修改成本极低。Wang 等人（2022d）认为，低分辨率和低信噪比的热成像中大坝表面植被与大坝表面渗漏相似，导致网络产生了渗漏区模糊边界。在网络跳跃连接中加入 CBAM 提升了语义和空间信息识别能力，实现了准确的渗漏剖面，边界清晰，且热图上 “渗漏状” 干扰引起的误报率更低。Chen 等人（2023）认为，高分辨率无人机图像中小范围的森林火焰区域会导致前景与背景之间的类别不平衡问题。他们在分段网络的解码器中添加了 CBAM，以提取低层语义特征的细节，使模型能够更专注于火焰区域，并在交叉与联合（IoU）指标上实现了 5.43% 的提升。Yan 等（2023）将 CBAM 嵌入卷积网络的特征提取层，以抑制不必要的特征提取。实验结果证实，CBAM 推动模型在稻田边界和大面积空隙处进行详细处理。</p>\n<img data-src=\"../../images/paper/semantic_segmentation/4.png\" alt=\"1\"  />\n<p>Fig. 5. Graphical visualization of the structure of the SE module and the ECA module. Both SE and ECA modules share the similar module pipeline and are channel attention modules. The nonlinear mapping function φ© in the SE module is formed by two fully connected layers, while the nonlinear mapping function φ© in the ECA module is two 1-dimensional convolutional layers.</p>\n<p>图 5。SE 模块和 ECA 模块结构的图形可视化。SE 和 ECA 模块共享相似的模块流水线，都是通道注意力模块。<mark>SE 模块中的非线性映射函数<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>φ</mi><mo stretchy=\"false\">(</mo><mi>C</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">φ(C)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">φ</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mclose\">)</span></span></span></span> 由两个全连通层构成</mark>，而<mark> ECA 模块中的非线性映射函数<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>φ</mi><mo stretchy=\"false\">(</mo><mi>C</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">φ(C)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">φ</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mclose\">)</span></span></span></span> 由两个一维卷积层组成。</mark></p>\n<p>Similar to CAM, the Squeeze and Excitation (SE) module proposed by Hu et al. (2018) converts information along the channel dimension of a feature map into channel weight coefficients that are relevant to particular tasks. As illustrated in Fig. 5, the SE module utilizes spatial global average pooling (GAP) to obtain the average feature response of each channel. Then, it adopts two fully connected layers as the non-local mapping function φ© to integrate global information across channels. Lastly, the output of the softmax activation function serves as the weight for each feature channel. Su et al. (2022) introduced the SE module in the multi-scale feature fusion stage of UNet, and the experimental results suggested that the combination of UNet and SE provided faster training convergence and better accuracy on farmland data with small samples and fragmented information.</p>\n<p><mark>类似于 CAM 的作，胡等人（2018）提出的挤压与激发（SE）模块将特征图的通道维度信息转换为与特定任务相关的通道权重系数。如图 5 所示，SE 模块利用空间全局平均池（GAP）来获得每个通道的平均特征响应。然后，采用两层全连通图层作为非本地映射函数 φ（C），以整合跨信道的全局信息。最后，softmax 激活函数的输出作为每个特征通道的权重。Su 等人（2022）在 UNet 多尺度特征融合阶段引入了 SE 模块，实验结果表明，UNet 和 SE 的结合在样本较小且信息碎片化的农田数据中提供了更快的训练收敛和更高精度。</mark></p>\n<p>On the basis of SENet, Sun et al. (2022) designed the concurrent spatial and channel squeeze and excitation (scSE) module by combining spatial and channel context information to further enhance the model capacity to extract  meaningful semantic representations for accurately segmenting trees  and roads in the orchard. However, the non-linear mapping function  of the SE module adopts two fully connected layers that are computationally intensive, and the channel dimension reduction destroys  the direct correspondence between channels and their weights.</p>\n<p><mark>在 SENet 的基础上，Sun 等人（2022）通过结合空间和通道上下文信息，设计了并行空间和通道挤压与激励（scSE）模块，以进一步提升模型提取有意义语义表征的能力，从而准确分割果园中的树木和道路。然而，SE 模块的非线性映射函数采用了两个计算密集的全连接层，且通道维度降低破坏了通道与其权重之间的直接对应关系。</mark></p>\n<p>Wang et al. (2020e) revisited the non-linear mapping mechanism of the SE module and proposed an Efficient Channel Attention (ECA) module that adopted one-dimensional convolution as mapping function φ© to avoid dimensionality reduction and implement cross-channel interaction. As an extremely light-weight module, ECA has little impact on the number of parameters of the network regardless of where it is inserted. Han et al. (2021) embedded ECA module in the encoder stage of UNet to focus on extracting semantic features for insulators with diverse, damaged, and ambiguous appearances. Huan et al. (2022) added a parallel global maximum pooling on the top of ECA for exploring the most significant spatial information along channels to improve the accuracy of segmenting farmland edges and identifying narrow farmland ridges from UAV images. A comparative experiment conducted by Cai et al. (2023) tested three non-local mapping methods, CBAM, SE, and ECA, for identifying weeds in pineapple fields in high-resolution UAV images. The results demonstrated that ECA outperformed the other methods in terms of parameter count, computational consumption, and semantic segmentation accuracy.</p>\n<p><mark>Wang 等人（2020e）重新审视了 SE（Squeeze-and-Excitation）模块的非线性映射机制，并提出了一种高效通道注意力（Efficient Channel Attention，ECA）模块。该模块采用一维卷积作为映射函数<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>φ</mi><mo stretchy=\"false\">(</mo><mi>C</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">φ(C)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">φ</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mclose\">)</span></span></span></span>，以避免降维并实现跨通道交互。作为一种极其轻量级的模块，无论插入在网络的哪个位置，ECA 对网络参数数量的影响都很小。Han 等人（2021）将 ECA 模块嵌入到 UNet 的编码器阶段，专注于提取具有多样、受损和模糊外观的绝缘体的语义特征。Huan 等人（2022）在 ECA 的顶部增加了一个并行的全局最大池化操作，以探索通道中最显著的空间信息，从而提高从无人机图像中分割农田边缘和识别狭窄农田垄埂的准确性。Cai 等人（2023）进行了一项对比实验，测试了三种非局部映射方法：CBAM、SE 和 ECA，用于识别高分辨率无人机图像中菠萝田的杂草。结果表明，在参数数量、计算消耗和语义分割准确性方面，ECA 均优于其他方法。</mark></p>\n<h4 id=\"self-attention-mechanism\"><a class=\"markdownIt-Anchor\" href=\"#self-attention-mechanism\">#</a> Self-attention mechanism</h4>\n<p>自注意力机制</p>\n<p>Recently, the self-attention mechanism, initially celebrated for its superior performance in sequence modeling (Vaswani et al., 2017), such as natural language processing and machine translation, has been widely adopted in the field of image processing (Koščević et al., 2019; Niu et al., 2021; Ghaffarian et al., 2021). In the context of image analysis, it aimed to compute the response matrix of one position attending to all positions and aggregate long-distance contextual dependency adaptively. Self-attention is a soft, deterministic, and differentiable attention mechanism that focuses more on regions or channels, which means that attention weights can be acquired through the learning process. It requires the input feature map from the previous layer to calculate the attention weights, reducing the dependence on external information (Wang et al., 2018). Well-known plug-and-play selfattention methods, such as Non-local Mapping Networks (Wang et al., 2018), Dual Attention Networks (DANet) (Fu et al., 2019), Criss-Cross Attention Networks (CCNet) (Huang et al., 2019b), have been developed to capture long-range contextual information in spatial and channel dimensions respectively, thus improving feature representation for accurate image segmentation. According to our investigation, DANet has received more attention for improving semantic segmentation accuracy in UAV remote sensing compared to other self-attention implementations.</p>\n<p>近年来，自注意机制最初因其在序列建模中的优异表现而备受赞誉（Vaswani 等，2017），如自然语言处理和机器翻译，已被广泛应用于图像处理领域（Koščević 等，2019;Niu 等，2021;Ghaffarian 等，2021）。在图像分析的背景下，它旨在计算一个位置对所有位置的响应矩阵，并自适应地汇总长距离上下文依赖性。自我关注是一种软性、确定性且可微分的注意力机制，更多关注区域或通道，这意味着注意力权重可以通过学习过程获得。它需要上一层的输入特征图来计算注意力权重，从而减少对外部信息的依赖（Wang 等，2018）。著名的即插即用自关注方法，如非本地映射网络（Wang 等，2018）、双注意力网络（DANet）（Fu 等，2019）、交叉注意力网络（CCNet）（Huang 等，2019b），已被开发出来，分别用于捕捉空间维度和通道维度的长距离上下文信息，从而提升特征表示以实现图像切割的准确性。根据我们的调查，DANet 在提升无人机遥感语义分割准确性方面，相较于其他自注意实现，受到了更多关注。</p>\n<p>Fig. 6 shows a diagram of the network topology of the Position Attention Module (PAM) and Channel Attention Module (CAM) of DANet (Fu et al., 2019) to facilitate an intuitive understanding of the self-attention mechanism. The Position Attention Module firstly convert the input feature map f ∈ RH×W ×C into three tensors θ ∈ R(H×W )×C , φ ∈ RC×(H×W ), and g ∈ R(H×W )×C . Then attention matrix Ms ∈ R(H×W )×(H×W ) that captures the dependencies between any two spatial positions can be obtained by the matrix product of θ and φ. Finally, it performs an element-wise sum operation on the original feature f and the matrix multiplication result of Ms and g to obtain the final attention-based representation. The network topology of the Channel Attention Module is similar to that of the Position Attention Module, which aims to establish channel dependencies between any two channels and adaptively update each channel map according to the weighted sum of all channel maps.</p>\n<p>图 6 展示了 DANet（Fu 等，2019）中位置注意力模块（PAM）和通道注意力模块（CAM）的网络拓扑图，便于直观地理解自注意机制。位置注意力模块首先将输入特征映射 f ∈ RH×W ×C 转换为三个张量 θ ∈ R（H×W ）×C 、φ ∈ RC×（H×W ） 和 g ∈ R（H×W ）×C 。那么，通过 θ 和 φ 的矩阵积，可以用 θ 和  的矩阵积得到注意力矩阵 Ms ∈ R（H×W ）×（H×W ）捕捉任意两个空间位置之间的依赖关系。最后，它对原始特征 f 和矩阵乘法结果 Ms 和 g 进行逐元素求和，得到基于注意力的最终表示。信道注意力模块的网络拓扑类似于位置注意力模块，后者旨在建立任意两个信道之间的信道依赖关系，并根据所有信道图的加权和自适应地更新每个信道映射。</p>\n<img data-src=\"../../images/paper/semantic_segmentation/5.png\" alt=\"1\"  />\n<p>Fig. 6. Graphical visualization of the Position Attention Module (a) and the Channel Attention Module (b) of DANet.</p>\n<p>图 6。DANet 中位置注意力模块（a）和通道注意力模块（b）的图形可视化。</p>\n<p>Chowdhury and Rahnemoonfar (2021a) reported the complexities in distinguishing the similar textures of debris, sand, and buildings with total destruction damage in high-resolution natural disaster images captured by UAVs (Chowdhury et al., 2020), as the shallow layers of the semantic segmentation backbone extracted fine-grained spatial texture information with low-level meanings but poor semantic consistency. However, the combination of PAM with the shallow layers encouraged the exploration of the global autocorrelation (Chen et al., 2012) of pixels or objects between each local receptive field in high-resolution images to enhance the distinguishability of similar textures of different classes (Chowdhury and Rahnemoonfar, 2021a,b). Regarding the semantic segmentation of tree species, Huang et al. (2023) contended that significant coincidence existed among the information of various tree species growing in the same geographic location. Therefore, the author proposed a dual-attention residual module to process the strong correlation between local features and global dependence of tree species information from spatial and channel dimensions. Jiang et al. (2022) argued that the ground fissure images in coal mine areas obtained by UAVs were heavily affected by strong noise, such as different illumination and shadow, making conventional segmentation techniques, such as Canny (1986) and Adaptive Threshold (Chang et al., 2000), suffered poor generalization performance. In contrast, the proposed MFPA-Net composed of dilated residual networks and the DANet generated clear and accurate shapes of the ground fissures by utilizing plenty of valuable global features and contextual information to overcome the interference of various noises. Zhang et al. (2021b) found that the spatial patterns of the same type of river ice could vary significantly, while different types of river ice sometimes appear similar due to the complex formation and evolution processes. The authors accordingly adopted the DANet to highlight distinguishable semantic representations of drift ice and shore ice.</p>\n<p>Chowdhury 和 Rahnemoonfar（2021a）报告了在高分辨率自然灾害图像中区分碎片、沙土和完全毁坏建筑物的相似纹理的复杂性，这些图像由无人机（Chowdhury 等人，2020）拍摄。由于语义分割主干网络的浅层提取了具有低级含义但语义一致性较差的细粒度空间纹理信息，因此，将点调整模块（PAM）与浅层相结合，鼓励在高分辨率图像中探索每个局部感受野之间像素或对象的全局自相关性（Chen 等人，2012），以提高不同类别相似纹理的可区分性（Chowdhury 和 Rahnemoonfar，2021a，b）。关于树种的语义分割，Huang 等人（2023）认为，生长在同一地理位置的各种树种的信息存在显著的重合。因此，作者提出了一个双注意力残差模块，从空间和通道维度处理树种信息局部特征与全局依赖之间的强相关性。Jiang 等人（2022）认为，无人机拍摄的煤矿区地裂缝图像受到强烈噪声（如不同光照和阴影）的严重影响，使得传统分割技术（如 Canny（1986）和自适应阈值（Chang 等人，2000））的泛化性能较差。相比之下，所提出的 MFPA-Net 由扩张残差网络和 DANet 组成，通过利用大量有价值的全局特征和上下文信息，克服了各种噪声的干扰，生成了清晰准确的裂缝形状。Zhang 等人（2021b）发现，同种河冰的空间模式可能存在显著差异，而不同类型的河冰有时由于复杂的形成和演化过程而显得相似。因此，作者采用 DANet 来突出漂冰和岸冰的可区分语义表示。</p>\n<p>In summary, the self-attention mechanism represented by the DANet can be utilized to enhance the ability of semantic segmentation models to extract distinguishable features from ambiguous semantic objects in high-resolution UAV images by establishing global contextual relationships across the spatial and channel dimensions of the feature maps. However, it should be noted that the full matrix multiplication operations in both PAM and SAM are computationally intensive (Huang et al., 2019b; Khan et al., 2022). In fact, there are other light-weight yet efficient modules (Huang et al., 2019a; Zhu et al., 2019; Huang et al., 2019b) built on the top of the self-attention mechanism, but the best practices of them or similar pipelines have not been validated in semantic segmentation for UAV images.</p>\n<p>总之，DANet 所代表的自注意机制可用于增强语义分割模型从高分辨率无人机图像中模糊语义对象中提取可区分特征的能力，通过建立跨空间和通道维度的全局上下文关系。然而，需要注意的是，PAM 和 SAM 中的全矩阵乘法运算都具有计算密集型（Huang 等，2019b;Khan 等，2022）。事实上，还有其他轻量级但高效的模块（Huang 等，2019a;Zhu 等，2019;Huang 等，2019b）建立在自注意机制之上，但它们或类似流程的最佳实践尚未在无人机图像的语义分割中得到验证。</p>\n<h4 id=\"hierarchical-attention-mechanism\"><a class=\"markdownIt-Anchor\" href=\"#hierarchical-attention-mechanism\">#</a> Hierarchical attention mechanism</h4>\n<p>层级注意力机制</p>\n<p>The abovementioned attention models can be regarded as singleinput representation models designed to calculate the attention weights of independent branches. Another co-attention mode is the hierarchical attention mechanism (Chen et al., 2016; Tao et al., 2020) that parallelly establishes the contextual dependency on the multi-input presentations and finally merge the attentions of these parallel branches. However, only a few studies were found in literature where the hierarchical attention was used for UAV segmentation tasks in high-resolution remote sensing images. Inspired by the hierarchical attention mechanism proposed by Tao et al. (2020) for predicting relative weights between adjacent scale pairs, Anand et al. (2021) proposed AgriSegNet for IoT-assisted precision agriculture monitoring. One of the distinctive characteristics of the hierarchical attention mechanism was that the model inference with multiple image scales, such as three image scales, only required two image scales in the training phase. Lyu et al. (2021) improved it and proposed bidirectional Multi-scale Attention Network (BiMSANet) that integrated two feature-level hierarchical multi-scale attention networks corresponding to two bypasses for hierarchical feature fusion. Specifically, benefiting from attention heads with the same pipeline, these two bypasses were able to obtain the optimal scale for feature fusion from both directions. Comparative experiments on the UAVid dataset had shown that BiMSANet delivered an excellent performance on processing small targets and adaptively adjusted multiscale attention patterns for different object scales. It achieved the best segmentation performance in the Human class compared to other methods and reached a superior result with the mIoU of 70.8% for the UAVid benchmark.</p>\n<p>上述注意力模型可视为单输入表示模型，旨在计算独立分支的注意力权重。== 另一种共注意模式是层级注意力机制（Chen 等，2016;Tao 等，2020），它并行建立对多输入呈现的上下文依赖，并最终合并这些并行分支的注意力。然而，文献中只有少数研究将分层注意力用于高分辨率遥感图像中的无人机分割任务。== 受 Tao 等人（2020）提出的分层注意力机制的启发，用于预测相邻尺度对之间的相对权重，Anand 等人（2021）提出了 AgriSegNet 用于物联网辅助精准农业监测。分层注意力机制的一个显著特点是，多图像尺度（如三图像尺度）的模型推断在训练阶段只需两个图像尺度。Lyu 等（2021）改进了该机制，提出了双向多尺度注意力网络（BiMSANet），集成了两个特征级层级多尺度注意力网络，对应于分层特征融合的两个旁通。具体来说，借助同一流水线的注意力头，这两种旁通能够从两个方向获得特征融合的最优尺度。UAVid 数据集的对比实验表明，BiMSANet 在处理小目标和对不同对象尺度的多尺度注意力模式进行自适应调整方面表现出色。<mark>它在人类类别中实现了最佳的分割性能，UAVid 基准测试的 mIoU 达到了 70.8%。</mark></p>\n<p>Table 3 provides a summary of several relevant relationship modeling methods that have been adopted in the semantic segmentation tasks for UAV-based images. The relationship modeling methods applied in the literature can be summarized as spatial-wise relationship modeling,  channel-wise relationship modeling, scale-wise relationship modeling, and hybrid methods. Developing a more effective relationship modeling mechanism for obtaining diverse and discriminative feature representation and improving the segmentation performance of UAV images are the recent trend that requires full comparisons and evaluations. As shown in Table 3, the DA modules have received significant attention in the recent literature on contextual relationship modeling. In fact, the self-attention mechanism is an essential component of Transformers (Khan et al., 2022; Jamil et al., 2023; Xiao et al., 2023a), the novel network architecture that explicitly learns the intrinsic relationships of elements or sequences. In recent years, Transformer-based semantic segmentation models have also profoundly impacted the development of semantic segmentation methods for UAV images, and we will provide details in the next section.</p>\n<p>表 3 总结了几种被无人机图像语义分割任务采用的相关关系建模方法。文献中应用的关系建模方法可归纳为空间关系建模、通道关系建模、尺度关系建模和混合方法。开发更有效的关系建模机制以获得多样且判别性强的特征表示，并提升无人机图像的分割性能，是近期需要全面比较和评估的趋势。如表 3 所示，DA 模块在近期关于情境关系建模的文献中获得了广泛关注。事实上，自我关注机制是 Transformers（Khan 等，2022;Jamil 等，2023;Xiao 等，2023a），这是一种新颖的网络架构，明确学习元素或序列的内在关系。近年来，基于 Transformer 的语义分割模型也深刻影响了无人机图像语义分割方法的发展，我们将在下一节提供详细介绍。</p>\n<img data-src=\"../../images/paper/semantic_segmentation/6.png\" alt=\"1\"  />\n<blockquote>\n<p>CBAM —— <strong>性价比高，但能力有限</strong></p>\n<p>SE / ECA —— <strong>轻量化最优，但表达能力偏弱</strong></p>\n<p>Dual Attention (DA) —— <strong>综合能力最强</strong>，显式建模长程上下文依赖，同时处理 <strong>空间注意力 + 通道注意力</strong>带来更精确的语义分割结果，但矩阵运算，计算量大</p>\n<p>Hierarchical Attention —— <strong>折中方案</strong></p>\n<p>DA &gt; Hierarchical Attention &gt; CBAM &gt; SE ≈ ECA</p>\n</blockquote>\n<h3 id=\"vision-transformer-architectures\"><a class=\"markdownIt-Anchor\" href=\"#vision-transformer-architectures\">#</a> Vision transformer architectures</h3>\n<p>ViT</p>\n<p>The remarkable performance of Transformer models on natural language tasks (Vaswani et al., 2017; Ott et al., 2018) has piqued the interest of the computer vision community to explore potential applications in computer vision problems. Both Khan et al. (2022) and Jamil et al. (2023) provided a comprehensive review on transformers in computer vision. According to the review conducted by Khan et al. (2022), Transformer-based models applied to vision tasks can be broadly categorized into models with single-head attention and models with multi-head attention. The combination of DCNNs and selfattention mechanism in the previous section can be classified as the former, while this section focuses on the latter.</p>\n<p>Transformer 模型在自然语言任务中的卓越表现（Vaswani 等，2017;Ott 等，2018）引起了计算机视觉界对探索计算机视觉问题潜在应用的兴趣。Khan 等人（2022 年）和 Jamil 等人（2023 年）都提供了关于计算机视觉中变换器的完整综述。根据 Khan 等人（2022）的综述，基于 Transformer 的模型应用于视觉任务，大致可分为单头注意力模型和多头注意力模型。前一节中 DCNNs 与自我关注机制的结合可归为前者，而本节则聚焦后者。</p>\n<p>As of recently, we observed that the transformer-based semantic segmentation method for UAV remote sensing images follows the encoder–decoder structure, which is the same as the underlying structure of CNN-based methods. Besides, transformer models with multi-head attention can be flexibly combined with convolutional networks, thus giving rise to more diverse encoder–decoder structures for UAV image semantic segmentation (Wang and Mahmoudian, 2023; Li and Hsu, 2022; Ghali and Akhloufi, 2023). In this section, we investigated and outlined the best practices of vision transformers (ViT) with multi-head attention in the semantic segmentation of UAV remote sensing images.</p>\n<p>近期，我们观察到，用于无人机遥感图像的基于 Transformer 的语义分割方法遵循编码器 - 解码器结构，这与基于卷积神经网络（CNN）的方法的基础结构相同。此外，具有多头注意力机制的 Transformer 模型可以与卷积网络灵活结合，从而为无人机图像语义分割提供了更多样化的编码器 - 解码器结构（Wang and Mahmoudian, 2023; Li and Hsu, 2022; Ghali and Akhloufi, 2023）。在本节中，我们研究和概述了具有多头注意力机制的视觉 Transformer（ViT）在无人机遥感图像语义分割中的最佳实践。</p>\n<p>ViT, designed by Dosovitskiy et al. (2021) for image recognition tasks, first divides an image into equal-sized patches and then flattens patches into 2D-patches sequences that are fed into linear projections to obtain patch embeddings. The transformer encoder, which contributes to capturing global relationships between image pixels at shallow layers, takes these patch embeddings along with position embeddings as input (Dosovitskiy et al., 2021). However, obtaining feature representation containing global contextual information in CNN-based encoders without attention modules necessitates deeper convolutional layers. The success of ViT in image analysis contributed to promising developments and innovations applicable to image segmentation in UAV remote sensing (Li and Hsu, 2022; Ghali and Akhloufi, 2023). For instance, due to significant variations of object scale, object appearance, and background clutters in remotely captured UAV images (Lyu et al., 2020), Kumar et al. (2022, 2023) designed a ViT-based encoder with a convolution-based Token Spatial Information Fusion (TSIF) module that captured the local context details about neighboring pixels. The proposed method exhibited competitive accuracy in the semantic segmentation of small-scale objects in the UAVid dataset compared with previous CNN-based methods. Zhou et al. (2022) argued that developing a practical solution that placed greater emphasis on global contextual information and the significant variation of broccoli in terms of texture, size, and shape is crucial when utilizing UAVs for broccoli detection and characterization. They adopted TransUNet (Chen et al., 2021), the first transformer-based model (Xiao et al., 2023a) built on the top of the UNet structure (Ronneberger et al., 2015), for broccoli canopy mapping. The feature encoder of TransUNet combined transformers with convolution layers to reduce the loss of low-level semantic information in the transformer and enhance the spatial details in local space. In the decode stage, a cascaded up-sampler (CUP) with multiple up-sampling steps was leveraged to generate the final mask. Similarly, Luo et al. (2023) applied TransUNet to poppy segmentation in UAV images. Experiment results demonstrated that TransUNet obtained higher segmentation accuracy with sharper boundaries and fewer false positives than the representative CNN-based UNet (Ronneberger et al., 2015) and DeepLabV3+ (Chen et al., 2018b). Inspired by TransUNet, Niu et al. (2022) designed the HSI-TransUNet for crop mapping from UAV hyperspectral imagery. Specifically, the encoder of HSI-TransUNet adopted spectral-feature attention modules for spectral feature aggregation as well as the residual Transformer layers for global contextual feature extraction. Competitive segmentation accuracies of HSI-TransUNet on the UAV-HSI-Crop dataset against TransUNet and its variants demonstrated that it was sufficient to process the characteristics of UAV HSI data, which had both very high spatial and spectral resolutions.</p>\n<p>ViT 由 Dosovitskiy 等人（2021 年）设计用于图像识别任务，首先将图像分割成等大小的块状，然后将这些斑块平展成二维斑块序列，再输入线性投影以获得斑块嵌入。变压器编码器负责捕捉浅层图像像素之间的全局关系，其输入是将这些补丁嵌入和位置嵌入一起进行（Dosovitskiy 等，2021）。然而，在无注意力模块的 CNN 编码器中获得包含全局上下文信息的特征表示，需要更深层的卷积层。ViT 在图像分析中的成功推动了无人机遥感图像分割领域的有前景的发展和创新（Li 和 Hsu，2022;Ghali 和 Akhloufi，2023 年）。例如，由于远程捕捉无人机图像中物体比例、物体外观和背景杂乱存在显著差异（Lyu 等，2020），Kumar 等人（2022,2023）设计了一个基于 ViT 的编码器，采用基于卷积的令牌空间信息融合（TSIF）模块，能够捕捉邻近像素的局部上下文细节。与以往基于 CNN 的方法相比，该方法在 UAVid 数据集中小尺度对象的语义分割表现出竞争力。周等人（2022）认为，开发一种实用解决方案，更加重视全球情境信息以及西兰花在质地、大小和形状上的显著变异，对于利用无人机进行西兰花检测和特征分析至关重要。他们采用了 TransUNet（Chen 等，2021），这是首个基于变压器的模型（Xiao 等，2023a），构建在 UNet 结构顶部（Ronneberger 等，2015），用于西兰花树冠映射。TransUNet 的特征编码器将变换器与卷积层结合，以减少变换器中低级别语义信息的丢失，并增强局部空间的空间细节。在解码阶段，采用了具有多重上采样步骤的级联上采样器（CUP）来生成最终的掩模。同样，Luo 等人（2023）将 TransUNet 应用于无人机图像中的罂粟切片。实验结果表明，TransUNet 在具有代表性的基于 CNN 的 UNet（Ronneberger 等，2015）和 DeepLabV3+（Chen 等，2018b）中，在分割准确性上、边界更锐利且假阳性更少。受 TransUNet 启发，Niu 等人（2022 年）设计了用于无人机高光谱图像裁判映射的 HSI-TransUNet。具体来说，HSI-TransUNet 的编码器采用了谱特征注意模块进行谱特征聚合，以及剩余的 Transformer 层用于全局上下文特征提取。HSI-TransUNet 在 UAV-HSI-Crop 数据集上的划分准确度与 TransUNet 及其变体的竞争性，证明处理无人机 HSI 数据的特性足以处理，这些数据具有极高的空间和光谱分辨率。</p>\n<p>Although TransUNet captures global semantic information about complex objects from fine-resolution UAV images, the transformer significantly increases the computational complexity as it is quadratically related to the number of tokens (Khan et al., 2022; Xiao et al., 2023a). However, in real-time urban applications using UAV platforms, prioritizing high image processing speed with light-weight models outweighs the demand for extreme accuracy (Wang et al., 2022c). Hence, Wang et al. (2022c) adopted the light-weight ResNet18 (He et al., 2016) as the encoder of the semantic segmentation network, while the decoder utilized the Global-local Transformer Block (GLTB) and the Feature Refinement Head (FRH) to capture the global context and maintain spatial details, in which the GLTB adopted the computation-friendly cross-shaped window context interaction module to capture the crosswindow relationships. Other researchers have also demonstrated that  an excellent encoder design also benefited the acquisition of semantic feature representations composed of global context information and local details for the accurate semantic segmentation of UAV images. For instance, Ding et al. (2023) proposed the IBR-Former, which consisted of two parallel crack segmentation branches, for UAV-oriented concrete crack detection and quantification. The coarse segmentation branch leveraged the Swin-Transformer (Swin-T) (Liu et al., 2021d) as the feature encoder for effectively extracting feature representations crack with different sizes and insufficient pixels, while the other crack offset generating branch aimed to fix irregularly shaped thin crack boundaries of the coarse segmentation maps. Lu et al. (2023) and Xiang et al. (2023) coincidentally adopted a dual-encoder design composed of both Transformer-based and CNN-based encoders for semantic segmentation on UAV remote sensing imagery. Both demonstrated the heterogeneous dual-encoder structure was complementary, since the transformer-based encoder established global relationships between pixels or semantic objects of the UAV image but lost local details, while the CNN-based encoder extracted spatial local features of the UAV image, such as edge details, color, texture and shape of the land covers or crops, which compensated for the loss of local information in transformers. Inspired by CBNet (Liu et al., 2020) and CBNetv2 (Liang et al., 2022), Yi et al. (2023a,b) designed UAVformer and CCSeg for urban scene segmentation and UAV visual perception. Both networks adopted a composite structure backbone composed of a main encoder and single or multiple auxiliary encoders to satisfy the semantic segmentation requirement for UAV images, which was characterized by objects at various spatial scales, complex backgrounds, and fuzzy boundaries (Lyu et al., 2020). Besides, the decoder of both networks utilized multiple down-sampling paths and up-sampling paths to integrate multi-scaled features extracted by the encoders to retain sharper boundaries of segmented objects. In contrast, Wang et al. (2023a) straightforwardly leveraged Swin-T as an encoder for the UAV semantic segmentation model, while putting more emphasis on the decoder design, which consists of four NeW FC-CRFs (Yuan et al., 2022) in series. Compared to the state-of-the-art methods, the proposed method, Swin-T-NFC CRF, obtained 0.32% and 1.41% performance gains in OA and mIoU metrics, respectively.</p>\n<p>尽管 TransUNet 能够从精分辨率无人机图像中捕捉复杂物体的全局语义信息，但由于变换器与令牌数量成二次方相关，计算复杂度显著增加（Khan 等，2022;Xiao 等，2023a）。然而，在使用无人机平台的实时城市应用中，优先考虑轻量化模型的高图像处理速度，超过了对极高精度的需求（Wang 等，2022c）。因此，Wang 等人（2022c）采用了轻量级的 ResNet18（He 等，2016）作为语义分割网络的编码器，而解码器则利用全局 - 局部变换器块（GLTB）和特征细化头（FRH）捕捉全局上下文并维护空间细节，而 GLTB 采用了计算友好的交叉形状窗口上下文交互模块来捕捉跨窗口关系。其他研究者还证明，优秀的编码器设计也有助于获取由全局上下文信息和局部细节组成的语义特征表示，从而实现无人机图像的准确语义分割。例如，丁等人（2023）提出了 IBR-Former，由两条平行的裂纹分割分支组成，用于无人机导向混凝土裂纹的检测和量化。粗分割分支利用 Swin-Transformer（Swin-T）（Liu 等，2021d）作为特征编码器，有效提取不同大小和像素不足的特征裂纹，而另一分支则旨在固定粗分割图中形状不规则的薄裂纹边界。Lu 等人（2023）和 Xiang 等人（2023）巧合地采用了一种双编码器设计，结合基于 Transformer 和基于 CNN 的编码器，用于无人机遥感图像的语义分割。两者都证明了异构双编码器结构是互补的，因为基于变压器的编码器建立了无人机图像像素或语义对象之间的全局关系，但会丢失局部细节；而基于卷积神经网络的编码器则提取无人机图像的空间局部特征，如边缘细节、颜色、纹理和土地覆盖或作物的形状，从而补偿变压器中局部信息的丢失。受 CBNet（Liu 等，2020）和 CBNetv2（Liang 等，2022）启发，Yi 等（2023a，b）设计了 UAVformer 和 CCSeg，用于城市场景分割和无人机视觉感知。两个网络都采用了由主编码器和单个或多个辅助编码器组成的复合结构骨干，以满足无人机图像的语义分割需求，该图像的特征包括不同空间尺度、复杂背景和模糊边界的对象（Lyu 等，2020）。此外，两个网络的解码器都采用多条下采样和上采样路径，整合编码器提取的多尺度特征，以保持更清晰的分段对象边界。相比之下，Wang 等人（2023a）直接利用 Swin-T 作为无人机语义分割模型的编码器，同时更强调解码器设计，该设计由四个串联的 NeW FC-CRF（Yuan 等，2022）组成。与最先进方法相比，所提方法 Swin-T-NFC CRF 在 OA 和 mIoU 指标上分别获得了 0.32% 和 1.41% 的性能提升。</p>\n<p>Several comparative studies were conducted to verify the semantic segmentation models combined with transformers outperformed the CNN-based method in terms of accuracy and generalization on RGBbased UAV imagery. For instance, Ghali et al. (2021, 2022) explored the potential of transformers for wildfire segmentation using ground and aerial imagery. Compared with CNN-based segmentation methods, Transformer-based methods, such as TransUNet (Chen et al., 2021), TransFire (Ghali et al., 2021), and MedT (Ghali et al., 2022), presented more excellent performance for localizing and segmenting forest fire pixels as well as small fire regions due to their ability to determine long-range dependencies and extract fine-grained details within input features. Gibril et al. (2023) evaluated the generalizability and the transferability of deep vision transformers and CNN-based semantic segmentation models for accurate mapping of date palm trees from very-high spatial resolution UAV-based and aerial images. The segmentation performance of the Segformer (Xie et al., 2021a) and the UperNet-Swin outperformed that of previous date palm tree mapping from UAV images, which demonstrated their superiority in processing UAV images with limited spectral information, high intra-class variance, variations in the spatial resolutions, and differences in image contexts and backgrounds. Wang and Mahmoudian (2023) permuted five encoder backbones and three decoder structures to construct multiple semantic segmentation methods for aerial fluvial images. Comparative results concluded that the semantic segmentation models utilizing the transformer as the encoder presented better generalization performance than CNNs as the encoder. Similar conclusions can also be found in the study conducted by Asad et al. (2023) on whether Transformers can be applied to natural disaster assessment in high-resolution UAV imagery.</p>\n<p>进行了多项比较研究，以验证语义分割模型结合变换器在基于 RGB 的无人机图像中，准确性和泛化性优于基于 CNN 的方法。例如，Ghali 等人（2021,2022）探索了利用地面和航拍影像在野火分割中的变压器潜力。与基于 CNN 的分割方法相比，基于 Transformer 的方法，如 TransUNet（Chen 等，2021）、TransFire（Ghali 等，2021）和 MedT（Ghali 等，2022），在定位和分割森林火灾像素以及小火灾区域方面表现更佳，因为它们能够确定远距离依赖关系并提取输入特征中的细粒度细节。Gibrinl 等人（2023）评估了深视变换器和基于卷积神经网络的语义分割模型在高空间分辨率无人机和航拍图像中枣椰树准确定位的普遍性和可迁移性。Segformer（Xie 等，2021a）和 UperNet-Swin 的分割性能优于以往无人机图像的枣椰树映射，后者展示了它们在处理光谱信息有限、类内方差大、空间分辨率差异以及图像上下文和背景差异的无人机图像方面的优势。Wang 和 Mahmoudian（2023）对五个编码主链和三个解码结构进行了置换，构建了多重航拍河流图像的语义分割方法。比较结果得出结论，使用变换器作为编码器的语义分割模型，其泛化性能优于作为编码器的 CNN。类似结论也出现在 Asad 等人（2023 年）关于变压器是否可应用于高分辨率无人机影像自然灾害评估的研究中。</p>\n<p>However, Zefri et al. (2023) discovered that the semantic segmentation training process of TransUNet exhibited more instability and slower convergence than that of CNN-based models on thermal image data collected by UAVs for photovoltaic array inspections. They argued that recent advanced models had been evaluated using multiclass RGB datasets, whose strength could not be directly highlighted or demonstrated in restricted and domain-specific tasks. It is justifiable as most ViTs trained on a new medium-range dataset would not give competitive results (Khan et al., 2022; Xiao et al., 2023a). Many Transformer-based models require very large-scale data to learn prior knowledge about the images, also called inductive biases, such as translation equivariance and spatial invariance (Khan et al., 2022; Xiao et al., 2023a).</p>\n<p>然而，Zefri 等人（2023）发现，在无人机收集的用于光伏阵列检查的热像数据上，TransUNet 的语义分割训练过程比基于卷积神经网络（CNN）的模型表现出更不稳定且收敛更慢。他们认为，近期的高级模型都是使用多类 RGB 数据集进行评估的，在受限且特定领域的任务中，这些模型的优点无法直接凸显或展示出来。这是有道理的，因为大多数在新的中距离数据集上训练的视觉变换器（ViTs）都无法给出具有竞争力的结果（Khan 等人，2022 年；Xiao 等人，2023a）。许多基于 Transformer 的模型需要非常大规模的数据来学习图像的先验知识，也称为归纳偏置，如平移等变性和空间不变性（Khan 等人，2022 年；Xiao 等人，2023a）。</p>\n<h3 id=\"light-weight-methods\"><a class=\"markdownIt-Anchor\" href=\"#light-weight-methods\">#</a> Light-weight methods</h3>\n<p>轻量化方法</p>\n<p>Although most semantic segmentation tasks for UAV remote sensing images, such as ecological monitoring, urban scene, and agricultural management, can benefit from efficient feature extraction based on DL methods, these methods are computationally intensive and require professional GPU servers for back-end image processing. A large amount of computation, memory overhead, and computational power consumption also curb the application of the recently feature-learning-based algorithms on embedding UAV platforms. Therefore, it is essential to carry out edge computing and light-weight artificial intelligence technologies so that the UAVs themselves can capture images and extract contextual information, thereby providing UAVs with autonomous perceptual capabilities of the surrounding environment. There are two concurrent research directions in this area: one is to develop more lightweight algorithms suitable for embedding platforms, while the other is to design or utilize parallel vector processors, such as Tensor Processing Unit (TPU) and Neural Processing Unit (NPU). In this section, we will focus on exploring light-weight algorithms for semantic segmentation on UAVs.</p>\n<p>虽然大多数无人机遥感图像的语义分割任务，如生态监测、城市景观和农业管理，都可以通过基于深度学习方法的高效特征提取受益，但这些方法计算量大，需要专业 GPU 服务器进行后端图像处理。大量的计算量、内存开销和计算功耗也限制了近期基于特征学习的算法在嵌入无人机平台上的应用。因此，必须开展边缘计算和轻量化人工智能技术，使无人机能够捕捉图像并提取上下文信息，从而赋予无人机对周围环境的自主感知能力。该领域有两个并行的研究方向：一是开发更轻量化的嵌入平台算法，二是设计或利用并行向量处理器，如张量处理单元（TPU）和神经处理单元（NPU）。本节将重点探讨无人机语义分割的轻量级算法。</p>\n<p>The light-weight methods of DL-based models can be divided into 6 groups: tensor decomposition (Jaderberg et al., 2014; Szegedy et al., 2016), low-precision quantization (Gholami et al., 2021), model pruning (Cheng et al., 2017), knowledge distillation (KD) (Hinton et al., 2015), neural architecture search (NAS) (Elsken et al., 2019), and efficient structures of light-weight networks (Howard et al., 2017; Tan and Le, 2019). Tensor decomposition aims to represent a high-dimensional tensor as the product of low-dimensional tensors, which can reduce the memory overhead of models and enable faster convolution with fewer and cheaper operations (Lebedev and Lempitsky, 2018). The lowprecision quantization method converts 32-bit floats into 16-bit floats or 8-bit integers. For instance, most processors allow faster processing for addition and multiplication operations of 8-bit integers, which means the light-weight CNNs after 8-bit quantization can be 4 times more efficient than 32-bit CNNs (Krishnamoorthi, 2018). NAS aims to automatically design and search efficient network structures beyond human experiences based on observation data. However, NAS on the large-scale datasets of UAV remote sensing imagery requires unaffordable computational resources for most researchers. Unfortunately, few recent literature found that the aforementioned light-weight methods are utilized in the research in the context of semantic segmentation of UAV remote sensing images due to limited expertise, repetitive fine-tuning, and restricted hardware resources.</p>\n<p>基于 DL 模型的轻量级方法可分为 6 类：张量分解（Jaderberg 等，2014;Szegedy 等，2016）、低精度量化（Gholami 等，2021）、模型剪枝（Cheng 等，2017）、知识蒸馏（KD）（Hinton 等，2015）、神经结构搜索（NAS）（Elsken 等，2019）以及轻量级网络的高效结构（Howard 等，2017; 谭和黎，2019）。张量分解旨在将高维张量表示为低维张量的乘积，这可以降低模型的内存开销，并以更少且更便宜的作实现更快的卷积（Lebedev 和 Lempitsky，2018）。低精度量化方法将 32 位浮点数转换为 16 位浮点或 8 位整数。例如，大多数处理器支持更快的 8 位整数加法和乘法处理，这意味着 8 位量化后的轻量级卷积神经网络效率可是 32 位卷积神经网络的 4 倍（Krishnamoorthi，2018）。NAS 旨在基于观察数据自动设计和搜索超越人类经验的高效网络结构。然而，NAS 用于大规模无人机遥感图像数据集，对大多数研究人员来说需要负担得起的计算资源。遗憾的是，由于专业知识有限、重复微调和硬件资源有限，近期文献很少发现上述轻量化方法在无人机遥感图像语义分割的研究中被广泛应用。</p>\n<p>Model pruning is one of the model compression methods that remove network branches or connection nodes that have low impacts on model performance, facilitating the deployment of deep networks to resource-constrained devices. To address the challenge of real-time scene parsing on UAV platforms, Zhang et al. (2019c) proposed slimYOLOv3, a narrow yet faster deep object detector by pruning less important feature channels of YOLOv3 (Redmon and Farhadi, 2018). The number of parameters and the amount of floating-point operations (FLOPS) of slimYOLOv3 were less than one-tenth of the original YOLOv3. However, it achieved about 2 times faster inference efficiency  and comparable detection accuracy to the YOLOv3. In addition, knowledge distillation (KD), as proposed by Hinton et al. (2015), is also one of the efficient methods for model compression. The knowledge distillation follows the fundamental rules that small models (students) can be trained by the output probability distribution or feature space distribution of large models (teachers). Recent studies had demonstrated the efficiency of knowledge distillation for object detection and action recognition in UAV remote sensing images (Liu et al., 2021a) or videos (Ding et al., 2020). To accommodate the need of embedded intelligence on UAVs, Wang et al. (2021b) proposed a real-time forest fire monitoring model on the top of YOLOv4 (Bochkovskiy et al., 2020) by combining model pruning and knowledge distillation. Specifically, they utilized channel-level sparsity-induced regularization to eliminate redundant feature channels and applied the knowledge distillation algorithm to enhance the detection accuracy of the pruned model. The light-weight model with pruning and KD fell to only 2.64M parameters, a reduction of 95.87% compared to the original model. The inference time was 4.11 times faster, while the mean average precision (mAP) is 3.9% lower than that of the original YOLOv4.</p>\n<p>模型剪枝是一种模型压缩方法，用于去除对模型性能影响较小的网络分支或连接节点，便于将深度网络部署到资源受限的设备上。为解决无人机平台上实时场景解析的挑战，<mark>Zhang 等人（2019c）提出了 slimYOLOv3，这是一种通过修剪 YOLOv3 中较不重要的特征通道，实现狭窄但更快的深层物体探测器（Redmon 和 Farhadi，2018）。slimYOLOv3 的参数数量和浮点运算（FLOPS）数量不到原始 YOLOv3 的十分之一</mark>。然而，<mark>它的推断效率约是 YOLOv3 的两倍，检测精度相当</mark>。此外，Hinton 等人（2015）提出的知识蒸馏（KD）也是模型压缩的高效方法之一。知识提炼遵循基本规则：== 小模型（学生）可以通过大型模型（教师）的输出概率分布或特征空间分布来训练。== 近期研究已证明，<mark>在无人机遥感图像（Liu 等，2021a）或视频（Ding 等，2020）中，知识蒸馏在物体检测和动作识别中的高效性</mark>。为满足无人机嵌入式智能的需求，==Wang 等（2021b）提出了基于 YOLOv4 的实时森林火灾监测模型（Bochkovskiy 等，2020），结合模型修剪与知识蒸馏。== 具体来说，他们利用通道级稀疏诱导的正则化消除了冗余特征通道，并应用知识蒸馏算法提升了修剪模型的检测准确率。<mark>轻量模型加修剪和 KD 后参数降至仅 264 万，比原始模型减少了 95.87%。推断时间快了 4.11 倍，平均精度（mAP）比原始 YOLOv4 低了 3.9%。</mark></p>\n<p>The design of efficient structures for light-weight networks is another commonly used technique for real-time semantic segmentation (Yu et al., 2018a; Orsic et al., 2019; Wang et al., 2020d; Gao et al., 2021a). The light-weight models designed following this paradigm are highly flexible and editable, as researchers can reduce the width, depth, and interlayer connections of the light-weight models according to the practical demands. Hence, the design of efficient structures can dynamically balance the computational complexity, number of parameters, computational power consumption, and model accuracy. Nguyen et al. (2019) designed MAVNet, a small but efficient light-weight network, for semantic segmentation on micro aerial vehicles (MAV) based on dilated convolution and depth-wise feature aggregation block (DWFab). Zuo et al. (2021) introduced BiSeNet (Yu et al., 2018a), a bilateral light-weight semantic segmentation network, to carry out the realtime aerial video semantic segmentation of UAV streetscape sequences. Both of their experiments were sufficient to demonstrate that efficient structures of light-weight networks achieve not only a good tradeoff between inference time, model size, and model accuracy, but also the rapid deployment without post-processing of the trained models. In addition, the combination of light-weight methods and efficient attention mechanisms enabled networks with limited parameters to capture more contextual information. Gao et al. (2021a) explored an asymmetric encoder–decoder network composed of factorization depthwise and dilation convolution using the multi-scale context fusion scheme and multiple efficient attention branches. Pang et al. (2022) also proposed the Semantics Guided Bottleneck Network (SGBNet) based on BiSeNet and the Channel Pooled Attention (CPA) mechanism to balance segmentation accuracy, model size, and inference speed on the Land Cover Dataset. These models utilized semantic enhancement modules with small parameters increment to preserve the spatial presentation with more details and enhanced the contextual relationships and generalization performance of light-weight models.</p>\n<p>为轻量级网络设计高效结构是另一种常用的实时语义分割技术（Yu 等，2018a;Orsic 等，2019;Wang 等，2020d;Gao 等，2021a）。按照这一范式设计的轻量级模型高度灵活且可编辑，研究人员可以根据实际需求缩小轻量级模型的宽度、深度和层间连接。因此，高效结构的设计能够动态平衡计算复杂度、参数数量、计算功耗和模型准确性。Nguyen 等人（2019）设计了 MAVNet，这是一个小巧但高效的轻量级网络，用于微型航空载具（MAV）语义分割，基于膨胀卷积和深度特征聚合块（DWFab）。Zuo 等（2021）引入了 BiSeNet（Yu 等，2018a），这是一种双边轻量级语义分割网络，用于实现无人机街景序列的实时航拍视频语义分割。== 他们的两个实验都足以证明，高效的轻量级网络结构不仅在推理时间、模型规模和模型准确性之间取得了良好权衡，还能在无需后处理的情况下快速部署训练模型。== 此外，轻量化方法和高效的注意力机制相结合，使参数有限的网络能够捕捉更多上下文信息。Gao 等（2021a）利用多尺度上下文融合方案和多高效注意力分支，探索了由深度分解和膨胀卷积组成的非对称编码器 - 解码器网络。Pang 等人（2022）还提出了基于 BiSeNet 和通道集中注意力（CPA）机制的语义引导瓶颈网络（SGBNet），以平衡土地覆盖数据集上的切分准确性、模型规模和推断速度。这些模型使用了参数增量较小的语义增强模块，以更详细的空间呈现方式保持空间表现，并提升了轻量级模型的上下文关系和泛化性能。</p>\n<p>Here we have described light-weight semantic segmentation methods in the context of UAVs, which is still a young research area awaiting in-depth explorations, with minimal published papers in this field. The design of efficient network structures seems to be the most practical approach in current literature compared to tensor decomposition, low-precision quantization, and NAS, for it does not require complex fine-tunings and post processes for model deployment on UAVs. Additionally, there are probably considerable benefits in combining different light-weight methods for model acceleration: more significant reduction of the model size and power consumption while maintaining model accuracy and accelerating the inference process (Wang et al., 2021b; Aghli and Ribeiro, 2021). Though light-weight semantic segmentation methods show encouraging achievements, the pretraining process of light-weight models is restricted by the limited image datasets with fine-gained annotations.</p>\n<p>本文中我们描述了无人机背景下的轻量级语义分割方法，该领域仍是一个年轻且等待深入探索的研究领域，且该领域的发表论文极少。与张量分解、低精度量化和无人机导航（NAS）相比，高效网络结构的设计似乎是当前文献中最实用的方法，因为它无需复杂的微调和后期处理即可在无人机上部署模型。此外，结合不同的轻量化模型加速方法可能带来显著好处：在保持模型准确性和加速推理过程的同时，更显著地减少模型规模和功耗（Wang 等，2021b;Aghli 和 Ribeiro，2021 年）。尽管轻量级语义分割方法取得了令人鼓舞的成就，但轻量级模型的预训练过程受限于有限的图像数据集和细致增益注释。</p>\n<p>Researchers prefer to transfer and fine-turn the pre-trained backbones for real-time semantic segmentation on UAVs due to the computational burden of pre-training the model from scratch, which also limits the diversification of efficient network structures.</p>\n<p>由于从零开始预训练模型的计算负担较大，且会限制高效网络结构的多样性，研究人员更倾向于迁移并微调预训练的主干网络，以便在无人机上进行实时语义分割。</p>\n<h2 id=\"datasets-for-uav-semantic-segmentation\"><a class=\"markdownIt-Anchor\" href=\"#datasets-for-uav-semantic-segmentation\">#</a> Datasets for UAV semantic segmentation</h2>\n<p>UAV 语义分割数据集</p>\n<p>The rapid development of semantic segmentation owes much to large-scale datasets and relevant DL-based image analysis methods. Undoubtedly, large-scale datasets and massive semantic annotations allow models to improve generalization performance and learn more diverse semantic information. The data sources of remote sensing semantic segmentation datasets are mainly collected by satellite-based platforms, aerial platforms, and embedding UAV platforms (Toth and Jóźków, 2016). Advanced surveys that summarized the remote sensing image datasets for different application scenarios mainly focused on datasets collected by satellite platforms (Song et al., 2019; Yuan et al., 2021; Osco et al., 2021). Satellites are constrained to catch the top vertical view from the sky, while UAVs are free to capture the perspective view in three dimensions, including vertical view, horizontal view, and oblique view, allowing researchers and practitioners to obtain unexplored viewpoints at various spatial scales than prior benchmarks (Nigam et al., 2018; Lyu et al., 2020). Due to many restrictions such as flight authorization and potential confidentiality requirements, we found that many restricted and domain-specific datasets collected by UAVs are not publicly available. Nevertheless, we believe that summarizing the publicly available UAV-based image datasets for semantic segmentation up to now may help scholars and practitioners understand the application trend of UAV platforms, reduce the labor cost for investigating relevant open-source datasets, as well as promote the emergence of more advanced semantic segmentation methods for UAVbased images. In this review, we have listed publicly available UAV datasets for semantic segmentation applied to different applications, as shown in Table 4.</p>\n<p>语义分割的快速发展很大程度上得益于大规模数据集和相关的基于深度学习的图像分析方法。毫无疑问，大规模数据集和海量语义注释使模型能够提升泛化性能，学习更多样的语义信息。遥感语义分割数据集的数据主要由卫星平台、空中平台和嵌入无人机平台收集（Toth 和 Jóźków，2016）。高级调查总结了不同应用场景下的遥感图像数据集，主要聚焦于卫星平台收集的数据集（Song 等，2019;Yuan 等，2021;Osco 等，2021）。卫星受限于捕捉天空顶部的垂直视角，而无人机则可自由捕捉三维透视视角，包括垂直视角、水平视角和斜视，使研究人员和从业者能够获得不同空间尺度上未探索的视角（Nigam 等，2018;Lyu 等，2020）。由于飞行授权和潜在保密要求等诸多限制，我们发现许多由无人机收集的受限和特定领域数据集并未公开。尽管如此，我们认为，汇总迄今为止公开的无人机图像数据集用于语义分割，有助于学者和实践者理解无人机平台的应用趋势，降低研究相关开源数据集的劳动成本，并推动更先进的无人机图像语义分割方法的出现。在本综述中，我们列出了公开可用的 UAV 数据集，用于不同应用的语义分割，如表 4 所示。</p>\n<p>Inspired by Cityscapes (Cordts et al., 2016; Nigam et al., 2018) released AeroScapes, which is designed for the image semantic segmentation tasks of the low-altitude scenes. It provides 3269 images  acquired from 141 video sequences of UAV fleets. Researchers prelabeled 11 ground truth classes with dense annotations, but the view variations caused by flexible flight altitude and movable perspective make it challenging for semantic segmentation tasks. Semantic Drone Dataset is another publicly available urban scene semantic understanding dataset that aims to increase the safety of UAV flight and landing procedures. The dataset consists of 400 training images with densely labeled semantic labels and 200 private testing images, all acquired by autonomous drones at an altitude of 5 to 30 m above the ground. Urban Drone Dataset (Chen et al., 2018c) (UDD5) is an urban scene collection of drone images acquired from 4 different cities in China at flight altitudes between 60 and 100 m. The original dataset comprises 5 categories, splitting 160 frames for the training set and 45 images for the verification set. In addition, the authors released a new public dataset with a new Roof class in 2020, which is also called UDD6. ManipalUAVid (Girisha et al., 2019) is a new UAV aerial video dataset collected in a closed university campus. It provides 33 videos and 667 key frames collected at six locations during the day. Only the key frames were finely annotated into 4 semantic classes, including constructions, greeneries, roads, and waterbodies. More recently, Lyu et al. (2020) released a high-resolution urban dataset called UAVid. The most characteristic of UAVid is the severe class imbalance of pixel distribution, making it challenging to preserve temporal consistency and obtain accurate segmentation results. It should be noted that this dataset only provides semantic label masks for specific image frames at selected time points within the video rather than for the entire video sequence. Their subsequent work added extra 12 sequences to strengthen the original 30 video sequences and released 42 sequences as UAVid2020, which can be available on their benchmark website.</p>\n<p>受城市景观启发（Cordts 等，2016;Nigam 等人，2018 年）发布了 AeroScapes，该软件专为低空场景的图像语义分割任务设计。它提供了从 141 段无人机机队视频序列中获取的 3269 张图像。研究人员预先标记了 11 个地面真实类并带有密集注释，但由于灵活飞行高度和可移动视角引起的视角变化，使得语义分割任务具有挑战性。语义无人机数据集是另一个公开可用的城市场景语义理解数据集，旨在提高无人机飞行和着陆程序的安全性。该数据集包含 400 张带有密集语义标签的训练图像和 200 张私有测试图像，均由自主无人机在地面 5 至 30 米高空拍摄。城市无人机数据集（Chen 等，2018c）（UDD5）是一组从中国 4 个不同城市在 60 至 100 米飞行高度拍摄的城市场景图像。原始数据集包含 5 个类别，训练集分为 160 帧，验证集分为 45 张图像。此外，作者于 2020 年发布了一个新的公开数据集，包含一个新的 Roof 类，也称为 UDD6。ManipalUAVid（Girisha 等，2019）是一个在关闭大学校园内收集的新无人机航拍视频数据集。它提供 33 个视频和 667 个关键帧，这些视频在一天内收集到六个地点。只有关键帧被精细注释为 4 个语义类别，包括建筑、绿地、道路和水体。最近，Lyu 等人（2020）发布了一个名为 UAVid 的高分辨率城市数据集。UAVid 最显著的特点是像素分布的严重类别失衡，这使得保持时间一致性和获得准确分割结果变得具有挑战性。需要注意的是，该数据集仅为视频中特定时间点的特定图像帧提供语义标签遮罩，而非整个视频序列。他们后续的作品增加了 12 个序列以加强原有 30 个视频序列，并发布了 42 个序列</p>\n<img data-src=\"../../images/paper/semantic_segmentation/7.png\" alt=\"1\"  />\n<p>DroneDeploy is a large-scale segmentation benchmark challenge that encourages state-of-the-art machine learning on aerial drone data. It consists of aerial orthomosaics and elevation images, and there are 55 tiles have been finely annotated into 6 categories. Inria Aerial Image Labeling Dataset (IAILD) (Maggiori et al., 2017) is another aerial dataset covering a wide range of urban landscapes with a spatial resolution of 30 cm. The 360 images, including 180 trading sets and 180 testing sets, have been annotated into two semantic classes. The scenes of different cities do not overlap in the training and testing sets, making it possible to powerfully validate the generalization of models for semantic segmentation.</p>\n<p>DroneDeploy 是一项大规模分割基准挑战赛，旨在鼓励对无人机航拍数据进行最先进的机器学习研究。该数据集包含航拍正射影像和高程图像，共有 55 个图块被精细标注为 6 个类别。Inria 航拍图像标注数据集（IAILD）（Maggiori 等人，2017）是另一个航拍数据集，覆盖了多种城市景观，空间分辨率为 30 厘米。该数据集包含 360 幅图像，包括 180 个训练集和 180 个测试集，均已标注为两个语义类别。训练集和测试集中的不同城市场景互不重叠，从而能够有力地验证语义分割模型的泛化能力。</p>\n<p>UAVs have received much attention in crack detection on highrise infrastructures due to their low budget and high efficiency. Yang et al. (2017) proposed the Concrete Structure Spalling and Crack (CSSC) database for automatic concrete inspection by UAVs, consisting of 278 spalling images and 954 crack images collected through web keyword search. Hong et al. (2021) relabeled the AerialCrackDetection dataset (Wang, 2017) that only provided bounding rectangles for crack detection. The proposed Highway Crack Dataset contains 1157 images with corresponding pixel-wise segmentation annotations. CrackUAS, a high-resolution crack dataset built by Arda et al. (2021), provided crack images with and without shell obstructions. In addition, the dataset containing synthetic images of surface cracks with shell obstructions enables researchers to verify the robustness of models and further validating their transfer learning performance. UAVs have also shown great potential for crop management, especially for tasks requiring human visual inspection, such as weed detection, lodging detection, and many others. Sa et al. (2017) released WeedNet, a multispectral (NR, Red channel, and NDVI) dataset with three semantic annotations, containing 132 crop images, 243 weeds images, and 90 crop-weeds mixtures. Another large-scale multispectral crop-weed dataset with 8 image modalities, called WeedMap Dataset (Sa et al., 2018) in this review, was proposed in their subsequent work. The spatial resolution of this dataset reached about 1 cm per pixel given the camera specification and flight altitude. To achieve precise crop mapping with hyperspectral feature space, Niu et al. (2022) acquired high-resolution images of 27 kinds of crops with a complex plantation structure based on UAV hyperspectral systems and then released the UAV-HSI-Crop dataset. The dataset is densely labeled with 29 classes, and the long-tail distribution of the pixel number histogram poses a great challenge for accurate crop mapping. In addition, the ease with which UAV sensors can provide high resolution is a unique advantage in infrastructure monitoring. The Massachusetts Dataset, published by Mnih (2013), contains 1711 road images and 151 building images at a spatial resolution of 100 cm. Since most datasets for road extractions from UAV images are not publicly available, the Massachusetts Roads Dataset (MRD) can be employed to validate the performance of UAV road extraction methods (Wang et al., 2021c). The Topo-boundary Dataset (Xu et al., 2021) is a largescale high-resolution road boundary extraction dataset applied to 8 sub-tasks. The dataset provides 25 295 optical images and eight pixellevel annotation labels. The most significant feature of this dataset is the imbalance between positive and negative sample pixels, which poses a significant challenge for the semantic segmentation of road boundaries. Besides, the heterogeneity in color intensity and significant variations in road width also curbed accurate segmentation of roads in high-resolution UAV images. Hence, Behera et al. (2023) built the NITRDrone dataset, which contains the occluded_road and vegetation classes in addition to the two commonly used binary semantic annotations of road and background. It presents more complex and diverse road context information due to its characteristics, such as occlusions, discontinuities, different viewpoints, and various road types.</p>\n<p>由于低成本和高效，无人机在高层基础设施的裂纹检测中备受关注。Yang 等人（2017）提出了混凝土结构剥落与裂缝（CSSC）数据库，用于无人机自动进行混凝土检查，包含 278 张剥落图像和 954 张裂纹图像，均通过网络关键词搜索收集。Hong 等人（2021）重新标记了仅提供边界矩形用于裂纹检测的 AerialCrackDetection 数据集（Wang， 2017）。拟议的公路裂缝数据集包含 1157 张图像及相应的像素分割注释。CrackUAS 是 Arda 等人（2021 年）构建的高分辨率裂纹数据集，提供了有壳体障碍和无壳体障碍的裂纹图像。此外，包含带有壳体障碍的表面裂纹合成图像的数据集，使研究人员能够验证模型的稳健性，并进一步验证其迁移学习性能。无人机在作物管理方面也展现出巨大潜力，尤其是在需要人工目视检查的任务中，如杂草检测、停泊检测等。Sa 等人（2017）发布了 WeedNet，这是一个多光谱（NR、红色通道和 NDVI）数据集，包含三个语义注释，包含 132 张裁剪图像、243 张杂草图像和 90 张裁剪 - 杂草混合图。他们在后续研究中提出了另一个具有 8 种图像模态的大规模多光谱作物 - 杂草数据集，称为 WeedMap 数据集（Sa 等，2018）。根据相机规格和飞行高度，该数据集的空间分辨率约为每像素 1 厘米。为了实现高光谱特征空间的精确作物映射，Niu 等人（2022）基于无人机高光谱系统，拍摄了 27 种具有复植结构作物的高分辨率图像，随后发布了无人机 - HSI - 作物数据集。该数据集密集地标注了 29 个类别，像素数直方图的长尾分布对准确的裁判映射构成了巨大挑战。此外，无人机传感器能够轻松提供高分辨率，这也是基础设施监测的独特优势。马萨诸塞州数据集由 Mnih（2013 年）发布，包含 1711 张道路图像和 151 张建筑图像，空间分辨率为 100 厘米。由于大多数无人机图像中道路提取的数据集尚未公开，马萨诸塞州道路数据集（MRD）可用于验证无人机道路提取方法的性能（Wang 等，2021c）。地形边界数据集（Xu 等，2021）是一个大规模高分辨率道路边界提取数据集，应用于 8 个子任务。该数据集提供 25,295 张光学图像和 8 个像素级注释标签。该数据集最重要的特点是正负样本像素的不平衡，这对道路边界的语义分割构成了重大挑战。此外，色彩强度的异质性和道路宽度的显著变化也限制了高分辨率无人机图像中道路的精确分割。因此，Behera 等人（2023）构建了 NITRDrone 数据集，该数据集除了常用的道路和背景这两个常用二进制语义注释外，还包含了 occluded_road 类和植被类。由于其特性，如阻塞、不连续、不同视角和多种道路类型，它呈现了更复杂和多样化的道路背景信息。</p>\n<p>In recent years, the rapid dispatch of UAVs has been an efficient approach for emergency response and damage assessment of disaster scenarios. Chowdhury et al. (2020) collected a natural disaster dataset (HRUD) based on a high-resolution UAV platform. The dataset provides 1973 images with 4 kinds of damage polygons based on damage levels. The dataset also provided semantic labels of 8 objects and background to annotate all damaged objects in an image. Their subsequent work released RescueNet (Chowdhury et al., 2022), a highresolution post-disaster dataset, for damage assessment after the natural disaster. The dataset is annotated in a similar format to HRUD, which consists of 4494 high-resolution UAV images with 11 categories of  pixel-level annotations of damaged objects. Rahnemoonfar et al. (2021) published a flood disaster assessment dataset (FloodNet) based on the UAV platform applied to damage classification, semantic segmentation, and visual question answering (VQA). It is the first dataset designed to simultaneously address three critical computer vision tasks, presenting new opportunities and challenges for disaster assessment. Furthermore, we found a dataset called FLAME (Shamsoshoara et al., 2021), which exhibits prescribed burnings of piled slash in the Arizona pine forest, to motivate advanced solutions for early fire detection and management. It provides 2003 image frames of video recordings and corresponding frame-level semantic annotations for the fully-supervised binary semantic segmentation.</p>\n<p>近年来，快速派遣无人机成为应急响应和灾害情景损害评估的高效方法。Chowdhury 等人（2020）基于高分辨率无人机平台收集了自然灾害数据集（HRUD）。该数据集提供了 1973 张图像，包含基于损伤等级的 4 种损坏多边形。数据集还提供了 8 个物体的语义标签，并用背景注释图像中所有受损物体。他们的后续工作发布了 RescueNet（Chowdhury 等，2022），这是一个高分辨率的灾后数据集，用于自然灾害后的损害评估。该数据集的注释格式与 HRUD 类似，后者包含 4494 张高分辨率无人机图像，包含 11 类像素级的受损物体注释。Rahnemoonfar 等人（2021）发表了基于无人机平台的洪水灾害评估数据集（FloodNet），该数据集应用于损害分类、语义分割和视觉问答（VQA）。这是首个同时设计用于解决三个关键计算机视觉任务的数据集，为灾害评估带来了新的机遇和挑战。此外，我们还发现了一个名为 FLAME 的数据集（Shamsoshoara 等，2021），该数据集展示了亚利桑那松林中桩柱的规定烧除，以激励早期火灾检测和管理的先进解决方案。它提供了 2003 帧视频录制的图像帧及相应的帧级语义注释，用于全监督二元语义分割。</p>\n<p>To quantify whether DL-based classifiers can imitate human experts and achieve higher accuracy in RGB fluvial scene classification on hyperspatial resolution airborne images, Carbonneau et al. (2020) released the 11 Rivers dataset, which comprises 305 hyperspatial (&lt;10 cm) resolution color imagery as well as corresponding label masks with 5 semantic classes. Wang and Mahmoudian (2023) created the Aerial River Image Dataset (AFID), which offers various perspectives of river scenes and focuses specifically on labeling water and waterborne obstacles. This dataset also suffers from imbalanced distribution in class pixel percentages and contains a small part of blurred images due to residual moisture on the camera lens surface. To promote studies on river ice monitoring based on DL technologies, Zhang et al. (2020d) released a publicly available UAV-based image dataset, called NWPU_YRCC, for river ice segmentation. This dataset provides 814 images captured by two UAVs in the region of the Yellow River with various appearances at different times, as well as three categories, including ice, water, and shore. To satisfy the training requirements of the neural network, they then added 74 images to the original dataset and renamed it NWPU_YRCC_EX. In their subsequent work (Zhang et al., 2021b), a new NWPU_YRCC2 dataset, which contains 1525 typical river ice images with different characteristics, was built for fine-grained river ice semantic segmentation. The new dataset puts more emphasis on distinguishing between drift ice and shore ice, and provides two other semantic categories, including water and other. In this section, we have introduced semantic segmentation datasets of UAV remote sensing images applied to different scenarios. In addition to optical UAV images, multispectral and hyperspectral modalities are gradually adopted in current UAV image acquisition tasks. Turning to 3D point cloud labeling, UAVs have also attracted attention in the semantic understanding of fine-grained geographic scenes. Researchers have already published relevant 3D point cloud datasets collected by UAVs, including The Hessigheim 3D (H3D) benchmark (Kölle et al., 2021), SensatUrban (Hu et al., 2021b), Swiss3DCities (Can et al., 2021), and many others. Recent publicly available UAV datasets suggest that the semantic segmentation on UAV-based platforms is trending towards sophisticated, multi-tasking, and multimodal.</p>\n<p>为了量化基于 DL 的分类器是否能模仿人类专家，并在高空间分辨率的空中图像上实现 RGB 河流场景分类的更高准确性，Carbonneau 等人（2020）发布了 11 Rivers 数据集，该数据集包含 305 张超空间（&lt;10 厘米）分辨率彩色图像及对应的标签掩码，包含 5 个语义类别。Wang 和 Mahmoudian（2023）创建了航拍河流图像数据集（AFID），提供了河流场景的多样视角，并特别关注水体及水上障碍物的标注。该数据集还存在类别像素百分比分布不平衡的问题，且由于相机镜头表面残留的湿气，图像出现了少量模糊。为促进基于 DL 技术的河川冰监测研究，Zhang 等人（2020d）发布了一项公开的基于无人机的图像数据集，称为 NWPU_YRCC，用于河川冰层切割。该数据集包含两架无人机在黄河地区拍摄的 814 张不同时间出现的图像，以及冰、水、岸三类。为了满足神经网络的训练需求，他们向原始数据集添加了 74 张图像并将其更名为 NWPU_YRCC_EX。在他们后续的工作中（Zhang 等，2021b），构建了一个新的 NWPU_YRCC2 数据集，包含 1525 张具有不同特征的典型河流冰图像，用于细粒度河川冰语义分割。新数据集更强调区分漂流冰和岸冰，并提供了另外两个语义类别，包括水和其他。本节介绍了应用于不同场景的无人机遥感图像语义分割数据集。除了光学无人机图像外，多光谱和高光谱模态也逐渐被应用于当前无人机图像采集任务中。转向三维点云标记，无人机在细粒度地理场景的语义理解中也受到关注。研究人员已经发布了由无人机收集的相关三维点云数据集，包括赫西格海姆 3D（H3D）基准测试（Kölle 等，2021）、SensatUrban（胡等，2021b）、Swiss3DCities（Can 等，2021）等。近期公开的无人机数据集表明，基于无人机平台的语义分割正趋向于复杂化、多任务处理和多模态化。</p>\n<h2 id=\"evaluations-and-comparisons\"><a class=\"markdownIt-Anchor\" href=\"#evaluations-and-comparisons\">#</a> Evaluations and comparisons</h2>\n<p>评估与比较</p>\n<p>Evaluation metrics are necessary to assess the effectiveness and reliability of semantic segmentation methods for UAV remote sensing images. Commonly used evaluation metrics evaluating the accuracy of semantic segmentation methods consist of overall accuracy (OA), mean intersection over union (mIoU) (Eigen and Fergus, 2015; Yu et al., 2018b), Precision, Recall, and F1-score. Due to the distinctions in features, datasets, algorithms, or tricks, it is tough to demonstrate which methods are better than others by comparing published papers directly. Hence, we conduct comparative experiments to evaluate the semantic segmentation accuracy of representative methods according to OA, mIoU, and F1-score on two recent UAV-based RGB image datasets from different scenarios, including the UAVid dataset and the FloodNet dataset. In addition, we adopt the number of parameters, Multiply-Accumulate Operations (MACs), and Frames Per Second (FPS) to evaluate the model inference efficiency, considering the necessity of loading the model onto the airborne device for real-time image processing.</p>\n<p>评估指标对于评估无人机遥感图像语义分割方法的有效性和可靠性是必要的。常用的评估指标包括整体准确率（OA）、平均交集与并集（mIoU）（Eigen 和 Fergus，2015;Yu 等，2018b）、精确度、回忆和 F1 评分。由于特征、数据集、算法或技巧的差异，直接比较已发表论文很难证明哪些方法优于其他方法。因此，我们进行了比较实验，评估代表性方法根据 OA、mIoU 和 F1 评分，针对两个来自不同场景的无人机 RGB 图像数据集（包括 UAVid 数据集和 FloodNet 数据集）的语义分割准确性。此外，我们采用参数数量、乘法累加作（MACs）和每秒帧数（FPS）来评估模型推理效率，同时考虑将模型加载到机载设备进行实时图像处理的必要性。</p>\n",
            "tags": [
                "深度学习",
                "论文阅读",
                "python",
                "深度学习",
                "分割方法与数据集",
                "语义分割",
                "综述",
                "遥感图像"
            ]
        },
        {
            "id": "https://735690757.github.io/python/fastapi/",
            "url": "https://735690757.github.io/python/fastapi/",
            "title": "FastAPI",
            "date_published": "2026-01-12T02:20:00.000Z",
            "content_html": "<h1 id=\"fastapi\"><a class=\"markdownIt-Anchor\" href=\"#fastapi\">#</a> FastAPI</h1>\n<p>FastAPI 是一个用于构建 Web 应用的 Python 框架。</p>\n<h2 id=\"天生非阻塞\"><a class=\"markdownIt-Anchor\" href=\"#天生非阻塞\">#</a> 天生非阻塞</h2>\n<img data-src=\"../../images/exp/fastapi/1.png\" alt=\"1\" style=\"zoom: 80%;\" />\n<img data-src=\"../../images/exp/fastapi/2.png\" alt=\"1\" style=\"zoom: 80%;\" />\n<h2 id=\"类型提示与验证\"><a class=\"markdownIt-Anchor\" href=\"#类型提示与验证\">#</a> 类型提示与验证</h2>\n<img data-src=\"../../images/exp/fastapi/3.png\" alt=\"1\" style=\"zoom: 80%;\" />\n<h2 id=\"自带交互式文档\"><a class=\"markdownIt-Anchor\" href=\"#自带交互式文档\">#</a> 自带交互式文档</h2>\n<img data-src=\"../../images/exp/fastapi/4.png\" alt=\"1\" style=\"zoom: 80%;\" />\n<h2 id=\"快速开始\"><a class=\"markdownIt-Anchor\" href=\"#快速开始\">#</a> 快速开始</h2>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span> fastapi <span class=\"token keyword\">import</span> FastAPI</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 创建一个 FastAPI 实例</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>app <span class=\"token operator\">=</span> FastAPI<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">root</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"message\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Hello World\"</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/hello/&#123;name&#125;\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">say_hello</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"message\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"Hello </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>name<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"启动命令\"><a class=\"markdownIt-Anchor\" href=\"#启动命令\">#</a> 启动命令</h3>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>uvicorn main:app <span class=\"token parameter variable\">--reload</span></pre></td></tr></table></figure><p>uvicorn？<strong> <code>uvicorn</code>  是一个高性能的 Python ASGI Web 服务器</strong>，专门用来运行 <strong>FastAPI / Starlette / Django ASGI</strong> 这类现代 Web 框架。</p>\n<p>–reload？支持热部署。</p>\n<h3 id=\"结果\"><a class=\"markdownIt-Anchor\" href=\"#结果\">#</a> 结果</h3>\n<img data-src=\"../../images/exp/fastapi/5.png\" alt=\"1\" style=\"zoom: 80%;\" />\n<img data-src=\"../../images/exp/fastapi/6.png\" alt=\"1\" style=\"zoom: 80%;\" />\n<img data-src=\"../../images/exp/fastapi/7.png\" alt=\"1\" style=\"zoom: 80%;\" />\n<h2 id=\"python-装饰器\"><a class=\"markdownIt-Anchor\" href=\"#python-装饰器\">#</a> Python 装饰器</h2>\n<p>在不改原函数代码的情况下，给函数外挂一层功能。</p>\n<h3 id=\"java-注解本身只是个标签\"><a class=\"markdownIt-Anchor\" href=\"#java-注解本身只是个标签\">#</a> Java 注解本身只是个标签</h3>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/hello\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">hello</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token string\">\"hi\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>@GetMapping</code>  本身不拦截，不执行，不改方法，真正干活的是 <strong>Spring 框架 + 反射 + AOP</strong></p>\n<h3 id=\"python-装饰器是可执行的\"><a class=\"markdownIt-Anchor\" href=\"#python-装饰器是可执行的\">#</a> Python 装饰器是可执行的</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">log</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">wrapper</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"before\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">return</span> func<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">return</span> wrapper</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token decorator annotation punctuation\">@log</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">hello</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hi\"</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>等价于：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>hello <span class=\"token operator\">=</span> log<span class=\"token punctuation\">(</span>hello<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p><strong>这里已经执行代码了</strong></p>\n<h2 id=\"路由\"><a class=\"markdownIt-Anchor\" href=\"#路由\">#</a> 路由</h2>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/hello/\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">say_hello</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"message\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Hello World 这是默输出\"</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这是一个 get 方法，通过 <code>@app.get</code>  装饰。</p>\n<h2 id=\"接口的动态交互\"><a class=\"markdownIt-Anchor\" href=\"#接口的动态交互\">#</a> 接口的动态交互</h2>\n<p>路径参数写在 URL 路径里，用来<strong>标识具体资源</strong></p>\n<p>查询参数写在 URL  <code>?</code>  后面，用来<strong>筛选 / 附加条件</strong></p>\n<p>请求体参数放在请求体中，用来<strong>提交复杂数据</strong></p>\n<h3 id=\"路径参数\"><a class=\"markdownIt-Anchor\" href=\"#路径参数\">#</a> 路径参数</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/book/&#123;id&#125;\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">getBook</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token string\">\"id\"</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token string\">\"title\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"FastAPI book-</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"校验大小校验与长度校验\"><a class=\"markdownIt-Anchor\" href=\"#校验大小校验与长度校验\">#</a> 校验 —— 大小校验与长度校验</h4>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/book/&#123;id&#125;\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">getBook</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span> <span class=\"token operator\">=</span> Path<span class=\"token punctuation\">(</span>description<span class=\"token operator\">=</span><span class=\"token string\">\"The ID of the book to get\"</span><span class=\"token punctuation\">,</span> gt<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> lt<span class=\"token operator\">=</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token string\">\"id\"</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token string\">\"title\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"FastAPI book-</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/classify/&#123;name&#125;\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">classify</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token operator\">=</span>Path<span class=\"token punctuation\">(</span>title<span class=\"token operator\">=</span><span class=\"token string\">\"classify\"</span><span class=\"token punctuation\">,</span> min_length<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> max_length<span class=\"token operator\">=</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> name<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token string\">\"class\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"FastAPI\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"查询参数\"><a class=\"markdownIt-Anchor\" href=\"#查询参数\">#</a> 查询参数</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/query_book\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">query_book</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        classify<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span> <span class=\"token operator\">=</span> Query<span class=\"token punctuation\">(</span><span class=\"token string\">\"默认分类\"</span><span class=\"token punctuation\">,</span> min_length<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> max_length<span class=\"token operator\">=</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        price<span class=\"token punctuation\">:</span> <span class=\"token builtin\">float</span> <span class=\"token operator\">=</span> Query<span class=\"token punctuation\">(</span><span class=\"token number\">10.0</span><span class=\"token punctuation\">,</span> gt<span class=\"token operator\">=</span><span class=\"token number\">50.0</span><span class=\"token punctuation\">,</span> le<span class=\"token operator\">=</span><span class=\"token number\">100.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token string\">\"classify\"</span><span class=\"token punctuation\">:</span> classify<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token string\">\"price\"</span><span class=\"token punctuation\">:</span> price</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"请求体参数\"><a class=\"markdownIt-Anchor\" href=\"#请求体参数\">#</a> 请求体参数</h3>\n<p>使用 pydantic。</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span> pydantic <span class=\"token keyword\">import</span> BaseModel</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span>BaseModel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    username<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    password<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>post</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/register\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">:</span> User<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">return</span> user</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">Book</span><span class=\"token punctuation\">(</span>BaseModel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    title<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    author<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    publisher<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    price<span class=\"token punctuation\">:</span> <span class=\"token builtin\">float</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>post</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/book/add\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">add_book</span><span class=\"token punctuation\">(</span>book<span class=\"token punctuation\">:</span> Book<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">return</span> book</pre></td></tr></table></figure><p>请求体参数的约束：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span>BaseModel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    username<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span> <span class=\"token operator\">=</span> Field<span class=\"token punctuation\">(</span>default<span class=\"token operator\">=</span><span class=\"token string\">\"默认用户名\"</span><span class=\"token punctuation\">,</span> min_length<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> max_length<span class=\"token operator\">=</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> description<span class=\"token operator\">=</span><span class=\"token string\">\"用户名\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    password<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span> <span class=\"token operator\">=</span> Field<span class=\"token punctuation\">(</span>default<span class=\"token operator\">=</span><span class=\"token string\">\"默认密码\"</span><span class=\"token punctuation\">,</span> min_length<span class=\"token operator\">=</span><span class=\"token number\">6</span><span class=\"token punctuation\">,</span> max_length<span class=\"token operator\">=</span><span class=\"token number\">20</span><span class=\"token punctuation\">,</span> description<span class=\"token operator\">=</span><span class=\"token string\">\"密码\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>post</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/register\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">:</span> User<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">return</span> user</pre></td></tr></table></figure><h2 id=\"响应类型\"><a class=\"markdownIt-Anchor\" href=\"#响应类型\">#</a> 响应类型</h2>\n<p>通过<strong> response_class</strong> 指定</p>\n<img data-src=\"../../images/exp/fastapi/8.png\" alt=\"1\" style=\"zoom: 80%;\" />\n<h3 id=\"json\"><a class=\"markdownIt-Anchor\" href=\"#json\">#</a> JSON</h3>\n<p>这个你返回一个字典对象的时候，FastAPI 就自动帮你做好转换了。</p>\n<h3 id=\"html-纯文本\"><a class=\"markdownIt-Anchor\" href=\"#html-纯文本\">#</a> HTML / 纯文本</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/html\"</span><span class=\"token punctuation\">,</span>response_class<span class=\"token operator\">=</span>HTMLResponse<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">html</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token triple-quoted-string string\">\"\"\"</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    &lt;html></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        &lt;head></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            &lt;title>FastAPI&lt;/title></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        &lt;/head></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        &lt;body></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            &lt;h1>Hello World&lt;/h1></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        &lt;/body></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    &lt;/html></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    \"\"\"</span></pre></td></tr></table></figure><h3 id=\"file文件\"><a class=\"markdownIt-Anchor\" href=\"#file文件\">#</a> File 文件</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/file\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">file</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    path <span class=\"token operator\">=</span> <span class=\"token string\">\"./files/dd.txt\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">return</span> FileResponse<span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h2 id=\"自定义响应类型\"><a class=\"markdownIt-Anchor\" href=\"#自定义响应类型\">#</a> 自定义响应类型</h2>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">R</span><span class=\"token punctuation\">(</span>BaseModel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    code<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    msg<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    data<span class=\"token punctuation\">:</span> <span class=\"token builtin\">dict</span> <span class=\"token operator\">=</span> Field<span class=\"token punctuation\">(</span>default<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> description<span class=\"token operator\">=</span><span class=\"token string\">\"返回数据\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/api\"</span><span class=\"token punctuation\">,</span> response_model<span class=\"token operator\">=</span>R<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">api</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token string\">\"code\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token string\">\"msg\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"success\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token string\">\"data\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"KarryLiu\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token string\">\"age\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">18</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>当你缺失数据时会报错，当你数据超出约定时会自动过滤掉。</p>\n<h2 id=\"异常处理\"><a class=\"markdownIt-Anchor\" href=\"#异常处理\">#</a> 异常处理</h2>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/api/news\"</span><span class=\"token punctuation\">,</span> response_model<span class=\"token operator\">=</span>R<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">api_news</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span> <span class=\"token operator\">=</span> Query<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> gt<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> lt<span class=\"token operator\">=</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    news_list <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token builtin\">id</span> <span class=\"token keyword\">not</span> <span class=\"token keyword\">in</span> news_list<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">raise</span> HTTPException<span class=\"token punctuation\">(</span>status_code<span class=\"token operator\">=</span><span class=\"token number\">404</span><span class=\"token punctuation\">,</span> detail<span class=\"token operator\">=</span><span class=\"token string\">\"新闻不存在\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token string\">\"code\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token string\">\"msg\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"success\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token string\">\"data\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token string\">\"id\"</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token string\">\"title\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"新闻标题-</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token string\">\"content\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"新闻内容-</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"中间件\"><a class=\"markdownIt-Anchor\" href=\"#中间件\">#</a> 中间件</h2>\n<p>中间件给每一个请求提供统一的处理逻辑。使用 <code>@app.middleware(&quot;http&quot;)</code>  来定义。<mark>多个中间件是自底向上执行的</mark></p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>middleware</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"http\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">middleware1</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> call_next<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"中间件1开始执行\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> call_next<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"中间件1结束执行\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">return</span> response</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>middleware</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"http\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">middleware2</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> call_next<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"中间件2开始执行\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> call_next<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"中间件2结束执行\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">return</span> response</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/api/mid\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">api_mid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token string\">\"code\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token string\">\"msg\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"success\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token string\">\"data\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"KarryLiu\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token string\">\"age\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">18</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><img data-src=\"../../images/exp/fastapi/9.png\" alt=\"1\" style=\"zoom: 80%;\" />\n<p>居然是自底向上执行的</p>\n<h2 id=\"依赖注入\"><a class=\"markdownIt-Anchor\" href=\"#依赖注入\">#</a> 依赖注入</h2>\n<img data-src=\"../../images/exp/fastapi/10.png\" alt=\"1\" style=\"zoom: 80%;\" />\n<img data-src=\"../../images/exp/fastapi/11.png\" alt=\"1\" style=\"zoom: 80%;\" />\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">common_parameters</span><span class=\"token punctuation\">(</span>skip<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> limit<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span> <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"skip\"</span><span class=\"token punctuation\">:</span> skip<span class=\"token punctuation\">,</span> <span class=\"token string\">\"limit\"</span><span class=\"token punctuation\">:</span> limit<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/api/news_list\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">get_news_list</span><span class=\"token punctuation\">(</span>commons<span class=\"token operator\">=</span>Depends<span class=\"token punctuation\">(</span>common_parameters<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"msg\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"news_list\"</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"api/user_list\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">get_user_list</span><span class=\"token punctuation\">(</span>commons<span class=\"token operator\">=</span>Depends<span class=\"token punctuation\">(</span>common_parameters<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"msg\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"user_list\"</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>common_parameters</code>  里  <code>return &#123;&quot;skip&quot;: skip, &quot;limit&quot;: limit&#125;</code>  <strong>返回值不会直接返回给客户端</strong>， 而是 <strong>作为参数值，传给  <code>get_news_list</code>  里的  <code>commons</code>  变量</strong>。我们可以打印一下：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/api/news_list\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">get_news_list</span><span class=\"token punctuation\">(</span>commons<span class=\"token operator\">=</span>Depends<span class=\"token punctuation\">(</span>common_parameters<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>commons<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>commons<span class=\"token punctuation\">[</span><span class=\"token string\">\"skip\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>commons<span class=\"token punctuation\">[</span><span class=\"token string\">\"limit\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"msg\"</span><span class=\"token punctuation\">:</span> \"news_list</pre></td></tr></table></figure><img data-src=\"../../images/exp/fastapi/12.png\" alt=\"1\" style=\"zoom: 80%;\" />\n<h2 id=\"orm工具sqlalchemy\"><a class=\"markdownIt-Anchor\" href=\"#orm工具sqlalchemy\">#</a> ORM 工具 ——SQLAlchemy</h2>\n<h3 id=\"安装sqlalchemyasyncio和aiomysql\"><a class=\"markdownIt-Anchor\" href=\"#安装sqlalchemyasyncio和aiomysql\">#</a> 安装 sqlalchemy [asyncio] 和 aiomysql</h3>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pip <span class=\"token function\">install</span> sqlalchemy<span class=\"token punctuation\">[</span>asyncio<span class=\"token punctuation\">]</span> aiomysql</pre></td></tr></table></figure><h3 id=\"自动建表\"><a class=\"markdownIt-Anchor\" href=\"#自动建表\">#</a> 自动建表</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ASYNC_DATABASE_URL <span class=\"token operator\">=</span> <span class=\"token string\">\"mysql+aiomysql://root:123456@localhost:3306/fastapi_first?charsetutf-8\"</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>engine <span class=\"token operator\">=</span> create_async_engine<span class=\"token punctuation\">(</span>ASYNC_DATABASE_URL<span class=\"token punctuation\">,</span> echo<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> pool_size<span class=\"token operator\">=</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> max_overflow<span class=\"token operator\">=</span><span class=\"token number\">20</span><span class=\"token punctuation\">,</span> pool_recycle<span class=\"token operator\">=</span><span class=\"token number\">3600</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                             pool_pre_ping<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> pool_use_lifo<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> pool_timeout<span class=\"token operator\">=</span><span class=\"token number\">30</span><span class=\"token punctuation\">,</span> future<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">Base</span><span class=\"token punctuation\">(</span>DeclarativeBase<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    create_time<span class=\"token punctuation\">:</span> Mapped<span class=\"token punctuation\">[</span>datetime<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> mapped_column<span class=\"token punctuation\">(</span>DateTime<span class=\"token punctuation\">,</span> insert_default<span class=\"token operator\">=</span>func<span class=\"token punctuation\">.</span>now<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> comment<span class=\"token operator\">=</span><span class=\"token string\">\"创建时间\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    update_time<span class=\"token punctuation\">:</span> Mapped<span class=\"token punctuation\">[</span>datetime<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> mapped_column<span class=\"token punctuation\">(</span>DateTime<span class=\"token punctuation\">,</span> insert_default<span class=\"token operator\">=</span>func<span class=\"token punctuation\">.</span>now<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> comment<span class=\"token operator\">=</span><span class=\"token string\">\"更新时间\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">Book</span><span class=\"token punctuation\">(</span>Base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    __tablename__ <span class=\"token operator\">=</span> <span class=\"token string\">\"book\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token builtin\">id</span><span class=\"token punctuation\">:</span> Mapped<span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> mapped_column<span class=\"token punctuation\">(</span>primary_key<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> autoincrement<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> comment<span class=\"token operator\">=</span><span class=\"token string\">\"ID\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    title<span class=\"token punctuation\">:</span> Mapped<span class=\"token punctuation\">[</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> mapped_column<span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> comment<span class=\"token operator\">=</span><span class=\"token string\">\"标题\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    author<span class=\"token punctuation\">:</span> Mapped<span class=\"token punctuation\">[</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> mapped_column<span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">(</span><span class=\"token number\">50</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> comment<span class=\"token operator\">=</span><span class=\"token string\">\"作者\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    publisher<span class=\"token punctuation\">:</span> Mapped<span class=\"token punctuation\">[</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> mapped_column<span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> comment<span class=\"token operator\">=</span><span class=\"token string\">\"出版社\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    price<span class=\"token punctuation\">:</span> Mapped<span class=\"token punctuation\">[</span><span class=\"token builtin\">float</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> mapped_column<span class=\"token punctuation\">(</span>Float<span class=\"token punctuation\">,</span> comment<span class=\"token operator\">=</span><span class=\"token string\">\"价格\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span>Base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    __tablename__ <span class=\"token operator\">=</span> <span class=\"token string\">\"user\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token builtin\">id</span><span class=\"token punctuation\">:</span> Mapped<span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> mapped_column<span class=\"token punctuation\">(</span>primary_key<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> autoincrement<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> comment<span class=\"token operator\">=</span><span class=\"token string\">\"ID\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    username<span class=\"token punctuation\">:</span> Mapped<span class=\"token punctuation\">[</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> mapped_column<span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">(</span><span class=\"token number\">50</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> comment<span class=\"token operator\">=</span><span class=\"token string\">\"用户名\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    password<span class=\"token punctuation\">:</span> Mapped<span class=\"token punctuation\">[</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> mapped_column<span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">(</span><span class=\"token number\">50</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> comment<span class=\"token operator\">=</span><span class=\"token string\">\"密码\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">create_table</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token keyword\">async</span> <span class=\"token keyword\">with</span> engine<span class=\"token punctuation\">.</span>begin<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> conn<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token keyword\">await</span> conn<span class=\"token punctuation\">.</span>run_sync<span class=\"token punctuation\">(</span>Base<span class=\"token punctuation\">.</span>metadata<span class=\"token punctuation\">.</span>create_all<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token decorator annotation punctuation\">@asynccontextmanager</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">lifespan</span><span class=\"token punctuation\">(</span>apps<span class=\"token punctuation\">:</span> FastAPI<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token keyword\">await</span> create_table<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token keyword\">yield</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token keyword\">await</span> engine<span class=\"token punctuation\">.</span>dispose<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>app <span class=\"token operator\">=</span> FastAPI<span class=\"token punctuation\">(</span>lifespan<span class=\"token operator\">=</span>lifespan<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><img data-src=\"../../images/exp/fastapi/13.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<h3 id=\"orm依赖注入与数据查询\"><a class=\"markdownIt-Anchor\" href=\"#orm依赖注入与数据查询\">#</a> ORM 依赖注入与数据查询</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>AsyncSessionLocal <span class=\"token operator\">=</span> async_sessionmaker<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    engine<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    class_<span class=\"token operator\">=</span>AsyncSession<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    expire_on_commit<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">get_database</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">async</span> <span class=\"token keyword\">with</span> AsyncSessionLocal<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> session<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token keyword\">yield</span> session</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token keyword\">await</span> session<span class=\"token punctuation\">.</span>commit<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">except</span> Exception <span class=\"token keyword\">as</span> e<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token keyword\">await</span> session<span class=\"token punctuation\">.</span>rollback<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token keyword\">raise</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">finally</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token keyword\">await</span> session<span class=\"token punctuation\">.</span>close<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/book/books\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">get_books</span><span class=\"token punctuation\">(</span>session<span class=\"token punctuation\">:</span> AsyncSession <span class=\"token operator\">=</span> Depends<span class=\"token punctuation\">(</span>get_database<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    query <span class=\"token operator\">=</span> select<span class=\"token punctuation\">(</span>Book<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> session<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    books <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>scalars<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>books<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">return</span> books</pre></td></tr></table></figure><img data-src=\"../../images/exp/fastapi/14.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<h3 id=\"查询\"><a class=\"markdownIt-Anchor\" href=\"#查询\">#</a> 查询</h3>\n<h4 id=\"比较判断\"><a class=\"markdownIt-Anchor\" href=\"#比较判断\">#</a> 比较判断</h4>\n<p>==；&gt;；&lt;；&gt;=；&lt;=</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/book/book/&#123;id&#125;\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">get_book</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> session<span class=\"token punctuation\">:</span> AsyncSession <span class=\"token operator\">=</span> Depends<span class=\"token punctuation\">(</span>get_database<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    query <span class=\"token operator\">=</span> select<span class=\"token punctuation\">(</span>Book<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>where<span class=\"token punctuation\">(</span>Book<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span> <span class=\"token operator\">==</span> <span class=\"token builtin\">id</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> session<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    book <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>scalars<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>first<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">return</span> book</pre></td></tr></table></figure><figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/book/book/&#123;id&#125;\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">get_book</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> session<span class=\"token punctuation\">:</span> AsyncSession <span class=\"token operator\">=</span> Depends<span class=\"token punctuation\">(</span>get_database<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    query <span class=\"token operator\">=</span> select<span class=\"token punctuation\">(</span>Book<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>where<span class=\"token punctuation\">(</span>Book<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span> <span class=\"token operator\">==</span> <span class=\"token builtin\">id</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> session<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    book <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>scalars<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>one_or_none<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">return</span> book</pre></td></tr></table></figure><h4 id=\"模糊查询\"><a class=\"markdownIt-Anchor\" href=\"#模糊查询\">#</a> 模糊查询</h4>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/book/like\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">get_like_book</span><span class=\"token punctuation\">(</span>title<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span> session<span class=\"token punctuation\">:</span> AsyncSession <span class=\"token operator\">=</span> Depends<span class=\"token punctuation\">(</span>get_database<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    query <span class=\"token operator\">=</span> select<span class=\"token punctuation\">(</span>Book<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>where<span class=\"token punctuation\">(</span>Book<span class=\"token punctuation\">.</span>title<span class=\"token punctuation\">.</span>like<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"%</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>title<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">%\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> session<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    book <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>scalars<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">return</span> book</pre></td></tr></table></figure><img data-src=\"../../images/exp/fastapi/15.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<h4 id=\"取首条数据\"><a class=\"markdownIt-Anchor\" href=\"#取首条数据\">#</a> 取首条数据</h4>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/book/first\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">get_first_book</span><span class=\"token punctuation\">(</span>session<span class=\"token punctuation\">:</span> AsyncSession <span class=\"token operator\">=</span> Depends<span class=\"token punctuation\">(</span>get_database<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    query <span class=\"token operator\">=</span> select<span class=\"token punctuation\">(</span>Book<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> session<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    book <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>scalars<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>first<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">return</span> book</pre></td></tr></table></figure><h4 id=\"多条件\"><a class=\"markdownIt-Anchor\" href=\"#多条件\">#</a> 多条件</h4>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/book/like_start\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">get_like_start_book</span><span class=\"token punctuation\">(</span>title<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span> session<span class=\"token punctuation\">:</span> AsyncSession <span class=\"token operator\">=</span> Depends<span class=\"token punctuation\">(</span>get_database<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    query <span class=\"token operator\">=</span> select<span class=\"token punctuation\">(</span>Book<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>where<span class=\"token punctuation\">(</span>Book<span class=\"token punctuation\">.</span>title<span class=\"token punctuation\">.</span>like<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>title<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">%\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>where<span class=\"token punctuation\">(</span>Book<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span> <span class=\"token operator\">==</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> session<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    book <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>scalars<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">return</span> book</pre></td></tr></table></figure><h4 id=\"聚合查询\"><a class=\"markdownIt-Anchor\" href=\"#聚合查询\">#</a> 聚合查询</h4>\n<p>func——count / avg / max / min / sum</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/book/get_avg_price\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">get_avg_price</span><span class=\"token punctuation\">(</span>session<span class=\"token punctuation\">:</span> AsyncSession <span class=\"token operator\">=</span> Depends<span class=\"token punctuation\">(</span>get_database<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    query <span class=\"token operator\">=</span> select<span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">.</span>avg<span class=\"token punctuation\">(</span>Book<span class=\"token punctuation\">.</span>price<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> session<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    avg_price <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>scalars<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>one<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">return</span> avg_price</pre></td></tr></table></figure><img data-src=\"../../images/exp/fastapi/16.png\" alt=\"1\" style=\"zoom: 100%;\" />\n<img data-src=\"../../images/exp/fastapi/17.png\" alt=\"1\" style=\"zoom: 100%;\" />\n",
            "tags": [
                "开发经验",
                "python",
                "Fast API"
            ]
        },
        {
            "id": "https://735690757.github.io/python/v2yWdtc/",
            "url": "https://735690757.github.io/python/v2yWdtc/",
            "title": "v2yWdtc：无聊写了一个格式转换工具",
            "date_published": "2026-01-10T04:12:12.000Z",
            "content_html": "<h1 id=\"v2ywdtc\"><a class=\"markdownIt-Anchor\" href=\"#v2ywdtc\">#</a> v2yWdtc</h1>\n<p>v2yWdtc 是我无聊编写的一款将 VOC 格式转换为 YOLO 格式的工具，它的构成非常简单，尽管如此它很强大，它可以辅助你分析你的数据集是否有异常的数据，同时针对空标签还有过滤功能。</p>\n<ul>\n<li><strong>快速转换</strong>：一键将 VOC 格式标签转换为 YOLO 格式。</li>\n<li><strong>数据预检测</strong>：统计数据集，辅助你发现异常标签或标注问题。</li>\n<li><strong>空标签过滤</strong>：自动过滤空标签，保证训练数据质量。</li>\n<li><strong>简单易用</strong>：无需复杂配置，几步操作即可完成数据预处理。</li>\n</ul>\n<h2 id=\"开源地址-\"><a class=\"markdownIt-Anchor\" href=\"#开源地址-\">#</a> 开源地址 - ⭐！</h2>\n<p><mark>v2yWdtc</mark>：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tLzczNTY5MDc1Ny92MnlXZHRj\">https://github.com/735690757/v2yWdtc</span></p>\n<h2 id=\"项目结构\"><a class=\"markdownIt-Anchor\" href=\"#项目结构\">#</a> 项目结构</h2>\n<table>\n<thead>\n<tr>\n<th><strong>目录 / 文件</strong></th>\n<th><strong>核心职能说明</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong> <code>Annotations/</code> </strong></td>\n<td><strong>原始标签存放地</strong>。通常存放标准的 XML 格式文件，包含目标类别和边界框坐标。</td>\n</tr>\n<tr>\n<td><strong> <code>Imagesets/</code> </strong></td>\n<td><strong>数据集索引中心</strong>。存放  <code>train.txt</code> ,  <code>val.txt</code> ,  <code>test.txt</code>  等。之前的报错正是因为程序无法在此找到这些索引文件。</td>\n</tr>\n<tr>\n<td><strong> <code>JPEGImages/</code> </strong></td>\n<td><strong>原始图像库</strong>。存放所有训练和测试用的图片（  <code>.jpg</code>  格式）。</td>\n</tr>\n<tr>\n<td><strong> <code>Tools/</code> </strong></td>\n<td><strong>数据诊断工具箱</strong>。包含用于分析数据集质量的脚本（如  <code>check.py</code>  检查完整性， <code>cbox.py</code>  分析边界框分布）。</td>\n</tr>\n<tr>\n<td><strong> <code>images_tag.py</code> </strong></td>\n<td><strong>标签处理模块</strong>。可能涉及图像标注的自动化处理或类别名称映射。</td>\n</tr>\n<tr>\n<td><strong> <code>imgsWlabels.py</code> </strong></td>\n<td><strong>数据分发引擎</strong>。负责根据索引文件将图片和转换后的标签文件分发到指定的训练 / 验证文件夹中。</td>\n</tr>\n<tr>\n<td><strong> <code>main.py</code> </strong></td>\n<td><strong>项目总入口</strong>。一键化操作的控制台，通过调用其他模块完成全流程转换。</td>\n</tr>\n<tr>\n<td><strong> <code>voc_to_yolo.py</code> </strong></td>\n<td><strong>格式转换核心</strong>。执行最关键的 XML 到 TXT 归一化转换逻辑。</td>\n</tr>\n</tbody>\n</table>\n<img data-src=\"../../images/python/v2yWdtc/1.png\" alt=\"v1\"  />\n<h2 id=\"train与val模式-trainval模式\"><a class=\"markdownIt-Anchor\" href=\"#train与val模式-trainval模式\">#</a> train 与 val 模式、trainval 模式</h2>\n<p>切换模式只需要修改 main.py 的此处：</p>\n<img data-src=\"../../images/python/v2yWdtc/2.png\" alt=\"v1\" style=\"zoom: 67%;\" />\n<h3 id=\"train与val模式0模式默认模式\"><a class=\"markdownIt-Anchor\" href=\"#train与val模式0模式默认模式\">#</a> train 与 val 模式（0 模式）（默认模式）</h3>\n<p>在这种模式下，数据集被分为三个部分：训练集、验证集、测试集，这种模式的特点是：<strong>训练集和验证集是分开的</strong>，避免数据泄露，确保模型的泛化能力。</p>\n<h3 id=\"trainval模式1模式\"><a class=\"markdownIt-Anchor\" href=\"#trainval模式1模式\">#</a> trainval 模式（1 模式）</h3>\n<p>在 <strong>trainval</strong> 模式下，训练集和验证集被合并为一个整体的数据集，模型在整个  <code>trainval</code>  数据集上进行训练和验证。这种模式通常用于特定的任务，例如数据量不大时，可以通过合并训练集和验证集来提升训练集的多样性和大小。</p>\n<h2 id=\"使用方法\"><a class=\"markdownIt-Anchor\" href=\"#使用方法\">#</a> 使用方法</h2>\n<ol>\n<li>将图片数据放在 JPEGImages 下</li>\n<li>将 xml 放在 Annotation 下</li>\n<li>执行主函数</li>\n<li>ok 了就</li>\n</ol>\n<h2 id=\"执行过程\"><a class=\"markdownIt-Anchor\" href=\"#执行过程\">#</a> 执行过程</h2>\n<img data-src=\"../../images/python/v2yWdtc/3.png\" alt=\"v1\" style=\"zoom: 67%;\" />\n<h2 id=\"结果文件\"><a class=\"markdownIt-Anchor\" href=\"#结果文件\">#</a> 结果文件</h2>\n<img data-src=\"../../images/python/v2yWdtc/5.png\" alt=\"v1\" style=\"zoom: 67%;\" />\n<p>紫色输出结果是图片（训练、验证、测试）和标签（训练、验证、测试）</p>\n<p>白色输出结果是这样的索引记录格式：</p>\n<img data-src=\"../../images/python/v2yWdtc/6.png\" alt=\"v1\" style=\"zoom: 67%;\" />\n<h2 id=\"参考开源脚本\"><a class=\"markdownIt-Anchor\" href=\"#参考开源脚本\">#</a> 参考开源脚本</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0ppZVp6em9vL0RhdGFfVHJhbnM=\">https://github.com/JieZzzoo/Data_Trans</span></p>\n",
            "tags": [
                "深度学习",
                "项目与实战",
                "python"
            ]
        },
        {
            "id": "https://735690757.github.io/python/YOLO/YOLOv3_ultralytics/",
            "url": "https://735690757.github.io/python/YOLO/YOLOv3_ultralytics/",
            "title": "ultralytics YOLOv3",
            "date_published": "2026-01-08T04:12:12.000Z",
            "content_html": "<h1 id=\"yolov3-ultralytics\"><a class=\"markdownIt-Anchor\" href=\"#yolov3-ultralytics\">#</a> YOLOv3 ultralytics</h1>\n<h2 id=\"安装ultralytics基础环境\"><a class=\"markdownIt-Anchor\" href=\"#安装ultralytics基础环境\">#</a> 安装 ultralytics 基础环境</h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>conda <span class=\"token function\">install</span> <span class=\"token parameter variable\">-c</span> conda-forge ultralytics</pre></td></tr></table></figure><h2 id=\"克隆yolov3代码\"><a class=\"markdownIt-Anchor\" href=\"#克隆yolov3代码\">#</a> 克隆 YOLOv3 代码</h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">git</span> clone https://github.com/ultralytics/yolov3</pre></td></tr></table></figure><img data-src=\"../../../images/python/YOLO/v3ultralytics/1.png\" alt=\"v1\" style=\"zoom:50%;\" />\n<h3 id=\"解决-git-443-报错\"><a class=\"markdownIt-Anchor\" href=\"#解决-git-443-报错\">#</a> 解决 git 443 报错</h3>\n<p>推荐使用 v2Ray 进行代理，设置 git 的 http 及 https 代理：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>git config <span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token keyword\">global</span> http<span class=\"token punctuation\">.</span>proxy socks5<span class=\"token punctuation\">:</span><span class=\"token operator\">//</span><span class=\"token number\">127.0</span><span class=\"token number\">.0</span><span class=\"token number\">.1</span><span class=\"token punctuation\">:</span><span class=\"token number\">10808</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>git config <span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token keyword\">global</span> https<span class=\"token punctuation\">.</span>proxy socks5<span class=\"token punctuation\">:</span><span class=\"token operator\">//</span><span class=\"token number\">127.0</span><span class=\"token number\">.0</span><span class=\"token number\">.1</span><span class=\"token punctuation\">:</span><span class=\"token number\">10808</span></pre></td></tr></table></figure><p>若使用 v2Ray 的话，其代理端口为 10808，若为 clash 则应为 7891。</p>\n<h2 id=\"安装缺少的依赖库\"><a class=\"markdownIt-Anchor\" href=\"#安装缺少的依赖库\">#</a> 安装缺少的依赖库</h2>\n<img data-src=\"../../../images/python/YOLO/v3ultralytics/2.png\" alt=\"v1\" style=\"zoom:50%;\" />\n<p>当然你可以一个一个安装，但那样有点麻烦，请使用如下命令：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pip <span class=\"token function\">install</span> <span class=\"token parameter variable\">-r</span> .<span class=\"token punctuation\">\\</span>requirements.txt</pre></td></tr></table></figure><h2 id=\"权重文件\"><a class=\"markdownIt-Anchor\" href=\"#权重文件\">#</a> 权重文件</h2>\n<p>请访问：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRjb2RlLmNvbS9vcGVuLXNvdXJjZS10b29sa2l0L2I1MTI2Lw==\">https://gitcode.com/open-source-toolkit/b5126/</span></p>\n<p>其中包含了：</p>\n<ol>\n<li><strong><span class=\"exturl\" data-url=\"aHR0cDovL3lvbG92My5wdA==\">yolov3.pt</span></strong><br>\nYOLOv3 的标准权重文件，适用于大多数目标检测任务。</li>\n<li><strong><span class=\"exturl\" data-url=\"aHR0cDovL3lvbG92My1zcHAucHQ=\">yolov3-spp.pt</span></strong><br>\nYOLOv3-SPP 的权重文件，通过空间金字塔池化（Spatial Pyramid Pooling）增强了模型的性能，特别适用于高分辨率图像的目标检测。</li>\n<li><strong><span class=\"exturl\" data-url=\"aHR0cDovL3lvbG92My10aW55LnB0\">yolov3-tiny.pt</span></strong><br>\nYOLOv3-Tiny 的权重文件，适用于资源受限的环境，如嵌入式设备或移动设备，具有较快的推理速度和较小的模型体积。</li>\n</ol>\n<h2 id=\"试运行\"><a class=\"markdownIt-Anchor\" href=\"#试运行\">#</a> 试运行</h2>\n<p>首先修改权重文件路径</p>\n<img data-src=\"../../../images/python/YOLO/v3ultralytics/3.png\" alt=\"v1\" style=\"zoom:50%;\" />\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3huLS1kZXRlY3QtMncycjU0OWIucHk=\">运行 detect.py</span></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Fusing layers<span class=\"token punctuation\">..</span>. </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>yolov3 summary: <span class=\"token number\">261</span> layers, <span class=\"token number\">61922845</span> parameters, <span class=\"token number\">0</span> gradients, <span class=\"token number\">155.9</span> GFLOPs</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>image <span class=\"token number\">1</span>/2 D:<span class=\"token punctuation\">\\</span>PycharmProjects<span class=\"token punctuation\">\\</span>yolov3<span class=\"token punctuation\">\\</span>data<span class=\"token punctuation\">\\</span>images<span class=\"token punctuation\">\\</span>bus.jpg: 640x480 <span class=\"token number\">4</span> persons, <span class=\"token number\">1</span> bicycle, <span class=\"token number\">1</span> bus, <span class=\"token number\">70</span>.7ms</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>image <span class=\"token number\">2</span>/2 D:<span class=\"token punctuation\">\\</span>PycharmProjects<span class=\"token punctuation\">\\</span>yolov3<span class=\"token punctuation\">\\</span>data<span class=\"token punctuation\">\\</span>images<span class=\"token punctuation\">\\</span>zidane.jpg: 384x640 <span class=\"token number\">2</span> persons, <span class=\"token number\">2</span> ties, <span class=\"token number\">55</span>.0ms</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Speed: <span class=\"token number\">1</span>.0ms pre-process, <span class=\"token number\">62</span>.8ms inference, <span class=\"token number\">25</span>.5ms NMS per image at shape <span class=\"token punctuation\">(</span><span class=\"token number\">1</span>, <span class=\"token number\">3</span>, <span class=\"token number\">640</span>, <span class=\"token number\">640</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Results saved to runs<span class=\"token punctuation\">\\</span>detect<span class=\"token punctuation\">\\</span>exp3</pre></td></tr></table></figure><p>输出结果：</p>\n<img data-src=\"../../../images/python/YOLO/v3ultralytics/4.png\" alt=\"v1\" style=\"zoom:50%;\" />\n<img data-src=\"../../../images/python/YOLO/v3ultralytics/5.png\" alt=\"v1\" style=\"zoom:50%;\" />\n<p>效果惊艳，起初我观察输出时  <code>4 persons, 1 bicycle, 1 bus, 70.7ms</code> ，我在想这个  <code>1 bicycle</code>  到底在哪里。</p>\n<p>我反复盯着图片看了好几遍：公交车很明显，人也数得清，可自行车呢？画面里没有完整的车轮，没有清晰的车架，甚至也没有骑车的人。那一刻我甚至怀疑，是不是模型误判了。</p>\n<p>直到我真正把 YOLO 的标注框图片打开，那辆自行车就在公交车的右上角，位于居民窗户围栏之中，一个几乎被遮挡、只露出局部轮廓的物体，被一个细小却坚定的框牢牢圈住。那一瞬间，我才理解 You Only Look Once 的真正含义…</p>\n<h2 id=\"项目结构\"><a class=\"markdownIt-Anchor\" href=\"#项目结构\">#</a> 项目结构</h2>\n<h3 id=\"资源和工具\"><a class=\"markdownIt-Anchor\" href=\"#资源和工具\">#</a> 资源和工具</h3>\n<ul>\n<li><strong> <code>data</code> </strong>：存放数据相关的<strong>配置文件</strong>比如类别名称、路径配置和<strong>图片测试数据</strong>。</li>\n<li><strong> <code>models</code> </strong>：存放<strong>模型相关的配置文件</strong>，定义神经网络层级结构和核心代码。</li>\n<li><strong> <code>runs</code> </strong>：<strong>结果文件夹</strong>。当你运行程序进行推理、训练或测试后，生成的图表、保存的检测结果都会放在这里。</li>\n<li><strong> <code>utils</code> </strong>：<strong>工具代码库</strong>。存放一些辅助函数，比如计算损失的代码、在图片上画框框的代码等。</li>\n<li><strong> <code>VOCdevkit</code> </strong>：<strong>数据集文件夹</strong>。通常是按照官方 VOC 标准存放的原始图片和标签文件。</li>\n<li><strong> <code>weight</code> </strong>：<strong>权重文件夹</strong>。专门用来放训练好的模型参数（权重文件），没有它模型就无法工作。</li>\n</ul>\n<h3 id=\"视频与环境文件\"><a class=\"markdownIt-Anchor\" href=\"#视频与环境文件\">#</a> 视频与环境文件</h3>\n<ul>\n<li><strong> <code>che.avi</code> </strong>：一个<strong>测试视频</strong>。方便你写好程序后，直接运行来看看能不能识别出视频里的物体。</li>\n<li><strong> <code>requirements.txt</code> </strong>：<strong>环境配置文件</strong>。记录了运行这个项目需要安装哪些 Python 插件和库，以及对应的版本。</li>\n</ul>\n<h3 id=\"python-脚本部分核心运行程序\"><a class=\"markdownIt-Anchor\" href=\"#python-脚本部分核心运行程序\">#</a> Python 脚本部分（核心运行程序）</h3>\n<ul>\n<li><strong> <code>Dataset_partitioning.py</code> </strong>：<strong>数据集划分代码</strong>。用来把你的图片随机分成 “训练集” 和 “验证集”。</li>\n<li><strong> <code>detect.py</code> </strong>：<strong>检测推理代码</strong>。最常用的文件，运行它就可以调用模型去识别一张图片或一段视频。</li>\n<li><strong> <code>hubconf.py</code> </strong>：PyTorch Hub 相关的脚本（用于方便地在其他地方调用这个模型）。</li>\n<li><strong> <code>train.py</code> </strong>：<strong>模型训练代码</strong>。如果你想用自己的数据教模型认东西，就运行这个文件。</li>\n<li><strong> <code>val.py</code> </strong>：<strong>模型测试 / 验证代码</strong>。用来跑分，看看训练出来的模型准确率（mAP）到底有多高。</li>\n</ul>\n<h2 id=\"超参数文件hypscratch-highyaml\"><a class=\"markdownIt-Anchor\" href=\"#超参数文件hypscratch-highyaml\">#</a> 超参数文件：hyp.scratch-high.yaml</h2>\n<p>lr0 表示初始学习率，即训练刚开始时优化器使用的学习率。一般来说，SGD 常用 0.01，Adam 常用 0.001。学习率过大会导致训练震荡甚至发散，过小则收敛缓慢。</p>\n<p>lrf 表示最终学习率与初始学习率的比例，通常用于 OneCycle 学习率策略。训练后期的学习率等于 lr0 乘以 lrf，例如 lr0 为 0.01，lrf 为 0.1，则最终学习率为 0.001。这样可以在训练后期减小步长，使模型更稳定地收敛。</p>\n<p>momentum 表示动量参数。在使用 SGD 时它是 momentum，在使用 Adam 时对应 beta1。动量的作用是保留历史梯度方向，减少参数更新的抖动，加快收敛速度。</p>\n<p>weight_decay 表示权重衰减系数，也就是 L2 正则化强度。它通过惩罚过大的权重来防止模型过拟合，0.0005 是目标检测中非常常见的经验值。</p>\n<p>warmup_epochs 表示学习率预热的轮数，前若干个 epoch 内学习率会从较小值逐步增加到设定的初始学习率，主要目的是防止训练初期梯度过大导致不稳定。</p>\n<p>warmup_momentum 表示在 warmup 阶段使用的初始动量值，随着 warmup 的结束逐渐过渡到正常的 momentum，有助于平滑训练初期的参数更新。</p>\n<p>warmup_bias_lr 表示偏置参数在 warmup 阶段使用的学习率。通常会给 bias 一个相对更大的学习率，使模型能更快地学会目标的大致位置和存在性。</p>\n<p>box 表示边界框回归损失的权重，用于控制模型对目标位置和大小回归精度的关注程度。该值越大，模型越重视框的位置准确性。</p>\n<p>cls 表示分类损失的权重，用于平衡多类别预测的重要性。如果类别数较多或类别区分困难，通常需要适当增大该值。</p>\n<p>cls_pw 表示分类损失中正样本的权重，主要用于缓解正负样本不平衡问题。值为 1 表示不额外加权。</p>\n<p>obj 表示目标置信度损失的权重，用于衡量模型判断 “该位置是否存在目标” 的能力，这是 YOLO 检测中非常核心的一项。</p>\n<p>obj_pw 表示目标置信度损失中正样本的权重，同样用于样本不平衡场景。</p>\n<p>iou_t 表示训练时使用的 IoU 阈值，只有预测框与真实框的 IoU 大于该值时才会参与正样本训练。阈值较低时有利于提高召回率，较高时有利于提高定位精度。</p>\n<p>anchor_t 表示 anchor 匹配阈值，用于控制真实框与 anchor 在宽高比例上的匹配宽松程度。数值越大，允许匹配的 anchor 越多。</p>\n<p>anchors 表示每个输出层使用的 anchor 数量，该项被注释掉说明使用模型默认的 anchor 设置。</p>\n<p>fl_gamma 表示 Focal Loss 的 gamma 参数，当该值为 0 时表示不启用 Focal Loss。Focal Loss 主要用于缓解正负样本极度不平衡的问题。</p>\n<p>hsv_h 表示对图像色调的随机扰动幅度，用于增强模型对不同色彩变化的鲁棒性。</p>\n<p>hsv_s 表示对图像饱和度的随机扰动幅度，使模型适应颜色深浅变化。</p>\n<p>hsv_v 表示对图像亮度的随机扰动幅度，提高模型在不同光照条件下的泛化能力。</p>\n<p>degrees 表示随机旋转角度的范围，当前为 0 表示不进行旋转增强。</p>\n<p>translate 表示图像随机平移的比例，0.1 表示在上下左右方向最多平移图像尺寸的 10%。</p>\n<p>scale 表示图像的随机缩放比例，数值越大，缩放范围越广，有助于增强尺度不变性。</p>\n<p>shear 表示错切变换的角度范围，当前为 0 表示不使用错切变换。</p>\n<p>perspective 表示透视变换的强度，通常用于模拟不同拍摄角度的效果。</p>\n<p>flipud 表示图像上下翻转的概率，0 表示不进行上下翻转。</p>\n<p>fliplr 表示图像左右翻转的概率，0.5 表示一半概率进行左右翻转，这是目标检测中非常常用的增强方式。</p>\n<p>mosaic 表示 Mosaic 数据增强的使用概率，1.0 表示始终使用。该方法将四张图片拼接成一张，对小目标检测和复杂场景效果显著。</p>\n<p>mixup 表示 MixUp 数据增强的概率，通过将两张图片和标签进行线性混合来增强模型的泛化能力。</p>\n<p>copy_paste 表示 Copy-Paste 数据增强的概率，即从一张图中裁剪目标并粘贴到另一张图中，用于增加目标组合的多样性。</p>\n<h2 id=\"no-aug-object365-scratch-highmedlow-voc\"><a class=\"markdownIt-Anchor\" href=\"#no-aug-object365-scratch-highmedlow-voc\">#</a> no-aug / Object365/ scratch-high/med/low / VOC</h2>\n<h3 id=\"hypno-augment\"><a class=\"markdownIt-Anchor\" href=\"#hypno-augment\">#</a> hyp.no-augment</h3>\n<p>hyp.no-augment 非常特殊，它表示<strong>几乎关闭所有数据增强</strong>。mosaic、mixup、颜色扰动基本都不开。它主要有三种用途：第一，用来做消融实验，验证 “数据增强到底有没有用”；第二，用在数据本身已经被严格对齐、增强会破坏语义的任务中比如工业缺陷、医学影像；第三，用于调试或快速验证训练流程是否正确。</p>\n<h3 id=\"hypscratch-object365\"><a class=\"markdownIt-Anchor\" href=\"#hypscratch-object365\">#</a> hyp.scratch-object365</h3>\n<p>hyp.scratch-object365 是为 <strong>Object365 这种超大规模、类别极多的数据集</strong>设计的。它会更加重视分类稳定性，对 cls loss、正负样本平衡和 anchor 匹配都有特殊调优。这套参数一般不建议直接拿来用在普通自制数据集上。</p>\n<h3 id=\"hypscratch\"><a class=\"markdownIt-Anchor\" href=\"#hypscratch\">#</a> hyp.scratch</h3>\n<p>scratch 的意思是 “从零开始训练”，也就是<strong>不加载任何预训练权重</strong>，网络参数完全随机初始化。在这种情况下，训练对学习率、数据增强和 warmup 都非常敏感，所以官方给了多套经过验证的 hyp 配置。</p>\n<h4 id=\"hypscratch-high\"><a class=\"markdownIt-Anchor\" href=\"#hypscratch-high\">#</a> hyp.scratch-high</h4>\n<p>hyp.scratch-high 是为<strong>大数据集 + 强数据增强</strong>准备的配置。它通常用于 COCO 这种规模在十万级以上的数据集，或者你有非常多样、复杂场景的数据。它的典型特征是数据增强非常激进，比如 mosaic、mixup、颜色扰动都开得比较大，学习率也相对偏高，模型泛化能力最强，但前期训练不稳定，对小数据集非常不友好。</p>\n<h4 id=\"hypscratch-med\"><a class=\"markdownIt-Anchor\" href=\"#hypscratch-med\">#</a> hyp.scratch-med</h4>\n<p>hyp.scratch-med 是一个<strong>折中方案</strong>。数据增强和学习率都比 high 温和一些，适合中等规模数据集，比如几千到一两万张图片。很多人在自定义数据集时，其实用的就是这一套，只是没意识到。</p>\n<h4 id=\"hypscratch-low\"><a class=\"markdownIt-Anchor\" href=\"#hypscratch-low\">#</a> hyp.scratch-low</h4>\n<p>hyp.scratch-low 是为<strong>小数据集</strong>准备的。它会明显减弱数据增强强度，学习率也更保守，避免模型在强增强下 “学歪”。如果你的数据只有几百到一两千张，用 high 或 med 很容易出现 loss 震荡、mAP 不升甚至下降，这时 low 反而效果更好。</p>\n<h4 id=\"hypscratch-voc\"><a class=\"markdownIt-Anchor\" href=\"#hypscratch-voc\">#</a> hyp.scratch-voc</h4>\n<p>hyp.scratch-voc。它是<strong>专门为 PASCAL VOC 数据集调的</strong>，而不是简单的 low 或 med。VOC 的特点是类别少、目标相对大、场景简单，所以这个配置通常会降低分类损失权重、调整 anchor 匹配策略，更偏向于 “稳而准”。</p>\n<h2 id=\"最佳实践\"><a class=\"markdownIt-Anchor\" href=\"#最佳实践\">#</a> 最佳实践？</h2>\n<p><strong>90% 的自定义数据集，scratch-med 或 scratch-low 起步是最稳的</strong>，不要一上来就 high。</p>\n<h2 id=\"数据集分类文件及其下载脚本\"><a class=\"markdownIt-Anchor\" href=\"#数据集分类文件及其下载脚本\">#</a> 数据集分类文件及其下载脚本</h2>\n<img data-src=\"../../../images/python/YOLO/v3ultralytics/6.png\" alt=\"v1\"  />\n<p>每一个  <code>.yaml</code>  文件都像是一份说明书，告诉模型：</p>\n<ul>\n<li><strong>训练 / 验证数据在哪里</strong>：图片和标签存储在硬盘的哪个路径下。</li>\n<li><strong>有多少个类别</strong>：例如模型需要识别 80 种物体还是 10 种。</li>\n<li><strong>类别的名字是什么</strong>：例如  <code>0: person</code> ,  <code>1: bicycle</code>  等。</li>\n</ul>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 路径设置</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> ../datasets/coco128  <span class=\"token comment\"># 数据集根目录</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">train</span><span class=\"token punctuation\">:</span> images/train2017    <span class=\"token comment\"># 训练集图片路径</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token key atrule\">val</span><span class=\"token punctuation\">:</span> images/train2017      <span class=\"token comment\"># 验证集图片路径</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 类别信息</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token key atrule\">nc</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>  <span class=\"token comment\"># 类别数量 (number of classes)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token key atrule\">names</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token key atrule\">0</span><span class=\"token punctuation\">:</span> person</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token key atrule\">1</span><span class=\"token punctuation\">:</span> bicycle</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token key atrule\">2</span><span class=\"token punctuation\">:</span> car</pre></td></tr></table></figure><h2 id=\"labelimg标注软件\"><a class=\"markdownIt-Anchor\" href=\"#labelimg标注软件\">#</a> labelimg 标注软件</h2>\n<p>开源地址：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0h1bWFuU2lnbmFsL2xhYmVsSW1n\">https://github.com/HumanSignal/labelImg</span></p>\n<blockquote>\n<p>LabelImg is now part of the Label Studio community. The popular image annotation tool created by Tzutalin is no longer actively being developed, but you can check out Label Studio, the open source data labeling tool for images, text, hypertext, audio, video and time-series data.<br>\nLabelImg 现已成为 Label Studio 社区的一部分。Tzutalin 开发的流行图像注释工具已不再积极开发，但你可以看看 Label Studio，这是一个开源的数据标注工具，用于图像、文本、超文本、音频、视频和时间序列数据。</p>\n</blockquote>\n<p>Label Studio：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9sYWJlbHN0dWQuaW8v\">https://labelstud.io/</span> （Open Source Data Labeling Platform）</p>\n<p>开源地址：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0h1bWFuU2lnbmFsL2xhYmVsLXN0dWRpby8=\">https://github.com/HumanSignal/label-studio/</span></p>\n<p>labelimg 最终版本为：1.8.1 /released this Dec 3, 2018 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3R6dXRhbGluL2xhYmVsSW1nL2ZpbGVzLzI2MzgxOTkvd2luZG93c192MS44LjEuemlw\">https://github.com/tzutalin/labelImg/files/2638199/windows_v1.8.1.zip</span></p>\n<img data-src=\"../../../images/python/YOLO/v3ultralytics/8.png\" alt=\"v1\"  />\n<p>推荐使用 VOC 格式的 xml 信息。</p>\n<h2 id=\"voc2007\"><a class=\"markdownIt-Anchor\" href=\"#voc2007\">#</a> VOC2007</h2>\n<p>源：<span class=\"exturl\" data-url=\"aHR0cDovL2hvc3Qucm9ib3RzLm94LmFjLnVrL3Bhc2NhbC9WT0Mvdm9jMjAwNw==\">http://host.robots.ox.ac.uk/pascal/VOC/voc2007</span> 但是我访问这个时候被防火墙拦截了。</p>\n<p>源码中的：</p>\n<ol>\n<li>训练集与验证集：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3VsdHJhbHl0aWNzL2Fzc2V0cy9yZWxlYXNlcy9kb3dubG9hZC92MC4wLjAvVk9DdHJhaW52YWxfMDYtTm92LTIwMDcuemlw\">https://github.com/ultralytics/assets/releases/download/v0.0.0/VOCtrainval_06-Nov-2007.zip</span></li>\n<li>测试集：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3VsdHJhbHl0aWNzL2Fzc2V0cy9yZWxlYXNlcy9kb3dubG9hZC92MC4wLjAvVk9DdGVzdF8wNi1Ob3YtMjAwNy56aXA=\">https://github.com/ultralytics/assets/releases/download/v0.0.0/VOCtest_06-Nov-2007.zip</span></li>\n</ol>\n<h2 id=\"将voc格式转为yolo格式\"><a class=\"markdownIt-Anchor\" href=\"#将voc格式转为yolo格式\">#</a> 将 VOC 格式转为 YOLO 格式</h2>\n<h3 id=\"data_trans脚本\"><a class=\"markdownIt-Anchor\" href=\"#data_trans脚本\">#</a> Data_Trans 脚本</h3>\n<p>请访问开源脚本：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0ppZVp6em9vL0RhdGFfVHJhbnM=\">https://github.com/JieZzzoo/Data_Trans</span></p>\n<p>使用说明：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1RoZWJlc3RfamFjay9hcnRpY2xlL2RldGFpbHMvMTI1NjM3MDk5\">https://blog.csdn.net/Thebest_jack/article/details/125637099</span></p>\n<div class=\"links\"><div class=\"item\" title=\"蓝胖胖\" style=\"--block-color:#409be1;\"><span class=\"exturl image\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1RoZWJlc3RfamFjaz90eXBlPWJsb2c=\" data-background-image=\"/images/404.png\"></span>\n          <div class=\"info\">\n          <span class=\"exturl title\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1RoZWJlc3RfamFjaz90eXBlPWJsb2c=\">蓝胖胖</span>\n          <p class=\"desc\">感谢作者开源</p>\n          </div></div></div>\n<p>这个脚本可以将 VOC 格式转为 YOLO 格式，不过他把数据集索引写在了 test、train 和 val 的文本文件里了。</p>\n<p>不过他这个提取脚本有点小 bug，后续我将会制作一个完整的脚本。</p>\n<p>如果要产生图片（训练、验证、测试）和标签（训练、验证、测试）那样的结构，需要进一步改写，因此我设计了这样的脚本： <code>imgsWlabels</code></p>\n<h3 id=\"imgswlabels脚本\"><a class=\"markdownIt-Anchor\" href=\"#imgswlabels脚本\">#</a> imgsWlabels 脚本</h3>\n<p>imgsWlabels 是我自创的一个提取与整理的脚本，如用方式如下，首先你需要把 <code>Data_Trans</code>  中的的 Imagesets、labels 以及 JPEGImages 复制下来放到 <code>imgsWlabels</code>  的 pre 目录下，形如：</p>\n<img data-src=\"../../../images/python/YOLO/v3ultralytics/9.png\" alt=\"v1\"  />\n<p><code>imgsWlabels</code>  有两种模式，分别是 “train 与 val” 模式和”trainval“模式。</p>\n<h4 id=\"train与val模式\"><a class=\"markdownIt-Anchor\" href=\"#train与val模式\">#</a> train 与 val 模式</h4>\n<p>在这种模式下，数据集被分为三个部分：训练集、验证集、测试集，这种模式的特点是：<strong>训练集和验证集是分开的</strong>，避免数据泄露，确保模型的泛化能力。</p>\n<h4 id=\"trainval模式\"><a class=\"markdownIt-Anchor\" href=\"#trainval模式\">#</a> trainval 模式</h4>\n<p>在 <strong>trainval</strong> 模式下，训练集和验证集被合并为一个整体的数据集，模型在整个  <code>trainval</code>  数据集上进行训练和验证。这种模式通常用于特定的任务，例如数据量不大时，可以通过合并训练集和验证集来提升训练集的多样性和大小。</p>\n<h3 id=\"代码\"><a class=\"markdownIt-Anchor\" href=\"#代码\">#</a> 代码</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 划分数据集模式，0 为 train 与 val 模式，1 为 trainval 模式</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>split_mode <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># ----</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">import</span> os</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">import</span> time</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">import</span> shutil</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">from</span> tqdm <span class=\"token keyword\">import</span> tqdm</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>root_dir <span class=\"token operator\">=</span> <span class=\"token string\">'pre'</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>root_img_dir <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>root_dir<span class=\"token punctuation\">,</span> <span class=\"token string\">'JPEGImages'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>root_label_dir <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>root_dir<span class=\"token punctuation\">,</span> <span class=\"token string\">'labels'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>indexes <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>root_dir<span class=\"token punctuation\">,</span> <span class=\"token string\">'Imagesets'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>train_index <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>indexes<span class=\"token punctuation\">,</span> <span class=\"token string\">'train.txt'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>val_index <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>indexes<span class=\"token punctuation\">,</span> <span class=\"token string\">'val.txt'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>trainval_index <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>indexes<span class=\"token punctuation\">,</span> <span class=\"token string\">'trainval.txt'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>test_index <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>indexes<span class=\"token punctuation\">,</span> <span class=\"token string\">'test.txt'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">read_file_return_list</span><span class=\"token punctuation\">(</span>file_path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span>file_path<span class=\"token punctuation\">,</span> <span class=\"token string\">'r'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            lines <span class=\"token operator\">=</span> f<span class=\"token punctuation\">.</span>readlines<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>line<span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> line <span class=\"token keyword\">in</span> lines<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">except</span> FileNotFoundError<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'index file not found'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        exit<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">except</span> Exception <span class=\"token keyword\">as</span> e<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        exit<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>train_indexes_list <span class=\"token operator\">=</span> read_file_return_list<span class=\"token punctuation\">(</span>train_index<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>val_indexes_list <span class=\"token operator\">=</span> read_file_return_list<span class=\"token punctuation\">(</span>val_index<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>trainval_indexes_list <span class=\"token operator\">=</span> read_file_return_list<span class=\"token punctuation\">(</span>trainval_index<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>test_indexes_list <span class=\"token operator\">=</span> read_file_return_list<span class=\"token punctuation\">(</span>test_index<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">copy_file</span><span class=\"token punctuation\">(</span>src_file<span class=\"token punctuation\">,</span> dst_dir<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        os<span class=\"token punctuation\">.</span>makedirs<span class=\"token punctuation\">(</span>dst_dir<span class=\"token punctuation\">,</span> exist_ok<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        shutil<span class=\"token punctuation\">.</span>copy<span class=\"token punctuation\">(</span>src_file<span class=\"token punctuation\">,</span> dst_dir<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token boolean\">True</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token keyword\">except</span> Exception <span class=\"token keyword\">as</span> e<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token boolean\">False</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">cp_file_in_list</span><span class=\"token punctuation\">(</span>src_dir<span class=\"token punctuation\">,</span> dst_dir<span class=\"token punctuation\">,</span> index_list<span class=\"token punctuation\">,</span> target_ext<span class=\"token operator\">=</span><span class=\"token string\">'.jpg'</span><span class=\"token punctuation\">,</span> msg<span class=\"token operator\">=</span><span class=\"token string\">'copy file...'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>exists<span class=\"token punctuation\">(</span>src_dir<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Source directory does not exist!'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>exists<span class=\"token punctuation\">(</span>dst_dir<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        os<span class=\"token punctuation\">.</span>makedirs<span class=\"token punctuation\">(</span>dst_dir<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token keyword\">with</span> tqdm<span class=\"token punctuation\">(</span>index_list<span class=\"token punctuation\">,</span> desc<span class=\"token operator\">=</span>msg<span class=\"token punctuation\">,</span> unit<span class=\"token operator\">=</span><span class=\"token string\">'file'</span><span class=\"token punctuation\">,</span> total<span class=\"token operator\">=</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>index_list<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> dynamic_ncols<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>              ncols<span class=\"token operator\">=</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span> mininterval<span class=\"token operator\">=</span><span class=\"token number\">0.1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>              bar_format<span class=\"token operator\">=</span><span class=\"token string\">\"&#123;l_bar&#125;&#123;bar&#125;| &#123;n_fmt&#125;/&#123;total_fmt&#125; [&#123;elapsed&#125; &lt; &#123;remaining&#125;, &#123;rate_fmt&#125;]\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> pbar<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token keyword\">for</span> index <span class=\"token keyword\">in</span> pbar<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>            src_file <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>src_dir<span class=\"token punctuation\">,</span> index <span class=\"token operator\">+</span> target_ext<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>            <span class=\"token keyword\">if</span> copy_file<span class=\"token punctuation\">(</span>src_file<span class=\"token punctuation\">,</span> dst_dir<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                pbar<span class=\"token punctuation\">.</span>set_postfix<span class=\"token punctuation\">(</span><span class=\"token builtin\">file</span><span class=\"token operator\">=</span>index<span class=\"token punctuation\">,</span> color<span class=\"token operator\">=</span><span class=\"token string\">'green'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>            <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>                pbar<span class=\"token punctuation\">.</span>set_postfix<span class=\"token punctuation\">(</span><span class=\"token builtin\">file</span><span class=\"token operator\">=</span>index<span class=\"token punctuation\">,</span> color<span class=\"token operator\">=</span><span class=\"token string\">'red'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>            pbar<span class=\"token punctuation\">.</span>update<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">boot_split</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token keyword\">if</span> split_mode <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        <span class=\"token comment\"># train 与 val 模式</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        cp_file_in_list<span class=\"token punctuation\">(</span>root_img_dir<span class=\"token punctuation\">,</span> <span class=\"token string\">'images/train'</span><span class=\"token punctuation\">,</span> train_indexes_list<span class=\"token punctuation\">,</span> msg<span class=\"token operator\">=</span><span class=\"token string\">'copy train file...'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        cp_file_in_list<span class=\"token punctuation\">(</span>root_img_dir<span class=\"token punctuation\">,</span> <span class=\"token string\">'images/val'</span><span class=\"token punctuation\">,</span> val_indexes_list<span class=\"token punctuation\">,</span> msg<span class=\"token operator\">=</span><span class=\"token string\">'copy val file...'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        cp_file_in_list<span class=\"token punctuation\">(</span>root_img_dir<span class=\"token punctuation\">,</span> <span class=\"token string\">'images/test'</span><span class=\"token punctuation\">,</span> test_indexes_list<span class=\"token punctuation\">,</span> msg<span class=\"token operator\">=</span><span class=\"token string\">'copy test file...'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        cp_file_in_list<span class=\"token punctuation\">(</span>root_label_dir<span class=\"token punctuation\">,</span> <span class=\"token string\">'labels/train'</span><span class=\"token punctuation\">,</span> train_indexes_list<span class=\"token punctuation\">,</span> target_ext<span class=\"token operator\">=</span><span class=\"token string\">'.txt'</span><span class=\"token punctuation\">,</span> msg<span class=\"token operator\">=</span><span class=\"token string\">'copy train label...'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        cp_file_in_list<span class=\"token punctuation\">(</span>root_label_dir<span class=\"token punctuation\">,</span> <span class=\"token string\">'labels/val'</span><span class=\"token punctuation\">,</span> val_indexes_list<span class=\"token punctuation\">,</span> target_ext<span class=\"token operator\">=</span><span class=\"token string\">'.txt'</span><span class=\"token punctuation\">,</span> msg<span class=\"token operator\">=</span><span class=\"token string\">'copy val label...'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        cp_file_in_list<span class=\"token punctuation\">(</span>root_label_dir<span class=\"token punctuation\">,</span> <span class=\"token string\">'labels/test'</span><span class=\"token punctuation\">,</span> test_indexes_list<span class=\"token punctuation\">,</span> target_ext<span class=\"token operator\">=</span><span class=\"token string\">'.txt'</span><span class=\"token punctuation\">,</span> msg<span class=\"token operator\">=</span><span class=\"token string\">'copy test label...'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    <span class=\"token keyword\">elif</span> split_mode <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        <span class=\"token comment\"># trainval 模式</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        cp_file_in_list<span class=\"token punctuation\">(</span>root_img_dir<span class=\"token punctuation\">,</span> <span class=\"token string\">'images/trainval'</span><span class=\"token punctuation\">,</span> trainval_indexes_list<span class=\"token punctuation\">,</span> msg<span class=\"token operator\">=</span><span class=\"token string\">'copy trainval file...'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        cp_file_in_list<span class=\"token punctuation\">(</span>root_img_dir<span class=\"token punctuation\">,</span> <span class=\"token string\">'images/test'</span><span class=\"token punctuation\">,</span> test_indexes_list<span class=\"token punctuation\">,</span> msg<span class=\"token operator\">=</span><span class=\"token string\">'copy test file...'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>        cp_file_in_list<span class=\"token punctuation\">(</span>root_label_dir<span class=\"token punctuation\">,</span> <span class=\"token string\">'labels/trainval'</span><span class=\"token punctuation\">,</span> trainval_indexes_list<span class=\"token punctuation\">,</span> target_ext<span class=\"token operator\">=</span><span class=\"token string\">'.txt'</span><span class=\"token punctuation\">,</span> msg<span class=\"token operator\">=</span><span class=\"token string\">'copy trainval label...'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        cp_file_in_list<span class=\"token punctuation\">(</span>root_label_dir<span class=\"token punctuation\">,</span> <span class=\"token string\">'labels/test'</span><span class=\"token punctuation\">,</span> test_indexes_list<span class=\"token punctuation\">,</span> target_ext<span class=\"token operator\">=</span><span class=\"token string\">'.txt'</span><span class=\"token punctuation\">,</span> msg<span class=\"token operator\">=</span><span class=\"token string\">'copy test label...'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre></pre></td></tr><tr><td data-num=\"86\"></td><td><pre></pre></td></tr><tr><td data-num=\"87\"></td><td><pre><span class=\"token comment\"># ----</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre><span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">'__main__'</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    start_time <span class=\"token operator\">=</span> time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>    boot_split<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Time used: %.2f'</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> start_time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>可以根据需要的模式进行修改运行模式。</p>\n<p>执行后：</p>\n<img data-src=\"../../../images/python/YOLO/v3ultralytics/10.png\" alt=\"v1\"  />\n<p>会生成：</p>\n<img data-src=\"../../../images/python/YOLO/v3ultralytics/11.png\" alt=\"v1\"  />\n<h2 id=\"如何训练模型\"><a class=\"markdownIt-Anchor\" href=\"#如何训练模型\">#</a> 如何训练模型</h2>\n<p>一般训练需要修改这几个参数就足够了</p>\n<img data-src=\"../../../images/python/YOLO/v3ultralytics/12.png\" alt=\"v1\"  />\n<p>设置好数据集路径：</p>\n<img data-src=\"../../../images/python/YOLO/v3ultralytics/13.png\" alt=\"v1\"  />\n<p>修改类别数：</p>\n<img data-src=\"../../../images/python/YOLO/v3ultralytics/14.png\" alt=\"v1\"  />\n<p>最好根据自己的数据集设置检测框那样最好。</p>\n<p>开始训练：</p>\n<img data-src=\"../../../images/python/YOLO/v3ultralytics/15.png\" alt=\"v1\"  />\n<img data-src=\"../../../images/python/YOLO/v3ultralytics/16.png\" alt=\"v1\"  />\n<h2 id=\"参数详解\"><a class=\"markdownIt-Anchor\" href=\"#参数详解\">#</a> 参数详解</h2>\n<h3 id=\"rect矩形训练\"><a class=\"markdownIt-Anchor\" href=\"#rect矩形训练\">#</a> rect 矩形训练</h3>\n<p>在训练时，按照图片的原始宽高比进行分组，并尽量减少 padding，而不是把所有图片强行 resize 成正方形。</p>\n<h3 id=\"resume断点续训\"><a class=\"markdownIt-Anchor\" href=\"#resume断点续训\">#</a> resume 断点续训</h3>\n<p>当训练被中断比如关机、Ctrl+C、显存不足或崩溃后， <strong>从上一次保存的 checkpoint 继续训练，而不是从头开始。</strong></p>\n<h2 id=\"如何上采样\"><a class=\"markdownIt-Anchor\" href=\"#如何上采样\">#</a> 如何上采样？</h2>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> nn.Upsample<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>None<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"nearest\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr></table></figure><table>\n<thead>\n<tr>\n<th style=\"text-align:center\">参数</th>\n<th style=\"text-align:center\">解释</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\"><code>None</code></td>\n<td style=\"text-align:center\">不指定目标尺寸</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><code>2</code></td>\n<td style=\"text-align:center\"><code>scale_factor=2</code> ，宽和高放大 <strong>2 倍</strong></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><code>&quot;nearest&quot;</code></td>\n<td style=\"text-align:center\">使用 <strong>最近邻插值</strong></td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"为什么yaml定义结构中的输出通道并不是255对于coco\"><a class=\"markdownIt-Anchor\" href=\"#为什么yaml定义结构中的输出通道并不是255对于coco\">#</a> 为什么 yaml 定义结构中的输出通道并不是 255？（对于 Coco）</h2>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">head</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Bottleneck<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token boolean important\">False</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\"># 15 (P5/32-large)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">[</span><span class=\"token number\">-2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> nn.Upsample<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>None<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"nearest\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Concat<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\"># cat backbone P4</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Bottleneck<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token boolean important\">False</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Bottleneck<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token boolean important\">False</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\"># 22 (P4/16-medium)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">[</span><span class=\"token number\">-2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> nn.Upsample<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>None<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"nearest\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Concat<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\"># cat backbone P3</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Bottleneck<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token boolean important\">False</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">[</span><span class=\"token number\">-1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> Bottleneck<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token boolean important\">False</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\"># 27 (P3/8-small)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">27</span><span class=\"token punctuation\">,</span> <span class=\"token number\">22</span><span class=\"token punctuation\">,</span> <span class=\"token number\">15</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Detect<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>nc<span class=\"token punctuation\">,</span> anchors<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\"># Detect(P3, P4, P5)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token punctuation\">]</span></pre></td></tr></table></figure><p>因为 YAML 里定义的是特征提取与融合过程中的中间特征通道数，真正的 255 通道是在  <code>Detect</code>  模块内部，通过 1×1 卷积动态生成的，而不是在 YAML 中显式写出来的。</p>\n<img data-src=\"../../../images/python/YOLO/v3ultralytics/17.png\" alt=\"v1\"  />\n<h3 id=\"源码种这样写到\"><a class=\"markdownIt-Anchor\" href=\"#源码种这样写到\">#</a> 源码种这样写到…</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>self<span class=\"token punctuation\">.</span>nc <span class=\"token operator\">=</span> nc  <span class=\"token comment\"># number of classes</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>self<span class=\"token punctuation\">.</span>no <span class=\"token operator\">=</span> nc <span class=\"token operator\">+</span> <span class=\"token number\">5</span>  <span class=\"token comment\"># number of outputs per anchor</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>self<span class=\"token punctuation\">.</span>nl <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>anchors<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># number of detection layers</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>self<span class=\"token punctuation\">.</span>na <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>anchors<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">//</span> <span class=\"token number\">2</span>  <span class=\"token comment\"># number of anchors</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>self<span class=\"token punctuation\">.</span>grid <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>torch<span class=\"token punctuation\">.</span>empty<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>nl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\"># init grid</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>self<span class=\"token punctuation\">.</span>anchor_grid <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>torch<span class=\"token punctuation\">.</span>empty<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>nl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\"># init anchor grid</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>self<span class=\"token punctuation\">.</span>register_buffer<span class=\"token punctuation\">(</span><span class=\"token string\">\"anchors\"</span><span class=\"token punctuation\">,</span> torch<span class=\"token punctuation\">.</span>tensor<span class=\"token punctuation\">(</span>anchors<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">float</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>nl<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># shape(nl,na,2)</span></pre></td></tr><tr class=\"marked\"><td data-num=\"8\"></td><td><pre>self<span class=\"token punctuation\">.</span>m <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>ModuleList<span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>no <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>na<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> x <span class=\"token keyword\">in</span> ch<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># output conv</span></pre></td></tr></table></figure><p><mark>255 = 3 × (80 + 5)</mark></p>\n<p><strong>255 与  <code>nc</code>  强相关</strong>， <code>nc</code>  改了，输出通道立刻变，YAML 不可能写死 255。</p>\n",
            "tags": [
                "深度学习",
                "YOLO",
                "项目与实战",
                "python",
                "CNN",
                "深度学习",
                "YOLO"
            ]
        },
        {
            "id": "https://735690757.github.io/python/YOLO/evaluation_indicators/",
            "url": "https://735690757.github.io/python/YOLO/evaluation_indicators/",
            "title": "模型评价指标",
            "date_published": "2026-01-07T04:12:12.000Z",
            "content_html": "<h1 id=\"什么是模型评价指标\"><a class=\"markdownIt-Anchor\" href=\"#什么是模型评价指标\">#</a> 什么是模型评价指标</h1>\n<p><strong>模型评价指标</strong>是用来定量评估机器学习模型性能的一套标准和度量方法。它们将模型的预测结果与真实情况进行比较，给出一个数值化的分数。</p>\n<h1 id=\"准确率\"><a class=\"markdownIt-Anchor\" href=\"#准确率\">#</a> 准确率</h1>\n<p>简单来说，准确率回答了一个核心问题：“<strong>在模型做出的所有判断中，有多少次是猜对的？</strong>”</p>\n<p>在二分类问题中，我们通常使用<strong>混淆矩阵</strong>中的四个指标来定义准确率：</p>\n<ul>\n<li><strong>TP (True Positive)</strong>：真正例，实际为正，模型也预测为正。</li>\n<li><strong>TN (True Negative)</strong>：真负例，实际为负，模型也预测为负。</li>\n<li><strong>FP (False Positive)</strong>：假正例，实际为负，模型却预测为正。</li>\n<li><strong>FN (False Negative)</strong>：假负例，实际为正，模型却预测为负。</li>\n</ul>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mtext>Accuracy</mtext><mo>=</mo><mfrac><mrow><mi>T</mi><mi>P</mi><mo>+</mo><mi>T</mi><mi>N</mi></mrow><mrow><mi>T</mi><mi>P</mi><mo>+</mo><mi>T</mi><mi>N</mi><mo>+</mo><mi>F</mi><mi>P</mi><mo>+</mo><mi>F</mi><mi>N</mi></mrow></mfrac><mo>=</mo><mfrac><mtext>预测正确的样本数</mtext><mtext>总样本数</mtext></mfrac></mrow><annotation encoding=\"application/x-tex\">\\text{Accuracy} = \\frac{TP + TN}{TP + TN + FP + FN} = \\frac{\\text{预测正确的样本数}}{\\text{总样本数}}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8777699999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord text\"><span class=\"mord\">Accuracy</span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.1296600000000003em;vertical-align:-0.7693300000000001em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.36033em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7693300000000001em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.04633em;vertical-align:-0.686em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.36033em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord cjk_fallback\">总样本数</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord cjk_fallback\">预测正确的样本数</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span></p>\n<p>三分类及其以上的也是可以的，我们关注的就是整理，其他的就是反例。</p>\n<h1 id=\"混淆矩阵\"><a class=\"markdownIt-Anchor\" href=\"#混淆矩阵\">#</a> 混淆矩阵</h1>\n<p><strong>混淆矩阵</strong> 就是一张 “对比表”。它把模型<strong>预测的结果</strong>和<strong>实际的真实情况</strong>排在一起，让你一眼看出模型在哪些地方混淆了，而它的样子取决于你有多少个类别。</p>\n<p>无论是二分类还是多分类，混淆矩阵的结构通常如下：</p>\n<ul>\n<li><strong>行</strong>：代表样本的<strong>真实类别</strong>。</li>\n<li><strong>列</strong>：代表模型<strong>预测的类别</strong>。</li>\n<li><strong>对角线</strong>：从左上角到右下角的格子，代表预测正确的数量。</li>\n</ul>\n<p>假设你有一个识别动物的模型，测试了 27 只动物，结果可能长这样：</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th><strong>预测：猫</strong></th>\n<th><strong>预测：狗</strong></th>\n<th><strong>预测：兔</strong></th>\n<th><strong>总计（实际）</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>实际：猫</strong></td>\n<td><strong>5</strong> (TP)</td>\n<td>2</td>\n<td>1</td>\n<td>8</td>\n</tr>\n<tr>\n<td><strong>实际：狗</strong></td>\n<td>0</td>\n<td><strong>6</strong> (TP)</td>\n<td>0</td>\n<td>6</td>\n</tr>\n<tr>\n<td><strong>实际：兔</strong></td>\n<td>2</td>\n<td>1</td>\n<td><strong>10</strong> (TP)</td>\n<td>13</td>\n</tr>\n<tr>\n<td><strong>总计（预测）</strong></td>\n<td>7</td>\n<td>9</td>\n<td>11</td>\n<td><strong>27</strong></td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> seaborn <span class=\"token keyword\">as</span> sns</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> sklearn<span class=\"token punctuation\">.</span>metrics <span class=\"token keyword\">import</span> confusion_matrix</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>y_true <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span><span class=\"token number\">8</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span><span class=\"token number\">6</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span><span class=\"token number\">13</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>y_pred <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span><span class=\"token number\">5</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span><span class=\"token number\">2</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span><span class=\"token number\">2</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span><span class=\"token number\">1</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"实际标签: </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>y_true<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"预测结果: </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>y_pred<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>cm <span class=\"token operator\">=</span> confusion_matrix<span class=\"token punctuation\">(</span>y_true<span class=\"token punctuation\">,</span> y_pred<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>sns<span class=\"token punctuation\">.</span>heatmap<span class=\"token punctuation\">(</span>cm<span class=\"token punctuation\">,</span> annot<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> fmt<span class=\"token operator\">=</span><span class=\"token string\">'d'</span><span class=\"token punctuation\">,</span> cmap<span class=\"token operator\">=</span><span class=\"token string\">'Blues'</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><img data-src=\"../../../images/python/eval/1.png\" alt=\"v1\"  />\n<h1 id=\"精确率-查准率\"><a class=\"markdownIt-Anchor\" href=\"#精确率-查准率\">#</a> 精确率 / 查准率</h1>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mtext>Precision</mtext><mo>=</mo><mfrac><mrow><mi>T</mi><mi>P</mi></mrow><mrow><mi>T</mi><mi>P</mi><mo>+</mo><mi>F</mi><mi>P</mi></mrow></mfrac><mo>=</mo><mfrac><mtext>预测对的正例</mtext><mtext>所有预测为正例的样本数</mtext></mfrac></mrow><annotation encoding=\"application/x-tex\">\\text{Precision} = \\frac{TP}{TP + FP} = \\frac{\\text{预测对的正例}}{\\text{所有预测为正例的样本数}}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord text\"><span class=\"mord\">Precision</span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.1296600000000003em;vertical-align:-0.7693300000000001em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.36033em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7693300000000001em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.04633em;vertical-align:-0.686em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.36033em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord cjk_fallback\">所有预测为正例的样本数</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord cjk_fallback\">预测对的正例</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span></p>\n<p>它的核心问题在于，模型说 “是” 的时候，它<strong>有多可信</strong>？</p>\n<h1 id=\"召回率-查全率\"><a class=\"markdownIt-Anchor\" href=\"#召回率-查全率\">#</a> 召回率 / 查全率</h1>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mtext>Recall</mtext><mo>=</mo><mfrac><mrow><mi>T</mi><mi>P</mi></mrow><mrow><mi>T</mi><mi>P</mi><mo>+</mo><mi>F</mi><mi>N</mi></mrow></mfrac><mo>=</mo><mfrac><mtext>预测对的正例</mtext><mtext>所有实际为正例的样本数</mtext></mfrac></mrow><annotation encoding=\"application/x-tex\">\\text{Recall} = \\frac{TP}{TP + FN} = \\frac{\\text{预测对的正例}}{\\text{所有实际为正例的样本数}}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord text\"><span class=\"mord\">Recall</span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.1296600000000003em;vertical-align:-0.7693300000000001em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.36033em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7693300000000001em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.04633em;vertical-align:-0.686em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.36033em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord cjk_fallback\">所有实际为正例的样本数</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord cjk_fallback\">预测对的正例</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span></p>\n<p>它关注的是<strong>模型发现正例的能力</strong>，或者说<strong>覆盖率</strong>。</p>\n<h1 id=\"精确率与召回率的进一步理解\"><a class=\"markdownIt-Anchor\" href=\"#精确率与召回率的进一步理解\">#</a> 精确率与召回率的进一步理解</h1>\n<p>假设一个小镇上有 <strong>10 个坏人</strong> 和 <strong>90 个好人</strong>。</p>\n<h2 id=\"策略一极端谨慎没把握绝不动手\"><a class=\"markdownIt-Anchor\" href=\"#策略一极端谨慎没把握绝不动手\">#</a> 策略一：极端谨慎，没把握绝不动手</h2>\n<p>在这个场景下，警察非常担心冤枉好人。他们只在掌握了百分之百证据的情况下才抓人。</p>\n<p><strong>结果</strong>：警察只抓了 <strong>1 个人</strong>，而这个人确实是坏人。</p>\n<ul>\n<li><strong>精确率</strong>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn><mi mathvariant=\"normal\">/</mi><mn>1</mn><mo>=</mo><mrow><mn mathvariant=\"bold\">100</mn><mi mathvariant=\"bold\">%</mi></mrow></mrow><annotation encoding=\"application/x-tex\">1 / 1 = \\mathbf{100\\%}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">1</span><span class=\"mord\">/</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.80556em;vertical-align:-0.05556em;\"></span><span class=\"mord\"><span class=\"mord mathbf\">1</span><span class=\"mord mathbf\">0</span><span class=\"mord mathbf\">0</span><span class=\"mord mathbf\">%</span></span></span></span></span>。因为抓的人里没有一个是冤枉的。</li>\n<li><strong>召回率</strong>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn><mi mathvariant=\"normal\">/</mi><mn>10</mn><mo>=</mo><mrow><mn mathvariant=\"bold\">10</mn><mi mathvariant=\"bold\">%</mi></mrow></mrow><annotation encoding=\"application/x-tex\">1 / 10 = \\mathbf{10\\%}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">1</span><span class=\"mord\">/</span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.80556em;vertical-align:-0.05556em;\"></span><span class=\"mord\"><span class=\"mord mathbf\">1</span><span class=\"mord mathbf\">0</span><span class=\"mord mathbf\">%</span></span></span></span></span>。虽然抓得准，但剩下的 9 个坏人还在外面逍遥法外。</li>\n</ul>\n<p><strong>“虽然从不冤枉好人，但办事效率太低，坏人都漏掉了。”</strong></p>\n<h2 id=\"策略二宁可错杀一千不可放过一个\"><a class=\"markdownIt-Anchor\" href=\"#策略二宁可错杀一千不可放过一个\">#</a> 策略二：宁可错杀一千，不可放过一个</h2>\n<p>在这个场景下，警察为了彻底肃清坏人，决定把所有有嫌疑的人全部抓起来。</p>\n<p><strong>结果</strong>：警察抓了 <strong>50 个人</strong>。其中包含了全部 <strong>10 个坏人</strong>，但也误抓了 <strong>40 个好人</strong>。</p>\n<ul>\n<li><strong>召回率</strong>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>10</mn><mi mathvariant=\"normal\">/</mi><mn>10</mn><mo>=</mo><mrow><mn mathvariant=\"bold\">100</mn><mi mathvariant=\"bold\">%</mi></mrow></mrow><annotation encoding=\"application/x-tex\">10 / 10 = \\mathbf{100\\%}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">/</span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.80556em;vertical-align:-0.05556em;\"></span><span class=\"mord\"><span class=\"mord mathbf\">1</span><span class=\"mord mathbf\">0</span><span class=\"mord mathbf\">0</span><span class=\"mord mathbf\">%</span></span></span></span></span>。所有的坏人都被抓进了监狱，一个没漏。</li>\n<li><strong>精确率</strong>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>10</mn><mi mathvariant=\"normal\">/</mi><mn>50</mn><mo>=</mo><mrow><mn mathvariant=\"bold\">20</mn><mi mathvariant=\"bold\">%</mi></mrow></mrow><annotation encoding=\"application/x-tex\">10 / 50 = \\mathbf{20\\%}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">/</span><span class=\"mord\">5</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.80556em;vertical-align:-0.05556em;\"></span><span class=\"mord\"><span class=\"mord mathbf\">2</span><span class=\"mord mathbf\">0</span><span class=\"mord mathbf\">%</span></span></span></span></span>。虽然坏人抓完了，但抓的人里有 80% 都是冤枉的好人。</li>\n</ul>\n<p><strong>“虽然坏人一个没跑，但滥杀无辜，造成了大量的误报。”</strong></p>\n<h2 id=\"精确率与召回率的相互制衡\"><a class=\"markdownIt-Anchor\" href=\"#精确率与召回率的相互制衡\">#</a> 精确率与召回率的相互制衡</h2>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">维度</th>\n<th style=\"text-align:center\">精确率高 / 召回率低</th>\n<th style=\"text-align:center\">精确率低 / 召回率高</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\"><strong>核心逻辑</strong></td>\n<td style=\"text-align:center\">追求 “真”，怕误报</td>\n<td style=\"text-align:center\">追求 “全”，怕漏报</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><strong>模型表现</strong></td>\n<td style=\"text-align:center\">表现得非常<strong>保守</strong></td>\n<td style=\"text-align:center\">表现得非常<strong>激进</strong></td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><strong>反面后果</strong></td>\n<td style=\"text-align:center\">漏网之鱼太多</td>\n<td style=\"text-align:center\">冤假错案太多</td>\n</tr>\n</tbody>\n</table>\n<p>在模型调整中，当你调低阈值时，你抓到的坏人会变多，但随之而来的误伤也会变多。这就是机器学习中著名的 <strong>P-R 权衡</strong>。</p>\n<p>P：Precision  R：Recall</p>\n<img data-src=\"../../../images/python/eval/2.png\" alt=\"v1\"  />\n<h1 id=\"f1-score值\"><a class=\"markdownIt-Anchor\" href=\"#f1-score值\">#</a> F1-score 值</h1>\n<p>F1-Score 使用的是<strong>调和平均数</strong>，它的公式是：</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>F</mi><mn>1</mn><mo>=</mo><mn>2</mn><mo>×</mo><mfrac><mrow><mtext>Precision</mtext><mo>×</mo><mtext>Recall</mtext></mrow><mrow><mtext>Precision</mtext><mo>+</mo><mtext>Recall</mtext></mrow></mfrac></mrow><annotation encoding=\"application/x-tex\">F1 = 2 \\times \\frac{\\text{Precision} \\times \\text{Recall}}{\\text{Precision} + \\text{Recall}}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.14077em;vertical-align:-0.7693300000000001em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.37144em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">Precision</span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord text\"><span class=\"mord\">Recall</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">Precision</span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord text\"><span class=\"mord\">Recall</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7693300000000001em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span></p>\n<p><strong>调和平均数的特点：</strong> 它对 “极小值” 非常敏感。如果 Precision 或 Recall 其中一个非常低，整个 F1-Score 就会被拉得很低，取值范围是 0~1。</p>\n<h1 id=\"iou交并比\"><a class=\"markdownIt-Anchor\" href=\"#iou交并比\">#</a> IOU 交并比</h1>\n<p>IoU 衡量的是<strong>模型预测的边界框</strong>与<strong>真实的边界框</strong>之间的重叠程度。</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>I</mi><mi>o</mi><mi>U</mi><mo>=</mo><mfrac><mtext>Area of Overlap</mtext><mtext>Area of Union</mtext></mfrac></mrow><annotation encoding=\"application/x-tex\">IoU = \\frac{\\text{Area of Overlap}}{\\text{Area of Union}}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.0574399999999997em;vertical-align:-0.686em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.3714399999999998em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">Area of Union</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">Area of Overlap</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span></p>\n<h1 id=\"nms非极大值抑制\"><a class=\"markdownIt-Anchor\" href=\"#nms非极大值抑制\">#</a> NMS 非极大值抑制</h1>\n<p>当你运行一个检测模型时，模型往往非常热心，会在同一个物体周围画出成百上千个重叠的候选框。NMS 的作用就是：<strong>在这一堆框里，只选出最准的那一个，把剩下的删掉。</strong></p>\n<ol>\n<li><strong>排序</strong>：将所有候选框按<strong>置信度得分</strong>从高到低排序。</li>\n<li><strong>选中</strong>：挑选得分最高的框，把它作为最终结果保存。</li>\n<li><strong>比较与删除</strong>：计算剩下的所有框与 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>A</mi></mrow><annotation encoding=\"application/x-tex\">A</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">A</span></span></span></span> 的 <strong>IoU</strong>。如果某个框与 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>A</mi></mrow><annotation encoding=\"application/x-tex\">A</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">A</span></span></span></span> 的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>I</mi><mi>o</mi><mi>U</mi></mrow><annotation encoding=\"application/x-tex\">IoU</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span></span></span></span> 超过了预设的<strong>阈值</strong>（比如 0.5），就认为这个框和 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>A</mi></mrow><annotation encoding=\"application/x-tex\">A</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">A</span></span></span></span> 预测的是同一个物体，直接把它<strong>删掉</strong>。</li>\n<li><strong>循环</strong>：在剩下的框中继续找得分最高的，重复上述过程，直到处理完所有框。</li>\n</ol>\n<p>为什么不找一个置信度最高的的一个框就完事了呢，那是因为，我们在一张图片里有好多要检测的目标，如果只选择最大的那就只保留了一个，这是不合理的。</p>\n<p>这就是 <strong>NMS</strong> 算法设计的精妙之处：它不是简单的全场选最高，而是<strong>局部选最高</strong>。</p>\n<h1 id=\"confidence置信度\"><a class=\"markdownIt-Anchor\" href=\"#confidence置信度\">#</a> Confidence 置信度</h1>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mtext>Confidence</mtext><mo>=</mo><mi>P</mi><mi>r</mi><mo stretchy=\"false\">(</mo><mi>O</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mo stretchy=\"false\">)</mo><mo>×</mo><msubsup><mtext>IoU</mtext><mrow><mi>p</mi><mi>r</mi><mi>e</mi><mi>d</mi></mrow><mrow><mi>t</mi><mi>r</mi><mi>u</mi><mi>t</mi><mi>h</mi></mrow></msubsup></mrow><annotation encoding=\"application/x-tex\">\\text{Confidence} = Pr(Object) \\times \\text{IoU}_{pred}^{truth}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord text\"><span class=\"mord\">Confidence</span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.3054459999999999em;vertical-align:-0.383108em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">IoU</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9223379999999999em;\"><span style=\"top:-2.4530000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">p</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal mtight\">e</span><span class=\"mord mathnormal mtight\">d</span></span></span></span><span style=\"top:-3.1362300000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal mtight\">u</span><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\">h</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.383108em;\"><span></span></span></span></span></span></span></span></span></span></span></p>\n<p><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>P</mi><mi>r</mi><mo stretchy=\"false\">(</mo><mi>O</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">Pr(Object)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mclose\">)</span></span></span></span></strong>：是一个概率值，取值范围在 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">[</mo><mn>0</mn><mo separator=\"true\">,</mo><mn>1</mn><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">[0, 1]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">[</span><span class=\"mord\">0</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">]</span></span></span></span> 之间。</p>\n<ul>\n<li>如果框内包含物体的中心点，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>P</mi><mi>r</mi><mo stretchy=\"false\">(</mo><mi>O</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">Pr(Object) = 1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span>。</li>\n<li>如果框内只有背景，没有任何物体中心点，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>P</mi><mi>r</mi><mo stretchy=\"false\">(</mo><mi>O</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mn>0</mn></mrow><annotation encoding=\"application/x-tex\">Pr(Object) = 0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">0</span></span></span></span>。</li>\n</ul>\n<p><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msubsup><mtext>IoU</mtext><mrow><mi>p</mi><mi>r</mi><mi>e</mi><mi>d</mi></mrow><mrow><mi>t</mi><mi>r</mi><mi>u</mi><mi>t</mi><mi>h</mi></mrow></msubsup></mrow><annotation encoding=\"application/x-tex\">\\text{IoU}_{pred}^{truth}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.3054459999999999em;vertical-align:-0.383108em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">IoU</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9223379999999999em;\"><span style=\"top:-2.4530000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">p</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal mtight\">e</span><span class=\"mord mathnormal mtight\">d</span></span></span></span><span style=\"top:-3.1362300000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal mtight\">u</span><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\">h</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.383108em;\"><span></span></span></span></span></span></span></span></span></span></strong>：预测框与真实框之间的重叠程度。</p>\n<h1 id=\"特定类别得分\"><a class=\"markdownIt-Anchor\" href=\"#特定类别得分\">#</a> 特定类别得分</h1>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mtext>Score</mtext><mo>=</mo><mi>P</mi><mi>r</mi><mo stretchy=\"false\">(</mo><mi>O</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mo stretchy=\"false\">)</mo><mo>×</mo><mtext>IoU</mtext><mo>×</mo><mi>P</mi><mi>r</mi><mo stretchy=\"false\">(</mo><mi>C</mi><mi>l</mi><mi>a</mi><mi>s</mi><msub><mi>s</mi><mi>i</mi></msub><mi mathvariant=\"normal\">∣</mi><mi>O</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\text{Score} = Pr(Object) \\times \\text{IoU} \\times Pr(Class_i | Object)\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord text\"><span class=\"mord\">Score</span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.76666em;vertical-align:-0.08333em;\"></span><span class=\"mord text\"><span class=\"mord\">IoU</span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">s</span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord\">∣</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mclose\">)</span></span></span></span></span></p>\n<p><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>P</mi><mi>r</mi><mo stretchy=\"false\">(</mo><mi>C</mi><mi>l</mi><mi>a</mi><mi>s</mi><msub><mi>s</mi><mi>i</mi></msub><mi mathvariant=\"normal\">∣</mi><mi>O</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">Pr(Class_i | Object)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">s</span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord\">∣</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mclose\">)</span></span></span></span></strong>：这是<strong>条件类别概率</strong>，即在已经确定有物体的前提下，它是狗的概率。</p>\n<p><strong>最终得分</strong>：综合了有没有东西、框得准不准以及是什么东西这三个因素。</p>\n<h1 id=\"pr-曲线\"><a class=\"markdownIt-Anchor\" href=\"#pr-曲线\">#</a> PR 曲线</h1>\n<p><strong>PR 曲线</strong> 是衡量分类模型性能的另一把尺。它展示了在不同的<strong>置信度阈值</strong>下，<strong>精确率</strong> 和 <strong>召回率</strong> 之间的博弈关系。</p>\n<p>当我们使用模型预测时，通常会得到一个概率值。我们需要设定一个<strong>阈值</strong>来决定它是正还是负。</p>\n<ul>\n<li>如果阈值设为 <strong>0.9</strong> 很严苛：只有极有把握的才算正例，<strong>精确率会很高，但会漏掉很多，召回率低</strong>。</li>\n<li>如果阈值设为 <strong>0.1</strong> 很宽松：宁可错抓不可放过，<strong>召回率会很高，但误报也多，精确率低</strong>。</li>\n</ul>\n<p>PR 曲线就是把阈值从 0 变到 1 的过程中，所有的 Recall 与 Precision 坐标点连成的线。</p>\n<p>横轴是 Recall 召回率，纵轴是 Precision 精确率。它常是一条向右下方倾斜的曲线。当召回率上升时，精确率往往会下降。</p>\n<p><strong>理想位置</strong>：曲线越靠近<strong>右上角</strong>（1, 1）越好。这意味着模型能同时保持高精确率和高召回率。</p>\n<h1 id=\"map\"><a class=\"markdownIt-Anchor\" href=\"#map\">#</a> mAP</h1>\n<p>mAP: mean Average Precision</p>\n<p>AP: Average Precision， <strong>AP</strong> 是 <strong>PR 曲线下方的面积</strong>。</p>\n<p>m: mean</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mtext>mAP</mtext><mo>=</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><mi>A</mi><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\text{mAP} = \\frac{1}{N} \\sum_{i=1}^{N} AP_i\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord text\"><span class=\"mord\">mAP</span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:3.106005em;vertical-align:-1.277669em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.32144em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000002em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">1</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">N</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">A</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></span></p>\n<p>mAP 反映了模型的<strong>全能程度</strong>。如果一个模型只会认猫，不认识狗，那么它的 mAP 就会被拉低。mAP 是衡量模型好坏的终极标准。它不仅看模型能不能分类正确，还看模型框得准不准。</p>\n<h1 id=\"fps\"><a class=\"markdownIt-Anchor\" href=\"#fps\">#</a> FPS</h1>\n<p>在模型评价指标中，如果说 <strong>mAP</strong> 衡量的是模型<strong>聪不聪明</strong>，那么 <strong>FPS</strong> 衡量的就是模型<strong>快不快</strong>。FPS 即每秒传输帧数，是衡量模型推理速度的核心指标。</p>\n",
            "tags": [
                "深度学习",
                "深度学习基础",
                "python",
                "CNN",
                "深度学习",
                "YOLO"
            ]
        },
        {
            "id": "https://735690757.github.io/python/YOLO/YOLO_V3/",
            "url": "https://735690757.github.io/python/YOLO/YOLO_V3/",
            "title": "YOLO-V3",
            "date_published": "2026-01-05T04:12:12.000Z",
            "content_html": "<h1 id=\"yolov3\"><a class=\"markdownIt-Anchor\" href=\"#yolov3\">#</a> YOLOv3</h1>\n<h2 id=\"原文\"><a class=\"markdownIt-Anchor\" href=\"#原文\">#</a> 原文</h2>\n<p>YOLOv3: An Incremental Improvement(YOLOv3): [<span class=\"exturl\" data-url=\"aHR0cHM6Ly9hcnhpdi5vcmcvYWJzLzE4MDQuMDI3Njc=\">https://arxiv.org/abs/1804.02767</span>]</p>\n<h2 id=\"网络结构\"><a class=\"markdownIt-Anchor\" href=\"#网络结构\">#</a> 网络结构</h2>\n<img data-src=\"../../../images/python/YOLO/v3/1.png\" alt=\"v1\"  />\n<p>在检测头，他这个数值标错了。</p>\n<img data-src=\"../../../images/python/YOLO/v3/2.png\" alt=\"v1\"  />\n<hr>\n<p>他这个用步幅为 2 的卷积带代替池化操作了，可以看到他又把全连接拿回来了。</p>\n<img data-src=\"../../../images/python/YOLO/v3/5.png\" alt=\"v1\"  />\n<h2 id=\"图像金字塔fpn\"><a class=\"markdownIt-Anchor\" href=\"#图像金字塔fpn\">#</a> 图像金字塔 FPN</h2>\n<img data-src=\"../../../images/python/YOLO/v3/3.png\" alt=\"v1\"  />\n<p>特征金字塔网络 FPN，这是它相比 YOLOv2 最重大的改进之一。这一设计极大地提升了模型对多尺度目标尤其是小目标的检测能力。</p>\n<p>YOLOv3 在主干网络 Darknet-53 的基础上，提取了三个不同跨度的特征图进行预测：</p>\n<ul>\n<li><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>13</mn><mo>×</mo><mn>13</mn></mrow><annotation encoding=\"application/x-tex\">13 \\times 13</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">1</span><span class=\"mord\">3</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\">3</span></span></span></span> 输出层：</strong> 对应深层特征，感受野最大，负责检测<strong>大尺寸</strong>物体。</li>\n<li><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>26</mn><mo>×</mo><mn>26</mn></mrow><annotation encoding=\"application/x-tex\">26 \\times 26</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">2</span><span class=\"mord\">6</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">2</span><span class=\"mord\">6</span></span></span></span> 输出层：</strong> 对应中层特征，负责检测<strong>中等尺寸</strong>物体。</li>\n<li><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>52</mn><mo>×</mo><mn>52</mn></mrow><annotation encoding=\"application/x-tex\">52 \\times 52</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">5</span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">5</span><span class=\"mord\">2</span></span></span></span> 输出层：</strong> 对应浅层特征，感受野较小，负责检测<strong>小尺寸</strong>物体。</li>\n</ul>\n<p>为了让浅层也拥有深层的语义信息，YOLOv3 执行了以下操作：</p>\n<ol>\n<li><strong>上采样：</strong> 将 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>13</mn><mo>×</mo><mn>13</mn></mrow><annotation encoding=\"application/x-tex\">13 \\times 13</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">1</span><span class=\"mord\">3</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\">3</span></span></span></span> 的特征图通过上采样放大 2 倍，变为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>26</mn><mo>×</mo><mn>26</mn></mrow><annotation encoding=\"application/x-tex\">26 \\times 26</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">2</span><span class=\"mord\">6</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">2</span><span class=\"mord\">6</span></span></span></span>。</li>\n<li><strong>拼接：</strong> 将上采样后的特征图与 Darknet-53 中对应的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>26</mn><mo>×</mo><mn>26</mn></mrow><annotation encoding=\"application/x-tex\">26 \\times 26</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">2</span><span class=\"mord\">6</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">2</span><span class=\"mord\">6</span></span></span></span> 原始特征图进行<strong>通道拼接</strong>，原始 FPN 是逐元素相加，而 YOLOv3 是沿通道维度的 Concat，这点非常重要。</li>\n<li><strong>循环操作：</strong> 同样的逻辑也应用在 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>26</mn><mo>×</mo><mn>26</mn></mrow><annotation encoding=\"application/x-tex\">26 \\times 26</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">2</span><span class=\"mord\">6</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">2</span><span class=\"mord\">6</span></span></span></span> 到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>52</mn><mo>×</mo><mn>52</mn></mrow><annotation encoding=\"application/x-tex\">52 \\times 52</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">5</span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">5</span><span class=\"mord\">2</span></span></span></span> 的过程中。</li>\n</ol>\n<p>在深度学习的特征融合中，主要有两种方式：<strong>Add 逐元素相加</strong> 和 <strong>Concat 通道拼接</strong>。YOLOv3 的 FPN 结构明确使用了 <strong>Concat</strong>。</p>\n<p>上采样后，对于原始格子来说相当于变多了，这意味这感受野下降，但更聚焦于小目标。</p>\n<h3 id=\"为什么要用concat而不是add\"><a class=\"markdownIt-Anchor\" href=\"#为什么要用concat而不是add\">#</a> 为什么要用 Concat 而不是 Add？</h3>\n<p>Concat 不会改变原始特征图的数值，它只是把深层的 “语义信息” 和浅层的 “位置信息” 放在一起，交给后面的卷积层去自动学习如何加权利用。通过增加通道数，网络可以同时看到来自不同尺度的特征表达。</p>\n<h3 id=\"好像u-net\"><a class=\"markdownIt-Anchor\" href=\"#好像u-net\">#</a> 好像 U-Net？</h3>\n<p>YOLOv3 的 FPN 构建了一个类似的流程：</p>\n<ul>\n<li><strong>左侧下采样 / 编码器</strong>：在 YOLOv3 中是 Darknet-53 主干网络，负责提取特征。</li>\n<li><strong>右侧上采样 / 解码器</strong>：YOLOv3 通过上采样不断恢复分辨率。</li>\n<li><strong>中间使用跳跃连接</strong>：两者都将左侧的特征图直接传递到右侧，与上采样后的特征进行 <strong>Concat</strong>。</li>\n</ul>\n<h2 id=\"concat\"><a class=\"markdownIt-Anchor\" href=\"#concat\">#</a> Concat</h2>\n<p>在 YOLO 里，这个 Concat 本质上就是堆叠通道</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>上采样后的高层特征: <span class=\"token punctuation\">(</span>B, <span class=\"token number\">256</span>, <span class=\"token number\">26</span>, <span class=\"token number\">26</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>浅层特征:           <span class=\"token punctuation\">(</span>B, <span class=\"token number\">256</span>, <span class=\"token number\">26</span>, <span class=\"token number\">26</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>----------------------------------</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Concat<span class=\"token punctuation\">(</span>dim<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>↓</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>输出特征:           <span class=\"token punctuation\">(</span>B, <span class=\"token number\">512</span>, <span class=\"token number\">26</span>, <span class=\"token number\">26</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h2 id=\"检测头\"><a class=\"markdownIt-Anchor\" href=\"#检测头\">#</a> 检测头</h2>\n <img data-src=\"../../../images/python/YOLO/v3/4.png\" alt=\"v1\"  />\n<p>如上图所示，<strong>YOLOv3 一共有 9 个 Anchor</strong>，但在每一个预测层上，它只使用其中的 <strong>3 个</strong>。</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\"><strong>预测层尺度</strong></th>\n<th style=\"text-align:center\"><strong>负责目标</strong></th>\n<th style=\"text-align:center\"><strong>分配的 Anchor 数量</strong></th>\n<th style=\"text-align:center\"><strong>说明</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\"><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>13</mn><mo>×</mo><mn>13</mn></mrow><annotation encoding=\"application/x-tex\">13 \\times 13</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">1</span><span class=\"mord\">3</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\">3</span></span></span></span></strong></td>\n<td style=\"text-align:center\"><strong>大物体</strong></td>\n<td style=\"text-align:center\">3 个</td>\n<td style=\"text-align:center\">感受野大，适合抓大个子。</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>26</mn><mo>×</mo><mn>26</mn></mrow><annotation encoding=\"application/x-tex\">26 \\times 26</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">2</span><span class=\"mord\">6</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">2</span><span class=\"mord\">6</span></span></span></span></strong></td>\n<td style=\"text-align:center\"><strong>中物体</strong></td>\n<td style=\"text-align:center\">3 个</td>\n<td style=\"text-align:center\">兼顾语义和细节。</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>52</mn><mo>×</mo><mn>52</mn></mrow><annotation encoding=\"application/x-tex\">52 \\times 52</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">5</span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">5</span><span class=\"mord\">2</span></span></span></span></strong></td>\n<td style=\"text-align:center\"><strong>小物体</strong></td>\n<td style=\"text-align:center\">3 个</td>\n<td style=\"text-align:center\">分辨率高，专门抓细小目标。</td>\n</tr>\n</tbody>\n</table>\n<p>如果只说聚类出来的，为什么不聚类成 6 个或 12 个？我想这是<strong>经验科学</strong>与<strong>计算效率</strong>妥协的结果。</p>\n<p>YOLOv3 的特征金字塔有 <strong>3 个输出层</strong>。为了保证模型的<strong>对称性</strong>和<strong>代码实现的简洁性</strong>，作者给每个层分配了相同数量的 Anchor。如果每层只给 1 个 Anchor，覆盖的形状太少，如果每层给 5 个，总共 15 个，模型最后一层的通道数会变得非常臃肿，推理速度大幅下降。也可能是超过 9 个以后，准确率的提升已经微乎其微，但计算量却在持续线性增加，这是覆盖率的边际效益。</p>\n<h3 id=\"重提xywhc\"><a class=\"markdownIt-Anchor\" href=\"#重提xywhc\">#</a> 重提 x,y,w,h,c</h3>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\"><strong>字母</strong></th>\n<th style=\"text-align:center\"><strong>全称</strong></th>\n<th style=\"text-align:center\"><strong>含义</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\"><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi><mo separator=\"true\">,</mo><mi>y</mi></mrow><annotation encoding=\"application/x-tex\">x, y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span></span></strong></td>\n<td style=\"text-align:center\"><strong>Coordinates</strong></td>\n<td style=\"text-align:center\">预测框的<strong>中心点坐标</strong>相对于当前格子的偏移量。</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>w</mi><mo separator=\"true\">,</mo><mi>h</mi></mrow><annotation encoding=\"application/x-tex\">w, h</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">h</span></span></span></span></strong></td>\n<td style=\"text-align:center\"><strong>Width / Height</strong></td>\n<td style=\"text-align:center\">预测框的<strong>宽度和高度</strong>相对于 Anchor 尺寸的缩放比例。</td>\n</tr>\n<tr>\n<td style=\"text-align:center\"><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi></mrow><annotation encoding=\"application/x-tex\">c</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">c</span></span></span></span></strong></td>\n<td style=\"text-align:center\"><strong>Confidence</strong></td>\n<td style=\"text-align:center\"><strong>置信度</strong>，代表这个框里 “有物体” 的概率以及框得 “准不准”。</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"损失函数\"><a class=\"markdownIt-Anchor\" href=\"#损失函数\">#</a> 损失函数</h2>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>L</mi><mi>o</mi><mi>s</mi><mi>s</mi><mo>=</mo><mi>L</mi><mi>o</mi><mi>s</mi><msub><mi>s</mi><mrow><mi>c</mi><mi>o</mi><mi>o</mi><mi>r</mi><mi>d</mi><mi>i</mi><mi>n</mi><mi>a</mi><mi>t</mi><mi>e</mi></mrow></msub><mo>+</mo><mi>L</mi><mi>o</mi><mi>s</mi><msub><mi>s</mi><mrow><mi>c</mi><mi>o</mi><mi>n</mi><mi>f</mi><mi>i</mi><mi>d</mi><mi>e</mi><mi>n</mi><mi>c</mi><mi>e</mi></mrow></msub><mo>+</mo><mi>L</mi><mi>o</mi><mi>s</mi><msub><mi>s</mi><mrow><mi>c</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi><mi>i</mi><mi>f</mi><mi>i</mi><mi>c</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">Loss = Loss_{coordinate} + Loss_{confidence} + Loss_{classification}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">L</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\">L</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">s</span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal mtight\">d</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">n</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\">e</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord mathnormal\">L</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">s</span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">n</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">d</span><span class=\"mord mathnormal mtight\">e</span><span class=\"mord mathnormal mtight\">n</span><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\">e</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord mathnormal\">L</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">s</span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">s</span><span class=\"mord mathnormal mtight\">s</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">n</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span></span></p>\n<p>Coordinate Loss 坐标损失 ：这部分负责让框画得更准。它只针对<strong>正样本</strong>计算。统一使用 <strong>BCE Loss</strong>。</p>\n<p>Confidence Loss 置信度损失：这部分负责判断 “有没有物体”。它是训练中最关键的部分，因为它要处理严重的<strong>正负样本不平衡</strong>。统一使用 <strong>BCE Loss</strong>。</p>\n<p>Classification Loss：这部分负责判断 “是什么物体”。统一使用 <strong>BCE Loss</strong>。</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mtable rowspacing=\"0.24999999999999992em\" columnalign=\"right\" columnspacing=\"\"><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mi>L</mi><mo>=</mo><msub><mi>λ</mi><mrow><mi>c</mi><mi>o</mi><mi>o</mi><mi>r</mi><mi>d</mi></mrow></msub><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><msup><mi>G</mi><mn>2</mn></msup></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>B</mi></munderover><msubsup><mn mathvariant=\"double-struck\">1</mn><mrow><mi>i</mi><mi>j</mi></mrow><mrow><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msubsup><mrow><mo fence=\"true\">[</mo><mi>B</mi><mi>C</mi><mi>E</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><mover accent=\"true\"><mi>x</mi><mo>^</mo></mover><mo stretchy=\"false\">)</mo><mo>+</mo><mi>B</mi><mi>C</mi><mi>E</mi><mo stretchy=\"false\">(</mo><mi>y</mi><mo separator=\"true\">,</mo><mover accent=\"true\"><mi>y</mi><mo>^</mo></mover><mo stretchy=\"false\">)</mo><mo>+</mo><mi>M</mi><mi>S</mi><mi>E</mi><mo stretchy=\"false\">(</mo><mi>w</mi><mo separator=\"true\">,</mo><mover accent=\"true\"><mi>w</mi><mo>^</mo></mover><mo stretchy=\"false\">)</mo><mo>+</mo><mi>M</mi><mi>S</mi><mi>E</mi><mo stretchy=\"false\">(</mo><mi>h</mi><mo separator=\"true\">,</mo><mover accent=\"true\"><mi>h</mi><mo>^</mo></mover><mo stretchy=\"false\">)</mo><mo fence=\"true\">]</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mo>+</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><msup><mi>G</mi><mn>2</mn></msup></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>B</mi></munderover><msubsup><mn mathvariant=\"double-struck\">1</mn><mrow><mi>i</mi><mi>j</mi></mrow><mrow><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msubsup><mrow><mo fence=\"true\">[</mo><mi>B</mi><mi>C</mi><mi>E</mi><mo stretchy=\"false\">(</mo><mi>c</mi><mo separator=\"true\">,</mo><mn>1</mn><mo stretchy=\"false\">)</mo><mo fence=\"true\">]</mo></mrow><mo>+</mo><msub><mi>λ</mi><mrow><mi>n</mi><mi>o</mi><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msub><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><msup><mi>G</mi><mn>2</mn></msup></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>B</mi></munderover><msubsup><mn mathvariant=\"double-struck\">1</mn><mrow><mi>i</mi><mi>j</mi></mrow><mrow><mi>n</mi><mi>o</mi><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msubsup><mrow><mo fence=\"true\">[</mo><mi>B</mi><mi>C</mi><mi>E</mi><mo stretchy=\"false\">(</mo><mi>c</mi><mo separator=\"true\">,</mo><mn>0</mn><mo stretchy=\"false\">)</mo><mo fence=\"true\">]</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mo>+</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><msup><mi>G</mi><mn>2</mn></msup></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>B</mi></munderover><msubsup><mn mathvariant=\"double-struck\">1</mn><mrow><mi>i</mi><mi>j</mi></mrow><mrow><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msubsup><munder><mo>∑</mo><mrow><mi>k</mi><mo>∈</mo><mi>c</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi><mi>e</mi><mi>s</mi></mrow></munder><mi>B</mi><mi>C</mi><mi>E</mi><mo stretchy=\"false\">(</mo><msub><mi>p</mi><mi>k</mi></msub><mo separator=\"true\">,</mo><msub><mover accent=\"true\"><mi>p</mi><mo>^</mo></mover><mi>k</mi></msub><mo stretchy=\"false\">)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding=\"application/x-tex\">\\begin{aligned}\nL = \\lambda_{coord} \\sum_{i=0}^{G^2} \\sum_{j=0}^{B} \\mathbb{1}_{ij}^{obj} \\left[ BCE(x, \\hat{x}) + BCE(y, \\hat{y}) + MSE(w, \\hat{w}) + MSE(h, \\hat{h}) \\right] \\\\\n+ \\sum_{i=0}^{G^2} \\sum_{j=0}^{B} \\mathbb{1}_{ij}^{obj} \\left[ BCE(c, 1) \\right] + \\lambda_{noobj} \\sum_{i=0}^{G^2} \\sum_{j=0}^{B} \\mathbb{1}_{ij}^{noobj} \\left[ BCE(c, 0) \\right] \\\\\n+ \\sum_{i=0}^{G^2} \\sum_{j=0}^{B} \\mathbb{1}_{ij}^{obj} \\sum_{k \\in classes} BCE(p_k, \\hat{p}_k)\n\\end{aligned}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:11.063106000000001em;vertical-align:-5.281553000000001em;\"></span><span class=\"mord\"><span class=\"mtable\"><span class=\"col-align-r\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:5.781553000000001em;\"><span style=\"top:-7.781553000000001em;\"><span class=\"pstrut\" style=\"height:3.9739250000000004em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">L</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal mtight\">d</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.9739250000000004em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">G</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8913142857142857em;\"><span style=\"top:-2.931em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\">1</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9670159999999999em;\"><span style=\"top:-2.4231360000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.412972em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size2\">[</span></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.22222em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.19444em;\"><span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">M</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.16666em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">M</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">h</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9578799999999998em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">h</span></span></span><span style=\"top:-3.26344em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.25em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size2\">]</span></span></span></span></span><span style=\"top:-4.093850999999999em;\"><span class=\"pstrut\" style=\"height:3.9739250000000004em;\"></span><span class=\"mord\"><span class=\"mord\">+</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.9739250000000004em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">G</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8913142857142857em;\"><span style=\"top:-2.931em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\">1</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9670159999999999em;\"><span style=\"top:-2.4231360000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.412972em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\">[</span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">c</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">)</span><span class=\"mclose delimcenter\" style=\"top:0em;\">]</span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.9739250000000004em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">G</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8913142857142857em;\"><span style=\"top:-2.931em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\">1</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9670159999999999em;\"><span style=\"top:-2.4231360000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.412972em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\">[</span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">c</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">0</span><span class=\"mclose\">)</span><span class=\"mclose delimcenter\" style=\"top:0em;\">]</span></span></span></span><span style=\"top:-0.40614899999999965em;\"><span class=\"pstrut\" style=\"height:3.9739250000000004em;\"></span><span class=\"mord\"><span class=\"mord\">+</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.9739250000000004em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">G</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8913142857142857em;\"><span style=\"top:-2.931em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\">1</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9670159999999999em;\"><span style=\"top:-2.4231360000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.412972em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.050005em;\"><span style=\"top:-1.8478869999999998em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span><span class=\"mrel mtight\">∈</span><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">s</span><span class=\"mord mathnormal mtight\">s</span><span class=\"mord mathnormal mtight\">e</span><span class=\"mord mathnormal mtight\">s</span></span></span></span><span style=\"top:-3.0500049999999996em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.329483em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.16666em;\"><span class=\"mord\">^</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.19444em;\"><span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:5.281553000000001em;\"><span></span></span></span></span></span></span></span></span></span></span></span></p>\n<p>置信度损失分为两部分：<strong>有物体的网格（正样本）</strong> 和 <strong>没有物体的网格（负样本）</strong>。</p>\n<p>二值交叉熵 BCE 公式：</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>B</mi><mi>C</mi><mi>E</mi><mo stretchy=\"false\">(</mo><mi>y</mi><mo separator=\"true\">,</mo><mover accent=\"true\"><mi>y</mi><mo>^</mo></mover><mo stretchy=\"false\">)</mo><mo>=</mo><mo>−</mo><mo stretchy=\"false\">[</mo><mi>y</mi><mi>log</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><mover accent=\"true\"><mi>y</mi><mo>^</mo></mover><mo stretchy=\"false\">)</mo><mo>+</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>−</mo><mi>y</mi><mo stretchy=\"false\">)</mo><mi>log</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>−</mo><mover accent=\"true\"><mi>y</mi><mo>^</mo></mover><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">BCE(y, \\hat{y}) = - [y \\log(\\hat{y}) + (1 - y) \\log(1 - \\hat{y})]\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.19444em;\"><span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">−</span><span class=\"mopen\">[</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mopen\">(</span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.19444em;\"><span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.19444em;\"><span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mclose\">]</span></span></span></span></span></p>\n<p>最终的展开：</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mtable rowspacing=\"0.24999999999999992em\" columnalign=\"right\" columnspacing=\"\"><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mi>L</mi><mi>o</mi><mi>s</mi><msub><mi>s</mi><mrow><mi>c</mi><mi>o</mi><mi>n</mi><mi>f</mi></mrow></msub><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><msup><mi>G</mi><mn>2</mn></msup></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>B</mi></munderover><msubsup><mn mathvariant=\"double-struck\">1</mn><mrow><mi>i</mi><mi>j</mi></mrow><mrow><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msubsup><mrow><mo fence=\"true\">[</mo><mi>B</mi><mi>C</mi><mi>E</mi><mo stretchy=\"false\">(</mo><mi>c</mi><mo separator=\"true\">,</mo><mn>1</mn><mo stretchy=\"false\">)</mo><mo fence=\"true\">]</mo></mrow><mo>+</mo><msub><mi>λ</mi><mrow><mi>n</mi><mi>o</mi><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msub><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><msup><mi>G</mi><mn>2</mn></msup></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>B</mi></munderover><msubsup><mn mathvariant=\"double-struck\">1</mn><mrow><mi>i</mi><mi>j</mi></mrow><mrow><mi>n</mi><mi>o</mi><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msubsup><mrow><mo fence=\"true\">[</mo><mi>B</mi><mi>C</mi><mi>E</mi><mo stretchy=\"false\">(</mo><mi>c</mi><mo separator=\"true\">,</mo><mn>0</mn><mo stretchy=\"false\">)</mo><mo fence=\"true\">]</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mo>=</mo><mo>−</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><msup><mi>G</mi><mn>2</mn></msup></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>B</mi></munderover><msubsup><mn mathvariant=\"double-struck\">1</mn><mrow><mi>i</mi><mi>j</mi></mrow><mrow><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msubsup><mrow><mo fence=\"true\">[</mo><msub><mover accent=\"true\"><mi>c</mi><mo>^</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mi>log</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><msub><mi>c</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy=\"false\">)</mo><mo>+</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>−</mo><msub><mover accent=\"true\"><mi>c</mi><mo>^</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy=\"false\">)</mo><mi>log</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>−</mo><msub><mi>c</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy=\"false\">)</mo><mo fence=\"true\">]</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mo>−</mo><msub><mi>λ</mi><mrow><mi>n</mi><mi>o</mi><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msub><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><msup><mi>G</mi><mn>2</mn></msup></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>B</mi></munderover><msubsup><mn mathvariant=\"double-struck\">1</mn><mrow><mi>i</mi><mi>j</mi></mrow><mrow><mi>n</mi><mi>o</mi><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msubsup><mrow><mo fence=\"true\">[</mo><msub><mover accent=\"true\"><mi>c</mi><mo>^</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mi>log</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><msub><mi>c</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy=\"false\">)</mo><mo>+</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>−</mo><msub><mover accent=\"true\"><mi>c</mi><mo>^</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy=\"false\">)</mo><mi>log</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>−</mo><msub><mi>c</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy=\"false\">)</mo><mo fence=\"true\">]</mo></mrow></mrow></mstyle></mtd></mtr></mtable><annotation encoding=\"application/x-tex\">\\begin{aligned} Loss_{conf} =\\sum_{i=0}^{G^2} \\sum_{j=0}^{B} \\mathbb{1}_{ij}^{obj} \\left[ BCE(c, 1) \\right] + \\lambda_{noobj} \\sum_{i=0}^{G^2} \\sum_{j=0}^{B} \\mathbb{1}_{ij}^{noobj} \\left[ BCE(c, 0) \\right]\\\\\n=-\\sum_{i=0}^{G^2} \\sum_{j=0}^{B} \\mathbb{1}_{ij}^{obj} \\left[ \\hat{c}_{ij} \\log(c_{ij}) + (1 - \\hat{c}_{ij}) \\log(1 - c_{ij}) \\right] \\\\ - \\lambda_{noobj} \\sum_{i=0}^{G^2} \\sum_{j=0}^{B} \\mathbb{1}_{ij}^{noobj} \\left[ \\hat{c}_{ij} \\log(c_{ij}) + (1 - \\hat{c}_{ij}) \\log(1 - c_{ij}) \\right] \\end{aligned}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:11.063106000000001em;vertical-align:-5.281553000000001em;\"></span><span class=\"mord\"><span class=\"mtable\"><span class=\"col-align-r\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:5.781553000000001em;\"><span style=\"top:-7.781553000000001em;\"><span class=\"pstrut\" style=\"height:3.9739250000000004em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">L</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">s</span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">n</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10764em;\">f</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.9739250000000004em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">G</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8913142857142857em;\"><span style=\"top:-2.931em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\">1</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9670159999999999em;\"><span style=\"top:-2.4231360000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.412972em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\">[</span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">c</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">)</span><span class=\"mclose delimcenter\" style=\"top:0em;\">]</span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.9739250000000004em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">G</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8913142857142857em;\"><span style=\"top:-2.931em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\">1</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9670159999999999em;\"><span style=\"top:-2.4231360000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.412972em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\">[</span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">c</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">0</span><span class=\"mclose\">)</span><span class=\"mclose delimcenter\" style=\"top:0em;\">]</span></span></span></span><span style=\"top:-4.093850999999999em;\"><span class=\"pstrut\" style=\"height:3.9739250000000004em;\"></span><span class=\"mord\"><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mord\">−</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.9739250000000004em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">G</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8913142857142857em;\"><span style=\"top:-2.931em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\">1</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9670159999999999em;\"><span style=\"top:-2.4231360000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.412972em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\">[</span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mclose delimcenter\" style=\"top:0em;\">]</span></span></span></span><span style=\"top:-0.40614899999999965em;\"><span class=\"pstrut\" style=\"height:3.9739250000000004em;\"></span><span class=\"mord\"><span class=\"mord\">−</span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.9739250000000004em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">G</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8913142857142857em;\"><span style=\"top:-2.931em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\">1</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9670159999999999em;\"><span style=\"top:-2.4231360000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.412972em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\">[</span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mclose delimcenter\" style=\"top:0em;\">]</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:5.281553000000001em;\"><span></span></span></span></span></span></span></span></span></span></span></span></p>\n<p><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msubsup><mn mathvariant=\"double-struck\">1</mn><mrow><mi>i</mi><mi>j</mi></mrow><mrow><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msubsup></mrow><annotation encoding=\"application/x-tex\">\\mathbb{1}_{ij}^{obj}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.379988em;vertical-align:-0.412972em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\">1</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9670159999999999em;\"><span style=\"top:-2.4231360000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.412972em;\"><span></span></span></span></span></span></span></span></span></span></strong>：这是一个 “开关”。只有当第 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>i</mi></mrow><annotation encoding=\"application/x-tex\">i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.65952em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">i</span></span></span></span> 个网格的第 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>j</mi></mrow><annotation encoding=\"application/x-tex\">j</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.85396em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span></span></span></span> 个 Anchor 被分配为<strong>正样本</strong>时，第一行公式才生效。</p>\n<p><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msubsup><mn mathvariant=\"double-struck\">1</mn><mrow><mi>i</mi><mi>j</mi></mrow><mrow><mi>n</mi><mi>o</mi><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msubsup></mrow><annotation encoding=\"application/x-tex\">\\mathbb{1}_{ij}^{noobj}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.379988em;vertical-align:-0.412972em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\">1</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9670159999999999em;\"><span style=\"top:-2.4231360000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.412972em;\"><span></span></span></span></span></span></span></span></span></span></strong>：只有当 Anchor 是<strong>负样本</strong>时，第二行公式才生效。</p>\n<p><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>c</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">c_{ij}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.716668em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span></strong>：模型预测出的置信度值，经过 Sigmoid 激活，在 0 到 1 之间。</p>\n<p><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mover accent=\"true\"><mi>c</mi><mo>^</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\hat{c}_{ij}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.980548em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span>​</strong>：真实值（Label）对于<strong>正样本</strong>，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mover accent=\"true\"><mi>c</mi><mo>^</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">\\hat{c}_{ij} = 1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.980548em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span>，对于<strong>负样本</strong>，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mover accent=\"true\"><mi>c</mi><mo>^</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding=\"application/x-tex\">\\hat{c}_{ij} = 0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.980548em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">0</span></span></span></span>。</p>\n<p><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>λ</mi><mrow><mi>n</mi><mi>o</mi><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\lambda_{noobj}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.980548em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span></strong>：<strong>权重惩罚系数</strong>（通常设为 0.5）。</p>\n<h3 id=\"我要再解释一遍这是求什么\"><a class=\"markdownIt-Anchor\" href=\"#我要再解释一遍这是求什么\">#</a> 我要再解释一遍，这是求什么？</h3>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><msup><mi>G</mi><mn>2</mn></msup></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>B</mi></munderover></mrow><annotation encoding=\"application/x-tex\">\\sum_{i=0}^{G^2} \\sum_{j=0}^{B}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:3.387702em;vertical-align:-1.4137769999999998em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.9739250000000004em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">G</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8913142857142857em;\"><span style=\"top:-2.931em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span></span></span></span></span></p>\n<p>第一个 $ \\sum_<ruby>i=0}<rp>【</rp><rt>{G^2</rt><rp>】</rp></ruby>$：遍历所有网格，第二个 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msubsup><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>B</mi></msubsup></mrow><annotation encoding=\"application/x-tex\">\\sum_{j=0}^{B}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.417049em;vertical-align:-0.43581800000000004em;\"></span><span class=\"mop\"><span class=\"mop op-symbol small-op\" style=\"position:relative;top:-0.0000050000000000050004em;\">∑</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.981231em;\"><span style=\"top:-2.40029em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.2029em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.43581800000000004em;\"><span></span></span></span></span></span></span></span></span></span>：遍历每个网格里的 Anchor</p>\n<p><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mi>G</mi><mn>2</mn></msup></mrow><annotation encoding=\"application/x-tex\">G^2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8141079999999999em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">G</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></strong>：指的是特征图上的网格总数，比如在 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>13</mn><mo>×</mo><mn>13</mn></mrow><annotation encoding=\"application/x-tex\">13 \\times 13</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">1</span><span class=\"mord\">3</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\">3</span></span></span></span> 的尺度下，这个求和符号就会从第 1 个方格一直数到第 169 个方格。</p>\n<p>在 YOLOv3 中，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>B</mi><mo>=</mo><mn>3</mn></mrow><annotation encoding=\"application/x-tex\">B = 3</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">3</span></span></span></span>，每个网格里有 3 个不同形状的 Anchor。这个求和符号就是要在每一个格子里，把这 3 个 Anchor 挨个拎出来算一遍 Loss。</p>\n<p>这个总损失告诉模型：<strong>“在这一张图中，你一共犯了多少错？”</strong></p>\n<p>某个格子的 Anchor 1 没对准，产生定位损失。</p>\n<p>某个格子的 Anchor 2 把背景看成了车，产生置信度损失。</p>\n<p>所有的错误加在一起，模型再根据这个总分进行反向传播，去调整全图的权重。</p>\n<h3 id=\"为什么-yolov3-用-bce-而不是多分类交叉熵\"><a class=\"markdownIt-Anchor\" href=\"#为什么-yolov3-用-bce-而不是多分类交叉熵\">#</a> 为什么 YOLOv3 用 BCE 而不是多分类交叉熵？</h3>\n<p>这是 YOLOv3 的一个重要进步：</p>\n<ol>\n<li><strong>多标签分类</strong>：YOLOv3 认为一个物体可以同时属于多个类，比如它是 “卡车” 也是 “汽车”。</li>\n<li><strong>Softmax 的缺陷</strong>：Softmax 会强迫模型只能选出一个最高分，这在处理重叠标签时效果不好。</li>\n<li><strong>BCE 的优势</strong>：YOLOv3 对每个类别都<strong>独立运行</strong>一个 Sigmoid + BCE。这意味着每个类别都在做一个 “是或不是该类” 的二元判断，从而支持了多标签分类。注意它是对每一个标签独立做的，这一点非常重要。</li>\n</ol>\n<hr>\n<p>在实际写 YOLOv3 代码时，通常不会直接手写这个 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>log</mi><mo>⁡</mo></mrow><annotation encoding=\"application/x-tex\">\\log</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span></span></span></span> 公式，而是调用： <code>torch.nn.BCEWithLogitsLoss()</code></p>\n<h3 id=\"这个函数名里为什么多了一个-withlogits\"><a class=\"markdownIt-Anchor\" href=\"#这个函数名里为什么多了一个-withlogits\">#</a> 这个函数名里为什么多了一个 “WithLogits”？</h3>\n<ol>\n<li><strong>Logits</strong> 是指卷积层输出的原始数值。</li>\n<li>这个函数会自动在内部帮你做一遍 <strong>Sigmoid</strong>，然后再算 <strong>BCE</strong>。</li>\n<li><strong>好处</strong>：由于 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>log</mi><mo>⁡</mo></mrow><annotation encoding=\"application/x-tex\">\\log</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span></span></span></span> 函数在自变量接近 0 时极其不稳定，官方这种合并写法在数学上做了优化，比你自己先写  <code>Sigmoid</code>  再写  <code>BCE</code>  要更<strong>数值稳定</strong>。</li>\n</ol>\n<h3 id=\"强大的类别损失但是谁在贡献损失\"><a class=\"markdownIt-Anchor\" href=\"#强大的类别损失但是谁在贡献损失\">#</a> 强大的类别损失，但是谁在贡献损失？</h3>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><msup><mi>G</mi><mn>2</mn></msup></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>B</mi></munderover><msubsup><mn mathvariant=\"double-struck\">1</mn><mrow><mi>i</mi><mi>j</mi></mrow><mrow><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msubsup><munder><mo>∑</mo><mrow><mi>k</mi><mo>∈</mo><mi>c</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi><mi>e</mi><mi>s</mi></mrow></munder><mi>B</mi><mi>C</mi><mi>E</mi><mo stretchy=\"false\">(</mo><msub><mi>p</mi><mi>k</mi></msub><mo separator=\"true\">,</mo><msub><mover accent=\"true\"><mi>p</mi><mo>^</mo></mover><mi>k</mi></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\sum_{i=0}^{G^2} \\sum_{j=0}^{B} \\mathbb{1}_{ij}^{obj} \\sum_{k \\in classes} BCE(p_k, \\hat{p}_k)\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:3.387702em;vertical-align:-1.4137769999999998em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.9739250000000004em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">G</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8913142857142857em;\"><span style=\"top:-2.931em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\">1</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9670159999999999em;\"><span style=\"top:-2.4231360000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.412972em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.050005em;\"><span style=\"top:-1.8478869999999998em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span><span class=\"mrel mtight\">∈</span><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">s</span><span class=\"mord mathnormal mtight\">s</span><span class=\"mord mathnormal mtight\">e</span><span class=\"mord mathnormal mtight\">s</span></span></span></span><span style=\"top:-3.0500049999999996em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.329483em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.16666em;\"><span class=\"mord\">^</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.19444em;\"><span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></span></p>\n<p>就像我们之前讨论的前两个求和符号负责遍历全图所有的网格和所有的 Anchor。</p>\n<p><strong>指示函数 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msubsup><mn mathvariant=\"double-struck\">1</mn><mrow><mi>i</mi><mi>j</mi></mrow><mrow><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msubsup></mrow><annotation encoding=\"application/x-tex\">\\mathbb{1}_{ij}^{obj}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.379988em;vertical-align:-0.412972em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\">1</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9670159999999999em;\"><span style=\"top:-2.4231360000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.412972em;\"><span></span></span></span></span></span></span></span></span></span></strong>：这是最关键的<strong>过滤器</strong>，只有当这个框是<strong>正样本</strong>即负责预测某个真实物体的那个框时，后面的类别损失才会被计算，负样本或者说是背景不计算类别损失。</p>\n<p>核心公式：</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><munder><mo>∑</mo><mrow><mi>k</mi><mo>∈</mo><mi>c</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi><mi>e</mi><mi>s</mi></mrow></munder><mi>B</mi><mi>C</mi><mi>E</mi><mo stretchy=\"false\">(</mo><msub><mi>p</mi><mi>k</mi></msub><mo separator=\"true\">,</mo><msub><mover accent=\"true\"><mi>p</mi><mo>^</mo></mover><mi>k</mi></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\sum_{k \\in classes} BCE(p_k, \\hat{p}_k)\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:2.3794880000000003em;vertical-align:-1.329483em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.050005em;\"><span style=\"top:-1.8478869999999998em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span><span class=\"mrel mtight\">∈</span><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">s</span><span class=\"mord mathnormal mtight\">s</span><span class=\"mord mathnormal mtight\">e</span><span class=\"mord mathnormal mtight\">s</span></span></span></span><span style=\"top:-3.0500049999999996em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.329483em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.16666em;\"><span class=\"mord\">^</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.19444em;\"><span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></span></p>\n<p>这部分是 YOLOv3 相比 YOLOv2 的重大改进，他对每一个类别进行计算，</p>\n<p>总结来说就是要找出所有的正样本，对它们预测的每一个类别都进行一次对错检查，然后把这些检查结果全部累加。</p>\n<h3 id=\"通俗理解这个过程\"><a class=\"markdownIt-Anchor\" href=\"#通俗理解这个过程\">#</a> 通俗理解这个过程</h3>\n<p>有一个正样本 Anchor：</p>\n<ol>\n<li>它对应的真实物体是一只 “狗”。</li>\n<li>类别标签（<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><mi>p</mi><mo>^</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\hat{p}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.16666em;\"><span class=\"mord\">^</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.19444em;\"><span></span></span></span></span></span></span></span></span>）就是： <code>[0, 0, 1, 0, ... 0]</code>  假设第 3 位是狗，假设一共有 80 个分类。</li>\n<li>模型预测（<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>p</mi></mrow><annotation encoding=\"application/x-tex\">p</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">p</span></span></span></span>）可能是： <code>[0.1, 0.1, 0.8, 0.2, ... 0.05]</code> 。</li>\n<li>计算 Loss 时：\n<ul>\n<li>第 3 位算一次 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>B</mi><mi>C</mi><mi>E</mi><mo stretchy=\"false\">(</mo><mn>0.8</mn><mo separator=\"true\">,</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">BCE(0.8, 1)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mopen\">(</span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">8</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">)</span></span></span></span> —— <strong>“让你像狗，你做得还不够好，扣分。”</strong></li>\n<li>其余 79 位分别算 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>B</mi><mi>C</mi><mi>E</mi><mo stretchy=\"false\">(</mo><msub><mi>p</mi><mi>k</mi></msub><mo separator=\"true\">,</mo><mn>0</mn><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">BCE(p_k, 0)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">0</span><span class=\"mclose\">)</span></span></span></span> —— <strong>“你虽然不是猫，但给了 0.1 的概率，也要扣一点分。”</strong></li>\n</ul>\n</li>\n<li>把这 80 个分数值全部加起来，就是这个 Anchor 的类别总损失。</li>\n</ol>\n<h3 id=\"视频中的损失函数\"><a class=\"markdownIt-Anchor\" href=\"#视频中的损失函数\">#</a> 视频中的损失函数</h3>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mtable rowspacing=\"0.24999999999999992em\" columnalign=\"right left\" columnspacing=\"0em\"><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mi>l</mi><mi>o</mi><mi>s</mi><mi>s</mi><mo>=</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mrow></mrow><msub><mi>λ</mi><mtext>coord</mtext></msub><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><msup><mi>S</mi><mn>2</mn></msup></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>B</mi></munderover><msubsup><mn mathvariant=\"double-struck\">1</mn><mrow><mi>i</mi><mo separator=\"true\">,</mo><mi>j</mi></mrow><mrow><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msubsup><mo>⋅</mo><mrow><mo fence=\"true\">[</mo><mo stretchy=\"false\">(</mo><msub><mi>b</mi><mi>x</mi></msub><mo>−</mo><msub><mover accent=\"true\"><mi>b</mi><mo>^</mo></mover><mi>x</mi></msub><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy=\"false\">(</mo><msub><mi>b</mi><mi>y</mi></msub><mo>−</mo><msub><mover accent=\"true\"><mi>b</mi><mo>^</mo></mover><mi>y</mi></msub><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy=\"false\">(</mo><msub><mi>b</mi><mi>w</mi></msub><mo>−</mo><msub><mover accent=\"true\"><mi>b</mi><mo>^</mo></mover><mi>w</mi></msub><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy=\"false\">(</mo><msub><mi>b</mi><mi>h</mi></msub><mo>−</mo><msub><mover accent=\"true\"><mi>b</mi><mo>^</mo></mover><mi>h</mi></msub><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup><mo fence=\"true\">]</mo></mrow><mo stretchy=\"false\">(</mo><mn>2</mn><mo>−</mo><msub><mi>w</mi><mi>i</mi></msub><mo>×</mo><msub><mi>h</mi><mi>i</mi></msub><mo stretchy=\"false\">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mrow></mrow><mo>+</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><msup><mi>S</mi><mn>2</mn></msup></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>B</mi></munderover><msubsup><mn mathvariant=\"double-struck\">1</mn><mrow><mi>i</mi><mo separator=\"true\">,</mo><mi>j</mi></mrow><mrow><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msubsup><mo>⋅</mo><mrow><mo fence=\"true\">[</mo><mo>−</mo><mi>log</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><msub><mi>p</mi><mi>c</mi></msub><mo stretchy=\"false\">)</mo><mo>+</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mi>B</mi><mi>C</mi><mi>E</mi><mo stretchy=\"false\">(</mo><msub><mover accent=\"true\"><mi>c</mi><mo>^</mo></mover><mi>i</mi></msub><mo separator=\"true\">,</mo><msub><mi>c</mi><mi>i</mi></msub><mo stretchy=\"false\">)</mo><mo fence=\"true\">]</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mrow></mrow><mo>+</mo><msub><mi>λ</mi><mtext>noobj</mtext></msub><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><msup><mi>S</mi><mn>2</mn></msup></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>B</mi></munderover><msubsup><mn mathvariant=\"double-struck\">1</mn><mrow><mi>i</mi><mo separator=\"true\">,</mo><mi>j</mi></mrow><mtext>noobj</mtext></msubsup><mo>⋅</mo><mrow><mo fence=\"true\">[</mo><mo>−</mo><mi>log</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>−</mo><msub><mi>p</mi><mi>c</mi></msub><mo stretchy=\"false\">)</mo><mo fence=\"true\">]</mo></mrow></mrow></mstyle></mtd></mtr></mtable><annotation encoding=\"application/x-tex\">\\begin{aligned}\nloss = &amp; \\lambda_{\\text{coord}} \\sum_{i=0}^{S^2} \\sum_{j=0}^{B} \\mathbb{1}_{i,j}^{obj} \\cdot \\left[ (b_x - \\hat{b}_x)^2 + (b_y - \\hat{b}_y)^2 + (b_w - \\hat{b}_w)^2 + (b_h - \\hat{b}_h)^2 \\right] (2 - w_i \\times h_i) \\\\\n&amp; + \\sum_{i=0}^{S^2} \\sum_{j=0}^{B} \\mathbb{1}_{i,j}^{obj} \\cdot \\left[ -\\log(p_c) + \\sum_{i=1}^{n} BCE(\\hat{c}_i, c_i) \\right] \\\\\n&amp; + \\lambda_{\\text{noobj}} \\sum_{i=0}^{S^2} \\sum_{j=0}^{B} \\mathbb{1}_{i,j}^{\\text{noobj}} \\cdot \\left[ -\\log(1 - p_c) \\right]\n\\end{aligned}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:11.063106000000001em;vertical-align:-5.281553000000001em;\"></span><span class=\"mord\"><span class=\"mtable\"><span class=\"col-align-r\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:5.781553000000001em;\"><span style=\"top:-7.781553000000001em;\"><span class=\"pstrut\" style=\"height:3.9739250000000004em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span></span></span><span style=\"top:-4.093850999999999em;\"><span class=\"pstrut\" style=\"height:3.9739250000000004em;\"></span><span class=\"mord\"></span></span><span style=\"top:-0.40614899999999965em;\"><span class=\"pstrut\" style=\"height:3.9739250000000004em;\"></span><span class=\"mord\"></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:5.281553000000001em;\"><span></span></span></span></span></span><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:5.781553000000001em;\"><span style=\"top:-7.781553000000001em;\"><span class=\"pstrut\" style=\"height:3.9739250000000004em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">coord</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.9739250000000004em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05764em;\">S</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8913142857142857em;\"><span style=\"top:-2.931em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\">1</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9670159999999999em;\"><span style=\"top:-2.4231360000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.412972em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size2\">[</span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9578799999999998em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span></span></span><span style=\"top:-3.26344em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.25em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641079999999999em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9578799999999998em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span></span></span><span style=\"top:-3.26344em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.25em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641079999999999em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9578799999999998em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span></span></span><span style=\"top:-3.26344em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.25em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641079999999999em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">h</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9578799999999998em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span></span></span><span style=\"top:-3.26344em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.25em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">h</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641079999999999em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size2\">]</span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">h</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span><span style=\"top:-4.093850999999999em;\"><span class=\"pstrut\" style=\"height:3.9739250000000004em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.9739250000000004em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05764em;\">S</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8913142857142857em;\"><span style=\"top:-2.931em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\">1</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9670159999999999em;\"><span style=\"top:-2.4231360000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.412972em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size4\">[</span></span><span class=\"mord\">−</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.6513970000000002em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">1</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size4\">]</span></span></span></span></span><span style=\"top:-0.40614899999999965em;\"><span class=\"pstrut\" style=\"height:3.9739250000000004em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">noobj</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.9739250000000004em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05764em;\">S</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8913142857142857em;\"><span style=\"top:-2.931em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\">1</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9670159999999999em;\"><span style=\"top:-2.4231360000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">noobj</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.412972em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\">[</span><span class=\"mord\">−</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mclose delimcenter\" style=\"top:0em;\">]</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:5.281553000000001em;\"><span></span></span></span></span></span></span></span></span></span></span></span></p>\n<h4 id=\"位置损失\"><a class=\"markdownIt-Anchor\" href=\"#位置损失\">#</a> 位置损失</h4>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mi>λ</mi><mtext>coord</mtext></msub><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><msup><mi>S</mi><mn>2</mn></msup></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>B</mi></munderover><msubsup><mn mathvariant=\"double-struck\">1</mn><mrow><mi>i</mi><mo separator=\"true\">,</mo><mi>j</mi></mrow><mrow><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msubsup><mo>⋅</mo><mrow><mo fence=\"true\">[</mo><mo stretchy=\"false\">(</mo><msub><mi>b</mi><mi>x</mi></msub><mo>−</mo><msub><mover accent=\"true\"><mi>b</mi><mo>^</mo></mover><mi>x</mi></msub><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy=\"false\">(</mo><msub><mi>b</mi><mi>y</mi></msub><mo>−</mo><msub><mover accent=\"true\"><mi>b</mi><mo>^</mo></mover><mi>y</mi></msub><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy=\"false\">(</mo><msub><mi>b</mi><mi>w</mi></msub><mo>−</mo><msub><mover accent=\"true\"><mi>b</mi><mo>^</mo></mover><mi>w</mi></msub><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy=\"false\">(</mo><msub><mi>b</mi><mi>h</mi></msub><mo>−</mo><msub><mover accent=\"true\"><mi>b</mi><mo>^</mo></mover><mi>h</mi></msub><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup><mo fence=\"true\">]</mo></mrow><mo stretchy=\"false\">(</mo><mn>2</mn><mo>−</mo><msub><mi>w</mi><mi>i</mi></msub><mo>×</mo><msub><mi>h</mi><mi>i</mi></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\lambda_{\\text{coord}} \\sum_{i=0}^{S^2} \\sum_{j=0}^{B} \\mathbb{1}_{i,j}^{obj} \\cdot \\left[ (b_x - \\hat{b}_x)^2 + (b_y - \\hat{b}_y)^2 + (b_w - \\hat{b}_w)^2 + (b_h - \\hat{b}_h)^2 \\right] (2 - w_i \\times h_i) \n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:3.387702em;vertical-align:-1.4137769999999998em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">coord</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.9739250000000004em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05764em;\">S</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8913142857142857em;\"><span style=\"top:-2.931em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\">1</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9670159999999999em;\"><span style=\"top:-2.4231360000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.412972em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.80002em;vertical-align:-0.65002em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size2\">[</span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9578799999999998em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span></span></span><span style=\"top:-3.26344em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.25em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641079999999999em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9578799999999998em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span></span></span><span style=\"top:-3.26344em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.25em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641079999999999em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9578799999999998em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span></span></span><span style=\"top:-3.26344em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.25em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641079999999999em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">h</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9578799999999998em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span></span></span><span style=\"top:-3.26344em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.25em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">h</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641079999999999em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size2\">]</span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.73333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">h</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></span></p>\n<p>这一行负责让预测框画得更准。</p>\n<ul>\n<li><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">(</mo><msub><mi>b</mi><mi>x</mi></msub><mo separator=\"true\">,</mo><msub><mi>b</mi><mi>y</mi></msub><mo separator=\"true\">,</mo><msub><mi>b</mi><mi>w</mi></msub><mo separator=\"true\">,</mo><msub><mi>b</mi><mi>h</mi></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">(b_x, b_y, b_w, b_h)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.036108em;vertical-align:-0.286108em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">h</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></strong>：模型预测的四个坐标值。</li>\n<li><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">(</mo><msub><mover accent=\"true\"><mi>b</mi><mo>^</mo></mover><mi>x</mi></msub><mo separator=\"true\">,</mo><msub><mover accent=\"true\"><mi>b</mi><mo>^</mo></mover><mi>y</mi></msub><mo separator=\"true\">,</mo><msub><mover accent=\"true\"><mi>b</mi><mo>^</mo></mover><mi>w</mi></msub><mo separator=\"true\">,</mo><msub><mover accent=\"true\"><mi>b</mi><mo>^</mo></mover><mi>h</mi></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">(\\hat{b}_x, \\hat{b}_y, \\hat{b}_w, \\hat{b}_h)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.2439879999999999em;vertical-align:-0.286108em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9578799999999998em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span></span></span><span style=\"top:-3.26344em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.25em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9578799999999998em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span></span></span><span style=\"top:-3.26344em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.25em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9578799999999998em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span></span></span><span style=\"top:-3.26344em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.25em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9578799999999998em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span></span></span><span style=\"top:-3.26344em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.25em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">h</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></strong>：真实目标的坐标值。</li>\n<li><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">(</mo><mn>2</mn><mo>−</mo><msub><mi>w</mi><mi>i</mi></msub><mo>×</mo><msub><mi>h</mi><mi>i</mi></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">(2 - w_i \\times h_i)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.73333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">h</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></strong>：<strong>小目标增强权重</strong>。物体面积越小，这个值越大，从而补偿大框和小框在 MSE 损失上的不平衡。</li>\n<li><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>λ</mi><mtext>coord</mtext></msub></mrow><annotation encoding=\"application/x-tex\">\\lambda_{\\text{coord}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">coord</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></strong>：坐标损失权重系数，用来提高定位的优先级。</li>\n</ul>\n<h4 id=\"正样本置信度与类别损失\"><a class=\"markdownIt-Anchor\" href=\"#正样本置信度与类别损失\">#</a> 正样本置信度与类别损失</h4>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><msup><mi>S</mi><mn>2</mn></msup></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>B</mi></munderover><msubsup><mn mathvariant=\"double-struck\">1</mn><mrow><mi>i</mi><mo separator=\"true\">,</mo><mi>j</mi></mrow><mrow><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msubsup><mo>⋅</mo><mrow><mo fence=\"true\">[</mo><mo>−</mo><mi>log</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><msub><mi>p</mi><mi>c</mi></msub><mo stretchy=\"false\">)</mo><mo>+</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mi>B</mi><mi>C</mi><mi>E</mi><mo stretchy=\"false\">(</mo><msub><mover accent=\"true\"><mi>c</mi><mo>^</mo></mover><mi>i</mi></msub><mo separator=\"true\">,</mo><msub><mi>c</mi><mi>i</mi></msub><mo stretchy=\"false\">)</mo><mo fence=\"true\">]</mo></mrow></mrow><annotation encoding=\"application/x-tex\">\\sum_{i=0}^{S^2} \\sum_{j=0}^{B} \\mathbb{1}_{i,j}^{obj} \\cdot \\left[ -\\log(p_c) + \\sum_{i=1}^{n} BCE(\\hat{c}_i, c_i) \\right]\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:3.387702em;vertical-align:-1.4137769999999998em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.9739250000000004em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05764em;\">S</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8913142857142857em;\"><span style=\"top:-2.931em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\">1</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9670159999999999em;\"><span style=\"top:-2.4231360000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.412972em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:3.027669em;vertical-align:-1.277669em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size4\">[</span></span><span class=\"mord\">−</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.6513970000000002em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">1</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size4\">]</span></span></span></span></span></span></span></p>\n<p>这一行只针对<strong>正样本</strong>即包含物体的框的计算。</p>\n<ul>\n<li><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>−</mo><mi>log</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><msub><mi>p</mi><mi>c</mi></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">-\\log(p_c)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">−</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></strong>：物体存在的置信度损失。当预测概率 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>p</mi><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">p_c</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 越接近 1，损失越小。</li>\n<li><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></msubsup><mi>B</mi><mi>C</mi><mi>E</mi><mo stretchy=\"false\">(</mo><msub><mover accent=\"true\"><mi>c</mi><mo>^</mo></mover><mi>i</mi></msub><mo separator=\"true\">,</mo><msub><mi>c</mi><mi>i</mi></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\sum_{i=1}^{n} BCE(\\hat{c}_i, c_i)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.104002em;vertical-align:-0.29971000000000003em;\"></span><span class=\"mop\"><span class=\"mop op-symbol small-op\" style=\"position:relative;top:-0.0000050000000000050004em;\">∑</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.804292em;\"><span style=\"top:-2.40029em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">1</span></span></span></span><span style=\"top:-3.2029em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.29971000000000003em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span></span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31166399999999994em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></strong>：分类损失。对 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span> 个类别中的每一个都进行二值交叉熵计算，支持多标签分类。</li>\n</ul>\n<h4 id=\"负样本置信度损失\"><a class=\"markdownIt-Anchor\" href=\"#负样本置信度损失\">#</a> 负样本置信度损失</h4>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mi>λ</mi><mtext>noobj</mtext></msub><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><msup><mi>S</mi><mn>2</mn></msup></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>B</mi></munderover><msubsup><mn mathvariant=\"double-struck\">1</mn><mrow><mi>i</mi><mo separator=\"true\">,</mo><mi>j</mi></mrow><mtext>noobj</mtext></msubsup><mo>⋅</mo><mrow><mo fence=\"true\">[</mo><mo>−</mo><mi>log</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>−</mo><msub><mi>p</mi><mi>c</mi></msub><mo stretchy=\"false\">)</mo><mo fence=\"true\">]</mo></mrow></mrow><annotation encoding=\"application/x-tex\">\\lambda_{\\text{noobj}} \\sum_{i=0}^{S^2} \\sum_{j=0}^{B} \\mathbb{1}_{i,j}^{\\text{noobj}} \\cdot \\left[ -\\log(1 - p_c) \\right]\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:3.387702em;vertical-align:-1.4137769999999998em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">noobj</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.9739250000000004em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05764em;\">S</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8913142857142857em;\"><span style=\"top:-2.931em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\">1</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9670159999999999em;\"><span style=\"top:-2.4231360000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span style=\"top:-3.1809080000000005em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">noobj</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.412972em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\">[</span><span class=\"mord\">−</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mclose delimcenter\" style=\"top:0em;\">]</span></span></span></span></span></span></p>\n<p>这一行只针对<strong>负样本</strong>即背景计算。</p>\n<ul>\n<li><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>−</mo><mi>log</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>−</mo><msub><mi>p</mi><mi>c</mi></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">-\\log(1 - p_c)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">−</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></strong>：背景的置信度损失。当预测概率 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>p</mi><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">p_c</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 越接近 0，损失越小。</li>\n<li><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>λ</mi><mtext>noobj</mtext></msub></mrow><annotation encoding=\"application/x-tex\">\\lambda_{\\text{noobj}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.980548em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">noobj</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span></strong>：背景惩罚系数。因为背景框远多于物体框，所以通常会设置一个较小的值来防止模型被背景淹没。</li>\n</ul>\n<h2 id=\"回望\"><a class=\"markdownIt-Anchor\" href=\"#回望\">#</a> 回望</h2>\n<p>YOLOv3 是目标检测领域的经典之作，它在 YOLOv2 的基础上进行了大幅度改进，舍弃了之前的 Darknet-19，采用了拥有 53 层卷积层的 <strong>Darknet-53</strong>。它引入了大量的残差结构，有效解决了深层网络的梯度消失问题，使模型能够学到更复杂的特征。受 FPN 启发，YOLOv3 分别在 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>13</mn><mo>×</mo><mn>13</mn></mrow><annotation encoding=\"application/x-tex\">13 \\times 13</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">1</span><span class=\"mord\">3</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\">3</span></span></span></span>、<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>26</mn><mo>×</mo><mn>26</mn></mrow><annotation encoding=\"application/x-tex\">26 \\times 26</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">2</span><span class=\"mord\">6</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">2</span><span class=\"mord\">6</span></span></span></span> 和 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>52</mn><mo>×</mo><mn>52</mn></mrow><annotation encoding=\"application/x-tex\">52 \\times 52</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">5</span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">5</span><span class=\"mord\">2</span></span></span></span> 三个尺度进行预测。分类方式放弃了 Softmax，改用多个独立的 Logistic 分类器即 BCE 损失，这使得 YOLOv3 能够支持<strong>多标签分类</strong>。</p>\n<h1 id=\"参考\"><a class=\"markdownIt-Anchor\" href=\"#参考\">#</a> 参考</h1>\n<ol>\n<li>【YOLOv1、YOLOv2、YOLOv3 目标检测算法原理与实战】<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL0JWMVdUNDIxcjcydw==\">https://www.bilibili.com/video/BV1WT421r72w</span></li>\n</ol>\n",
            "tags": [
                "深度学习",
                "YOLO",
                "python",
                "CNN",
                "深度学习",
                "YOLO"
            ]
        },
        {
            "id": "https://735690757.github.io/python/YOLO/YOLO_V2/",
            "url": "https://735690757.github.io/python/YOLO/YOLO_V2/",
            "title": "YOLO-V2",
            "date_published": "2026-01-04T04:12:12.000Z",
            "content_html": "<h1 id=\"yolov2\"><a class=\"markdownIt-Anchor\" href=\"#yolov2\">#</a> YOLOv2</h1>\n<h2 id=\"原文\"><a class=\"markdownIt-Anchor\" href=\"#原文\">#</a> 原文</h2>\n<p>YOLO9000: Better, Faster, Stronger(YOLOv2): [<span class=\"exturl\" data-url=\"aHR0cHM6Ly9hcnhpdi5vcmcvYWJzLzE2MTIuMDgyNDI=\">https://arxiv.org/abs/1612.08242</span>]</p>\n<img data-src=\"../../../images/python/YOLO/v2/1.png\" alt=\"v1\"  />\n<p>YOLO-v2 相较于 v1，不仅准确率高，而且检测速度更快，mAP 指标由 63.4% 提升到 78.6%。</p>\n<h2 id=\"v2-的改进\"><a class=\"markdownIt-Anchor\" href=\"#v2-的改进\">#</a> V2 的改进</h2>\n<img data-src=\"../../../images/python/YOLO/v2/2.png\" alt=\"v1\"  />\n<p><strong>Batch Normalization - 批归一化</strong> ：是深度学习中一种常用的技术，用于加速神经网络的训练并提高模型的稳定性。它通过对每一层的输入进行标准化处理来解决 “内部协变量偏移” 问题。</p>\n<p><strong>Hi-res classifier</strong>：Yolov2 相较于 Yolovl 采用更高分辨率的网络进行分类主干网络的训练。</p>\n<p><strong>Convolutional+anchor</strong>：Yolov2 相较于 Yolovl 去除全连接层，采用卷积层进行模型的输出；同时采用与锚框 (预选框) 进行 boundingbox 的预测</p>\n<p><strong>newnetwork</strong>：采用新的网络架构 Darknet-19</p>\n<p><strong>dimension priors</strong>：采用 k-means 聚类方法对训练集中的标准框做了聚类分析，获取 anchor boxes;</p>\n<p><strong>location prediction</strong>：使用 sigmoid 函数处理位置预测值。</p>\n<p><strong>passthrough</strong>：passthrough 网络模型的连接方式 (类似 resnet)</p>\n<p><strong>multi-scale</strong>：多尺度输入数据训练模型</p>\n<p><strong>hi-res detector</strong>：Yolov2 相较于 Yolovl 采用更高分辨率的网络进行检测主干网络的训练</p>\n<h2 id=\"anchor-box\"><a class=\"markdownIt-Anchor\" href=\"#anchor-box\">#</a> anchor box</h2>\n<p>在 YOLO v2 中，**Anchor 框（锚框 / 先验框）** 是这个算法的一项重大改进。如果说 “中心点” 决定了物体在哪个位置，那么 <strong>Anchor 框就决定了物体的 “体型” 和 “长相”</strong>。</p>\n<p>在一开始，这 5 个 Anchor 框就长得不一样。它们不是随意生成的，而是根据数据统计出来的<strong>最典型的 5 种形状</strong>。</p>\n<p>当图片输入模型时，每一个网格里的这 5 个 Anchor 都会去和真实物体比对：</p>\n<ul>\n<li><strong>计算重合度 IoU：</strong> 模型会计算真实物体的形状和这 5 个模板哪个最接近。</li>\n<li><strong>分配任务：</strong> 重合度 IoU 最高的那个 Anchor 被选为 “天选之子”，只有它负责预测这个物体。其他的 4 个 Anchor 在这个格子里就被当作 “背景” 忽略掉。</li>\n</ul>\n<p>一旦选定了最像的那个框，它只针对选中的这一个进行修正。</p>\n<p>虽然我们说是 “挑一个”，但在<strong>推理 / 预测</strong>阶段，其实 5 个框都会给出自己的分数（置信度）。只有那些得分超过你设定阈值的框才会被显示出来。如果一个格子里确实有两个重叠的物体，比如人挡住了车，那么负责人的 Anchor 和负责车的 Anchor 都会给出高分，这样两个物体就都能被挑出来！</p>\n<h2 id=\"流程描述\"><a class=\"markdownIt-Anchor\" href=\"#流程描述\">#</a> 流程描述</h2>\n<p>YOLOv2 把一张图分成  <code>S × S</code>  个 grid，每个 grid 预测  <code>B</code>  个候选框（anchor）。</p>\n<p>每个候选框输出：</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mo stretchy=\"false\">(</mo><msub><mi>b</mi><mi>x</mi></msub><mo separator=\"true\">,</mo><msub><mi>b</mi><mi>y</mi></msub><mo separator=\"true\">,</mo><msub><mi>b</mi><mi>w</mi></msub><mo separator=\"true\">,</mo><msub><mi>b</mi><mi>h</mi></msub><mo separator=\"true\">,</mo><mtext>confidence</mtext><mo separator=\"true\">,</mo><msub><mi>p</mi><mn>1</mn></msub><mo separator=\"true\">,</mo><msub><mi>p</mi><mn>2</mn></msub><mo separator=\"true\">,</mo><mo>…</mo><mo separator=\"true\">,</mo><msub><mi>p</mi><mi>C</mi></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">(b_x, b_y, b_w, b_h, \\text{confidence}, p_1, p_2, \\dots, p_C)\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.036108em;vertical-align:-0.286108em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">h</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord text\"><span class=\"mord\">confidence</span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\">…</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">C</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></span></p>\n<p>其中：</p>\n<ul>\n<li><code>confidence = Pr(object) × IoU(pred, gt)</code></li>\n<li><code>p_c = Pr(class_c | object)</code></li>\n</ul>\n<p><strong>真正用于排序和筛选的是：</strong></p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mtext>score</mtext><mi>c</mi></msub><mo>=</mo><mtext>confidence</mtext><mo>×</mo><msub><mi>p</mi><mi>c</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\text{score}_{c} = \\text{confidence} \\times p_c\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">score</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.77777em;vertical-align:-0.08333em;\"></span><span class=\"mord text\"><span class=\"mord\">confidence</span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></span></p>\n<p>对同一类别来说，score 最大的那个框</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>s</mi><mi>c</mi><mi>o</mi><mi>r</mi><mi>e</mi><mo>=</mo><mi>P</mi><mi>r</mi><mo stretchy=\"false\">(</mo><mi>o</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mo stretchy=\"false\">)</mo><mo>×</mo><mi>I</mi><mi>o</mi><mi>U</mi><mo>×</mo><mi>P</mi><mi>r</mi><mo stretchy=\"false\">(</mo><mi>c</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">score=Pr(object)×IoU×Pr(class)\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">e</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.76666em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">s</span><span class=\"mclose\">)</span></span></span></span></span></p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">因素</th>\n<th style=\"text-align:center\">含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">Pr(object)</td>\n<td style=\"text-align:center\">有没有目标</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">IoU</td>\n<td style=\"text-align:center\">框得准不准</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Pr(class)</td>\n<td style=\"text-align:center\">是不是这个类别</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"darknet-19-分类模型\"><a class=\"markdownIt-Anchor\" href=\"#darknet-19-分类模型\">#</a> DarkNet-19 分类模型</h2>\n<img data-src=\"../../../images/python/YOLO/v2/3.png\" alt=\"v1\"  />\n<h2 id=\"darknet-19-检测模型非完整版\"><a class=\"markdownIt-Anchor\" href=\"#darknet-19-检测模型非完整版\">#</a> DarkNet-19 检测模型（非完整版）</h2>\n<img data-src=\"../../../images/python/YOLO/v2/4.png\" alt=\"v1\"  />\n<h2 id=\"凭什么13x13可以代表那些格子\"><a class=\"markdownIt-Anchor\" href=\"#凭什么13x13可以代表那些格子\">#</a> 凭什么 13x13 可以代表那些格子？</h2>\n<p>不是 YOLO 把图片 “切成了 13×13”，而是卷积网络在经过多次 stride=2 下采样后，只剩下 13×13 个空间位置可以说话。YOLO 的 grid 结构并非人为划分，而是全卷积网络在多次下采样后自然形成的空间离散化结果。</p>\n<h2 id=\"应当有5个锚框是如何得出的\"><a class=\"markdownIt-Anchor\" href=\"#应当有5个锚框是如何得出的\">#</a> 应当有 5 个锚框是如何得出的？</h2>\n<p>YOLOv2 使用<strong> K-means 聚类</strong>来统计，<strong>K-means 聚类</strong>实际上是通过计算训练数据中每个目标框的 <strong>宽度</strong> 和 <strong>高度</strong> 来进行的，并且这些框的 <strong>中心点</strong> 被视为一个关键的参照来进行聚类。</p>\n<p>每个训练样本的目标框通常由其 <strong>宽度</strong> 和 <strong>高度</strong> 组成。YOLOv2 并不会直接使用每个框的左上角坐标，而是将框的 <strong>宽度</strong> 和 <strong>高度</strong> 作为输入特征。</p>\n<p>聚类的目的是找到一组能够很好地覆盖这些框的 <strong>中心点</strong> 和 <strong>尺寸</strong>。</p>\n<p>K-means 聚类在选择锚框时使用的是 <strong>IoU</strong>，即交并比，来度量物体框与锚框之间的相似度。</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>I</mi><mi>o</mi><mi>U</mi><mo>=</mo><mfrac><mrow><mi>A</mi><mi>r</mi><mi>e</mi><mi>a</mi><mi mathvariant=\"normal\">_</mi><mi>o</mi><mi>f</mi><mi mathvariant=\"normal\">_</mi><mi>o</mi><mi>v</mi><mi>e</mi><mi>r</mi><mi>l</mi><mi>a</mi><mi>p</mi></mrow><mrow><mi>A</mi><mi>r</mi><mi>e</mi><mi>a</mi><mi mathvariant=\"normal\">_</mi><mi>o</mi><mi>f</mi><mi mathvariant=\"normal\">_</mi><mi>u</mi><mi>n</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>A</mi><mi>r</mi><mi>e</mi><mi>a</mi></mrow></mfrac></mrow><annotation encoding=\"application/x-tex\">IoU=\\frac{Area\\_of\\_overlap}{Area\\_of\\_unionArea}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.39044em;vertical-align:-0.996em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.39444em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">a</span><span class=\"mord\" style=\"margin-right:0.02778em;\">_</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord\" style=\"margin-right:0.02778em;\">_</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">a</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.6999999999999997em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">a</span><span class=\"mord\" style=\"margin-right:0.02778em;\">_</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord\" style=\"margin-right:0.02778em;\">_</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">p</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.996em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span></p>\n<img data-src=\"../../../images/python/YOLO/V1_2.png\" alt=\"v1\"  />\n<p>对于每个训练集中的物体框，YOLOv2 会计算它与每个候选锚框的 IoU。物体框和锚框之间的 IoU 值越大，表示它们越相似。</p>\n<p><strong>聚类之后得到的 5 个框</strong>它们 <strong>不是拿来直接用的预测结果</strong> 而是用来 <strong>约束网络 “怎么预测框”</strong>，让回归问题变得容易、稳定、可学</p>\n<p>K-means 聚类后，得到的是：</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mo stretchy=\"false\">(</mo><msub><mi>w</mi><mn>1</mn></msub><mo separator=\"true\">,</mo><msub><mi>h</mi><mn>1</mn></msub><mo stretchy=\"false\">)</mo><mo separator=\"true\">,</mo><mo stretchy=\"false\">(</mo><msub><mi>w</mi><mn>2</mn></msub><mo separator=\"true\">,</mo><msub><mi>h</mi><mn>2</mn></msub><mo stretchy=\"false\">)</mo><mo separator=\"true\">,</mo><mo>…</mo><mo separator=\"true\">,</mo><mo stretchy=\"false\">(</mo><msub><mi>w</mi><mn>5</mn></msub><mo separator=\"true\">,</mo><msub><mi>h</mi><mn>5</mn></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">{(w_1,h_1),(w_2,h_2),…,(w_5,h_5)}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">h</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">h</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\">…</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">5</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">h</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">5</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></span></span></p>\n<p>这 5 组 <strong>宽高比例</strong>只和 <strong>形状、尺度</strong> 有关，<strong>不含位置</strong>，这通常是相对于输入图像的比例</p>\n<p>在 YOLO 模型中，网络会为每个目标预测四个偏移量：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>t</mi><mi>x</mi></msub><mo separator=\"true\">,</mo><msub><mi>t</mi><mi>y</mi></msub><mo separator=\"true\">,</mo><msub><mi>t</mi><mi>w</mi></msub><mo separator=\"true\">,</mo><msub><mi>t</mi><mi>h</mi></msub></mrow><annotation encoding=\"application/x-tex\">t_x, t_y, t_w, t_h</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9011879999999999em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">h</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>。通过以下公式，我们可以得到最终的边界框坐标：</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mi>b</mi><mi>x</mi></msub><mo>=</mo><mi>σ</mi><mo stretchy=\"false\">(</mo><msub><mi>t</mi><mi>x</mi></msub><mo stretchy=\"false\">)</mo><mo>+</mo><msub><mi>c</mi><mi>x</mi></msub></mrow><annotation encoding=\"application/x-tex\">b_x = \\sigma(t_x) + c_x\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">σ</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></span></p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mi>b</mi><mi>y</mi></msub><mo>=</mo><mi>σ</mi><mo stretchy=\"false\">(</mo><msub><mi>t</mi><mi>y</mi></msub><mo stretchy=\"false\">)</mo><mo>+</mo><msub><mi>c</mi><mi>y</mi></msub></mrow><annotation encoding=\"application/x-tex\">b_y = \\sigma(t_y) + c_y\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.980548em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.036108em;vertical-align:-0.286108em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">σ</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.716668em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span></span></p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mi>b</mi><mi>w</mi></msub><mo>=</mo><msub><mi>p</mi><mi>w</mi></msub><mo>⋅</mo><msup><mi>e</mi><msub><mi>t</mi><mi>w</mi></msub></msup></mrow><annotation encoding=\"application/x-tex\">b_w = p_w \\cdot e^{t_w}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.63889em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.843556em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">e</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.843556em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.16454285714285719em;\"><span style=\"top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.143em;\"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mi>b</mi><mi>h</mi></msub><mo>=</mo><msub><mi>p</mi><mi>h</mi></msub><mo>⋅</mo><msup><mi>e</mi><msub><mi>t</mi><mi>h</mi></msub></msup></mrow><annotation encoding=\"application/x-tex\">b_h = p_h \\cdot e^{t_h}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">h</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.63889em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">h</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.843556em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">e</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.843556em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3448em;\"><span style=\"top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\">h</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15122857142857138em;\"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>\n<p><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>c</mi><mi>x</mi></msub><mo separator=\"true\">,</mo><msub><mi>c</mi><mi>y</mi></msub></mrow><annotation encoding=\"application/x-tex\">c_x, c_y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.716668em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span></strong>：当前网格左上角的坐标（通常以网格大小为单位）。</p>\n<p><strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>p</mi><mi>w</mi></msub><mo separator=\"true\">,</mo><msub><mi>p</mi><mi>h</mi></msub></mrow><annotation encoding=\"application/x-tex\">p_w, p_h</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">h</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></strong>：<strong>锚框</strong>的宽度和高度。这是预设好的参考基准，在公式中，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>p</mi><mi>w</mi></msub></mrow><annotation encoding=\"application/x-tex\">p_w</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 和 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>p</mi><mi>h</mi></msub></mrow><annotation encoding=\"application/x-tex\">p_h</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">h</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 就是直接从锚框里拿出来的。后面乘个 e 的指数倍。</p>\n<h2 id=\"yolov2-边界框预测-损失计算流程\"><a class=\"markdownIt-Anchor\" href=\"#yolov2-边界框预测-损失计算流程\">#</a> YOLOv2 边界框预测 + 损失计算流程</h2>\n<h3 id=\"跑完一遍输出\"><a class=\"markdownIt-Anchor\" href=\"#跑完一遍输出\">#</a> 跑完一遍输出</h3>\n<p>网络最后一层输出的张量：</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mo stretchy=\"false\">[</mo><mi>S</mi><mo separator=\"true\">,</mo><mi>S</mi><mo separator=\"true\">,</mo><mi>B</mi><mo>×</mo><mo stretchy=\"false\">(</mo><mn>5</mn><mo>+</mo><mi>C</mi><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">[S, S, B \\times (5 + C)]\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">[</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mclose\">)</span><span class=\"mclose\">]</span></span></span></span></span></p>\n<ul>\n<li>S×S = 网格数（比如 13×13）</li>\n<li>B = anchor 数，在 YOLOv2 里是 5</li>\n<li>5 =  <code>[t_x, t_y, t_w, t_h, t_&#123;obj&#125;]</code></li>\n<li>C = 类别数</li>\n</ul>\n<blockquote>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>t</mi><mi>x</mi></msub><mo separator=\"true\">,</mo><msub><mi>t</mi><mi>y</mi></msub><mo separator=\"true\">,</mo><msub><mi>t</mi><mi>w</mi></msub><mo separator=\"true\">,</mo><msub><mi>t</mi><mi>h</mi></msub></mrow><annotation encoding=\"application/x-tex\">t_x, t_y, t_w, t_h</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9011879999999999em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">h</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 都是网络预测的偏移量（实数），还不是框的真实坐标。</p>\n</blockquote>\n<h3 id=\"解码为真实框\"><a class=\"markdownIt-Anchor\" href=\"#解码为真实框\">#</a> 解码为真实框</h3>\n<p>使用公式：</p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mi>b</mi><mi>x</mi></msub><mo>=</mo><mi>σ</mi><mo stretchy=\"false\">(</mo><msub><mi>t</mi><mi>x</mi></msub><mo stretchy=\"false\">)</mo><mo>+</mo><msub><mi>c</mi><mi>x</mi></msub></mrow><annotation encoding=\"application/x-tex\">b_x = \\sigma(t_x) + c_x\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">σ</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.58056em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></span></p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mi>b</mi><mi>y</mi></msub><mo>=</mo><mi>σ</mi><mo stretchy=\"false\">(</mo><msub><mi>t</mi><mi>y</mi></msub><mo stretchy=\"false\">)</mo><mo>+</mo><msub><mi>c</mi><mi>y</mi></msub></mrow><annotation encoding=\"application/x-tex\">b_y = \\sigma(t_y) + c_y\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.980548em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.036108em;vertical-align:-0.286108em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">σ</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.716668em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span></span></p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mi>b</mi><mi>w</mi></msub><mo>=</mo><msub><mi>p</mi><mi>w</mi></msub><mo>⋅</mo><msup><mi>e</mi><msub><mi>t</mi><mi>w</mi></msub></msup></mrow><annotation encoding=\"application/x-tex\">b_w = p_w \\cdot e^{t_w}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.63889em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.843556em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">e</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.843556em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.16454285714285719em;\"><span style=\"top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.143em;\"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mi>b</mi><mi>h</mi></msub><mo>=</mo><msub><mi>p</mi><mi>h</mi></msub><mo>⋅</mo><msup><mi>e</mi><msub><mi>t</mi><mi>h</mi></msub></msup></mrow><annotation encoding=\"application/x-tex\">b_h = p_h \\cdot e^{t_h}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">h</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.63889em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">h</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.843556em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">e</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.843556em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3448em;\"><span style=\"top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\">h</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15122857142857138em;\"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>\n<p>输出<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>b</mi><mi>x</mi></msub><mo separator=\"true\">,</mo><msub><mi>b</mi><mi>y</mi></msub><mo separator=\"true\">,</mo><msub><mi>b</mi><mi>w</mi></msub><mo separator=\"true\">,</mo><msub><mi>b</mi><mi>h</mi></msub></mrow><annotation encoding=\"application/x-tex\">b_x, b_y, b_w, b_h</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.980548em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">h</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，这是相对整个输入图像真实框坐标，</p>\n<h3 id=\"匹配-ground-truth-框\"><a class=\"markdownIt-Anchor\" href=\"#匹配-ground-truth-框\">#</a> 匹配 ground-truth 框</h3>\n<p>训练时：</p>\n<ol>\n<li>对每个 GT 框：\n<ul>\n<li>找到 <strong>IoU 最大的 anchor</strong> → 这个 anchor 来预测它</li>\n<li>其它 anchor 忽略或当负样本</li>\n</ul>\n</li>\n<li>计算预测框<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>b</mi><mi>x</mi></msub><mo separator=\"true\">,</mo><msub><mi>b</mi><mi>y</mi></msub><mo separator=\"true\">,</mo><msub><mi>b</mi><mi>w</mi></msub><mo separator=\"true\">,</mo><msub><mi>b</mi><mi>h</mi></msub></mrow><annotation encoding=\"application/x-tex\">b_x, b_y, b_w, b_h</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.980548em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">h</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 与 GT 框的误差</li>\n</ol>\n<h3 id=\"损失计算v2对比v1\"><a class=\"markdownIt-Anchor\" href=\"#损失计算v2对比v1\">#</a> 损失计算（v2 对比 v1）</h3>\n<p>YOLOv1 损失 = <strong>边界框回归 + 置信度 + 分类损失</strong></p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>L</mi><mi>o</mi><mi>s</mi><mi>s</mi><mo>=</mo><mi>c</mi><mi>o</mi><mi>o</mi><mi>r</mi><mi>d</mi><mi mathvariant=\"normal\">_</mi><mi>l</mi><mi>o</mi><mi>s</mi><mi>s</mi><mo>+</mo><mi>o</mi><mi>b</mi><mi>j</mi><mi mathvariant=\"normal\">_</mi><mi>l</mi><mi>o</mi><mi>s</mi><mi>s</mi><mo>+</mo><mi>n</mi><mi>o</mi><mi>o</mi><mi>b</mi><mi>j</mi><mi mathvariant=\"normal\">_</mi><mi>l</mi><mi>o</mi><mi>s</mi><mi>s</mi><mo>+</mo><mi>c</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi><mi mathvariant=\"normal\">_</mi><mi>l</mi><mi>o</mi><mi>s</mi><mi>s</mi></mrow><annotation encoding=\"application/x-tex\">Loss=coord\\_loss+obj\\_loss+noobj\\_loss+class\\_loss\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">L</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.00444em;vertical-align:-0.31em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">d</span><span class=\"mord\" style=\"margin-right:0.02778em;\">_</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.00444em;vertical-align:-0.31em;\"></span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord\" style=\"margin-right:0.02778em;\">_</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.00444em;vertical-align:-0.31em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord\" style=\"margin-right:0.02778em;\">_</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.00444em;vertical-align:-0.31em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">s</span><span class=\"mord\" style=\"margin-right:0.02778em;\">_</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">s</span></span></span></span></span></p>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi><mi>o</mi><mi>o</mi><mi>r</mi><mi>d</mi><mi mathvariant=\"normal\">_</mi><mi>l</mi><mi>o</mi><mi>s</mi><mi>s</mi></mrow><annotation encoding=\"application/x-tex\">coord\\_loss</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.00444em;vertical-align:-0.31em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">d</span><span class=\"mord\" style=\"margin-right:0.02778em;\">_</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">s</span></span></span></span> 坐标偏移损失，这里直接在<strong>偏移量空间</strong>计算误差，而不是在转换后的像素空间</p>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>o</mi><mi>b</mi><mi>j</mi><mi mathvariant=\"normal\">_</mi><mi>l</mi><mi>o</mi><mi>s</mi><mi>s</mi></mrow><annotation encoding=\"application/x-tex\">obj\\_loss</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.00444em;vertical-align:-0.31em;\"></span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord\" style=\"margin-right:0.02778em;\">_</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">s</span></span></span></span> 有物体置信度损失，如果这里有物体，模型预测的置信度应该接近它与真实目标的重合度。</p>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi><mi>o</mi><mi>o</mi><mi>b</mi><mi>j</mi><mi mathvariant=\"normal\">_</mi><mi>l</mi><mi>o</mi><mi>s</mi><mi>s</mi></mrow><annotation encoding=\"application/x-tex\">noobj\\_loss</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.00444em;vertical-align:-0.31em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord\" style=\"margin-right:0.02778em;\">_</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">s</span></span></span></span> 无物体置信度损失。</p>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi><mi mathvariant=\"normal\">_</mi><mi>l</mi><mi>o</mi><mi>s</mi><mi>s</mi></mrow><annotation encoding=\"application/x-tex\">class\\_loss</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.00444em;vertical-align:-0.31em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">s</span><span class=\"mord\" style=\"margin-right:0.02778em;\">_</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">s</span></span></span></span> 分类损失，YOLO v2 在分类上也使用了均方误差，而后续版本改成了交叉熵。</p>\n<p>有物体置信度损失和无物体置信度损失，像是模型里的 “<strong>安检员</strong>” 和 “<strong>纠错员</strong>”，它们共同解决目标：<strong>如何从成千上万个候选框中，把真正包含物体的那个找出来，并过滤掉背景。</strong></p>\n<p>在一张图中，背景框的数量远多于物体框。如果两者的权重一样，模型会发现，把所有框都预测成背景是最省力的做法，但其实这样并没有达到我们的预期。</p>\n<p>因此，我们通常设置 <strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>λ</mi><mrow><mi>n</mi><mi>o</mi><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\lambda_{noobj}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.980548em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span> 较小</strong>例如 0.5，而 <strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>λ</mi><mrow><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\lambda_{obj}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.980548em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span> 较大</strong>。这样即使背景框很多，它们产生的总梯度也不会完全淹没掉少数物体框带来的信号。</p>\n<p>我们可以看到，有好多<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>λ</mi></mrow><annotation encoding=\"application/x-tex\">\\lambda</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">λ</span></span></span></span> ，总损失 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>L</mi><mi>o</mi><mi>s</mi><mi>s</mi></mrow><annotation encoding=\"application/x-tex\">Loss</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">L</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">s</span></span></span></span> 是所有子损失的加权和，如果你发现模型<strong>框画得不准</strong>，就调大 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>λ</mi><mrow><mi>c</mi><mi>o</mi><mi>o</mi><mi>r</mi><mi>d</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">\\lambda_{coord}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal mtight\">d</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，模型通过误差反向传播，会告诉自己：下次把框往左挪点，胆子大一点，提高 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>o</mi><mi>b</mi><mi>j</mi></mrow><annotation encoding=\"application/x-tex\">obj</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span></span></span></span> 分数，并且多看看猫的特征！</p>\n<p>YOLOv2 损失 = <strong>背景置信度损失 + 预热期 Anchor 匹配损失 + 有物体坐标损失 + 有物体置信度损失 + 分类损失</strong></p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>L</mi><mi>o</mi><mi>s</mi><msub><mi>s</mi><mrow><mi>v</mi><mn>2</mn></mrow></msub><mo>=</mo><mi>N</mi><mi>o</mi><mi>O</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>L</mi><mi>o</mi><mi>s</mi><mi>s</mi><mo>+</mo><mi>P</mi><mi>r</mi><mi>i</mi><mi>o</mi><mi>r</mi><mi>L</mi><mi>o</mi><mi>s</mi><mi>s</mi><mo>+</mo><mi>C</mi><mi>o</mi><mi>o</mi><mi>r</mi><mi>d</mi><mi>i</mi><mi>n</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>L</mi><mi>o</mi><mi>s</mi><mi>s</mi><mo>+</mo><mi>O</mi><mi>b</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>L</mi><mi>o</mi><mi>s</mi><mi>s</mi><mo>+</mo><mi>C</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi><mi>L</mi><mi>o</mi><mi>s</mi><mi>s</mi></mrow><annotation encoding=\"application/x-tex\">Loss_{v2}=NoObjectLoss+PriorLoss+CoordinateLoss+ObjectLoss+ClassLoss\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\">L</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">s</span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mtight\">2</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">L</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.76666em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">L</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.77777em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">L</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">L</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">L</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">s</span></span></span></span></span></p>\n<p><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mtable rowspacing=\"0.24999999999999992em\" columnalign=\"right left\" columnspacing=\"0em\"><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mi>L</mi><mi>o</mi><mi>s</mi><mi>s</mi><mo>=</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mrow></mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mi>W</mi></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mi>H</mi></munderover><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>0</mn></mrow><mi>A</mi></munderover><msub><mn mathvariant=\"double-struck\">1</mn><mrow><mtext>Max IoU</mtext><mo>&lt;</mo><mtext>Thresh</mtext></mrow></msub><mo>⋅</mo><msub><mi>λ</mi><mrow><mi>n</mi><mi>o</mi><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msub><mo>⋅</mo><mo stretchy=\"false\">(</mo><mn>0</mn><mo>−</mo><msubsup><mi>b</mi><mrow><mi>i</mi><mi>j</mi><mi>k</mi></mrow><mi>o</mi></msubsup><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mrow></mrow><mo>+</mo><msub><mn mathvariant=\"double-struck\">1</mn><mrow><mi>t</mi><mo>&lt;</mo><mn>12800</mn></mrow></msub><mo>⋅</mo><msub><mi>λ</mi><mrow><mi>p</mi><mi>r</mi><mi>i</mi><mi>o</mi><mi>r</mi></mrow></msub><mo>⋅</mo><munder><mo>∑</mo><mrow><mi>r</mi><mo>∈</mo><mo stretchy=\"false\">{</mo><mi>x</mi><mo separator=\"true\">,</mo><mi>y</mi><mo separator=\"true\">,</mo><mi>w</mi><mo separator=\"true\">,</mo><mi>h</mi><mo stretchy=\"false\">}</mo></mrow></munder><mo stretchy=\"false\">(</mo><mi>p</mi><mi>r</mi><mi>i</mi><mi>o</mi><msubsup><mi>r</mi><mi>k</mi><mi>r</mi></msubsup><mo>−</mo><msubsup><mi>b</mi><mrow><mi>i</mi><mi>j</mi><mi>k</mi></mrow><mi>r</mi></msubsup><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mrow></mrow><mo>+</mo><msubsup><mn mathvariant=\"double-struck\">1</mn><mi>k</mi><mrow><mi>t</mi><mi>r</mi><mi>u</mi><mi>t</mi><mi>h</mi></mrow></msubsup><mrow><mo fence=\"true\">[</mo><msub><mi>λ</mi><mrow><mi>c</mi><mi>o</mi><mi>o</mi><mi>r</mi><mi>d</mi></mrow></msub><mo>⋅</mo><munder><mo>∑</mo><mrow><mi>r</mi><mo>∈</mo><mo stretchy=\"false\">{</mo><mi>x</mi><mo separator=\"true\">,</mo><mi>y</mi><mo separator=\"true\">,</mo><mi>w</mi><mo separator=\"true\">,</mo><mi>h</mi><mo stretchy=\"false\">}</mo></mrow></munder><mo stretchy=\"false\">(</mo><mi>t</mi><mi>r</mi><mi>u</mi><mi>t</mi><msup><mi>h</mi><mi>r</mi></msup><mo>−</mo><msubsup><mi>b</mi><mrow><mi>i</mi><mi>j</mi><mi>k</mi></mrow><mi>r</mi></msubsup><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mrow></mrow><mo>+</mo><msub><mi>λ</mi><mrow><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msub><mo>⋅</mo><mo stretchy=\"false\">(</mo><mi>I</mi><mi>O</mi><msubsup><mi>U</mi><mrow><mi>t</mi><mi>r</mi><mi>u</mi><mi>t</mi><mi>h</mi></mrow><mi>k</mi></msubsup><mo>−</mo><msubsup><mi>b</mi><mrow><mi>i</mi><mi>j</mi><mi>k</mi></mrow><mi>o</mi></msubsup><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mrow></mrow><mo>+</mo><mrow><msub><mi>λ</mi><mrow><mi>c</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi></mrow></msub><mo>⋅</mo><munderover><mo>∑</mo><mrow><mi>c</mi><mo>=</mo><mn>1</mn></mrow><mi>C</mi></munderover><mo stretchy=\"false\">(</mo><mi>t</mi><mi>r</mi><mi>u</mi><mi>t</mi><msup><mi>h</mi><mi>c</mi></msup><mo>−</mo><msubsup><mi>b</mi><mrow><mi>i</mi><mi>j</mi><mi>k</mi></mrow><mi>c</mi></msubsup><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup><mo fence=\"true\">]</mo></mrow></mrow></mstyle></mtd></mtr></mtable><annotation encoding=\"application/x-tex\">\\begin{aligned}\nLoss = &amp; \\sum_{i=0}^{W} \\sum_{j=0}^{H} \\sum_{k=0}^{A} \\mathbb{1}_{\\text{Max IoU} &lt; \\text{Thresh}} \\cdot \\lambda_{noobj} \\cdot (0 - b_{ijk}^o)^2 \\\\\n&amp; + \\mathbb{1}_{t &lt; 12800} \\cdot \\lambda_{prior} \\cdot \\sum_{r \\in \\{x,y,w,h\\}} (prior_k^r - b_{ijk}^r)^2 \\\\\n&amp; + \\mathbb{1}_k^{truth} \\left[ \\lambda_{coord} \\cdot \\sum_{r \\in \\{x,y,w,h\\}} (truth^r - b_{ijk}^r)^2 \\right. \\\\\n&amp; + \\lambda_{obj} \\cdot (IOU_{truth}^k - b_{ijk}^o)^2 \\\\\n&amp; + \\left. \\lambda_{class} \\cdot \\sum_{c=1}^{C} (truth^c - b_{ijk}^c)^2 \\right]\n\\end{aligned}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:15.286818000000004em;vertical-align:-7.393409000000002em;\"></span><span class=\"mord\"><span class=\"mtable\"><span class=\"col-align-r\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:7.893409000000002em;\"><span style=\"top:-10.116083000000001em;\"><span class=\"pstrut\" style=\"height:4.05101em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">L</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span></span></span><span style=\"top:-7.352301000000001em;\"><span class=\"pstrut\" style=\"height:4.05101em;\"></span><span class=\"mord\"></span></span><span style=\"top:-3.4852859999999994em;\"><span class=\"pstrut\" style=\"height:4.05101em;\"></span><span class=\"mord\"></span></span><span style=\"top:-0.736157999999999em;\"><span class=\"pstrut\" style=\"height:4.05101em;\"></span><span class=\"mord\"></span></span><span style=\"top:1.7752860000000021em;\"><span class=\"pstrut\" style=\"height:4.05101em;\"></span><span class=\"mord\"></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:7.393409000000002em;\"><span></span></span></span></span></span><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:7.893409000000002em;\"><span style=\"top:-10.116083000000001em;\"><span class=\"pstrut\" style=\"height:4.05101em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000002em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.13889em;\">W</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.277669em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000006em;\"><span style=\"top:-1.872331em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.08125em;\">H</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.4137769999999998em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000002em;\"><span style=\"top:-1.8478869999999998em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.0500049999999996em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.300005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">A</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.302113em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\">1</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999985em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">Max IoU</span></span><span class=\"mrel mtight\">&lt;</span><span class=\"mord text mtight\"><span class=\"mord mtight\">Thresh</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.17737em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.714392em;\"><span style=\"top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span style=\"top:-3.1130000000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">o</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.383108em;\"><span></span></span></span></span></span></span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641079999999999em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span><span style=\"top:-7.352301000000001em;\"><span class=\"pstrut\" style=\"height:4.05101em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\">1</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span><span class=\"mrel mtight\">&lt;</span><span class=\"mord mtight\">1</span><span class=\"mord mtight\">2</span><span class=\"mord mtight\">8</span><span class=\"mord mtight\">0</span><span class=\"mord mtight\">0</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.17737em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">p</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.050005em;\"><span style=\"top:-1.808995em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mrel mtight\">∈</span><span class=\"mopen mtight\">{</span><span class=\"mord mathnormal mtight\">x</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\">h</span><span class=\"mclose mtight\">}</span></span></span></span><span style=\"top:-3.0500049999999996em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.516005em;\"><span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">o</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7143919999999999em;\"><span style=\"top:-2.4530000000000003em;margin-left:-0.02778em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.714392em;\"><span style=\"top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span style=\"top:-3.1130000000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.383108em;\"><span></span></span></span></span></span></span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641079999999999em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span><span style=\"top:-3.4852859999999994em;\"><span class=\"pstrut\" style=\"height:4.05101em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\">1</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8991079999999998em;\"><span style=\"top:-2.4530000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal mtight\">u</span><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\">h</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\"><span class=\"mopen\"><span class=\"delimsizing mult\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.0510099999999998em;\"><span style=\"top:-2.2500000000000004em;\"><span class=\"pstrut\" style=\"height:3.1550000000000002em;\"></span><span class=\"delimsizinginner delim-size4\"><span>⎣</span></span></span><span style=\"top:-2.8099900000000004em;\"><span class=\"pstrut\" style=\"height:3.1550000000000002em;\"></span><span class=\"delimsizinginner delim-size4\"><span>⎢</span></span></span><span style=\"top:-4.05101em;\"><span class=\"pstrut\" style=\"height:3.1550000000000002em;\"></span><span class=\"delimsizinginner delim-size4\"><span>⎡</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.55002em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal mtight\">d</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.050005em;\"><span style=\"top:-1.808995em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mrel mtight\">∈</span><span class=\"mopen mtight\">{</span><span class=\"mord mathnormal mtight\">x</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02691em;\">w</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\">h</span><span class=\"mclose mtight\">}</span></span></span></span><span style=\"top:-3.0500049999999996em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.516005em;\"><span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">t</span><span class=\"mord\"><span class=\"mord mathnormal\">h</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7143919999999999em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.714392em;\"><span style=\"top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span style=\"top:-3.1130000000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.383108em;\"><span></span></span></span></span></span></span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641079999999999em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span><span style=\"top:-0.736157999999999em;\"><span class=\"pstrut\" style=\"height:4.05101em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8991079999999998em;\"><span style=\"top:-2.4530000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal mtight\">u</span><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\">h</span></span></span></span><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.714392em;\"><span style=\"top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span style=\"top:-3.1130000000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">o</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.383108em;\"><span></span></span></span></span></span></span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641079999999999em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span><span style=\"top:1.7752860000000021em;\"><span class=\"pstrut\" style=\"height:4.05101em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"minner\"><span class=\"mopen nulldelimiter\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">s</span><span class=\"mord mathnormal mtight\">s</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8283360000000002em;\"><span style=\"top:-1.882887em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">1</span></span></span></span><span style=\"top:-3.050005em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3000050000000005em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">C</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.267113em;\"><span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">t</span><span class=\"mord\"><span class=\"mord mathnormal\">h</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7143919999999999em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.714392em;\"><span style=\"top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span style=\"top:-3.1130000000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.383108em;\"><span></span></span></span></span></span></span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641079999999999em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size4\">]</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:7.393409000000002em;\"><span></span></span></span></span></span></span></span></span></span></span></span></p>\n<img data-src=\"../../../images/python/YOLO/v2/7.png\" alt=\"v1\"  />\n<h4 id=\"背景置信度损失-no-object-loss\"><a class=\"markdownIt-Anchor\" href=\"#背景置信度损失-no-object-loss\">#</a> 背景置信度损失 No-Object Loss</h4>\n<ul>\n<li><strong>公式</strong>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>λ</mi><mrow><mi>n</mi><mi>o</mi><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msub><mo>⋅</mo><mo stretchy=\"false\">(</mo><mn>0</mn><mo>−</mo><msubsup><mi>b</mi><mrow><mi>i</mi><mi>j</mi><mi>k</mi></mrow><mi>o</mi></msubsup><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup></mrow><annotation encoding=\"application/x-tex\">\\lambda_{noobj} \\cdot (0 - b_{ijk}^o)^2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.980548em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.2333239999999999em;vertical-align:-0.4192159999999999em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.664392em;\"><span style=\"top:-2.4168920000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">o</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.4192159999999999em;\"><span></span></span></span></span></span></span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span>，那么长一串核心就是这个，前面的都是一些条件。</li>\n<li><strong>含义</strong>：如果预测框与所有真实框的 IoU 都小于阈值（通常为 0.6），它就被判定为背景。</li>\n<li><strong>目标</strong>：强制该框的置信度 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mi>b</mi><mi>o</mi></msup></mrow><annotation encoding=\"application/x-tex\">b^o</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.664392em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">o</span></span></span></span></span></span></span></span></span></span></span> 趋向 <strong>0</strong>，所以采用 0 减去它自己。</li>\n<li><strong>权重</strong>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>λ</mi><mrow><mi>n</mi><mi>o</mi><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">\\lambda_{noobj} = 1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.980548em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span>。</li>\n</ul>\n<h4 id=\"预热期-anchor-匹配损失-prior-loss\"><a class=\"markdownIt-Anchor\" href=\"#预热期-anchor-匹配损失-prior-loss\">#</a> 预热期 Anchor 匹配损失 Prior Loss</h4>\n<ul>\n<li><strong>公式</strong>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mn mathvariant=\"double-struck\">1</mn><mrow><mi>t</mi><mo>&lt;</mo><mn>12800</mn></mrow></msub><mo>⋅</mo><msub><mi>λ</mi><mrow><mi>p</mi><mi>r</mi><mi>i</mi><mi>o</mi><mi>r</mi></mrow></msub><mo>…</mo></mrow><annotation encoding=\"application/x-tex\">\\mathbb{1}_{t &lt; 12800} \\cdot \\lambda_{prior} \\dots</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.82181em;vertical-align:-0.17737em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord\">1</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span><span class=\"mrel mtight\">&lt;</span><span class=\"mord mtight\">1</span><span class=\"mord mtight\">2</span><span class=\"mord mtight\">8</span><span class=\"mord mtight\">0</span><span class=\"mord mtight\">0</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.17737em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.980548em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.311664em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">p</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"minner\">…</span></span></span></span></li>\n<li><strong>含义</strong>：这是 YOLOv2 的特殊设计。在训练的前 12800 步，让预测框去拟合 Anchor Box 的原始形状。</li>\n<li><strong>作用</strong>：防止训练初期预测框乱跳，起到稳定模型的作用。过了这个阶段，这一项就消失了。</li>\n</ul>\n<h4 id=\"有物体坐标损失-coordinate-loss\"><a class=\"markdownIt-Anchor\" href=\"#有物体坐标损失-coordinate-loss\">#</a> 有物体坐标损失 Coordinate Loss</h4>\n<ul>\n<li><strong>公式</strong>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>λ</mi><mrow><mi>c</mi><mi>o</mi><mi>o</mi><mi>r</mi><mi>d</mi></mrow></msub><mo>⋅</mo><mo>∑</mo><mo stretchy=\"false\">(</mo><mi>t</mi><mi>r</mi><mi>u</mi><mi>t</mi><mi>h</mi><mo>−</mo><mi>b</mi><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup></mrow><annotation encoding=\"application/x-tex\">\\lambda_{coord} \\cdot \\sum (truth - b)^2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal mtight\">d</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.00001em;vertical-align:-0.25001em;\"></span><span class=\"mop op-symbol small-op\" style=\"position:relative;top:-0.0000050000000000050004em;\">∑</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.064108em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">b</span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></li>\n<li><strong>注意</strong>：这里的计算是在 <strong><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">t</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.61508em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">t</span></span></span></span> 空间</strong>（偏移量空间）进行的，即模型直接输出的数值与转化后的标签进行对比。</li>\n<li><strong>权重</strong>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>λ</mi><mrow><mi>c</mi><mi>o</mi><mi>o</mi><mi>r</mi><mi>d</mi></mrow></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">\\lambda_{coord} = 1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal mtight\">d</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span>。</li>\n</ul>\n<h4 id=\"有物体置信度损失-object-loss\"><a class=\"markdownIt-Anchor\" href=\"#有物体置信度损失-object-loss\">#</a> 有物体置信度损失 Object Loss</h4>\n<ul>\n<li><strong>公式</strong>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>λ</mi><mrow><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msub><mo>⋅</mo><mo stretchy=\"false\">(</mo><mi>I</mi><mi>O</mi><msubsup><mi>U</mi><mrow><mi>t</mi><mi>r</mi><mi>u</mi><mi>t</mi><mi>h</mi></mrow><mi>k</mi></msubsup><mo>−</mo><msubsup><mi>b</mi><mrow><mi>i</mi><mi>j</mi><mi>k</mi></mrow><mi>o</mi></msubsup><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup></mrow><annotation encoding=\"application/x-tex\">\\lambda_{obj} \\cdot (IOU_{truth}^k - b_{ijk}^o)^2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.980548em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.132216em;vertical-align:-0.2831079999999999em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.849108em;\"><span style=\"top:-2.4168920000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal mtight\">u</span><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\">h</span></span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2831079999999999em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.2333239999999999em;vertical-align:-0.4192159999999999em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.664392em;\"><span style=\"top:-2.4168920000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">o</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.4192159999999999em;\"><span></span></span></span></span></span></span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></li>\n<li><strong>核心细节</strong>：\n<ul>\n<li><strong>标签不是 1</strong>：这里使用的是预测框与真实框的 <strong>实际 IoU</strong> 作为学习目标。</li>\n<li><strong>高权重</strong>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>λ</mi><mrow><mi>o</mi><mi>b</mi><mi>j</mi></mrow></msub><mo>=</mo><mn>5</mn></mrow><annotation encoding=\"application/x-tex\">\\lambda_{obj} = 5</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.980548em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">5</span></span></span></span>。这反映了 YOLOv2 非常重视对真实目标的提取。</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"分类损失-class-loss\"><a class=\"markdownIt-Anchor\" href=\"#分类损失-class-loss\">#</a> 分类损失 Class Loss</h4>\n<ul>\n<li><strong>公式</strong>：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>λ</mi><mrow><mi>c</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi></mrow></msub><mo>⋅</mo><mo>∑</mo><mo stretchy=\"false\">(</mo><mi>t</mi><mi>r</mi><mi>u</mi><mi>t</mi><msup><mi>h</mi><mi>c</mi></msup><mo>−</mo><msubsup><mi>b</mi><mrow><mi>i</mi><mi>j</mi><mi>k</mi></mrow><mi>c</mi></msubsup><msup><mo stretchy=\"false\">)</mo><mn>2</mn></msup></mrow><annotation encoding=\"application/x-tex\">\\lambda_{class} \\cdot \\sum (truth^c - b_{ijk}^c)^2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">λ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">c</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">s</span><span class=\"mord mathnormal mtight\">s</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.00001em;vertical-align:-0.25001em;\"></span><span class=\"mop op-symbol small-op\" style=\"position:relative;top:-0.0000050000000000050004em;\">∑</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">t</span><span class=\"mord\"><span class=\"mord mathnormal\">h</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.664392em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.2333239999999999em;vertical-align:-0.4192159999999999em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.664392em;\"><span style=\"top:-2.4168920000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.4192159999999999em;\"><span></span></span></span></span></span></span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></li>\n<li><strong>计算方式</strong>：YOLOv2 依然使用了 <strong>MSE 均方误差</strong>，而不是后来版本常用的交叉熵。</li>\n</ul>\n<h4 id=\"总结\"><a class=\"markdownIt-Anchor\" href=\"#总结\">#</a> 总结</h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">损失项</th>\n<th style=\"text-align:center\">权重变量</th>\n<th style=\"text-align:center\">推荐值</th>\n<th style=\"text-align:center\">作用</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">背景置信度</td>\n<td style=\"text-align:center\" noobj=\"\">\\lambda_</td>\n<td style=\"text-align:center\">1</td>\n<td style=\"text-align:center\">抑制误报</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">物体置信度</td>\n<td style=\"text-align:center\" obj=\"\">\\lambda_</td>\n<td style=\"text-align:center\">5</td>\n<td style=\"text-align:center\">提高召回率</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">坐标回归</td>\n<td style=\"text-align:center\" coord=\"\">\\lambda_</td>\n<td style=\"text-align:center\">1</td>\n<td style=\"text-align:center\">精准定位</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">分类概率</td>\n<td style=\"text-align:center\" class=\"\">\\lambda_</td>\n<td style=\"text-align:center\">1</td>\n<td style=\"text-align:center\">类别判定</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Anchor 预热</td>\n<td style=\"text-align:center\" prior=\"\">\\lambda_</td>\n<td style=\"text-align:center\">0.01</td>\n<td style=\"text-align:center\">初期稳定训练</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"passthrough\"><a class=\"markdownIt-Anchor\" href=\"#passthrough\">#</a> passthrough</h2>\n<p>在 YOLOv2 架构中，Passthrough Layer 直通层 / 重组层是一个非常精妙的设计。它的核心目的是<strong>为了更好地检测微小物体</strong>。</p>\n<img data-src=\"../../../images/python/YOLO/v2/5.png\" alt=\"v1\"  />\n<h2 id=\"darknet-19-检测模型完整版\"><a class=\"markdownIt-Anchor\" href=\"#darknet-19-检测模型完整版\">#</a> DarkNet-19 检测模型（完整版）</h2>\n<img data-src=\"../../../images/python/YOLO/v2/6.png\" alt=\"v1\"  />\n<h2 id=\"多尺度训练\"><a class=\"markdownIt-Anchor\" href=\"#多尺度训练\">#</a> 多尺度训练</h2>\n<p>多尺度训练是 YOLOv2 提出的一种非常聪明的训练技巧。它的核心思想是让模型在训练过程中不断看到不同分辨率的图片，从而增强模型对不同尺寸物体的鲁棒性。</p>\n<p>模型不再依赖于物体的 “绝对像素大小”，而是学习物体的 “相对形状特征”。</p>\n<h1 id=\"参考\"><a class=\"markdownIt-Anchor\" href=\"#参考\">#</a> 参考</h1>\n<ol>\n<li>【YOLOv1、YOLOv2、YOLOv3 目标检测算法原理与实战】<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL0JWMVdUNDIxcjcydw==\">https://www.bilibili.com/video/BV1WT421r72w</span></li>\n</ol>\n",
            "tags": [
                "深度学习",
                "YOLO",
                "python",
                "CNN",
                "深度学习",
                "YOLO"
            ]
        },
        {
            "id": "https://735690757.github.io/life/p2025/",
            "url": "https://735690757.github.io/life/p2025/",
            "title": "回望2025——永不熄灭之光",
            "date_published": "2026-01-01T04:12:12.000Z",
            "content_html": "<h1 id=\"永不熄灭之光\"><a class=\"markdownIt-Anchor\" href=\"#永不熄灭之光\">#</a> 永不熄灭之光</h1>\n<p>2025 年，是一个充满挑战也充满希望的年份。</p>\n<p>这一年，我结束了大学生涯，进入研究生阶段。</p>\n<p>这一年，我与旧时好友挥手告别，也结识了许多新朋友。</p>\n<p>这一年，我学会在不确定中前行，在压力与迷茫中寻找方向。</p>\n<p>这一年，也是自我怀疑与重塑信念彼此交织的一年。</p>\n<p>那些看似平凡的日子，终将在回望时，汇聚成值得珍藏的记忆。</p>\n<p>我曾在深夜反复审视自己的选择，也曾在沉默中质问前路的意义。</p>\n<p>所谓坚定，并非从未动摇，</p>\n<p>而是在一次次动摇之后，仍愿意选择前行。</p>\n<p>那些未被看见的努力，那些无人知晓的坚持，</p>\n<p>如暗夜中的星火，虽小，却足以照亮漫长的路。</p>\n<p>心中的那束光，历经风雨，依然未曾熄灭。</p>\n<p>2025 年我开启了全新篇章，学习了很多新技术，</p>\n<p>这些知识不仅改变了我的学习方式，也重塑了我看待问题的视角，</p>\n<p>让我在未知面前，少了一分畏惧，多了一分从容。</p>\n<p>由此，我将其称之为：2025 永不熄灭之光。</p>\n<hr>\n<p>2026 年我仍将持续努力，不断学习新技术，奋勇前行。</p>\n<p>畅游在艺术与编程的海洋中， 用代码艺术编织未来。</p>\n<p>Swim in the ocean of art and programming, weave the future with code art.</p>\n",
            "tags": [
                "生活",
                "生活"
            ]
        },
        {
            "id": "https://735690757.github.io/English/shEnglish/",
            "url": "https://735690757.github.io/English/shEnglish/",
            "title": "文章翻译",
            "date_published": "2025-12-21T03:00:00.000Z",
            "content_html": "<h1 id=\"英语文章翻译\"><a class=\"markdownIt-Anchor\" href=\"#英语文章翻译\">#</a> 英语文章翻译</h1>\n<h2 id=\"c1p1\"><a class=\"markdownIt-Anchor\" href=\"#c1p1\">#</a> C1P1</h2>\n<p>It’s hard to imagine meeting someone for the first time and not exchanging any personal information.</p>\n<blockquote>\n<p>很难想象，与某人第一次见面却没有交换任何个人信息。</p>\n</blockquote>\n<p>At the very least, you offer your name and a few important facts - perhaps age, occupation,reason for joining a certain organization, or reason for attending a certain class.</p>\n<blockquote>\n<p>至少你会提供你的名字和一些重要的个人情况比如年龄、职业、加入某个组织或者参加某个课程的原因。</p>\n</blockquote>\n<p>As friendships develop, however, the answer to the question “Who are you?” becomes more complex.</p>\n<blockquote>\n<p>然而随着友谊的发展，“你是谁” 这个问题的答案会变得越来越复杂</p>\n</blockquote>\n<p>Our identities start to form when we are children and continue to grow,solidify, and even change as we mature.</p>\n<blockquote>\n<p>我们的身份认同从孩童时代开始形成，并随着我们的成长而不断发展和巩固，甚至会随着我们的成熟而发生变化。</p>\n</blockquote>\n<p>A person’s identity is actually made up of many different aspects, some broad and some narrow.</p>\n<blockquote>\n<p>一个人的身份实际上由许多不同的方面构成，有些方面宽泛，有些方面则具体。</p>\n</blockquote>\n<p>For instance, you might identify with the broad categories of “German,”“male,” and “student” as well as the narrower ones of&quot;violinist,&quot;“left-handed person,” and “brother of Anna.”</p>\n<blockquote>\n<p>例如，你可能会认同 “德国人”、“男性” 和 “学生” 这些宽泛的类别，以及 “小提琴手”、“左撇子” 和 “安娜的哥哥” 这些更具体的类别</p>\n</blockquote>\n<p>Identity traits can be ascribed, achieved or chosen.</p>\n<blockquote>\n<p>身份特质可以是赋予的、获得的或选择的。</p>\n</blockquote>\n<p>An ascribed trait is one that you are born with; examples include your ethnicity, your birthplace, and being the child and possibly the sibling of certain people.</p>\n<blockquote>\n<p>被赋予的是你与生俱来的特质；例如，你的种族、出生地，以及作为某些人的子女甚至可能是兄弟姐妹。</p>\n</blockquote>\n<p>An achieved trait is one you work for, such as being a university graduate or the employee of a certain company. An identity such as a club membership or affiliation with a political party is chosen.</p>\n<blockquote>\n<p>获得性特质是你努力追求的，比如大学毕业或成为某公司的员工。而身份则是你选择的，比如加入某个俱乐部或成为某个政党的成员。</p>\n</blockquote>\n<p>However, traits are not always so easy to categorize.</p>\n<blockquote>\n<p>然而，特征并不总是那么容易归类。</p>\n</blockquote>\n<p>Is speaking your native language, for example, ascribed (because you were born into the family and country where that language was spoken), achieved (because you studied the language and became more proficient), or even chosen (if you grew up in a multilingual country, but preferred one language over another)?</p>\n<blockquote>\n<p>例如，说你的母语，是因为你出生在讲这种语言的家庭和国家，所以被赋予了这种语言？还是因为你学习了这种语言并变得更加熟练，所以掌握了这种语言？或者，如果你在一个多语言国家长大，但更喜欢一种语言而不是另一种语言，那么你是主动选择了这种语言？</p>\n</blockquote>\n<p>Our identities are important not only because they shape our belief in who we are, but also because they impact how others treat us.</p>\n<blockquote>\n<p>我们的身份之所以重要，不仅是因为它们塑造了我们对自我身份的认知，更是因为它们影响着他人对我们的态度。</p>\n</blockquote>\n<p>Although traits can be positive (intelligent; loyal) or negative (stubborn;criminal), people are more affected by how similar or different their traits are compared to those of other people.</p>\n<blockquote>\n<p>尽管特质可以是积极的（如聪明、忠诚）或消极的（如固执、犯罪），但人们更容易受到自己特质与他人特质相似或相异程度的影响。</p>\n</blockquote>\n<p>For example, if you are a fan of the Falcons sports team, you have something in common with other Falcons fans.</p>\n<blockquote>\n<p>例如，如果你是猎鹰队的球迷，那么你和其他猎鹰队的球迷就有共同之处。</p>\n</blockquote>\n<p>The next time you go to an event or social gathering, watch how people who are strangers at first try to find something in common with the people they meet-perhaps a shared hometown,a similar occupation or hobby, or even the same opinion about the weather that day or a current event</p>\n<blockquote>\n<p>下次你去参加活动或社交聚会时，观察一下那些起初是陌生人的人是如何试图找到与他们遇到的人的共同点的 —— 也许是共同的家乡、相似的职业或爱好，甚至是当天对天气或当前事件的相同看法</p>\n</blockquote>\n<p>People don’t just define themselves as who they are, however; theyalso define themselves as who they are not.</p>\n<blockquote>\n<p>然而，人们不仅仅定义自己是谁，他们还定义自己不是谁。</p>\n</blockquote>\n<p>That is to say, they aren’t just fans of the Springfield High School basketball team; they are also not fans of the Pleasant Valley High School basketball team.</p>\n<blockquote>\n<p>也就是说，他们不仅是斯普林菲尔德高中篮球队的粉丝，同时也不是普莱森特谷高中篮球队的粉丝</p>\n</blockquote>\n<p>A friendly rivalry between two sports teams isn’t necessarily a bad thing, but when rivalries are taken too far or tensions arise over differences about larger social issues, the consequences can be more serious.</p>\n<blockquote>\n<p>两支运动队之间友好的竞争并不一定是坏事，但当竞争过度或因更大的社会问题上的分歧而引发紧张局势时，后果可能会更加严重。</p>\n</blockquote>\n<p>Interestingly, groups that have a lot in common sometimes form the most intense separate identities.</p>\n<blockquote>\n<p>有趣的是，有很多共同点的群体有时会形成最强烈的独立身份。</p>\n</blockquote>\n<p>To someone who doesn’t use a computer at all, they might all seem very similar.</p>\n<blockquote>\n<p>对于一个根本不使用电脑的人来说，它们可能看起来都很相似。</p>\n</blockquote>\n<p>However, debates over the best brands of laptop can become quite heated.</p>\n<blockquote>\n<p>然而，关于笔记本电脑最佳品牌的争论可能会变得相当激烈。</p>\n</blockquote>\n<p>People form different groups over whether they preferred a book or movie adaptation; which brand of cell phone they prefer; which leader in the same political party they support.</p>\n<blockquote>\n<p>人们会因为喜欢某本书或某个电影的改编、某个手机品牌、或因支持同一党内领导人而形成不同群体。</p>\n</blockquote>\n<p>States or cities that are near each other can be stronger rivals than those separated by greater distances.</p>\n<blockquote>\n<p>相距较近的州或城市可能比相距较远的州或市更强大。</p>\n</blockquote>\n<p>Rather than confirming the positive effects of social identity, these rivalries can make people feel insecure, threatened, angry, or even fearful.</p>\n<blockquote>\n<p>这些竞争非但没有证实社会认同的积极影响，反而会让人们感到不安全、威胁、愤怒，甚至恐惧。</p>\n</blockquote>\n<p>The challenge, then, for both leaders and all of us in society is to foster the positive effects of group membership while avoiding the negative ones.</p>\n<blockquote>\n<p>因此，对于领导者和我们社会中的所有人来说，挑战在于培养群体成员的积极影响，同时避免消极影响。</p>\n</blockquote>\n<h2 id=\"c1p2\"><a class=\"markdownIt-Anchor\" href=\"#c1p2\">#</a> C1P2</h2>\n<p>You know the old saying: You can’t teach an old dog new tricks.</p>\n<blockquote>\n<p>你知道一句老话：老狗学不了新把戏。</p>\n</blockquote>\n<p>It’s no surprise that we tend to believe that a person’s personality is stable.</p>\n<blockquote>\n<p>我们倾向于相信一个人的性格是稳定的，这并不奇怪。</p>\n</blockquote>\n<p>People might disagree about whether someone is born with a certain personality or develops a personality while growing up,but it’s commonly accepted that someone’s personality will be much the same at age 50 as it was at age 20.</p>\n<blockquote>\n<p>人们可能不同意一个人是天生具有某种性格，还是在成长过程中发展出某种性格，但人们普遍认为，一个人的性格在 50 岁时与 20 岁时基本相同。</p>\n</blockquote>\n<p>Both in our personal lives and our work lives, we’re told that we need to accept people the way they are and to learn to get along with other people even when they’re difficult.</p>\n<blockquote>\n<p>在我们的个人生活和工作生活中，我们被告知，我们需要接受人们的现状，学会与他人相处，即使他们很难相处。</p>\n</blockquote>\n<p>After all, they’re never going to change.</p>\n<blockquote>\n<p>毕竟，他们永远不会改变。</p>\n</blockquote>\n<p>New evidence,however, suggests that this isn’t true.</p>\n<blockquote>\n<p>然而，新的证据表明，事实并非如此。</p>\n</blockquote>\n<p>Published in the journal Psychology and Aging, a comprehensive study by four psychologists examined a group of Scottish volunteers over a period of 63years, making it the longest study of its type ever done.</p>\n<blockquote>\n<p>发表在《心理学与衰老》杂志上的一项由四位心理学家进行的综合研究对一组苏格兰志愿者进行了为期 63 年的调查，使其成为有史以来最长的同类研究。</p>\n</blockquote>\n<p>And what they found was unexpected: namely, no correlation at all between the participants’ scores on personality tests when they were 14 years old and the same tests when they were 77 years old.</p>\n<blockquote>\n<p>他们的发现出乎意料：即参与者 14 岁时的性格测试得分与 77 岁时的相同测试得分之间根本没有相关性。</p>\n</blockquote>\n<p>The test examined six areas: self-confidence,perseverance, stability of moods, conscientiousness,originality, and desire to learn.</p>\n<blockquote>\n<p>该测试考察了六个方面：自信、毅力、情绪稳定性、责任心、原创性和学习欲望。</p>\n</blockquote>\n<p>The original study involved 1,208 children, and 174 of them were available for the follow-up study six decades later.</p>\n<blockquote>\n<p>最初的研究涉及 1208 名儿童，其中 174 名儿童在 60 年后可用于后续研究。</p>\n</blockquote>\n<p>Because it’s not reliable to have people rate themselves, the participants were evaluated in these categories by other people-by teachers when they were 14, and by friends or relatives when they were 77.</p>\n<blockquote>\n<p>因为让人们对自己进行评分是不可靠的，所以参与者在 14 岁时由其他人进行评估，在 77 岁时由朋友或亲戚进行评估。</p>\n</blockquote>\n<p>They were also tested for intelligence and general well-being.</p>\n<blockquote>\n<p>他们还接受了智力和总体小方格状况的测试。</p>\n</blockquote>\n<p>The researchers were surprised to find that none of the ratings matched up with each other over the years.</p>\n<blockquote>\n<p>研究人员惊讶地发现，多年来，这些评级都不匹配。</p>\n</blockquote>\n<p>Earlier studies and tests produced somewhat different outcomes.</p>\n<blockquote>\n<p>早期的研究和测试产生了一些不同的结果。</p>\n</blockquote>\n<p>Research suggested a few character traits had a low correlation over time and others had a modest correlation.</p>\n<blockquote>\n<p>研究表明，随着时间的推移，一些性格特征的相关性较低，而另一些则相关性适中。</p>\n</blockquote>\n<p>The Scottish study, although smaller in scope because it involved fewer participants, measured them over a much longer period of time.</p>\n<blockquote>\n<p>苏格兰的这项研究尽管规模不大，但其时间跨度更长。</p>\n</blockquote>\n<p>This led there searchers to conclude that personality shifts are more likely to occur over long periods of time.</p>\n<blockquote>\n<p>这导致研究人员得出结论，人格转变更有可能在很长一段时间内发生。</p>\n</blockquote>\n<p>Now, it’s not a perfect study,of course; such a thing is rare, if not impossible, with human beings and personality.</p>\n<blockquote>\n<p>当然，这并非一项完美的研究；对于人类和性格而言，这样的研究实属罕见，甚至可以说是不可能的。</p>\n</blockquote>\n<p>For instance, the people who did the ratings in 1950 were not the same people who did the ratings in 2012, and this could have caused some difference.</p>\n<blockquote>\n<p>例如，1950 年进行评级的人与 2012 年进行评级的人并非同一拨人，这可能会造成一些差异。</p>\n</blockquote>\n<p>It’s difficult for a study on something as broad as identity and personality to take all the variables into consideration.</p>\n<blockquote>\n<p>对于像身份和性格这样广泛的研究课题来说，要将所有变量都考虑在内是很困难的。</p>\n</blockquote>\n<p>However, the results are still significant, and they have interesting implications.</p>\n<blockquote>\n<p>然而，结果仍然是重要的，他们有有趣的启示。</p>\n</blockquote>\n<p>Let’s consider some of those implications for a moment. What does it all mean? And is it only of academic interest, or can you yourself apply this knowledge to your own life?</p>\n<blockquote>\n<p>让我们考虑一下其中的一些含义。这一切意味着什么？这仅仅是学术上的兴趣，还是你能把这些知识应用到你自己的生活中？</p>\n</blockquote>\n<p>For one thing,it should give you a new way to think about other people.</p>\n<blockquote>\n<p>首先，它应该给你一种思考他人的新方式。</p>\n</blockquote>\n<p>For example, say you’re contacted on social media by someone you knew in school years ago. If you didn’t like the person at that time, you might be tempted to refuse the connection.</p>\n<blockquote>\n<p>例如，假设你在社交媒体上被你多年前在学校认识的人联系。如果你当时不喜欢这个人，你可能会想要拒绝这段关系。</p>\n</blockquote>\n<p>If you didn’t like each other then, after all, why would you like each other now?</p>\n<blockquote>\n<p>毕竟，如果你们当时不喜欢对方，为什么现在会喜欢对方呢？</p>\n</blockquote>\n<p>But if it’s true that personality can change, then there’s a reason to give that person another chance.</p>\n<blockquote>\n<p>但如果性格真的可以改变，那就有理由再给那个人一次机会。</p>\n</blockquote>\n<p>He or she might be very different now -and you might beto0.</p>\n<blockquote>\n<p>他或她现在可能和以前大不相同了 —— 你也可能是。</p>\n</blockquote>\n<p>You might also have more reasonable expectations of old childhood friends who reconnect after many years.</p>\n<blockquote>\n<p>你也可能对多年后重新联系的童年老朋友有更合理的期望。</p>\n</blockquote>\n<p>If you know their personalities (and yours) could have changed over the years, you’ll be less disappointed if your friendship isn’t as deep now as it was before.</p>\n<blockquote>\n<p>如果你知道他们（和你自己）的性格可能会随着时间的推移而改变，那么如果你们的友谊没有以前那么深厚，你就不会那么失望了。</p>\n</blockquote>\n<p>Rather than feel frustrated with yourselves, the two of you can accept that you have changed.</p>\n<blockquote>\n<p>与其对自己感到沮丧，不如接受自己已经改变的事实。</p>\n</blockquote>\n<p>The study has implications for the workplace too.</p>\n<blockquote>\n<p>这项研究对工作场所也有影响。</p>\n</blockquote>\n<p>Personality forms a large part of a worker’s suitability for a job, both in dealing with co-workers and in dealing with clients.</p>\n<blockquote>\n<p>性格在很大程度上决定了一个人是否适合一份工作，无论是在与同事打交道还是与客户打交道时。</p>\n</blockquote>\n<p>If a person has a personality trait that interferes with work-say he argues with customers or she misses deadlines-it’s important for managers to know that these traits can change.</p>\n<blockquote>\n<p>如果一个人的性格特征会干扰工作，比如他会和客户争吵，或者她错过了截止日期，那么管理者就应该知道这些性格特征是可以改变的。</p>\n</blockquote>\n<p>It’s usually cheaper to train a current employee than to let that person go and hire a replacement.</p>\n<blockquote>\n<p>通常来说，培训一名现有员工要比让他离开并雇佣一个替代者便宜得多。</p>\n</blockquote>\n<p>Even employees who aren’t experiencing problems can be trained to be even better and more effective in terms of personality.</p>\n<blockquote>\n<p>即使没有遇到问题的员工也可以通过培训，在个性方面表现得更好、更有效。</p>\n</blockquote>\n<p>This will help ensure that people continue to get along with one another.</p>\n<blockquote>\n<p>这将有助于确保人们继续彼此相处。</p>\n</blockquote>\n<p>Finally, there are personal implications.</p>\n<blockquote>\n<p>最后，还有个人影响。</p>\n</blockquote>\n<p>If you’re the sort of person who says things like &quot;I have a quick temper&quot;or “My problem is I can’t help procrastinating” or &quot;I’ve always been too sensitive, and I blame myself when ever something goes wrong,&quot;it should be good news to know that these personality traits are not ones you have to keep.</p>\n<blockquote>\n<p>如果你是那种会说 “我脾气暴躁” 或 “我的问题是我总是忍不住拖延” 或 “我总是太敏感，一旦出了问题我就会责怪自己” 的人，那么知道这些性格特征并不是你必须保留的，这应该是个好消息。</p>\n</blockquote>\n<p>Although some therapists do good work helping patients accept themselves as they are,to build self-esteem,wouldn’t it be more beneficial to eliminate negative personality traits than to learn to accept them?</p>\n<blockquote>\n<p>尽管一些治疗师在帮助病人接受自己的本来面目、建立自尊方面做得很好，但消除消极的人格特征不是比学会接受它们更有益吗？</p>\n</blockquote>\n<p>Knowing that you can change is the first stage in learning how to change.</p>\n<blockquote>\n<p>知道自己可以改变是学习如何改变的第一步。</p>\n</blockquote>\n<p>Then you can look forward to saying things like,“I used to be too sensitive, but I’m not anymore”;or look forward to a time when,as we might start saying, you can learn some new tricks.</p>\n<blockquote>\n<p>然后你就可以期待说这样的话：“我以前太敏感了，但现在不会了。” 或者期待有一天，就像我们开始说的，你可以学到一些新技巧。</p>\n</blockquote>\n<h2 id=\"c2p1\"><a class=\"markdownIt-Anchor\" href=\"#c2p1\">#</a> C2P1</h2>\n<p>Oh, no! You dropped the cup, and it smashed! Time to throw it away and buy a new one.</p>\n<blockquote>\n<p>哦，不！你把杯子掉在地上，打碎了！是时候扔掉它，买一个新的了。</p>\n</blockquote>\n<p>Unless, perhaps, you are a fan of the Japanese art of kintsugi or kintsukuroi–roughly translated,&quot;to mend with gold.&quot;This is the practice among certain craftsmen of mending the broken pieces of pottery, such as a plate, a cup, or a bowl, with gold (or similar) lacquer.</p>\n<blockquote>\n<p>除非你是日本 kintsugi 或 kintsukuroi 艺术的粉丝。这是某些工匠用金（或类似的）漆修补破碎的陶器碎片的做法，例如盘子，杯子或碗。</p>\n</blockquote>\n<p>The gold is used to glue the pieces back together</p>\n<blockquote>\n<p>金子是用来把碎片粘在一起的</p>\n</blockquote>\n<p>If small pieces are missing, they can be created out of gold, or a piece from a different bowl or plate can be used instead.</p>\n<blockquote>\n<p>如果少了一小块，可以用黄金制作，或者用另一个碗或盘子里的小块代替。</p>\n</blockquote>\n<p>The repaired product’s value is not reduced, though-it is actually enhanced.</p>\n<blockquote>\n<p>修复后的产品的价值并没有减少，反而增加了。</p>\n</blockquote>\n<p>It is believed to become more beautiful because it was broken.</p>\n<blockquote>\n<p>人们认为它因为被打破而变得更加美丽。</p>\n</blockquote>\n<p>Pieces of kintsugi pottery can be enormously expensive and are featured in museum exhibits in Japan and overseas.</p>\n<blockquote>\n<p>金杉陶器非常昂贵，在日本和海外的博物馆都有展出。</p>\n</blockquote>\n<p>These days you can even see machine-made ceramics with gold designs on them that look as if they are kintsugi,even though the original was actually never broken.</p>\n<blockquote>\n<p>如今，你甚至可以看到机器制作的陶瓷，上面有金色的图案，看起来像是金杉，尽管原来的金杉实际上从未破损过。</p>\n</blockquote>\n<p>But the mended patterns have become so trendy that people want to imitate them.</p>\n<blockquote>\n<p>但是缝补的图案变得如此流行，以至于人们都想模仿它们。</p>\n</blockquote>\n<p>There’s a story or legend behind the practice - which may or may not be historically accurate, but beautifully illustrates the concept.</p>\n<blockquote>\n<p>这种做法背后有一个故事或传说 —— 可能与历史不相符，但却很好地说明了这一概念。</p>\n</blockquote>\n<p>More than five hundred years ago, there lived a military ruler in Japan, who owned a bowl he especially loved.</p>\n<blockquote>\n<p>五百多年前，日本有一位军事统治者，他有一只碗，他特别喜欢。</p>\n</blockquote>\n<p>One day while he was entertaining some guests, his servant dropped the bowl, and it broke into five pieces.</p>\n<blockquote>\n<p>一天，当他招待客人时，他的仆人把碗掉在地上，摔成了五片。</p>\n</blockquote>\n<p>Knowing the leader’s bad temper, his guests worried that he would punish the servant</p>\n<blockquote>\n<p>客人们知道首领的坏脾气，担心他会惩罚仆人</p>\n</blockquote>\n<p>However, one of the guests made up an amusing poem about the incident</p>\n<blockquote>\n<p>然而，其中一位客人就这件事编了一首有趣的诗</p>\n</blockquote>\n<p>Everybody laughed, including the ruler.</p>\n<blockquote>\n<p>每个人都笑了，包括统治者。</p>\n</blockquote>\n<p>When he relaxed, he was able to see that the bowl’s beauty had not been destroyed by the accident.</p>\n<blockquote>\n<p>当他放松下来时，他能看到碗的美丽并没有被事故破坏。</p>\n</blockquote>\n<p>Instead,because the vessel could be repaired, the ruler now had a new appreciation for its strength and ability to survive.</p>\n<blockquote>\n<p>相反，因为容器可以修复，统治者现在对它的力量和生存能力有了新的认识。</p>\n</blockquote>\n<p>In fact, according to the story, the true life of the bowl began the moment it was dropped.</p>\n<blockquote>\n<p>事实上，根据这个故事，这个碗的真正生命从它被扔下的那一刻就开始了。</p>\n</blockquote>\n<p>If this seems a hard notion to understand, then consider it in light of another Japanese philosophy, that of wabi-sabi.</p>\n<blockquote>\n<p>如果这似乎是一个难以理解的概念，那么请根据另一种日本哲学来考虑它，那就是 wabi-sabi。</p>\n</blockquote>\n<p>This is harder to translate into English, but it refers to the combination of three beliefs that nothing is permanent, nothing is finished, and nothing is perfect.</p>\n<blockquote>\n<p>这句话很难翻译成英语，但它指的是三个信念的结合：没有什么是永恒的，没有什么是完成的，没有什么是完美的。</p>\n</blockquote>\n<p>Applied to arts and crafts, it explains why the Japanese traditionally value handmade objects.</p>\n<blockquote>\n<p>应用于工艺品，它解释了为什么日本传统上重视手工制品。</p>\n</blockquote>\n<p>Even though they look less perfect than those made by machine, it is actually this imperfection that makes them beautiful</p>\n<blockquote>\n<p>尽管它们看起来没有机器制作的那么完美，但实际上正是这种不完美让它们变得美丽</p>\n</blockquote>\n<p>In fact, artists who value the wabi-sabi aesthetic create works that are deliberately imperfect, such as a bowl that isn’t entirely round or a vase with a thumbprint visible in the clay.</p>\n<blockquote>\n<p>事实上，看重 wabi-sabi 美学的艺术家会刻意创造出不完美的作品，比如一个不全圆的碗，或者一个在粘土上可以看到拇指指纹的花瓶。</p>\n</blockquote>\n<p>Rough surfaces, instead of ones smoothed by machines, are common in wabi-sabi ceramics, and often the pieces are not glazed or colored.</p>\n<blockquote>\n<p>粗糙的表面，而不是机器光滑的表面，在 wabi-sabi 陶瓷中很常见，而且这些碎片通常没有上釉或着色。</p>\n</blockquote>\n<p>It’s not just Japan that has such a tradition, however</p>\n<blockquote>\n<p>然而，并非只有日本有这样的传统</p>\n</blockquote>\n<p>A similar idea can be found in Iran, among the makers of Persian rugs.</p>\n<blockquote>\n<p>在伊朗的波斯地毯制造商中也可以找到类似的想法。</p>\n</blockquote>\n<p>Tradition has it that those who weave carpets will deliberately include one small flaw,as recognition of the fact that nothing can be perfect.</p>\n<blockquote>\n<p>传统上，编织地毯的人会故意留下一个小瑕疵，因为他们意识到没有什么是完美的。</p>\n</blockquote>\n<p>The intentional mistake reminds them to be modest about their work.</p>\n<blockquote>\n<p>故意的错误提醒他们对自己的工作要谦虚。</p>\n</blockquote>\n<p>Similarly, some early American settlers known as the Puritans included a “humility square” when they sewed a quilt -one square that didn’t match the rest of the blanket.</p>\n<blockquote>\n<p>类似地，一些被称为清教徒的早期美国定居者在缝制被子时也会附上一块 “谦卑的方巾”—— 这块方巾与毯子的其他部分不匹配。</p>\n</blockquote>\n<p>Some Native American bead workers would include an intentional “mistake bead” for the same reason.</p>\n<blockquote>\n<p>出于同样的原因，一些印第安人的头饰工人会故意加上一个 “错误的头饰”。</p>\n</blockquote>\n<p>Such practices have also been reported among Amish furniture makers in the United States and some forms of Islamic art - although careful work by sociologists and historians suggests that these stories are actually not true, but rather a romanticized version of their art or a misunderstanding of a tradition.</p>\n<blockquote>\n<p>在美国的阿米什家具制造商和某些形式的伊斯兰艺术中也有类似的报道 —— 尽管社会学家和历史学家的仔细研究表明，这些故事实际上不是真实的，而是他们艺术的浪漫化版本，或者是对传统的误解。</p>\n</blockquote>\n<p>True or not,however, these cultural practices teach us not only about art but about life, and the importance of not only accepting, but actually celebrating, our imperfections.</p>\n<blockquote>\n<p>无论真假，这些文化实践不仅教会了我们艺术，也教会了我们生活，教会了我们不仅要接受，而且要赞美我们的不完美的重要性</p>\n</blockquote>\n<p>That doesn’t mean we shouldn’t care about making mistakes; but for many people, worrying about small imperfections keeps them from finishing a project or appreciating one they have finished.</p>\n<blockquote>\n<p>这并不意味着我们不应该在意犯错误；但对很多人来说，担心小瑕疵让他们无法完成一个项目，也无法欣赏他们已经完成的项目。</p>\n</blockquote>\n<p>People who are “perfectionists” can feel insecure and anxious about the art they create, which makes it harder for them to enjoy what they do.</p>\n<blockquote>\n<p>“完美主义者” 会对自己创造的艺术感到不安和焦虑，这使得他们更难享受自己所做的事情。</p>\n</blockquote>\n<p>The concept can even be applied more broadly than just to art, however.</p>\n<blockquote>\n<p>然而，这个概念甚至可以应用于更广泛的领域，而不仅仅是艺术。</p>\n</blockquote>\n<p>Consider yourself, for example. Do you have any imperfections - anything from physical scars to personal habits?</p>\n<blockquote>\n<p>以你自己为例。你有什么不完美的地方吗 —— 从身体上的伤疤到个人习惯？</p>\n</blockquote>\n<p>What if, instead of considering these to be flaws, you could appreciate them as part of what makes you a beautiful person?</p>\n<blockquote>\n<p>如果你不认为这些是缺点，而是把它们看作是让你成为一个美丽的人的一部分呢？</p>\n</blockquote>\n",
            "tags": [
                "笔记",
                "考研英语笔记",
                "英语"
            ]
        }
    ]
}