



<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="诗岸梦行舟" href="https://735690757.github.io/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="诗岸梦行舟" href="https://735690757.github.io/atom.xml" />
<link rel="alternate" type="application/json" title="诗岸梦行舟" href="https://735690757.github.io/feed.json" />
<link rel="stylesheet" href="https://unpkg.com/mermaid/dist/mermaid.min.css">
<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
<script>mermaid.initialize({ startOnLoad: true });</script>

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="python,CNN,深度学习,YOLO" />


<link rel="canonical" href="https://735690757.github.io/python/YOLO/YOLO_V5/">



  <title>
YOLO-V5 with Ultralytics YOLOv5源码解析 - YOLO - 深度学习 |
KarryLiu = 诗岸梦行舟 = 分享计算机知识以及各种心得总结</title>
<meta name="generator" content="Hexo 6.3.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">YOLO-V5 with Ultralytics YOLOv5源码解析
  </h1>
  
<div class="meta">
  <span class="item" title="创建时间：2026-01-16 12:12:12">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">发表于</span>
    <time itemprop="dateCreated datePublished" datetime="2026-01-16T12:12:12+08:00">2026-01-16</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="切换导航栏">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">KarryLiu</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
          <img src="/images/cover/ultralyticsv5.webp">
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">首页</a></span><i class="ic i-angle-right"></i>
<span  itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/python/" itemprop="item" rel="index" title="分类于 深度学习"><span itemprop="name">深度学习</span></a>
<meta itemprop="position" content="1" /></span>
<i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/python/YOLO/" itemprop="item" rel="index" title="分类于 YOLO"><span itemprop="name">YOLO</span></a>
<meta itemprop="position" content="2" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN">
  <link itemprop="mainEntityOfPage" href="https://735690757.github.io/python/YOLO/YOLO_V5/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/tx.jpg">
    <meta itemprop="name" content="KarryLiu">
    <meta itemprop="description" content="分享计算机知识以及各种心得总结, 愿世间所有的美好都得以祝愿">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="诗岸梦行舟">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="yolov5-with-ultralytics-yolov5源码解析"><a class="markdownIt-Anchor" href="#yolov5-with-ultralytics-yolov5源码解析">#</a> YOLOv5 with Ultralytics YOLOv5 源码解析</h1>
<h2 id="工程实现"><a class="markdownIt-Anchor" href="#工程实现">#</a> 工程实现</h2>
<p>【ultralytics-YOLOv5】：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3VsdHJhbHl0aWNzL3lvbG92NQ==">https://github.com/ultralytics/yolov5</span></p>
<h2 id="引言"><a class="markdownIt-Anchor" href="#引言">#</a> 引言</h2>
<p>本篇文章将一改往日风格，先从工程部署再到细节讨论。YOLOv5 之所以能成为很多工程师的首选，不仅是因为它性能强悍，更因为它在工程化上的极致友好：从环境配置、自动锚框计算到多平台导出，几乎做到了开箱即用。</p>
<p>我身为软件工程专业的学生，我想说 YOLOv5 真正打动我的，并不是那几项漂亮的 mAP 指标，而是它背后那种工程优先的设计思维。</p>
<p>在很多传统的深度学习项目中，我们常常会遇到这样的情况：论文很好看，模型结构也很优雅，但一到实际部署阶段，各种环境依赖冲突、版本问题、导出失败、推理速度不稳定接踵而至。而 YOLOv5 给我的感觉更像是一个 “成熟的后端项目”—— 结构清晰、模块解耦、配置集中管理，甚至连日志输出和参数管理都做得非常规范。</p>
<p>如果用我们熟悉的 SpringBoot 思维去类比：</p>
<ul>
<li><code>train.py</code>  像是启动类</li>
<li><code>models/</code>  目录像是核心业务模块</li>
<li><code>utils/</code>  像是工具类封装层</li>
<li><code>data.yaml</code>  类似于 application.yml 配置文件</li>
<li>导出 ONNX / TensorRT 就像是多环境打包部署</li>
</ul>
<p>这种工程结构，让人几乎不用反复翻源码，就可以快速定位问题。</p>
<p>YOLOv5 的脚本里充满了 “自动化” 的影子：</p>
<ul>
<li>Auto-Check： 每次运行都会自动检查  <code>requirements</code> ，甚至能自动下载缺失的字体和预训练权重。</li>
<li>Auto-Anchor： 它深知开发者懒得去算 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>−</mo><mi>m</mi><mi>e</mi><mi>a</mi><mi>n</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">K-means</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span><span class="mord mathnormal">a</span><span class="mord mathnormal">n</span><span class="mord mathnormal">s</span></span></span></span> 聚类，所以内置了基于你私有数据集的 Anchor 自动计算逻辑。</li>
<li>Logging： 原生集成 Tensorboard，这种可观测性设计是大型工程项目的标配。</li>
</ul>
<p>本文致力于从源码出发，剖析模型、训练手段、日志实践、以及各种工程方法，以便用在未来的学术和工程之中，顺便熟悉 Visio 的使用方法，让我们开始吧。</p>
<h2 id="快速开始"><a class="markdownIt-Anchor" href="#快速开始">#</a> 快速开始</h2>
<p>从仓库克隆：</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">git</span> clone https://github.com/ultralytics/yolov5.git</pre></td></tr></table></figure><p>安装环境，推荐 python3.9，torch2.5.1，pytorch-cuda11.8：</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>conda <span class="token function">install</span> <span class="token parameter variable">-c</span> pytorch <span class="token parameter variable">-c</span> nvidia <span class="token parameter variable">-c</span> conda-forge pytorch torchvision pytorch-cuda<span class="token operator">=</span><span class="token number">11.8</span> ultralytics</pre></td></tr></table></figure><p>自动检查：</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> torch</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> utils</pre></td></tr><tr><td data-num="3"></td><td><pre>display <span class="token operator">=</span> utils<span class="token punctuation">.</span>notebook_init<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># checks</span></pre></td></tr></table></figure><p>预测：</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>python detect.py <span class="token parameter variable">--weights</span> yolov5s.pt <span class="token parameter variable">--img</span> <span class="token number">1000</span> <span class="token parameter variable">--conf</span> <span class="token number">0.25</span> <span class="token parameter variable">--source</span> <span class="token number">0</span></pre></td></tr></table></figure><p>其余验证、训练和可视化可在 tutorial.ipynb 中查看。</p>
<h2 id="看看模型"><a class="markdownIt-Anchor" href="#看看模型">#</a> 看看模型</h2>
<p>运行 yolo.py 得到如下结果：</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>from  n    params  module                                  arguments                     </pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token number">0</span>                <span class="token parameter variable">-1</span>  <span class="token number">1</span>      <span class="token number">3520</span>  models.common.Conv                      <span class="token punctuation">[</span><span class="token number">3</span>, <span class="token number">32</span>, <span class="token number">6</span>, <span class="token number">2</span>, <span class="token number">2</span><span class="token punctuation">]</span>              </pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token number">1</span>                <span class="token parameter variable">-1</span>  <span class="token number">1</span>     <span class="token number">18560</span>  models.common.Conv                      <span class="token punctuation">[</span><span class="token number">32</span>, <span class="token number">64</span>, <span class="token number">3</span>, <span class="token number">2</span><span class="token punctuation">]</span>                </pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token number">2</span>                <span class="token parameter variable">-1</span>  <span class="token number">1</span>     <span class="token number">18816</span>  models.common.C3                        <span class="token punctuation">[</span><span class="token number">64</span>, <span class="token number">64</span>, <span class="token number">1</span><span class="token punctuation">]</span>                   </pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token number">3</span>                <span class="token parameter variable">-1</span>  <span class="token number">1</span>     <span class="token number">73984</span>  models.common.Conv                      <span class="token punctuation">[</span><span class="token number">64</span>, <span class="token number">128</span>, <span class="token number">3</span>, <span class="token number">2</span><span class="token punctuation">]</span>               </pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token number">4</span>                <span class="token parameter variable">-1</span>  <span class="token number">2</span>    <span class="token number">115712</span>  models.common.C3                        <span class="token punctuation">[</span><span class="token number">128</span>, <span class="token number">128</span>, <span class="token number">2</span><span class="token punctuation">]</span>                 </pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token number">5</span>                <span class="token parameter variable">-1</span>  <span class="token number">1</span>    <span class="token number">295424</span>  models.common.Conv                      <span class="token punctuation">[</span><span class="token number">128</span>, <span class="token number">256</span>, <span class="token number">3</span>, <span class="token number">2</span><span class="token punctuation">]</span>              </pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token number">6</span>                <span class="token parameter variable">-1</span>  <span class="token number">3</span>    <span class="token number">625152</span>  models.common.C3                        <span class="token punctuation">[</span><span class="token number">256</span>, <span class="token number">256</span>, <span class="token number">3</span><span class="token punctuation">]</span>                 </pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token number">7</span>                <span class="token parameter variable">-1</span>  <span class="token number">1</span>   <span class="token number">1180672</span>  models.common.Conv                      <span class="token punctuation">[</span><span class="token number">256</span>, <span class="token number">512</span>, <span class="token number">3</span>, <span class="token number">2</span><span class="token punctuation">]</span>              </pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token number">8</span>                <span class="token parameter variable">-1</span>  <span class="token number">1</span>   <span class="token number">1182720</span>  models.common.C3                        <span class="token punctuation">[</span><span class="token number">512</span>, <span class="token number">512</span>, <span class="token number">1</span><span class="token punctuation">]</span>                 </pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token number">9</span>                <span class="token parameter variable">-1</span>  <span class="token number">1</span>    <span class="token number">656896</span>  models.common.SPPF                      <span class="token punctuation">[</span><span class="token number">512</span>, <span class="token number">512</span>, <span class="token number">5</span><span class="token punctuation">]</span>                 </pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token number">10</span>                <span class="token parameter variable">-1</span>  <span class="token number">1</span>    <span class="token number">131584</span>  models.common.Conv                      <span class="token punctuation">[</span><span class="token number">512</span>, <span class="token number">256</span>, <span class="token number">1</span>, <span class="token number">1</span><span class="token punctuation">]</span>              </pre></td></tr><tr><td data-num="13"></td><td><pre> <span class="token number">11</span>                <span class="token parameter variable">-1</span>  <span class="token number">1</span>         <span class="token number">0</span>  torch.nn.modules.upsampling.Upsample    <span class="token punctuation">[</span>None, <span class="token number">2</span>, <span class="token string">'nearest'</span><span class="token punctuation">]</span>          </pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token number">12</span>           <span class="token punctuation">[</span>-1, <span class="token number">6</span><span class="token punctuation">]</span>  <span class="token number">1</span>         <span class="token number">0</span>  models.common.Concat                    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>                           </pre></td></tr><tr><td data-num="15"></td><td><pre> <span class="token number">13</span>                <span class="token parameter variable">-1</span>  <span class="token number">1</span>    <span class="token number">361984</span>  models.common.C3                        <span class="token punctuation">[</span><span class="token number">512</span>, <span class="token number">256</span>, <span class="token number">1</span>, False<span class="token punctuation">]</span>          </pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token number">14</span>                <span class="token parameter variable">-1</span>  <span class="token number">1</span>     <span class="token number">33024</span>  models.common.Conv                      <span class="token punctuation">[</span><span class="token number">256</span>, <span class="token number">128</span>, <span class="token number">1</span>, <span class="token number">1</span><span class="token punctuation">]</span>              </pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token number">15</span>                <span class="token parameter variable">-1</span>  <span class="token number">1</span>         <span class="token number">0</span>  torch.nn.modules.upsampling.Upsample    <span class="token punctuation">[</span>None, <span class="token number">2</span>, <span class="token string">'nearest'</span><span class="token punctuation">]</span>          </pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token number">16</span>           <span class="token punctuation">[</span>-1, <span class="token number">4</span><span class="token punctuation">]</span>  <span class="token number">1</span>         <span class="token number">0</span>  models.common.Concat                    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>                           </pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token number">17</span>                <span class="token parameter variable">-1</span>  <span class="token number">1</span>     <span class="token number">90880</span>  models.common.C3                        <span class="token punctuation">[</span><span class="token number">256</span>, <span class="token number">128</span>, <span class="token number">1</span>, False<span class="token punctuation">]</span>          </pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token number">18</span>                <span class="token parameter variable">-1</span>  <span class="token number">1</span>    <span class="token number">147712</span>  models.common.Conv                      <span class="token punctuation">[</span><span class="token number">128</span>, <span class="token number">128</span>, <span class="token number">3</span>, <span class="token number">2</span><span class="token punctuation">]</span>              </pre></td></tr><tr><td data-num="21"></td><td><pre> <span class="token number">19</span>          <span class="token punctuation">[</span>-1, <span class="token number">14</span><span class="token punctuation">]</span>  <span class="token number">1</span>         <span class="token number">0</span>  models.common.Concat                    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>                           </pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token number">20</span>                <span class="token parameter variable">-1</span>  <span class="token number">1</span>    <span class="token number">296448</span>  models.common.C3                        <span class="token punctuation">[</span><span class="token number">256</span>, <span class="token number">256</span>, <span class="token number">1</span>, False<span class="token punctuation">]</span>          </pre></td></tr><tr><td data-num="23"></td><td><pre> <span class="token number">21</span>                <span class="token parameter variable">-1</span>  <span class="token number">1</span>    <span class="token number">590336</span>  models.common.Conv                      <span class="token punctuation">[</span><span class="token number">256</span>, <span class="token number">256</span>, <span class="token number">3</span>, <span class="token number">2</span><span class="token punctuation">]</span>              </pre></td></tr><tr><td data-num="24"></td><td><pre> <span class="token number">22</span>          <span class="token punctuation">[</span>-1, <span class="token number">10</span><span class="token punctuation">]</span>  <span class="token number">1</span>         <span class="token number">0</span>  models.common.Concat                    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>                           </pre></td></tr><tr><td data-num="25"></td><td><pre> <span class="token number">23</span>                <span class="token parameter variable">-1</span>  <span class="token number">1</span>   <span class="token number">1182720</span>  models.common.C3                        <span class="token punctuation">[</span><span class="token number">512</span>, <span class="token number">512</span>, <span class="token number">1</span>, False<span class="token punctuation">]</span>          </pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token number">24</span>      <span class="token punctuation">[</span><span class="token number">17</span>, <span class="token number">20</span>, <span class="token number">23</span><span class="token punctuation">]</span>  <span class="token number">1</span>    <span class="token number">229245</span>  Detect                                  <span class="token punctuation">[</span><span class="token number">80</span>, <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">10</span>, <span class="token number">13</span>, <span class="token number">16</span>, <span class="token number">30</span>, <span class="token number">33</span>, <span class="token number">23</span><span class="token punctuation">]</span>, <span class="token punctuation">[</span><span class="token number">30</span>, <span class="token number">61</span>, <span class="token number">62</span>, <span class="token number">45</span>, <span class="token number">59</span>, <span class="token number">119</span><span class="token punctuation">]</span>, <span class="token punctuation">[</span><span class="token number">116</span>, <span class="token number">90</span>, <span class="token number">156</span>, <span class="token number">198</span>, <span class="token number">373</span>, <span class="token number">326</span><span class="token punctuation">]</span><span class="token punctuation">]</span>, <span class="token punctuation">[</span><span class="token number">128</span>, <span class="token number">256</span>, <span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="27"></td><td><pre>YOLOv5s summary: <span class="token number">214</span> layers, <span class="token number">7235389</span> parameters, <span class="token number">7235389</span> gradients</pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>Fusing layers<span class="token punctuation">..</span>. </pre></td></tr><tr><td data-num="30"></td><td><pre>YOLOv5s summary: <span class="token number">157</span> layers, <span class="token number">7225885</span> parameters, <span class="token number">7225885</span> gradients</pre></td></tr></table></figure><p>首先观察到 YOLOv5s summary 输出一次之后又输出了一次，提示： <code>Fusing layers... </code></p>
<p>融合前：</p>
<p>Conv<br>
├── conv<br>
├── bn<br>
└── act</p>
<p>融合后：</p>
<p>Conv<br>
├── conv (已吸收 bn)<br>
└── act</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">def</span> <span class="token function">fuse</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token triple-quoted-string string">"""Fuses Conv2d() and BatchNorm2d() layers in the model to improve inference speed."""</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Fusing layers... "</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">for</span> m <span class="token keyword">in</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>modules<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token punctuation">(</span>Conv<span class="token punctuation">,</span> DWConv<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token string">"bn"</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            m<span class="token punctuation">.</span>conv <span class="token operator">=</span> fuse_conv_and_bn<span class="token punctuation">(</span>m<span class="token punctuation">.</span>conv<span class="token punctuation">,</span> m<span class="token punctuation">.</span>bn<span class="token punctuation">)</span>  <span class="token comment"># update conv</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token builtin">delattr</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token string">"bn"</span><span class="token punctuation">)</span>  <span class="token comment"># remove batchnorm</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            m<span class="token punctuation">.</span>forward <span class="token operator">=</span> m<span class="token punctuation">.</span>forward_fuse  <span class="token comment"># update forward</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    self<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">return</span> self</pre></td></tr></table></figure><p><code>fuse</code>  用于加速推理。</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">def</span> <span class="token function">fuse_conv_and_bn</span><span class="token punctuation">(</span>conv<span class="token punctuation">,</span> bn<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token triple-quoted-string string">"""Fuses Conv2d and BatchNorm2d layers into a single Conv2d layer.</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    See https://tehnokv.com/posts/fusing-batchnorm-and-conv/.</pre></td></tr><tr><td data-num="5"></td><td><pre>    """</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    fusedconv <span class="token operator">=</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            conv<span class="token punctuation">.</span>in_channels<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            conv<span class="token punctuation">.</span>out_channels<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            kernel_size<span class="token operator">=</span>conv<span class="token punctuation">.</span>kernel_size<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            stride<span class="token operator">=</span>conv<span class="token punctuation">.</span>stride<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            padding<span class="token operator">=</span>conv<span class="token punctuation">.</span>padding<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            dilation<span class="token operator">=</span>conv<span class="token punctuation">.</span>dilation<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            groups<span class="token operator">=</span>conv<span class="token punctuation">.</span>groups<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">.</span>requires_grad_<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">.</span>to<span class="token punctuation">(</span>conv<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>device<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token comment"># Prepare filters</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    w_conv <span class="token operator">=</span> conv<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>conv<span class="token punctuation">.</span>out_channels<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    w_bn <span class="token operator">=</span> torch<span class="token punctuation">.</span>diag<span class="token punctuation">(</span>bn<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>div<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>bn<span class="token punctuation">.</span>eps <span class="token operator">+</span> bn<span class="token punctuation">.</span>running_var<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    fusedconv<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>copy_<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>mm<span class="token punctuation">(</span>w_bn<span class="token punctuation">,</span> w_conv<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>fusedconv<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment"># Prepare spatial bias</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    b_conv <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>conv<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> device<span class="token operator">=</span>conv<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>device<span class="token punctuation">)</span> <span class="token keyword">if</span> conv<span class="token punctuation">.</span>bias <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> conv<span class="token punctuation">.</span>bias</pre></td></tr><tr><td data-num="28"></td><td><pre>    b_bn <span class="token operator">=</span> bn<span class="token punctuation">.</span>bias <span class="token operator">-</span> bn<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>mul<span class="token punctuation">(</span>bn<span class="token punctuation">.</span>running_mean<span class="token punctuation">)</span><span class="token punctuation">.</span>div<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>bn<span class="token punctuation">.</span>running_var <span class="token operator">+</span> bn<span class="token punctuation">.</span>eps<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    fusedconv<span class="token punctuation">.</span>bias<span class="token punctuation">.</span>copy_<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>mm<span class="token punctuation">(</span>w_bn<span class="token punctuation">,</span> b_conv<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> b_bn<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">return</span> fusedconv</pre></td></tr></table></figure><h3 id="yolov5nsmlx"><a class="markdownIt-Anchor" href="#yolov5nsmlx">#</a> YOLOv5——n/s/m/l/x？</h3>
<img data-src="https://cdn.jsdelivr.net/gh/ultralytics/assets@main/docs/yolov5-model-comparison.avif" alt="1" style="zoom:80%;" />
<h3 id="基于yolov5s继续讨论"><a class="markdownIt-Anchor" href="#基于yolov5s继续讨论">#</a> 基于 YOLOv5s 继续讨论</h3>
<p>观察输出可以看到如下组件：</p>
<ol>
<li>Conv</li>
<li>C3</li>
<li>SPPF</li>
<li>Upsample（nearest）</li>
<li>Concat</li>
<li>Detect</li>
</ol>
<p>下面基于此来继续讨论。</p>
<h3 id="conv"><a class="markdownIt-Anchor" href="#conv">#</a> Conv</h3>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Conv</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token triple-quoted-string string">"""Applies a convolution, batch normalization, and activation function to an input tensor in a neural network."""</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    default_act <span class="token operator">=</span> nn<span class="token punctuation">.</span>SiLU<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># default activation</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> g<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> d<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> act<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token triple-quoted-string string">"""Initializes a standard convolution layer with optional batch normalization and activation."""</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        self<span class="token punctuation">.</span>conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> k<span class="token punctuation">,</span> s<span class="token punctuation">,</span> autopad<span class="token punctuation">(</span>k<span class="token punctuation">,</span> p<span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">,</span> groups<span class="token operator">=</span>g<span class="token punctuation">,</span> dilation<span class="token operator">=</span>d<span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        self<span class="token punctuation">.</span>bn <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>c2<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        self<span class="token punctuation">.</span>act <span class="token operator">=</span> self<span class="token punctuation">.</span>default_act <span class="token keyword">if</span> act <span class="token keyword">is</span> <span class="token boolean">True</span> <span class="token keyword">else</span> act <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>act<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span> <span class="token keyword">else</span> nn<span class="token punctuation">.</span>Identity<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token triple-quoted-string string">"""Applies a convolution followed by batch normalization and an activation function to the input tensor `x`."""</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>act<span class="token punctuation">(</span>self<span class="token punctuation">.</span>bn<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">forward_fuse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token triple-quoted-string string">"""Applies a fused convolution and activation function to the input tensor `x`."""</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>act<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>Conv 组件不是纯粹的卷积，它是由以卷积为核心的一组操作构成的，源码中说到：对神经网络中的输入张量应用卷积、批处理归一化和激活函数。</p>
<p>其中： <code>self.act = self.default_act if act is True else act if isinstance(act, nn.Module) else nn.Identity()</code>  这一段非常值得我们学习，如果 <code>act=True</code>  则使用 <code>default_act</code> ，否则就要判断传过来的 <code>act</code>  是否是 <code>nn.Module</code> ( <code>isinstance(act, nn.Module)</code> )，是的话就用新传过来的，否则则使用 <code>nn.Identity()</code>  直接原样输出。</p>
<img data-src="../../../images/python/YOLO/v5/1.png" alt="1" style="zoom: 100%;" />
<h3 id="c3"><a class="markdownIt-Anchor" href="#c3">#</a> C3</h3>
<p>YOLOv5s 可以支持各种 C3 变体，但官方默认配置只用基础 C3，C3 是一个系列，其中有 C3x、C3TR、C3SPP、C3Ghost，他们都继承 C3</p>
<ol>
<li><code>C3</code>  - 基础 CSP 瓶颈模块</li>
<li><code>C3x</code>  - 使用 CrossConv 交叉卷积的 C3 变体</li>
<li><code>C3TR</code>  - 使用 TransformerBlock 的 C3 变体</li>
<li><code>C3SPP</code>  - 使用 SPP 空间金字塔池化的 C3 变体</li>
<li><code>C3Ghost</code>  - 使用 GhostBottleneck 幽灵残差的 C3 变体</li>
</ol>
<p>YOLOv5s 中使用的是基础的 <code>C3</code>  模块，让我们先来看看 C3：</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">C3</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token triple-quoted-string string">"""Implements a CSP Bottleneck module with three convolutions for enhanced feature extraction in neural networks."""</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> n<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> shortcut<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> g<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> e<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token triple-quoted-string string">"""Initializes C3 module with options for channel count, bottleneck repetition, shortcut usage, group</pre></td></tr><tr><td data-num="6"></td><td><pre>        convolutions, and expansion.</pre></td></tr><tr><td data-num="7"></td><td><pre>        """</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        c_ <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>c2 <span class="token operator">*</span> e<span class="token punctuation">)</span>  <span class="token comment"># hidden channels</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        self<span class="token punctuation">.</span>cv1 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        self<span class="token punctuation">.</span>cv2 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        self<span class="token punctuation">.</span>cv3 <span class="token operator">=</span> Conv<span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> c_<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># optional act=FReLU(c2)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        self<span class="token punctuation">.</span>m <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>Bottleneck<span class="token punctuation">(</span>c_<span class="token punctuation">,</span> c_<span class="token punctuation">,</span> shortcut<span class="token punctuation">,</span> g<span class="token punctuation">,</span> e<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token triple-quoted-string string">"""Performs forward propagation using concatenated outputs from two convolutions and a Bottleneck sequence."""</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>cv3<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>m<span class="token punctuation">(</span>self<span class="token punctuation">.</span>cv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>cv2<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr></table></figure><img data-src="../../../images/python/YOLO/v5/3.png" alt="1" style="zoom: 100%;" />
<p>C3 见名知意，是一个以三个卷积为核心的特征提取块在向前传播中依赖了 <code>Bottleneck</code> ，其中 <code>nn.Sequential(*(Bottleneck(c_, c_, shortcut, g, e=1.0) for _ in range(n)))</code>  是一个语法糖，让我们一步步拆解，在外层的 <code>nn.Sequential()</code>  是一个序列组装，先不看，内层的 <code>*(xxx)</code>  意为由多个 <code>xxx</code>  组成，但到底由多少个 <code>xxx</code>  组成取决于内层 <code>Bottleneck(c_, c_, shortcut, g, e=1.0) for _ in range(n)</code>  中 <code>n</code>  的大小决定。说了这么多， <code>Bottleneck</code>  是啥？</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Bottleneck</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token triple-quoted-string string">"""A bottleneck layer with optional shortcut and group convolution for efficient feature extraction."""</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> shortcut<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> g<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> e<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token triple-quoted-string string">"""Initializes a standard bottleneck layer with optional shortcut and group convolution, supporting channel expansion.</pre></td></tr><tr><td data-num="6"></td><td><pre>        """</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        c_ <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>c2 <span class="token operator">*</span> e<span class="token punctuation">)</span>  <span class="token comment"># hidden channels</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        self<span class="token punctuation">.</span>cv1 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        self<span class="token punctuation">.</span>cv2 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c_<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> g<span class="token operator">=</span>g<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        self<span class="token punctuation">.</span>add <span class="token operator">=</span> shortcut <span class="token keyword">and</span> c1 <span class="token operator">==</span> c2</pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token triple-quoted-string string">"""Processes input through two convolutions, optionally adds shortcut if channel dimensions match; input is a tensor.</pre></td></tr><tr><td data-num="15"></td><td><pre>        """</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">return</span> x <span class="token operator">+</span> self<span class="token punctuation">.</span>cv2<span class="token punctuation">(</span>self<span class="token punctuation">.</span>cv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>add <span class="token keyword">else</span> self<span class="token punctuation">.</span>cv2<span class="token punctuation">(</span>self<span class="token punctuation">.</span>cv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>观察 <code>return x + self.cv2(self.cv1(x)) if self.add else self.cv2(self.cv1(x))</code>  显然这是一个残差模块，通过 <code>add</code>  控制开启与关闭。一般来说前后不改变通道数， <code>c_</code> 是前后通道数的一半。</p>
<img data-src="../../../images/python/YOLO/v5/2.png" alt="1" style="zoom: 100%;" />
<p>下面还有一个 Bottleneck，我称之为 Bottleneck-F，这是不启用残差链接的 Bottleneck。</p>
<img data-src="../../../images/python/YOLO/v5/5.png" alt="1" style="zoom: 100%;" />
<p>那自然有 C3-F-X</p>
<img data-src="../../../images/python/YOLO/v5/6.png" alt="1" style="zoom: 100%;" />
<h3 id="sppf"><a class="markdownIt-Anchor" href="#sppf">#</a> SPPF</h3>
<p>SPPF 通过复用中间结果，把 3 次独立池化变成了 3 次串联池化，计算量从 O (3k²) 降为 O (k²)，速度快了 2-3 倍，效果几乎不变。</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">SPPF</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token triple-quoted-string string">"""Implements a fast Spatial Pyramid Pooling (SPPF) layer for efficient feature extraction in YOLOv5 models."""</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token triple-quoted-string string">"""Initializes YOLOv5 SPPF layer with given channels and kernel size for YOLOv5 model, combining convolution and</pre></td></tr><tr><td data-num="6"></td><td><pre>        max pooling.</pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>        Equivalent to SPP(k=(5, 9, 13)).</pre></td></tr><tr><td data-num="9"></td><td><pre>        """</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        c_ <span class="token operator">=</span> c1 <span class="token operator">//</span> <span class="token number">2</span>  <span class="token comment"># hidden channels</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        self<span class="token punctuation">.</span>cv1 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        self<span class="token punctuation">.</span>cv2 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c_ <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> c2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        self<span class="token punctuation">.</span>m <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span>k<span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span>k <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token triple-quoted-string string">"""Processes input through a series of convolutions and max pooling operations for feature extraction."""</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        x <span class="token operator">=</span> self<span class="token punctuation">.</span>cv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">with</span> warnings<span class="token punctuation">.</span>catch_warnings<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            warnings<span class="token punctuation">.</span>simplefilter<span class="token punctuation">(</span><span class="token string">"ignore"</span><span class="token punctuation">)</span>  <span class="token comment"># suppress torch 1.9.0 max_pool2d() warning</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            y1 <span class="token operator">=</span> self<span class="token punctuation">.</span>m<span class="token punctuation">(</span>x<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            y2 <span class="token operator">=</span> self<span class="token punctuation">.</span>m<span class="token punctuation">(</span>y1<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token keyword">return</span> self<span class="token punctuation">.</span>cv2<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> self<span class="token punctuation">.</span>m<span class="token punctuation">(</span>y2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr></table></figure><img data-src="../../../images/python/YOLO/v5/4.png" alt="1" style="zoom: 100%;" />
<p>这个 <code>cv1</code>  和 <code>cv2</code>  中的 k 与 s 全是 1，完全不改变特征图大小，只改变通道数。通道拼接这里接受了四部分的输入，所以 <code>self.cv2 = Conv(c_ * 4, c2, 1, 1)</code>  中写道： <code>c_ * 4</code> ，其中 <code>c_</code> 是第一个 CBS 的输出通道数。</p>
<h3 id="focusfocus为什么被弃用"><a class="markdownIt-Anchor" href="#focusfocus为什么被弃用">#</a> Focus——Focus 为什么被弃用？</h3>
<p>YOLOv5 v6.0 版本（2021 年 10 月）是一个分水岭：Focus 的切片操作虽然减少了参数量，但在 GPU/TPU 上不友好。取而代之的是 6x6 卷积。</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>from  n    params  module                  arguments           </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">0</span>    <span class="token parameter variable">-1</span>    <span class="token number">1</span>    <span class="token number">3520</span>  	models.common.Conv      <span class="token punctuation">[</span><span class="token number">3</span>, <span class="token number">32</span>, <span class="token number">6</span>, <span class="token number">2</span>, <span class="token number">2</span><span class="token punctuation">]</span></pre></td></tr></table></figure><p><code>[3, 32, 6, 2, 2]</code>  输入 RGB 彩色图像，3 通道，第一层输出 32 个特征图，其中是<strong> 6×6</strong> 的卷积核，每次移动 2 像素，<strong>特征图尺寸减半</strong>，四周补 2 圈 0，保持尺寸计算正确。假如输入 <code>640×640×3</code> ，输出是 <code>320×320×32</code> ，因为步长 2，尺寸减半。</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Focus</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token triple-quoted-string string">"""Focuses spatial information into channel space using slicing and convolution for efficient feature extraction."""</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> g<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> act<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token triple-quoted-string string">"""Initializes Focus module to concentrate width-height info into channel space with configurable convolution</pre></td></tr><tr><td data-num="6"></td><td><pre>        parameters.</pre></td></tr><tr><td data-num="7"></td><td><pre>        """</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        self<span class="token punctuation">.</span>conv <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c1 <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> c2<span class="token punctuation">,</span> k<span class="token punctuation">,</span> s<span class="token punctuation">,</span> p<span class="token punctuation">,</span> g<span class="token punctuation">,</span> act<span class="token operator">=</span>act<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token comment"># self.contract = Contract(gain=2)</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token triple-quoted-string string">"""Processes input through Focus mechanism, reshaping (b,c,w,h) to (b,4c,w/2,h/2) then applies convolution."""</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>conv<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token comment"># return self.conv(self.contract(x))</span></pre></td></tr></table></figure><h3 id="upsample"><a class="markdownIt-Anchor" href="#upsample">#</a> Upsample</h3>
<p>Upsample 使用的是 <code>nn.Upsample(scale_factor=2, mode=&quot;nearest&quot;)</code> ，这个没什么好说的。</p>
<h3 id="concat"><a class="markdownIt-Anchor" href="#concat">#</a> Concat</h3>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Concat</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token triple-quoted-string string">"""Concatenates tensors along a specified dimension for efficient tensor manipulation in neural networks."""</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> dimension<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token triple-quoted-string string">"""Initializes a Concat module to concatenate tensors along a specified dimension."""</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        self<span class="token punctuation">.</span>d <span class="token operator">=</span> dimension</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token triple-quoted-string string">"""Concatenates a list of tensors along a specified dims; `x` is a list of tensors, `dimension` is an int."""</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">return</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>x<span class="token punctuation">,</span> self<span class="token punctuation">.</span>d<span class="token punctuation">)</span></pre></td></tr></table></figure><p>Concat 的注释很清晰，它将一组张量列表串接到指定的 dim 上；“x” 是张量列表，“维度” 是整数。</p>
<h3 id="detect"><a class="markdownIt-Anchor" href="#detect">#</a> Detect</h3>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Detect</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token triple-quoted-string string">"""YOLOv5 Detect head for processing input tensors and generating detection outputs in object detection models."""</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    stride <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># strides computed during build</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    dynamic <span class="token operator">=</span> <span class="token boolean">False</span>  <span class="token comment"># force grid reconstruction</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    export <span class="token operator">=</span> <span class="token boolean">False</span>  <span class="token comment"># export mode</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> nc<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">,</span> anchors<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ch<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token triple-quoted-string string">"""Initializes YOLOv5 detection layer with specified classes, anchors, channels, and inplace operations."""</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        self<span class="token punctuation">.</span>nc <span class="token operator">=</span> nc  <span class="token comment"># number of classes</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        self<span class="token punctuation">.</span>no <span class="token operator">=</span> nc <span class="token operator">+</span> <span class="token number">5</span>  <span class="token comment"># number of outputs per anchor</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        self<span class="token punctuation">.</span>nl <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>anchors<span class="token punctuation">)</span>  <span class="token comment"># number of detection layers</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        self<span class="token punctuation">.</span>na <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>anchors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span>  <span class="token comment"># number of anchors</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        self<span class="token punctuation">.</span>grid <span class="token operator">=</span> <span class="token punctuation">[</span>torch<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>nl<span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># init grid</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        self<span class="token punctuation">.</span>anchor_grid <span class="token operator">=</span> <span class="token punctuation">[</span>torch<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>nl<span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># init anchor grid</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        self<span class="token punctuation">.</span>register_buffer<span class="token punctuation">(</span><span class="token string">"anchors"</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>anchors<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>self<span class="token punctuation">.</span>nl<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># shape(nl,na,2)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        self<span class="token punctuation">.</span>m <span class="token operator">=</span> nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>x<span class="token punctuation">,</span> self<span class="token punctuation">.</span>no <span class="token operator">*</span> self<span class="token punctuation">.</span>na<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> ch<span class="token punctuation">)</span>  <span class="token comment"># output conv</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        self<span class="token punctuation">.</span>inplace <span class="token operator">=</span> inplace  <span class="token comment"># use inplace ops (e.g. slice assignment)</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token triple-quoted-string string">"""Processes input through YOLOv5 layers, altering shape for detection: `x(bs, 3, ny, nx, 85)`."""</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        z <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># inference output</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>nl<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>m<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># conv</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            bs<span class="token punctuation">,</span> _<span class="token punctuation">,</span> ny<span class="token punctuation">,</span> nx <span class="token operator">=</span> x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>shape  <span class="token comment"># x(bs,255,20,20) to x(bs,3,20,20,85)</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>bs<span class="token punctuation">,</span> self<span class="token punctuation">.</span>na<span class="token punctuation">,</span> self<span class="token punctuation">.</span>no<span class="token punctuation">,</span> ny<span class="token punctuation">,</span> nx<span class="token punctuation">)</span><span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>training<span class="token punctuation">:</span>  <span class="token comment"># inference</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                <span class="token keyword">if</span> self<span class="token punctuation">.</span>dynamic <span class="token keyword">or</span> self<span class="token punctuation">.</span>grid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">!=</span> x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                    self<span class="token punctuation">.</span>grid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>anchor_grid<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>_make_grid<span class="token punctuation">(</span>nx<span class="token punctuation">,</span> ny<span class="token punctuation">,</span> i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>                <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> Segment<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># (boxes + masks)</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                    xy<span class="token punctuation">,</span> wh<span class="token punctuation">,</span> conf<span class="token punctuation">,</span> mask <span class="token operator">=</span> x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>nc <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>no <span class="token operator">-</span> self<span class="token punctuation">.</span>nc <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                    xy <span class="token operator">=</span> <span class="token punctuation">(</span>xy<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>grid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token comment"># xy</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                    wh <span class="token operator">=</span> <span class="token punctuation">(</span>wh<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>anchor_grid<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token comment"># wh</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                    y <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>xy<span class="token punctuation">,</span> wh<span class="token punctuation">,</span> conf<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># Detect (boxes only)</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                    xy<span class="token punctuation">,</span> wh<span class="token punctuation">,</span> conf <span class="token operator">=</span> x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>nc <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                    xy <span class="token operator">=</span> <span class="token punctuation">(</span>xy <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>grid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token comment"># xy</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                    wh <span class="token operator">=</span> <span class="token punctuation">(</span>wh <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>anchor_grid<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token comment"># wh</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                    y <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>xy<span class="token punctuation">,</span> wh<span class="token punctuation">,</span> conf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                z<span class="token punctuation">.</span>append<span class="token punctuation">(</span>y<span class="token punctuation">.</span>view<span class="token punctuation">(</span>bs<span class="token punctuation">,</span> self<span class="token punctuation">.</span>na <span class="token operator">*</span> nx <span class="token operator">*</span> ny<span class="token punctuation">,</span> self<span class="token punctuation">.</span>no<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token keyword">return</span> x <span class="token keyword">if</span> self<span class="token punctuation">.</span>training <span class="token keyword">else</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>z<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>export <span class="token keyword">else</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>z<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">_make_grid</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> nx<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> ny<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> torch_1_10<span class="token operator">=</span>check_version<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>__version__<span class="token punctuation">,</span> <span class="token string">"1.10.0"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token triple-quoted-string string">"""Generates a mesh grid for anchor boxes with optional compatibility for torch versions &lt; 1.10."""</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        d <span class="token operator">=</span> self<span class="token punctuation">.</span>anchors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>device</pre></td></tr><tr><td data-num="50"></td><td><pre>        t <span class="token operator">=</span> self<span class="token punctuation">.</span>anchors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>dtype</pre></td></tr><tr><td data-num="51"></td><td><pre>        shape <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>na<span class="token punctuation">,</span> ny<span class="token punctuation">,</span> nx<span class="token punctuation">,</span> <span class="token number">2</span>  <span class="token comment"># grid shape</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        y<span class="token punctuation">,</span> x <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>ny<span class="token punctuation">,</span> device<span class="token operator">=</span>d<span class="token punctuation">,</span> dtype<span class="token operator">=</span>t<span class="token punctuation">)</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>nx<span class="token punctuation">,</span> device<span class="token operator">=</span>d<span class="token punctuation">,</span> dtype<span class="token operator">=</span>t<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        yv<span class="token punctuation">,</span> xv <span class="token operator">=</span> torch<span class="token punctuation">.</span>meshgrid<span class="token punctuation">(</span>y<span class="token punctuation">,</span> x<span class="token punctuation">,</span> indexing<span class="token operator">=</span><span class="token string">"ij"</span><span class="token punctuation">)</span> <span class="token keyword">if</span> torch_1_10 <span class="token keyword">else</span> torch<span class="token punctuation">.</span>meshgrid<span class="token punctuation">(</span>y<span class="token punctuation">,</span> x<span class="token punctuation">)</span>  <span class="token comment"># torch>=0.7 compatibility</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        grid <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">(</span>xv<span class="token punctuation">,</span> yv<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>expand<span class="token punctuation">(</span>shape<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0.5</span>  <span class="token comment"># add grid offset, i.e. y = 2.0 * x - 0.5</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        anchor_grid <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>anchors<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>na<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>expand<span class="token punctuation">(</span>shape<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token keyword">return</span> grid<span class="token punctuation">,</span> anchor_grid</pre></td></tr></table></figure><p>这段代码是负责目标检测的，核心在于看懂 <code>forward</code>  函数：</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token triple-quoted-string string">"""Processes input through YOLOv5 layers, altering shape for detection: `x(bs, 3, ny, nx, 85)`."""</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    z <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># inference output</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>nl<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>m<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># conv</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        bs<span class="token punctuation">,</span> _<span class="token punctuation">,</span> ny<span class="token punctuation">,</span> nx <span class="token operator">=</span> x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>shape  <span class="token comment"># x(bs,255,20,20) to x(bs,3,20,20,85)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>bs<span class="token punctuation">,</span> self<span class="token punctuation">.</span>na<span class="token punctuation">,</span> self<span class="token punctuation">.</span>no<span class="token punctuation">,</span> ny<span class="token punctuation">,</span> nx<span class="token punctuation">)</span><span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>training<span class="token punctuation">:</span>  <span class="token comment"># inference</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token keyword">if</span> self<span class="token punctuation">.</span>dynamic <span class="token keyword">or</span> self<span class="token punctuation">.</span>grid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">!=</span> x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                self<span class="token punctuation">.</span>grid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>anchor_grid<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>_make_grid<span class="token punctuation">(</span>nx<span class="token punctuation">,</span> ny<span class="token punctuation">,</span> i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> Segment<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># (boxes + masks)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                xy<span class="token punctuation">,</span> wh<span class="token punctuation">,</span> conf<span class="token punctuation">,</span> mask <span class="token operator">=</span> x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>nc <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>no <span class="token operator">-</span> self<span class="token punctuation">.</span>nc <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                xy <span class="token operator">=</span> <span class="token punctuation">(</span>xy<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>grid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token comment"># xy</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                wh <span class="token operator">=</span> <span class="token punctuation">(</span>wh<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>anchor_grid<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token comment"># wh</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                y <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>xy<span class="token punctuation">,</span> wh<span class="token punctuation">,</span> conf<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># Detect (boxes only)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                xy<span class="token punctuation">,</span> wh<span class="token punctuation">,</span> conf <span class="token operator">=</span> x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>nc <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                xy <span class="token operator">=</span> <span class="token punctuation">(</span>xy <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>grid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token comment"># xy</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                wh <span class="token operator">=</span> <span class="token punctuation">(</span>wh <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>anchor_grid<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token comment"># wh</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                y <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>xy<span class="token punctuation">,</span> wh<span class="token punctuation">,</span> conf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            z<span class="token punctuation">.</span>append<span class="token punctuation">(</span>y<span class="token punctuation">.</span>view<span class="token punctuation">(</span>bs<span class="token punctuation">,</span> self<span class="token punctuation">.</span>na <span class="token operator">*</span> nx <span class="token operator">*</span> ny<span class="token punctuation">,</span> self<span class="token punctuation">.</span>no<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">return</span> x <span class="token keyword">if</span> self<span class="token punctuation">.</span>training <span class="token keyword">else</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>z<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>export <span class="token keyword">else</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>z<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span></pre></td></tr></table></figure><p>x (bs, 3, ny, nx, 85)，85: 每个 anchor 的预测值，nx: 特征图宽度方向网格数，ny: 特征图高度方向网格数，3: 每个网格点的 anchor 数量， bs: batch size。</p>
<p>85 维向量 = [tx, ty, tw, th,     	obj_conf, 	cls1, cls2, …, cls80]<br>
├──4 坐标──┤   ├─1 置信─┤  ├──80 类别概率──┤</p>
<p>self.nl 是 anchors 的数量，向前传播首先进入： <code>for i in range(self.nl):</code> ，3 个检测分支通过 1 个 for 循环并行处理。</p>
<p>Detect 初始化时： <code>def __init__(self, nc=80, anchors=(), ch=(), inplace=True)</code> ，查看日志可以看到 <code>[80, [[10, 13, 16, 30, 33, 23], [30, 61, 62, 45, 59, 119], [116, 90, 156, 198, 373, 326]], [128, 256, 512]]</code> ，80 分类，三组检测框，对应三个上游通道数 <code>[128, 256, 512]</code> 。<strong>这是 3 组锚框，每组 3 个，一共 9 个锚框，分别对应 P3、P4、P5 三个检测层</strong></p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre>self<span class="token punctuation">.</span>na <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>anchors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span></pre></td></tr></table></figure><p>anchors 的存储格式是  <code>[w1, h1, w2, h2, w3, h3]</code> ，每两个数字组成一个 anchor。所以我们知道， <code>for i in range(self.nl)</code>  是为三个检测头准备的。</p>
<p>继续向下执行，这两行代码是 YOLOv5 检测头的变形魔法：</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre>bs<span class="token punctuation">,</span> _<span class="token punctuation">,</span> ny<span class="token punctuation">,</span> nx <span class="token operator">=</span> x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>shape  <span class="token comment"># x(bs,255,20,20) to x(bs,3,20,20,85)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>bs<span class="token punctuation">,</span> self<span class="token punctuation">.</span>na<span class="token punctuation">,</span> self<span class="token punctuation">.</span>no<span class="token punctuation">,</span> ny<span class="token punctuation">,</span> nx<span class="token punctuation">)</span><span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>原始：(1, 255, 20, 20)  batch=1, 通道 = 255, 高 = 20, 宽 = 20</p>
<p>view 重塑：</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>.view<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">3</span>, <span class="token number">85</span>, <span class="token number">20</span>, <span class="token number">20</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    │  │  │   │   │</pre></td></tr><tr><td data-num="3"></td><td><pre>    │  │  │   │   └── 宽度网格数 <span class="token punctuation">(</span>nx<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    │  │  │   └────── 高度网格数 <span class="token punctuation">(</span>ny<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    │  │  └────────── 每个anchor的预测值 <span class="token punctuation">(</span>no<span class="token operator">=</span><span class="token number">85</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    │  └───────────── 每个网格的anchor数 <span class="token punctuation">(</span>na<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    └──────────────── batch size <span class="token punctuation">(</span>bs<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token number">255</span> <span class="token operator">=</span> <span class="token number">3</span>×85</pre></td></tr></table></figure><p>permute 调整位置：</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>.permute<span class="token punctuation">(</span><span class="token number">0</span>, <span class="token number">1</span>, <span class="token number">3</span>, <span class="token number">4</span>, <span class="token number">2</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">3</span>, <span class="token number">20</span>, <span class="token number">20</span>, <span class="token number">85</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  ─┬─ ─┬─ ─┬─ ─┬─ ─┬─</pre></td></tr><tr><td data-num="4"></td><td><pre>   │   │   │   │   └── 检测值 <span class="token punctuation">(</span>坐标+置信度+类别<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   │   │   │   └────── 宽度网格 <span class="token punctuation">(</span>nx<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   │   │   └────────── 高度网格 <span class="token punctuation">(</span>ny<span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre>   │   └────────────── anchor索引 <span class="token punctuation">(</span>na<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   └────────────────── batch <span class="token punctuation">(</span>bs<span class="token punctuation">)</span></pre></td></tr></table></figure><p>contiguous 保证内存连续。</p>
<p>为了方便观察输出，可以打印一下：print (x [i].shape, “这是：”, i)</p>
<blockquote>
<p>torch.Size ([1, 255, 80, 80]) 这是： 0<br>
torch.Size ([1, 255, 40, 40]) 这是： 1<br>
torch.Size ([1, 255, 20, 20]) 这是： 2</p>
</blockquote>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">return</span> x <span class="token keyword">if</span> self<span class="token punctuation">.</span>training <span class="token keyword">else</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>z<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>export <span class="token keyword">else</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>z<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span></pre></td></tr></table></figure><p>训练时： <code>return x </code> ，直接去算 Loss。</p>
<p>推理时： <code>return (torch.cat(z, 1), x)</code> ，返回检测结果 + 特征图</p>
<p>这个 z 从哪里来？这里写道 <code>if not self.training</code> …</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>training<span class="token punctuation">:</span>  <span class="token comment"># inference</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">if</span> self<span class="token punctuation">.</span>dynamic <span class="token keyword">or</span> self<span class="token punctuation">.</span>grid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">!=</span> x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        self<span class="token punctuation">.</span>grid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>anchor_grid<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>_make_grid<span class="token punctuation">(</span>nx<span class="token punctuation">,</span> ny<span class="token punctuation">,</span> i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> Segment<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># (boxes + masks)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        xy<span class="token punctuation">,</span> wh<span class="token punctuation">,</span> conf<span class="token punctuation">,</span> mask <span class="token operator">=</span> x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>nc <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>no <span class="token operator">-</span> self<span class="token punctuation">.</span>nc <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        xy <span class="token operator">=</span> <span class="token punctuation">(</span>xy<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>grid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token comment"># xy</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        wh <span class="token operator">=</span> <span class="token punctuation">(</span>wh<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>anchor_grid<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token comment"># wh</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        y <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>xy<span class="token punctuation">,</span> wh<span class="token punctuation">,</span> conf<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># Detect (boxes only)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        xy<span class="token punctuation">,</span> wh<span class="token punctuation">,</span> conf <span class="token operator">=</span> x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>nc <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        xy <span class="token operator">=</span> <span class="token punctuation">(</span>xy <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>grid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token comment"># xy</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        wh <span class="token operator">=</span> <span class="token punctuation">(</span>wh <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>anchor_grid<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token comment"># wh</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        y <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>xy<span class="token punctuation">,</span> wh<span class="token punctuation">,</span> conf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    z<span class="token punctuation">.</span>append<span class="token punctuation">(</span>y<span class="token punctuation">.</span>view<span class="token punctuation">(</span>bs<span class="token punctuation">,</span> self<span class="token punctuation">.</span>na <span class="token operator">*</span> nx <span class="token operator">*</span> ny<span class="token punctuation">,</span> self<span class="token punctuation">.</span>no<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>推理时反向计算预测框。</p>
<h3 id="先提一下parse_model"><a class="markdownIt-Anchor" href="#先提一下parse_model">#</a> 先提一下 parse_model</h3>
<p>在 yaml 中， <code>[-1, 3, C3, [128]],</code>  只给了一个参数 128，而我我们前面说到的 C3 至少需要两个，parse_model 回答我们：</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre>c1<span class="token punctuation">,</span> c2 <span class="token operator">=</span> ch<span class="token punctuation">[</span>f<span class="token punctuation">]</span><span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">if</span> c2 <span class="token operator">!=</span> no<span class="token punctuation">:</span>  <span class="token comment"># if not output</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    c2 <span class="token operator">=</span> make_divisible<span class="token punctuation">(</span>c2 <span class="token operator">*</span> gw<span class="token punctuation">,</span> ch_mul<span class="token punctuation">)</span></pre></td></tr></table></figure><p>c2 来自 yaml，c1 从上一层自动获取：</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> n<span class="token punctuation">,</span> m<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>d<span class="token punctuation">[</span><span class="token string">"backbone"</span><span class="token punctuation">]</span> <span class="token operator">+</span> d<span class="token punctuation">[</span><span class="token string">"head"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># from, number, module, args</span></pre></td></tr></table></figure><h2 id="激动人心的时刻组装"><a class="markdownIt-Anchor" href="#激动人心的时刻组装">#</a> 激动人心的时刻 —— 组装</h2>
<p>这就是 YOLOv5s 的构成：</p>
<img data-src="../../../images/python/YOLO/v5/7.png" alt="1" style="zoom: 100%;" />
<h2 id="auto-anchor-自适应锚框计算"><a class="markdownIt-Anchor" href="#auto-anchor-自适应锚框计算">#</a> Auto-Anchor 自适应锚框计算</h2>
<p>YOLOv5 的自适应锚框计算主要写在  <code>utils/autoanchor.py</code>  文件里：</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token decorator annotation punctuation">@TryExcept</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>PREFIX<span class="token punctuation">&#125;</span></span><span class="token string">ERROR"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">def</span> <span class="token function">check_anchors</span><span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> model<span class="token punctuation">,</span> thr<span class="token operator">=</span><span class="token number">4.0</span><span class="token punctuation">,</span> imgsz<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token triple-quoted-string string">"""Evaluates anchor fit to dataset and adjusts if necessary, supporting customizable threshold and image size."""</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    m <span class="token operator">=</span> model<span class="token punctuation">.</span>module<span class="token punctuation">.</span>model<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> <span class="token string">"module"</span><span class="token punctuation">)</span> <span class="token keyword">else</span> model<span class="token punctuation">.</span>model<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># Detect()</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    shapes <span class="token operator">=</span> imgsz <span class="token operator">*</span> dataset<span class="token punctuation">.</span>shapes <span class="token operator">/</span> dataset<span class="token punctuation">.</span>shapes<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> keepdims<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    scale <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0.9</span><span class="token punctuation">,</span> <span class="token number">1.1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token punctuation">(</span>shapes<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># augment scale</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    wh <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>l<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">*</span> s <span class="token keyword">for</span> s<span class="token punctuation">,</span> l <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>shapes <span class="token operator">*</span> scale<span class="token punctuation">,</span> dataset<span class="token punctuation">.</span>labels<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># wh</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">metric</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># compute metric</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token triple-quoted-string string">"""Computes ratio metric, anchors above threshold, and best possible recall for YOLOv5 anchor evaluation."""</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        r <span class="token operator">=</span> wh<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">/</span> k<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        x <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">/</span> r<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># ratio metric</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        best <span class="token operator">=</span> x<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># best_x</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        aat <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">/</span> thr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># anchors above threshold</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        bpr <span class="token operator">=</span> <span class="token punctuation">(</span>best <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">/</span> thr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># best possible recall</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">return</span> bpr<span class="token punctuation">,</span> aat</pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    stride <span class="token operator">=</span> m<span class="token punctuation">.</span>stride<span class="token punctuation">.</span>to<span class="token punctuation">(</span>m<span class="token punctuation">.</span>anchors<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># model strides</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    anchors <span class="token operator">=</span> m<span class="token punctuation">.</span>anchors<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> stride  <span class="token comment"># current anchors</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    bpr<span class="token punctuation">,</span> aat <span class="token operator">=</span> metric<span class="token punctuation">(</span>anchors<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    s <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"\n</span><span class="token interpolation"><span class="token punctuation">&#123;</span>PREFIX<span class="token punctuation">&#125;</span></span><span class="token interpolation"><span class="token punctuation">&#123;</span>aat<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">&#125;</span></span><span class="token string"> anchors/target, </span><span class="token interpolation"><span class="token punctuation">&#123;</span>bpr<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">&#125;</span></span><span class="token string"> Best Possible Recall (BPR). "</span></span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">if</span> bpr <span class="token operator">></span> <span class="token number">0.98</span><span class="token punctuation">:</span>  <span class="token comment"># threshold to recompute</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>s<span class="token punctuation">&#125;</span></span><span class="token string">Current anchors are a good fit to dataset ✅"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>s<span class="token punctuation">&#125;</span></span><span class="token string">Anchors are a poor fit to dataset ⚠️, attempting to improve..."</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        na <span class="token operator">=</span> m<span class="token punctuation">.</span>anchors<span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span>  <span class="token comment"># number of anchors</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        anchors <span class="token operator">=</span> kmean_anchors<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> n<span class="token operator">=</span>na<span class="token punctuation">,</span> img_size<span class="token operator">=</span>imgsz<span class="token punctuation">,</span> thr<span class="token operator">=</span>thr<span class="token punctuation">,</span> gen<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        new_bpr <span class="token operator">=</span> metric<span class="token punctuation">(</span>anchors<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">if</span> new_bpr <span class="token operator">></span> bpr<span class="token punctuation">:</span>  <span class="token comment"># replace anchors</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            anchors <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>anchors<span class="token punctuation">,</span> device<span class="token operator">=</span>m<span class="token punctuation">.</span>anchors<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span>type_as<span class="token punctuation">(</span>m<span class="token punctuation">.</span>anchors<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            m<span class="token punctuation">.</span>anchors<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> anchors<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view_as<span class="token punctuation">(</span>m<span class="token punctuation">.</span>anchors<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            check_anchor_order<span class="token punctuation">(</span>m<span class="token punctuation">)</span>  <span class="token comment"># must be in pixel-space (not grid-space)</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            m<span class="token punctuation">.</span>anchors <span class="token operator">/=</span> stride</pre></td></tr><tr><td data-num="34"></td><td><pre>            s <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>PREFIX<span class="token punctuation">&#125;</span></span><span class="token string">Done ✅ (optional: update model *.yaml to use these anchors in the future)"</span></span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            s <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>PREFIX<span class="token punctuation">&#125;</span></span><span class="token string">Done ⚠️ (original anchors better than new anchors, proceeding with original anchors)"</span></span></pre></td></tr><tr><td data-num="37"></td><td><pre>        LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span>s<span class="token punctuation">)</span></pre></td></tr></table></figure><p>这个可以称之为拉起函数，在训练开始时，这个函数会登场。它使用一个关键指标 <strong>BPR 最佳可能召回率</strong> 来评估当前锚框的好坏。BPR 衡量的是数据集中有多少真实框能很好地匹配预设的锚框。如果 BPR <strong>大于等于 0.98</strong>，说明锚框已经够用了，流程结束。如果 BPR <strong>小于 0.98</strong>，说明锚框不太合适，代码就会自动启动锚框优化流程。</p>
<p>这个自适应功能是可选的。在训练脚本  <code>train.py</code>  中，有一个参数叫  <code>--noautoanchor</code> 。默认情况下它是  <code>False</code> ，意味着自适应锚框功能是<strong>开启</strong>的。如果你想使用自己预设的锚框，不让程序自动调整，可以在训练命令中加上  <code>--noautoanchor</code>  来<strong>关闭</strong>它。</p>
<h2 id="loss损失函数"><a class="markdownIt-Anchor" href="#loss损失函数">#</a> Loss 损失函数</h2>
<p>YOLOv5 的损失函数计算主要写在  <code>utils/loss.py</code>  文件里。</p>
<p><code>ComputeLoss</code>  是拉起类，它协调了 YOLOv5 的三大损失：边界框损失 <code>lbox</code> 、置信度损失 <code>lobj</code>  和分类损失 <code>lcls</code> 。</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre>lcls <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> device<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>  <span class="token comment"># 分类损失</span></pre></td></tr><tr><td data-num="2"></td><td><pre>lbox <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> device<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>  <span class="token comment"># 边界框损失  </span></pre></td></tr><tr><td data-num="3"></td><td><pre>lobj <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> device<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>  <span class="token comment"># 置信度损失</span></pre></td></tr></table></figure><p>然后：</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre>tcls<span class="token punctuation">,</span> tbox<span class="token punctuation">,</span> indices<span class="token punctuation">,</span> anchors <span class="token operator">=</span> self<span class="token punctuation">.</span>build_targets<span class="token punctuation">(</span>p<span class="token punctuation">,</span> targets<span class="token punctuation">)</span></pre></td></tr></table></figure><p>这段为每个真实目标找到最匹配的 anchor，确定目标落在哪个网格，返回匹配到的正样本信息。紧接着，逐层计算损失:</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">for</span> i<span class="token punctuation">,</span> pi <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 遍历 3 个检测层</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi <span class="token operator">=</span> indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token comment"># 当前层的正样本索引</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    tobj <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>pi<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>  <span class="token comment"># 初始化置信度目标张量</span></pre></td></tr></table></figure><h3 id="正样本损失计算"><a class="markdownIt-Anchor" href="#正样本损失计算">#</a> 正样本损失计算</h3>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">if</span> n <span class="token operator">:=</span> b<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>  <span class="token comment"># 如果这一层有正样本</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment"># 提取正样本位置的预测值</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    pxy<span class="token punctuation">,</span> pwh<span class="token punctuation">,</span> _<span class="token punctuation">,</span> pcls <span class="token operator">=</span> pi<span class="token punctuation">[</span>b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi<span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>nc<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    </pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment"># 解码预测坐标</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    pxy <span class="token operator">=</span> pxy<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">0.5</span>        <span class="token comment"># 中心点偏移</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    pwh <span class="token operator">=</span> <span class="token punctuation">(</span>pwh<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">*</span> anchors<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token comment"># 宽高</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    pbox <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>pxy<span class="token punctuation">,</span> pwh<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>      <span class="token comment"># 组合成预测框</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    </pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment"># 计算 CIoU 损失</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    iou <span class="token operator">=</span> bbox_iou<span class="token punctuation">(</span>pbox<span class="token punctuation">,</span> tbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> CIoU<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    lbox <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> iou<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># IoU 损失 = 1 - IoU</span></pre></td></tr></table></figure><h3 id="设置置信度目标值"><a class="markdownIt-Anchor" href="#设置置信度目标值">#</a> 设置置信度目标值</h3>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 使用 CIoU 作为置信度目标</span></pre></td></tr><tr><td data-num="2"></td><td><pre>iou <span class="token operator">=</span> iou<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clamp<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>tobj<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>tobj<span class="token punctuation">[</span>b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi<span class="token punctuation">]</span> <span class="token operator">=</span> iou  <span class="token comment"># 正样本位置填上 IoU 值</span></pre></td></tr></table></figure><h3 id="分类损失计算"><a class="markdownIt-Anchor" href="#分类损失计算">#</a> 分类损失计算</h3>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">if</span> self<span class="token punctuation">.</span>nc <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">:</span>  <span class="token comment"># 多类别才计算分类损失</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    t <span class="token operator">=</span> torch<span class="token punctuation">.</span>full_like<span class="token punctuation">(</span>pcls<span class="token punctuation">,</span> self<span class="token punctuation">.</span>cn<span class="token punctuation">)</span>  <span class="token comment"># 初始化负标签（默认值）</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    t<span class="token punctuation">[</span><span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> tcls<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>cp      <span class="token comment"># 正样本位置填上正确类别</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    lcls <span class="token operator">+=</span> self<span class="token punctuation">.</span>BCEcls<span class="token punctuation">(</span>pcls<span class="token punctuation">,</span> t<span class="token punctuation">)</span>         <span class="token comment"># 二值交叉熵损失</span></pre></td></tr></table></figure><h2 id="训练网上的数据集"><a class="markdownIt-Anchor" href="#训练网上的数据集">#</a> 训练网上的数据集</h2>
<p>现在手边没啥好设备，我找了一个有 100 张照片的数据集：</p>
<img data-src="../../../images/python/YOLO/v5/9.png" alt="1" style="zoom: 100%;" />
<p>这个是检测火焰目标的，下载下来发现没有标注文件，所以我又把这个标注软件拿出来了。</p>
<img data-src="../../../images/python/YOLO/v5/8.png" alt="1" style="zoom: 100%;" />
<p>依然是 VOC 数据格式，在这里我要再次安利一下我的小软件：v2yWdtc！</p>
<p>开源地址放这里了：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tLzczNTY5MDc1Ny92MnlXZHRj">https://github.com/735690757/v2yWdtc</span></p>
<img data-src="../../../images/python/YOLO/v5/10.png" alt="1" style="zoom: 100%;" />
<p>这个可以帮助你过滤一些脏数据，还可以方便的查看标签信息。</p>
<p>然后就是编写 yaml 文件：</p>
<figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">path</span><span class="token punctuation">:</span> ./datasets/fire</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">train</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token punctuation">-</span> images/train</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">val</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token punctuation">-</span> images/val</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">test</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token punctuation">-</span> images/test</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># Classes</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token key atrule">names</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">0</span><span class="token punctuation">:</span> fire</pre></td></tr></table></figure><p>我就框了一个类，那就是火！哈哈！注意路径： <code>./datasets/fire</code>  这个是相对于训练文件的，千万不要当成相对于 yaml 的就行。然后把数据集放这里：</p>
<img data-src="../../../images/python/YOLO/v5/11.png" alt="1" style="zoom: 100%;" />
<p>下面是警告的解决方案：</p>
<ol>
<li>
<p>未来警告：FutureWarning:  <code>torch.cuda.amp.autocast(args...)</code>  is deprecated. Please use  <code>torch.amp.autocast('cuda', args...)</code>  instead</p>
<p>​		建议使用：with torch.amp.autocast (“cuda”,enabled=amp)</p>
</li>
<li>
<p>【WARNING】 corrupt JPEG restored and saved，使用工具重新读取并保存</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> os</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>folder <span class="token operator">=</span> <span class="token string">"./JPEGImages"</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">for</span> filename <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>folder<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">if</span> filename<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">".jpg"</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>folder<span class="token punctuation">,</span> filename<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            img<span class="token punctuation">.</span>save<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"JPEG"</span><span class="token punctuation">)</span>  <span class="token comment"># 重新保存</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>filename<span class="token punctuation">&#125;</span></span><span class="token string"> 无法打开：</span><span class="token interpolation"><span class="token punctuation">&#123;</span>e<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>后续会加入到我的 v2yWdtc 项目里，成为可选功能，敬请期待！</p>
</li>
</ol>
<p>先练 100 轮</p>
<img data-src="../../../images/python/YOLO/v5/12.png" alt="1" style="zoom: 100%;" />
<p>使用 <code>tensorboard --logdir runs/train</code>  看看实时绘制图像：</p>
<img data-src="../../../images/python/YOLO/v5/13.png" alt="1" style="zoom: 100%;" />
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">100</span> epochs completed <span class="token keyword">in</span> <span class="token number">0.270</span> hours.</pre></td></tr><tr><td data-num="2"></td><td><pre>Optimizer stripped from runs<span class="token punctuation">\</span>train<span class="token punctuation">\</span>exp3<span class="token punctuation">\</span>weights<span class="token punctuation">\</span>last.pt, <span class="token number">14</span>.3MB</pre></td></tr><tr><td data-num="3"></td><td><pre>Optimizer stripped from runs<span class="token punctuation">\</span>train<span class="token punctuation">\</span>exp3<span class="token punctuation">\</span>weights<span class="token punctuation">\</span>best.pt, <span class="token number">14</span>.3MB</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>Validating runs<span class="token punctuation">\</span>train<span class="token punctuation">\</span>exp3<span class="token punctuation">\</span>weights<span class="token punctuation">\</span>best.pt<span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="6"></td><td><pre>Fusing layers<span class="token punctuation">..</span>. </pre></td></tr><tr><td data-num="7"></td><td><pre>Model summary: <span class="token number">157</span> layers, <span class="token number">7012822</span> parameters, <span class="token number">0</span> gradients</pre></td></tr><tr><td data-num="8"></td><td><pre>                 Class     Images  Instances          P          R      mAP50   mAP50-95: <span class="token number">100</span>%<span class="token operator">|</span>██████████<span class="token operator">|</span> <span class="token number">3</span>/3 <span class="token punctuation">[</span>00:0<span class="token operator"><span class="token file-descriptor important">1</span>&lt;</span>00:00,  <span class="token number">2</span>.96it/s<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                   all         <span class="token number">18</span>         <span class="token number">20</span>      <span class="token number">0.744</span>       <span class="token number">0.75</span>       <span class="token number">0.76</span>      <span class="token number">0.333</span></pre></td></tr><tr><td data-num="10"></td><td><pre>Results saved to runs<span class="token punctuation">\</span>train<span class="token punctuation">\</span>exp3</pre></td></tr></table></figure><p>单类检测效果不错，Precision 和 Recall 平衡良好，模型体积小，适合轻量部署，mAP50-95 仍然偏低，这对精确边界框要求高的任务可能不够稳，其实我觉得是数据集太小的缘故，再多一点效果可能更好。让我们看看这个图片，左边是标签，右边是预测：</p>
<img data-src="../../../images/python/YOLO/v5/14.png" alt="1" style="zoom: 100%;" />
<img data-src="../../../images/python/YOLO/v5/15.png" alt="1" style="zoom: 100%;" />
<img data-src="../../../images/python/YOLO/v5/16.png" alt="1" style="zoom: 100%;" />
<p>学的还行，加大数据集可能效果会更好。</p>
<h1 id="参考"><a class="markdownIt-Anchor" href="#参考">#</a> 参考</h1>
<ol>
<li>【yolov5 目标检测原理与实战】：<span class="exturl" data-url="aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL0JWMXExenlZdEVyRQ==">https://www.bilibili.com/video/BV1q1zyYtErE</span></li>
<li>【ultralytics-YOLOv5】：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3VsdHJhbHl0aWNzL3lvbG92NQ==">https://github.com/ultralytics/yolov5</span></li>
</ol>
<img data-src="../../../images/cover/ultralyticsv5.webp" alt="1" style="zoom: 100%;" />
<img data-src="https://cdn.jsdelivr.net/gh/ultralytics/assets@main/docs/Ultralytics-YOLO26-Benchmark.jpg" alt="1" style="zoom: 100%;" />
<p>在 YOLO 领域，从来不缺技术与人才，无数的人试图在这里证明自己，新的模块、新的数据处理方法，新的训练模式，加注意力，再加机器学习基础方法，不断的推动 YOLO 的发展。</p>
<p>今天 ultralytics 重磅推出 YOLO26</p>

      <div class="tags">
          <a href="/tags/python/" rel="tag"><i class="ic i-tag"></i> python</a>
          <a href="/tags/CNN/" rel="tag"><i class="ic i-tag"></i> CNN</a>
          <a href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" rel="tag"><i class="ic i-tag"></i> 深度学习</a>
          <a href="/tags/YOLO/" rel="tag"><i class="ic i-tag"></i> YOLO</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">更新于</span>
    <time title="修改时间：2026-02-13 22:22:46" itemprop="dateModified" datetime="2026-02-13T22:22:46+08:00">2026-02-13</time>
  </span>
  <span id="python/YOLO/YOLO_V5/" class="item leancloud_visitors" data-flag-title="YOLO-V5 with Ultralytics YOLOv5源码解析" title="阅读次数">
      <span class="icon">
        <i class="ic i-eye"></i>
      </span>
      <span class="text">阅读次数</span>
      <span class="leancloud-visitors-count"></span>
      <span class="text">次</span>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> 赞赏</button>
  <p>请我喝[茶]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/myWxPay.jpg" alt="KarryLiu 微信支付">
        <p>微信支付</p>
      </div>
      
      <div>
        <img data-src="/images/myAliPay.jpg" alt="KarryLiu 支付宝">
        <p>支付宝</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>本文作者： </strong>KarryLiu <i class="ic i-at"><em>@</em></i>诗岸梦行舟
  </li>
  <li class="link">
    <strong>本文链接：</strong>
    <a href="https://735690757.github.io/python/YOLO/YOLO_V5/" title="YOLO-V5 with Ultralytics YOLOv5源码解析">https://735690757.github.io/python/YOLO/YOLO_V5/</a>
  </li>
  <li class="license">
    <strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/python/YOLO/YOLO_V4/" itemprop="url" rel="prev" data-background-image="&#x2F;images&#x2F;cover&#x2F;yolo.png" title="YOLO-V4">
  <span class="type">上一篇</span>
  <span class="category"><i class="ic i-flag"></i> YOLO</span>
  <h3>YOLO-V4</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/python/YOLO/YOLO_V7/" itemprop="url" rel="next" data-background-image="&#x2F;images&#x2F;cover&#x2F;yolo.png" title="YOLO-V7 with WongKinYiu YOLOv7模型源码解析">
  <span class="type">下一篇</span>
  <span class="category"><i class="ic i-flag"></i> YOLO</span>
  <h3>YOLO-V7 with WongKinYiu YOLOv7模型源码解析</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="文章目录">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#yolov5-with-ultralytics-yolov5%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text"> YOLOv5 with Ultralytics YOLOv5 源码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E7%A8%8B%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.1.</span> <span class="toc-text"> 工程实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E8%A8%80"><span class="toc-number">1.2.</span> <span class="toc-text"> 引言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B"><span class="toc-number">1.3.</span> <span class="toc-text"> 快速开始</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9C%8B%E7%9C%8B%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.4.</span> <span class="toc-text"> 看看模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#yolov5nsmlx"><span class="toc-number">1.4.1.</span> <span class="toc-text"> YOLOv5——n&#x2F;s&#x2F;m&#x2F;l&#x2F;x？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Eyolov5s%E7%BB%A7%E7%BB%AD%E8%AE%A8%E8%AE%BA"><span class="toc-number">1.4.2.</span> <span class="toc-text"> 基于 YOLOv5s 继续讨论</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#conv"><span class="toc-number">1.4.3.</span> <span class="toc-text"> Conv</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#c3"><span class="toc-number">1.4.4.</span> <span class="toc-text"> C3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sppf"><span class="toc-number">1.4.5.</span> <span class="toc-text"> SPPF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#focusfocus%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A2%AB%E5%BC%83%E7%94%A8"><span class="toc-number">1.4.6.</span> <span class="toc-text"> Focus——Focus 为什么被弃用？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#upsample"><span class="toc-number">1.4.7.</span> <span class="toc-text"> Upsample</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#concat"><span class="toc-number">1.4.8.</span> <span class="toc-text"> Concat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#detect"><span class="toc-number">1.4.9.</span> <span class="toc-text"> Detect</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%88%E6%8F%90%E4%B8%80%E4%B8%8Bparse_model"><span class="toc-number">1.4.10.</span> <span class="toc-text"> 先提一下 parse_model</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BF%80%E5%8A%A8%E4%BA%BA%E5%BF%83%E7%9A%84%E6%97%B6%E5%88%BB%E7%BB%84%E8%A3%85"><span class="toc-number">1.5.</span> <span class="toc-text"> 激动人心的时刻 —— 组装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#auto-anchor-%E8%87%AA%E9%80%82%E5%BA%94%E9%94%9A%E6%A1%86%E8%AE%A1%E7%AE%97"><span class="toc-number">1.6.</span> <span class="toc-text"> Auto-Anchor 自适应锚框计算</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#loss%E6%8D%9F%E5%A4%B1%E5%87%BD%E6%95%B0"><span class="toc-number">1.7.</span> <span class="toc-text"> Loss 损失函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A3%E6%A0%B7%E6%9C%AC%E6%8D%9F%E5%A4%B1%E8%AE%A1%E7%AE%97"><span class="toc-number">1.7.1.</span> <span class="toc-text"> 正样本损失计算</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E7%BD%AE%E4%BF%A1%E5%BA%A6%E7%9B%AE%E6%A0%87%E5%80%BC"><span class="toc-number">1.7.2.</span> <span class="toc-text"> 设置置信度目标值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%B1%BB%E6%8D%9F%E5%A4%B1%E8%AE%A1%E7%AE%97"><span class="toc-number">1.7.3.</span> <span class="toc-text"> 分类损失计算</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%AD%E7%BB%83%E7%BD%91%E4%B8%8A%E7%9A%84%E6%95%B0%E6%8D%AE%E9%9B%86"><span class="toc-number">1.8.</span> <span class="toc-text"> 训练网上的数据集</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">2.</span> <span class="toc-text"> 参考</span></a></li></ol>
      </div>
      <div class="related panel pjax" data-title="系列文章">
        <ul>
          <li><a href="/python/YOLO/index/" rel="bookmark" title="YOLO系列">YOLO系列</a></li><li><a href="/python/YOLO/YOLO_V1/" rel="bookmark" title="YOLO-V1">YOLO-V1</a></li><li><a href="/python/YOLO/YOLO_V2/" rel="bookmark" title="YOLO-V2">YOLO-V2</a></li><li><a href="/python/YOLO/YOLO_V3/" rel="bookmark" title="YOLO-V3">YOLO-V3</a></li><li><a href="/python/YOLO/YOLOv3_ultralytics/" rel="bookmark" title="ultralytics YOLOv3">ultralytics YOLOv3</a></li><li><a href="/python/YOLO/YOLO_V4/" rel="bookmark" title="YOLO-V4">YOLO-V4</a></li><li class="active"><a href="/python/YOLO/YOLO_V5/" rel="bookmark" title="YOLO-V5 with Ultralytics YOLOv5源码解析">YOLO-V5 with Ultralytics YOLOv5源码解析</a></li><li><a href="/python/YOLO/YOLO_V7/" rel="bookmark" title="YOLO-V7 with WongKinYiu YOLOv7模型源码解析">YOLO-V7 with WongKinYiu YOLOv7模型源码解析</a></li><li><a href="/python/YOLO/YOLO_V8/" rel="bookmark" title="YOLO-V8 with Ultralytics Full Version">YOLO-V8 with Ultralytics Full Version</a></li><li><a href="/python/YOLO/YOLO_V9_10_11/" rel="bookmark" title="YOLO-V9 V10 V11 V12新特性汇总">YOLO-V9 V10 V11 V12新特性汇总</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="站点概览">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="KarryLiu"
      data-src="/images/tx.jpg">
  <p class="name" itemprop="name">KarryLiu</p>
  <div class="description" itemprop="description">愿世间所有的美好都得以祝愿</div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">64</span>
        <span class="name">文章</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">30</span>
        <span class="name">分类</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">54</span>
        <span class="name">标签</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tLzczNTY5MDc1Nw==" title="https:&#x2F;&#x2F;github.com&#x2F;735690757"><i class="ic i-github"></i></span>
      <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS92b0FMUXRkYWNCVE00RVk=" title="https:&#x2F;&#x2F;twitter.com&#x2F;voALQtdacBTM4EY"><i class="ic i-twitter"></i></span>
      <span class="exturl item email" data-url="bWFpbHRvOjczNTY5MDc1N0BxcS5jb20=" title="mailto:735690757@qq.com"><i class="ic i-envelope"></i></span>
      <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS9ydW8tcWlhbi15aW5n" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;ruo-qian-ying"><i class="ic i-zhihu"></i></span>
      <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTM1Nzc1OTIzOA==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;357759238"><i class="ic i-cloud-music"></i></span>
      <span class="exturl item about" data-url="aHR0cHM6Ly9hYm91dC5tZS9rYXJyeWxpdQ==" title="https:&#x2F;&#x2F;about.me&#x2F;karryliu"><i class="ic i-address-card"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>

    
  <li class="item">
    <a href="/about/" rel="section"><i class="ic i-user"></i>关于</a>
  </li>

        
  <li class="item dropdown">
      <a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a>
    <ul class="submenu">

        
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a>
  </li>

        
  <li class="item">
    <a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a>
  </li>

        
  <li class="item">
    <a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a>
  </li>

  </ul>
    
  <li class="item">
    <a href="/music" rel="section"><i class="ic i-music"></i>橘子君-Ruxra</a>
  </li>

    
  <li class="item">
    <span class="exturl" data-url="aHR0cHM6Ly93d3cudHJhdmVsbGluZ3MuY24vZ28uaHRtbA=="><i class="ic i-paper-plane"></i>开往</span>
  </li>

    
  <li class="item">
    <a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a>
  </li>

    
  <li class="item">
    <a href="/ocfy" rel="section"><i class="ic i-magic"></i>OCFY</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/python/YOLO/YOLO_V4/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/python/YOLO/YOLO_V7/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>随机文章</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Java/" title="分类于 Java">Java</a>
<i class="ic i-angle-right"></i>
<a href="/categories/Java/git%E7%9B%B8%E5%85%B3/" title="分类于 git相关">git相关</a>
</div>

    <span><a href="/Java/gitflow/" title="GitFlow分支管理策略">GitFlow分支管理策略</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Java/" title="分类于 Java">Java</a>
<i class="ic i-angle-right"></i>
<a href="/categories/Java/linux/" title="分类于 linux">linux</a>
</div>

    <span><a href="/experience/Ubuntu24-d/" title="双硬盘独立引导Windows与Ubuntu">双硬盘独立引导Windows与Ubuntu</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/python/" title="分类于 深度学习">深度学习</a>
<i class="ic i-angle-right"></i>
<a href="/categories/python/YOLO/" title="分类于 YOLO">YOLO</a>
</div>

    <span><a href="/python/YOLO/YOLO_V8/" title="YOLO-V8 with Ultralytics Full Version">YOLO-V8 with Ultralytics Full Version</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/python/" title="分类于 深度学习">深度学习</a>
<i class="ic i-angle-right"></i>
<a href="/categories/python/%E9%A1%B9%E7%9B%AE%E4%B8%8E%E5%AE%9E%E6%88%98/" title="分类于 项目与实战">项目与实战</a>
</div>

    <span><a href="/python/pytorch_nn_digital_identification/" title="基于PyTorch的手写数字识别">基于PyTorch的手写数字识别</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Operate-system/" title="分类于 操作系统">操作系统</a>
</div>

    <span><a href="/Operate-system/03OS/" title="进程同步问题">进程同步问题</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/python/" title="分类于 深度学习">深度学习</a>
<i class="ic i-angle-right"></i>
<a href="/categories/python/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/" title="分类于 深度学习基础">深度学习基础</a>
</div>

    <span><a href="/python/numpy/" title="NumPy核心处理方法">NumPy核心处理方法</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/python/" title="分类于 深度学习">深度学习</a>
<i class="ic i-angle-right"></i>
<a href="/categories/python/YOLO/" title="分类于 YOLO">YOLO</a>
</div>

    <span><a href="/python/YOLO/YOLO_V9_10_11/" title="YOLO-V9 V10 V11 V12新特性汇总">YOLO-V9 V10 V11 V12新特性汇总</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/notebook/" title="分类于 笔记">笔记</a>
<i class="ic i-angle-right"></i>
<a href="/categories/notebook/%E8%80%83%E7%A0%94%E6%94%BF%E6%B2%BB%E7%AC%94%E8%AE%B0/" title="分类于 考研政治笔记">考研政治笔记</a>
</div>

    <span><a href="/PoliticalKnowledge/politicalNote/" title="政治知识点速记（持续更新）">政治知识点速记（持续更新）</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E7%94%9F%E6%B4%BB/" title="分类于 生活">生活</a>
<i class="ic i-angle-right"></i>
<a href="/categories/%E7%94%9F%E6%B4%BB/%E4%B8%8A%E5%B2%B8/" title="分类于 上岸">上岸</a>
</div>

    <span><a href="/life/shangan/" title="写给我这一年多的考研时光">写给我这一年多的考研时光</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Java/" title="分类于 Java">Java</a>
<i class="ic i-angle-right"></i>
<a href="/categories/Java/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%9B%B8%E5%85%B3/" title="分类于 微服务相关">微服务相关</a>
</div>

    <span><a href="/Java/DubboStart/" title="Dubbo快速入门">Dubbo快速入门</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>最新评论</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">KarryLiu @ KarryLiu</span>
  </div>
  <div class="powered-by">
    <a href="https://icp.gov.moe/?keyword=20249329" target="_blank">萌ICP备20249329号</a>
    基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  <br/><span>世界本污浊，罪与爱同歌</span>
  <br/><i class="ic i-chart-area"></i>&nbsp;<span>622k&nbsp;字</span> &nbsp;|&nbsp;
  <i class="ic i-coffee"></i>&nbsp;<span> 17:17</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: 'python/YOLO/YOLO_V5/',
    favicon: {
      show: "（●´3｀●）嘿嘿嘿....",
      hide: "(´Д｀)不看我是吧！"
    },
    search : {
      placeholder: "文章搜索",
      empty: "关于 「 ${query} 」，什么也没搜到",
      stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,copy_tex: true,
    katex: true,fancybox: true,
    copyright: '复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<!-- <script src="https://cdn.polyfill.io/v2/polyfill.js"></script>  -->

<script src="https://polyfill-js.cn/v3/polyfill.min.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
